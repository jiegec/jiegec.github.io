
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/33/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-02-16 00:00:00">2018年2月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="stanford-cs140e-3"><a class="toclink" href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">近来做 Stanford CS140e 的一些进展和思考（3）</a></h2>
<p>由于 <code>Assignment 2: File System</code> 延期发布，所以中间那段时间转向 <code>MIT 6.828</code> 稍微研究了一下。前几天放出了新的任务，在<a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">上一篇文章</a>之后，我又有了一些进展：实现了从内存中读取 <code>ATAGS(ARM Tags)</code> 信息的代码，从而可以获得内存大小的信息，根据这个信息，实现了 <code>bump</code> 和 <code>bin</code> 两种内存分配器，并且把二者之一注册为全局内存分配器，利用上更新了的 <code>std</code> 就可以使用需要动态分配内存的相关工具了。利用这个，我实现了 <code>shell</code> 输入历史的回溯，把输入历史保存在一个动态增长的数组中，再特殊处理上下键，把当前的行替换为历史。</p>
<p>这个过程也不是没有踩坑。一开始代码放出来了，但是题目说明还没出，我就自己按照代码做了 <code>ATAGS</code> 和 <code>bump</code> 分配器，后来做完了，看到说明出了以后，发现理解还是有偏差，把代码更改了并修复了分配器的 BUG。看到 <code>bin</code> 分配器的时候，我按照网上的 <code>buddy memory allocation</code> 实现了一个内存分配器，原理看起来简单实现起来还是有很多细节问题，后来按照新放出的单元测试，修修补补才写得差不多可用了。同时，原来的 <code>bootloader</code> 因为用了新的 <code>std</code> 而缺失了 <code>alloc</code> 不能编译，我就把 <code>kernel</code> 下的相关文件软连接过去，调了数次后把问题解决。此时， <code>kernel</code> 文件大小已经有 40K，按照 115200 Baudrate 发送需要几秒才能传输过去，我就调到了 230400 Baudrate，果然现在的传输速度就有所提升，可以接受了。等之后写了 <code>EMMC(SD card)</code> 的驱动和 <code>FAT32</code> 的文件系统后，就可以实现更多的 <code>shell</code> 的功能了。中间还遇到一个问题，就是如果给 <code>kernel</code> 开启了 <code>bin</code> 分配器，使用 <code>exit</code> 回到 <code>bootloader</code> 就无法传新的 <code>kernel</code> 上去了，结果发现是因为 <code>bin</code> 中用到的侵入式 <code>LinkedList</code> 实现覆盖了部分 <code>bootloader</code> 的代码，换回不能回收内存的 <code>bump</code> 分配器即可，反正目前远远还用不了那么多内存。</p>
<p>之后还要在 <code>aarch64</code> 上用 <code>MMU</code> 实现虚拟内存，之前在 <code>MIT 6.828</code> 里被页表整得脑子眩晕，希望到时我还活着吧（逃</p>
<p>更新：<a href="../../programming/2018/02/27/thoughts-on-stanford-cs140e-4/">下一篇在这里</a>。</p>
<nav class="md-post__action">
<a href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-02-06 00:00:00">2018年2月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="stanford-cs140e-2"><a class="toclink" href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">近来做 Stanford CS140e 的一些进展和思考（2）</a></h2>
<p>在<a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">上一篇文章</a>之后，我又有了一些进展：<code>UART</code> ，简易的<code>shell</code> ，修复了之前写的 <code>xmodem</code> 中的 BUG，一个可以从 <code>UART</code> 接收一个 <code>kernel</code> 写入到内存中再跳转过去的 <code>bootloader</code> 。</p>
<p>首先是 <code>UART</code> ，就是通过两个 <code>GPIO pin</code> 进行数据传输，首先在 <code>memory mapped IO</code> 上进行相应的初始化，然后包装了 <code>io::Read</code> 和 <code>io::Write</code> （这里实现一开始有 BUG，后来修复了），然后很快地完成了一个仅仅能 <code>echo</code> 的 <code>kernel</code> 。</p>
<p>然后实现了 <code>CONSOLE</code> ，一个对 <code>MiniUart</code> 和单例封装，就可以用 <code>kprint!/kprintln!</code> 宏来输出到 <code>UART</code> ，接着实现了一个 <code>echo</code> 的 <code>shell</code> ，读入一行输出一行。然后实现退格键和方向键，这里的难点在于要控制光标并且用读入的或者空格覆盖掉屏幕上已经显示而不应该显示的内容。接着，利用 <code>skeleton</code> 中的 <code>Command</code> 做了一个简单的 <code>echo</code> 命令。</p>
<p>接着，利用之前编写的 <code>tty</code> ，配合上新编写的 <code>bootloader</code> ，实现通过 <code>UART</code> 把新的 <code>kernel</code> 通过 <code>XMODEM</code> 协议发送到设备，写入 <code>0x80000</code> 启动地址并且调转到新加载的 <code>kernel</code> 中执行。</p>
<p>最后，又实现了 <code>uptime</code> （输出设备启动到现在的时间）和 <code>exit</code> （跳转回 <code>bootloader</code> ，可以上传新的 <code>kernel</code> ）。并添加了 <code>TUNA</code> 作为 <code>shell</code> 启动时输出的 <code>BANNER</code> 。</p>
<p>整个过程挺虐的，踩了很多的坑，由于很多东西都没有，输入输出目前也只有 <code>UART</code> ，写了 <code>UART</code> 后又遇到 <code>XMODEM</code> 难以调试的问题。十分感谢 <code>#tuna</code> 上的 @BenYip 及时地指出了代码的几处问题，节省了我许多时间。</p>
<p>更新：<a href="../../programming/2018/02/16/thoughts-on-stanford-cs140e-3/">下一篇在这里</a>。</p>
<nav class="md-post__action">
<a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-02-04 00:00:00">2018年2月4日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="stanford-cs140e"><a class="toclink" href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">近来做 Stanford CS140e 的一些进展和思考</a></h2>
<p>最近，受各路安利，剁手买下了 <a href="https://item.taobao.com/item.htm?id=537501616420">这个淘宝商家的树莓派的套餐 C</a> ，还买了许多 LED 灯泡、杜邦线和电阻，开始按照 <a href="http://web.stanford.edu/class/cs140e/">CS 140e</a> 学习 Rust 并且用 Rust 编译写一个简易的操作系统。Assignment 0 的目标就是编写一个向 GPIO 16 连接的 LED 灯闪烁。首先当然就是愉快地按照教程下载 bootloader，下载交叉编译工具链，顺带装一个 Raspbian 到机器上，随时可以当成一个低性能的 ARM/ARM64（实际上，Raspbian 只用了 armv7l，没有用 64bit）机器来用，以后如果配上 <a href="https://scateu.me">@scateu</a> 团购的 Motorola Laptop Dock 的话就是一个几百块的笔记本了。把课程上的文件丢上去，可以看到绿色的活动指示灯闪烁，后面又把 CP2102 模块连上去，又能看到 Blink on, Blink off 的输出。然后按照要求，自己先码一段 C 语言，实现 blinky:</p>
<div class="language-c++ highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">##define GPIO_BASE (0x3F000000 + 0x200000)</span>
</span><span id="__span-0-2"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_FSEL1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">);</span>
</span><span id="__span-0-4"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_SET0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1C</span><span class="p">);</span>
</span><span id="__span-0-5"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">GPIO_CLR0</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span>
</span><span id="__span-0-6"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spin_sleep_us</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">us</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">"nop"</span><span class="p">);</span>
</span><span id="__span-0-10"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-11"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</span><span id="__span-0-12"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spin_sleep_ms</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-14"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">  </span><span class="n">spin_sleep_us</span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-15"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">}</span>
</span><span id="__span-0-16"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>
</span><span id="__span-0-17"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-18"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="c1">// STEP 1: Set GPIO Pin 16 as output.</span>
</span><span id="__span-0-19"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">  </span><span class="o">*</span><span class="n">GPIO_FSEL1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b001</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span>
</span><span id="__span-0-20"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">  </span><span class="c1">// STEP 2: Continuously set and clear GPIO 16.</span>
</span><span id="__span-0-21"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="o">*</span><span class="n">GPIO_SET0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-0-23"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-24"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="o">*</span><span class="n">GPIO_CLR0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-0-25"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-0-26"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-27"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>其中大部分代码都已经给出了，自己要实现也只是查询一下 BCM2837 SoC 的 GPIO 文档，按照文档把该做的内存操作和位运算都写一下即可。最后发现，闪烁的频率特别慢，几秒钟才闪烁一次。毕竟是按照 CPU 的 clock speed 进行粗略的计时，而生成的代码也不是很高效，没有 inline。接着则是用 Rust 再实现一下上面这部分的代码：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>#<span class="cp">#![feature(compiler_builtins_lib, lang_items, asm, pointer_methods)]</span>
</span><span id="__span-1-2"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>#<span class="cp">#![no_builtins]</span>
</span><span id="__span-1-3"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>#<span class="cp">#![no_std]</span>
</span><span id="__span-1-4"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">compiler_builtins</span><span class="p">;</span>
</span><span id="__span-1-6"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span> <span class="nn">lang_items</span><span class="p">;</span>
</span><span id="__span-1-8"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_BASE</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mh">0x3F000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200000</span><span class="p">;</span>
</span><span id="__span-1-10"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_FSEL1</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-12"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_SET0</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x1C</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-13"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="k">const</span><span class="w"> </span><span class="n">GPIO_CLR0</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_BASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
</span><span id="__span-1-14"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>#<span class="cp">#[inline(never)]</span>
</span><span id="__span-1-16"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="k">fn</span> <span class="nf">spin_sleep_ms</span><span class="p">(</span><span class="n">ms</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-17"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="p">(</span><span class="n">ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">600</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-18"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">asm!</span><span class="p">(</span><span class="s">"nop"</span><span class="w"> </span>:::: <span class="s">"volatile"</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-1-19"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-20"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="p">}</span>
</span><span id="__span-1-21"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
</span><span id="__span-1-22"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>#<span class="cp">#[no_mangle]</span>
</span><span id="__span-1-23"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">kmain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-24"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="c1">// STEP 1: Set GPIO Pin 16 as output.</span>
</span><span id="__span-1-25"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="n">GPIO_FSEL1</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">18</span><span class="p">);</span>
</span><span id="__span-1-26"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="c1">// STEP 2: Continuously set and clear GPIO 16.</span>
</span><span id="__span-1-27"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="n">GPIO_SET0</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-1-29"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-1-30"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="n">GPIO_CLR0</span><span class="p">.</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-1-31"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-1-32"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-33"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="p">}</span>
</span></code></pre></div>
<p>这边和上面一样，很多东西都已经给出了，只是重新改写一下而已。不过，这边的实测结果则是，一秒钟会闪烁很多下，看了下汇编，生成的循环比较紧凑，所以也没有达到想要的效果，不过后面到我实现了 Timer 的读取之后，就很精准了。</p>
<p>接下来就是痛苦的学习 Rust 的过程，Assignment 1 上来就是解答关于 Rust 语言的一些问题，在过程中被 Rust 十分严格的 Lifetime 和 Borrow checker 弄得想死，好歹最后还是让测试都通过了。接下来就是真正地提供一些封装硬件接口的 API，然后利用这些 API 去实现更多功能，首先是利用栈上分配的空间模拟一个变长数组的 API：<code>stack-vec</code> ，然后是把底层的直接操作硬件的内存操作封装成类型安全的 <code>volatile</code> ，然后实现一个简单的支持断点续传的传文件的协议 <code>xmodem</code> ，又做了一个辅助电脑上使用 TTY+XMODEM 的小工具 <code>ttywrite</code> ，然后就开始撸硬件了：时钟 <code>timer</code> ，针对 GPIO pin 的类型安全的状态机 <code>GPIO</code> 。目前只实现到这里，然后做出了一个准确一秒闪烁的 blinky（令人惊讶的是，因为这里的 kernel 直接从文件头开始就是代码，最后的 binary 异常地小，而之前的代码从文件的偏移 0x8000 开始。目前看来，是因为之前的代码是整个文件加载到 0x0000 上，而代码默认了从  0x8000 开始，所以除了最开头的一个跳转指令，中间留了许多空余的空间。而这里的代码是直接被 bootloader 加载到了 0x80000 处并且跳转到这里执行，所以省去了许多空间）：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">fn</span> <span class="nf">blinky</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pin16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gpio</span>::<span class="n">new</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-2-3"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pin_out16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin16</span><span class="p">.</span><span class="n">into_output</span><span class="p">();</span>
</span><span id="__span-2-4"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-6"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">        </span><span class="n">pin_out16</span><span class="p">.</span><span class="n">set</span><span class="p">();</span>
</span><span id="__span-2-7"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-2-8"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="n">pin_out16</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-2-9"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">        </span><span class="n">spin_sleep_ms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-2-10"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-11"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="p">}</span>
</span><span id="__span-2-12"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>
</span><span id="__span-2-13"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>#<span class="cp">#[no_mangle]</span>
</span><span id="__span-2-14"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">kmain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-15"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="c1">// FIXME: Start the shell.</span>
</span><span id="__span-2-16"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="n">blinky</span><span class="p">();</span>
</span><span id="__span-2-17"><a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>目前只做到这里。后面还有大把的坑要踩，难写的 Rust 还得继续啃下去。我的代码都以 diff 的形式放在了 <a href="https://github.com/jiegec/cs140e">jiegec/cs140e</a> ，写得并不美观。接下来就是实现 <code>UART</code> 了，终于要实现串口通信了。</p>
<p>2018-01-06 更新： <a href="../../programming/2018/02/06/thoughts-on-stanford-cs140e-2/">下一篇文章已经更新</a> 。</p>
<nav class="md-post__action">
<a href="../../programming/2018/02/04/thoughts-on-stanford-cs140e/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-01-30 00:00:00">2018年1月30日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="vs-scanf-scanf_s"><a class="toclink" href="../../programming/2018/01/30/more-on-scanf-and-scanf_s/">再次吐槽 VS 关于 scanf 和 scanf_s 的问题</a></h2>
<p>继<a href="/programming/2017/10/17/on-scanf-and-scanf_s/">上次的吐槽</a>后，今天再次遇到同学因为 <code>scanf</code> 在 VS 下的 <code>deprecation error</code> 感到十分迷茫，在知乎上求助又因为拍照的原因被说，我就在此再次吐槽一下 VS 这对初学者很不友善很不友善的两点。</p>
<p>一点就是上面提到的这个，另一点就是程序结束后任意键以退出这一功能要做得更加醒目一点。前者由于大多数新手在学习 <code>C/C++</code> 的时候都会跟着书上或者网上的代码敲一遍输入输出的代码，很容易就会撞到这个问题。后者则会让新手习惯性地以为程序闪退了，没有出结果，而不知道其实是程序执行结束后关闭而已。</p>
<nav class="md-post__action">
<a href="../../programming/2018/01/30/more-on-scanf-and-scanf_s/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-01-07 00:00:00">2018年1月7日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="emacs-patch"><a class="toclink" href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/">我正在使用的两个 Emacs 的 Patch</a></h2>
<p>我在本地对 <code>emacs.rb</code> 进行了修改：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>diff --git a/Formula/emacs.rb b/Formula/emacs.rb
</span><span id="__span-0-2"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>index d0138cd..de3c5ff 100644
</span><span id="__span-0-3"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>--- a/Formula/emacs.rb
</span><span id="__span-0-4"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>+++ b/Formula/emacs.rb
</span><span id="__span-0-5"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>@@ -4,6 +4,14 @@ class Emacs &lt; Formula
</span><span id="__span-0-6"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>   url "https://ftp.gnu.org/gnu/emacs/emacs-25.3.tar.xz"
</span><span id="__span-0-7"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>   sha256 "253ac5e7075e594549b83fd9ec116a9dc37294d415e2f21f8ee109829307c00b"
</span><span id="__span-0-8"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>+  patch do
</span><span id="__span-0-10"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>+    url "https://gist.githubusercontent.com/aatxe/260261daf70865fbf1749095de9172c5/raw/214b50c62450be1cbee9f11cecba846dd66c7d06/patch-multicolor-font.diff"
</span><span id="__span-0-11"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>+  end
</span><span id="__span-0-12"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>+
</span><span id="__span-0-13"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>+  patch do
</span><span id="__span-0-14"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>+    url "https://debbugs.gnu.org/cgi/bugreport.cgi?filename=0001-Fix-child-frame-placement-issues-bug-29953.patch;bug=29953;att=1;msg=8"
</span><span id="__span-0-15"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>+  end
</span><span id="__span-0-16"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>+
</span><span id="__span-0-17"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>   bottle do
</span><span id="__span-0-18"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>     sha256 "d5ce62eb55d64830264873a363a99f3de58c35c0bd1602cb7fd0bc37137b0c9d" =&gt; :high_sierra
</span><span id="__span-0-19"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>     sha256 "4d7ff7f96c9812a9f58cd45796aef789a1b5d26c58e3e68ecf520fab34af524d" =&gt; :sierra
</span></code></pre></div>
<p>主要涉及到两个 Patch：</p>
<ol>
<li>启用对 Multicolor font，比如 Emoji 的支持。由于一些 ethic problems 暂时在 Emacs 中被禁用了，所以自己启用回来。</li>
<li>打上我前几天上报的 <a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=29953">BUG #29953</a> 的修复。已经在上游 Merge 到 <code>emacs-26</code> 分支中，这个修复会在下一个版本中。</li>
</ol>
<p>有了第一个，就可以正常显示 Emoji（对不起，RMS）；有了第二个，就解决了 <code>pyim</code> 和 <code>lsp-ui-peek</code> 用 <code>child-frame</code> 显示的一些问题了。</p>
<p>另外还有一个我自己在用的 <code>recoll.rb</code> ：
<div class="language-rb highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">## Documentation: https://docs.brew.sh/Formula-Cookbook.html</span>
</span><span id="__span-1-2"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1">##                http://www.rubydoc.info/github/Homebrew/brew/master/Formula</span>
</span><span id="__span-1-3"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1">## PLEASE REMOVE ALL GENERATED COMMENTS BEFORE SUBMITTING YOUR PULL REQUEST!</span>
</span><span id="__span-1-4"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Recoll</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Formula</span>
</span><span id="__span-1-6"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="n">desc</span><span class="w"> </span><span class="s2">"Recoll is a desktop full-text search tool."</span>
</span><span id="__span-1-7"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="n">homepage</span><span class="w"> </span><span class="s2">"https://www.lesbonscomptes.com/recoll/"</span>
</span><span id="__span-1-8"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="s2">"https://www.lesbonscomptes.com/recoll/recoll-1.23.5.tar.gz"</span>
</span><span id="__span-1-9"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="n">sha256</span><span class="w"> </span><span class="s2">"9b6b6941efc3e87c8325e95a69a5d0a37c022c3c45773c71dccd0fb3f364475f"</span>
</span><span id="__span-1-10"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">"xapian"</span>
</span><span id="__span-1-12"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">"qt"</span>
</span><span id="__span-1-13"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="n">depends_on</span><span class="w"> </span><span class="s2">"aspell"</span>
</span><span id="__span-1-14"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
</span><span id="__span-1-15"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">install</span>
</span><span id="__span-1-16"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="n">inreplace</span><span class="w"> </span><span class="s2">"Makefile.in"</span><span class="p">,</span>
</span><span id="__span-1-17"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">      </span><span class="s2">"-Wl,--no-undefined -Wl,--warn-unresolved-symbols"</span><span class="p">,</span><span class="w"> </span><span class="s2">"--no-undefined --warn-unresolved-symbols"</span>
</span><span id="__span-1-18"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>
</span><span id="__span-1-19"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">"./configure"</span><span class="p">,</span><span class="w"> </span><span class="s2">"--disable-dependency-tracking"</span><span class="p">,</span>
</span><span id="__span-1-20"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">                          </span><span class="s2">"--disable-silent-rules"</span><span class="p">,</span>
</span><span id="__span-1-21"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">                          </span><span class="s2">"--without-x"</span><span class="p">,</span>
</span><span id="__span-1-22"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                          </span><span class="s2">"--disable-x11mon"</span><span class="p">,</span>
</span><span id="__span-1-23"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">                          </span><span class="s2">"--with-aspell"</span><span class="p">,</span>
</span><span id="__span-1-24"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">                          </span><span class="s2">"--enable-recollq"</span><span class="p">,</span>
</span><span id="__span-1-25"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">                          </span><span class="s2">"--disable-webkit"</span><span class="p">,</span><span class="w"> </span><span class="c1"># requires qtwebkit, which is not bundled with qt5</span>
</span><span id="__span-1-26"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">                          </span><span class="s2">"--prefix=</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-1-27"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">"make"</span><span class="p">,</span><span class="w"> </span><span class="s2">"install"</span>
</span><span id="__span-1-28"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>
</span><span id="__span-1-29"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="n">mkdir</span><span class="w"> </span><span class="n">libexec</span>
</span><span id="__span-1-30"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">    </span><span class="n">mv</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="s2">"recoll.app"</span><span class="p">,</span><span class="w"> </span><span class="n">libexec</span><span class="o">/</span><span class="s2">"recoll.app"</span>
</span><span id="__span-1-31"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-32"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>
</span><span id="__span-1-33"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">  </span><span class="nb">test</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-1-34"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">    </span><span class="c1"># `test do` will create, run in and delete a temporary directory.</span>
</span><span id="__span-1-35"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-1-36"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">    </span><span class="c1"># This test will fail and we won't accept that! For Homebrew/homebrew-core</span>
</span><span id="__span-1-37"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="c1"># this will need to be a test that verifies the functionality of the</span>
</span><span id="__span-1-38"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">    </span><span class="c1"># software. Run the test with `brew test recoll`. Options passed</span>
</span><span id="__span-1-39"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">    </span><span class="c1"># to `brew install` such as `--HEAD` also need to be provided to `brew test`.</span>
</span><span id="__span-1-40"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="c1">#</span>
</span><span id="__span-1-41"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">    </span><span class="c1"># The installed folder is not in the path, so use the entire path to any</span>
</span><span id="__span-1-42"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">    </span><span class="c1"># executables being tested: `system "#{bin}/program", "do", "something"`.</span>
</span><span id="__span-1-43"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="nb">system</span><span class="w"> </span><span class="s2">"false"</span>
</span><span id="__span-1-44"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">  </span><span class="k">end</span>
</span><span id="__span-1-45"><a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="k">end</span>
</span></code></pre></div></p>
<nav class="md-post__action">
<a href="../../programming/2018/01/07/two-patches-of-Emacs-I-am-using/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2018-01-02 00:00:00">2018年1月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/networking/">networking</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nat64"><a class="toclink" href="../../networking/2018/01/02/first-trail-of-NAT64/">NAT64 初尝试</a></h2>
<p>最近宿舍里有线网络的 IPv4 总是拿不到地址，只能连无线网，不禁对计算机系学生的可怕的设备数量有了深刻的认识。不过，作为一个有道德（误）的良好青年，还是不要给已经枯竭的 IPv4 地址填堵了，还是赶紧玩玩 IPv6 的网络吧。然后在 TUNA 群里受青年千人续本达 (@heroxbd) 的安利，本地搭建一下 NAT64+DNS64 的环境。不过考虑到宿舍还是拿不到有线的 IPv4 地址，我就先利用苹果先前在强制 iOS 的应用支持 NAT64 网络的同时，在 macOS 上为了方便开发者调试，提供的便捷的建立 NAT64 网络的能力。</p>
<p>首先在设置中按住 Option 键打开 Sharing，点击 Internet Sharing，勾上 Create NAT64 Network 然后把网络共享给设备。然后在手机上关掉 Wi-Fi 和 Cellular，发现还能正常上网。此时可以打开 Wireshark 验证我们的成果了：</p>
<p>在手机上打开浏览器，浏览千度，得到如下的 Wireshark 截图：
<img alt="baidu-nat64" src="/images/baidu-nat64.jpg"/></p>
<p>这里，<code>2001:2:0:aab1::1</code> 是本机在这个子网中的地址，<code>2001:2::aab1:cda2:5de:87f6:fd78</code> 是我的 iOS 设备的地址，然后 iOS 向 macOS 发出了 DNS 请求，macOS 发送 DNS 请求后得到 <code>baidu.com</code> 的 IPv4 地址之一为 <code>111.13.101.208</code> ：
<img alt="baidu-dns" src="/images/baidu-dns.jpg"/></p>
<p>上图中，我们可以看到， <code>baidu.com</code> 的 <code>AAAA</code> 记录是 <code>2001:2:0:1baa::6f0d:65d0</code> ，这个就是 DNS64 转译的地址，前面为网关的 <code>prefix</code> ，后面就是对应的 IPv4 地址： <code>0x6f=111, 0x0d=13, 0x65=101, 0xd0=208</code> ，当客户端向这个地址发包的时候，网关发现前缀符合条件，把最后的这部分 IPv4 地址取出来，自己把包发送到真实的地址上去，再把返回来的包再转为 IPv6 的地址返还给客户端。可以验证，剩下的几个地址也符合这个转译规则。</p>
<p>这就实现了：利用一台连接着 IPv6 和 IPv4 两种网络的网关，可以使得 IPv6 这个网络通过网关访问 IPv4。通过配置，也可以使得 IPv4 访问 IPv6 中的地址（即 Stateful 和 Stateless 的区分，需要手动配置映射）。</p>
<p>好处：作为比较成熟的 IPv4 到 IPv6 过渡方案之一，可以让自己组建的 IPv6 网络访问一些仅 IPv4 的网站。
坏处：依赖于 DNS64，必须要经过一层翻译，一些应用或协议可能写死了 IPv4 的地址，该方法可能会失效。</p>
<nav class="md-post__action">
<a href="../../networking/2018/01/02/first-trail-of-NAT64/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2017-12-31 00:00:00">2017年12月31日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="java"><a class="toclink" href="../../programming/2017/12/31/interesting-java-formatting-problem/">有趣的 Java 日期格式化问题</a></h2>
<p>今天在群里看到有人说，Java 的日期格式化有问题，如果用 <code>YYYY-MM-dd</code> ，今天的日期就会显示 <code>2018-12-31</code> 。我立马在本地用 Java REPL (aka Groovy) 跑了一下，果然如此：</p>
<div class="language-groovy highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">$</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="o">()</span>
</span><span id="__span-0-2"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">===&gt;</span><span class="w"> </span><span class="n">Sun</span><span class="w"> </span><span class="n">Dec</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">26</span><span class="w"> </span><span class="n">CST</span><span class="w"> </span><span class="mi">2017</span>
</span><span id="__span-0-3"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">$</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nn">java.text.SimpleDateFormat</span>
</span><span id="__span-0-4"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="o">===&gt;</span><span class="w"> </span><span class="n">java</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">SimpleDateFormat</span>
</span><span id="__span-0-5"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="n">$</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s2">"YYYY-MM-dd"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">)</span>
</span><span id="__span-0-6"><a href="../../programming/2017/12/31/interesting-java-formatting-problem/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="o">===&gt;</span><span class="w"> </span><span class="mi">2018</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>
</span></code></pre></div>
<p>解决方案是，把格式换为 <code>yyyy-MM-dd</code> ，确实就可以了。于是我就去研究了一下文档： <a href="https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html">Class SimpleDateFormat</a> ，发现了问题：</p>
<p><code>y</code> 代表 <code>year</code> ，而 <code>Y</code> 代表 <code>week year</code> 。根据 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/GregorianCalendar.html#week_year">week year</a> ，因为今年最后的一个星期在明年的部分更多，于是这个星期被归在了明年，所以这一周属于 2018，这就可以解释之前的那个输出问题了。</p>
<nav class="md-post__action">
<a href="../../programming/2017/12/31/interesting-java-formatting-problem/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2017-12-27 00:00:00">2017年12月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="macos-gentooprefix"><a class="toclink" href="../../devops/2017/12/27/try-gentoo-prefix-on-macOS/">在 macOS 上试用 Gentoo/Prefix</a></h2>
<p>前几天参加了<a href="https://keybase.io/jsteward">许朋程</a>主讲的 Tunight，对 Gentoo 有了一定的了解，不过看到如此复杂的安装过程和长久的编译时间，又看看我的 CPU，只能望而却步了。不过，有 Gentoo/Prefix 这个工具，使得我们可以在其它的操作系统（如 macOS,Solaris 等）上在一个 $EPREFIX 下跑 Portage，也就是把 Portage 运行在别的操作系统，当作一个包管理器，并且可以和别的操作系统并存。</p>
<p>首先还是祭出官网：<a href="https://wiki.gentoo.org/wiki/Project:Prefix">Project:Prefix</a>。</p>
<p>首先设定好环境变量 <code>$EPREFIX</code> ，之后所有的东西都会安装到这个目录下，把 <code>bootstrap-prefix.sh</code> 下载到 <code>$EPREFIX</code> ，然后 <code>./bootstrap-prefix.sh</code> ，会进行一系列的问题，一一回答即可。建议在运行前设置好 <code>GENTOO_MIRRORS=http://mirrors.tuna.tsinghua.edu.cn/gentoo</code> 由于 TUNA 没有对 gentoo_prefix 做镜像，只能把 distfiles 切换到 TUNA 的镜像上。</p>
<p>然后。。。</p>
<p>stage1...</p>
<p>stage2..</p>
<p>stage3.</p>
<p><code>emerge -e @world</code> BOOM</p>
<p>经过 n 次跑挂以后，终于搞完了 stage3，然后 <code>SHELL=bash ./bootstrap-prefix.sh $EPREFIX startscript</code> 生成 <code>startprefix</code> ，在外面的 SHELL 中向切进来的时候运行这个即可。</p>
<p>然后就可以使用Gentoo/Prefix了。注意！此时的 <code>$PATH</code> 仅限于 <code>$EPREFIX</code> 下几个目录和 <code>/usr/bin</code> <code>/bin</code> 所以很多东西都会出问题（Emacs, Vim, Fish etc）。小心不要把自己的目录什么的搞挂了。</p>
<p>然后就可以假装试用 Gentoo 了！</p>
<p>哈哈哈哈哈哈哈</p>
<p>死于编译 libgcrypt 和 llvm。</p>
<nav class="md-post__action">
<a href="../../devops/2017/12/27/try-gentoo-prefix-on-macOS/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2017-12-12 00:00:00">2017年12月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="lsp-c"><a class="toclink" href="../../programming/2017/12/12/lsp-and-cpp/">LSP 和 C++</a></h2>
<p>之前时间，巨硬发布了 LSP（Language Server Protocol），目的是解决目前 IDE 和各语言的 m+n 问题。想法很好，不过直到最近，终于有我觉得可以用的工具出来了，并且已经代替了我在使用的其它的插件。</p>
<p>由于我最近主要就是做做程设作业，做做 OJ 这些，主要就是和 C++ 打交道。所以我当然就开始找一些比较成熟的 C++的 LSP server。有一个 Sourcegraph 维护的 <a href="https://langserver.org/">langserver.org</a> ，上面有着目前的各个语言和编辑器/IDE 的支持情况，我刚才提到的 cquery 也会加入到这个列表里去。从这个列表里可以看到，我用的比较多的 Python 和 Haskell 都已经有不错的的 LSP server，我已经开始在本地体验 pyls 和 hie 了，感觉做得挺不错的。</p>
<p>回到 C++，我的主力编辑器是 Emacs，其次是 CLion，而 Emacs 上的<a href="https://github.com/emacs-lsp/lsp-mode">LSP 支持 lsp-mode</a>也在快速发展，与之配合的<a href="https://github.com/emacs-lsp/lsp-ui">lsp-ui</a> 也出现了很多很棒的功能。</p>
<p>下面开始编译并配置<a href="https://github.com/jacobdufault/cquery">cquery</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jacobdufault/cquery<span class="w"> </span>--recursive
</span><span id="__span-0-2"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nb">cd</span><span class="w"> </span>cquery
</span><span id="__span-0-3"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>./waf<span class="w"> </span>configure<span class="w"> </span><span class="c1"># to use system clang, append --use-system-clang</span>
</span><span id="__span-0-4"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>./waf<span class="w"> </span>build
</span></code></pre></div>
<p>然后配置 Emacs：</p>
<div class="language-elisp highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">lsp-mode</span>
</span><span id="__span-1-2"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nb">:ensure</span><span class="w"> </span><span class="no">t</span>
</span><span id="__span-1-3"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nb">:diminish</span>
</span><span id="__span-1-4"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nv">lsp-mode</span>
</span><span id="__span-1-5"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nb">:commands</span>
</span><span id="__span-1-6"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="p">(</span><span class="nv">lsp-mode</span><span class="p">)</span>
</span><span id="__span-1-7"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nb">:config</span>
</span><span id="__span-1-8"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="p">(</span><span class="nv">lsp-define-stdio-client</span>
</span><span id="__span-1-9"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">   </span><span class="nv">lsp-pyls</span>
</span><span id="__span-1-10"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">   </span><span class="s">"python"</span>
</span><span id="__span-1-11"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">   </span><span class="nf">#'</span><span class="nv">get-project-root</span>
</span><span id="__span-1-12"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">   </span><span class="o">'</span><span class="p">(</span><span class="s">"/usr/local/bin/pyls"</span><span class="p">)))</span>
</span><span id="__span-1-13"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>
</span><span id="__span-1-14"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">lsp-ui</span>
</span><span id="__span-1-15"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="nb">:commands</span>
</span><span id="__span-1-16"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="nv">lsp-ui-mode</span>
</span><span id="__span-1-17"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="nb">:init</span>
</span><span id="__span-1-18"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="p">(</span><span class="nv">add-hook</span><span class="w"> </span><span class="ss">'lsp-mode-hook</span><span class="w"> </span><span class="ss">'lsp-ui-mode</span><span class="p">))</span>
</span><span id="__span-1-19"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">cquery</span>
</span><span id="__span-1-21"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">  </span><span class="nb">:load-path</span>
</span><span id="__span-1-22"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="s">"path_to_cquery/emacs"</span>
</span><span id="__span-1-23"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">  </span><span class="nb">:config</span>
</span><span id="__span-1-24"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">  </span><span class="p">(</span><span class="k">setq</span>
</span><span id="__span-1-25"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">     </span><span class="nv">cquery-executable</span><span class="w"> </span><span class="s">"path_to_cquery/build/app"</span>
</span><span id="__span-1-26"><a href="../../programming/2017/12/12/lsp-and-cpp/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">     </span><span class="nv">cquery-resource-dir</span><span class="w"> </span><span class="s">"path_to_cquery/clang_resource_dir"</span><span class="p">))</span>
</span></code></pre></div>
<p>接下来，需要配置 基于 Clang 的 工具都需要的 Compilation Database。Sacrasm 对这个有一个非常完整的<a href="https://sarcasm.github.io/notes/dev/compilation-database.html">总结</a> ，可以查看里面的方法。我这里推荐在 CMake 项目中用 CMake 自带的，加上<a href="https://github.com/nickdiego/compiledb-generator">nickdiego/compiledb-generator</a> 应付基于Makefile/Autotools的项目。如果都不适用，就按照cquery的README写一个简单的.cquery文件即可，不需要Bear那种必须关闭SIP的方案。</p>
<p>然后就可以享受很多功能了！还是挺好用的。</p>
<nav class="md-post__action">
<a href="../../programming/2017/12/12/lsp-and-cpp/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2017-12-02 00:00:00">2017年12月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nginx"><a class="toclink" href="../../programming/2017/12/02/on-nginx-memory-pool/">Nginx 的内存池实现</a></h2>
<p>今晚参加了 Tunight，会长给我们讲了 Nginx 的一些内部运作的机制和原理。中间的时候，会长展示的代码中用到了线程池方面的一些函数，但是大多地方只有调用 <code>ngx_pcalloc</code> 而没有看到相应的对象释放的过程，于是在演示的最后，会长应大家要求对 Nginx 魔幻的内存池实现做了现场代码分析。</p>
<p>在分析的中途遇到了很多坑，最后才终于理清了内存池的工作原理。这里直接解释结论吧。以下代码均摘自 Nginx 1.13.7，代码都可以在官方仓库找到。</p>
<p>首先分析一下创建一个内存池的函数：
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-0-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nf">ngx_create_pool</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ngx_log_t</span><span class="w"> </span><span class="o">*</span><span class="n">log</span><span class="p">)</span>
</span><span id="__span-0-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span>
</span><span id="__span-0-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-0-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-0-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-0-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-0-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>
</span><span id="__span-0-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-20"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-21"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-22"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-23"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">;</span>
</span><span id="__span-0-24"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>
</span><span id="__span-0-25"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-0-26"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>现在开始分段分析这个函数：在这里，一个内存池用一个 <code>ngx_pool_t (aka struct ngx_pool_s)</code> 类型的数据进行包装，所有的关于内存池的操作都基于相应的内存池对象。 <code>ngx_log_t</code> 表示输出信息的对象，与内存池无关，后面也不会讨论它。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-1-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-1-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-1-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-1-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-1-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<p>这里通过调用 <code>ngx_memalign</code> 分配一段（能对齐就对齐，不能对齐就放弃的）以 size 为大小的内存，做为这个内存池第一个块的内存，这个块的头是完整的，其中 <code>p-&gt;d.last</code> 和 <code>p-&gt;d.end</code> 分别表示可用于分配对象的内存段的开始和结束，在用 <code>p-&gt;d.next</code> 连接起来的链表中，每个链表实际上只有 <code>d</code> 是存储了数据，后面的各个域都不再使用。这里的 <code>p-&gt;d.failed</code> 涉及到链表的优化，在以后会接触到。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
</span><span id="__span-2-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>
</span><span id="__span-2-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
</span><span id="__span-2-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-2-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-2-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">;</span>
</span><span id="__span-2-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>
</span><span id="__span-2-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span></code></pre></div>
<p>这里的 <code>size</code> 计算出实际用于对象分配的内存大小， <code>p-&gt;max</code> 存储了当前这个块最大能容纳的对象的大小， <code>p-&gt;current</code> 会和上面的 <code>p-&gt;d.failed</code> 合在一起对链表进行优化。 <code>p-&gt;chain</code> 与其他功能关系较密切，不会在本文中展开，而 <code>p-&gt;cleanup</code> 允许外部注册一些清理函数，实现起来并不难。</p>
<p>接下来，由于 <code>ngx_pnalloc</code> 和 <code>ngx_pcalloc</code> 都和 <code>ngx_palloc</code> 相近，这里只对 <code>ngx_palloc</code> 进行分析：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nf">ngx_palloc</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-3-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="p">{</span>
</span><span id="__span-3-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="cp">##if !(NGX_DEBUG_PALLOC)</span>
</span><span id="__span-3-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-3-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="cp">##endif</span>
</span><span id="__span-3-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_large</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-3-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里分了两种情况，如果要分配的内存大于一个块的最大值，那么这段内存必须要单独分配单独维护，所以调用了 <code>ngx_palloc_large</code> ，下面对其分析：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-4-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nf">ngx_palloc_large</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-4-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">{</span>
</span><span id="__span-4-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="kt">void</span><span class="w">              </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">ngx_uint_t</span><span class="w">         </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-4-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">  </span><span class="o">*</span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-4-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-4-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>
</span><span id="__span-4-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">            </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-19"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-20"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>
</span><span id="__span-4-21"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-22"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-4-23"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-24"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-25"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>
</span><span id="__span-4-26"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">    </span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_large_t</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-4-27"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">large</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-28"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">        </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-4-29"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-4-30"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-31"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a>
</span><span id="__span-4-32"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-33"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-34"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">    </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">large</span><span class="p">;</span>
</span><span id="__span-4-35"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>
</span><span id="__span-4-36"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-4-37"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>ngx_alloc</code> 就是对 <code>malloc</code> 的简单封装，直接分配一段内存，然后向 <code>pool-&gt;large</code> 中以 <code>ngx_pool_large_t</code> 组成的链表中插入。这里有一个小优化：因为 <code>ngx_pool_large_t</code> 本身也要占用内存，为了复用已经被释放的 <code>ngx_pool_large_t</code> ，尝试链表的前几项，如果几项中都没有空的位置，因为 <code>ngx_pool_large_t</code> 本身是一个很小的对象，自然可以复用自己在内存池中分配对象的方法 <code>ngx_palloc_small</code> ，然后把它加入到 <code>pool-&gt;large</code> 的链表的第一向前。如果很大的内存都在分配后很快释放，这种方法可以复用很多的 <code>ngx_pool_large_t</code> 。</p>
<p>接下来分析 <code>ngx_palloc_small</code> ：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="n">ngx_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-5-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">ngx_uint_t</span><span class="w"> </span><span class="n">align</span><span class="p">)</span>
</span><span id="__span-5-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="p">{</span>
</span><span id="__span-5-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="n">u_char</span><span class="w">      </span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-5-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-5-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>
</span><span id="__span-5-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>
</span><span id="__span-5-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
</span><span id="__span-5-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>
</span><span id="__span-5-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">            </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">NGX_ALIGNMENT</span><span class="p">);</span>
</span><span id="__span-5-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>
</span><span id="__span-5-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">            </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-5-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>
</span><span id="__span-5-19"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-5-20"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-5-21"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>
</span><span id="__span-5-22"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-5-23"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>
</span><span id="__span-5-24"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-5-25"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>
</span><span id="__span-5-26"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ngx_palloc_block</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-5-27"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>首先，从 <code>pool-&gt;current</code> 遍历（这样做的原因下面会提到）已有的各个块，寻找有没有哪个块能容纳下现在需要的大小，如果能就可以调整 <code>p-&gt;d.last</code> 返回，否则就分配一个新的块到内存池中，再从新的块中分配需要的大小的内存。需要一提的是，在设计中，小的对象是随着整个内存池的销毁而被一起释放的，不会在中途被释放，而大的对象尽量要用完即释放。接下来分析 <code>ngx_palloc_block</code> ：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-6-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nf">ngx_palloc_block</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-6-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">{</span>
</span><span id="__span-6-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="n">u_char</span><span class="w">      </span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="kt">size_t</span><span class="w">       </span><span class="n">psize</span><span class="p">;</span>
</span><span id="__span-6-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">  </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-6-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="n">psize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">u_char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">pool</span><span class="p">);</span>
</span><span id="__span-6-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span><span class="w"> </span><span class="n">psize</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
</span><span id="__span-6-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-6-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>
</span><span id="__span-6-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>
</span><span id="__span-6-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">psize</span><span class="p">;</span>
</span><span id="__span-6-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-6-19"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-20"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>
</span><span id="__span-6-21"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_data_t</span><span class="p">);</span>
</span><span id="__span-6-22"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">NGX_ALIGNMENT</span><span class="p">);</span>
</span><span id="__span-6-23"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-6-24"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>
</span><span id="__span-6-25"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-26"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-27"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">            </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-6-28"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-29"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-30"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a>
</span><span id="__span-6-31"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="p">;</span>
</span><span id="__span-6-32"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>
</span><span id="__span-6-33"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</span><span id="__span-6-34"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="p">}</span>
</span></code></pre></div>
<p>为了节省内存，结构体中并没有记录实际分配的内存块的大小，于是根据第一个块的大小分配当前的块，虽然这里用的也是一个类型为 <code>ngx_pool_t</code> 结构体，实际上只用到了 <code>new-&gt;d</code> 中的内容维护块组成的链表和块内的分配情况。然后从 <code>pool-&gt;current</code> 开始找块的链表的结尾，找到节尾后把当前的块加到结尾的后面，然后把刚才需要分配的小对象的地址返回。与此同时，由于调用这个函数的时候，一定是当前的对象在已有的从 <code>pool-&gt;current</code> 开始的块中都放不下了，我们给这些块的 <code>p-&gt;d.failed</code> 进行自增，意思是说这个块在分配新的对象的时候又一次放不下了，如果放不下的次数比较多，我们可以认为这个块已经装得比较满了，那么，我们把 <code>pool-&gt;current</code> 设为它的后继，以后在分配新的对象的时候就会自动跳过这些比较满的块，从而提高了效率。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">ngx_int_t</span>
</span><span id="__span-7-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nf">ngx_pfree</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-7-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="p">{</span>
</span><span id="__span-7-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">  </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span><span id="__span-7-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">            </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-7-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">                           </span><span class="s">"free: %p"</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-7-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">            </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-7-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">            </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-7-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">NGX_OK</span><span class="p">;</span>
</span><span id="__span-7-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-7-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>
</span><span id="__span-7-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NGX_DECLINED</span><span class="p">;</span>
</span><span id="__span-7-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>从 <code>ngx_pfree</code> 的实现可以看出，只有大的对象才会要求尽快释放，小的对象和没有被手动释放的大的对象都会随着内存池生命周期的结束而一起释放。如 <code>ngx_destroy_pool</code> 中的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">void</span>
</span><span id="__span-8-2"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nf">ngx_destroy_pool</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="w"> </span><span class="o">*</span><span class="n">pool</span><span class="p">)</span>
</span><span id="__span-8-3"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="p">{</span>
</span><span id="__span-8-4"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="n">ngx_pool_t</span><span class="w">          </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-8-5"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="n">ngx_pool_large_t</span><span class="w">    </span><span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span><span id="__span-8-6"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="n">ngx_pool_cleanup_t</span><span class="w">  </span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
</span><span id="__span-8-7"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>
</span><span id="__span-8-8"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-9"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-10"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">            </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-11"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">                           </span><span class="s">"run cleanup: %p"</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-8-12"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">            </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-8-13"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-14"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-15"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>
</span><span id="__span-8-16"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="cp">##if (NGX_DEBUG)</span>
</span><span id="__span-8-17"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>
</span><span id="__span-8-18"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-8-19"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="cm">     * we could allocate the pool-&gt;log from this pool</span>
</span><span id="__span-8-20"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="cm">     * so we cannot use this log while free()ing the pool</span>
</span><span id="__span-8-21"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="cm">     */</span>
</span><span id="__span-8-22"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a>
</span><span id="__span-8-23"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-24"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">"free: %p"</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-8-25"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-26"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a>
</span><span id="__span-8-27"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="cm">/* void */</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-28"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">        </span><span class="n">ngx_log_debug2</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-8-29"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">                       </span><span class="s">"free: %p, unused: %uz"</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span id="__span-8-30"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a>
</span><span id="__span-8-31"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-32"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-32" id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-8-33"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-33" id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-34"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-34" id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-35"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-35" id="__codelineno-8-35" name="__codelineno-8-35"></a>
</span><span id="__span-8-36"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-36" id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="cp">##endif</span>
</span><span id="__span-8-37"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-37" id="__codelineno-8-37" name="__codelineno-8-37"></a>
</span><span id="__span-8-38"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-38" id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-39"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-39" id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-40"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-40" id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">            </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
</span><span id="__span-8-41"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-41" id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-42"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-42" id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-43"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-43" id="__codelineno-8-43" name="__codelineno-8-43"></a>
</span><span id="__span-8-44"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-44" id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="cm">/* void */</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-45"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-45" id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">        </span><span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-8-46"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-46" id="__codelineno-8-46" name="__codelineno-8-46"></a>
</span><span id="__span-8-47"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-47" id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-48"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-48" id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-8-49"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-49" id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-50"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-50" id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-51"><a href="../../programming/2017/12/02/on-nginx-memory-pool/#__codelineno-8-51" id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数首先调用了一系列用户定义的 <code>pool-&gt;cleanup</code> 链表中的函数，允许自定义回收一些特定的资源。然后对每一个 <code>pool-&gt;large</code> 链表中的内容分别释放，最后再把各个块中所有的内存整块释放。注意 <code>ngx_large_block_t</code> 也是存在块中的，所以顺序不能反了。</p>
<nav class="md-post__action">
<a href="../../programming/2017/12/02/on-nginx-memory-pool/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../31/">31</a> <a class="md-pagination__link" href="../32/">32</a> <span class="md-pagination__current">33</span> <a class="md-pagination__link" href="../34/">34</a> <a class="md-pagination__link" href="../35/">35</a> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>