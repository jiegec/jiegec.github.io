
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/2/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-06 00:00:00">2023年5月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="linux-6213-bug-vivado-fpga"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/">Linux 6.2.13 引入的 BUG 导致 Vivado 无法识别 FPGA</a></h2>
<p><a href="/software/2023/05/06/linux-regression-vivado-en/">English version</a></p>
<h3 id="tldr"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#tldr">TLDR</a></h3>
<p>简单来说，Linux 6.2.13 引入的 commit：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac
</span><span id="__span-0-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>Date:   Fri Apr 14 14:59:19 2023 -0400
</span><span id="__span-0-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>    mm/mmap: regression fix for unmapped_area{_topdown}
</span><span id="__span-0-6"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>    commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream.
</span><span id="__span-0-8"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>    The maple tree limits the gap returned to a window that specifically fits
</span><span id="__span-0-10"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>    what was asked.  This may not be optimal in the case of switching search
</span><span id="__span-0-11"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>    directions or a gap that does not satisfy the requested space for other
</span><span id="__span-0-12"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>    reasons.  Fix the search by retrying the operation and limiting the search
</span><span id="__span-0-13"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>    window in the rare occasion that a conflict occurs.
</span><span id="__span-0-14"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>
</span><span id="__span-0-15"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>    Link: https://lkml.kernel.org/r/20230414185919.4175572-1-Liam.Howlett@oracle.com
</span><span id="__span-0-16"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>    Fixes: 3499a13168da ("mm/mmap: use maple tree for unmapped_area{_topdown}")
</span><span id="__span-0-17"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>    Signed-off-by: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-0-18"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>    Reported-by: Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;
</span><span id="__span-0-19"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>    Cc: &lt;stable@vger.kernel.org&gt;
</span><span id="__span-0-20"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</span><span id="__span-0-21"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</span></code></pre></div>
<p>修复了 BUG 的同时，引入了新的 BUG，导致 MAP_32BIT 有时无法工作，而 Xilinx 的 Digilent 下载器代码使用了这个参数，导致 mmap 失败，无法识别 FPGA。</p>
<h3 id="_1"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#_1">背景</a></h3>
<p>事情的背景是，@vowstar 升级内核到 6.2.14 以后，发现 Vivado 找不到 FPGA 了，重启回到 6.2.12 就好了。</p>
<h3 id="_2"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#_2">排查</a></h3>
<p>因为升级了内核，第一反应是不是 ftdi_sio 驱动的问题。比对了一下二者的 dmesg 日志，发现 Linux 6.2.12 会显示 <code>ftdi_sio: device disconnected</code> 消息：这是因为 FPGA 下载器内置的是 FTDI 芯片，它支持多种模式，默认情况下，内核检测到设备以后，会由 ftdi_sio 驱动初始化为串口模式，创建 <code>/dev/ttyUSB*</code> 设备；而 Vivado 需要用的是 MPSSE 模式，从而使用 JTAG 协议与 FPGA 通讯。这与串口模式冲突，因此 Vivado 要做的事情，首先是把内核模块 detach，也就是不再占用 USB 设备，然后再让 FTDI 芯片进入 MPSSE 模式。</p>
<p>沿着这个思路，首先想到的是权限问题：默认情况下，USB 设备权限比较严格，所以 Vivado 在安装的时候，会安装 udev rule，把 Digilent 下载器的 usb 设备文件的权限改为 666，这样就允许所有用户访问 USB 设备。但是检查了一下，/dev/bus/usb 下的设备文件权限是正确的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>kernel<span class="w"> </span><span class="m">6</span>.2.12:<span class="w"> </span>crw-rw-rw-<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>usb<span class="w"> </span><span class="m">189</span>,<span class="w"> </span><span class="m">271</span><span class="w"> </span>May<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">15</span>:31<span class="w"> </span>/dev/bus/usb/003/016
</span><span id="__span-1-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>kernel<span class="w"> </span><span class="m">6</span>.2.14:<span class="w"> </span>crw-rw-rw-<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>usb<span class="w"> </span><span class="m">189</span>,<span class="w"> </span><span class="m">262</span><span class="w"> </span>May<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">15</span>:32<span class="w"> </span>/dev/bus/usb/003/016
</span></code></pre></div>
<p>这时候就觉得很蹊跷，只更新了内核，其他都没有变，为什么行为就会不同。于是翻了翻 Linux 内核的 ChangeLog，因为 6.2.12 是好的，6.2.14 是不工作的，所以只需要看两者之间的 changelog：</p>
<ul>
<li><a href="https://cdn.kernel.org/pub/linux/kernel/v6.x/ChangeLog-6.2.13">6.2.13</a></li>
<li><a href="https://cdn.kernel.org/pub/linux/kernel/v6.x/ChangeLog-6.2.14">6.2.14</a></li>
</ul>
<p>以 ftdi 或 usb 为关键词搜索，只有一个看起来有一些相关的 commit：<code>USB: serial: option: add UNISOC vendor and TOZED LT70C product</code>，但是仔细一看，只是添加了新的 VID/PID，也没有和 Digilent 下载器冲突。</p>
<p>这时候，就觉得不是 Linux 的问题了。按照这个思路，继续控制变量法，看看是不是 FTDI 芯片出了问题。这时候就祭出了 OpenOCD，看看 OpenOCD 能否配置 FTDI 芯片进入 MPSSE 模式，并且找到 FPGA。试了一下，还真可以，ftdi_sio 正常 detach，然后 OpenOCD 也找到 FPGA 了。</p>
<p>但此时再打开 Vivado，还是找不到设备，说明不是 MPSSE 模式的问题。考虑到 Vivado 访问硬件的进程是 hw_server，想到能不能看看 hw_server 的日志。</p>
<p>运行 hw_server，打印所有日志类型：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>hw_server<span class="w"> </span>-L-<span class="w"> </span>-l<span class="w"> </span>alloc,eventcore,waitpid,events,protocol,context,children,discovery,asyncreq,proxy,tcflog,elf,stack,plugin,shutdown,disasm,jtag2,jtag,pcie,slave,dpc
</span></code></pre></div>
<p>这里 <code>-L-</code> 表示输出日志到 stderr，后面的 <code>-l</code> 一串参数就是各种日志开关。在两个内核里都运行一次，比对日志，发现了不同：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>Success<span class="w"> </span><span class="o">(</span><span class="m">6</span>.2.12<span class="o">)</span>:
</span><span id="__span-3-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>TCF<span class="w"> </span><span class="m">08</span>:39:37.247:<span class="w"> </span>jtagpoll:<span class="w"> </span>add<span class="w"> </span>node<span class="w"> </span>0xxxxxxxx<span class="o">(</span>jsn-JTAG-SMT2NC-XXXXXXXXXXXX<span class="o">)</span>
</span><span id="__span-3-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>TCF<span class="w"> </span><span class="m">08</span>:39:37.247:<span class="w"> </span>Node<span class="w"> </span>000000FF,<span class="w"> </span>added<span class="w"> </span>jsn-JTAG-SMT2NC-XXXXXXXXXXXX
</span><span id="__span-3-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>Failed<span class="w"> </span><span class="o">(</span><span class="m">6</span>.2.14<span class="o">)</span>:
</span><span id="__span-3-6"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>TCF<span class="w"> </span><span class="m">08</span>:45:12.385:<span class="w"> </span>jtagpoll:<span class="w"> </span>cannot<span class="w"> </span>get<span class="w"> </span>port<span class="w"> </span>description<span class="w"> </span>list:<span class="w"> </span>ftdidb_lock<span class="w"> </span>failed:<span class="w"> </span>FTDMGR<span class="w"> </span>wasn<span class="err">'</span>t<span class="w"> </span>properly<span class="w"> </span>initialized
</span><span id="__span-3-7"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>TCF<span class="w"> </span><span class="m">08</span>:45:12.391:<span class="w"> </span>jtagpoll:<span class="w"> </span>cannot<span class="w"> </span>get<span class="w"> </span>port<span class="w"> </span>description<span class="w"> </span>list:<span class="w"> </span>JTAG<span class="w"> </span>device<span class="w"> </span>enumeration<span class="w"> </span>failed:<span class="w"> </span>Initialization<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>DPCOMM<span class="w"> </span>library<span class="w"> </span>failed.
</span></code></pre></div>
<p>终于看到了错误信息：<code>jtagpoll: cannot get port description list: ftdidb_lock failed: FTDMGR wasn't properly initialized</code>。把这个作为关键词一搜索，果然有别人也遇到了同样的问题：</p>
<ul>
<li><a href="https://support.xilinx.com/s/article/000033531?language=en_US">XSDB fails with "ftdidb_lock failed: FTDMGR wasn't properly initialized"</a></li>
<li><a href="https://blog.t123yh.xyz:2/index.php/archives/1013">Linux 多用户环境下 Vivado 无法连接 Digilent JTAG 适配器的解决方法</a></li>
</ul>
<p>尝试了第一篇文章的解决方案，没有效果。第二篇文章指出的问题是，多用户环境下，多个用户抢同一个文件，然后出现权限问题，所以要删掉文件再启动。按照第二篇文档的方法尝试了一下，也没有解决问题。</p>
<p>但是第二篇文章给出了一个调试方法：运行 Digilent 提供的 dadutil 程序，看看它是否可以识别下载器，果然复现出问题了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>dadutil<span class="w"> </span>enum
</span><span id="__span-4-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>ERROR:<span class="w"> </span>DmgrSetNetworkEnumTimeout<span class="w"> </span>failed,<span class="w"> </span><span class="nv">erc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3090</span>
</span><span id="__span-4-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>$<span class="w"> </span>dadutil<span class="w"> </span>enum
</span><span id="__span-4-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>device<span class="o">(</span>s<span class="o">)</span>
</span><span id="__span-4-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>$<span class="w"> </span>dadutil<span class="w"> </span>enum
</span><span id="__span-4-6"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>device<span class="o">(</span>s<span class="o">)</span>
</span><span id="__span-4-7"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>$<span class="w"> </span>dadutil<span class="w"> </span>enum
</span><span id="__span-4-8"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>ERROR:<span class="w"> </span>DmgrSetNetworkEnumTimeout<span class="w"> </span>failed,<span class="w"> </span><span class="nv">erc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3090</span>
</span></code></pre></div>
<p>到这里多次尝试，发现有三分之一的概率会失败，但已经足够解释为什么 hw_server 不工作了：大概率它也调用了 Digilent 提供的代码，得到了同样的结果，所以失败了。</p>
<p>上面第二篇文章用 strace 的方法找到了问题，照葫芦画瓢，用 strace 找到出错的日志：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>strace<span class="w"> </span>dadutil<span class="w"> </span>enum
</span><span id="__span-5-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>openat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"/dev/shm/digilent-adept2-mtx-ftdmgr"</span>,<span class="w"> </span>O_RDWR<span class="p">|</span>O_NOFOLLOW<span class="p">|</span>O_CLOEXEC<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
</span><span id="__span-5-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>ftruncate<span class="o">(</span><span class="m">7</span>,<span class="w"> </span><span class="m">4</span><span class="o">)</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-5-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>mmap<span class="o">(</span>NULL,<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>PROT_READ<span class="p">|</span>PROT_WRITE,<span class="w"> </span>MAP_SHARED<span class="p">|</span>MAP_32BIT,<span class="w"> </span><span class="m">7</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOMEM<span class="w"> </span><span class="o">(</span>Cannot<span class="w"> </span>allocate<span class="w"> </span>memory<span class="o">)</span>
</span><span id="__span-5-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>close<span class="o">(</span><span class="m">7</span><span class="o">)</span><span class="w">                                </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span></code></pre></div>
<p>可以发现问题是返回了 ENOMEM，这就很奇怪了，<code>/dev/shm</code> 是个 tmpfs，还有很多空间，怎么会返回 ENOMEM 呢？</p>
<h3 id="_3"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#_3">柳暗花明又一村</a></h3>
<p>按照新线索继续研究：mmap 返回了不应该返回的错误，那是不是 6.2.13 或 6.2.14 引入了相关改动呢？一查，还真有：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>## https://cdn.kernel.org/pub/linux/kernel/v6.x/ChangeLog-6.2.13
</span><span id="__span-6-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac
</span><span id="__span-6-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-6-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>Date:   Fri Apr 14 14:59:19 2023 -0400
</span><span id="__span-6-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>
</span><span id="__span-6-6"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w"> </span>   mm/mmap: regression fix for unmapped_area{_topdown}
</span><span id="__span-6-7"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w"> </span>   commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream.
</span><span id="__span-6-9"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w"> </span>   The maple tree limits the gap returned to a window that specifically fits
</span><span id="__span-6-11"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w"> </span>   what was asked.  This may not be optimal in the case of switching search
</span><span id="__span-6-12"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w"> </span>   directions or a gap that does not satisfy the requested space for other
</span><span id="__span-6-13"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w"> </span>   reasons.  Fix the search by retrying the operation and limiting the search
</span><span id="__span-6-14"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w"> </span>   window in the rare occasion that a conflict occurs.
</span><span id="__span-6-15"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w"> </span>   Link: https://lkml.kernel.org/r/20230414185919.4175572-1-Liam.Howlett@oracle.com
</span><span id="__span-6-17"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w"> </span>   Fixes: 3499a13168da ("mm/mmap: use maple tree for unmapped_area{_topdown}")
</span><span id="__span-6-18"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w"> </span>   Signed-off-by: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt;
</span><span id="__span-6-19"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w"> </span>   Reported-by: Rick Edgecombe &lt;rick.p.edgecombe@intel.com&gt;
</span><span id="__span-6-20"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w"> </span>   Cc: &lt;stable@vger.kernel.org&gt;
</span><span id="__span-6-21"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w"> </span>   Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
</span><span id="__span-6-22"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w"> </span>   Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</span></code></pre></div>
<p>和 mmap 相关，点进<a href="https://lkml.kernel.org/r/20230414185919.4175572-1-Liam.Howlett@oracle.com">邮件链接</a>看看，发现有人提出这个 commit 虽然修复了一个 BUG，但是引入了新的 BUG：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>* Re: [PATCH v2] mm/mmap: Regression fix for unmapped_area{_topdown}
</span><span id="__span-7-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>  2023-04-14 18:59   ` [PATCH v2] " Liam R. Howlett
</span><span id="__span-7-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>  2023-04-14 19:09     ` Andrew Morton
</span><span id="__span-7-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>@ 2023-04-29 14:32     ` Tad
</span><span id="__span-7-5"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>  2023-04-30 22:41       ` Michael Keyes
</span><span id="__span-7-6"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>  1 sibling, 1 reply; 18+ messages in thread
</span><span id="__span-7-7"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>From: Tad @ 2023-04-29 14:32 UTC (permalink / raw)
</span><span id="__span-7-8"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>  To: liam.howlett; +Cc: akpm, linux-kernel, linux-mm, rick.p.edgecombe
</span><span id="__span-7-9"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>
</span><span id="__span-7-10"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>This reintroduces the issue described in
</span><span id="__span-7-11"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>https://lore.kernel.org/linux-mm/cb8dc31a-fef2-1d09-f133-e9f7b9f9e77a@sony.com/
</span><span id="__span-7-12"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>Linux 6.2.13 can no longer successfully run the mmap-test reproducer linked
</span><span id="__span-7-14"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>there.
</span><span id="__span-7-15"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>
</span><span id="__span-7-16"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>Linux 6.2.12 passes.
</span><span id="__span-7-17"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>
</span><span id="__span-7-18"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>Regards,
</span><span id="__span-7-19"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>Tad.
</span></code></pre></div>
<p>再继续跟踪上面的<a href="https://lore.kernel.org/linux-mm/cb8dc31a-fef2-1d09-f133-e9f7b9f9e77a@sony.com/">链接</a>，赫然看到里面的错误日志里，也出现了类似的 mmap 调用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>&gt;<span class="w"> </span>mmap<span class="o">(</span>NULL,<span class="w"> </span><span class="m">131072</span>,<span class="w"> </span>PROT_READ<span class="p">|</span>PROT_WRITE,<span class="w"> </span>MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_32BIT,<span class="w"> </span>-1,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x40720000
</span><span id="__span-8-2"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>&gt;<span class="w"> </span>mmap<span class="o">(</span>NULL,<span class="w"> </span><span class="m">131072</span>,<span class="w"> </span>PROT_READ<span class="p">|</span>PROT_WRITE,<span class="w"> </span>MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_32BIT,<span class="w"> </span>-1,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x4124e000
</span><span id="__span-8-3"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>&gt;<span class="w"> </span>mmap<span class="o">(</span>NULL,<span class="w"> </span><span class="m">131072</span>,<span class="w"> </span>PROT_READ<span class="p">|</span>PROT_WRITE,<span class="w"> </span>MAP_PRIVATE<span class="p">|</span>MAP_ANONYMOUS<span class="p">|</span>MAP_32BIT,<span class="w"> </span>-1,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOMEM<span class="w"> </span><span class="o">(</span>Cannot<span class="w"> </span>allocate<span class="w"> </span>memory<span class="o">)</span>
</span><span id="__span-8-4"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>&gt;<span class="w"> </span>dex2oatd<span class="w"> </span>F<span class="w"> </span><span class="m">03</span>-01<span class="w"> </span><span class="m">10</span>:32:33<span class="w"> </span><span class="m">74063</span><span class="w"> </span><span class="m">74063</span><span class="w"> </span>mem_map_arena_pool.cc:65<span class="o">]</span><span class="w"> </span>Check<span class="w"> </span>failed:<span class="w"> </span>map.IsValid<span class="o">()</span><span class="w"> </span>Failed<span class="w"> </span>anonymous<span class="w"> </span>mmap<span class="o">((</span>nil<span class="o">)</span>,<span class="w"> </span><span class="m">131072</span>,<span class="w"> </span>0x3,<span class="w"> </span>0x22,<span class="w"> </span>-1,<span class="w"> </span><span class="m">0</span><span class="o">)</span>:<span class="w"> </span>Cannot<span class="w"> </span>allocate<span class="w"> </span>memory.<span class="w"> </span>See<span class="w"> </span>process<span class="w"> </span>maps<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>log.
</span></code></pre></div>
<p>再看看上面 <code>dadutil enum</code> 报错的 mmap 日志：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2023/05/06/linux-regression-vivado/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>mmap<span class="o">(</span>NULL,<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>PROT_READ<span class="p">|</span>PROT_WRITE,<span class="w"> </span>MAP_SHARED<span class="p">|</span>MAP_32BIT,<span class="w"> </span><span class="m">7</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>ENOMEM<span class="w"> </span><span class="o">(</span>Cannot<span class="w"> </span>allocate<span class="w"> </span>memory<span class="o">)</span>
</span></code></pre></div>
<p>赫然也是 MAP_32BIT，结果也是 ENOMEM，那说明就是这个问题了。结合邮件列表的其他讨论，基本可以确认是作者忽略了 MAP_32BIT 的情况，所以出现了问题。</p>
<p>从 Linux 6.2.14 回滚出问题的 commit 以后，问题解决了。</p>
<h3 id="_4"><a class="toclink" href="../../software/2023/05/06/linux-regression-vivado/#_4">总结</a></h3>
<p>这就是整个 Debug 流程，从 Vivado 找不到 FPGA 的表象，到内在的 Linux 内核 BUG，看起来毫不相关，但却能发现背后的逻辑。</p>
<p>我和 @vowstar 一起完成了整个调试的流程，学到了许多，因此写了这篇博客。</p>
<nav class="md-post__action">
<a href="../../software/2023/05/06/linux-regression-vivado/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-03 00:00:00">2023年5月3日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="i2c"><a class="toclink" href="../../hardware/2023/05/03/i2c/">I2C 协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/i2c.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_1">背景</a></h3>
<p>最近数设课上，同学们开始购买外设，其中就涉及到 I2C 协议，因此顺带写一下 I2C 协议的教程，帮助同学们进行理解。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_2">接口</a></h3>
<p>I2C 协议涉及到两个信号：</p>
<ul>
<li>SCL: 时钟信号，Master -&gt; Slave</li>
<li>SDA：数据信号，Master &lt;-&gt; Slave</li>
</ul>
<p>由于只有一个数据信号，所以 SDA 由 Master 和 Slave 轮流输出。一次请求的开始条件是，SDA 从 1 变成 0，之后 SCL 从 1 变成 0。开始请求以后，每次 SCL 上升沿采样一位的数据。请求结束时，SCL 从 0 变成 1，然后 SDA 从 0 变成 1。一次请求的波形如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "scl", wave: "1.0101010|.101..."},
      { name: "sda", wave: "10....1..|0....1."},
      { name: "i2c", wave: "34.5.....|6.7....", data: ["idle", "start", "data", "ack", "stop"]},
    ]
}</script>
<ol>
<li>idle 阶段，scl 和 sda 都是 1</li>
<li>start 阶段，首先是 sda 变成 0，之后是 scl 变成 0</li>
<li>data/ack 阶段，在 scl 上升沿采样数据，在 scl 下降沿（准确来说，负半周期）修改数据</li>
<li>stop 阶段，首先是 scl 变成 1，之后是 sda 变成 1</li>
</ol>
<p>传输数据的时候，需要保证 sda 在 scl 正半周期的时候保持不变。如果变了，那就是 start 或者 stop。因此，在 data/ack 阶段，建议 sda 的变化相比 scl 下降沿有一个延迟（Hold Time，一般的要求是 Min 0us）。实现方法可能是在分频的时候，延迟一个周期。</p>
<p>这里的 data/ack 指的则是传输的具体内容：例如 master 要传输 7 位的地址和 1 位的读使能，响应地址的 slave 要返回 ack；之后，无论是 master 还是 slave 发送数据，接收的一方都要返回 ack。ack 是低有效，意味着 0 表示成功，1 表示失败。</p>
<p>由于 sda 带有上拉电阻，所以如果没有 slave 响应，ack 阶段的 sda 就会变成 1，意味着失败。</p>
<h3 id="i2c_1"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c_1">I2C 控制器实现</a></h3>
<p>结合上面的 I2C 波形，可以设计一个状态机：</p>
<ol>
<li>INIT 状态：初始情况下，SCL 和 SDA 都为 1，要发送数据的时候，转移到 START1 状态</li>
<li>START1 状态：设置 SDA=0，当达到分频条件时，转移到 START2 状态</li>
<li>START2 状态：设置 SCL=0，当达到分频条件时，START 发送完成，转移到 SEND 状态</li>
<li>SEND 状态：当达到分频条件时，SCL 取反，如果 SCL 要从 1 变成 0，延迟一个周期，再输出 1 位的数据到 SDA 上，保证 SDA 的变化在 SCL 的负半周期；同时统计传输位数，每传输 8 位，就要等待一个周期让 Slave 响应 ACK，此时要设置 inout 输出为高阻态；如果要转换传输方向，即 Master 要读取数据，那么转移到 RECV 状态；如果传输结束，转移到 STOP1 状态</li>
<li>RECV 状态：当达到分频条件时，SCL 取反，如果 SCL 从 0 变成 1，对 SDA 进行采样并且保存下来；同时统计传输位数，每传输 8 位，就要在 SDA 输出一次 ACK；如果传输结束，转移到 STOP1 状态</li>
<li>STOP1 状态：设置 SCL=1，当达到分频条件时，转移到 STOP2 状态</li>
<li>STOP2 状态：设置 SDA=1，当达到分频条件时，转移到 INIT 状态</li>
</ol>
<p>分频是因为一般 I2C 的频率比较低，是 kHz 的量级。需要按照控制逻辑的主频，结合外设能接受的 I2C 频率范围，计算出分频的倍数。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/05/03/i2c/#_3">上层协议</a></h3>
<p>在此基础上，可以设计上层协议，例如 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a>，支持通过 I2C 写入内部寄存器，一次写操作分为以下步骤：</p>
<ol>
<li>start</li>
<li>master 发送 7 位的设备地址和 0（表示写），slave 发送 ack</li>
<li>master 发送 7 位的寄存器地址 和 1 位的寄存器数据，slave 发送 ack</li>
<li>master 发送 8 位的寄存器数据，slave 发送 ack</li>
<li>stop</li>
</ol>
<p>这里的第二步发送的 7 位地址 + 读/写位是标准的，I2C Slave 都会根据 7 位地址来决定是否由自己来响应。此后的数据的定义，则是各个芯片按照各自的协议来进行。</p>
<p>为了让多个同型号 I2C 芯片可以同时使用，通常芯片提供了一些引脚来配置它的地址，那么在设计的时候，给不同的芯片设置不同的地址，就解决了地址冲突的问题。</p>
<h3 id="i2c-eeprom"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-eeprom">I2C EEPROM</a></h3>
<p>以 <a href="https://ww1.microchip.com/downloads/en/devicedoc/doc0336.pdf">AT24C32/AT24C64</a> 为例，它提供了一个 I2C 接口的 EEPROM，支持如下操作：</p>
<p>写入数据：start，7 位设备地址，W，ACK；写入地址的高 8 位，ack；写入地址的低 8 位，ack；数据的每个字节，ack；最终 stop。</p>
<p>读取数据：start，7 位设备地址，W，ack；读取地址的高 8 位，ack；读取地址的低 8 位，ack；start，7 位设备地址，R，ack；数据的每个字节，ack；最终不想读的时候 nack，stop。</p>
<p>可以看到，这里设计成写操作的时候，只有 Master 到 Slave 的数据传输，反过来读操作的时候，只有 Slave 到 Master 的数据传输。因此，为了传输读取的地址，要首先“写入”读取的地址，再进行一次读操作，把数据读出来。</p>
<h3 id="i2c-audio-codec"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-audio-codec">I2C Audio Codec</a></h3>
<p>上面的例子中的 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a> 实际上就是一个 Audio Codec，可以通过 I2C 对其寄存器进行写入。WM8731 的寄存器地址有 9 位，每个寄存器有 8 位的数据，因此写入流程是：start，7 位设备地址，W，ack；7 位寄存器地址，1 位寄存器数据，ack；8 位寄存器数据，ack；stop。</p>
<h3 id="i2c-sensor"><a class="toclink" href="../../hardware/2023/05/03/i2c/#i2c-sensor">I2C Sensor</a></h3>
<p>举一个传感器的例子：<a href="https://m5stack.oss-cn-shenzhen.aliyuncs.com/resource/docs/datasheet/unit/gesture/paj7620u2_datasheet.pdf">PAJ7620U2: Integrated Gesture Recognition Sensor </a>，它也提供了一个寄存器读写的接口，支持如下操作：</p>
<p>单次写入：start，7 位设备地址，W，ack；8 位地址，ack；8 位数据，ack；stop。</p>
<p>单次读取：start，7 位设备地址，W，ack；8 位地址，ack；stop；start，7 位设备地址，R，ack；8 位数据，nack；stop。这里的读取也拆成了两步：第一步“写入”读取的地址，第二步读取出数据。最后的 nack 表示 master 不需要读取更多的数据。</p>
<p>如果要批量读取的话，只要在单次读取的基础上，读取数据的时候发 ack，等到不需要继续读的时候再发 nack，就可以连续读取多个寄存器的数据。</p>
<p>这些命令格式和上面的 I2C EEPROM 基本是一样的。</p>
<p>颜色传感器 <a href="https://cdn-shop.adafruit.com/datasheets/TCS34725.pdf">TCS3472</a> 的命令格式也是类似的。</p>
<nav class="md-post__action">
<a href="../../hardware/2023/05/03/i2c/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-26 00:00:00">2023年4月26日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="spi"><a class="toclink" href="../../hardware/2023/04/26/spi/">SPI 协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/spi.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/26/spi/#_1">背景</a></h3>
<p>最近数设课上，同学们开始购买外设，其中就涉及到 SPI 协议，因此顺带写一下 SPI 协议的教程，帮助同学们进行理解。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/04/26/spi/#_2">接口</a></h3>
<p>SPI 协议涉及到四个信号：</p>
<ul>
<li>SCLK: 时钟信号，Master -&gt; Slave</li>
<li>MOSI：数据信号，Master -&gt; Slave</li>
<li>MISO：数据信号，Slave -&gt; Master</li>
<li>CS：芯片使能，一般是低有效</li>
</ul>
<p>要通过 SPI 协议发送命令的时候，通常需要先拉低 CS，然后启动 SCLK 时钟，同时收发数据。注意 SPI 是全双工的，也就是发送的同时也在接收，只不过通常来说，外设等到主机发送了命令本身，才知道要回复什么，所以很多时候命令设计成了事实上的半双工：前半部分主机在发命令，外设发送无用的数据；后半部分外设在发送响应，主机发送无用的数据。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/04/26/spi/#_3">波形</a></h3>
<p>SPI 有不同的类型，下面讲一种比较常见的配置（即 CPOL=0，CPHA=0），在这种模式下，Master 和 Slave 都是在时钟的下降沿修改输出的数据，然后在时钟（<code>sclk</code>）的上升沿对接收到的数据进行采样：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........"},
      { name: "sclk", wave: "0.101010."},
      { name: "mosi", wave: "03.4.5.x."},
      { name: "miso", wave: "06.7.8.x."},
      { name: "cs_n", wave: "10......1"},
    ]
}</script>
<p>波形图中，时钟（<code>sclk</code>）上升沿时，数据处于稳定的状态，所以此时 Master 对 MISO 采样，Slave 对 MOSI 采样，可以得到稳定的数据；时钟下降沿时，Master 和 Slave 修改输出的数据。</p>
<p>实际在 RTL 中实现的时候，Master 可以不写 negedge 逻辑，而是写一个分频器，在分频出来的负半周期里，实现数据的修改，如上图中的 <code>clk</code> 分频到 <code>sclk</code>。一般使用一个状态机来实现 SPI Master，记录当前传输到哪一个 bit，以及记录当前是 <code>sclk</code> 的正半周期还是负半周期。</p>
<p>SPI 本身很简单，所以核心不在 SPI，而是在 SPI 之上定义的各种协议。</p>
<h3 id="spi-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-flash">SPI Flash</a></h3>
<p>SPI Flash 是一种很常见的 SPI 外设，可以用来访问 NAND/NOR Flash。</p>
<p>为了提升性能，很多 SPI Flash 还会提供 Dual SPI 和 Quad SPI 模式。标准的 SPI 中，Master 到 Slave 和 Slave 到 Master 分别是一根信号线，如果要继续提高性能，那就要引入更多的信号线来进行数据传输，所以 Dual SPI 就是让原来的 MISO 和 MOSI 都可以同时发送数据；Quad SPI 则是又额外添加了两个信号线来进行数据传输。</p>
<p>常见的 SPI Flash 厂家：</p>
<ul>
<li>Spansion -&gt; Cypress -&gt; Infineon</li>
<li>Numonyx -&gt; Micron</li>
<li>Winbond</li>
<li>GigaDevice</li>
<li>Macronix</li>
</ul>
<h4 id="spi-nand-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-nand-flash">SPI NAND Flash</a></h4>
<p>下面以 <a href="https://www.alliancememory.com/wp-content/uploads/pdf/flash/AllianceMemory_SPI_NAND_Flash_July2020_Rev1.0.pdf">Alliance Memory SPI NAND Flash Datasheet</a> 为例子，看看通常 SPI Flash 都支持哪些命令，都是如何传输数据的。</p>
<p>这款 SPI NAND Flash 的内部存储分为三层：</p>
<ol>
<li>Block：数量不定</li>
<li>Page：每个 Block 包括 64 个 Page</li>
<li>Byte：每个 Page 包括一定数量的 Byte，常见的有 2112(2048+64)、2176(2048+128)、4352(4096+256)</li>
</ol>
<p>NAND Flash 的读取粒度是 Page，这就是为什么 NAND Flash 更像块设备。一次读取过程分为三个步骤：</p>
<ol>
<li>发送 13H(Page Read to Cache) 命令，把一个 Page 的数据读取到 NAND Flash 内部的 Cache 中</li>
<li>不断发送 0FH(Get Feature) 命令，直到 NAND Flash 表示 Page Read to Cache 命令完成</li>
<li>发送 Read from Cache 命令，考虑到传输的方式不同，有以下几种：<ol>
<li>Read from Cache x1 IO(03H/0BH): Master 给出 1 字节命令，2 字节地址和 1 字节 dummy 数据，共 8(COMMAND)+16(ADDR)+8(DUMMY) 个周期，之后 Slave 从 MISO 给出数据</li>
<li>Read from Cache x2 IO(3BH): Slave 同时通过 MISO 和 MOSI 给出数据</li>
<li>Read from Cache x4 IO(6BH): Slave 同时通过 MISO、MOSI、WP# 和 HOLD# 给出数据</li>
<li>Read from Cache Dual IO(BBH): 在 3BH 的基础上，Master 也同时通过 MISO 和 MOSI 给出地址和 dummy 字节，所以 Master 只占用 8(COMMAND)+8(ADDR)+4(DUMMY) 个周期的时间发送</li>
<li>Read from Cache Quad IO(EBH): 在 6BH 的基础上，Master 也同时通过四个数据信号给出地址和 dummy 字节，所以 Master 只占用 8(COMMAND)+4(ADDR)+2(DUMMY) 个周期的时间发送</li>
</ol>
</li>
</ol>
<p>写入的时候，由于 NAND Flash 的特性，首先需要擦除，把一个 Block 的内容全部擦除，需要注意每个 Block 包括多个 Page，所以擦除的粒度是很粗的。擦除过的 Page 才可以进行写入，具体步骤是：</p>
<ol>
<li>发送 06H(Write Enable) 允许写入</li>
<li>发送 02H(Program Load) 或 32H(Program Load x4) 把要写入的数据传输给 NAND Flash 中的 Cache；02H 和 32H 的区别就是后者同时在四个信号线上传输数据</li>
<li>发送 10H(Program Execute) 进行实际的写入操作，从 Cache 到 Flash 存储</li>
<li>不断发送 0FH(Get Feature) 命令，直到 Program Execute 操作完成</li>
</ol>
<h4 id="spi-nor-flash"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-nor-flash">SPI NOR Flash</a></h4>
<p>NOR Flash 和 NAND Flash 的区别在于，NOR Flash 可以随机访问，可以提供 XIP 支持。下面以 <a href="https://www.micron.com/-/media/client/global/documents/products/data-sheet/nor-flash/serial-nor/n25q/n25q_128mb_3v_65nm.pdf">128Mb, 3V, Multiple I/O Serial Flash Memory</a> 为例子看看它是如何读写的。</p>
<p>SPI NOR Flash 读取的时候，只需要一条命令就可以了：READ/FAST READ。其中 READ 命令比较简单：发送 Command，发送地址，然后 Slave 紧接着就会发送数据；FAST READ 可以达到更高的频率，但是为了让 NOR Flash 有时间读取数据，在 Master 发送 Command 和地址后，还需要发送 Dummy cycles，然后 Slave 才会发送数据。和前面一样，FAST READ 也支持不同的 IO 类型，例如 Dual Output，Dual Input/Output，Quad Output，Quad Input/Output。一些比较高端的 SPI NOR Flash 还支持 DTR（Double Transfer Rate），实际上就是 DDR，在时钟上升沿和下降沿都采样数据。</p>
<p>写入的时候，和 NAND Flash 一样，也需要先擦除，再写入。SPI Flash 的存储层级是：</p>
<ol>
<li>Sector</li>
<li>Subsector</li>
<li>Page</li>
<li>Byte</li>
</ol>
<p>擦除的粒度是 Sector 或者 Subsector，写入的粒度是 Page。写入的时候，也需要首先发送 WRITE ENABLE 命令，再发送 PAGE PROGRAM 命令。NOR Flash 在 Program 上也比较简化，直接 Program 即可，不需要先写入到 Cache，再进行 Program。</p>
<p>NOR Flash 还提供了 XIP Mode 来加快随机访问：启用 XIP 模式后，给出一个地址，等待 Dummy cycles 后，就可以读出数据，不需要像前面那样发送 COMMAND，减少了延迟。当然了，即使不打开 NOR Flash 的 XIP Mode，也可以在 SPI 控制器里实现 XIP，只不过每次读取都要发一次 READ 命令。</p>
<h3 id="spi-eeprom"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-eeprom">SPI EEPROM</a></h3>
<p>SPI EEPROM 和 SPI NOR Flash 比较类似，但是 EEPROM 更小，也更加简单，例如写入的时候，不需要擦除。感兴趣的可以在 <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/22040c_cn.pdf">SPI 串行 EEPROM 系列数据手册</a> 中查看命令列表，这里就不赘述了。</p>
<h3 id="sd"><a class="toclink" href="../../hardware/2023/04/26/spi/#sd">SD 卡</a></h3>
<p>SD 卡除了 SD Bus 以外，还支持 SPI 模式（最新的 SDUC 不支持 SPI 模式），所以也可以用 SPI 来读写 SD 卡。</p>
<p>SD 卡比较特别的一点是，它需要比较复杂的初始化流程：</p>
<ol>
<li>首先要发送 CMD0 命令，同时 CS 拉低，使得 SD 卡进入 SPI 模式</li>
<li>对于 SDHC SD 卡，需要发送 CMD8 来协商工作电压范围</li>
<li>重复发送 ACMD41 命令（CMD55 + CMD41 = ACMD41）进行初始化，直到 SD 卡回复初始化完成</li>
<li>发送 CMD58 命令以读取 OCR 寄存器的值</li>
</ol>
<p>比较有意思的是命令的传输方式。每个命令有一个 6 位的命令编号，例如 CMD0 的编号就是 0，CMD55 的编号就是 55；还带有四字节的参数。每个命令会组装成一个 48 位的分组：</p>
<ol>
<li>bit[47]=0: Start Bit</li>
<li>bit[46]=1: Transmission Bit</li>
<li>bit[45:40]: Command Index</li>
<li>bit[39:8]: Argument</li>
<li>bit[7:1]: CRC7</li>
<li>bit[0]=1: End Bit</li>
</ol>
<p>可见额外多了一个 CRC7 的校验和。</p>
<p>SD 卡规定，SPI 模式下，所有的数据传输都是对齐到 8 位，也就是从 CS 拉低开始算，每 8 个时钟上升沿是一个字节，无论命令还是响应，都在 8 位的边界上传输。</p>
<p>想要读取数据的话，就要发送 READ_SINGLE_BLOCK 命令，参数就是要读取的 Block 地址。SD 卡回先回复一个字节的响应，然后开始发数据，数据从 Start Block Token 开始，然后是一个 Block 的数据（通常是 512 字节），最后再两个字节的 CRC16。</p>
<p>写数据则是发送 WRITE_BLOCK 命令，SD 卡回复一个字节的响应，然后控制器开始传输数据，数据从 Start Block Token 开始，接着是要写入的数据，最后是两个字节的 CRC16，然后 SD 卡回复一个字节的响应，标志着写入成功。</p>
<h3 id="spi_1"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi_1">SPI 以太网控制器</a></h3>
<p>有一些以太网产品提供了 SPI 接口，例如 <a href="https://ww1.microchip.com/downloads/aemDocuments/documents/UNG/ProductDocuments/DataSheets/KSZ8851SNL-Single-Port-Ethernet-Controller-with-SPI-DS00002381C.pdf">KSZ8851SNL/SNLI</a>，集成了 MAC 和 PHY，直接连接 MDI/MDI-X 接口，虽然最高只支持百兆网，但是接口上确实非常简单。</p>
<p>SPI 上发送的命令就两类：一类是读写寄存器，一类是读写 RX/TX FIFO。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2023/04/26/spi/#_4">键盘和触摸板</a></h3>
<p>一些型号的苹果电脑的键盘和触摸板是通过 SPI 接口访问的，在 Linux 中有相应的 applespi 驱动。</p>
<h3 id="spi-vs-i2c"><a class="toclink" href="../../hardware/2023/04/26/spi/#spi-vs-i2c">SPI vs I2C</a></h3>
<p>SPI 和 I2C 的区别在于，前者信号更多，全双工传输；后者信号更少，半双工传输。SPI 通过 CS 信号选择 Slave 芯片，I2C 通过地址进行区分。此外 I2C 还需要 Pull up resistor，这样如果没有设备响应，就会 NACK。</p>
<p>一些芯片提供了 SPI 或 I2C 的选项：共用两个信号，允许用户选择用 I2C 还是 SPI。例如 <a href="http://cdn.sparkfun.com/datasheets/Dev/Arduino/Shields/WolfsonWM8731.pdf">WM8731</a>，既支持 I2C（记为 2-wire mode），又支持 SPI（记为 3-wire mode）。一般这种时候，SPI 和 I2C 就是用来配置一些寄存器的，另外可能还有一些接口，例如 WM8731 负责声音数据传输的实际上是 I2S。</p>
<nav class="md-post__action">
<a href="../../hardware/2023/04/26/spi/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-24 00:00:00">2023年4月24日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="litex-uart-over-jtag"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/">在 LiteX 中使用 UART over JTAG</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#_1">背景</a></h3>
<p>在给 Alinx AX7021 适配 LiteX 的时候，遇到一个问题：PL 上没有连接串口，只有 PS 连接了串口，如果用 RISC-V 软核的话，就会面临无串口可用的情况，除非在扩展 IO 上自己定义一个串口。</p>
<p>因此研究了一下 LiteX 自带的 UART over JTAG 功能，在 Alinx AX7021 中调试出来了。</p>
<h3 id="litex"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#litex">LiteX 配置</a></h3>
<p>启用很简单，直接在命令里添加 <code>--uart-name jtag_uart</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>litex_boards.targets.alinx_ax7021<span class="w"> </span>--build<span class="w"> </span>--uart-name<span class="w"> </span>jtag_uart
</span></code></pre></div>
<p>如果要设置成默认的话，也可以在代码中添加：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"uart_name"</span><span class="p">,</span> <span class="s2">"serial"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"serial"</span><span class="p">:</span>
</span><span id="__span-1-2"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>            <span class="c1"># Defaults to JTAG-UART since UART is connected to PS instead of PL</span>
</span><span id="__span-1-3"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"uart_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"jtag_uart"</span>
</span></code></pre></div>
<p>那么 FPGA 部分的准备就完成了，把 bitstream 下载到 FPGA 即可进入下一步。</p>
<h3 id="openocd"><a class="toclink" href="../../hardware/2023/04/24/litex-uart-over-jtag/#openocd">OpenOCD 配置</a></h3>
<p>下一步是使用 litex_term 来连接 UART over JTAG。它的启动方式是：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>litex_term<span class="w"> </span>--jtag-config<span class="w"> </span>alinx_ax7021.cfg<span class="w"> </span>jtag
</span></code></pre></div>
<p>实现的原理是，litex_term 会启动一个 OpenOCD，让 OpenOCD 监听 20000 端口，然后虚拟串口的收发都会在 TCP 上进行。那么，首先第一步是要让 OpenOCD 找到 Zynq 中的 PL。首先可以找到 Zynq 的 OpenOCD 配置模板：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>ftdi<span class="o">/</span>digilent_jtag_smt2.cfg<span class="k">]</span>
</span><span id="__span-3-2"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nv">reset_config</span><span class="w"> </span>srst_only<span class="w"> </span>srst_push_pull
</span><span id="__span-3-4"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>target<span class="o">/</span>zynq_7000.cfg<span class="k">]</span>
</span></code></pre></div>
<p>这个模板可以找到 ARM 核和 FPGA PL 部分，但是因为名字和 litex_term 期望的不同，所以无法工作。去掉那些不需要的，只保留想要的 PL 部分的 JTAG 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>ftdi<span class="o">/</span>digilent_jtag_smt2.cfg<span class="k">]</span>
</span><span id="__span-4-2"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nv">reset_config</span><span class="w"> </span>srst_only<span class="w"> </span>srst_push_pull
</span><span id="__span-4-4"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">15000</span>
</span><span id="__span-4-6"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span>zynq_pl<span class="w"> </span>bs<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">-</span>ignore-version<span class="w"> </span><span class="o">-</span>ircapture<span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">-</span>irmask<span class="w"> </span><span class="mh">0x03</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-7"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03723093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-8"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03722093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-9"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0373c093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-10"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03728093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-11"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0373B093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-12"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03732093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-13"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03727093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-14"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x0372C093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-15"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03731093</span><span class="w"> </span><span class="err">\</span>
</span><span id="__span-4-16"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="nv">-expected-id</span><span class="w"> </span><span class="mh">0x03736093</span>
</span></code></pre></div>
<p>接下来，就可以启动 OpenOCD：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>openocd<span class="w"> </span>-f<span class="w"> </span>alinx_ax7021.cfg<span class="w"> </span>-f<span class="w"> </span>stream.cfg<span class="w"> </span>-c<span class="w"> </span><span class="s2">"init; irscan zynq_pl.bs 2; jtagstream_serve zynq_pl.bs 20000"</span>
</span></code></pre></div>
<p>这里的 stream.cfg 是 litex_term 生成的，没有用 litex_term 启动是因为它写死了 tap 的名字，需要适配，不如直接绕过它去启动 OpenOCD，然后用 nc 连接：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>nc<span class="w"> </span>localhost<span class="w"> </span><span class="m">20000</span>
</span><span id="__span-6-2"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>litex&gt;
</span></code></pre></div>
<p>就可以看到熟悉的串口了。但是跑命令的时候，经常出现重复字幕的输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>LiteX BIOS, available commands:
</span><span id="__span-7-2"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>
</span><span id="__span-7-3"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>flush_cpu_dcache         -FFlush CPU data cache
</span><span id="__span-7-4"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>crc                      - Compute CRC32 ff a part of the address space
</span><span id="__span-7-5"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>ident                    - Identffier of the system
</span><span id="__span-7-6"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>help                     - Print this help
</span><span id="__span-7-7"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>
</span><span id="__span-7-8"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>
</span><span id="__span-7-9"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>serialboot               - Boot from Serial (SFL)
</span><span id="__span-7-10"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>reboot                   - Reboot
</span><span id="__span-7-11"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>boot                     - Boot from Meoory
</span><span id="__span-7-12"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>mem_cmp                  - Compare memory content
</span><span id="__span-7-14"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>mem_seeed                - Test memory speed
</span><span id="__span-7-15"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>mem_test                 - Test memory access
</span><span id="__span-7-16"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>mem_copy                 - Copy address ppace
</span><span id="__span-7-17"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>mem_write                - Write address space
</span><span id="__span-7-18"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>mem_read                 - Read address space
</span><span id="__span-7-19"><a href="../../hardware/2023/04/24/litex-uart-over-jtag/#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>mem_list                 -LList available memory regions
</span></code></pre></div>
<p>怀疑是哪里速率不匹配，导致同一份数据被读出来两次。之后用一个更低的 CPU 主频再试一次。</p>
<nav class="md-post__action">
<a href="../../hardware/2023/04/24/litex-uart-over-jtag/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-20 00:00:00">2023年4月20日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 13 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="dram"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/">DRAM 的拓扑和训练</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/sdram.html">知识库</a>中。</p>
<h3 id="dram-training"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#dram-training">DRAM Training</a></h3>
<p>DRAM 一直有一个比较麻烦的初始化过程，就是 DRAM Training，其中很重要的一步就是计算出各个数据线相对于时钟的偏移（skew）。这个偏移是怎么来的呢？</p>
<p>我们知道，对于 SRAM，如果想要更多的位宽，只需要把地址线和控制信号连接到多个 SRAM 上，然后把 SRAM 的数据信号并行连接到 FPGA 上就可以了，但是前提是要尽量保证等长，否则一样有偏移的问题。DRAM 也是采用类似的方法进行扩展的，但是 DRAM 通常需要并行连接很多个芯片，例如 8 个 x8 的芯片的合并成一个 64 位的 DDR SDRAM。此时数据线依然是并行连接，但是地址线和控制信号就出现了走线困难：很难在那么小的空间里，等长地把地址和控制信号分布到各个芯片上，而且还有信号完整性的问题。</p>
<h3 id="fly-by-topology"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#fly-by-topology">Fly-by topology</a></h3>
<p>因此，实际上地址和控制信号是采用了串联的方式连接，也就是下图的右边的连接方式：</p>
<p><img alt="" src="/images/ddr_fly_by.png"/></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces">Versal ACAP PCB Design User Guide (UG863)</a>。</p>
<p>但是数据信号（DQ 和 DQS）依然是并行点对点连接到 DRAM 上的（上图左侧）。这就出现了问题：不同的 DRAM 芯片，数据和时钟的偏差不同，数据可能差不多时间到，但是时钟的延迟越来越大：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...."},
      { name: "data", wave: "01010"},
      { name: "clock_dram0", wave: "p....", phase: -0.1},
      { name: "clock_dram1", wave: "p....", phase: -0.2},
      { name: "clock_dram2", wave: "p....", phase: -0.3},
      { name: "clock_dram3", wave: "p....", phase: -0.4},
      { name: "clock_dram4", wave: "p....", phase: -0.5},
      { name: "clock_dram5", wave: "p....", phase: -0.6},
      { name: "clock_dram6", wave: "p....", phase: -0.7},
      { name: "clock_dram7", wave: "p....", phase: -0.8},
    ]
}</script>
<p>注：这里简化了，当成 SDR 来画。</p>
<p>不做任何处理的话，DRAM 采样得到的数据就不正确了。为了解决这个问题，就需要人为地在数据信号上也加上可变的延迟，保证时钟和数据同步，这样 DRAM 才可以实现正确的写入：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p.p.."},
      { name: "data", wave: "01010"},
      { name: "clock_dram0", wave: "p.p..", phase: -0.1},
      { name: "data_dram0", wave: "01010", phase: -0.1},
      { name: "clock_dram1", wave: "p.p..", phase: -0.2},
      { name: "data_dram1", wave: "01010", phase: -0.2},
      { name: "clock_dram2", wave: "p.p..", phase: -0.3},
      { name: "data_dram2", wave: "01010", phase: -0.3},
      { name: "clock_dram3", wave: "p.p..", phase: -0.4},
      { name: "data_dram3", wave: "01010", phase: -0.4},
    ]
}</script>
<h3 id="write-leveling"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#write-leveling">Write Leveling</a></h3>
<p>为了解决写入时，时钟和数据有偏移的问题，需要采用 Write Leveling 方法来解决。具体思路是这样的：如果 DRAM 以时钟信号去采样数据信号可以得到正确的结果，那反过来，如果认为数据信号是时钟信号，在数据信号的上升沿去采样时钟，应该也可以观测到稳定的结果。</p>
<p>所以 Write Leveling 的工作方式就是：</p>
<ol>
<li>设置 DRAM 进入 Write Leveling 模式，此时 DRAM 会使用 DQS 信号来采样 CK 信号，把结果输出到 DQ 上</li>
<li>DDR 控制器不断地修改 DQS 的输出延迟，然后统计 DQ 上的输出</li>
</ol>
<p>示意图如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "ck", wave: "p.p.."},
      { name: "dqs_0", wave: "010..", phase: -0.5},
      { name: "dq_0", wave: "0....", phase: -0.55},
      { name: "dqs_1", wave: "010..", phase: -0.7},
      { name: "dq_1", wave: "0....", phase: -0.75},
      { name: "dqs_2", wave: "010..", phase: -0.9},
      { name: "dq_2", wave: "01...", phase: -0.95},
      { name: "dqs_3", wave: "010..", phase: -1.1},
      { name: "dq_3", wave: "01...", phase: -1.15},
    ]
}</script>
<p>上图中，用不断增大的四种延迟的 <code>dqs</code> 对 <code>ck</code> 进行采样：用 <code>dqs_0</code> 和 <code>dqs_1</code> 采样得到了 0，用 <code>dqs_2</code> 和 <code>dqs_3</code> 采样得到了 1。把这些结果列出来，可能会得到类似下面的结果：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>001111111111111111110000
</span></code></pre></div>
<p>也就是说，随着延迟增大，采样的数据从 0 变成 1，再从 1 变成 0。我们的目标是，让 <code>dqs</code> 和 <code>ck</code> 同步。在上图中，<code>dqs_2</code> 的上升沿和 <code>ck</code> 上升沿是最接近的，而刚好 <code>dqs_2</code> 也正好出现在采样 0 变成采样 1 的位置。这意味着，只要找到采样数据从 0 变成 1 的位置，就知道如何让 DQS 与 CK 同步了。</p>
<p>这样就完成了 Write Leveling 的步骤，实现了 DQS 与 CK 同步的目标，那么在写入数据的时候，DRAM 就可以得到正确的 DQS 信号了。</p>
<h3 id="read-leveling"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#read-leveling">Read Leveling</a></h3>
<p>在上一步的 Write Leveling 当中，通过修改内存控制器的输出延迟，保证了 DRAM 可以得到同步的 DQS 和 CK 信号，解决了 Fly by topology 引入的延迟不一致的问题。但是，对于读操作，数据从 DRAM 输出，输入到内存控制器，又会引入一定的延迟。所以对读操作，也需要进行校准。</p>
<p>回顾 SRAM，当想要测试读取功能的时候，会首先写入一些数据，再读出来，判断读取的数据和之前写入的数据是否一致。DRAM 也是类似的：先向 MPR 写入一些伪随机数据，然后要求 DRAM 从 MPR 中读取数据，而不是从 memory cell 中读取数据；然后内存控制器一侧不断进行读取操作，在不同的延迟下，比较读取的数据与预期的随机数据是否一致。最后也会得到一个延迟的区间，在这个区间内可以读取出正确的结果。最后，把延迟设定在区间的中央位置。</p>
<h3 id="clam-shell-topology"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#clam-shell-topology">Clam Shell Topology</a></h3>
<p>再回到拓扑的问题上来，实际上除了 Fly by topology，还有一种拓扑是 Clam shell topology：把 DRAM 分布在 PCB 的上面和下面，这样可以节省 PCB 的面积，但是走线就会比较困难：</p>
<p><img alt="" src="/images/ddr_clam_shell.png"/></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology">Versal ACAP Programmable Network on Chip and Integrated Memory Controller LogiCORE IP Product Guide (PG313) </a>.</p>
<p>直观地讲，两个芯片都放在 PCB 的正面，如果要连线的话，如果保证引脚顺序接近一致，就可以比较容易地连接，不会有很多交叉的地方。但如果一个在正面，另一个在背面，引脚的顺序就倒转过来了，连线的时候就比较困难。解决的办法是，修改引脚的顺序，把一些引脚的功能进行对调，使得走线更加简单：</p>
<p><img alt="" src="/images/ddr_mirror.png"/></p>
<p>图源 <a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing">Versal ACAP PCB Design User Guide (UG863)</a></p>
<p>这里特意挑选了一些不影响特殊功能的引脚来交换，使得大部分功能，即使交换了引脚，也可以正常工作。但是，对于 Mode Register Set 操作，必须要内存控制器自己先内部交换位的顺序，才能保证在 DRAM 一侧得到正确的结果。</p>
<p>此外，Clam Shell Topology 的正面和背面各有一个 cs_n 片选信号，但是这和 Dual Rank 不同：Dual Rank 是正面和背面都有同样数量的 DRAM 芯片，共享地址信号、数据信号和控制信号，总线上同一时间只有一侧的 DRAM 芯片在使用，好处是内存容量翻倍，并且两个 rank 可以互相掩盖延迟；而 Clam Shell Topology 的两个 cs_n 是为了给 Mode Register Set 操作指定正面或背面，而其余的大部分操作，可以正面和背面同时使用，因为它们的数据信号并没有共享。</p>
<p><img alt="" src="/images/ddr_rank.png"/></p>
<p>图源 <a href="https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/">DIFFERENCE BETWEEN DUAL RANK AND SINGLE RANK RAM</a></p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_1">背景</a></h3>
<p>实际上，前面的整个研究过程，来自于我对 VCU128 LiteX 移植的观察：<a href="https://github.com/litex-hub/litex-boards/issues/496">VCU128 DDR4 memory calibration failure</a>。我在配置 litedram 的时候，发现总是有一半的 DRAM 芯片无法使用，和 Datasheet 对照了以后，发现正好是 PCB 背面的那一半。接着，发现它是 Clam Shell Topology 方式来分布的，然后 Top 和 Bottom 各有一个 cs_n 信号，这一点在 UG1302 里是没有写的，在 xdc 里才可以找到：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nv">set_property</span><span class="w"> </span>PACKAGE_PIN<span class="w"> </span>BK48<span class="w">       </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">"PL_DDR4_BOT_CS_B"</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L7P_T1L_N0_QBC_AD13P_66</span>
</span><span id="__span-1-2"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nv">set_property</span><span class="w"> </span>IOSTANDARD<span class="w">  </span>SSTL12_DCI<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">"PL_DDR4_BOT_CS_B"</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L7P_T1L_N0_QBC_AD13P_66</span>
</span><span id="__span-1-3"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nv">set_property</span><span class="w"> </span>PACKAGE_PIN<span class="w"> </span>BP49<span class="w">     </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">"PL_DDR4_CS_B"</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L1N_T0L_N1_DBC_66</span>
</span><span id="__span-1-4"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nv">set_property</span><span class="w"> </span>IOSTANDARD<span class="w">  </span>SSTL12<span class="w">   </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span><span class="s2">"PL_DDR4_CS_B"</span><span class="k">]</span><span class="w"> </span><span class="k">;</span><span class="c"># Bank  66 VCCO - DDR4_VDDQ_1V2 - IO_L1N_T0L_N1_DBC_66</span>
</span></code></pre></div>
<p>所以 Xilinx 文档也是可能出错的，需要结合多个信息源来判断。这里有 xdc 和 schematic 可以参考，都可以发现这个结论。</p>
<p>沿着这个思路，我给 litedram 添加了 clam shell topology 的支持：<a href="https://github.com/enjoy-digital/litedram/pull/332">https://github.com/enjoy-digital/litedram/pull/332</a> 和 <a href="https://github.com/enjoy-digital/litex/pull/1673">https://github.com/enjoy-digital/litex/pull/1673</a>，实现方法：</p>
<ol>
<li>在校准阶段，把 Top 和 Bottom 两个 cs_n 暴露给软件，软件在 MRS 的时候，分两次写入，第一次原样写到 Top，第二次交换地址顺序，再写入 Bottom。</li>
<li>正常工作阶段，把 Top 和 Bottom 的两个 cs_n 当成一个用，也就是当成 single rank dram。</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_2">训练代码</a></h3>
<p>下面结合 litex 和 litedram 的代码，以及 DDR4 标准，来验证上面的观察。</p>
<h4 id="write-leveling_1"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#write-leveling_1">Write Leveling</a></h4>
<p>Write Leveling 的核心函数是 <code>sdram_write_leveling_scan</code>，它的核心思路是：</p>
<p>第一步调用 <code>sdram_write_leveling_on</code> 打开 DRAM 的 Write Leveling 模式：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="w">  </span><span class="n">sdram_write_leveling_on</span><span class="p">();</span>
</span></code></pre></div>
<p>循环每个 DRAM 芯片的每个 DQS 信号：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SDRAM_PHY_MODULES</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">dq_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">dq_line</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DQ_COUNT</span><span class="p">;</span><span class="w"> </span><span class="n">dq_line</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="cm">/* 设置 DQS 初始延迟为 0 */</span>
</span><span id="__span-3-4"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">sdram_leveling_action</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dq_line</span><span class="p">,</span><span class="w"> </span><span class="n">write_rst_delay</span><span class="p">);</span>
</span><span id="__span-3-5"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
</span><span id="__span-3-6"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="cm">/* 循环 DQS 延迟 */</span>
</span><span id="__span-3-7"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">err_ddrphy_wdly</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-8"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">zero_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-9"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">one_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-10"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="n">loops</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-12"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">        </span><span class="cm">/* 发送 DQS 序列：00000001 */</span>
</span><span id="__span-3-13"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="n">ddrphy_wlevel_strobe_write</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-3-14"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>
</span><span id="__span-3-15"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="cm">/* 统计 1 和 0 的个数 */</span>
</span><span id="__span-3-16"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">SDRAM_PHY_MODULES</span><span class="mi">-1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-17"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">          </span><span class="n">one_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-3-18"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">        </span><span class="k">else</span>
</span><span id="__span-3-19"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">          </span><span class="n">zero_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-3-20"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-3-21"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">zero_count</span><span class="p">)</span>
</span><span id="__span-3-22"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">        </span><span class="cm">/* DQS 采样到了 CK 的正半周期 */</span>
</span><span id="__span-3-23"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">        </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-24"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">      </span><span class="k">else</span>
</span><span id="__span-3-25"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">        </span><span class="cm">/* DQS 采样到了 CK 的负半周期 */</span>
</span><span id="__span-3-26"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-27"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>
</span><span id="__span-3-28"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">      </span><span class="cm">/* 每次循环增加一次 DQS 延迟 */</span>
</span><span id="__span-3-29"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">      </span><span class="n">sdram_leveling_action</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">dq_line</span><span class="p">,</span><span class="w"> </span><span class="n">write_inc_delay</span><span class="p">);</span>
</span><span id="__span-3-30"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-31"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>
</span><span id="__span-3-32"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">    </span><span class="cm">/* 找到一个最长的连续 1 的序列 */</span>
</span><span id="__span-3-33"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">    </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-34"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">    </span><span class="n">one_window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-35"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">    </span><span class="n">one_window_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-36"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">    </span><span class="n">one_window_best_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-37"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">    </span><span class="n">one_window_best_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-3-38"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">err_ddrphy_wdly</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-39"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_window_active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-40"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">err_ddrphy_wdly</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-41"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">          </span><span class="cm">/* 结束了一段连续的 1 */</span>
</span><span id="__span-3-42"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">          </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-43"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="w">          </span><span class="n">one_window_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">one_window_start</span><span class="p">;</span>
</span><span id="__span-3-44"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">          </span><span class="cm">/* 记录最长的连续 1 的长度和位置 */</span>
</span><span id="__span-3-45"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">one_window_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">one_window_best_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-46"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">            </span><span class="n">one_window_best_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_start</span><span class="p">;</span>
</span><span id="__span-3-47"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">            </span><span class="n">one_window_best_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_count</span><span class="p">;</span>
</span><span id="__span-3-48"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">          </span><span class="p">}</span>
</span><span id="__span-3-49"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-50"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-51"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">        </span><span class="cm">/* 找到连续的 1 的开头 */</span>
</span><span id="__span-3-52"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">err_ddrphy_wdly</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">taps_scan</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-53"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">          </span><span class="n">one_window_active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-3-54"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">          </span><span class="n">one_window_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-3-55"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-56"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-3-57"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-58"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>
</span><span id="__span-3-59"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="w">    </span><span class="cm">/* 要找的延迟就是连续的 1 序列的开始位置 */</span>
</span><span id="__span-3-60"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="w">    </span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one_window_best_start</span><span class="p">;</span>
</span><span id="__span-3-61"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-62"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="p">}</span>
</span><span id="__span-3-63"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a>
</span><span id="__span-3-64"><a href="../../hardware/2023/04/20/dram-topology-training/#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a><span class="n">sdram_write_leveling_off</span><span class="p">();</span>
</span></code></pre></div>
<p>这样就实现了 Write Leveling 的全流程：</p>
<ol>
<li>设置 DRAM 进入 Write Leveling 模式，DRAM 用 DQS 对 CK 采样，结果输出到 DQ</li>
<li>在不同的 DQS 延迟下，发送同样的 00000001 DQS 模式，观察 DQ 上的数据</li>
<li>统计 DQ 上的 1 和 0 的个数，如果 1 更多，就认为当前 DQS 延迟下，DQS 采样到了 CK 的正半周期；反之如果 0 更多，就认为当前 DQS 延迟下，DQS 采样到了 CK 的负半周期</li>
<li>在第三步的结果中，找到最长的连续的 1 序列，那么这个序列的开始，就对应了采样值从 0 到 1 的变化，此时 DQS 与 CK 基本同步</li>
<li>最后设置 DRAM 退出 Write Leveling 模式</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/04/20/dram-topology-training/#_3">参考文档</a></h3>
<ul>
<li><a href="https://www.systemverilog.io/design/ddr4-initialization-and-calibration/">https://www.systemverilog.io/design/ddr4-initialization-and-calibration/</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces">https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Signals-and-Connections-for-DDR4-Interfaces</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/pg353-versal-acap-soft-ddr4-mem-ip/Calibration-Overview">https://docs.xilinx.com/r/en-US/pg353-versal-acap-soft-ddr4-mem-ip/Calibration-Overview</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology">https://docs.xilinx.com/r/en-US/pg313-network-on-chip/Clamshell-Topology</a></li>
<li><a href="https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing">https://docs.xilinx.com/r/en-US/ug863-versal-pcb-design/Utilizing-Address-Mirroring-to-Ease-Clamshell-Routing</a></li>
<li><a href="https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/">https://blog.memory4less.com/2022/09/16/difference-between-dual-rank-and-single-rank-ram/</a></li>
<li><a href="https://daffy1108.wordpress.com/2010/09/02/understanding-ddr3-write-leveling-and-read-leveling/">https://daffy1108.wordpress.com/2010/09/02/understanding-ddr3-write-leveling-and-read-leveling/</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2023/04/20/dram-topology-training/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-19 00:00:00">2023年4月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="arty-a7-litex-vexriscv-linux"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/">在 Arty A7 上用 LiteX 和 VexRiscv 跑 Linux</a></h2>
<h3 id="litex"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#litex">litex 安装</a></h3>
<p>litex 安装过程按照 <a href="https://github.com/enjoy-digital/litex/wiki/Installation">https://github.com/enjoy-digital/litex/wiki/Installation</a> 进行，由于需要 pip install，建议用 venv 来开一个干净的环境：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
</span><span id="__span-0-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nb">source</span><span class="w"> </span>venv/bin/activate
</span><span id="__span-0-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">cd</span><span class="w"> </span>litex
</span><span id="__span-0-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>./litex_setup.py<span class="w"> </span>--init<span class="w"> </span>--install
</span></code></pre></div>
<h3 id="bitstream"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#bitstream">构建 bitstream</a></h3>
<p>litex-boards 已经内建了 Arty A7 的支持，直接运行下列命令，就可以得到 bitstream：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>python3<span class="w"> </span>-m<span class="w"> </span>litex_boards.targets.digilent_arty<span class="w"> </span>--build<span class="w"> </span>--with-ethernet
</span></code></pre></div>
<p>这样就可以在 build/digilent_arty/gateware 目录下找到 bitstream。可以通过命令行参数来自定义需要的功能，详见 <a href="https://github.com/litex-hub/litex-boards/blob/f5e51d72bca6ed0325c1213791a78362326002f8/litex_boards/targets/digilent_arty.py#L162-L180">https://github.com/litex-hub/litex-boards/blob/f5e51d72bca6ed0325c1213791a78362326002f8/litex_boards/targets/digilent_arty.py#L162-L180</a>。</p>
<p>如果想切换 CPU 为 Rocket Chip 的话，克隆并安装 <a href="https://github.com/litex-hub/pythondata-cpu-rocket">https://github.com/litex-hub/pythondata-cpu-rocket</a>，添加 <code>--cpu-type rocket --cpu-variant small</code> 参数即可。</p>
<h3 id="bitstream_1"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#bitstream_1">下载 bitstream</a></h3>
<p>最后，连接 microUSB 和网线到电脑，然后下载 bitstream：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>openFPGALoader<span class="w"> </span>-b<span class="w"> </span>arty<span class="w"> </span>digilent_arty.bit
</span><span id="__span-2-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>screen<span class="w"> </span>/dev/tty.usbserial-XXXXXXXXXXXXX<span class="w"> </span><span class="m">115200</span>
</span></code></pre></div>
<p>就可以看到 litex 的输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>--<span class="o">===============</span><span class="w"> </span><span class="nv">SoC</span><span class="w"> </span><span class="o">==================</span>--
</span><span id="__span-3-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>CPU:<span class="w">            </span>VexRiscv<span class="w"> </span>@<span class="w"> </span>100MHz
</span><span id="__span-3-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>BUS:<span class="w">            </span>WISHBONE<span class="w"> </span><span class="m">32</span>-bit<span class="w"> </span>@<span class="w"> </span>4GiB
</span><span id="__span-3-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>CSR:<span class="w">            </span><span class="m">32</span>-bit<span class="w"> </span>data
</span><span id="__span-3-5"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>ROM:<span class="w">            </span><span class="m">128</span>.0KiB
</span><span id="__span-3-6"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>SRAM:<span class="w">           </span><span class="m">8</span>.0KiB
</span><span id="__span-3-7"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>L2:<span class="w">             </span><span class="m">8</span>.0KiB
</span><span id="__span-3-8"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>SDRAM:<span class="w">          </span><span class="m">256</span>.0MiB<span class="w"> </span><span class="m">16</span>-bit<span class="w"> </span>@<span class="w"> </span>800MT/s<span class="w"> </span><span class="o">(</span>CL-7<span class="w"> </span>CWL-5<span class="o">)</span>
</span><span id="__span-3-9"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>MAIN-RAM:<span class="w">       </span><span class="m">256</span>.0MiB
</span><span id="__span-3-10"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>--<span class="o">==========</span><span class="w"> </span><span class="nv">Initialization</span><span class="w"> </span><span class="o">============</span>--
</span><span id="__span-3-12"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>Ethernet<span class="w"> </span>init...
</span><span id="__span-3-13"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>Initializing<span class="w"> </span>SDRAM<span class="w"> </span>@0x40000000...
</span><span id="__span-3-14"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>Switching<span class="w"> </span>SDRAM<span class="w"> </span>to<span class="w"> </span>software<span class="w"> </span>control.
</span><span id="__span-3-15"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>Read<span class="w"> </span>leveling:
</span><span id="__span-3-16"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">  </span>m0,<span class="w"> </span>b00:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-17"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">  </span>m0,<span class="w"> </span>b01:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-18"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">  </span>m0,<span class="w"> </span>b02:<span class="w"> </span><span class="p">|</span><span class="m">11111111110000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">04</span>+-04
</span><span id="__span-3-19"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">  </span>m0,<span class="w"> </span>b03:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000111111111111000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-20"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">  </span>m0,<span class="w"> </span>b04:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000011</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">30</span>+-00
</span><span id="__span-3-21"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">  </span>m0,<span class="w"> </span>b05:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-22"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">  </span>m0,<span class="w"> </span>b06:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-23"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">  </span>m0,<span class="w"> </span>b07:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-24"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">  </span>best:<span class="w"> </span>m0,<span class="w"> </span>b03<span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-25"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">  </span>m1,<span class="w"> </span>b00:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-26"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">  </span>m1,<span class="w"> </span>b01:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-27"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">  </span>m1,<span class="w"> </span>b02:<span class="w"> </span><span class="p">|</span><span class="m">11111111110000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">04</span>+-04
</span><span id="__span-3-28"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">  </span>m1,<span class="w"> </span>b03:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000111111111111000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-29"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">  </span>m1,<span class="w"> </span>b04:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000011</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span><span class="m">30</span>+-00
</span><span id="__span-3-30"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">  </span>m1,<span class="w"> </span>b05:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-31"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">  </span>m1,<span class="w"> </span>b06:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-32"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">  </span>m1,<span class="w"> </span>b07:<span class="w"> </span><span class="p">|</span><span class="m">00000000000000000000000000000000</span><span class="p">|</span><span class="w"> </span>delays:<span class="w"> </span>-
</span><span id="__span-3-33"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">  </span>best:<span class="w"> </span>m1,<span class="w"> </span>b03<span class="w"> </span>delays:<span class="w"> </span><span class="m">19</span>+-05
</span><span id="__span-3-34"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>Switching<span class="w"> </span>SDRAM<span class="w"> </span>to<span class="w"> </span>hardware<span class="w"> </span>control.
</span><span id="__span-3-35"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>Memtest<span class="w"> </span>at<span class="w"> </span>0x40000000<span class="w"> </span><span class="o">(</span><span class="m">2</span>.0MiB<span class="o">)</span>...
</span><span id="__span-3-36"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">  </span>Write:<span class="w"> </span>0x40000000-0x40200000<span class="w"> </span><span class="m">2</span>.0MiB
</span><span id="__span-3-37"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">   </span>Read:<span class="w"> </span>0x40000000-0x40200000<span class="w"> </span><span class="m">2</span>.0MiB
</span><span id="__span-3-38"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>Memtest<span class="w"> </span>OK
</span><span id="__span-3-39"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>Memspeed<span class="w"> </span>at<span class="w"> </span>0x40000000<span class="w"> </span><span class="o">(</span>Sequential,<span class="w"> </span><span class="m">2</span>.0MiB<span class="o">)</span>...
</span><span id="__span-3-40"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">  </span>Write<span class="w"> </span>speed:<span class="w"> </span><span class="m">37</span>.0MiB/s
</span><span id="__span-3-41"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">   </span>Read<span class="w"> </span>speed:<span class="w"> </span><span class="m">48</span>.7MiB/s
</span><span id="__span-3-42"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>
</span><span id="__span-3-43"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>--<span class="o">==============</span><span class="w"> </span><span class="nv">Boot</span><span class="w"> </span><span class="o">==================</span>--
</span><span id="__span-3-44"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>Booting<span class="w"> </span>from<span class="w"> </span>serial...
</span><span id="__span-3-45"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>Press<span class="w"> </span>Q<span class="w"> </span>or<span class="w"> </span>ESC<span class="w"> </span>to<span class="w"> </span>abort<span class="w"> </span>boot<span class="w"> </span>completely.
</span><span id="__span-3-46"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>sL5DdSMmkekro
</span><span id="__span-3-47"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>Timeout
</span><span id="__span-3-48"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>Booting<span class="w"> </span>from<span class="w"> </span>network...
</span><span id="__span-3-49"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>Local<span class="w"> </span>IP:<span class="w"> </span><span class="m">192</span>.168.1.50
</span><span id="__span-3-50"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>Remote<span class="w"> </span>IP:<span class="w"> </span><span class="m">192</span>.168.1.100
</span><span id="__span-3-51"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>Booting<span class="w"> </span>from<span class="w"> </span>boot.json...
</span><span id="__span-3-52"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>Booting<span class="w"> </span>from<span class="w"> </span>boot.bin...
</span><span id="__span-3-53"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>Copying<span class="w"> </span>boot.bin<span class="w"> </span>to<span class="w"> </span>0x40000000...
</span><span id="__span-3-54"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a>Network<span class="w"> </span>boot<span class="w"> </span>failed.
</span><span id="__span-3-55"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>No<span class="w"> </span>boot<span class="w"> </span>medium<span class="w"> </span>found
</span><span id="__span-3-56"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a>
</span><span id="__span-3-57"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a>--<span class="o">=============</span><span class="w"> </span><span class="nv">Console</span><span class="w"> </span><span class="o">================</span>--
</span><span id="__span-3-58"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>
</span><span id="__span-3-59"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a>litex&gt;<span class="w"> </span>
</span></code></pre></div>
<p>可见是非常方便的。之后可以用 litex_term 来往里面传程序，也可以直接通过 TFTP 来传。</p>
<h3 id="linux"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#linux">启动 Linux</a></h3>
<p>接下来，可以使用项目 <a href="https://github.com/litex-hub/linux-on-litex-vexriscv">https://github.com/litex-hub/linux-on-litex-vexriscv</a> 来启动 Linux。参考项目 README，编译 Linux 并启动。不想折腾的话，可以从 <a href="https://github.com/litex-hub/linux-on-litex-vexriscv/issues/164">https://github.com/litex-hub/linux-on-litex-vexriscv/issues/164</a> 下载编译好的结果。</p>
<p>首先克隆项目到本地，然后运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/litex-hub/linux-on-litex-vexriscv.git
</span><span id="__span-4-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nb">cd</span><span class="w"> </span>linux-on-litex-vexriscv
</span><span id="__span-4-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>./make.py<span class="w"> </span>--board<span class="o">=</span>arty
</span></code></pre></div>
<p>这样就生成了 bitstream，接下来构建 Linux 和 rootfs：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>git<span class="w"> </span>clone<span class="w"> </span>http://github.com/buildroot/buildroot
</span><span id="__span-5-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nb">cd</span><span class="w"> </span>buildroot
</span><span id="__span-5-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>make<span class="w"> </span><span class="nv">BR2_EXTERNAL</span><span class="o">=</span>../linux-on-litex-vexriscv/buildroot/<span class="w"> </span>litex_vexriscv_defconfig
</span><span id="__span-5-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>make
</span></code></pre></div>
<p>再构建 OpenSBI：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/litex-hub/opensbi<span class="w"> </span>--branch<span class="w"> </span><span class="m">0</span>.8-linux-on-litex-vexriscv
</span><span id="__span-6-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nb">cd</span><span class="w"> </span>opensbi
</span><span id="__span-6-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">## riscv32-unknown-elf toolchain is built by ct-ng</span>
</span><span id="__span-6-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>make<span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>riscv32-unknown-elf-<span class="w"> </span><span class="nv">PLATFORM</span><span class="o">=</span>litex/vexriscv
</span></code></pre></div>
<p>但是实践过程中发现 ct-ng 编译的是 hardfloat 工具链，而默认配置下 vexriscv 不带 FPU，所以编译时用的是 rv32ima 作为 target，链接的时候报错，最后就直接用编译好的版本。</p>
<p>最后得到如下的几个文件：</p>
<ul>
<li>boot.json: linux-on-litex-vexriscv/images/boot.json</li>
<li>rv32.dtb: linux-on-litex-vexriscv/images/rv32.dtb</li>
<li>Image: buildroot/output/images/Image</li>
<li>rootfs.cpio: buildroot/output/images/rootfs.cpio</li>
<li>opensbi.bin</li>
</ul>
<p>把这些文件复制到 TFTP 服务的目录下，重新 Program linux-on-litex-vexriscv/build/arty/gateware/arty.bit，即可启动 Linux：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>--============== Boot ==================--
</span><span id="__span-7-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>Booting from serial...
</span><span id="__span-7-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>Press Q or ESC to abort boot completely.
</span><span id="__span-7-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>sL5DdSMmkekro
</span><span id="__span-7-5"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>Timeout
</span><span id="__span-7-6"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>Booting from SDCard in SD-Mode...
</span><span id="__span-7-7"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>Booting from boot.json...
</span><span id="__span-7-8"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>Booting from boot.bin...
</span><span id="__span-7-9"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>SDCard boot failed.
</span><span id="__span-7-10"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>Booting from network...
</span><span id="__span-7-11"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>Local IP: 192.168.1.50
</span><span id="__span-7-12"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>Remote IP: 192.168.1.100
</span><span id="__span-7-13"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>Booting from boot.json...
</span><span id="__span-7-14"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>Copying Image to 0x40000000... (7726264 bytes)
</span><span id="__span-7-15"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>Copying rv32.dtb to 0x40ef0000... (5294 bytes)
</span><span id="__span-7-16"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>Copying rootfs.cpio to 0x41000000... (3566592 bytes)
</span><span id="__span-7-17"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>Copying opensbi.bin to 0x40f00000... (53640 bytes)
</span><span id="__span-7-18"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>Executing booted program at 0x40f00000
</span><span id="__span-7-19"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>
</span><span id="__span-7-20"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>--============= Liftoff! ===============--
</span><span id="__span-7-21"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>
</span><span id="__span-7-22"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>OpenSBI v0.8-1-gecf7701
</span><span id="__span-7-23"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>   ____                    _____ ____ _____
</span><span id="__span-7-24"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a>  / __ \                  / ____|  _ \_   _|
</span><span id="__span-7-25"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a> | |  | |_ __   ___ _ __ | (___ | |_) || |
</span><span id="__span-7-26"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a> | |  | | '_ \ / _ \ '_ \ \___ \|  _ &lt; | |
</span><span id="__span-7-27"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a> | |__| | |_) |  __/ | | |____) | |_) || |_
</span><span id="__span-7-28"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a>  \____/| .__/ \___|_| |_|_____/|____/_____|
</span><span id="__span-7-29"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>        | |
</span><span id="__span-7-30"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a>        |_|
</span><span id="__span-7-31"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>
</span><span id="__span-7-32"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>Platform Name       : LiteX / VexRiscv-SMP
</span><span id="__span-7-33"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>Platform Features   : timer,mfdeleg
</span><span id="__span-7-34"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a>Platform HART Count : 8
</span><span id="__span-7-35"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a>Boot HART ID        : 0
</span><span id="__span-7-36"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a>Boot HART ISA       : rv32imas
</span><span id="__span-7-37"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a>BOOT HART Features  : time
</span><span id="__span-7-38"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a>BOOT HART PMP Count : 0
</span><span id="__span-7-39"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a>Firmware Base       : 0x40f00000
</span><span id="__span-7-40"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a>Firmware Size       : 124 KB
</span><span id="__span-7-41"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a>Runtime SBI Version : 0.2
</span><span id="__span-7-42"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a>
</span><span id="__span-7-43"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a>MIDELEG : 0x00000222
</span><span id="__span-7-44"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a>MEDELEG : 0x0000b101
</span><span id="__span-7-45"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a>[    0.000000] Linux version 6.1.0-rc2 (jiegec@linux) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2023.02-270-gb100440bff) 11.3.0, GNU ld (GNU Binutils) 2.38) #1 SMP Wed Apr 19 16:21:39 CST 2023
</span><span id="__span-7-46"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a>[    0.000000] earlycon: liteuart0 at I/O port 0x0 (options '')
</span><span id="__span-7-47"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a>[    0.000000] Malformed early option 'console'
</span><span id="__span-7-48"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a>[    0.000000] earlycon: liteuart0 at MMIO 0xf0001000 (options '')
</span><span id="__span-7-49"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a>[    0.000000] printk: bootconsole [liteuart0] enabled
</span><span id="__span-7-50"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a>[    0.000000] Zone ranges:
</span><span id="__span-7-51"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a>[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-52"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a>[    0.000000] Movable zone start for each node
</span><span id="__span-7-53"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-53" id="__codelineno-7-53" name="__codelineno-7-53"></a>[    0.000000] Early memory node ranges
</span><span id="__span-7-54"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-54" id="__codelineno-7-54" name="__codelineno-7-54"></a>[    0.000000]   node   0: [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-55"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-55" id="__codelineno-7-55" name="__codelineno-7-55"></a>[    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x000000004fffffff]
</span><span id="__span-7-56"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-56" id="__codelineno-7-56" name="__codelineno-7-56"></a>[    0.000000] SBI specification v0.2 detected
</span><span id="__span-7-57"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-57" id="__codelineno-7-57" name="__codelineno-7-57"></a>[    0.000000] SBI implementation ID=0x1 Version=0x8
</span><span id="__span-7-58"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-58" id="__codelineno-7-58" name="__codelineno-7-58"></a>[    0.000000] SBI TIME extension detected
</span><span id="__span-7-59"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-59" id="__codelineno-7-59" name="__codelineno-7-59"></a>[    0.000000] SBI IPI extension detected
</span><span id="__span-7-60"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-60" id="__codelineno-7-60" name="__codelineno-7-60"></a>[    0.000000] SBI RFENCE extension detected
</span><span id="__span-7-61"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-61" id="__codelineno-7-61" name="__codelineno-7-61"></a>[    0.000000] SBI HSM extension detected
</span><span id="__span-7-62"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-62" id="__codelineno-7-62" name="__codelineno-7-62"></a>[    0.000000] riscv: base ISA extensions aim
</span><span id="__span-7-63"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-63" id="__codelineno-7-63" name="__codelineno-7-63"></a>[    0.000000] riscv: ELF capabilities aim
</span><span id="__span-7-64"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-64" id="__codelineno-7-64" name="__codelineno-7-64"></a>[    0.000000] percpu: Embedded 8 pages/cpu s11732 r0 d21036 u32768
</span><span id="__span-7-65"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-65" id="__codelineno-7-65" name="__codelineno-7-65"></a>[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 65024
</span><span id="__span-7-66"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-66" id="__codelineno-7-66" name="__codelineno-7-66"></a>[    0.000000] Kernel command line: console=liteuart earlycon=liteuart,0xf0001000 rootwait root=/dev/ram0
</span><span id="__span-7-67"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-67" id="__codelineno-7-67" name="__codelineno-7-67"></a>[    0.000000] Dentry cache hash table entries: 32768 (order: 5, 131072 bytes, linear)
</span><span id="__span-7-68"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-68" id="__codelineno-7-68" name="__codelineno-7-68"></a>[    0.000000] Inode-cache hash table entries: 16384 (order: 4, 65536 bytes, linear)
</span><span id="__span-7-69"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-69" id="__codelineno-7-69" name="__codelineno-7-69"></a>[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off
</span><span id="__span-7-70"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-70" id="__codelineno-7-70" name="__codelineno-7-70"></a>[    0.000000] Memory: 243336K/262144K available (5848K kernel code, 571K rwdata, 906K rodata, 215K init, 254K bss, 18808K reserved, 0K cma-reserved)
</span><span id="__span-7-71"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-71" id="__codelineno-7-71" name="__codelineno-7-71"></a>[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1
</span><span id="__span-7-72"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-72" id="__codelineno-7-72" name="__codelineno-7-72"></a>[    0.000000] rcu: Hierarchical RCU implementation.
</span><span id="__span-7-73"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-73" id="__codelineno-7-73" name="__codelineno-7-73"></a>[    0.000000] rcu:     RCU restricting CPUs from NR_CPUS=32 to nr_cpu_ids=1.
</span><span id="__span-7-74"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-74" id="__codelineno-7-74" name="__codelineno-7-74"></a>[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.
</span><span id="__span-7-75"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-75" id="__codelineno-7-75" name="__codelineno-7-75"></a>[    0.000000] rcu: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=1
</span><span id="__span-7-76"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-76" id="__codelineno-7-76" name="__codelineno-7-76"></a>[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0
</span><span id="__span-7-77"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-77" id="__codelineno-7-77" name="__codelineno-7-77"></a>[    0.000000] riscv-intc: 32 local interrupts mapped
</span><span id="__span-7-78"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-78" id="__codelineno-7-78" name="__codelineno-7-78"></a>[    0.000000] plic: interrupt-controller@f0c00000: mapped 32 interrupts with 1 handlers for 2 contexts.
</span><span id="__span-7-79"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-79" id="__codelineno-7-79" name="__codelineno-7-79"></a>[    0.000000] rcu: srcu_init: Setting srcu_struct sizes based on contention.
</span><span id="__span-7-80"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-80" id="__codelineno-7-80" name="__codelineno-7-80"></a>[    0.000000] riscv-timer: riscv_timer_init_dt: Registering clocksource cpuid [0] hartid [0]
</span><span id="__span-7-81"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-81" id="__codelineno-7-81" name="__codelineno-7-81"></a>[    0.000000] clocksource: riscv_clocksource: mask: 0xffffffffffffffff max_cycles: 0x171024e7e0, max_idle_ns: 440795205315 ns
</span><span id="__span-7-82"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-82" id="__codelineno-7-82" name="__codelineno-7-82"></a>[    0.000018] sched_clock: 64 bits at 100MHz, resolution 10ns, wraps every 4398046511100ns
</span><span id="__span-7-83"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-83" id="__codelineno-7-83" name="__codelineno-7-83"></a>[    0.010246] Console: colour dummy device 80x25
</span><span id="__span-7-84"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-84" id="__codelineno-7-84" name="__codelineno-7-84"></a>[    0.014169] Calibrating delay loop (skipped), value calculated using timer frequency.. 200.00 BogoMIPS (lpj=400000)
</span><span id="__span-7-85"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-85" id="__codelineno-7-85" name="__codelineno-7-85"></a>[    0.024255] pid_max: default: 32768 minimum: 301
</span><span id="__span-7-86"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-86" id="__codelineno-7-86" name="__codelineno-7-86"></a>[    0.033262] Mount-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-87"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-87" id="__codelineno-7-87" name="__codelineno-7-87"></a>[    0.039790] Mountpoint-cache hash table entries: 1024 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-88"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-88" id="__codelineno-7-88" name="__codelineno-7-88"></a>[    0.080128] ASID allocator using 9 bits (512 entries)
</span><span id="__span-7-89"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-89" id="__codelineno-7-89" name="__codelineno-7-89"></a>[    0.086947] rcu: Hierarchical SRCU implementation.
</span><span id="__span-7-90"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-90" id="__codelineno-7-90" name="__codelineno-7-90"></a>[    0.090826] rcu:     Max phase no-delay instances is 1000.
</span><span id="__span-7-91"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-91" id="__codelineno-7-91" name="__codelineno-7-91"></a>[    0.103556] smp: Bringing up secondary CPUs ...
</span><span id="__span-7-92"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-92" id="__codelineno-7-92" name="__codelineno-7-92"></a>[    0.107186] smp: Brought up 1 node, 1 CPU
</span><span id="__span-7-93"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-93" id="__codelineno-7-93" name="__codelineno-7-93"></a>[    0.118798] devtmpfs: initialized
</span><span id="__span-7-94"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-94" id="__codelineno-7-94" name="__codelineno-7-94"></a>[    0.169571] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns
</span><span id="__span-7-95"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-95" id="__codelineno-7-95" name="__codelineno-7-95"></a>[    0.178637] futex hash table entries: 256 (order: 2, 16384 bytes, linear)
</span><span id="__span-7-96"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-96" id="__codelineno-7-96" name="__codelineno-7-96"></a>[    0.214981] NET: Registered PF_NETLINK/PF_ROUTE protocol family
</span><span id="__span-7-97"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-97" id="__codelineno-7-97" name="__codelineno-7-97"></a>[    0.455944] pps_core: LinuxPPS API ver. 1 registered
</span><span id="__span-7-98"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-98" id="__codelineno-7-98" name="__codelineno-7-98"></a>[    0.460007] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti &lt;giometti@linux.it&gt;
</span><span id="__span-7-99"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-99" id="__codelineno-7-99" name="__codelineno-7-99"></a>[    0.469508] PTP clock support registered
</span><span id="__span-7-100"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-100" id="__codelineno-7-100" name="__codelineno-7-100"></a>[    0.476324] FPGA manager framework
</span><span id="__span-7-101"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-101" id="__codelineno-7-101" name="__codelineno-7-101"></a>[    0.493464] clocksource: Switched to clocksource riscv_clocksource
</span><span id="__span-7-102"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-102" id="__codelineno-7-102" name="__codelineno-7-102"></a>[    0.722433] NET: Registered PF_INET protocol family
</span><span id="__span-7-103"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-103" id="__codelineno-7-103" name="__codelineno-7-103"></a>[    0.731210] IP idents hash table entries: 4096 (order: 3, 32768 bytes, linear)
</span><span id="__span-7-104"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-104" id="__codelineno-7-104" name="__codelineno-7-104"></a>[    0.752236] tcp_listen_portaddr_hash hash table entries: 512 (order: 0, 4096 bytes, linear)
</span><span id="__span-7-105"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-105" id="__codelineno-7-105" name="__codelineno-7-105"></a>[    0.760269] Table-perturb hash table entries: 65536 (order: 6, 262144 bytes, linear)
</span><span id="__span-7-106"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-106" id="__codelineno-7-106" name="__codelineno-7-106"></a>[    0.767834] TCP established hash table entries: 2048 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-107"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-107" id="__codelineno-7-107" name="__codelineno-7-107"></a>[    0.775654] TCP bind hash table entries: 2048 (order: 3, 32768 bytes, linear)
</span><span id="__span-7-108"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-108" id="__codelineno-7-108" name="__codelineno-7-108"></a>[    0.783026] TCP: Hash tables configured (established 2048 bind 2048)
</span><span id="__span-7-109"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-109" id="__codelineno-7-109" name="__codelineno-7-109"></a>[    0.789689] UDP hash table entries: 256 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-110"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-110" id="__codelineno-7-110" name="__codelineno-7-110"></a>[    0.795620] UDP-Lite hash table entries: 256 (order: 1, 8192 bytes, linear)
</span><span id="__span-7-111"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-111" id="__codelineno-7-111" name="__codelineno-7-111"></a>[    0.816406] Unpacking initramfs...
</span><span id="__span-7-112"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-112" id="__codelineno-7-112" name="__codelineno-7-112"></a>[    0.926651] workingset: timestamp_bits=30 max_order=16 bucket_order=0
</span><span id="__span-7-113"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-113" id="__codelineno-7-113" name="__codelineno-7-113"></a>[    1.186672] io scheduler mq-deadline registered
</span><span id="__span-7-114"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-114" id="__codelineno-7-114" name="__codelineno-7-114"></a>[    1.190309] io scheduler kyber registered
</span><span id="__span-7-115"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-115" id="__codelineno-7-115" name="__codelineno-7-115"></a>[    1.570624] No litex,nclkout entry in the dts file
</span><span id="__span-7-116"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-116" id="__codelineno-7-116" name="__codelineno-7-116"></a>[    1.607895] LiteX SoC Controller driver initialized
</span><span id="__span-7-117"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-117" id="__codelineno-7-117" name="__codelineno-7-117"></a>[    2.358518] Initramfs unpacking failed: invalid magic at start of compressed archive
</span><span id="__span-7-118"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-118" id="__codelineno-7-118" name="__codelineno-7-118"></a>[    2.448554] Freeing initrd memory: 8192K
</span><span id="__span-7-119"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-119" id="__codelineno-7-119" name="__codelineno-7-119"></a>[    3.423827] f0001000.serial: ttyLXU0 at MMIO 0x0 (irq = 0, base_baud = 0) is a liteuart
</span><span id="__span-7-120"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-120" id="__codelineno-7-120" name="__codelineno-7-120"></a>[    3.431446] printk: console [liteuart0] enabled
</span><span id="__span-7-121"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-121" id="__codelineno-7-121" name="__codelineno-7-121"></a>[    3.431446] printk: console [liteuart0] enabled
</span><span id="__span-7-122"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-122" id="__codelineno-7-122" name="__codelineno-7-122"></a>[    3.440068] printk: bootconsole [liteuart0] disabled
</span><span id="__span-7-123"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-123" id="__codelineno-7-123" name="__codelineno-7-123"></a>[    3.440068] printk: bootconsole [liteuart0] disabled
</span><span id="__span-7-124"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-124" id="__codelineno-7-124" name="__codelineno-7-124"></a>[    3.499884] liteeth f0002000.mac eth0: irq 2 slots: tx 2 rx 2 size 2048
</span><span id="__span-7-125"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-125" id="__codelineno-7-125" name="__codelineno-7-125"></a>[    3.510055] i2c_dev: i2c /dev entries driver
</span><span id="__span-7-126"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-126" id="__codelineno-7-126" name="__codelineno-7-126"></a>[    3.520573] i2c i2c-0: Not I2C compliant: can't read SCL
</span><span id="__span-7-127"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-127" id="__codelineno-7-127" name="__codelineno-7-127"></a>[    3.525314] i2c i2c-0: Bus may be unreliable
</span><span id="__span-7-128"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-128" id="__codelineno-7-128" name="__codelineno-7-128"></a>[    3.577560] litex-mmc f0009000.mmc: LiteX MMC controller initialized.
</span><span id="__span-7-129"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-129" id="__codelineno-7-129" name="__codelineno-7-129"></a>[    3.623272] NET: Registered PF_INET6 protocol family
</span><span id="__span-7-130"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-130" id="__codelineno-7-130" name="__codelineno-7-130"></a>[    3.653652] Segment Routing with IPv6
</span><span id="__span-7-131"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-131" id="__codelineno-7-131" name="__codelineno-7-131"></a>[    3.657870] In-situ OAM (IOAM) with IPv6
</span><span id="__span-7-132"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-132" id="__codelineno-7-132" name="__codelineno-7-132"></a>[    3.662630] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver
</span><span id="__span-7-133"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-133" id="__codelineno-7-133" name="__codelineno-7-133"></a>[    3.683817] NET: Registered PF_PACKET protocol family
</span><span id="__span-7-134"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-134" id="__codelineno-7-134" name="__codelineno-7-134"></a>[    3.699016] Freeing unused kernel image (initmem) memory: 208K
</span><span id="__span-7-135"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-135" id="__codelineno-7-135" name="__codelineno-7-135"></a>[    3.704055] Kernel memory protection not selected by kernel config.
</span><span id="__span-7-136"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-136" id="__codelineno-7-136" name="__codelineno-7-136"></a>[    3.710506] Run /init as init process
</span><span id="__span-7-137"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-137" id="__codelineno-7-137" name="__codelineno-7-137"></a>Starting syslogd: OK
</span><span id="__span-7-138"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-138" id="__codelineno-7-138" name="__codelineno-7-138"></a>Starting klogd: OK
</span><span id="__span-7-139"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-139" id="__codelineno-7-139" name="__codelineno-7-139"></a>Running sysctl: OK
</span><span id="__span-7-140"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-140" id="__codelineno-7-140" name="__codelineno-7-140"></a>Saving 256 bits of non-creditable seed for next boot
</span><span id="__span-7-141"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-141" id="__codelineno-7-141" name="__codelineno-7-141"></a>Starting network: OK
</span><span id="__span-7-142"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-142" id="__codelineno-7-142" name="__codelineno-7-142"></a>
</span><span id="__span-7-143"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-143" id="__codelineno-7-143" name="__codelineno-7-143"></a>Welcome to Buildroot
</span><span id="__span-7-144"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-144" id="__codelineno-7-144" name="__codelineno-7-144"></a>buildroot login: root
</span><span id="__span-7-145"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-145" id="__codelineno-7-145" name="__codelineno-7-145"></a>                   __   _
</span><span id="__span-7-146"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-146" id="__codelineno-7-146" name="__codelineno-7-146"></a>                  / /  (_)__  __ ____ __
</span><span id="__span-7-147"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-147" id="__codelineno-7-147" name="__codelineno-7-147"></a>                 / /__/ / _ \/ // /\ \ /
</span><span id="__span-7-148"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-148" id="__codelineno-7-148" name="__codelineno-7-148"></a>                /____/_/_//_/\_,_//_\_\
</span><span id="__span-7-149"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-149" id="__codelineno-7-149" name="__codelineno-7-149"></a>                      / _ \/ _ \
</span><span id="__span-7-150"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-150" id="__codelineno-7-150" name="__codelineno-7-150"></a>   __   _ __      _  _\___/_//_/         ___  _
</span><span id="__span-7-151"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-151" id="__codelineno-7-151" name="__codelineno-7-151"></a>  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __
</span><span id="__span-7-152"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-152" id="__codelineno-7-152" name="__codelineno-7-152"></a> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /
</span><span id="__span-7-153"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-153" id="__codelineno-7-153" name="__codelineno-7-153"></a>/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/
</span><span id="__span-7-154"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-154" id="__codelineno-7-154" name="__codelineno-7-154"></a>                  / __/  |/  / _ \
</span><span id="__span-7-155"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-155" id="__codelineno-7-155" name="__codelineno-7-155"></a>                 _\ \/ /|_/ / ___/
</span><span id="__span-7-156"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-156" id="__codelineno-7-156" name="__codelineno-7-156"></a>                /___/_/  /_/_/
</span><span id="__span-7-157"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-157" id="__codelineno-7-157" name="__codelineno-7-157"></a>  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.
</span><span id="__span-7-158"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-158" id="__codelineno-7-158" name="__codelineno-7-158"></a>
</span><span id="__span-7-159"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-159" id="__codelineno-7-159" name="__codelineno-7-159"></a>login[70]: root login on 'console'
</span><span id="__span-7-160"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-7-160" id="__codelineno-7-160" name="__codelineno-7-160"></a>root@buildroot:~# 
</span></code></pre></div>
<p>Linux 中也可以访问网络（通过主线内的 liteeth 驱动）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>liteeth
</span><span id="__span-8-2"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.499861<span class="o">]</span><span class="w"> </span>liteeth<span class="w"> </span>f0002000.mac<span class="w"> </span>eth0:<span class="w"> </span>irq<span class="w"> </span><span class="m">2</span><span class="w"> </span>slots:<span class="w"> </span>tx<span class="w"> </span><span class="m">2</span><span class="w"> </span>rx<span class="w"> </span><span class="m">2</span><span class="w"> </span>size<span class="w"> </span><span class="m">2048</span>
</span><span id="__span-8-3"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>$<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>eth0<span class="w"> </span>up
</span><span id="__span-8-4"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.1.50/24<span class="w"> </span>dev<span class="w"> </span>eth0
</span><span id="__span-8-5"><a href="../../hardware/2023/04/19/litex-digilent-arty-a7/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>$<span class="w"> </span>ping<span class="w"> </span><span class="m">192</span>.168.1.100
</span></code></pre></div>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/04/19/litex-digilent-arty-a7/#_1">其他开发板</a></h3>
<p>除了 Digilent Arty A7，我还做了以下开发板的 LiteX 支持：</p>
<ul>
<li><a href="https://github.com/jiegec/litex-boards/tree/vcu128">VCU128</a>，支持 UART，SDRAM 和 HBM；以太网因为是 SGMII 暂时无法解决</li>
<li><a href="https://github.com/jiegec/litex-boards/tree/ma703fa-35t">MA703FA-35T</a>，支持 UART，SDRAM，ETH、SD 卡和 HDMI；MA703FA-35T 的文档中 TF_DAT3 引脚绑定有误，AB12 应该改为 AB20</li>
<li><a href="https://github.com/jiegec/litex-boards/tree/alinx_ax7021">Alinx AX7021</a>，支持 UART over JTAG 和 HDMI</li>
<li><a href="https://lab.cs.tsinghua.edu.cn/digital-design/doc/hardware/board/">THU Digital Design</a>，基于 @gaoyichuan 的实现，支持 UART，SDRAM，ETH，SD 卡和 VGA</li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2023/04/19/litex-digilent-arty-a7/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-14 00:00:00">2023年4月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="cc"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/">C/C++ 数参数个数的特别方法</a></h2>
<h3 id="_1"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#_1">背景</a></h3>
<p>群友上个月提了一个未知来源问题：</p>
<p>实现一个你自己的 <code>printf(int, ...)</code> 函数，该函数包含可变参数。为简便期间，假设所有参数均为 int 类型。</p>
<ol>
<li>第一个参数是一个普通参数，不表示后续可变参数的数目</li>
<li>在 printf 中逐个输出所有传入的整数值（可使用系统自带的 kprintf 实现输出）</li>
<li>思考如何判定参数结束，是否有副作用</li>
</ol>
<h3 id="va_args"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#va_args">va_args</a></h3>
<p>我们知道，传统的处理可变参数的方法是 va_args，但是它无法知道传入了多少参数，而要像 POSIX printf 那样，解析 format 参数，然后一个一个去取。</p>
<p>所以问题的关键是，如何获取参数的个数？一个思路是宏，尝试用宏的魔法来计算出参数个数，这个方法可能是可以的，但是没有深究。另一个思路是利用 ABI 的特点，例如 i386 上参数是通过栈传递的，那或许可以在栈上找到所有的 int，但是问题是无法确认参数在哪里结束。</p>
<h3 id="__builtin_va_arg_pack_len"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#__builtin_va_arg_pack_len">__builtin_va_arg_pack_len</a></h3>
<p>今天，另一位群友发了一个链接：<a href="https://gcc.gnu.org/onlinedocs/gcc/Constructing-Calls.html#Constructing-Calls">https://gcc.gnu.org/onlinedocs/gcc/Constructing-Calls.html#Constructing-Calls</a>，讲述了 GCC 中一些特别的 builtin 函数，用于函数调用相关的魔法，其中一段描述吸引了我的眼球：</p>
<div class="language-text highlight"><pre><span></span><code>Built-in Function: int __builtin_va_arg_pack_len ()

This built-in function returns the number of anonymous arguments of an
inline function. It can be used only in inline functions that are always
inlined, never compiled as a separate function, such as those using
__attribute__ ((__always_inline__)) or __attribute__ ((__gnu_inline__))
extern inline functions. For example following does link- or run-time
checking of open arguments for optimized code:
</code></pre></div>
<p>这正好实现了前面提到的获取参数个数，实现思路也可以想到，就是编译器在 inline 的时候，顺便做了一次替换。也因此，这个函数必须被 inline，不能正常调用。有了这个思路以后，经过一番尝试，写入了下面的代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-0-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cp">##include &lt;stdarg.h&gt;</span>
</span><span id="__span-0-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_printf_inner</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-0-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-0-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
</span><span id="__span-0-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-0-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">}</span>
</span><span id="__span-0-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">__always_inline__</span><span class="p">))</span><span class="w"> </span><span class="kr">inline</span>
</span><span id="__span-0-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="kt">void</span><span class="w"> </span><span class="n">my_printf</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__builtin_va_arg_pack_len</span><span class="p">();</span>
</span><span id="__span-0-17"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
</span><span id="__span-0-18"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="n">my_printf_inner</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">__builtin_va_arg_pack</span><span class="p">());</span>
</span><span id="__span-0-19"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</span><span id="__span-0-20"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>
</span><span id="__span-0-21"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-22"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="n">my_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-0-23"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-24"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个代码在 GCC 中可以正确地输出 1-10 的十个数字。我一开始尝试的时候，把循环也写到 <code>my_printf</code> 函数中，但是 GCC 的 inline 就罢工了，最后只好拆成两个函数，把不知道参数个数的问题，转化成知道参数的问题，剩下就好解决了。</p>
<p>最后生成的汇编如下：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nl">main:</span>
</span><span id="__span-1-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
</span><span id="__span-1-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
</span><span id="__span-1-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-1-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-4</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-1-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-8</span><span class="p">],</span><span class="w"> </span><span class="mi">9</span>
</span><span id="__span-1-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-4</span><span class="p">]</span>
</span><span id="__span-1-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span>
</span><span id="__span-1-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="no">OFFSET</span><span class="w"> </span><span class="no">FLAT</span><span class="p">:.</span><span class="no">LC0</span>
</span><span id="__span-1-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span>
</span><span id="__span-1-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="no">DWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rbp-8</span><span class="p">]</span>
</span><span id="__span-1-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">10</span>
</span><span id="__span-1-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">9</span>
</span><span id="__span-1-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">8</span>
</span><span id="__span-1-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="nf">push</span><span class="w">    </span><span class="mi">7</span>
</span><span id="__span-1-17"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">r9d</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
</span><span id="__span-1-18"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">r8d</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
</span><span id="__span-1-19"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">ecx</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-1-20"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edx</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
</span><span id="__span-1-21"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">esi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
</span><span id="__span-1-22"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">edi</span><span class="p">,</span><span class="w"> </span><span class="no">eax</span>
</span><span id="__span-1-23"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-24"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="nf">call</span><span class="w">    </span><span class="no">my_printf_inner</span>
</span><span id="__span-1-25"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
</span><span id="__span-1-26"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">        </span><span class="nf">nop</span>
</span><span id="__span-1-27"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-1-28"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="nf">leave</span>
</span><span id="__span-1-29"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="nf">ret</span>
</span></code></pre></div>
<p>可以看到，它 inline 了 <code>my_printf</code> 的实现，先调用了第一个 <code>printf</code>，然后把剩下的参数个数 <code>9</code> 赋值给了 <code>edi</code>，剩下就是正常的传参了。</p>
<p>以上实验都在 Godbolt Compiler Explorer 中进行：<a href="https://godbolt.org/z/KjYzETn5Y">https://godbolt.org/z/KjYzETn5Y</a>。</p>
<p>继续挖掘，会发现在 libc 中出现了 __builtin_va_arg_pack_len 的身影，在 fcntl2.h 中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">__errordecl</span><span class="w"> </span><span class="p">(</span><span class="n">__open_too_many_args</span><span class="p">,</span>
</span><span id="__span-2-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">             </span><span class="s">"open can be called either with 2 or 3 arguments, not more"</span><span class="p">);</span>
</span><span id="__span-2-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">__errordecl</span><span class="w"> </span><span class="p">(</span><span class="n">__open_missing_mode</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">             </span><span class="s">"open with O_CREAT or O_TMPFILE in second argument needs 3 arguments"</span><span class="p">);</span>
</span><span id="__span-2-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="n">__fortify_function</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-2-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-2-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">{</span>
</span><span id="__span-2-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-2-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_constant_p</span><span class="w"> </span><span class="p">(</span><span class="n">__oflag</span><span class="p">))</span>
</span><span id="__span-2-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__OPEN_NEEDS_MODE</span><span class="w"> </span><span class="p">(</span><span class="n">__oflag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-2-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">          </span><span class="n">__open_missing_mode</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-2-17"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">__open_2</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">);</span>
</span><span id="__span-2-18"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-19"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">__open_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="n">__va_arg_pack</span><span class="w"> </span><span class="p">());</span>
</span><span id="__span-2-20"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-21"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>
</span><span id="__span-2-22"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__va_arg_pack_len</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-2-23"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">__open_2</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">);</span>
</span><span id="__span-2-24"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>
</span><span id="__span-2-25"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">__open_alias</span><span class="w"> </span><span class="p">(</span><span class="n">__path</span><span class="p">,</span><span class="w"> </span><span class="n">__oflag</span><span class="p">,</span><span class="w"> </span><span class="n">__va_arg_pack</span><span class="w"> </span><span class="p">());</span>
</span><span id="__span-2-26"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它核心的思想就是根据 open 第三个参数的有无，调用相应的 <code>__open_2</code> 或者 <code>__open_alias</code> 函数，这样就不用再用 <code>va_args</code> 方法了，并且如果传入了过多的参数，可以直接在编译期指出错误。例子：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">##include &lt;fcntl.h&gt;</span>
</span><span id="__span-3-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">open</span><span class="p">(</span><span class="s">"123"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-3-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>报错：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">In</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">301</span><span class="p">,</span>
</span><span id="__span-4-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">                 </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-4-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">In</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">'</span><span class="n">open</span><span class="err">'</span><span class="p">,</span>
</span><span id="__span-4-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">inlined</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">'</span><span class="n">main</span><span class="err">'</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span>
</span><span id="__span-4-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">bits</span><span class="o">/</span><span class="n">fcntl2</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">'</span><span class="n">__open_too_many_args</span><span class="err">'</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">more</span>
</span><span id="__span-4-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-4-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">      </span><span class="o">|</span><span class="w">     </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~</span>
</span><span id="__span-4-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="n">ASM</span><span class="w"> </span><span class="n">generation</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">returned</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-4-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="n">In</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">fcntl</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">301</span><span class="p">,</span>
</span><span id="__span-4-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">                 </span><span class="n">from</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">2</span><span class="o">:</span>
</span><span id="__span-4-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="n">In</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="err">'</span><span class="n">open</span><span class="err">'</span><span class="p">,</span>
</span><span id="__span-4-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="n">inlined</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="err">'</span><span class="n">main</span><span class="err">'</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span>
</span><span id="__span-4-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">bits</span><span class="o">/</span><span class="n">fcntl2</span><span class="p">.</span><span class="n">h</span><span class="o">:</span><span class="mi">44</span><span class="o">:</span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">'</span><span class="n">__open_too_many_args</span><span class="err">'</span><span class="w"> </span><span class="n">declared</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">either</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">more</span>
</span><span id="__span-4-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">__open_too_many_args</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-4-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">      </span><span class="o">|</span><span class="w">     </span><span class="o">^~~~~~~~~~~~~~~~~~~~~~~</span>
</span><span id="__span-4-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="n">Execution</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">returned</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>Compiler Explorer:<a href="https://godbolt.org/z/hebshz3P5">https://godbolt.org/z/hebshz3P5</a>.</p>
<h3 id="c"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#c">使用 C 宏</a></h3>
<p>和 Claude 聊了一下，是否能够用 C 宏来实现，它的回答是：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cp">##define PRINTF(...) printf(__VA_ARGS__)</span>
</span><span id="__span-5-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="cp">##define NARG(...)  (sizeof((int[]){__VA_ARGS__})/sizeof(int))</span>
</span><span id="__span-5-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
</span><span id="__span-5-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">printf</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-5-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">);</span>
</span><span id="__span-5-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>
</span><span id="__span-5-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="c1">// Access the variable arguments using va_arg based on </span>
</span><span id="__span-5-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="c1">// the number of arguments passed, obtained using NARG</span>
</span><span id="__span-5-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>
</span><span id="__span-5-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-5-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="p">}</span>
</span><span id="__span-5-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>
</span><span id="__span-5-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="c1">// Usage:</span>
</span><span id="__span-5-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="n">PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w">     </span><span class="c1">// Prints 1 2 3 </span>
</span><span id="__span-5-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="n">PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"> </span><span class="c1">// Prints 1 2 3 4</span>
</span></code></pre></div>
<p>核心思路就是把参数列表放到数组里，然后让编译器去推断数组大小。沿着这个思路，实现出代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-6-2"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="cp">##include &lt;stdarg.h&gt;</span>
</span><span id="__span-6-3"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>
</span><span id="__span-6-4"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">my_printf_inner</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
</span><span id="__span-6-6"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-6-7"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-9"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
</span><span id="__span-6-10"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-11"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-6-12"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="p">}</span>
</span><span id="__span-6-13"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>
</span><span id="__span-6-14"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="cp">##define MY_PRINTF(...) do {int len=(sizeof((int[]){__VA_ARGS__})/sizeof(int)); my_printf_inner(len, __VA_ARGS__); } while(0);</span>
</span><span id="__span-6-15"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-17"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="n">MY_PRINTF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-6-18"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-19"><a href="../../programming/2023/04/14/counting-arguments/#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="p">}</span>
</span></code></pre></div>
<p>也是可以工作的。Compiler Explorer 链接：<a href="https://godbolt.org/z/TxKb3YEcf">https://godbolt.org/z/TxKb3YEcf</a>。</p>
<h3 id="chatgpt"><a class="toclink" href="../../programming/2023/04/14/counting-arguments/#chatgpt">ChatGPT</a></h3>
<p>尝试询问了一下 ChatGPT：<a href="https://shareg.pt/IXUKjYK">https://shareg.pt/IXUKjYK</a>，它可以写出额外传入 int 个数的版本，可以写出哨兵（传入 <code>-1</code> 表示结束）的版本，提示了 builtin 以后，再提示 inline 和 always_inline，最后让它拆分成两个函数，得到的代码距离正确结果已经比较接近，但还是有一些问题。</p>
<nav class="md-post__action">
<a href="../../programming/2023/04/14/counting-arguments/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-10 00:00:00">2023年4月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="sco-openserver-600"><a class="toclink" href="../../system/2023/04/10/sco6/">SCO OpenServer 6.0.0 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/10/sco6/#_1">安装过程</a></h3>
<p>首先从 <a href="https://www.sco.com/support/update/download/product.php?pfid=12&amp;prid=20">https://www.sco.com/support/update/download/product.php?pfid=12&amp;prid=20</a> 下载 SCO OpenServer 的安装 ISO。尝试过用 QEMU 启动，但是会卡在无法读取硬盘的错误上。</p>
<p>最后使用 VirtualBox 7.0.6 成功启动，注意创建虚拟机的时候不要给太多内存，例如 4GB 就起不来，2GB 可以。硬盘我也只给了 4GB 的空间。</p>
<p>安装过程中会询问 License number 和 License code，可以选择使用 Evaluation License，或者使用下面参考文档中提供的 License。按照流程一直走就可以了。如果重启出现无法 mount root 的问题，就 poweroff 再开机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/10/sco6/#_2">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://virtuallyfun.com/2020/11/21/fun-with-openserver-6-and-mergepro/">https://virtuallyfun.com/2020/11/21/fun-with-openserver-6-and-mergepro/</a></li>
</ul>
<nav class="md-post__action">
<a href="../../system/2023/04/10/sco6/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-10 00:00:00">2023年4月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="unixware-714"><a class="toclink" href="../../system/2023/04/10/unixware7/">UnixWare 7.1.4 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/10/unixware7/#_1">安装过程</a></h3>
<p>在 <a href="https://www.sco.com/support/update/download/product.php?pfid=1&amp;prid=6">https://www.sco.com/support/update/download/product.php?pfid=1&amp;prid=6</a> 可以看到 UnixWare 7.1.4 的相关下载，其中首先要下载 UnixWare 的安装 ISO：<a href="https://www.sco.com/support/update/download/release.php?rid=346">https://www.sco.com/support/update/download/release.php?rid=346</a>，尝试过用 QEMU 启动，会遇到找不到 CD-ROM 的问题，虽然通过设置 <code>ATAPI_DMA_DISABLE=YES</code> 解决了，但是又遇到了找不到硬盘的问题。</p>
<p>最后换成了 VirtualBox 7.0.6。用 VirtualBox 创建虚拟机的时候，不要给太多内存，4GB 就会无法启动，2GB 可以，硬盘也不要给太多，4GB 就足够。</p>
<p>剩下就是按照安装界面一路默认即可，License 可以选择 Defer，使用 Evaluation License。</p>
<p>关机以后，修改启动顺序，把硬盘放到 CD 前，然后启动，就可以进入系统了。如果重启出现无法 mount root 的问题，就 poweroff 再开机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/10/unixware7/#_2">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://virtuallyfun.com/2018/01/31/revisiting-a-unixware-7-1-1-install-on-qemu-kvm/">https://virtuallyfun.com/2018/01/31/revisiting-a-unixware-7-1-1-install-on-qemu-kvm/</a></li>
</ul>
<nav class="md-post__action">
<a href="../../system/2023/04/10/unixware7/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-04-09 00:00:00">2023年4月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="aix-72"><a class="toclink" href="../../system/2023/04/09/aix/">AIX 7.2 虚拟机安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/04/09/aix/#_1">安装过程</a></h3>
<p>宿主机环境是 Debian bookworm，不需要像其他教程那样自己编译 qemu，直接 apt install 即可。</p>
<p>通过 google 可以搜索到 AIX 7.2 的 ISO，下载第一个 ISO 到本地，然后在 QEMU 中启动安装镜像：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2023/04/09/aix/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>qemu-img<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>qcow2<span class="w"> </span>aix-hdd.qcow2<span class="w"> </span>20G
</span><span id="__span-0-2"><a href="../../system/2023/04/09/aix/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>qemu-system-ppc64<span class="w"> </span>-cpu<span class="w"> </span>POWER8<span class="w"> </span>-machine<span class="w"> </span>pseries<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>aix-hdd.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-device<span class="w"> </span>virtio-scsi-pci,id<span class="o">=</span>scsi<span class="w"> </span>-device<span class="w"> </span>scsi-hd,drive<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-cdrom<span class="w"> </span>aix_7200-04-02-2027_1of2_072020.iso<span class="w"> </span>-prom-env<span class="w"> </span>boot-command<span class="o">=</span><span class="s1">'boot cdrom:\ppc\chrp\bootfile.exe'</span><span class="w"> </span>-display<span class="w"> </span>none
</span></code></pre></div>
<p>进去以后，耐心等待，直到进入安装界面，按照提示进行安装，建议安装上 SSH Server，关掉图形界面，这样安装会比较快。安装需要几十分钟，安装完成后会进入 bootloop，关掉 QEMU。接着，准备好网络：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../system/2023/04/09/aix/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>sudo<span class="w"> </span>ip<span class="w"> </span>tuntap<span class="w"> </span>add<span class="w"> </span>tap0<span class="w"> </span>mode<span class="w"> </span>tap
</span><span id="__span-1-2"><a href="../../system/2023/04/09/aix/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>tap0<span class="w"> </span>up
</span><span id="__span-1-3"><a href="../../system/2023/04/09/aix/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>sudo<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.0.2.15/24<span class="w"> </span>dev<span class="w"> </span>tap0
</span></code></pre></div>
<p>再启动虚拟机，注意启动选项修改了，并且多了网络的配置：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../system/2023/04/09/aix/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>qemu-system-ppc64<span class="w"> </span>-cpu<span class="w"> </span>POWER8<span class="w"> </span>-machine<span class="w"> </span>pseries<span class="w"> </span>-m<span class="w"> </span><span class="m">16384</span><span class="w"> </span>-serial<span class="w"> </span>mon:stdio<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>aix-hdd.qcow2,if<span class="o">=</span>none,id<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-device<span class="w"> </span>virtio-scsi-pci,id<span class="o">=</span>scsi<span class="w"> </span>-device<span class="w"> </span>scsi-hd,drive<span class="o">=</span>drive-virtio-disk0<span class="w"> </span>-cdrom<span class="w"> </span>aix_7200-04-02-2027_1of2_072020.iso<span class="w"> </span>-prom-env<span class="w"> </span>boot-command<span class="o">=</span><span class="s1">'boot disk:'</span><span class="w"> </span>-display<span class="w"> </span>none<span class="w"> </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>tap,script<span class="o">=</span>no,ifname<span class="o">=</span>tap0
</span></code></pre></div>
<p>第一次启动系统时，会进入配置界面，修改好 root 密码，然后配置网络：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../system/2023/04/09/aix/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>chdev<span class="w"> </span>-l<span class="w"> </span>en0<span class="w"> </span>-a<span class="w"> </span><span class="nv">netaddr</span><span class="o">=</span><span class="m">10</span>.0.2.16<span class="w"> </span>-a<span class="w"> </span><span class="nv">netmask</span><span class="o">=</span><span class="m">255</span>.255.255.0<span class="w"> </span>-a<span class="w"> </span><span class="nv">state</span><span class="o">=</span>up
</span></code></pre></div>
<p>到这里了以后，就可以通过 ssh 访问虚拟机：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../system/2023/04/09/aix/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>ssh<span class="w"> </span>root@10.0.2.16
</span></code></pre></div>
<h3 id="kvm"><a class="toclink" href="../../system/2023/04/09/aix/#kvm">KVM</a></h3>
<p>另外测试了一下，在 powerpc64 机器上，可以开启 KVM 来加速 QEMU，但是需要首先关掉 SMT。另外在使用过程中出现了玄学问题，最后还是在 x86 上跑了虚拟机。</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/04/09/aix/#_2">安装软件</a></h3>
<p>接下来，可以从 <a href="https://www.ibm.com/support/pages/node/882892">AIX Toolbox for Open Source Software</a> 安装软件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../system/2023/04/09/aix/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">## in aix</span>
</span><span id="__span-5-2"><a href="../../system/2023/04/09/aix/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+200M<span class="w"> </span>/home
</span><span id="__span-5-3"><a href="../../system/2023/04/09/aix/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+400M<span class="w"> </span>/opt
</span><span id="__span-5-4"><a href="../../system/2023/04/09/aix/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>chfs<span class="w"> </span>-a<span class="w"> </span><span class="nv">size</span><span class="o">=</span>+400M<span class="w"> </span>/tmp
</span><span id="__span-5-5"><a href="../../system/2023/04/09/aix/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="c1">## setup default gateway</span>
</span><span id="__span-5-6"><a href="../../system/2023/04/09/aix/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>route<span class="w"> </span>add<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">10</span>.0.2.15<span class="w"> </span>-if<span class="w"> </span>en0
</span><span id="__span-5-7"><a href="../../system/2023/04/09/aix/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="c1">## edit /etc/resolv.conf</span>
</span><span id="__span-5-8"><a href="../../system/2023/04/09/aix/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"nameserver 1.1.1.1"</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/resolv.conf
</span><span id="__span-5-9"><a href="../../system/2023/04/09/aix/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="c1">## in host</span>
</span><span id="__span-5-10"><a href="../../system/2023/04/09/aix/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>wget<span class="w"> </span>https://public.dhe.ibm.com/aix/freeSoftware/aixtoolbox/ezinstall/ppc/dnf_aixtoolbox.sh
</span><span id="__span-5-11"><a href="../../system/2023/04/09/aix/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>scp<span class="w"> </span>dnf_aixtoolbox.sh<span class="w"> </span>root@10.0.2.16:/
</span><span id="__span-5-12"><a href="../../system/2023/04/09/aix/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="c1">## in aix</span>
</span><span id="__span-5-13"><a href="../../system/2023/04/09/aix/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>rpm<span class="w"> </span>--rebuilddb
</span><span id="__span-5-14"><a href="../../system/2023/04/09/aix/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>ksh<span class="w"> </span>/dnf_aixtoolbox.sh<span class="w"> </span>-y
</span><span id="__span-5-15"><a href="../../system/2023/04/09/aix/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>/opt/freeware/bin/dnf<span class="w"> </span>update
</span><span id="__span-5-16"><a href="../../system/2023/04/09/aix/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>/opt/freeware/bin/dnf<span class="w"> </span>install<span class="w"> </span>gcc
</span></code></pre></div>
<p>安装好的包会放到 /opt/freeware 路径下。</p>
<p>安装过程中可能需要继续扩大各个 fs 的大小。</p>
<p>dnf 如果提示缺少 <code>libssl.a</code>，参考 <a href="https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors">https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors</a> 进行解决：</p>
<ol>
<li>
<p>访问 <a href="https://www.ibm.com/resources/mrs/assets?source=aixbp&amp;S_PKG=openssl">https://www.ibm.com/resources/mrs/assets?source=aixbp&amp;S_PKG=openssl</a> 下载安装包，例如 <code>openssl-1.1.2.2000.tar.Z</code>。</p>
</li>
<li>
<p>scp 到 AXI 上安装：</p>
</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../system/2023/04/09/aix/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>uncompress<span class="w"> </span>openssl-1.1.2.2000.tar.Z
</span><span id="__span-6-2"><a href="../../system/2023/04/09/aix/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>tar<span class="w"> </span>-xvf<span class="w"> </span>openssl-1.1.2.2000.tar
</span><span id="__span-6-3"><a href="../../system/2023/04/09/aix/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">## install openssl.base using smitty</span>
</span></code></pre></div>
<p>为了方便，可以修改 <code>/etc/environment</code> 文件，把 <code>/opt/freeware/bin</code> 目录加到 PATH 目录中。</p>
<h3 id="_3"><a class="toclink" href="../../system/2023/04/09/aix/#_3">参考文档</a></h3>
<p>本博客参考了以下文档中的命令：</p>
<ul>
<li><a href="https://aix4admins.blogspot.com/2020/04/qemu-aix-on-x86-qemu-quick-emulator-is.html">https://aix4admins.blogspot.com/2020/04/qemu-aix-on-x86-qemu-quick-emulator-is.html</a></li>
<li><a href="https://virtuallyfun.com/2019/04/22/installing-aix-on-qemu/">https://virtuallyfun.com/2019/04/22/installing-aix-on-qemu/</a></li>
<li><a href="https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors">https://www.ibm.com/support/pages/resolving-rpm-libssla-and-libcryptoa-errors</a></li>
</ul>
<nav class="md-post__action">
<a href="../../system/2023/04/09/aix/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__current">2</span> <a class="md-pagination__link" href="../3/">3</a> <a class="md-pagination__link" href="../4/">4</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
<script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>