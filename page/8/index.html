
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/8/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-12 00:00:00">2022年3月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="openroad-flow"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/">OpenROAD Flow 初尝试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_1">背景</a></h3>
<p>最近在尝试接触一些芯片前后端的知识。正好有现成的开源工具链 OpenROAD 来做这个事情，借此机会来学习一下整个流程。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_2">尝试过程</a></h3>
<p>首先 clone 仓库 OpenROAD-flow-scripts，然后运行：<code>./build_openroad.sh</code>，脚本会克隆一些仓库，自动进行编译。</p>
<p>编译中会找不到一些库，比如可能需要安装这些依赖：<code>liblemon-dev libeigen3-dev libreadline-dev swig</code>，此外运行的时候还需要 <code>klayout</code> 依赖。</p>
<p>如果遇到解决 cmake 找不到 LEMON 的问题，这是一个 <a href="https://lemon.cs.elte.hu/trac/lemon/ticket/628">BUG</a>，可以运行下面的命令解决：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/lib/x86_64-linux-gnu/cmake/lemon
</span><span id="__span-0-2"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>cp<span class="w"> </span>lemonConfig.cmake<span class="w"> </span>LEMONConfig.cmake
</span></code></pre></div>
<p>编译后整个目录大概有 4.8G，输出的二进制目录是 133M。</p>
<p>如果要跑一下样例里的 nangate45 工艺的 gcd 例子，运行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>cd flow
</span><span id="__span-1-2"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>make DESIGN_CONFIG=./designs/nangate45/gcd/config.mk
</span></code></pre></div>
<h3 id="gcd"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#gcd">分析 GCD 测例</a></h3>
<p>这个测例的代码提供了这样一个接口：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">module</span><span class="w"> </span><span class="n">gcd</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="p">(</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">req_msg</span><span class="p">,</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_rdy</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_val</span><span class="p">,</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">reset</span><span class="p">,</span>
</span><span id="__span-2-8"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w">  </span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">resp_msg</span><span class="p">,</span>
</span><span id="__span-2-9"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_rdy</span><span class="p">,</span>
</span><span id="__span-2-10"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">resp_val</span>
</span><span id="__span-2-11"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="p">);</span>
</span><span id="__span-2-12"><a href="../../hardware/2022/03/12/try-openroad-flow/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>从名字可以推断出，外部通过 req 发送请求到 GCD 模块，然后模块计算出 GCD 后再返回结果。</p>
<p>根据日志可以看到，从 verilog 到最终的 gds 文件，经过了这些步骤：</p>
<ol>
<li>第一步用 yosys 综合（1_1_yosys），把 verilog 代码转化为网表，网表中的单元就是形如 <code>NAND2_X1</code> <code>DFF_X1</code> 等这样由工艺库定义的一些单元。</li>
<li>第二步进行 floorplan（2_1_floorplan），规划出芯片的大小，逻辑放在哪个位置，输入输出引脚放在什么位置（2_2_floorplan_io），还要考虑 SRAM 等宏或者 IP（2_4_mplace），电源网络 PDN（2_6_floorplan_pdn）</li>
<li>第三步是 Placement，就是把前面得到的一些 cell 放到芯片上的 (x,y) 坐标上</li>
<li>第四步是 Clock Tree Synthesis（4_1_cts），简称 CTS，生成时钟树</li>
<li>第五步是进行路由连线，OpenROAD 有两个路由：FastRoute（5_1_fastroute）和 TritonRoute（5_2_TritonRoute）</li>
<li>第六步输出结果到 gds 文件（6_1_merge）。</li>
</ol>
<p>这些步骤可以在仓库的 <code>flow/Makefile</code> 里面看得比较清晰，英文版摘抄如下：</p>
<ol>
<li>SYNTHESIS<ol>
<li>Run Synthesis using yosys</li>
</ol>
</li>
<li>FLOORPLAN<ol>
<li>Translate verilog to def</li>
<li>IO Placement (random)</li>
<li>Timing Driven Mixed Size Placement (tdms)</li>
<li>Macro Placement</li>
<li>Tapcell and Welltie insertion</li>
<li>PDN generation</li>
</ol>
</li>
<li>PLACE<ol>
<li>Global placement without placed IOs, timing-driven, and routability-driven</li>
<li>IO placement (non-random)</li>
<li>Global placement with placed IOs, timing-driven, and routability-driven</li>
<li>Resizing &amp; Buffering</li>
<li>Detail placement</li>
</ol>
</li>
<li>CTS(Clock Tree Synthesis)<ol>
<li>Run TritonCTS</li>
<li>Filler cell insertion</li>
</ol>
</li>
<li>ROUTING<ol>
<li>Run global route (FastRoute)</li>
<li>Run detailed route (TritonRoute)</li>
</ol>
</li>
</ol>
<p>最后生成的 gds，用 KLayout 打开，可以看到这个样子：</p>
<p><img alt="" src="/images/gcd_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 1.71 mW，面积占用是 703 um^2。</p>
<p>还跑了一下其他样例设计的 gds，比如 ibex：</p>
<p><img alt="" src="/images/ibex_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 10.1 mW，面积占用是 32176 um^2。</p>
<p>还有 tiny rocket：</p>
<p><img alt="" src="/images/tiny_rocket_gds.png"/></p>
<p>日志里可以看到，预测的总功耗是 36.8 mW，面积占用是 52786 um^2。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_3">工艺库常见术语</a></h3>
<ul>
<li>slvt/lvt/rvt/hvt: super-low/low/regular/high V threshold 前者速度快：阈值电压低，同时漏电流大</li>
<li>ss/tt/ff: slow-slow/typical-typical/fast-fast 后者速度快：电压高，温度低，比如 SS（0.99V 125C）TT（1.10V 25C）FF（1.21V -40C）；有时候还会看到 ssg，可以理解为 ss 的比较精确的版本，因此没有那么悲观，延迟比 SS 低一些，详见 <a href="https://cloud.tencent.com/developer/article/1598417">STA | ssg 跟 ss corner 的区别——谬误更正版</a></li>
<li>c+数字：表示的是 channel length，c40 表示 40nm，数字越大速度越慢，能耗越低</li>
<li>数字+track：表示的是 track height，sc12 表示 12-track，数字越大速度越快</li>
</ul>
<p>ARM 的文档 <a href="https://developer.arm.com/documentation/102738/0100/Choosing-the-physical-IP-libraries">Choosing the physical IP libraries</a> 描述了 Channel length, Track height, Voltage threshold 等不同的选择。</p>
<p>综合来说，如果要更低的延迟，选择低 vt，小 c 和大 track，反之如果要更低的能耗，选择高 vt，大 c 和 小 track。</p>
<h3 id="ccs-vs-nldm"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#ccs-vs-nldm">CCS v.s. NLDM</a></h3>
<p>由于物理的特性比较复杂，工艺库里描述的也只是一个大致的模型，刻画了这些 cell 的特性，那么自然可以选取不同的模型。NLDM（上面举的例子就是 NLDM），CCS 就是常见的两个模型，相比之下，CCS 更精确，同时参数更多。更精确的还有直接用 SPICE 描述的电路。详细的对比可以看下面的参考文档。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/03/12/try-openroad-flow/#_4">参考文档</a></h3>
<ul>
<li><a href="https://theopenroadproject.org/2019/12/11/getting-started-with-openroad-app-part-1/">GETTING STARTED WITH OPENROAD APP – PART 1</a></li>
<li><a href="https://link.springer.com/book/10.1007/b117024">Advanced ASIC Chip Synthesis Using Synopsys® Design Compiler™ Physical Compiler™ and PrimeTime®</a></li>
<li><a href="https://www.paripath.com/blog/characterization-blog/comparing-nldm-and-ccs-delay-models">Comparing NLDM And CCS delay models</a></li>
<li><a href="https://chitlesh.ch/wordpress/liberty-ccs-ecsm-or-ndlm/">Introduction to Liberty : CCS, ECSM and NDLM</a></li>
<li><a href="https://blog.csdn.net/graymount/article/details/106010388">STA 概念：一文了解 NLDM 与 CCS</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/03/12/try-openroad-flow/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-09 00:00:00">2022年3月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="jtag-vcu128-rocket-chip"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/">通过 JTAG 对 VCU128 上的 Rocket Chip 进行调试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_1">前言</a></h3>
<p>两年前，我尝试过用 BSCAN JTAG 来配置 Rocket Chip 的调试，但是这个方法不是很好用，具体来说，如果有独立的一组 JTAG 信号，配置起来会更方便，而且不用和 Vivado 去抢，OpenOCD 可以和 Vivado hw_server 同时运行和工作。但是，苦于 VCU128 上没有 PMOD 接口，之前一直没考虑过在 VCU128 上配置独立的 JTAG。然后最近研究了一下，终于解决了这个问题。</p>
<h3 id="jtag"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#jtag">寻找 JTAG 接口</a></h3>
<p>前几天在研究别的问题的时候，看到 VCU128 文档中的这段话：</p>
<div class="language-text highlight"><pre><span></span><code>The FT4232HL U8 multi-function USB-UART on the VCU128 board provides three level-shifted
UART connections through the single micro-AB USB connector J2.
• Channel A is configured in JTAG mode to support the JTAG chain
• Channel B implements 4-wire UART0 (level-shifted) FPGA U1 bank 67 connections
• Channel C implements 4-wire UART1 (level-shifted) FPGA U1 bank 67 connections
• Channel D implements 2-wire (level-shifted) SYSCTLR U42 bank 501 connections
</code></pre></div>
<p>其中 Channel A 是到 FPGA 本身的 JTAG 接口，是给 Vivado 用的，如果是通过 BSCAN 的方式，也是在这个 Channel 上，但是需要经过 FPGA 自己的 TAP 再隧道到 BSCAN 上，比较麻烦。Channel B 和 C 是串口，Channel D 是连接 VCU128 上的 System Controller 的。之前的时候，都是直接用 Channel B 做串口，然后突发奇想：注意到这里是 4-wire UART，说明连接到 FPGA 是四条线，那是不是也可以拿来当 JTAG 用？</p>
<p>查询了一下 FT4232H 的文档，发现它的 Channel A 和 Channel B 是支持 MPSSE 模式的，在 MPSSE 模式下，可以当成 JTAG 使用：</p>
<table>
<thead>
<tr>
<th>Signal</th>
<th>Channel A</th>
<th>Channel B</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCK</td>
<td>12</td>
<td>22</td>
</tr>
<tr>
<td>TDI</td>
<td>13</td>
<td>23</td>
</tr>
<tr>
<td>TDO</td>
<td>14</td>
<td>24</td>
</tr>
<tr>
<td>TMS</td>
<td>15</td>
<td>25</td>
</tr>
</tbody>
</table>
<p>对照 VCU128 的 Schematic 看，虽然引脚的编号不大一样，可以发现，Channel A 和 B 分别对应了 ADBUS0-4 和 BDBUS 0-4，对应到 schematic 上的名字是：</p>
<ul>
<li>ADBUS0 - FT4232_TCK</li>
<li>ADBUS1 - FT4232_TDI</li>
<li>ADBUS2 - FMCP_HSPC_TDO</li>
<li>ADBUS3 - FT4232_TMS</li>
</ul>
<p>这一组是直接连到 FPGA 上专用的 JTAG 引脚，其中 TDO 是连接了额外的逻辑，可以把 FMC 接口上的 JTAG 连接成 daisy chain。</p>
<ul>
<li>ADBUS0 - FTDI_UART0_TXD_LS - UART0_RXD - BP26 -&gt; TCK</li>
<li>ADBUS1 - FTDI_UART0_RXD_LS - UART0_TXD - BN26 -&gt; TDI</li>
<li>ADBUS2 - FTDI_UART0_RTS_B_LS - UART0_RTS_B - BP22 -&gt; TDO</li>
<li>ADBUS3 - FTDI_UART0_CTS_B_LS - UART0_CTS_B - BP23 -&gt; TMS</li>
</ul>
<p>这里的 RXD/TXD 名字交换也是很容易看错，要小心，只要记住 FT4232H 要求的顺序一定是 TCK-TDI-TDO-TMS 即可。对应到 vivado 内的 xdc 就是这么写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BN26<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP22<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-0-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nv">set_property</span><span class="w"> </span><span class="o">-</span>dict<span class="w"> </span><span class="k">{</span><span class="nv">PACKAGE_PIN</span><span class="w"> </span>BP23<span class="w"> </span>IOSTANDARD<span class="w"> </span>LVCMOS18<span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span></code></pre></div>
<p>接下来，我们要把 Rocket Chip 的 JTAG 信号接出来。</p>
<h3 id="rocket-chip-jtag"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#rocket-chip-jtag">配置 Rocket Chip 的 JTAG</a></h3>
<p>配置 Rocket Chip 的 JTAG，大概需要如下几步：</p>
<ol>
<li>给 Config 加上 WithJtagDTM，以 JTAG 作为 DTM 模块</li>
<li>给 Subsystem 加上 HasPeripheryDebug</li>
<li>给 SubsystemModuleImp 加上 HasPeripheryDebugModuleImp</li>
<li>把 JTAG 信号连到自己的顶层模块上</li>
</ol>
<p>最后一步的相关代码，首先，按照 spec 要求，把 DM 输出的 ndreset 信号连到整个 Rocket 的 reset 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// ndreset can reset all harts</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">ndreset</span><span class="p">).</span><span class="n">getOrElse</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">target</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span>
</span></code></pre></div>
<p>接着，把 JTAG 的信号连到顶层：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">systemJtag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">get</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="n">io</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">systemJtag</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span>
</span></code></pre></div>
<p>除了 JTAG 信号以外，还需要配置 IDCODE 相关的变量：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeManufId</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodePartNum</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">JtagDTMKey</span><span class="p">).</span><span class="n">idcodeVersion</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span></code></pre></div>
<p>最后这一部分比较关键：首先，JTAG 部分的 reset 是独立于其余部分的，这里简单期间就连到了外部的 reset，其实可以改成 FPGA program 的时候进行 reset，然后等时钟来了就释放，实现方法可以参考文末的链接。resetctrl 是给 DM 知道哪些核心被 reset 了，最后是调用 rocket chip 自带的函数。这里踩的一个坑是，传给 systemJtag.reset 一定得是异步的，因为这个时钟域的时钟都是 jtag 的 TCK 信号，所以很可能错过一开始的 reset 信号，所以这里要用异步的 reset。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// MUST use async reset here</span>
</span><span id="__span-4-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">// otherwise the internal logic(e.g. TLXbar) might not function</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">// if reset deasserted before TCK rises</span>
</span><span id="__span-4-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="n">systemJtag</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span><span class="p">.</span><span class="n">asAsyncReset</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">target</span><span class="p">.</span><span class="n">resetctrl</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">rc</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-4-6"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="n">rc</span><span class="p">.</span><span class="n">hartIsInReset</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">childReset</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-4-7"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="p">}</span>
</span><span id="__span-4-8"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="nc">Debug</span><span class="p">.</span><span class="n">connectDebugClockAndReset</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="jtag_1"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#jtag_1">配置 JTAG 相关的约束</a></h3>
<p>这部分是参考了 pulp 的 VCU118 中 jtag 信号的约束文件。照着抄就行：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nv">create_clock</span><span class="w"> </span><span class="o">-</span>period<span class="w"> </span><span class="mf">100.000</span><span class="w"> </span><span class="o">-</span>name<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TCK<span class="k">]</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nv">set_input_jitter</span><span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">1.000</span>
</span><span id="__span-5-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="nv">set_property</span><span class="w"> </span>CLOCK_DEDICATED_ROUTE<span class="w"> </span>FALSE<span class="w"> </span><span class="k">[</span><span class="nv">get_nets</span><span class="w"> </span>jtag_TCK_IBUF_inst<span class="o">/</span>O<span class="k">]</span>
</span><span id="__span-5-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span>
</span><span id="__span-5-5"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="nv">set_input_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="o">-</span>clock_fall<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span>
</span><span id="__span-5-6"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="nv">set_output_delay</span><span class="w"> </span><span class="o">-</span>clock<span class="w"> </span>jtag_TCK<span class="w"> </span><span class="mf">5.000</span><span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span>
</span><span id="__span-5-7"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>to<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDO<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-8"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TMS<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-9"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="nv">set_max_delay</span><span class="w"> </span><span class="o">-</span>from<span class="w"> </span><span class="k">[</span><span class="nv">get_ports</span><span class="w"> </span>jtag_TDI<span class="k">]</span><span class="w"> </span><span class="mf">20.000</span>
</span><span id="__span-5-10"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="nv">set_clock_groups</span><span class="w"> </span><span class="o">-</span>asynchronous<span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span>jtag_TCK<span class="k">]</span><span class="w"> </span><span class="o">-</span>group<span class="w"> </span><span class="k">[</span><span class="nv">get_clocks</span><span class="w"> </span><span class="o">-</span>of_objects<span class="w"> </span><span class="k">[</span><span class="nv">get_pins</span><span class="w"> </span>system_i<span class="o">/</span>clk_wiz_0<span class="o">/</span>inst<span class="o">/</span>mmcme4_adv_inst<span class="o">/</span>CLKOUT1<span class="k">]]</span>
</span><span id="__span-5-11"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="nv">set_property</span><span class="w"> </span>ASYNC_REG<span class="w"> </span>TRUE<span class="w"> </span><span class="k">[</span><span class="nv">get_cells</span><span class="w"> </span><span class="o">-</span>hier<span class="w"> </span><span class="o">-</span>regexp<span class="w"> </span><span class="s2">"system_i/rocketchip_wrapper_0/.*/cdc_reg_reg.*"</span><span class="k">]</span>
</span></code></pre></div>
<p>和原版本稍微改了一下，一个区别是 <code>set_clock_groups</code> 的时候，第二个时钟参数用的是 Clocking Wizard 的输出，同时也是 Rocket Chip 自己的时钟输入；另一个区别是用的 ASYNC_REG 查询语句不大一样。我没有具体分析过这些约束为什么这么写，不确定这些约束是否都合理，是否都是需要的，没有测试过不带这些约束会不会出问题。</p>
<h3 id="openocd-gdb"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#openocd-gdb">运行 OpenOCD 和 GDB</a></h3>
<p>最后，采用如下的 OpenOCD 配置来连接：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c">## openocd config</span>
</span><span id="__span-6-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="c">## use ftdi channel 1</span>
</span><span id="__span-6-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c">## vcu128 uart0 as jtag</span>
</span><span id="__span-6-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">10000</span>
</span><span id="__span-6-5"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-6-6"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>FT4232H
</span><span id="__span-6-7"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>Output:<span class="w"> </span>TCK<span class="w"> </span>TDI<span class="w"> </span>TMS
</span><span id="__span-6-8"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-6-9"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>channel<span class="w"> </span>B
</span><span id="__span-6-10"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-6-11"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>
</span><span id="__span-6-12"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-6-13"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span>
</span><span id="__span-6-14"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>
</span><span id="__span-6-15"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-6-16"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>
</span><span id="__span-6-17"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-6-18"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w"> </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span></code></pre></div>
<p>然后就可以连接到 Rocket Chip 上：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>&gt;<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-7-2"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0-rc2
</span><span id="__span-7-3"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-7-4"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-7-5"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-7-6"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">"jtag"</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">'transport select &lt;transport&gt;'</span>.
</span><span id="__span-7-7"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-7-8"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-7-9"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-7-10"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x10000913<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x489<span class="w"> </span><span class="o">(</span>SiFive<span class="w"> </span>Inc<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x1<span class="o">)</span>
</span><span id="__span-7-11"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">16</span>
</span><span id="__span-7-12"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Disabling<span class="w"> </span>abstract<span class="w"> </span><span class="nb">command</span><span class="w"> </span>reads<span class="w"> </span>from<span class="w"> </span>CSRs.
</span><span id="__span-7-13"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-7-14"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">64</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x800000000094112d
</span><span id="__span-7-15"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-7-16"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-7-17"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>&gt;<span class="w"> </span>riscv64-unknown-elf-gdb
</span><span id="__span-7-18"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>target<span class="w"> </span>remote<span class="w"> </span>localhost:3333
</span><span id="__span-7-19"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>Remote<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>localhost:3333
</span><span id="__span-7-20"><a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>0x00000000800001a4<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span>
</span></code></pre></div>
<p>可以看到调试功能都正常了。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_2">总结</a></h3>
<p>调试这个功能大概花了一天的时间，主要遇到了下面这些问题：</p>
<ol>
<li>调试模块的 reset 信号需要是异步的，这个是通过仿真（Remote Bitbang 连接 OpenOCD）调试出来的</li>
<li>看 schematic 的时候 rxd/txd 搞反了，后来仔细对比才找到了正确的对应关系</li>
<li>OpenOCD 配置的 irlen 一开始写的不对，dmcontrol 读出来是 0，一直以为是有别的问题，结果改了 irlen 后立马就成功了，这个问题可以让 OpenOCD 自动推断 irlen 来发现</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/09/rocket-chip-jtag-debug/#_3">参考</a></h3>
<ul>
<li><a href="https://www.xilinx.com/support/documentation/boards_and_kits/vcu128/ug1302-vcu128-eval-bd.pdf">VCU128 User Guide</a></li>
<li><a href="https://ftdichip.com/wp-content/uploads/2020/08/DS_FT4232H.pdf">FT4232H</a></li>
<li><a href="https://github.com/sequencer/rocket-doc/blob/e55f7af549c5859b3c8f5a52c81c4c802153ed60/sanitytests/vcu118/src/DesignKeyWrapper.scala">DesignKeyWrapper from 中国 Chisel 之父 @sequencer</a></li>
<li><a href="https://github.com/pulp-platform/pulp/blob/770b4e1d69baf7daceaadcb301ba7212a4310577/fpga/pulp-vcu118/constraints/vcu118.xdc">pulp VCU118 constraints</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/03/09/rocket-chip-jtag-debug/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-02-22 00:00:00">2022年2月22日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="k3s-traefik-x-forwarded-for"><a class="toclink" href="../../devops/2022/02/22/k3s-traefik-client-ip/">解决 k3s 中 traefik 不会转发 X-Forwarded-For 等头部的问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/02/22/k3s-traefik-client-ip/#_1">背景</a></h3>
<p>把应用迁移到 k3s 中，然后用了 traefik 作为 Ingress Controller，发现无法获得真实的用户 IP 地址，而是 cni 内部的地址。搜索了一番，找到了靠谱的解决方案：</p>
<p><a href="https://medium.com/@_jonas/traefik-kubernetes-ingresse-x-forwarded-headers-82194d319b0e">Traefik Kubernetes Ingress and X-Forwarded-Headers</a></p>
<p>具体来说，需要给 traefik 传额外的参数，方法是在 k3s 的配置目录下，添加一个 HelmChartConfig：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">## edit /var/lib/rancher/k3s/server/manifests/traefik-config.yaml</span>
</span><span id="__span-0-2"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1">## content:</span>
</span><span id="__span-0-3"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>apiVersion:<span class="w"> </span>helm.cattle.io/v1
</span><span id="__span-0-4"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>kind:<span class="w"> </span>HelmChartConfig
</span><span id="__span-0-5"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>metadata:
</span><span id="__span-0-6"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span>name:<span class="w"> </span>traefik
</span><span id="__span-0-7"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span>namespace:<span class="w"> </span>kube-system
</span><span id="__span-0-8"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>spec:
</span><span id="__span-0-9"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span>valuesContent:<span class="w"> </span><span class="p">|</span>-
</span><span id="__span-0-10"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span>additionalArguments:
</span><span id="__span-0-11"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">"--entryPoints.web.proxyProtocol.insecure"</span>
</span><span id="__span-0-12"><a href="../../devops/2022/02/22/k3s-traefik-client-ip/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">      </span>-<span class="w"> </span><span class="s2">"--entryPoints.web.forwardedHeaders.insecure"</span>
</span></code></pre></div>
<p>这样相当于让 traefik 信任前一级代理传过来的这些头部。更精细的话，还可以设置信任的 IP 地址范围，不过如果 traefik 不会直接暴露出去，就不用考虑这个问题了。</p>
<nav class="md-post__action">
<a href="../../devops/2022/02/22/k3s-traefik-client-ip/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-30 00:00:00">2022年1月30日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/os/">os</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="m1-windows-arm"><a class="toclink" href="../../os/2022/01/30/windows-on-arm-on-m1/">在 M1 上运行 Windows ARM 虚拟机</a></h2>
<p>目前 Windows ARM 出了预览版，可以从 <a href="https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewARM64">Windows Insider Preview Downloads</a> 下载，得到一个 9.5GB 的 vhdx 文件。</p>
<p>接着，用 qemu-img 转换为 vmdk 格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>convert<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vhdx<span class="w"> </span>-O<span class="w"> </span>vmdk<span class="w"> </span>-o<span class="w"> </span><span class="nv">adapter_type</span><span class="o">=</span>lsilogic<span class="w"> </span>Windows11_InsiderPreview_Client_ARM64_en-us_22533.vmdk
</span></code></pre></div>
<p>转换后，在 VMWare Fusion for Apple Silicon Tech Preview 中，选择从已有的 vmdk 中创建虚拟机，启动前修改一些设置，特别是内存，默认 256MB 肯定不够，默认单核 CPU 也太少了一些。内存不足可能导致安装失败，记住要第一次启动前设置。</p>
<p>启动以后会无法访问网络，按照下面网页里的方法设置网络：</p>
<p>https://www.gerjon.com/vmware/vmware-fusion-on-apple-silicion-m1/</p>
<p>需要注意的是，bcdedit 选项填的 IP 地址一般是 bridge 上的地址，比如 bridge101 的地址。</p>
<p>然后就可以正常工作了！</p>
<p>在 <a href="https://communities.vmware.com/t5/Fusion-for-Apple-Silicon-Tech/Vmware-Fusion-Apple-Silicon-Support-Windows/m-p/2868331">VMWare 论坛里</a>，还谈到了下面几个问题的解决方法：</p>
<p>为了让声音工作，可以修改 vmx 文件，设置 guestOS：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>guestOS = "arm-windows11-64"
</span></code></pre></div>
<p>这样声音就可以正常播放了。</p>
<p>分辨率的问题，可以用 RDP 来解决：首先在虚拟机里打开 Remote Desktop，然后用 macOS 的 Microsoft Remote Desktop Beta 访问即可。</p>
<p>系统里没有 Microsoft Store，要安装的话，用命令行的 Powershell 执行下面的命令：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>wsreset.exe -i
</span></code></pre></div>
<p>这个方法见 <a href="https://kb.parallels.com/128520">Parallels Desktop KB128520</a>。</p>
<p>UPDATE:</p>
<p>VMware Fusion 发布了新版本 <a href="https://blogs.vmware.com/teamfusion/2022/07/just-released-vmware-fusion-22h2-tech-preview.html">22H2</a>，有官方的 Windows 11 on ARM 支持了：</p>
<ul>
<li>Windows 11 on Intel and Apple Silicon with 2D GFX and Networking</li>
<li>VMtools installation for Windows 11 GOS on M1</li>
<li>Improved Linux support on M1</li>
<li>3D Graphics HW Acceleration and OpenGL 4.3 in Linux VMs* (Requires Linux 5.19+ &amp; Mesa 22.1.3+)</li>
<li>Virtual TPM Device</li>
<li>Fast Encryption</li>
<li>Universal Binary</li>
</ul>
<p>并且不需要上面写的网卡的 workaround 了：</p>
<div class="language-text highlight"><pre><span></span><code>vmxnet3 Networking Drivers for Windows on ARM

While Windows does not yet ship with our vmxnet3 networking driver for
Windows on ARM as it now does for Intel, the VMware Tools ISO on ARM
contains the 2 currently supported drivers for graphics and networking.
</code></pre></div>
<p>实测安装 VMware Tools 以后，就可以成功用 vmxnet3 网卡上网了，不需要之前的 bcdedit 方案。</p>
<p>但是目前测试 Linux 虚拟机有一些问题，一些内核版本在启动的时候 vmwgfx 驱动会报错，不能正常显示，但是系统是正常启动的，可以通过 SSH 访问。我测试的情况见下：</p>
<p>Linux 5.19.6(5.19.0-1-arm64): 可以正常启动和显示，但是没有 3D 加速（按照 VMware 的说法是需要 5.19 内核 + Mesa 22.1.1 以上，但是我的环境版本已经符合了这个要求，可能是 Debian 打包缺了什么东西）；</p>
<p>UPDATE（2022-09-27）：更新了一下系统，现在 <code>glxinfo</code> 可以看到 SVGA 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>Device: SVGA3D; build: RELEASE; LLVM; (0x406)
</span><span id="__span-3-2"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Version: 22.2.0
</span><span id="__span-3-3"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>Accelerated: no
</span></code></pre></div>
<p>但是显示有一些 BUG，刷新不正常。</p>
<p>Linux 5.18(5.18.0-0.bpo.1-arm64): <code>VMware Fusion has encountered an error and has shut down the virtual machine</code></p>
<p>Linux 5.16(5.16.0-0.bpo.4-arm64): SSH 也没启动，看不到内核日志</p>
<p>Linux 5.15.15(5.15.0-0.bpo.3-arm64):</p>
<p>图形界面起不来，可以通过 SSH 访问。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>[   10.765945] kernel BUG at drivers/gpu/drm/vmwgfx/vmwgfx_drv.h:1627!
</span><span id="__span-4-2"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>[   10.766206] Call trace:
</span><span id="__span-4-3"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>[   10.766207]  vmw_event_fence_action_queue+0x328/0x330 [vmwgfx]
</span><span id="__span-4-4"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>[   10.766210]  vmw_stdu_primary_plane_atomic_update+0xd8/0x220 [vmwgfx]
</span><span id="__span-4-5"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>[   10.766214]  drm_atomic_helper_commit_planes+0xf8/0x21c [drm_kms_helper]
</span><span id="__span-4-6"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>[   10.766222]  drm_atomic_helper_commit_tail+0x5c/0xb0 [drm_kms_helper]
</span><span id="__span-4-7"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>[   10.766225]  commit_tail+0x160/0x190 [drm_kms_helper]
</span><span id="__span-4-8"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>[   10.766227]  drm_atomic_helper_commit+0x16c/0x400 [drm_kms_helper]
</span><span id="__span-4-9"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>[   10.766230]  drm_atomic_commit+0x58/0x6c [drm]
</span><span id="__span-4-10"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>[   10.766242]  drm_atomic_helper_set_config+0xe0/0x120 [drm_kms_helper]
</span><span id="__span-4-11"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>[   10.766245]  drm_mode_setcrtc+0x1ac/0x680 [drm]
</span><span id="__span-4-12"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>[   10.766249]  drm_ioctl_kernel+0xd0/0x120 [drm]
</span><span id="__span-4-13"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>[   10.766253]  drm_ioctl+0x250/0x460 [drm]
</span><span id="__span-4-14"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>[   10.766257]  vmw_generic_ioctl+0xbc/0x160 [vmwgfx]
</span><span id="__span-4-15"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>[   10.766261]  vmw_unlocked_ioctl+0x24/0x30 [vmwgfx]
</span><span id="__span-4-16"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>[   10.766264]  __arm64_sys_ioctl+0xb4/0x100
</span><span id="__span-4-17"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>[   10.766287]  invoke_syscall+0x50/0x120
</span><span id="__span-4-18"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>[   10.766300]  el0_svc_common.constprop.0+0x4c/0xf4
</span><span id="__span-4-19"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>[   10.766302]  do_el0_svc+0x30/0x9c
</span><span id="__span-4-20"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>[   10.766303]  el0_svc+0x28/0xb0
</span><span id="__span-4-21"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>[   10.766327]  el0t_64_sync_handler+0x1a4/0x1b0
</span><span id="__span-4-22"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>[   10.766328]  el0t_64_sync+0x1a0/0x1a4
</span></code></pre></div>
<p>回收硬盘空间：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../os/2022/01/30/windows-on-arm-on-m1/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>sudo<span class="w"> </span>vmware-toolbox-cmd<span class="w"> </span>disk<span class="w"> </span>shrink<span class="w"> </span>/
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../os/2022/01/30/windows-on-arm-on-m1/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-25 00:00:00">2022年1月25日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="risc-v-vector-10"><a class="toclink" href="../../software/2022/01/25/rvv-1.0-toolchain/">RISC-V Vector 1.0 工具链构建</a></h2>
<p>不久前 RVV 1.0 标准终于是出来了，但是工具链的支持目前基本还处于刚 upstream 还没有 release 的状态。而目前 RVV 1.0 的支持主要在 LLVM 上比较活跃，因此也是采用 LLVM Clang + GCC Newlib Toolchain 的方式进行配合，前者做 RVV 1.0 的编译，后者提供 libc 等基础库。</p>
<p>UPDATE: LLVM 14 已经发布，这个版本已经支持 RVV 1.0，直接从 https://apt.llvm.org 等地安装 LLVM 14 即可。</p>
<p>LLVM Clang 直接采用 upstream 即可。编译选项：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>cmake<span class="w"> </span>-G<span class="w"> </span>Ninja<span class="w"> </span>../llvm<span class="w"> </span>-DCMAKE_C_COMPILER<span class="o">=</span>clang<span class="w"> </span>-DCMAKE_CXX_COMPILER<span class="o">=</span>clang++<span class="w"> </span>-DCMAKE_INSTALL_PREFIX<span class="o">=</span>/prefix/llvm<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span>Release<span class="w"> </span>-DLLVM_ENABLE_PROJECTS<span class="o">=</span><span class="s2">"clang"</span><span class="w"> </span>-DLLVM_TARGETS_TO_BUILD<span class="o">=</span><span class="s2">"RISCV"</span>
</span><span id="__span-0-2"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>ninja
</span><span id="__span-0-3"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span>ninja<span class="w"> </span>install
</span><span id="__span-0-4"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>$<span class="w"> </span>/prefix/llvm/bin/clang<span class="w"> </span>--version
</span><span id="__span-0-5"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>clang<span class="w"> </span>version<span class="w"> </span><span class="m">14</span>.0.0<span class="w"> </span><span class="o">(</span>https://github.com/llvm/llvm-project.git<span class="w"> </span>8d298355ca3778a47fd6b3110aeee03ea5e8e02b<span class="o">)</span>
</span><span id="__span-0-6"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>Target:<span class="w"> </span>x86_64-unknown-linux-gnu
</span><span id="__span-0-7"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>Thread<span class="w"> </span>model:<span class="w"> </span>posix
</span><span id="__span-0-8"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>InstalledDir:<span class="w"> </span>/data/llvm/bin
</span></code></pre></div>
<p>还需要配合一个 GCC 工具链才可以完整地工作。可以直接采用 riscv-gnu-toolchain nightly 版本，比如 <a href="https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2022.01.17/riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz">riscv64-elf-ubuntu-20.04-nightly-2022.01.17-nightly.tar.gz</a>。下载以后解压，得到 riscv 目录，GCC 版本是比较新的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-gcc<span class="w"> </span>--version
</span><span id="__span-1-2"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>riscv64-unknown-elf-gcc<span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span><span class="m">11</span>.1.0
</span><span id="__span-1-3"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2021</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-1-4"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>copying<span class="w"> </span>conditions.<span class="w">  </span>There<span class="w"> </span>is<span class="w"> </span>NO
</span><span id="__span-1-5"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>warranty<span class="p">;</span><span class="w"> </span>not<span class="w"> </span>even<span class="w"> </span><span class="k">for</span><span class="w"> </span>MERCHANTABILITY<span class="w"> </span>or<span class="w"> </span>FITNESS<span class="w"> </span>FOR<span class="w"> </span>A<span class="w"> </span>PARTICULAR<span class="w"> </span>PURPOSE.
</span></code></pre></div>
<p>但是如果编译 C++ 程序，链接的时候就会报错：<code>prefixed ISA extension must separate with _</code>，这是因为 riscv-gnu-toolchain 仓库的 binutils 版本不够新，在 upstream 的 binutils 里面已经修复了这个问题。所以 clone 下来，然后编译，覆盖掉 riscv-gnu-toolchain 里面的 binutils：</p>
<p>UPDATE: binutils 2.38 已经发布，用这个版本即可。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>../configure<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>--prefix<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>--disable-gdb<span class="w"> </span>--disable-sim<span class="w"> </span>--disable-libdecnumber<span class="w"> </span>--disable-readline
</span><span id="__span-2-2"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>$<span class="w"> </span>make
</span><span id="__span-2-3"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>$<span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-2-4"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>$<span class="w"> </span>~/riscv/bin/riscv64-unknown-elf-ld<span class="w"> </span>--version
</span><span id="__span-2-5"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.38.50.20220125
</span><span id="__span-2-6"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2022</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
</span><span id="__span-2-7"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>This<span class="w"> </span>program<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software<span class="p">;</span><span class="w"> </span>you<span class="w"> </span>may<span class="w"> </span>redistribute<span class="w"> </span>it<span class="w"> </span>under<span class="w"> </span>the<span class="w"> </span>terms<span class="w"> </span>of
</span><span id="__span-2-8"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>the<span class="w"> </span>GNU<span class="w"> </span>General<span class="w"> </span>Public<span class="w"> </span>License<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span><span class="o">(</span>at<span class="w"> </span>your<span class="w"> </span>option<span class="o">)</span><span class="w"> </span>a<span class="w"> </span>later<span class="w"> </span>version.
</span><span id="__span-2-9"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>This<span class="w"> </span>program<span class="w"> </span>has<span class="w"> </span>absolutely<span class="w"> </span>no<span class="w"> </span>warranty.
</span></code></pre></div>
<p>然后编译程序的时候，使用 clang，配置参数 <code>--gcc-toolchain=~/riscv</code> 即可让 clang 找到 GNU 工具链。这样就可以编译出来 RVV 1.0 的程序了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>/llvm/bin/clang<span class="w"> </span>--target<span class="o">=</span>riscv64-unknown-elf<span class="w"> </span>-O2<span class="w"> </span>-march<span class="o">=</span>rv64gcv1p0<span class="w"> </span>-menable-experimental-extensions<span class="w"> </span>-mllvm<span class="w"> </span>--riscv-v-vector-bits-min<span class="o">=</span><span class="m">256</span><span class="w"> </span>--gcc-toolchain<span class="o">=</span><span class="nv">$HOME</span>/riscv<span class="w"> </span>add.cpp<span class="w"> </span>-o<span class="w"> </span>add
</span><span id="__span-3-2"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>$<span class="w"> </span>/data/llvm/bin/llvm-objdump<span class="w"> </span>--mattr<span class="o">=</span>+v<span class="w"> </span>-S<span class="w"> </span>add
</span><span id="__span-3-3"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">   </span>1020e:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="m">04</span><span class="w"> </span>c5<span class="w">   </span>vsetivli<span class="w">        </span>zero,<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>e32,<span class="w"> </span>m1,<span class="w"> </span>ta,<span class="w"> </span>mu
</span><span id="__span-3-4"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">   </span><span class="m">10212</span>:<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>t1<span class="o">)</span>
</span><span id="__span-3-5"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">   </span><span class="m">10216</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span>e4<span class="w"> </span><span class="m">03</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>t2<span class="o">)</span>
</span><span id="__span-3-6"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">   </span>1021a:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">07</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a4,<span class="w"> </span>-32
</span><span id="__span-3-7"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">   </span>1021e:<span class="w"> </span><span class="m">07</span><span class="w"> </span>e5<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v10,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-3-8"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">   </span><span class="m">10222</span>:<span class="w"> </span><span class="m">87</span><span class="w"> </span><span class="m">65</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vle32.v<span class="w"> </span>v11,<span class="w"> </span><span class="o">(</span>a4<span class="o">)</span>
</span><span id="__span-3-9"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">   </span><span class="m">10226</span>:<span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">85</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v8,<span class="w"> </span>v8,<span class="w"> </span>v10
</span><span id="__span-3-10"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">   </span>1022a:<span class="w"> </span>d7<span class="w"> </span><span class="m">94</span><span class="w"> </span><span class="m">95</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vfadd.vv<span class="w">        </span>v9,<span class="w"> </span>v9,<span class="w"> </span>v11
</span><span id="__span-3-11"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">   </span>1022e:<span class="w"> </span><span class="m">93</span><span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">05</span><span class="w"> </span>fe<span class="w">   </span>addi<span class="w">    </span>a5,<span class="w"> </span>a0,<span class="w"> </span>-32
</span><span id="__span-3-12"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">   </span><span class="m">10232</span>:<span class="w"> </span><span class="m">27</span><span class="w"> </span>e4<span class="w"> </span><span class="m">07</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v8,<span class="w"> </span><span class="o">(</span>a5<span class="o">)</span>
</span><span id="__span-3-13"><a href="../../software/2022/01/25/rvv-1.0-toolchain/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">   </span><span class="m">10236</span>:<span class="w"> </span>a7<span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="m">05</span><span class="w"> </span><span class="m">02</span><span class="w">   </span>vse32.v<span class="w"> </span>v9,<span class="w"> </span><span class="o">(</span>a0<span class="o">)</span>
</span></code></pre></div>
<p>可以看到 llvm 的自动向量化是工作的。此外，也可以编写 rvv intrinsic。</p>
<nav class="md-post__action">
<a href="../../software/2022/01/25/rvv-1.0-toolchain/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-12 00:00:00">2022年1月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="jiegech"><a class="toclink" href="../../misc/2022/01/12/deprecating-jiege-ch/">jiege.ch 停用</a></h2>
<p>jiege.ch 域名不再续费，之后一直继续用 jia.je 这个域名。</p>
<nav class="md-post__action">
<a href="../../misc/2022/01/12/deprecating-jiege-ch/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-05 00:00:00">2022年1月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rocket-chip-diplomacy"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/">分析 Rocket Chip 中 Diplomacy 系统</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#_1">概念</a></h3>
<p>Diplomacy 主要实现了两个功能：</p>
<ol>
<li>把整个总线结构在代码中表现出来</li>
<li>自动配置总线中各个端口的参数</li>
</ol>
<p>具体来说，第一点实现了类似 Vivado Board Design 中连线的功能，第二点则是保证总线两端的参数一致，可以连接起来。</p>
<p>Diplomacy 为了表示总线的结构，每个模块可以对应一个 Node，Node 和 Node 之间连接形成一个图。Node 的类型主要有以下几个：</p>
<ol>
<li>Client：对应 AXI 里面的 Master，发起请求</li>
<li>Manager：对应 AXI 里面的 Slave，处理请求</li>
<li>Adapter：对应 AXI Width Converter/Clock Converter/AXI4 to AXI3/AXI4 to AHB bridge 等，会修改 AXI 的参数，然后每个输入对应一个输出</li>
<li>Nexus：对应 AXI Crossbar，多个输入和多个输出</li>
</ol>
<p>每个 Node 可能作为 Manager 连接上游的 Client，这个叫做入边（Inward Edge）；同样地，也可以作为 Client 连接下游的 Manager，这个是出边（Outward Edge）。想象成一个 DAG，从若干个 Client 流向 Manager。</p>
<p>连接方式采用的是 <code>:=</code> <code>:=*</code> <code>:*=</code> <code>:*=*</code> 操作符，左侧是 Client，右侧是 Manager。</p>
<h3 id="rocket-chip"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#rocket-chip">Rocket Chip 总线结构</a></h3>
<p>Rocket Chip 主要有以下几个总线：</p>
<ol>
<li>sbus: System Bus</li>
<li>mbus: Memory Bus</li>
<li>cbus: Control Bus</li>
<li>pbus: Periphery Bus</li>
<li>fbus: Frontend Bus</li>
</ol>
<p>图示可以见参考文档中的链接，不过链接中的结构和实际的有一些区别。目前的 Rocket Chip 内存结构大致是这样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>fbus -&gt; sbus -&gt; mbus
</span><span id="__span-0-2"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>tile --/    \-&gt; cbus -&gt; pbus
</span></code></pre></div>
<p>主要是 pbus 的位置从连接 sbus 移动到了连接 cbus。</p>
<p>相关代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cm">/** Parameterization of a topology containing three additional, optional buses for attaching MMIO devices. */</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalBusTopologyParams</span><span class="p">(</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="n">pbus</span><span class="p">:</span><span class="w"> </span><span class="nc">PeripheryBusParams</span><span class="p">,</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="n">fbus</span><span class="p">:</span><span class="w"> </span><span class="nc">FrontBusParams</span><span class="p">,</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="n">cbus</span><span class="p">:</span><span class="w"> </span><span class="nc">PeripheryBusParams</span><span class="p">,</span>
</span><span id="__span-1-6"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="n">xTypes</span><span class="p">:</span><span class="w"> </span><span class="nc">SubsystemCrossingParams</span><span class="p">,</span>
</span><span id="__span-1-7"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="n">driveClocksFromSBus</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-1-8"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">TLBusWrapperTopology</span><span class="p">(</span>
</span><span id="__span-1-9"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="n">instantiations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-1-10"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="p">(</span><span class="nc">PBUS</span><span class="p">,</span><span class="w"> </span><span class="n">pbus</span><span class="p">),</span>
</span><span id="__span-1-11"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="p">(</span><span class="nc">FBUS</span><span class="p">,</span><span class="w"> </span><span class="n">fbus</span><span class="p">),</span>
</span><span id="__span-1-12"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="p">(</span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="n">cbus</span><span class="p">)),</span>
</span><span id="__span-1-13"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-1-14"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="p">(</span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="w">  </span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">sbusToCbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)),</span>
</span><span id="__span-1-15"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="p">(</span><span class="nc">CBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">PBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="w">  </span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">cbusToPbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)),</span>
</span><span id="__span-1-16"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">(</span><span class="nc">FBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">TLBusWrapperConnection</span><span class="p">.</span><span class="n">crossFrom</span><span class="p">(</span><span class="n">xTypes</span><span class="p">.</span><span class="n">fbusToSbusXType</span><span class="p">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveClocksFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">)))</span>
</span><span id="__span-1-17"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="p">)</span>
</span></code></pre></div>
<p>当然了，也有简化版的 JustOneBusTopology，那就只有 SystemBus 了。如果再配置了 CoherentBusTopology，那么 SBUS 和 MBUS 之间还有一层 L2:</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cm">/** Parameterization of a topology containing a banked coherence manager and a bus for attaching memory devices. */</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">CoherentBusTopologyParams</span><span class="p">(</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="n">sbus</span><span class="p">:</span><span class="w"> </span><span class="nc">SystemBusParams</span><span class="p">,</span><span class="w"> </span><span class="c1">// TODO remove this after better width propagation</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="n">mbus</span><span class="p">:</span><span class="w"> </span><span class="nc">MemoryBusParams</span><span class="p">,</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="n">l2</span><span class="p">:</span><span class="w"> </span><span class="nc">BankedL2Params</span><span class="p">,</span>
</span><span id="__span-2-6"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="n">sbusToMbusXType</span><span class="p">:</span><span class="w"> </span><span class="nc">ClockCrossingType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">NoCrossing</span><span class="p">,</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="n">driveMBusClockFromSBus</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-2-8"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">TLBusWrapperTopology</span><span class="p">(</span>
</span><span id="__span-2-9"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="n">instantiations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nc">Nil</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-2-10"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="p">(</span><span class="nc">MBUS</span><span class="p">,</span><span class="w"> </span><span class="n">mbus</span><span class="p">),</span>
</span><span id="__span-2-11"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="p">(</span><span class="nc">L2</span><span class="p">,</span><span class="w"> </span><span class="nc">CoherenceManagerWrapperParams</span><span class="p">(</span><span class="n">mbus</span><span class="p">.</span><span class="n">blockBytes</span><span class="p">,</span><span class="w"> </span><span class="n">mbus</span><span class="p">.</span><span class="n">beatBytes</span><span class="p">,</span><span class="w"> </span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="p">,</span><span class="w"> </span><span class="nc">L2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">sbus</span><span class="p">.</span><span class="n">dtsFrequency</span><span class="p">)(</span><span class="n">l2</span><span class="p">.</span><span class="n">coherenceManager</span><span class="p">)))),</span>
</span><span id="__span-2-12"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l2</span><span class="p">.</span><span class="n">nBanks</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nc">Nil</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">List</span><span class="p">(</span>
</span><span id="__span-2-13"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="p">(</span><span class="nc">SBUS</span><span class="p">,</span><span class="w"> </span><span class="nc">L2</span><span class="p">,</span><span class="w">   </span><span class="nc">TLBusWrapperConnection</span><span class="p">(</span><span class="n">driveClockFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="n">nodeBinding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BIND_STAR</span><span class="p">)()),</span>
</span><span id="__span-2-14"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="p">(</span><span class="nc">L2</span><span class="p">,</span><span class="w">  </span><span class="nc">MBUS</span><span class="p">,</span><span class="w">  </span><span class="nc">TLBusWrapperConnection</span><span class="p">.</span><span class="n">crossTo</span><span class="p">(</span>
</span><span id="__span-2-15"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">      </span><span class="n">xType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sbusToMbusXType</span><span class="p">,</span>
</span><span id="__span-2-16"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">      </span><span class="n">driveClockFromMaster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">driveMBusClockFromSBus</span><span class="p">)</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">None</span><span class="p">,</span>
</span><span id="__span-2-17"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">      </span><span class="n">nodeBinding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BIND_QUERY</span><span class="p">))</span>
</span><span id="__span-2-18"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-19"><a href="../../hardware/2022/01/05/diplomacy/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/01/05/diplomacy/#_2">参考文档</a></h3>
<ul>
<li><a href="https://chipyard.readthedocs.io/en/latest/TileLink-Diplomacy-Reference/index.html">TileLink and Diplomacy Reference</a></li>
<li><a href="https://chipyard.readthedocs.io/en/latest/Generators/Rocket-Chip.html#memory-system">Rocket Chip - Memory System</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/01/05/diplomacy/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-03 00:00:00">2022年1月3日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="chisel3-cookbook"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/">Chisel3 Cookbook</a></h2>
<h3 id="chisel"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#chisel">Chisel 版本选择</a></h3>
<p>尽量选择较新版本的 Chisel。Chisel v3.5 完善了编译器插件，使得生成的代码中会包括更多变量名信息。</p>
<h3 id="verilog"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#verilog">去掉输出 Verilog 文件中的寄存器随机初始化</a></h3>
<p>版本：FIRRTL &gt;= 1.5.0-RC2</p>
<p>代码：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-X"</span><span class="p">,</span><span class="w"> </span><span class="s">"verilog"</span><span class="p">,</span><span class="w"> </span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-0-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-0-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="nc">CustomDefaultRegisterEmission</span><span class="p">(</span>
</span><span id="__span-0-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">      </span><span class="n">useInitAsPreset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">      </span><span class="n">disableRandomization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-0-8"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-0-9"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-0-10"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">)</span>
</span></code></pre></div>
<p>设置 disableRandomization=true 即可。useInitAsPreset 不建议开启。</p>
<h3 id="firrtl-verilog"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#firrtl-verilog">关闭 FIRRTL 优化，输出尽可能与源代码一致的 Verilog</a></h3>
<p>设置 Chisel 生成 MinimumVerilog：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-X"</span><span class="p">,</span><span class="w"> </span><span class="s">"mverilog"</span><span class="p">,</span><span class="w"> </span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">)</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-1-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">)</span>
</span></code></pre></div>
<p>此时代码中会保留更多原始 Chisel 代码的元素。</p>
<h3 id="axi4"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#axi4">重命名 AXI4 为标准命名</a></h3>
<p>Rocket Chip 中 AXI4Bundle 直接生成的名字和标准写法不同，可以利用 Chisel3 3.5.0 的 DataView 功能进行重命名：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// https://www.chisel-lang.org/chisel3/docs/explanations/dataview.html</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// use standard names</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">addrBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">dataBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">idBits</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-8"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-9"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-10"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-11"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-12"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-13"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-14"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-15"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-16"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>
</span><span id="__span-2-17"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-18"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-19"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-20"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">((</span><span class="n">dataBits</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-21"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">WLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-22"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>
</span><span id="__span-2-23"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-24"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-25"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-26"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">BRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-27"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>
</span><span id="__span-2-28"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-29"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-30"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-31"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">addrBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-32"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-33"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-34"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-35"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-36"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-37"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-38"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-39"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>
</span><span id="__span-2-40"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-41"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-42"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">idBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-43"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">dataBits</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-44"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RRESP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-2-45"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">RLAST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
</span><span id="__span-2-46"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="p">}</span>
</span><span id="__span-2-47"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>
</span><span id="__span-2-48"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="k">object</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-49"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DataView</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">,</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">](</span>
</span><span id="__span-2-50"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">    </span><span class="n">vab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-2-51"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="nc">AXI4Bundle</span><span class="p">(</span>
</span><span id="__span-2-52"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">        </span><span class="nc">AXI4BundleParameters</span><span class="p">(</span><span class="n">vab</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span><span class="w"> </span><span class="n">vab</span><span class="p">.</span><span class="n">idBits</span><span class="p">)</span>
</span><span id="__span-2-53"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a><span class="w">      </span><span class="p">),</span>
</span><span id="__span-2-54"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">    </span><span class="c1">// AW</span>
</span><span id="__span-2-55"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-56"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-57"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-58"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-2-59"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-2-60"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-2-61"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-2-62"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-2-63"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-2-64"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-2-65"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">AWQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-2-66"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a><span class="w">    </span><span class="c1">// W</span>
</span><span id="__span-2-67"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-68"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-69"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-2-70"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WSTRB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">,</span>
</span><span id="__span-2-71"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">WLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span><span class="p">,</span>
</span><span id="__span-2-72"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a><span class="w">    </span><span class="c1">// B</span>
</span><span id="__span-2-73"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-74"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-75"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-76"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">BRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-2-77"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a><span class="w">    </span><span class="c1">// AR</span>
</span><span id="__span-2-78"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-79"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-80"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-81"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARADDR</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span id="__span-2-82"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-2-83"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARSIZE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
</span><span id="__span-2-84"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARBURST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">burst</span><span class="p">,</span>
</span><span id="__span-2-85"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARLOCK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
</span><span id="__span-2-86"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARCACHE</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cache</span><span class="p">,</span>
</span><span id="__span-2-87"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARPROT</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">prot</span><span class="p">,</span>
</span><span id="__span-2-88"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">ARQOS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">qos</span><span class="p">,</span>
</span><span id="__span-2-89"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a><span class="w">    </span><span class="c1">// R</span>
</span><span id="__span-2-90"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RREADY</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span>
</span><span id="__span-2-91"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RVALID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span>
</span><span id="__span-2-92"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RID</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-2-93"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RDATA</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="__span-2-94"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RRESP</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span>
</span><span id="__span-2-95"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a><span class="w">    </span><span class="n">_</span><span class="p">.</span><span class="nc">RLAST</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-2-96"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-97"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">axiView2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">.</span><span class="n">axiView</span><span class="p">.</span><span class="n">invert</span><span class="p">(</span><span class="n">ab</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-2-98"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span>
</span><span id="__span-2-99"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">addrBits</span><span class="p">,</span>
</span><span id="__span-2-100"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dataBits</span><span class="p">,</span>
</span><span id="__span-2-101"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="w">      </span><span class="n">ab</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">idBits</span>
</span><span id="__span-2-102"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-2-103"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-2-104"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a><span class="p">}</span>
</span><span id="__span-2-105"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a>
</span><span id="__span-2-106"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a><span class="c1">// usage</span>
</span><span id="__span-2-107"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="kd">val</span><span class="w"> </span><span class="nc">MEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">StandardAXI4BundleBundle</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
</span><span id="__span-2-108"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a><span class="nc">MEM</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">mem_axi4</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">viewAs</span><span class="p">[</span><span class="nc">StandardAXI4BundleBundle</span><span class="p">]</span>
</span></code></pre></div>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/01/03/chisel3-cookbook/#_1">给所有模块添加名称前缀</a></h3>
<p>有些时候，我们希望给所有模块添加一个名称前缀，防止可能出现的冲突。</p>
<p>在 Chisel 3 中，可以使用自定义 FIRRTL Transform 来实现这个功能。这一部分的实现参考了 <a href="https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578">chisel issue #1059</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">options</span><span class="p">.</span><span class="nc">Dependency</span>
</span><span id="__span-3-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">passes</span><span class="p">.</span><span class="nc">PassException</span>
</span><span id="__span-3-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">import</span><span class="w"> </span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">transforms</span><span class="p">.</span><span class="nc">DedupModules</span>
</span><span id="__span-3-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// adapted from https://github.com/chipsalliance/chisel3/issues/1059#issuecomment-814353578</span>
</span><span id="__span-3-8"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="cm">/** Specifies a global prefix for all module names. */</span>
</span><span id="__span-3-10"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">NoTargetAnnotation</span>
</span><span id="__span-3-11"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="cm">/** FIRRTL pass to add prefix to module names</span>
</span><span id="__span-3-13"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="cm">  */</span>
</span><span id="__span-3-14"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="k">object</span><span class="w"> </span><span class="nc">PrefixModulesPass</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Transform</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">DependencyAPIMigration</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-15"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">  </span><span class="c1">// we run after deduplication to save some work</span>
</span><span id="__span-3-16"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">prerequisites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">[</span><span class="nc">DedupModules</span><span class="p">])</span>
</span><span id="__span-3-17"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">  </span><span class="c1">// we do not invalidate the results of any prior passes</span>
</span><span id="__span-3-19"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">invalidates</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Transform</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-3-20"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>
</span><span id="__span-3-21"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">protected</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">):</span><span class="w"> </span><span class="nc">CircuitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-22"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">prefixes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">ModulePrefix</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-23"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">      </span><span class="n">a</span><span class="p">.</span><span class="n">prefix</span>
</span><span id="__span-3-24"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">    </span><span class="p">}.</span><span class="n">distinct</span>
</span><span id="__span-3-25"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="n">prefixes</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-26"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-27"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"[PrefixModulesPass] No ModulePrefix annotation found."</span><span class="p">)</span>
</span><span id="__span-3-28"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">        </span><span class="n">state</span>
</span><span id="__span-3-29"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">state</span>
</span><span id="__span-3-30"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-31"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">circuit</span><span class="p">.</span><span class="n">mapModule</span><span class="p">(</span><span class="n">onModule</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-32"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">circuit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">main</span><span class="p">))</span>
</span><span id="__span-3-33"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-34"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PassException</span><span class="p">(</span>
</span><span id="__span-3-35"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">          </span><span class="s">s"[PrefixModulesPass] found more than one prefix annotation: </span><span class="si">$</span><span class="n">other</span><span class="s">"</span>
</span><span id="__span-3-36"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">        </span><span class="p">)</span>
</span><span id="__span-3-37"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-38"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-39"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>
</span><span id="__span-3-40"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onModule</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefModule</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-3-41"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-42"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">ExtModule</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-3-43"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">mod</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Module</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-3-44"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mod</span><span class="p">.</span><span class="n">name</span>
</span><span id="__span-3-45"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onStmt</span><span class="p">(</span><span class="n">mod</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-3-46"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">        </span><span class="n">mod</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</span><span id="__span-3-47"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-48"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>
</span><span id="__span-3-49"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onStmt</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">):</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-50"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">i</span><span class="p">:</span><span class="w"> </span><span class="n">ir</span><span class="p">.</span><span class="nc">DefInstance</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">module</span><span class="p">)</span>
</span><span id="__span-3-51"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">other</span><span class="w">             </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">mapStmt</span><span class="p">(</span><span class="n">onStmt</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">))</span>
</span><span id="__span-3-52"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-53"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="p">}</span>
</span></code></pre></div>
<p>实现思路就是遍历 IR，找到所有的 Module 并改名，再把所有模块例化也做一次替换。最后在生成 Verilog 的时候添加 Annotation 即可：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">new</span><span class="w"> </span><span class="nc">ChiselStage</span><span class="p">().</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-4-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nc">Array</span><span class="p">(</span><span class="s">"-o"</span><span class="p">,</span><span class="w"> </span><span class="s">s"</span><span class="si">${</span><span class="n">name</span><span class="si">}</span><span class="s">.v"</span><span class="p">),</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nc">Seq</span><span class="p">(</span>
</span><span id="__span-4-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="nc">ChiselGeneratorAnnotation</span><span class="p">(</span><span class="n">genModule</span><span class="p">),</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nc">RunFirrtlTransformAnnotation</span><span class="p">(</span><span class="nc">Dependency</span><span class="p">(</span><span class="nc">PrefixModulesPass</span><span class="p">)),</span>
</span><span id="__span-4-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="nc">ModulePrefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</span><span id="__span-4-7"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<p>如果使用新的 MLIR FIRRTL Compiler，则可以利用 <code>sifive.enterprise.firrtl.NestedPrefixModulesAnnotation</code> annotation，让 firtool 来进行 <a href="https://github.com/llvm/circt/blob/fc6b00fd20d8a50f17a908cc681c8cf3a4d1c000/lib/Dialect/FIRRTL/Transforms/PrefixModules.cpp">prefix 操作</a>：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">package</span><span class="w"> </span><span class="n">sifive</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="k">package</span><span class="w"> </span><span class="n">enterprise</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-3"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="k">package</span><span class="w"> </span><span class="n">firrtl</span><span class="w"> </span><span class="err">{</span>
</span><span id="__span-5-4"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">      </span><span class="k">import</span><span class="w"> </span><span class="nn">_root_</span><span class="p">.</span><span class="nn">firrtl</span><span class="p">.</span><span class="nn">annotations</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-5-5"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>
</span><span id="__span-5-6"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span>
</span><span id="__span-5-7"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">,</span>
</span><span id="__span-5-8"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">          </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span>
</span><span id="__span-5-9"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">          </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span>
</span><span id="__span-5-10"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">SingleTargetAnnotation</span><span class="p">[</span><span class="nc">Target</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-11"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>
</span><span id="__span-5-12"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">):</span><span class="w"> </span><span class="nc">Annotation</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-5-13"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">          </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-5-14"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-5-15"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-16"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-17"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="p">}</span>
</span><span id="__span-5-18"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>
</span><span id="__span-5-19"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="k">object</span><span class="w"> </span><span class="nc">AddPrefix</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-20"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">Module</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-21"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="n">annotate</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ChiselAnnotation</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-22"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">toFirrtl</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-5-23"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">NestedPrefixModulesAnnotation</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">toTarget</span><span class="p">,</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="p">)</span>
</span><span id="__span-5-24"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-5-25"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-5-26"><a href="../../hardware/2022/01/03/chisel3-cookbook/#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个方法的灵感来自 @sequencer。唯一的缺点就是比较 Hack，建议 SiFive 把相关的类也开源出来用。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/01/03/chisel3-cookbook/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-01-03 00:00:00">2022年1月3日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/networking/">networking</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="linksys-e8450-openwrt-ubi"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">升级 Linksys E8450 的 OpenWRT 系统到 UBI</a></h2>
<h3 id="_1"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_1">背景</a></h3>
<p>在 <a href="https://openwrt.org/toh/linksys/e8450">OpenWRT Linksys E8450 页面</a> 中，如果要用新版的固件，需要转换到 UBI 格式的文件系统。之前用的是 non-UBI 格式的文件系统，直接在官方的分区下，覆盖掉其中一个启动分区。但是经常会报告 flash 出错，然后系统也不稳定，决定要按照文档更新到 UBI。</p>
<h3 id="_2"><a class="toclink" href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/#_2">步骤</a></h3>
<p>请注意：更换文件系统操作比较危险，请先备份好数据，并做好变砖的心理准备。本文仅记录了作者编写时可行的更新操作，不代表读者在阅读时，依然可以按照这个顺序进行，请按照 <a href="https://github.com/dangowrt/owrt-ubi-installer">https://github.com/dangowrt/owrt-ubi-installer</a> 的文档进行操作。</p>
<p>基本按照文档一步一步走。初始状态是一个 non-UBI 版本的 OpenWRT 固件：</p>
<ol>
<li>下载官方的 1.0 固件：https://downloads.linksys.com/support/assets/firmware/FW_E8450_1.0.01.101415_prod.img</li>
<li>在 luci 中，刷入官方 1.0 固件，这时候进入了官方固件的系统</li>
<li>登录官方固件网页，恢复出厂设置</li>
<li>下载 openwrt ubi recovery <a href="https://github.com/dangowrt/linksys-e8450-openwrt-installer/releases/download/v0.6.1/openwrt-mediatek-mt7622-linksys_e8450-ubi-initramfs-recovery-installer.itb">固件</a> 然后在官方固件里刷入</li>
<li>这时候进入了 recovery 固件，下载 <a href="https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">ubi 固件</a>，继续在网页里刷入</li>
<li>这时候固件就更新完成了。ssh root@192.168.1.1，然后进去安装 luci 等软件，恢复配置即可。</li>
</ol>
<nav class="md-post__action">
<a href="../../networking/2022/01/03/upgrade-e8450-openwrt-ubi/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-12-29 00:00:00">2021年12月29日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="xrdp-nvidia"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/">XRDP 和 NVIDIA 显卡兼容性问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/#_1">背景</a></h3>
<p>最近在尝试配置 XRDP，发现它在有 NVIDIA 的机器上启动远程桌面后会黑屏，查看错误信息可以看到：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>xf86OpenConsole: Cannot open virtual console 1 (Permission denied)
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../software/2021/12/29/xrdp-nvidia/#_2">解决方法</a></h3>
<p>XRDP 作者在 <a href="https://github.com/neutrinolabs/xrdp/issues/2010#issuecomment-942561105">issue #2010</a> 中提到了解决方法：</p>
<p>修改 /etc/xrdp/sesman.ini，在 <code>[Xorg]</code> 部分里加上下面的配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>param=-configdir
</span><span id="__span-1-2"><a href="../../software/2021/12/29/xrdp-nvidia/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>param=/
</span></code></pre></div>
<p>实际上就是不让 Xorg 加载 nvidia xorg 驱动，这样就绕过了问题。</p>
<nav class="md-post__action">
<a href="../../software/2021/12/29/xrdp-nvidia/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../6/">6</a> <a class="md-pagination__link" href="../7/">7</a> <span class="md-pagination__current">8</span> <a class="md-pagination__link" href="../9/">9</a> <a class="md-pagination__link" href="../10/">10</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>