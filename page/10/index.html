
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/10/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-10-05 00:00:00">2021年10月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="esxi"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/">ESXi 常用信息</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_1">常用链接</a></h3>
<ul>
<li><a href="http://blog.erben.sk/2020/02/04/how-to-check-cpu-microcode-revision-in-esxi/">检查 CPU microcode 版本</a>：</li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>vsish<span class="w"> </span>-e<span class="w"> </span>cat<span class="w"> </span>/hardware/cpu/cpuList/0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>-E<span class="w"> </span><span class="s1">'family|model|stepping|microcode|revision'</span>
</span></code></pre></div>
<ul>
<li><a href="https://kb.vmware.com/s/article/56145">ESXi 从 6.7 到 6.7U1 升级时出现版本问题</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/6_7#custom_iso">ESXi 6.7 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0#custom_iso">ESXi 7.0 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/en/web/vmware/evalcenter?p=free-esxi7">ESXi 7.0 标准版下载</a></li>
<li><a href="https://flings.vmware.com/community-networking-driver-for-esxi/comments">NUC 11 ESXi 7.0 网卡支持</a></li>
</ul>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>vib<span class="w"> </span>install<span class="w"> </span>-d<span class="w"> </span><span class="nv">$PWD</span>/Net-Community-Driver_1.2.0.0-1vmw.700.1.0.15843807_18028830.zip
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_2">离线升级方法</a></h3>
<ol>
<li>下载 Offline Bundle 文件</li>
<li>上传到 ESXi datastore 中</li>
<li>在 <code>/vmfs/volumes/</code> 里找到更新文件</li>
<li>查询 profile 列表 <code>esxcli software sources profile list -d &lt;zip&gt;</code></li>
<li>更新到 profile <code>esxcli software profile update -p &lt;profile&gt; -d &lt;zip&gt;</code></li>
</ol>
<p>ref: <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-E51C5DB6-F28E-42E8-ACA4-0EBDD11DF55D.html">Upgrade or Update a Host with Image Profiles</a></p>
<p>如果 CPU 比较旧，可能会有警告：<a href="https://kb.vmware.com/s/article/82794">Updated Plan for CPU Support Discontinuation In Future Major vSphere Releases</a>，按照信息添加参数忽略即可，ESXi 7.0 系列都是支持的，如果之后出了新的版本可能不支持。</p>
<h3 id="_3"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_3">在线升级方法</a></h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-e<span class="w"> </span><span class="nb">true</span><span class="w"> </span>-r<span class="w"> </span>httpClient
</span><span id="__span-2-2"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">## find profile name</span>
</span><span id="__span-2-3"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>sources<span class="w"> </span>profile<span class="w"> </span>list<span class="w"> </span>-d<span class="w"> </span>https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span><span id="__span-2-4"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1">## upgrade to 7.0u3 for example</span>
</span><span id="__span-2-5"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>$<span class="w"> </span>esxcli<span class="w"> </span>software<span class="w"> </span>profile<span class="w"> </span>update<span class="w"> </span>-p<span class="w"> </span>ESXi-7.0U3-18644231-standard<span class="w"> </span>-d<span class="w"> </span>https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span></code></pre></div>
<p>ref: <a href="https://docs.macstadium.com/docs/update-standalone-esxi-host-via-online-bundle">Update Standalone ESXi Host</a></p>
<h3 id="_4"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_4">防火墙</a></h3>
<p>列出所有防火墙规则：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span>list
</span></code></pre></div>
<p>允许出站 SSH：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--ruleset-id<span class="o">=</span>sshClient
</span></code></pre></div>
<p>关闭出站 SSH：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>network<span class="w"> </span>firewall<span class="w"> </span>ruleset<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--enabled<span class="o">=</span><span class="nb">false</span><span class="w"> </span>--ruleset-id<span class="o">=</span>sshClient
</span></code></pre></div>
<h3 id="nuc11i5-esxi-70"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#nuc11i5-esxi-70">NUC11i5 ESXi 7.0 安装过程</a></h3>
<ol>
<li>下载 ESXi ISO 文件，用 UNetbootin 制作安装盘</li>
<li>插入 U 盘，在 NUC 上安装 ESXi，在 81% 的时候卡住了，不管直接重启</li>
<li>用 root 无密码登录进去，然后重置网络设置</li>
<li>配置 usb 网卡，然后通过网页访问 ESXi，打开 SSH</li>
<li>下载 Fling 上面的社区网卡支持，用 esxcli 安装</li>
<li>重启以后，就可以看到 vmnic0 网卡了</li>
</ol>
<p>参考：<a href="https://www.virten.net/2020/07/solution-esxi-installation-with-usb-nic-only-fails-at-81/">Solution: ESXi Installation with USB NIC only fails at 81%</a></p>
<h3 id="_5"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_5">推荐博客</a></h3>
<p>发现以下博客有很多关于 ESXi 的内容：</p>
<ul>
<li>https://williamlam.com/</li>
<li>https://www.virten.net/</li>
</ul>
<h3 id="_6"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#_6">重要版本更新</a></h3>
<p>参考 ESXi/vCSA Release Notes：</p>
<ul>
<li>Performance improvements for AMD Zen CPUs: With ESXi 7.0 Update 2, out-of-the-box optimizations can increase AMD Zen CPU performance by up to 30% in various benchmarks. The updated ESXi scheduler takes full advantage of the AMD NUMA architecture to make the most appropriate placement decisions for virtual machines and containers. AMD Zen CPU optimizations allow a higher number of VMs or container deployments with better performance.</li>
<li>Reduced compute and I/O latency, and jitter for latency sensitive workloads: Latency sensitive workloads, such as in financial and telecom applications, can see significant performance benefit from I/O latency and jitter optimizations in ESXi 7.0 Update 2. The optimizations reduce interference and jitter sources to provide a consistent runtime environment. With ESXi 7.0 Update 2, you can also see higher speed in interrupt delivery for passthrough devices.</li>
<li>vSphere Lifecycle Manager fast upgrades: Starting with vSphere 7.0 Update 2, you can configure vSphere Lifecycle Manager to suspend virtual machines to memory instead of migrating them, powering them off, or suspending them to disk. For more information, see Configuring vSphere Lifecycle Manager for Fast Upgrades.</li>
<li>Zero downtime, zero data loss for mission critical VMs in case of Machine Check Exception (MCE) hardware failure: With vSphere 7.0 Update 3, mission critical VMs protected by VMware vSphere Fault Tolerance can achieve zero downtime, zero data loss in case of Machine Check Exception (MCE) hardware failure, because VMs fallback to the secondary VM, instead of failing. For more information, see How Fault Tolerance Works.</li>
</ul>
<h3 id="vcsa"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#vcsa">vCSA 相关常见错误</a></h3>
<ul>
<li>https://kb.vmware.com/s/article/85468 vCSA 日志分区 <code>/storage/log</code> 满，原因是访问 vmware 网站失败打印的日志太大：<code>/storage/log/vmware/analytics/analytics-runtime.log*</code>；解决方法：<code>vmon-cli -r analytics</code> 重启服务，然后删掉旧的日志。</li>
<li>https://kb.vmware.com/s/article/83070 vCSA 日志分区 <code>/storage/log</code> 满，原因是 tomcat 日志太大。</li>
<li><code>XXX Service Health Alarm</code>：尝试重启对应服务，比如 <code>vmon-cli -r perfcharts</code> 对应 <code>Performance Charts</code>，<code>vmon-cli -r vapi-endpoint</code> 对应 <code>VMWare vAPI Endpoint</code></li>
</ul>
<p>查看更新状态：<code>cat /storage/core/software-update/stage_operation</code>；更新文件下载路径：<code>/storage/updatemgr/software-update*/stage</code>。有一个包特别大：<code>wcpovf</code> 需要两个多 G。</p>
<p>CLI 更新方法：https://earlruby.org/2021/01/upgrading-vcenter-7-via-the-command-line/</p>
<h3 id="vm"><a class="toclink" href="../../devops/2021/10/05/vmware-esxi-notes/#vm">迁移虚拟机到不同 VM</a></h3>
<p>首先，unregister 原来的 VM，然后把文件移动到新的路径下。对于 Thin Provisioned Disk，需要特殊处理，否则直接复制的话，会变成 Thick Provisioned Disk，正确方法是采用 <code>vmkfstool</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>vmkfstool<span class="w"> </span>-i<span class="w"> </span><span class="s2">"old.vmdk"</span><span class="w"> </span>-d<span class="w"> </span>thin<span class="w"> </span><span class="s2">"new.vmdk"</span>
</span></code></pre></div>
<p>需要注意的是，这里的路径用的是不带 <code>-flat</code> 的 vmdk，因为这个文件记录了 metadata，而 <code>-flat.vmdk</code> 保存了实际的数据。可以用 <code>du</code> 命令看实际的硬盘占用，从而确认它确实是 Thin Provisioned。</p>
<p>如果已经在 Web UI 上复制了，你会发现无法停止复制，解决办法是：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../devops/2021/10/05/vmware-esxi-notes/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>/etc/init.d/hostd<span class="w"> </span>restart
</span></code></pre></div>
<p>这样就会重启 Web UI，不过等它恢复需要很长的时间，还要删掉 cookie。</p>
<nav class="md-post__action">
<a href="../../devops/2021/10/05/vmware-esxi-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-27 00:00:00">2021年9月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="axi-quad-spi"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">「教学」AXI Quad SPI 时序分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/spi.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#_1">背景</a></h3>
<p>之前一直没搞懂 Vivado 中 xdc 需要怎么编写，遇到一些必须要写 xdc 的时候就很头疼，不知道怎么写才可以得到正确的结果。今天分析了一下 AXI Quad SPI 的时序 xdc，终于理解了其中的含义。</p>
<h3 id="axi-quad-spi_1"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#axi-quad-spi_1">AXI Quad SPI</a></h3>
<p>AXI Quad SPI 是一个 SPI 的控制器，它支持 XIP（eXecute In Place）模式，即可以暴露一个只读 AXI Slave 接口，当接收到读请求的时候，就按照标准的 SPI Flash 命令去对应的地址进行读取，然后返回结果。由于不同厂家的 SPI Flash 支持有所不同，所以 IP 上的设置可以看到厂家的选择。</p>
<p>特别地，一个常见的需求是希望访问 Cfg（Configuration）Flash，亦即用来保存 Bitstream 的 Flash。当 FPGA 上电的时候，如果启动模式设置为 SPI Flash，FPGA 就会向 Cfg Flash 读取 Bitstream，Cfg Flash 需要连接到 FPGA 的指定引脚上，当 FPGA 初始化的时候由内部逻辑驱动，初始化完成后又要转交给用户逻辑。转交的方式就是通过 STARTUP 系列的 primitive。</p>
<p>通常，如果要连接外部的 SPI Flash，需要连接几条信号线到顶层，然后通过 xdc 把信号绑定到引脚上，然后引脚连接了一个外部的 SPI Flash。但由于 Cfg Flash 比较特殊，所以信号从 AXI Quad SPI 直接连到 STARTUP 系列的 primitive 上。如果是采用 STARTUPE2 原语的 7 系列的 FPGA，那么只有时钟会通过 STARTUPE2 pritimive 连接到 SPI Flash 上，其他数据信号还是正常通过顶层绑定；如果是采用 STARTUPE3 原语的 UltraScale 系列的 FPGA，那么时钟和数据都通过 STARTUPE3 primitive 连接到 SPI Flash。</p>
<h3 id="virtex-ultrascale"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#virtex-ultrascale">Virtex UltraScale+ 时序</a></h3>
<p>把信号连好了只是第一步，因为外设对时序要求比较复杂，如果用一个比较高直接跑，很大可能就读取到错误的数据了。很贴心的是，AXI Quad SPI 已经在生成的文件里提供了一个样例的 xdc，在文档里也有体现。在这里，我使用的设备是 Virtex Ultrascale+ 的 FPGA，其他系列的 FPGA 会有所不一样。它内容如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>##### All the delay numbers have to be provided by the user
</span><span id="__span-0-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>##### Following are the SPI device parameters
</span><span id="__span-0-4"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>##### Max Tco
</span><span id="__span-0-5"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>set tco_max 7
</span><span id="__span-0-6"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>##### Min Tco
</span><span id="__span-0-7"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>set tco_min 1
</span><span id="__span-0-8"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>##### Setup time requirement
</span><span id="__span-0-9"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>set tsu 2
</span><span id="__span-0-10"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>##### Hold time requirement
</span><span id="__span-0-11"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>set th 3
</span><span id="__span-0-12"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>######################################################################################################
</span><span id="__span-0-13"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>## STARTUPE3 primitive included inside IP for US+                                                             #
</span><span id="__span-0-14"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>######################################################################################################
</span><span id="__span-0-15"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-0-16"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-0-17"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-0-18"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-0-19"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>
</span><span id="__span-0-20"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span><span id="__span-0-21"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-0-22"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-0-23"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-0-24"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]]
</span><span id="__span-0-25"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-0-26"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span><span id="__span-0-27"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-0-28"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>我们分段来看这个 xdc 都做了什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical *axi_quad_spi_0/ext_spi_clk] [get_pins -hierarchical */CCLK] -edges {3 5 7}
</span></code></pre></div>
<p>首先，它创建了一个时钟 <code>clk_sck</code>。CCLK 是 STARTUP 输出的实际时钟，会连接到 Cfg Flash 的时钟信号上。而 AXI Quad SPI 的 ext_spi_clk 会输出到 CCLK 上，因此这里是一个生成的时钟，并且指定上下边沿的位置。<code>edges</code> 参数有三个，分别表示上升、下降和上升沿分别的位置。1 表示源时钟的第一个上升沿，2 表示源时钟的第一个下降沿，以此类推，所以 {3, 5, 7} 的意思就是频率减半，相位差半个周期。</p>
<p>接着，最主要的就是，怎么设置延迟。可以看到，代码中首先定义了一些参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>##### Max Tco
</span><span id="__span-2-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>set tco_max 7
</span><span id="__span-2-3"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>##### Min Tco
</span><span id="__span-2-4"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>set tco_min 1
</span><span id="__span-2-5"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>##### Setup time requirement
</span><span id="__span-2-6"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>set tsu 2
</span><span id="__span-2-7"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>##### Hold time requirement
</span><span id="__span-2-8"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>set th 3
</span><span id="__span-2-9"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>
</span><span id="__span-2-10"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>##### Trace delay
</span><span id="__span-2-11"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-2-12"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-2-13"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-2-14"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>set tclk_trace_delay_min 0.2
</span></code></pre></div>
<p>首先是 <span class="arithmatex">\(t_{co}\)</span>，应该表示的是 SPI Flash 的时钟到输出的延迟。本文用的 SPI Flash 型号是 Micron MT25QU02GCBB8E12-0SIT，可以从它的 <a href="https://media-www.micron.com/-/media/client/global/documents/products/data-sheet/nor-flash/serial-nor/mt25q/die-rev-b/mt25q_qlkt_u_02g_cbb_0.pdf">Datasheet</a> 看到，时钟到输出的延迟应该是 Max 7ns：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>Clock LOW to output valid under 30pF Max 7ns
</span><span id="__span-3-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Clock LOW to output valid under 10pF Max 6ns
</span></code></pre></div>
<p>因此 <code>tco_max</code> 设为 7，<code>tco_min</code> 默认即可，因为 Datasheet 中没有做要求。</p>
<p>然后 <span class="arithmatex">\(t_{su}\)</span> 和 <span class="arithmatex">\(t_h\)</span> 则是输入的 setup 和 hold time。类似的，可以查到 SPI Flash 的参数：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>Data in setup time Min 2.5ns
</span><span id="__span-4-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>Data in hold time Min 2ns
</span></code></pre></div>
<p>所以 <code>tsu</code> 设为 2.5，<code>th</code> 设为 2。</p>
<p>接下来则是 tdata 和 tclk 的 trace delay。这指的是从 FPGA 引脚到 SPI Flash 引脚的信号传输延迟。从严谨的角度来说，可以从板子的布线上测量长度来计算出来，不过这里就先用默认值了。一个简单的估算方法：光速 <span class="arithmatex">\(3*10^8 \text{m/s}\)</span>，考虑电信号传播速度是光速的一半，可以得到延迟和长度的比值： <span class="arithmatex">\(0.06 \text{ns/cm} = 0.15 \text{ns/inch}\)</span>。</p>
<p>那么，这些变量怎么参与到 input/output delay 的计算呢？</p>
<p>首先考虑 input delay。它指的是，从 SPI Flash 到 FPGA 的数据，相对于时钟的延迟。这个延迟由三部分组成：</p>
<ol>
<li>从 FPGA 输出的时钟 CCLK 到 SPI Flash 的时钟有延迟 <span class="arithmatex">\(t_{clk}\)</span>，下图 <code>a -&gt; b</code></li>
<li>从 SPI Flash 的时钟到数据输出有延迟 <span class="arithmatex">\(t_{co}\)</span>，下图 <code>b -&gt; c</code></li>
<li>从 SPI Flash 的数据到 FPGA 的数据输入有延迟 <span class="arithmatex">\(t_{data}\)</span>，下图 <code>c -&gt; d</code></li>
</ol>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.7 },
      { name: "data_flash", wave: "3456", node: "..c", phase: 2.5 },
      { name: "data_fpga", wave: "3456", node: "..d", phase: 2.3 },
    ],
  config: { hscale: 3 },
}</script>
<p>因此总延迟就是 <span class="arithmatex">\(t_{clk}+t_{co}+t_{data}\)</span>，就可以得到对应的设置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max + $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span><span id="__span-5-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min + $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_IN[*]] -clock_fall;
</span></code></pre></div>
<p>接下来要考虑 output delay。虽然 output delay 也有 min 和 max，但其含义有所区别，需要分别考虑。</p>
<p>首先是 max，它对应的是 setup time。如果定义时间 0 为时钟的上升沿，沿更早的时间为正的时间轴，沿更晚的时间为负的时间轴。那么，我们希望的是，数据到达寄存器输入的时间大于 setup time，此时可以满足 setup 条件。那么，具体怎么算呢？注意，我们要考虑的是从 FPGA 数据输出到 SPI Flash 上时钟的延迟。</p>
<p>假设 FPGA CCLK 时钟上升沿在 <span class="arithmatex">\(0\)</span> 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（通常为正，下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），我们期望 <span class="arithmatex">\(t_0-t_{data}\)</span> 在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻之前（下图的 <code>d -&gt; b</code>）至少 <span class="arithmatex">\(t_{su}\)</span> 时间到达，可以得到表达式：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.7 },
      { name: "data_fpga", wave: "3456", node: "..c", phase: 3.6 },
      { name: "data_flash", wave: "3456", node: "..d", phase: 3.4 }
    ],
  config: { hscale: 3 },
}</script>
<div class="arithmatex">\[
t_0 - t_{data} &gt; -t_{clk} + t_{su}
\]</div>
<p>化简一下，就可以得到 <span class="arithmatex">\(t_0 &gt; t_{data} + t_{su} - t_{clk}\)</span>，如果考虑极端情况，右侧 <span class="arithmatex">\(t_{data}\)</span> 取最大值，<span class="arithmatex">\(t_{clk}\)</span> 取最小值，我们就可以得到约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max - $tclk_trace_delay_min] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>接下来考虑 output delay 的 min，这对应的是 hold time。我们希望数据到达 SPI Flash 寄存器的时候，距离上升沿时间超过了 <span class="arithmatex">\(t_h\)</span>。还是一样的假设，如果 FPGA CCLK 时钟上升沿在 0 时刻（下图的 <code>a</code>），那么 SPI Flash 时钟上升沿在 <span class="arithmatex">\(-t_{clk}\)</span> 时刻（下图的 <code>b</code>）。假设 FPGA 数据输出时刻为 <span class="arithmatex">\(t_0\)</span>（下图的 <code>c</code>），那么 FPGA 数据输出到达 SPI Flash 在 <span class="arithmatex">\(t_0-t_{data}\)</span> 时刻（下图的 <code>d</code>），要求满足 hold 条件，可以得到：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p..", node: ".a" },
      { name: "data_fpga", wave: "3456", node: "..c", phase: 2.6 },
      { name: "clk_flash", wave: "p...", node: "..b", phase: 2.3 },
      { name: "data_flash", wave: "3456", node: "..d", phase: 2.2 },
    ],
  config: { hscale: 3 },
}</script>
<div class="arithmatex">\[
t_0 - t_{data} &lt; -t_{clk} - t_h
\]</div>
<p>化简以后，可以得到 <span class="arithmatex">\(t_0 &lt; t_{data} - t_{clk} - t_h\)</span>，按照极限来取，<span class="arithmatex">\(t_{data}\)</span> 取最小值，<span class="arithmatex">\(t_{clk}\)</span> 取最大值，可以得到最终的时序约束：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th - $tclk_trace_delay_max] [get_pins -hierarchical *STARTUP*/DATA_OUT[*]];
</span></code></pre></div>
<p>这样就可以实现 FPGA 和 SPI Flash 之间的正常通讯了。我觉得，这里比较绕的就是时间轴的定义，和我们平常思考的是反过来的。而且，这里的 min 和 max 并不是指 <span class="arithmatex">\([\min, \max]\)</span>，而是 <span class="arithmatex">\((-\inf, \min] \cup [\max, \inf)\)</span>。代入上面的数据，可以得到 <span class="arithmatex">\(\max=2.05, \min=-2.95, t_0 \in (\inf, -2.95] \cup [2.05, \inf)\)</span>。如果变化的时刻距离时钟上升沿太接近，就会导致在 SPI Flash 侧出现不满足 setup 或者 hold 约束的情况。</p>
<p>也可以换个角度来理解 min 和 max：对于同一个周期的时钟和数据来说，数据相对时钟有一个延迟，这个延迟不能太小，至少要满足 hold，所以这是一个最小的延迟；同时这个延迟不能太大，最多需要满足下一个时钟上升沿的 setup，所以这是一个最大的延迟。如果从这个角度来看，那就是延迟在一个 <span class="arithmatex">\([\min, \max]\)</span> 的范围内。但是，这样在计算的时候就需要把时钟周期纳入到 <span class="arithmatex">\(\max\)</span> 的计算中，比如 <span class="arithmatex">\(\max=t_c-t_{su}\)</span>。如果我们把坐标轴修改一下，原点变成原来的下一个时钟周期的上升沿，x 的正方向变成反向，就可以得到上面的形式了。</p>
<h3 id="artix-7"><a class="toclink" href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#artix-7">Artix 7 时序</a></h3>
<p>那么，更常见的 FPGA 是 7 系列的，比如 Artix 7，它采用的是 STARTUPE2 原语，只有时钟是通过 STARTUPE2 原语的 USRCCLKO 信号传递到 CCLK 引脚上的，其他数据信号都是需要在顶层信号绑定对应的引脚。在 AXI Quad SPI 文档中，描述了 STARTUPE2 所需要的时序约束，我们分段来分析一下。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>## You must provide all the delay numbers
</span><span id="__span-8-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>## CCLK delay is 0.5, 6.7 ns min/max for K7-2; refer Data sheet
</span><span id="__span-8-3"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>## Consider the max delay for worst case analysis
</span><span id="__span-8-4"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>set cclk_delay 6.7
</span><span id="__span-8-5"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>## Following are the SPI device parameters
</span><span id="__span-8-6"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>## Max Tco
</span><span id="__span-8-7"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>set tco_max 7
</span><span id="__span-8-8"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>## Min Tco
</span><span id="__span-8-9"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>set tco_min 1
</span><span id="__span-8-10"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>## Setup time requirement
</span><span id="__span-8-11"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>set tsu 2
</span><span id="__span-8-12"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>## Hold time requirement
</span><span id="__span-8-13"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>set th 3
</span><span id="__span-8-14"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>## Following are the board/trace delay numbers
</span><span id="__span-8-15"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>## Assumption is that all Data lines are matched
</span><span id="__span-8-16"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>set tdata_trace_delay_max 0.25
</span><span id="__span-8-17"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>set tdata_trace_delay_min 0.25
</span><span id="__span-8-18"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>set tclk_trace_delay_max 0.2
</span><span id="__span-8-19"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a>set tclk_trace_delay_min 0.2
</span><span id="__span-8-20"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a>#### End of user provided delay numbers
</span></code></pre></div>
<p>可以看到，这一部分和上面 UltraScale+ 部分差不多，只是多一个 <code>cclk_delay</code> 变量，这是因为 Artix 7 中，时钟只能创建到 USRCCLKO 引脚上，但是实际 SPI Flash 接收到的时钟等于 USRCCLKO 到 CCLK 引脚，然后再通过 PCB 上的线传播到 SPI Flash，所以需要手动添加一个偏移，这个偏移就是 USRCCLKO 到 CCLK 的延迟，可以在 <a href="https://www.xilinx.com/support/documentation/data_sheets/ds181_Artix_7_Data_Sheet.pdf">Artix 7 Data Sheet</a> 里面看到：对于 1.0V，-2 速度的 FPGA，这个延迟最小值为 0.50ns，最大值为 6.70ns，这里采用了最大值。</p>
<p>所以，下面的约束，除了时钟部分以外，和上面分析的 UltraScale+ 时序约束计算方法是相同的。不同点在于，首先约束了从 AXI Quad SPI 到 STARTUPE2 的路由时延，从 0.1ns 到 1.5ns，然后又从 USRCCLKO 创建了一个分频 + 延迟 <code>cclk_delay</code> 纳秒的时钟，作为 SPI Flash 上 SCK 引脚的时钟。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>## this is to ensure min routing delay from SCK generation to STARTUP input
</span><span id="__span-9-2"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>## User should change this value based on the results
</span><span id="__span-9-3"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>## having more delay on this net reduces the Fmax
</span><span id="__span-9-4"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>set_max_delay 1.5 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-9-5"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>*USRCCLKO] -datapath_only
</span><span id="__span-9-6"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>set_min_delay 0.1 -from [get_pins -hier *SCK_O_reg_reg/C] -to [get_pins -hier
</span><span id="__span-9-7"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>*USRCCLKO]
</span><span id="__span-9-8"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>## Following command creates a divide by 2 clock
</span><span id="__span-9-9"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>## It also takes into account the delay added by STARTUP block to route the CCLK
</span><span id="__span-9-10"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>create_generated_clock -name clk_sck -source [get_pins -hierarchical
</span><span id="__span-9-11"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>*axi_quad_spi_1/ext_spi_clk] [get_pins -hierarchical *USRCCLKO] -edges {3 5 7}
</span><span id="__span-9-12"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>-edge_shift [list $cclk_delay $cclk_delay $cclk_delay]
</span><span id="__span-9-13"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a>## Data is captured into FPGA on the second rising edge of ext_spi_clk after the SCK
</span><span id="__span-9-14"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a>falling edge
</span><span id="__span-9-15"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>
</span><span id="__span-9-16"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a>## Data is driven by the FPGA on every alternate rising_edge of ext_spi_clk
</span><span id="__span-9-17"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a>set_input_delay -clock clk_sck -max [expr $tco_max + $tdata_trace_delay_max +
</span><span id="__span-9-18"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a>$tclk_trace_delay_max] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-9-19"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>set_input_delay -clock clk_sck -min [expr $tco_min + $tdata_trace_delay_min +
</span><span id="__span-9-20"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a>$tclk_trace_delay_min] [get_ports IO*_IO] -clock_fall;
</span><span id="__span-9-21"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>set_multicycle_path 2 -setup -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-9-22"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-9-23"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>set_multicycle_path 1 -hold -end -from clk_sck -to [get_clocks -of_objects [get_pins
</span><span id="__span-9-24"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a>-hierarchical */ext_spi_clk]]
</span><span id="__span-9-25"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a>## Data is captured into SPI on the following rising edge of SCK
</span><span id="__span-9-26"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>## Data is driven by the IP on alternate rising_edge of the ext_spi_clk
</span><span id="__span-9-27"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a>set_output_delay -clock clk_sck -max [expr $tsu + $tdata_trace_delay_max -
</span><span id="__span-9-28"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a>$tclk_trace_delay_min] [get_ports IO*_IO];
</span><span id="__span-9-29"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>set_output_delay -clock clk_sck -min [expr $tdata_trace_delay_min - $th -
</span><span id="__span-9-30"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a>$tclk_trace_delay_max] [get_ports IO*_IO];
</span><span id="__span-9-31"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a>set_multicycle_path 2 -setup -start -from [get_clocks -of_objects [get_pins
</span><span id="__span-9-32"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a>-hierarchical */ext_spi_clk]] -to clk_sck
</span><span id="__span-9-33"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a>set_multicycle_path 1 -hold -from [get_clocks -of_objects [get_pins -hierarchical */
</span><span id="__span-9-34"><a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a>ext_spi_clk]] -to clk_sck
</span></code></pre></div>
<p>一个 Artix 7 上配置 STARTUP SPI Flash 的例子 <a href="https://github.com/trivialmips/nontrivial-mips/blob/master/vivado/NonTrivialMIPS.srcs/constrs_1/new/io_timings.xdc">io_timings.xdc</a> 可供参考。</p>
<nav class="md-post__action">
<a href="../../hardware/2021/09/27/xilinx-axi-quad-spi-timing/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-18 00:00:00">2021年9月18日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="k8s"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/">研究 k8s 网络工作原理</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_1">背景</a></h3>
<p>用 k8s 也有一段时间了，之前遇到过 iptables 等出现问题，导致 k8s 节点间网络出现问题，于是想研究一下 k8s 的网络工作原理。</p>
<h3 id="docker"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#docker">Docker 网络</a></h3>
<p>首先研究一下 Docker 网络连接是如何实现的。Docker 首先会创建一个 bridge，名为 bridge0:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>docker0
</span><span id="__span-0-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="m">3</span>:<span class="w"> </span>docker0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-0-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span>link/ether<span class="w"> </span><span class="m">02</span>:42:c4:87:73:bf<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-0-4"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">172</span>.17.0.1/16<span class="w"> </span>brd<span class="w"> </span><span class="m">172</span>.17.255.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>docker0
</span><span id="__span-0-5"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-0-6"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::42:c4ff:fe87:73bf/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-0-7"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>默认情况下，每个容器都会有单独的一个 netns，然后创建一对 veth pair，一端留在 global netns，另一端放到容器中。在 global netns 中的 veth 端口会加入到 docker0 中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>dev<span class="w"> </span>veth3db9316
</span><span id="__span-1-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="m">21</span>:<span class="w"> </span>veth3db9316@if20:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>docker0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-1-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span>link/ether<span class="w"> </span>e2:49:a6:2d:5a:bd<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netnsid<span class="w"> </span><span class="m">0</span>
</span><span id="__span-1-4"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::e049:a6ff:fe2d:5abd/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-1-5"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-1-6"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>$<span class="w"> </span>brctl<span class="w"> </span>show<span class="w"> </span>docker0
</span><span id="__span-1-7"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>bridge<span class="w"> </span>name<span class="w">     </span>bridge<span class="w"> </span>id<span class="w">               </span>STP<span class="w"> </span>enabled<span class="w">     </span>interfaces
</span><span id="__span-1-8"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>docker0<span class="w">         </span><span class="m">8000</span>.0242c48773bf<span class="w">       </span>no<span class="w">              </span>veth3db9316
</span></code></pre></div>
<p>容器中的网络，在 veth 上 docker 会分配并配置一个地址（比如 172.17.0.2），然后设置默认路由 via 172.17.0.1。一方面，可以通过默认路由到 172.17.0.1 再通过 iptables NAT 访问外面的网络：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>iptables-save<span class="w"> </span>-t<span class="w"> </span>nat
</span><span id="__span-2-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">## Generated by xtables-save v1.8.2 on Sat Sep 18 10:44:49 2021</span>
</span><span id="__span-2-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>*nat
</span><span id="__span-2-4"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>:PREROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-5"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>:INPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-6"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>:POSTROUTING<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-7"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>:OUTPUT<span class="w"> </span>ACCEPT<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-8"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>:DOCKER<span class="w"> </span>-<span class="w"> </span><span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>
</span><span id="__span-2-9"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-m<span class="w"> </span>addrtype<span class="w"> </span>--dst-type<span class="w"> </span>LOCAL<span class="w"> </span>-j<span class="w"> </span>DOCKER
</span><span id="__span-2-10"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.17.0.0/16<span class="w"> </span>!<span class="w"> </span>-o<span class="w"> </span>docker0<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</span><span id="__span-2-11"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>-A<span class="w"> </span>OUTPUT<span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="m">127</span>.0.0.0/8<span class="w"> </span>-m<span class="w"> </span>addrtype<span class="w"> </span>--dst-type<span class="w"> </span>LOCAL<span class="w"> </span>-j<span class="w"> </span>DOCKER
</span><span id="__span-2-12"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>-A<span class="w"> </span>DOCKER<span class="w"> </span>-i<span class="w"> </span>docker0<span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-2-13"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>COMMIT
</span><span id="__span-2-14"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="c1">## Completed on Sat Sep 18 10:44:49 2021</span>
</span></code></pre></div>
<p>另一方面，因为连接不同容器的 veth 在同一个 bridge 下面，所以不同容器的可以认为在同一个二层网络中，自然可以互相访问。</p>
<h3 id="k8s_1"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#k8s_1">K8s 网络</a></h3>
<p>在 k8s 中，所有的 pod 都希望可以通过 IP 地址互联。一个思路是把各个节点上的 pod 通过类似 docker 的方法实现，即每个 netns 通过 veth 连接到一个 bridge 上，然后再想办法去路由在其它节点上的 pod。</p>
<p>因为我用 k3s 搭建 k8s 集群，它用的 cni 是 flannel。flannel 采用的是 vxlan 的方式来实现节点间的网络通信。</p>
<p>首先还是看看节点内的 pod 如何组网。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="m">5</span>:<span class="w"> </span>cni0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-3-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span>link/ether<span class="w"> </span>6a:4f:ff:8b:b1:b3<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-3-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.42.0.1/24<span class="w"> </span>brd<span class="w"> </span><span class="m">10</span>.42.0.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>cni0
</span><span id="__span-3-4"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-3-5"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::7cf6:57ff:fed7:c49b/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-3-6"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-3-7"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="m">6</span>:<span class="w"> </span>vethc47d6140@if3:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>master<span class="w"> </span>cni0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-3-8"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span>link/ether<span class="w"> </span>da:19:f8:48:f6:49<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netns<span class="w"> </span>cni-9d2a5120-16a3-453e-bf64-c4006c06c93b
</span><span id="__span-3-9"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::d819:f8ff:fe48:f649/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-3-10"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>首先，flannel 给每个节点分配了一个 /24 的网段，比如第一个节点是 10.42.0.0/24，第二个是 10.42.1.0/24，依次类推。然后，节点内的 pod 就从这个网段里分配地址，比如 10.42.0.50/24，它的默认网关是 10.42.0.1。这些 veth 都会加入到 cni0 的 bridge 中。这一部分原理和 docker 是一样的，只不过名字不同了。也有相应的 iptables 规则：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>iptables-save<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>MASQUERADE
</span><span id="__span-4-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="m">224</span>.0.0.0/4<span class="w"> </span>-j<span class="w"> </span>MASQUERADE<span class="w"> </span>--random-fully
</span><span id="__span-4-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>!<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.42.0.0/16<span class="w"> </span>-j<span class="w"> </span>MASQUERADE<span class="w"> </span>--random-fully
</span></code></pre></div>
<p>那么，节点间网络如何实现呢？假如，我们要从第一个节点 pod 10.42.0.50/24 访问第二个节点的 pod 10.42.1.51/24，首先，pod 根据默认路由会发给 10.42.0.1/24，到达第一个节点的 cni0，然后查路由表：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>ip<span class="w"> </span>r
</span><span id="__span-5-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="m">10</span>.42.0.0/24<span class="w"> </span>dev<span class="w"> </span>cni0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.42.0.1
</span><span id="__span-5-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="m">10</span>.42.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.42.1.0<span class="w"> </span>dev<span class="w"> </span>flannel.1<span class="w"> </span>onlink
</span></code></pre></div>
<p>可以看到，它会匹配 10.42.1.0/24 via 10.42.1.0 dev flannel.1 的路由。flannel.1 是一个 vxlan 的 interface：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>ip<span class="w"> </span>a<span class="w"> </span>show<span class="w"> </span>flannel.1
</span><span id="__span-6-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="m">4</span>:<span class="w"> </span>flannel.1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1450</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>group<span class="w"> </span>default
</span><span id="__span-6-3"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span>link/ether<span class="w"> </span>b6:2f:39:4a:02:c0<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
</span><span id="__span-6-4"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.42.0.0/32<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>flannel.1
</span><span id="__span-6-5"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span><span id="__span-6-6"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span>inet6<span class="w"> </span>fe80::b42f:39ff:fe4a:2c0/64<span class="w"> </span>scope<span class="w"> </span>link
</span><span id="__span-6-7"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
</span></code></pre></div>
<p>当这个 interface 接收到一个 packet 的时候，会查询 fdb：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>bridge<span class="w"> </span>fdb<span class="w"> </span>show<span class="w"> </span>brport<span class="w"> </span>flannel.1
</span><span id="__span-7-2"><a href="../../devops/2021/09/18/k8s-networking/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>...
</span></code></pre></div>
<p>这个 fdb 中包括了 (MAC 地址，IP 地址) 的 tuple。当 flannel.1 收到一个 Ethernet Frame 的时候，如果目的地址匹配这里的 MAC 地址，就会直接把 Eth Frame 封装到 UDP 里面发给目的 IP 地址；否则，就会在这个表里面 broadcast。这样，第二个节点就会收到 packet 并且转给实际的 pod。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_2">总结</a></h3>
<p>总结一下 k8s 的网络互联的实现方法：节点内通过 bridge 实现，把链接各个 netns 的 veth 桥接起来；节点间划分为多个子网，子网间通过 flannel 的网关进行路由，flannel 网关间通过 vxlan 进行互联。</p>
<h3 id="_3"><a class="toclink" href="../../devops/2021/09/18/k8s-networking/#_3">参考文档</a></h3>
<p><a href="https://zhuanlan.zhihu.com/p/34749675">技术干货 | 深入理解 flannel</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/140711132">一文看懂 k8s 的 Flannel 网络</a></p>
<nav class="md-post__action">
<a href="../../devops/2021/09/18/k8s-networking/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-14 00:00:00">2021年9月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="cpu"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#_1">背景</a></h3>
<p>最早学习乱序执行 CPU 的时候，是在 Wikipedia 上自学的，后来在计算机系统结构课上又学了一遍，但发现学的和现在实际采用的乱序执行 CPU 又有很大区别，后来又仔细研究了一下，觉得理解更多了，就想总结一下。</p>
<h3 id="tomasulo"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#tomasulo">经典 Tomasulo</a></h3>
<p>参考 <a href="https://people.eecs.berkeley.edu/~pattrsn/252F96/Lecture04.pdf">Stanford 教材</a></p>
<p>经典 Tomasulo，也是 Wikipedia 上描述的 Tomasulo 算法，它的核心是保留站。指令在 Decode 之后，会被分配到一个保留站中。保留站有以下的这些属性：</p>
<ol>
<li>Op：需要执行的操作</li>
<li>Qj，Qk：操作数依赖的指令目前所在的保留站 ID</li>
<li>Vj，Qk：操作数的值</li>
<li>Rj，Rk：操作数是否 ready（或者用特殊的 Qj，Qk 值表示是否 ready）</li>
<li>Busy：这个保留站被占用</li>
</ol>
<p>此外还有一个 mapping（Wikipedia 上叫做 RegisterStat），记录了寄存器是否会被某个保留站中的指令写入。</p>
<p>指令分配到保留站的时候，会查询 RegisterStat，得知操作数寄存器是否 ready，如果不 ready，说明有一个先前的指令要写入这个寄存器，那就记录下对应的保留站 ID。当操作数都 ready 了，就可以进入计算单元计算。当一条指令在执行单元中完成的时候，未出现 WAW 时会把结果写入寄存器堆，并且通过 Common Data Bus 进行广播，目前在保留站中的指令如果发现，它所需要的操作数刚好计算出来了，就会把取值保存下来。</p>
<p>这里有一些细节：因为保留站中的指令可能要等待其他指令的完成，为了保证计算单元利用率更高，对于同一个计算类型（比如 ALU），需要有若干个同类的保留站（比如 Add1，Add2，Add3）。在 Wikipedia 的表述中，每个保留站对应了一个计算单元，这样性能比较好，但自然面积也就更大。如果节省面积，也可以减少计算单元的数量，然后每个计算单元从多个保留站中获取计算的指令。</p>
<p>可以思考一下，这种方法的瓶颈在什么地方。首先，每条指令都放在一个保留站中，当保留站满的时候就不能发射新的指令。其次，如果计算单元的吞吐跟不上保留站的填充速度，也会导致阻塞。</p>
<p>这种方法的一个比较麻烦的点在于难以实现精确异常。精确异常的关键在于，异常之前的指令都生效，异常和异常之后的指令不生效，但这种方法无法进行区分。</p>
<p>从寄存器重命名的角度来看，可以认为这种方法属于 Implicit Register Renaming，也就是说，把 Register 重命名为保留站的 ID。</p>
<p>再分析一下寄存器堆需要哪些读写口。有一条规律是，寄存器堆的面积与读写口个数的平方成正比。对于每条发射的指令，都需要从寄存器堆读操作数，所以读口是操作数 x 指令发射数。当执行单元完成计算的时候，需要写入寄存器堆，所以每个执行单元都对应一个寄存器堆的写口。</p>
<p>硬件实现的时候，为了性能，希望保留站可以做的比较多，这样可以容纳更多的指令。但是，保留站里面至少要保存操作数的值，会比较占用面积，并且时延也比较大。</p>
<h3 id="rob-reorder-buffer"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#rob-reorder-buffer">ROB (ReOrder Buffer)</a></h3>
<p><a href="https://web.stanford.edu/class/cs349g/cs349g-speculation.pdf">参考教材</a></p>
<p>为了实现精确异常，我们需要引入 ROB。在上面的 Tomasulo 算法中，计算单元计算完成的时候，就会把结果写入到寄存器堆中，因此精确异常时难以得到正确的寄存器堆取值。既然我们希望寄存器堆的状态与顺序执行的结果一致，我们需要引入 ROB。</p>
<p>ROB 实际上就是一个循环队列，队列头尾指针之间就是正在执行的指令，每个 ROB 表项记录了指令的状态、目的寄存器和目的寄存器将要写入的值。ROB 会检查队列头的指令，如果已经执行完成，并且没有异常，就可以让结果生效，并把指令从队列头中删去，继续检查后面的。Decode 出来的指令则会插入到 ROB 的尾部，并且随着指令的执行过程更新状态。遇到异常的指令，就把队列中的指令、保留站和执行单元清空，从异常处理地址开始重新执行。</p>
<p>为了保证寄存器堆的正确性，运算单元的运算结果会写入 ROB 项中，当这一项在 ROB 队列头部被删去时，就会写入寄存器堆。在经典 Tomasulo 中，寄存器重命名为保留站的 ID，但在这种设计中，应该重命名为 ROB 的 ID，也就是说，需要维护一个寄存器到 ROB ID 的映射，当指令进入保留站的时候，需要从寄存器堆或者 ROB 中去读取操作数的值。在 CDB 上广播的也是 ROB 的 ID，而不是保留站的 ID。</p>
<p>这种方法中，ROB 的大小成为了一个新的瓶颈，因为每条在正在执行的指令都需要在 ROB 中记录一份。不过好处是实现了精确异常。</p>
<h3 id="explicit-register-renaming"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#explicit-register-renaming">Explicit Register Renaming</a></h3>
<p>上面两种设计都是采用的 Implicit Register Renaming 的方法，第一种方法重命名到了保留站，第二种方法重命名到了 ROB。还有一种设计，把寄存器编号映射到物理的寄存器。把 ISA 中的寄存器称为架构寄存器（比如 32 个通用寄存器），CPU 中实际的寄存器称为物理寄存器，物理寄存器一般会比架构寄存器多很多（一两百个甚至更多）。</p>
<p>Explicit Register Renaming 和 ReOrder Buffer 这两个设计方向可以同时使用，也可以单独使用。</p>
<p>映射的方法和前面的类似，也是维护一个 mapping，从架构寄存器到物理寄存器。当一条指令 Dispatch 的时候，操作数在 mapping 中找到实际的物理寄存器编号。如果这条指令要写入新的架构寄存器，则从未分配的物理寄存器中分配一个新的物理寄存器，并且更新 mapping，即把写入的架构寄存器映射到新的物理寄存器上。然后，放到 Issue Queue 中。</p>
<p>Issue Queue 可以理解为保留站的简化版，它不再保存操作数的取值，而仅仅维护操作数是否 ready。后面解释为什么不需要保存操作数的取值。在 Issue Queue 中的指令在所有操作数都 ready 的时候，则会 Issue 到不同的端口中。每个端口对应着一个执行单元，比如两个 ALU 端口分别对应两个 ALU 执行单元。指令首先通过寄存器堆，以物理寄存器为编号去读取数据，然后这个值直接传给执行单元，不会存下来。当执行单元执行完毕的时候，结果也是写到物理寄存器堆中，ROB 不保存数据。</p>
<p>可以发现，这种设计中，值仅保存在寄存器堆中，Issue Queue 和 ROB 都只保存一些状态位，因此它们可以做的很大，典型的 Issue Queue 有几十项，ROB 则有几百项。</p>
<p>接下来讨论一些细节。首先是，物理寄存器何时释放。当一条指令写入一个架构寄存器的时候，在下一次这个架构寄存器被写入之前，这个寄存器的值都有可能被读取，因此这个架构寄存器到物理寄存器的映射要保留。如果我们能保证读取这个值的指令都已经完成，我们就可以释放这个物理寄存器了。一个方法是，我在覆盖架构寄存器到物理寄存器的映射时，我还要记录原来的物理寄存器，当该指令在 ROB 中提交了（从队头出去了），说明之前可能依赖这个物理寄存器的所有指令都完成了，这时候就可以把原来的物理寄存器放到未映射的列表中。</p>
<p>还有一个问题，就是在遇到异常的时候，如何恢复在异常指令处的架构寄存器到物理寄存器的映射呢？一个办法是，利用我在 ROB 中记录的被覆盖的物理寄存器编号，从 ROB 队尾往前回滚，当发现一条指令覆盖了一个架构寄存器映射的时候，就恢复为覆盖之前的值。这样，当回滚到异常指令的时候，就会得到正确的映射。<a href="https://ieeexplore.ieee.org/document/491460">MIPS R10K 的论文</a>中是这么描述的：</p>
<div class="language-text highlight"><pre><span></span><code>The active list contains the logical-destination register number and its
old physical-register number for each instruction. An instruction's
graduation commits its new mapping, so the old physical register can
return to the free list for reuse. When an exception occurs, however,
subsequent instructions never graduate. Instead, the processor restores
old mappings from the active list. The R1OOOO unmaps four instructions
per cycle--in reverse order, in case it renamed the same logical
register twice. Although this is slower than restoring a branch,
exceptions are much rarer than mispredicted branches. The processor
returns new physical registers to the free lists by restoring their read
pointers.
</code></pre></div>
<p>和 @CircuitCoder 讨论并参考 <a href="https://docs.boom-core.org/en/latest/sections/reorder-buffer.html#parameterization-rollback-versus-single-cycle-reset">BOOM 文档</a> 后发现，另一种办法是记录一个 Committed Map Table，也就是，只有当 ROB Head 的指令被 Commit 的时候，才更新 Committed Map Table，可以认为是顺序执行的寄存器映射表。当发生异常的时候，把 Committed Map Table 覆盖到 Register Map Table 上。这样需要的周期比较少，但是时序可能比较差。</p>
<h3 id="implicit-renamingrob-explicit-renaming"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#implicit-renamingrob-explicit-renaming">Implicit Renaming(ROB) 和 Explicit Renaming 的比较</a></h3>
<p>这两种方法主要区别：</p>
<ol>
<li>Implicit Renaming 在分发的时候，就会从寄存器堆读取数据，保存到保留站中；而 Explicit Renaming 是指令从 Issue Queue 到执行单元时候从寄存器堆读取数据</li>
<li>Implicit Renaming 的寄存器堆读取口较少，只需要考虑发射数乘以操作数个数，但所有类型的寄存器堆（整数、浮点）都需要读取；Explicit Renaming 的寄存器堆读取口更多，对于每个 Issue Queue，都需要操作数个数个读取口，但好处是可以屏蔽掉不需要访问的读取口，比如浮点 FMA 流水不需要读取整数寄存器堆。写和读是类似的：Implicit Renaming 中，寄存器堆的写入是从 ROB 上提交；而 Explicit Renaming 则是执行单元计算完后写入寄存器堆。</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/09/14/brief-into-ooo/#_2">其他优化的手段</a></h3>
<p>在第一和第二种设计中，当一条指令计算完成时，结果会直接通过 CDB 转发到其他指令的输入，这样可以提高运行效率。在第三种设计中，为了提高效率，也可以做类似的事情，但因为中间多了一级寄存器堆读取的流水线级，处理会更加复杂一点。比如，有一条 ALU 指令，可以确定它在一个周期后一定会得到计算结果，那么我就可以提前把依赖这条指令的其他指令 Dispatch 出去，然后在 ALU 之间连接一个 bypass 网络，这样就可以减少一些周期。</p>
<p>此外，为了提高吞吐率，一般计算单元都被设计为每个周期可以接受一条指令，在内部实现流水线执行，每个周期完成一条指令的计算。当然了，很多时候由于数据依赖问题，可能并不能达到每个周期每个计算单元都满载的情况。</p>
<p>有些时候，一些指令不方便后端实现，就会加一层转换，从指令转换为 uop，再由后端执行。这在 x86 处理器上很普遍，因为指令集太复杂了。像 AArch64 指令集，它在 Load/Store 的时候可以对地址进行计算，这种时候也是拆分为两条 uop 来执行。一些实用的指令需要三个操作数，比如 <code>D = A ? B : C</code>，在 Alpha 21264 中，这条指令会转换为两条 uop，这两条 uop 的操作数就只有两个，便于后端实现，否则在各个地方都允许三个操作数会导致一定的浪费。</p>
<nav class="md-post__action">
<a href="../../hardware/2021/09/14/brief-into-ooo/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-09-02 00:00:00">2021年9月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="locale"><a class="toclink" href="../../software/2021/09/02/locale/">Locale 影响排序的特殊副作用</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/09/02/locale/#_1">背景</a></h3>
<p>最近在答疑的时候，发现同一条命令在不同系统上行为不同，一开始以为是 bash 版本问题，排查后最后发现是 locale 的问题。一个例子如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2021/09/02/locale/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>cat<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\\n'</span><span class="w"> </span><span class="s1">' '</span>
</span><span id="__span-0-2"><a href="../../software/2021/09/02/locale/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="m">1</span><span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>*<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试<span class="w"> </span>α
</span><span id="__span-0-3"><a href="../../software/2021/09/02/locale/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\\n'</span><span class="w"> </span><span class="s1">' '</span>
</span><span id="__span-0-4"><a href="../../software/2021/09/02/locale/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="m">1</span><span class="w"> </span>A<span class="w"> </span>B<span class="w"> </span><span class="se">\ </span>a<span class="w"> </span>b<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span><span id="__span-0-5"><a href="../../software/2021/09/02/locale/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">"zh_CN.UTF-8"</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\\n'</span><span class="w"> </span><span class="s1">' '</span>
</span><span id="__span-0-6"><a href="../../software/2021/09/02/locale/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>测<span class="w"> </span>二<span class="w"> </span>试<span class="w"> </span>一<span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α
</span><span id="__span-0-7"><a href="../../software/2021/09/02/locale/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>$<span class="w"> </span><span class="nv">LANG</span><span class="o">=</span><span class="s2">"en_US.UTF-8"</span><span class="w"> </span>sort<span class="w"> </span>poc.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">'\\n'</span><span class="w"> </span><span class="s1">' '</span>
</span><span id="__span-0-8"><a href="../../software/2021/09/02/locale/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>*<span class="w"> </span>+<span class="w"> </span>-<span class="w"> </span>/<span class="w"> </span><span class="se">\ </span><span class="m">1</span><span class="w"> </span>a<span class="w"> </span>A<span class="w"> </span>b<span class="w"> </span>B<span class="w"> </span>α<span class="w"> </span>一<span class="w"> </span>二<span class="w"> </span>测<span class="w"> </span>试
</span></code></pre></div>
<p>注意 \ 1 a A 的顺序，在不同的 locale 下结果不同。</p>
<p>网上也有关于这个问题的讨论：</p>
<ol>
<li>https://unix.stackexchange.com/questions/75341/specify-the-sort-order-with-lc-collate-so-lowercase-is-before-uppercase</li>
<li>https://stackoverflow.com/questions/43448655/weird-behavior-of-bash-glob-regex-ranges</li>
</ol>
<nav class="md-post__action">
<a href="../../software/2021/09/02/locale/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-08-30 00:00:00">2021年8月30日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rhel-6-centos-7"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/">一次从 RHEL 6 到 CentOS 7 的更新</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_1">背景</a></h3>
<p>有一台 RHEL 6 的服务器，各种软件版本太老了，用起来很难受，因此想升级。一开始想升级到 RHEL 7，但是发现必须要从 RedHat 下载 ISO，比较慢，所以我就先切换到 CentOS 6，再升级到 CentOS 7</p>
<h3 id="_2"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_2">过程</a></h3>
<h4 id="rhel-6-pre-upgrade"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#rhel-6-pre-upgrade">RHEL 6 Pre upgrade</a></h4>
<p>一开始还是打算升级到 RHEL 7，所以跟随 RedHat 的文档去做 pre upgrade check，发现有一步要跑好久，网上搜了一下，发现这个步骤会扫描已有的各种程序，检查升级以后会不会出现不能运行的问题。但是如果有很多小文件，这一个过程就会进行很久，好在可以设置 exclusion 目录。最后检查出来的结果就是 GNOME 没法升级，建议卸载。</p>
<p>倒腾了一下升级工具，发现需要离线安装，比较麻烦，我就干脆换 CentOS 了。</p>
<h4 id="rhel-6-centos-6"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#rhel-6-centos-6">RHEL 6 -&gt; CentOS 6</a></h4>
<p>首先，把软件源都切换到 CentOS，这一步很简单，因为包都是一样的。只不过，因为 CentOS 6 在 centos-vault 里面，所以用起来比较麻烦。</p>
<h4 id="centos-6-centos-7"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#centos-6-centos-7">CentOS 6 -&gt; CentOS 7</a></h4>
<p>由于 CentOS 6 到 CentOS 7 升级涉及的改动比较多，官方提供了一个升级工具。一开始，我想直接升级到 CentOS 7 最新版本，但是报错，看到网上说可以升级到 CentOS 7 的早期版本，试了一下，确实没问题。</p>
<p>一通升级以后，重启，进入更新过程，发现很多包都安装失败了。重启以后，因为找不到 rootfs，挂在了 dracut 的 initramfs 里面。</p>
<h4 id="_3"><a class="toclink" href="../../system/2021/08/30/rhel6-upgrade-centos7/#_3">漫长的修复过程</a></h4>
<p>简单试了一下，发现 dracut 的 initramfs 里程序太少了，调试起来很痛苦。所以，我在 BMC 里通过 Virtual Media 挂了一个 Arch Linux 的 Live CD。因为通过 Web 访问延迟太高，我设了一个 root 密码，然后直接 ssh 到 live cd 系统中。</p>
<p>接着，我发现，可以正常找到盘和里面的各个分区，所以怀疑是之前 initramfs 里缺了什么东西，导致找不到硬盘。我 arch-chroot 到 root 分区里，然后手动更新各个包，特别麻烦：我首先升级了 yum repos 到最新的 CentOS 7，然后手动删掉/升级 el6 的各个软件包。最后好不容易把 kernel 终于升级好了，又重新生成 grub2 的配置，因为 CentOS 6 是 grub1。这时候，重启进入系统，发现可以找到 rootfs 了，但是经过 selinux relabel 以后，仍然会遇到 systemd-logind 起不来的问题，伴随着一系列的 audit 报警。</p>
<p>最后，使出了暴力的解决办法：在 cmdline 中设置 selinux=0 audit=0，然后终于进入系统了。再继续删掉一些 el6 的包，然后升级各种包，最后终于是恢复了正常。</p>
<nav class="md-post__action">
<a href="../../system/2021/08/30/rhel6-upgrade-centos7/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-08-06 00:00:00">2021年8月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="../../misc/2021/08/06/intel-intrinsics-guide/">轶事一则</a></h2>
<p>7.31 号周六的时候，发现 Intel Intrinsics Guide(https://software.intel.com/sites/landingpage/IntrinsicsGuide/) 出现错误，加载数据失败，于是在 Intel 的网站上提交了一个 bug。</p>
<p>8.2 号的时候，Intel 发邮件过来，说已经复现了问题，已经汇报给了后端团队。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>Thank you for bringing this to our attention. We have verified and
encountered the same issue. Please know that we have escalated this
issue to our backend technical team.

We will get back to you as soon as we have an update. Have a nice day
ahead!
</code></pre></div>
<p>8.4 号的时候，Intel 再次发邮件过来，说后端团队正在处理这个问题，会尽快完成修复，请我耐心等待。这个时候我去网站上看，还是有问题。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>Our backend team is still working on this issue. We are trying our level
best to get back to you with an update soon.

Have a nice day ahead!
</code></pre></div>
<p>8.6 号 19:27 的时候，Intel 又发了一次邮件，说后端团队依然在处理这个问题，并且正在进行一个永久性的修复（言下之意是现在提供了一个临时性的修复）。这个时候去网站上看，终于是修好了。邮件原文：</p>
<div class="language-text highlight"><pre><span></span><code>We have received an update from our backend team is that they are
working on this issue and, a more permanent fix is in the works.
Hopefully, it will resolve soon.

We appreciate your patience and understanding on this matter. Have a
nice day!
</code></pre></div>
<p>我回复了一下邮件，告诉 Intel 我这边看到已经是修复好的版本，紧接着又收到了一封邮件，告诉我可以从网站上下载离线版的 Intrinsics Guide：</p>
<div class="language-text highlight"><pre><span></span><code>Thank you for your prompt response. We are glad that your issue has been
resolved and we would like to thank you for your co operation.  Please
be informed that the offline version of the Intrinsic Guide is now
available for download from the site. The offline version of the guide
has the same content as the site, but is viewable offline by the user. A
link to the download is now added in the left column of the site:
https://software.intel.com/sites/landingpage/IntrinsicsGuide/

That said, we are closing this ticket and if you have further issues
please open another ticket and we will be happy to help you.

After case closure, you will receive a survey email. We appreciate it if
you can complete this survey regarding the support you received.  Your
feedback will help us improve our support.

For any concerns related to Intel® Developer Zone account, login or
website, please feel free to open a new ticket:
https://software.intel.com/en-us/support
</code></pre></div>
<p>这次 Intel Support 的反应挺快的，给个好评。就是希望 Intel 能够不挤牙膏，能拿出和 AMD 相当水平的 CPU。</p>
<nav class="md-post__action">
<a href="../../misc/2021/08/06/intel-intrinsics-guide/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-07-24 00:00:00">2021年7月24日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="homebridge-broadlink-rm-pro"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/">配置 homebridge-broadlink-rm-pro</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/#_1">背景</a></h3>
<p>最近发现空调遥控器电池有点不足，有时候会自动关机，于是拿出以前买的 Broadlink RM mini 3 充当远程的空调遥控器使用。为了方便手机上配置，分别采用了官方的 App 智慧星和 homebridge 进行配置。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/07/24/homebridge-rm-mini-3/#_2">步骤</a></h3>
<p>首先用官方的智慧星配置好 Broadlink RM mini 3 的网络，然后配置 homebridge-broadlink-rm-pro。最早的插件作者不怎么更新了，这个版本是目前用的比较多的一个 fork。</p>
<p>安装好以后，在 Home 里面可以看到 Scan Code 的开关。打开以后，用遥控器在 Broadlink RM mini 3 附近按按键，就可以在 Homebridge 日志里看到 hex code 了。然后，就按照插件教程里的方法写配置，例子如下：</p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
</span><span id="__span-0-2"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">        </span><span class="nt">"platform"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BroadlinkRM"</span><span class="p">,</span>
</span><span id="__span-0-3"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Broadlink RM"</span><span class="p">,</span>
</span><span id="__span-0-4"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="nt">"accessories"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-0-5"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-0-6"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">                </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Air Conditioner"</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">                </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"air-conditioner"</span><span class="p">,</span>
</span><span id="__span-0-8"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">                </span><span class="nt">"noHumidity"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
</span><span id="__span-0-9"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">                </span><span class="nt">"minTemperature"</span><span class="p">:</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span>
</span><span id="__span-0-10"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">                </span><span class="nt">"maxTemperature"</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span>
</span><span id="__span-0-11"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">                </span><span class="nt">"defaultCoolTemperature"</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span>
</span><span id="__span-0-12"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">                </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-13"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">                        </span><span class="nt">"off"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2600..."</span><span class="p">,</span>
</span><span id="__span-0-14"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">                        </span><span class="nt">"cool28"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-15"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">                                </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2600..."</span>
</span><span id="__span-0-16"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-0-17"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">                        </span><span class="nt">"cool27"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-18"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">                                </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2600..."</span>
</span><span id="__span-0-19"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">                        </span><span class="p">},</span>
</span><span id="__span-0-20"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">                        </span><span class="nt">"cool26"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-21"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">                                </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2600..."</span>
</span><span id="__span-0-22"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-0-23"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-0-24"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">        </span><span class="p">}]</span>
</span><span id="__span-0-25"><a href="../../software/2021/07/24/homebridge-rm-mini-3/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就可以在手机上方便地控制空调温度了。测试了一下，可以用 Siri 说“设置空调为 XX 度”，也是完全可以工作的。</p>
<p>P.S. 小米的空气净化器现在可以用插件 https://github.com/torifat/xiaomi-mi-air-purifier#readme，之前博客里写的那一个已经不更新了。</p>
<nav class="md-post__action">
<a href="../../software/2021/07/24/homebridge-rm-mini-3/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-07-19 00:00:00">2021年7月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="../../misc/2021/07/19/sigs/">轶事一则</a></h2>
<p>7.17 号周六的时候，一位朋友 <a href="https://github.com/elenacliu">@elenacliu</a> 发现<a href="https://www.sigs.tsinghua.edu.cn/2020/0923/c118a21164/page.htm">深研院网站</a>的一个<a href="https://www.sigs.tsinghua.edu.cn/_upload/article/files/81/7c/a5c0421f4e418de32ef13701da95/448b40b3-87e2-4026-832e-28b113a01f4a.pdf">文档链接</a>，文档中标题写的是 2021，但是网页的标题显示的是 2006 年。于是我发邮件给深研院的招生办，抄送本部的研招办，提交了这个 issue。</p>
<p>7.19 号周一上午的时候，本部的研招办回复了一封邮件，没有理解我想表达的意思，可能以为我是要报考的学生，让我关注明年发布的文档。</p>
<p>7.19 号周一下午的时候，深研院招生办回复了邮件，说“谢谢你的反馈”，不过没有提到是否进行了修复。我晚上再查看页面的时候，发现<a href="https://www.sigs.tsinghua.edu.cn/_upload/article/files/81/7c/a5c0421f4e418de32ef13701da95/7917dd50-ad49-4664-a275-821fab3bfd87.pdf">新的文档链接</a>已经修复了问题。</p>
<nav class="md-post__action">
<a href="../../misc/2021/07/19/sigs/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-07-16 00:00:00">2021年7月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nginx-post-internal-server-error"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/">Nginx 处理 POST 请求出现 Internal Server Error 排查一则</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_1">前言</a></h3>
<p>最近一个服务忽然出现问题，用户反馈，HTTP POST 一个小的 body 不会出错，POST 一个大的 body 就会 500 Internal Server Error。</p>
<h3 id="_2"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_2">排查</a></h3>
<p>观察后端日志，发现没有出错的那一个请求。观察 Nginx 日志，发现最后一次日志是几个小时前。最后几条 Nginx 日志写的是 <code>a client request body is buffered to a temporary file</code>。</p>
<h3 id="_3"><a class="toclink" href="../../software/2021/07/16/nginx-post-internal-server-error/#_3">结论</a></h3>
<p>继续研究后，发现是硬盘满了。Nginx 在处理 POST body 的时候，如果 body 超过阈值，会写入到临时文件中：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Syntax: client_body_buffer_size size;
</span><span id="__span-0-2"><a href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>Default: client_body_buffer_size 8k|16k;
</span><span id="__span-0-3"><a href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>Context: http, server, location
</span><span id="__span-0-4"><a href="../../software/2021/07/16/nginx-post-internal-server-error/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file. By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.
</span></code></pre></div>
<p>详见 https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size</p>
<p>这就可以解释为什么 Nginx 返回 500 而且没有转发到后端，也可以解释为什么 Nginx 没有输出新的错误日志。</p>
<nav class="md-post__action">
<a href="../../software/2021/07/16/nginx-post-internal-server-error/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../8/">8</a> <a class="md-pagination__link" href="../9/">9</a> <span class="md-pagination__current">10</span> <a class="md-pagination__link" href="../11/">11</a> <a class="md-pagination__link" href="../12/">12</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
<script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>