
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/15/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-04-13 00:00:00">2020年4月13日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="sbt-fork"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/">在 sbt 中 fork 并且并行运行测试</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/#_1">问题</a></h3>
<p>最近在 sbt 使用遇到一个问题，有两个测试，分别用 testOnly 测试的时候没有问题，如果同时测试就会出问题，应该是全局的状态上出现了冲突。一个自然的解决思路是 fork，但是 sbt 默认 fork 之后 test 是顺序执行的，这会很慢。所以搜索了一下，找到了 fork 并且并行测试的方法。</p>
<h3 id="_2"><a class="toclink" href="../../software/2020/04/13/sbt-fork-parallel-test/#_2">解决方法</a></h3>
<p>解决方法在 sbt 文档中其实就有（<a href="https://www.scala-sbt.org/release/docs/Testing.html#Forking+testsl">原文</a>）。简单来说就是：把每个 test 放到单独的 TestGroup 中，每个 TestGroup 分别用一个 forked JVM 去运行；然后让 sbt 的并行限制设高一些：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// move each test into a group and fork them to avoid race condition</span>
</span><span id="__span-0-2"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="nc">Tests</span><span class="p">.</span><span class="n">_</span>
</span><span id="__span-0-3"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">singleTests</span><span class="p">(</span><span class="n">tests</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">TestDefinition</span><span class="p">])</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-0-4"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="n">tests</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-5"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">Group</span><span class="p">(</span>
</span><span id="__span-0-6"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-0-7"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">      </span><span class="n">tests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
</span><span id="__span-0-8"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">      </span><span class="nc">SubProcess</span><span class="p">(</span><span class="nc">ForkOptions</span><span class="p">()))</span>
</span><span id="__span-0-9"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-0-10"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">testGrouping</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">singleTests</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nc">Test</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">definedTests</span><span class="p">).</span><span class="n">value</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-0-12"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c1">// allow multiple concurrent tests</span>
</span><span id="__span-0-13"><a href="../../software/2020/04/13/sbt-fork-parallel-test/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="n">concurrentRestrictions</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Global</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span><span class="nc">Tags</span><span class="p">.</span><span class="n">limitAll</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></code></pre></div>
<p>这样就可以了。</p>
<nav class="md-post__action">
<a href="../../software/2020/04/13/sbt-fork-parallel-test/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-04-04 00:00:00">2020年4月4日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="vivado"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/">在命令行中进行 Vivado 仿真</a></h2>
<h3 id="vivado_1"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/#vivado_1">已有 Vivado 项目</a></h3>
<p>想要在命令行里进行 Vivado 仿真，所以查了下 Xilinx 的 UG900 文档，找到了命令行仿真的方法。首先是生成仿真所需的文件：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c">## assuming batch mode</span>
</span><span id="__span-0-2"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nv">open_project</span><span class="w"> </span>xxx.xpr
</span><span id="__span-0-3"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nv">set_property</span><span class="w"> </span>top<span class="w"> </span>YOUR_SIM_TOP<span class="w"> </span><span class="k">[</span><span class="nv">current_fileset</span><span class="w"> </span><span class="o">-</span>simset<span class="k">]</span>
</span><span id="__span-0-4"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nv">export_ip_user_files</span><span class="w"> </span><span class="o">-</span>no_script<span class="w"> </span><span class="o">-</span>force
</span><span id="__span-0-5"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nv">export_simulation</span><span class="w"> </span><span class="o">-</span>simulator<span class="w"> </span>xsim<span class="w"> </span><span class="o">-</span>force
</span></code></pre></div>
<p>可以把这些语句放到 tcl 文件里然后用 batch mode 执行。执行成功以后，会在 <code>export_sim/xsim</code> 目录下生成一些文件。里面会有生成的脚本以供仿真：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">cd</span><span class="w"> </span>export_sim/xsim<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>./YOUR_SIM_TOP.sh
</span></code></pre></div>
<p>默认情况下它会执行 export_sim/xsim/cmd.tcl 里面的命令。如果想要记录 vcd 文件，修改内容为：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-2-2"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nv">log_vcd</span>
</span><span id="__span-2-3"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nv">run</span><span class="w"> </span><span class="mi">20</span>us
</span><span id="__span-2-4"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-2-5"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>这样就可以把仿真的波形输出到 dump.vcd 文件，拖到本地然后用 GTKWave 看。更多支持的命令可以到 UG900 里找。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2020/04/04/vivado-simulation-command/#_1">无项目模式</a></h3>
<p>如果没有创建 Vivado 项目，也可以单独进行仿真，具体分为三个步骤：</p>
<ol>
<li>第一步，对每个源 Verilog 文件，运行 <code>xvlog module.v</code> 命令</li>
<li>第二步，生成 snapshot，运行 <code>xelab -debug all --snapshot snapshot_name top_module_name</code></li>
<li>第三步，仿真，运行 <code>xsim snapshot_name</code></li>
</ol>
<p>如果想要生成波形文件，编辑 <code>xsim.tcl</code> 为以下内容：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nv">open_vcd</span>
</span><span id="__span-3-2"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nv">log_vcd</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-3-3"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nv">run</span><span class="w"> </span><span class="o">-</span>all
</span><span id="__span-3-4"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nv">close_vcd</span>
</span><span id="__span-3-5"><a href="../../hardware/2020/04/04/vivado-simulation-command/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="nv">quit</span>
</span></code></pre></div>
<p>把第三步运行的命令改为：<code>xsim snapshot_name -tclbatch xsim.tcl</code> 即可。</p>
<nav class="md-post__action">
<a href="../../hardware/2020/04/04/vivado-simulation-command/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-03-17 00:00:00">2020年3月17日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="tencent-kubernetes-engine"><a class="toclink" href="../../devops/2020/03/17/setup-k8s-tencentcloud/">体验 Tencent Kubernetes Engine</a></h2>
<p>之前在机器上试验了一下 kubernetes，感觉挺不错的，所以就想把腾讯云上面的机器也交给 kubernetes 管理。找到容器服务，新建集群，选择模板里的标准托管集群就可以了。然后开启下面的公网访问，设置一个比较小的 IP 地址段，按照页面下面的要求合并一下 kube config（因为还有别的 k8s cluster）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>~/.kube/config:/path/to/new/config<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--merge<span class="w"> </span>--flatten<span class="w"> </span>&gt;<span class="w"> </span>new_config
</span><span id="__span-0-2"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>cp<span class="w"> </span>new_config<span class="w"> </span>~/.kube/config
</span></code></pre></div>
<p>覆盖之前先确认原来的配置还在，然后就可以用 kubectl 切换到新的 context：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts
</span><span id="__span-1-2"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>new-context-here
</span><span id="__span-1-3"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>node
</span><span id="__span-1-4"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>NAME<span class="w">          </span>STATUS<span class="w">   </span>ROLES<span class="w">    </span>AGE<span class="w">   </span>VERSION
</span><span id="__span-1-5"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="m">172</span>.21.0.17<span class="w">   </span>Ready<span class="w">    </span>&lt;none&gt;<span class="w">   </span>75m<span class="w">   </span>v1.16.3-tke.3
</span></code></pre></div>
<p>可以看到我们的 k8s node 已经上线了。我一般习惯先配好 kubernetes-dashboard：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/cilium/cilium/v1.6/install/kubernetes/quick-install.yaml
</span><span id="__span-2-2"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>proxy<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-2-3"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>describe<span class="w"> </span>secret<span class="w"> </span><span class="o">(</span>kubectl<span class="w"> </span>-n<span class="w"> </span>kubernetes-dashboard<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>admin-user<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print \$1}'</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print \$2}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>pbcopy
</span></code></pre></div>
<p>然后在浏览器里访问 http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/overview?namespace=default 然后把剪贴板里的 token 粘贴进去即可。</p>
<p>默认情况下 kubernetes-dashboard 的权限比较少，可以让它获得更多权限：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>edit<span class="w"> </span>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard
</span><span id="__span-3-2"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">## use '*' for ultimate </span>
</span><span id="__span-3-3"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1">## use `kubectl get clusterrole.rbac.authorization.k8s.io/cluster-admin -o yaml` to see full permissions</span>
</span></code></pre></div>
<p>接下来配置 metrics-server。下载 metrics-server 仓库，然后修改镜像地址：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://github.com/kubernetes-sigs/metrics-server/archive/v0.3.6.zip
</span><span id="__span-4-2"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>$<span class="w"> </span>unar<span class="w"> </span>v0.3.6.zip
</span><span id="__span-4-3"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>metrics-server-0.3.6/deploy/1.8+
</span><span id="__span-4-4"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>$<span class="w"> </span>vim<span class="w"> </span>metrics-server-deployment
</span><span id="__span-4-5"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1">## change: k8s.gcr.io/metrics-server-amd64:v0.3.6</span>
</span><span id="__span-4-6"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="c1">## to: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span>
</span><span id="__span-4-7"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c1">## add line below image: args: ["--kubelet-insecure-tls"]</span>
</span><span id="__span-4-8"><a href="../../devops/2020/03/17/setup-k8s-tencentcloud/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>.
</span></code></pre></div>
<p>等一段时间，就可以看到 metrics server 正常运行了。</p>
<p>参考：https://tencentcloudcontainerteam.github.io/tke-handbook/</p>
<nav class="md-post__action">
<a href="../../devops/2020/03/17/setup-k8s-tencentcloud/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-03-17 00:00:00">2020年3月17日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rocket-chip-tlram"><a class="toclink" href="../../hardware/2020/03/17/rocket-chip-tlram-load/">在 Rocket Chip 上挂接 TLRAM</a></h2>
<p>最近遇到一个需求，需要在 Rocket Chip 里面开辟一块空间，通过 verilog 的 $readmemh 来进行初始化而不是用 BootROM，这样每次修改内容不需要重新跑一次 Chisel -&gt; Verilog 的流程。然后到处研究了一下，找到了解决的方案：</p>
<p>首先是新建一个 TLRAM 然后挂接到 cbus 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLRAM</span>
</span><span id="__span-0-2"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLFragmenter</span>
</span><span id="__span-0-3"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">LazyModule</span>
</span><span id="__span-0-4"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">AddressSet</span>
</span><span id="__span-0-5"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="k">trait</span><span class="w"> </span><span class="nc">HasTestRAM</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">BaseSubsystem</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-7"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">testRAM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LazyModule</span><span class="p">(</span>
</span><span id="__span-0-8"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">TLRAM</span><span class="p">(</span><span class="nc">AddressSet</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1FFF</span><span class="p">),</span><span class="w"> </span><span class="n">beatBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">beatBytes</span><span class="p">)</span>
</span><span id="__span-0-9"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-0-10"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="n">testRAM</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">coupleTo</span><span class="p">(</span><span class="s">"bootrom"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">TLFragmenter</span><span class="p">(</span><span class="n">cbus</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-12"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的地址和大小都可以自由定义。然后添加到自己的 Top Module 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">(</span><span class="k">implicit</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="nc">Parameters</span><span class="p">)</span>
</span><span id="__span-1-2"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSystem</span>
</span><span id="__span-1-3"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-1-4"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="k">with</span><span class="w"> </span><span class="nc">HasTestRAM</span>
</span><span id="__span-1-5"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-1-6"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-7"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">lazy</span><span class="w"> </span><span class="p">...</span><span class="w">    </span>
</span><span id="__span-1-8"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上这时候 TLRAM 就已经加入到了 TileLink 总线中。接着，为了让 firrtl 生成 $readmemh 的代码，需要两个步骤：</p>
<p>首先是用 <code>chisel3.util.experimental.loadMemoryFromFile</code> 函数（文档在 https://github.com/freechipsproject/chisel3/wiki/Chisel-Memories）：</p>
<p>UPDATE：现在的文档在 <a href="https://www.chisel-lang.org/chisel3/docs/appendix/experimental-features#loading-memories-for-simulation-or-fpga-initialization-">Loading Memories for simulation or FPGA initialization</a> 处，并且可以用 loadMemoryFromFileInline。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTopImp</span><span class="p">(</span><span class="n">outer</span><span class="p">:</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">)</span>
</span><span id="__span-2-2"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSubsystemModuleImp</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
</span><span id="__span-2-3"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-2-4"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-5"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">loadMemoryFromFile</span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">testRAM</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="s">"test.hex"</span><span class="p">)</span><span class="w">    </span>
</span><span id="__span-2-6"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数会生成一个 FIRRTL Annotation，记录了在这里需要对这个 mem 生成对应的 readmemh 调用。然后在 firrtl 的调用里传入 .anno.json 和 transform：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>runMain<span class="w"> </span>firrtl.stage.Main<span class="w"> </span>-i<span class="w"> </span>xxx<span class="w"> </span>-o<span class="w"> </span>xxx<span class="w"> </span>-X<span class="w"> </span>verilog<span class="w"> </span>-faf<span class="w"> </span>/path/to/xxx.anno.json<span class="w"> </span>-fct<span class="w"> </span>chisel3.util.experimental.LoadMemoryTransform
</span></code></pre></div>
<p>UPDATE: 现在不需要 <code>-fct chisel3.util.experimental.LoadMemoryTransform</code> 参数。目前这个功能和生成 blackbox memory 有冲突，不能同时使用，需要等 chisel3 后续修复。</p>
<p>这里的 chisel3.util.experimental.LoadMemoryTransform 会找到 anno.json 里面对应的 Annotation，然后生成类似下面这样的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">module</span><span class="w"> </span><span class="n">xxx</span><span class="p">(</span>
</span><span id="__span-4-2"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-4-3"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">);</span>
</span><span id="__span-4-4"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-4-5"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nb">$readmemh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">mem_xxx</span><span class="p">);</span>
</span><span id="__span-4-6"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="k">endmodule</span>
</span><span id="__span-4-7"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="n">bind</span><span class="w"> </span><span class="n">TLRAM</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="n">xxx</span><span class="p">(.</span><span class="o">*</span><span class="p">);</span>
</span></code></pre></div>
<p>这里采用了 Verilog 的 bind 功能，可以在不修改模块代码的时候注入，比如上面，就是注入了一个语句 $readmemh，从而达到目的。</p>
<nav class="md-post__action">
<a href="../../hardware/2020/03/17/rocket-chip-tlram-load/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-03-14 00:00:00">2020年3月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="kubernetes-gitlabrunner"><a class="toclink" href="../../devops/2020/03/14/k8s-gitlab-runner/">在 Kubernetes 集群上部署 gitlab—runner</a></h2>
<p>按照 GitLab 上的教程试着把 gitlab-runner 部署到 k8s 集群上，发现异常地简单，所以简单做个笔记：</p>
<p>编辑 <code>values.yaml</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>gitlabUrl: GITLAB_URL
</span><span id="__span-0-2"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>runnerRegistrationToken: "REDACTED"
</span><span id="__span-0-3"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>rbac:
</span><span id="__span-0-4"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>    create: true
</span></code></pre></div>
<p>此处的信息按照 "Set up a specific Runner manually" 下面的提示填写。然后用 Helm 进行安装：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>gitlab<span class="w"> </span>https://charts.gitlab.io
</span><span id="__span-1-2"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>gitlab-runner
</span><span id="__span-1-3"><a href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>$<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>gitlab-runner<span class="w"> </span>gitlab-runner<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>gitlab/gitlab-runner
</span></code></pre></div>
<p>然后去 Kubernetes Dashboard 就可以看到部署的情况，回到 GitLab 也可以看到出现了“Runners activated for this project” ，表示配置成功。</p>
<p>参考配置：https://docs.gitlab.com/runner/install/kubernetes.html</p>
<nav class="md-post__action">
<a href="../../devops/2020/03/14/k8s-gitlab-runner/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-03-10 00:00:00">2020年3月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="kubernetes"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/">用 Kubernetes 部署无状态服务</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#_1">背景</a></h3>
<p>最近需要部署一个用来跑编译的服务，服务从 MQ 取任务，编译完以后提交任务。最初的做法是包装成 docker，然后用 docker-compose 来 scale up。但既然有 k8s 这么好的工具，就试着学习了一下，踩了很多坑，总结了一些需要用到的命令。</p>
<h3 id="docker-registry"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#docker-registry">搭建 Docker Registry</a></h3>
<p>首先搭建一个本地的 Docker Repository，首先设置密码：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>mkdir<span class="w"> </span>auth
</span><span id="__span-0-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>user<span class="w"> </span>pass<span class="w"> </span>&gt;<span class="w"> </span>auth/passwd
</span></code></pre></div>
<p>然后运行 registry：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">5000</span>:5000<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">        </span>--restart<span class="o">=</span>always<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-3"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">        </span>--name<span class="w"> </span>registry<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-4"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span>-v<span class="w"> </span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/registry"</span>:/var/lib/registry<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-5"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span>-v<span class="w"> </span><span class="s2">"</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/auth"</span>:/auth<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-6"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span>-e<span class="w"> </span><span class="s2">"REGISTRY_AUTH=htpasswd"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span>-e<span class="w"> </span><span class="s2">"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-8"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span>-e<span class="w"> </span><span class="nv">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="o">=</span>/auth/htpasswd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-9"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">        </span>registry:2
</span></code></pre></div>
<p>简单起见没有配 tls。然后吧本地的 image push 上去：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>docker<span class="w"> </span>tag<span class="w"> </span><span class="nv">$image</span><span class="w"> </span>localhost:5000/<span class="nv">$image</span>
</span><span id="__span-2-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>$<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/<span class="nv">$image</span>
</span></code></pre></div>
<p>这样就可以了。</p>
<h3 id="k8s"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#k8s">搭建 k8s 环境</a></h3>
<p>考虑到只用了单个物理机，所以采用的是 minikube。首先下载 minikube，下载方法略去。</p>
<p>接着新建 minikube 虚拟机：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>minikube<span class="w"> </span>start<span class="w"> </span>--registry-mirror<span class="o">=</span>https://registry.docker-cn.com<span class="w"> </span>--image-mirror-country<span class="o">=</span>cn<span class="w"> </span>--image-repository<span class="o">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers<span class="w"> </span>--vm-driver<span class="o">=</span>kvm2<span class="w"> </span>--insecure-registry<span class="o">=</span><span class="s2">"0.0.0.0/0"</span><span class="w"> </span>--disk-size<span class="o">=</span>50GB<span class="w"> </span>--cpus<span class="w"> </span><span class="m">128</span><span class="w"> </span>--memory<span class="w"> </span><span class="m">131072</span>
</span></code></pre></div>
<p>这里的 0.0.0.0/0 可以缩小，磁盘、CPU 和内存需要在这里就设好，之后不能改，要改只能重新开个虚拟机，不过这个过程也挺快的。</p>
<p>然后初始化一些组件（metrics server 和 kubernetes dashboard）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>minikube<span class="w"> </span>addons<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>metrics-server
</span><span id="__span-4-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>$<span class="w"> </span>minikube<span class="w"> </span>dashboard
</span></code></pre></div>
<p>如果要访问 dashboard 的话，可以用上面命令输出的链接，或者用 <code>kubectl proxy</code> 然后打开  http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ （注意 http 还是 https）。</p>
<p>如果问到 Access Token，可以用以下 alias 获得（fish/macOS）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span><span class="nb">alias</span><span class="w"> </span><span class="nv">kubedashboard</span><span class="o">=</span><span class="s2">"kubectl -n kubernetes-dashboard describe secret (kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print \$1}') | tail -n1 | awk '{print \$2}' | pbcopy"</span>
</span></code></pre></div>
<p>接着，配置一下 docker registry 的密钥：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>regcred<span class="w"> </span>--from-file<span class="o">=</span>.dockerconfigjson<span class="o">=</span>/path/to/config.json<span class="w">  </span>--type<span class="o">=</span>kubernetes.io/dockerconfigjson
</span></code></pre></div>
<p>然后，在 Pod/Deployment 里面设定镜像：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>containers:
</span><span id="__span-7-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>  - name: name
</span><span id="__span-7-3"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>    image: IP:5000/image
</span><span id="__span-7-4"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>imagePullSecrets:
</span><span id="__span-7-5"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>  - name: regcred
</span></code></pre></div>
<p>然后部署即可。</p>
<h3 id="hpa"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#hpa">部署水平自动伸缩（HPA）</a></h3>
<p>这一步配置的是自带的 HPA 功能，需要上述的 metrics-server 打开，并且在 Pod/Deployment 里面写明 resources.requests.cpu:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>- name: name
</span><span id="__span-8-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>  resources:
</span><span id="__span-8-3"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>    requests:
</span><span id="__span-8-4"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>      cpu: "xxx"
</span></code></pre></div>
<p>然后创建 HPA 即可：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>autoscale<span class="w"> </span>deployment<span class="w"> </span><span class="nv">$deployment</span><span class="w"> </span>--cpu-percent<span class="o">=</span><span class="m">50</span><span class="w"> </span>--min<span class="o">=</span><span class="m">1</span><span class="w"> </span>--max<span class="o">=</span><span class="m">10</span>
</span></code></pre></div>
<p>通过压测，可以看到自动伸缩的记录：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>hpa
</span><span id="__span-10-2"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>Normal<span class="w">  </span>SuccessfulRescale<span class="w">  </span>22s<span class="w">   </span>horizontal-pod-autoscaler<span class="w">  </span>New<span class="w"> </span>size:<span class="w"> </span><span class="m">4</span><span class="p">;</span><span class="w"> </span>reason:<span class="w"> </span>cpu<span class="w"> </span>resource<span class="w"> </span>utilization<span class="w"> </span><span class="o">(</span>percentage<span class="w"> </span>of<span class="w"> </span>request<span class="o">)</span><span class="w"> </span>above<span class="w"> </span>target
</span><span id="__span-10-3"><a href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>Normal<span class="w">  </span>SuccessfulRescale<span class="w">  </span>6s<span class="w">     </span>horizontal-pod-autoscaler<span class="w">  </span>New<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>reason:<span class="w"> </span>All<span class="w"> </span>metrics<span class="w"> </span>below<span class="w"> </span>target
</span></code></pre></div>
<p>参考：Kubernetes 官方文档</p>
<nav class="md-post__action">
<a href="../../devops/2020/03/10/k8s-deploy-with-hpa/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-03-09 00:00:00">2020年3月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="jailkit-scp"><a class="toclink" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/">用 jailkit 限制用户仅 scp</a></h2>
<p>最近需要用 scp 部署到生产机器，但又不想出现安全问题，所以用了 jailkit 的方法。首先是创建单独的用户，然后生成 ssh key 来认证，不再赘述。此时是可以 scp 了，但用户依然可以获得 shell，不够安全。</p>
<p>然后找到了下面参考链接，大概摘录一下所需要的命令和配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>mkdir<span class="w"> </span>/path/to/jail
</span><span id="__span-0-2"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>chown<span class="w"> </span>root:root<span class="w"> </span>/path/to/jail
</span><span id="__span-0-3"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>chmod<span class="w"> </span><span class="m">701</span><span class="w"> </span>/path/to/jail
</span><span id="__span-0-4"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>jk_init<span class="w"> </span>-j<span class="w"> </span>/path/to/jail<span class="w"> </span>scp<span class="w"> </span>sftp<span class="w"> </span>jk_lsh
</span><span id="__span-0-5"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>jk_jailuser<span class="w"> </span>-m<span class="w"> </span>-j<span class="w"> </span>/path/to/jail<span class="w"> </span>jailed_user
</span><span id="__span-0-6"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>vim<span class="w"> </span>/path/to/jail/etc/jailkit/jk_lsh.ini
</span><span id="__span-0-7"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="c1">## Add following lines</span>
</span><span id="__span-0-8"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="o">[</span>jailed_user<span class="o">]</span>
</span><span id="__span-0-9"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nv">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/bin,<span class="w"> </span>/usr/lib
</span><span id="__span-0-10"><a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nv">exectuables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/bin/scp
</span></code></pre></div>
<p>之后可以发现该用户的 shell 已经更改 jk_chrootsh，并且只能用 scp。</p>
<p>参考：https://blog.tinned-software.net/restrict-linux-user-to-scp-to-his-home-directory/</p>
<nav class="md-post__action">
<a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-28 00:00:00">2020年2月28日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="56"><a class="toclink" href="../../misc/2020/02/28/weekly-sharing-56/">每周分享第 56 期</a></h2>
<p>咕咕咕</p>
<ol>
<li>SystemVerilog linter https://github.com/dalance/svlint</li>
<li>东北方言编程语言 https://github.com/zhanyong-wan/dongbei</li>
<li>JS LaTeX 渲染到 HTML https://github.com/michael-brade/LaTeX.js</li>
<li>一种对语音助手的攻击 https://surfingattack.github.io/</li>
<li>在线打铃网站 http://thulpwan.net/timer/</li>
<li>网络学堂 PC 端 App https://github.com/jiegec/learn_tsinghua_app/releases</li>
<li>Rust 2020 roadmap https://github.com/rust-lang/rfcs/pull/2857/files</li>
</ol>
<nav class="md-post__action">
<a href="../../misc/2020/02/28/weekly-sharing-56/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-10 00:00:00">2020年2月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="bscan-jtag-rocket-chip"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/">通过 BSCAN JTAG 对 Rocket Chip 进行调试</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#_1">前言</a></h3>
<p>在上一个 <a href="/hardware/2020/02/09/rocket-chip-bscan-analysis/">post</a> 里研究了原理，今天也是成功在 Artix 7 上实现了调试。效果如下：</p>
<p>OpenOCD 输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Info : JTAG tap: riscv.cpu tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)
</span><span id="__span-0-2"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>Info : datacount=1 progbufsize=16
</span><span id="__span-0-3"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>Info : Disabling abstract command reads from CSRs.
</span><span id="__span-0-4"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>Info : Examined RISC-V core; found 1 harts
</span><span id="__span-0-5"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>Info :  hart 0: XLEN=32, misa=0x40801105
</span><span id="__span-0-6"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>Info : Listening on port 3333 for gdb connections
</span></code></pre></div>
<p>GDB 输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>Remote debugging using localhost:3333
</span><span id="__span-1-2"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>0x0001018c in getc () at bootloader.c:36
</span><span id="__span-1-3"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>36        while (!(*UART_LSR &amp; 0x1))
</span><span id="__span-1-4"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>(gdb) 
</span></code></pre></div>
<p>这里用的 OpenOCD 和 GDB 都是 riscv 版本，上游的支持尚不完善。对于 Homebrew 用户，我在 <a href="https://github.com/jiegec/homebrew-formulas">jiegec/homebrew-formulas</a> 维护了需要的 Formula。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#_2">过程</a></h3>
<p>代码基本借鉴了 <a href="https://github.com/sequencer/rocket-playground/tree/7fa3c51113be607add2034f3abe0ae973caac04a">sequencer/rocket-playground</a> 和 <a href="https://github.com/KireinaHoro/rocket-zcu102/tree/ab9112c951eeeb64482716394d926777862d9e86">KireinaHoro/rocket-zcu102</a> 而来，代码方面主要是添加了 <a href="https://github.com/jiegec/rocket2thinpad/blob/ad1e86620c54bc0be29d08394d04f70031718b6d/src/main/scala/BscanJTAG.scala#L1">BscanJTAG.scala</a>，然后在 Top 模块下把它连接到内部的 JTAG 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">boardJTAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">BscanJTAG</span><span class="p">)</span>
</span><span id="__span-2-2"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">jtagBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">head</span>
</span><span id="__span-2-3"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
</span><span id="__span-2-4"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c1">// set JTAG parameters</span>
</span><span id="__span-2-5"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span>
</span><span id="__span-2-6"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x233</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-7"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-8"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-9"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="c1">// connect to BSCAN</span>
</span><span id="__span-2-10"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tck</span>
</span><span id="__span-2-11"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tms</span>
</span><span id="__span-2-12"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdi</span>
</span><span id="__span-2-13"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="p">.</span><span class="n">data</span>
</span><span id="__span-2-14"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdoEnable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="p">.</span><span class="n">driven</span>
</span></code></pre></div>
<p>代码方面就足够了。然后，需要一个 riscv-openocd 和 riscv-gdb，分别从上游 repo 编译得来。然后采用以下的 openocd.cfg：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>adapter_khz 20000
</span><span id="__span-3-2"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>interface ftdi
</span><span id="__span-3-3"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>ftdi_vid_pid 0x0403 0x6014
</span><span id="__span-3-4"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>ftdi_layout_init 0x00e8 0x60eb
</span><span id="__span-3-5"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>ftdi_tdo_sample_edge falling
</span><span id="__span-3-6"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>reset_config none
</span><span id="__span-3-7"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>set _CHIPNAME riscv
</span><span id="__span-3-9"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>jtag newtap $_CHIPNAME cpu -irlen 6
</span><span id="__span-3-10"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>set _TARGETNAME $_CHIPNAME.cpu
</span><span id="__span-3-12"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>
</span><span id="__span-3-13"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>target create $_TARGETNAME.0 riscv -chain-position $_TARGETNAME
</span><span id="__span-3-14"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>$_TARGETNAME.0 configure -work-area-phys 0x80000000 -work-area-size 10000 -work-area-backup 1
</span><span id="__span-3-15"><a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>riscv use_bscan_tunnel 5
</span></code></pre></div>
<p>然后就可以用 GDB 调试了。</p>
<nav class="md-post__action">
<a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-10 00:00:00">2020年2月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="vivado-chisel3-verilog"><a class="toclink" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/">在 Vivado 中对 chisel3 产生的 verilog 代码仿真</a></h2>
<p>默认情况下，chisel3 生成的 verilog 代码在 Vivado 中仿真会出现很多信号大面积变成 X。解决方法在一个不起眼的 Wiki 页面：<a href="https://github.com/freechipsproject/chisel3/wiki/Randomization-flags">Randomization flags</a>：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">`define RANDOMIZE_REG_INIT</span>
</span><span id="__span-0-2"><a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cp">`define RANDOMIZE_MEM_INIT</span>
</span><span id="__span-0-3"><a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="cp">`define RANDOMIZE_GARBAGE_ASSIGN</span>
</span><span id="__span-0-4"><a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="cp">`define RANDOMIZE_INVALID_ASSIGN</span>
</span></code></pre></div>
<p>在生成的 verilog 前面加上这四句，就可以正常仿真了。</p>
<nav class="md-post__action">
<a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../13/">13</a> <a class="md-pagination__link" href="../14/">14</a> <span class="md-pagination__current">15</span> <a class="md-pagination__link" href="../16/">16</a> <a class="md-pagination__link" href="../17/">17</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>