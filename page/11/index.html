
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/11/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-06-25 00:00:00">2021年6月25日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="k8s-rook-ceph-cephadm"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/">将 k8s rook ceph 集群迁移到 cephadm</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_1">背景</a></h3>
<p>前段时间用 rook 搭建了一个 k8s 内部的 ceph 集群，但是使用过程中遇到了一些稳定性问题，所以想要用 cephadm 重建一个 ceph 集群。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_2">重建过程</a></h3>
<p>重建的时候，我首先用 cephadm 搭建了一个 ceph 集群，再把原来的 MON 数据导入，再恢复各个 OSD。理论上，可能有更优雅的办法，但我还是慢慢通过比较复杂的办法解决了。</p>
<h4 id="cephadm-ceph"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#cephadm-ceph">cephadm 搭建 ceph 集群</a></h4>
<p>首先，配置 <a href="https://mirrors.tuna.tsinghua.edu.cn/help/ceph/">TUNA 源</a>，在各个节点上安装 <code>docker-ce</code> 和 <code>cephadm</code>。接着，在主节点上 bootstrap：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>cephadm<span class="w"> </span>bootstrap<span class="w"> </span>--mon-ip<span class="w"> </span>HOST1_IP
</span></code></pre></div>
<p>此时，在主节点上会运行最基础的 ceph 集群，不过此时还没有任何数据。寻找 ceph 分区，会发现因为 FSID 不匹配而无法导入。所以，首先要恢复 MON 数据。</p>
<p>参考文档：<a href="https://docs.ceph.com/en/latest/cephadm/install/">cephadm install</a>。</p>
<h4 id="mon"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#mon">恢复 MON 数据</a></h4>
<p>首先，关掉 rook ceph 集群，找到留存下来的 MON 数据目录，默认路径是 <code>/var/lib/rook</code> 下的 <code>mon-[a-z]</code> 目录，找到最新的一个即可。我把目录下的路径覆盖到 cephadm 生成的 MON 目录下，然后跑起来，发现有几个问题：</p>
<ol>
<li>cephadm 生成的 /etc/ceph/ceph.client.admin.keyring 与 MON 中保存的 auth 信息不匹配，导致无法访问</li>
<li>FSID 不一致，而 cephadm 会将各个设置目录放到 <code>/var/lib/ceph/$FSID</code> 下</li>
</ol>
<p>第一个问题的解决办法就是临时用 MON 目录下的 keyring 进行认证，再创建一个新的 client.admin 认证。第二个问题的解决办法就是将遇到的各种 cephadm 生成的 FSID 替换为 MON 中的 FSID，包括目录名、各个目录下 unit.run 中的路径和 systemd unit 的名称。</p>
<p>进行一系列替换以后，原来的 MON 已经起来了，可以看到原来保留的各个 pool 和 cephfs 信息。</p>
<h4 id="_3"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#_3">扩展到多节点</a></h4>
<p>接下来，由于 MON 中保存的数据更新了，所以要重新生成 cephadm 的 SSH 密钥。将 SSH 密钥复制到各节点后，再用 cephadm 的 orch 功能部署到其他节点上。此时 FSID 都已经是 MON 中的 FSID，不需要替换。此时可以在 <code>ceph orch ps</code> 命令中看到在各个节点上运行的程序。接下来，还需要恢复各个 OSD。</p>
<h4 id="osd"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#osd">导入 OSD</a></h4>
<p>为了从 ceph 分区从导出 OSD 的配置文件，需要用 <code>ceph-volume</code> 工具。这个工具会生成一个 <code>/var/lib/ceph/osd-ID</code> 目录，在 cephadm 的概念里属于 legacy，因此我们首先要把路径 mount 到 shell 里面：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>cephadm<span class="w"> </span>shell<span class="w"> </span>--mount<span class="w"> </span>/var/lib/ceph:/var/lib/ceph
</span></code></pre></div>
<p>接着，生成 osd 目录配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>ceph-volume<span class="w"> </span>lvm<span class="w"> </span>activate<span class="w"> </span>--all<span class="w"> </span>--no-systemd
</span></code></pre></div>
<p>然后，可以看到创建了对应的 osd 路径，再用 cephadm 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2021/06/25/ceph-k8s-to-external/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>osd.ID
</span></code></pre></div>
<p>这样就可以用 cephadm 管理了。</p>
<h3 id="k8s"><a class="toclink" href="../../devops/2021/06/25/ceph-k8s-to-external/#k8s">配置 k8s</a></h3>
<p>配置好外部 ceph 集群后，还需要配置 k8s rook。</p>
<p>参考 <a href="https://rook.github.io/docs/rook/v1.8/ceph-cluster-crd.html#external-cluster">https://rook.github.io/docs/rook/v1.8/ceph-cluster-crd.html#external-cluster</a>，大概有这么几步：</p>
<ol>
<li>在 ceph 集群上运行 create-external-cluster-resources.sh，创建用户，并且导出 key</li>
<li>在 k8s 集群上应用第一步生成的环境变量，然后运行 import-external-cluster.sh</li>
<li>复制一份 cluster-external.yaml 然后应用</li>
<li>复制 storageclass.yaml，把里面的 namespace 改成 rook-ceph-external</li>
</ol>
<nav class="md-post__action">
<a href="../../devops/2021/06/25/ceph-k8s-to-external/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-06-23 00:00:00">2021年6月23日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="c-11-abi"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/">C++ 11 的 ABI 问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#_1">背景</a></h3>
<p>有同学遇到这样的一个问题，代码中链接了一个第三方的动态库，在链接的时候出现了不一致的问题，比如有一个函数签名如下：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">foobar</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</span></code></pre></div>
<p>使用 GCC 11.1.0 编译上面的代码，可以发现它需要的符号是 <code>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE</code>，但是第三方库里面却是 <code>_Z6foobarSs</code>，因此找不到对应的符号，链接失败。</p>
<h3 id="_2"><a class="toclink" href="../../programming/2021/06/23/cpp-11-abi-problem/#_2">问题</a></h3>
<p>经过一番研究，发现 <code>Ss</code> 在 <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">Itanium ABI</a> 中表示的是缩写：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>In addition, the following catalog of abbreviations of the form "Sx" are used:
</span><span id="__span-1-2"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>   &lt;substitution&gt; ::= St # ::std::
</span><span id="__span-1-5"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>   &lt;substitution&gt; ::= Sa # ::std::allocator
</span><span id="__span-1-6"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>   &lt;substitution&gt; ::= Sb # ::std::basic_string
</span><span id="__span-1-7"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>   &lt;substitution&gt; ::= Ss # ::std::basic_string &lt; char,
</span><span id="__span-1-8"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>                         ::std::char_traits&lt;char&gt;,
</span><span id="__span-1-9"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>                         ::std::allocator&lt;char&gt; &gt;
</span><span id="__span-1-10"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>   &lt;substitution&gt; ::= Si # ::std::basic_istream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-11"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>   &lt;substitution&gt; ::= So # ::std::basic_ostream&lt;char,  std::char_traits&lt;char&gt; &gt;
</span><span id="__span-1-12"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>   &lt;substitution&gt; ::= Sd # ::std::basic_iostream&lt;char, std::char_traits&lt;char&gt; &gt;
</span></code></pre></div>
<p>这看起来很正常，<code>_Z6foobarSs</code> 表示的是 <code>foobar(std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>，但是 GCC 11.1.0 编译出来的上面的代码却没有用这个符号，而是 <code>foobar(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;)</code>。差别就在于 <code>__cxx11</code> 中。</p>
<p>经过一番搜索，找到了 GCC <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_dual_abi.html">关于这个问题的文档</a>和<a href="https://developers.redhat.com/blog/2015/02/05/gcc5-and-the-c11-abi">网上的文章</a>，找到了原因：从 GCC5 开始，为了兼容 C++11 标准的改变，做了这个变动。如果要恢复原来的行为，需要添加一个定义：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>g++<span class="w"> </span>-D_GLIBCXX_USE_CXX11_ABI<span class="o">=</span><span class="m">0</span><span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-2"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span><span id="__span-2-3"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>$<span class="w"> </span>g++<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-4"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
</span><span id="__span-2-5"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">## install g++-4.9 in ubuntu 16.04</span>
</span><span id="__span-2-6"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>$<span class="w"> </span>g++-4.9<span class="w"> </span>-c<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>test.o<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>nm<span class="w"> </span>test.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>foobar
</span><span id="__span-2-7"><a href="../../programming/2021/06/23/cpp-11-abi-problem/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>_Z6foobarSs
</span></code></pre></div>
<p>这样就可以正常链接到第三方的动态库了。</p>
<nav class="md-post__action">
<a href="../../programming/2021/06/23/cpp-11-abi-problem/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-05-06 00:00:00">2021年5月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="../../hardware/2021/05/06/disk/">硬盘相关的概念</a></h2>
<h3 id="ata"><a class="toclink" href="../../hardware/2021/05/06/disk/#ata">ATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Parallel_ATA">ATA</a> 定义了发送给硬盘的命令，<a href="https://people.freebsd.org/~imp/asiabsdcon2015/works/d2161r5-ATAATAPI_Command_Set_-_3.pdf">标准</a>定义了命令：</p>
<ul>
<li>ech IDENTIFY DEVICE: 获取设备信息</li>
<li>25h READ DMA EXT: 读取扇区</li>
<li>35h WRITE DMA EXT: 写入扇区</li>
</ul>
<p>ATA 同时也是接口，图片如下。ATA 前身是 IDE，现在 ATA 叫做 PATA。</p>
<p><img alt="PATA Pin" src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/ATA_Plug.svg/600px-ATA_Plug.svg.png"/></p>
<h3 id="ahci"><a class="toclink" href="../../hardware/2021/05/06/disk/#ahci">AHCI</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Advanced_Host_Controller_Interface">AHCI</a> 可以简单理解为 PCIe &lt;-&gt; SATA 的转换器。AHCI 暴露为一个 PCIe 设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2021/05/06/disk/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>lspci<span class="w"> </span>-vv
</span><span id="__span-0-2"><a href="../../hardware/2021/05/06/disk/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="m">00</span>:1f.2<span class="w"> </span>SATA<span class="w"> </span>controller:<span class="w"> </span>Intel<span class="w"> </span>Corporation<span class="w"> </span>C600/X79<span class="w"> </span>series<span class="w"> </span>chipset<span class="w"> </span><span class="m">6</span>-Port<span class="w"> </span>SATA<span class="w"> </span>AHCI<span class="w"> </span>Controller<span class="w"> </span><span class="o">(</span>rev<span class="w"> </span><span class="m">05</span><span class="o">)</span>
</span><span id="__span-0-3"><a href="../../hardware/2021/05/06/disk/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span>Kernel<span class="w"> </span>modules:<span class="w"> </span>ahci
</span></code></pre></div>
<p>处理器通过 IO port/MMIO 访问 AHCI，然后 AHCI HBA 连接到 SATA 设备。</p>
<h3 id="sata"><a class="toclink" href="../../hardware/2021/05/06/disk/#sata">SATA</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Serial_ATA">SATA</a> 一般说的是接口。它一般分为两个部分，数据和电源。数据部分只有 7 个 pin，三个 GND 和两对差分线（A+A- B+B-），图片如下：</p>
<p><img alt="SATA Data" src="https://upload.wikimedia.org/wikipedia/commons/e/ef/SATA_Data_Cable.jpg"/></p>
<p>电源部分有 15 个 pin，有 GND 3.3V 5V 和 12V，图片如下：</p>
<p><img alt="SATA Power" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/SATA_power_cable.jpg/400px-SATA_power_cable.jpg"/></p>
<p>常见的 SATA 盘有 2.5 英寸（small form factor, SFF）和 3.5 英寸（large form factor，LFF）两种规格。</p>
<h3 id="m2"><a class="toclink" href="../../hardware/2021/05/06/disk/#m2">M.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/M.2">M.2</a> 又称 NGFF，有不同的 key 类型。常见的是 B 和 M：</p>
<ul>
<li>B key: 12-19 notched, PCIe x2, SATA</li>
<li>M key: 59-66 notched, PCIe x4, SATA</li>
</ul>
<p>都有部分引脚的位置是空的：</p>
<p><img alt="M.2" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ed/M2_Edge_Connector_Keying.svg/620px-M2_Edge_Connector_Keying.svg.png"/></p>
<p>在<a href="https://pinoutguide.com/HD/M.2_NGFF_connector_pinout.shtml">这里</a>可以看到两种 key 的 pinout。</p>
<ul>
<li>B key: SATA pin B(41,43) A(47,49), PCIe x2 pin R1(29,31) T1(35,37) R0(41,43) T0(47,49), USB 3.0 pin TX(29, 31) RX(35,37)</li>
<li>M key: SATA 同上，PCIe x4 pin R3(5,7) T3(11,13) R2(17,19) T2(23,25) Lane 0,1 同上</li>
</ul>
<p>可以看到，SATA pin 和 PCIe 的两个 lane 在 B 和 M key 中是一样的，物理上也是可以兼容的。</p>
<p>因为支持 SATA 和 PCIe，就有下面三种可能的使用方式：</p>
<ul>
<li>PCIe -- AHCI HBA(Board) -- SATA(M.2) -- Disk: 传统方式，只不过物理接口从 SATA 变成了 M.2</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(AHCI)：硬盘实现了 AHCI 的接口，通过 PCIe 连接到 CPU</li>
<li>PCIe -- PCIe Device(M.2) -- Disk(NVMe)：硬盘实现了 NVMe 的接口，通过 PCIe 连接到 CPU</li>
</ul>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/SATA_Express_interface.svg/620px-SATA_Express_interface.svg.png"/></p>
<h3 id="sata-express"><a class="toclink" href="../../hardware/2021/05/06/disk/#sata-express">SATA express</a></h3>
<p><a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 在 SATA 3.2 引入，它用的很少，被 U.2 取代。提供了 PCIe x2 或者 SATA x2。</p>
<h3 id="u2"><a class="toclink" href="../../hardware/2021/05/06/disk/#u2">U.2</a></h3>
<p><a href="https://en.wikipedia.org/wiki/U.2">U.2</a> 也叫 <a href="https://members.snia.org/document/dl/26489">SFF-8639</a>。它和 <a href="https://en.wikipedia.org/wiki/SATA_Express">SATA express</a> 接口一样，但提供了 PCIe x4 或者 SATA x2。详见 <a href="https://pinoutguide.com/HD/U.2_SATA_connector_pinout.shtml">pinout</a>。</p>
<p><img alt="U.2" src="https://www.delock.com/infothek/U.2-NVMe/images/teaser.jpg"/></p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/05/06/disk/#_2">速度比较</a></h3>
<p>不同的协议的速度如下：</p>
<ul>
<li>SATA 3.0: 6Gb/s(8b/10b, 4Gb/s uncoded)</li>
<li>SAS-1: 3Gb/s</li>
<li>SAS-2: 6Gb/s</li>
<li>SAS-3: 12Gb/s</li>
<li>SAS-4: 22.5Gb/s</li>
<li>PCIe 3.0 x4: 32Gb/s(8GT/s, 128b/130b, 31.5 Gb/s uncoded)</li>
</ul>
<p>更完整的可以看<a href="https://en.wikipedia.org/wiki/List_of_interface_bit_rates">List of interface bit rates</a>。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/192574/intel-ssd-dc-p4618-series-6-4tb-1-2-height-pcie-3-1-x8-3d2-tlc.html">Intel SSD DC P4618 Series</a> 读写速度可以达到 40~50 Gb/s，它采用的是 PCIe 3.0 x8(64Gb/s) NVMe。</p>
<p><a href="https://ark.intel.com/content/www/us/en/ark/products/125024/intel-ssd-545s-series-1-024tb-2-5in-sata-6gb-s-3d2-tlc.html">Intel SSD 545s Series</a> 读写速度约 4Gb/s，采用的是 SATA 3.0 6Gb/s。</p>
<p><a href="https://www.samsung.com/semiconductor/minisite/ssd/product/consumer/970evo/">SAMSUNG 970 EVO</a> 读写速度 20~30 Gb/s，它采用的是 PCIe 3.0 x4(32Gb/s) NVMe。</p>
<h3 id="sas"><a class="toclink" href="../../hardware/2021/05/06/disk/#sas">SAS</a></h3>
<p>SAS 涉及的物理接口比较多，下面举一个具体的例子：DELL SCv2000</p>
<p>文档：https://dl.dell.com/topicspdf/storage-sc2000_owners-manual_en-us.pdf</p>
<p>它的背面：</p>
<p><img alt="" src="/images/scv2000.png"/></p>
<p>它有四个前端接口 Mini-SAS High Density (HD)，即 SFF-8644；两个后端接口 Mini-SAS，即 SFF-8088。</p>
<p>RAID 卡例子：MegaRAID SAS 9361-8i</p>
<p>文档：https://docs.broadcom.com/doc/12351995</p>
<p>它的接口有：</p>
<ol>
<li>两个 mini-SAS SFF-8643(Mini Multilane 4/8X 12 Gb/s Unshielded Connector (HD12un)) 内部连接器，连接到硬盘</li>
<li>PCIe 3.0 8x 连接主板</li>
</ol>
<p>SAS 标准：</p>
<ul>
<li>INCITS 417 Serial Attached SCSI 1.1 (SAS-1.1)</li>
<li>INCITS 457 Serial Attached SCSI 2 (SAS-2)</li>
<li>INCITS 478 Serial Attached SCSI 2.1 (SAS-2.1)</li>
<li>INCITS 519 Serial Attached SCSI - 3 (SAS-3)</li>
<li>INCITS 534 Serial Attached SCSI - 4 (SAS-4)</li>
</ul>
<p>可以从 https://www.t10.org/drafts.htm#SCSI3_SAS 免费下载尚未成为标准的 SAS-4.1 Working Draft。</p>
<h3 id="sas_1"><a class="toclink" href="../../hardware/2021/05/06/disk/#sas_1">SAS 相关的物理接口</a></h3>
<p>查找 SFF 标准：https://www.snia.org/technology-communities/sff/specifications</p>
<p>中文介绍：https://www.163.com/dy/article/H8TGPEUA0532B75P.html</p>
<h4 id="sff-8087"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8087">SFF-8087</a></h4>
<p>Mini Multilane 4X Unshielded Connector Shell and Plug</p>
<p><img alt="" src="/images/sff8087.png"/></p>
<p>介绍：https://cs-electronics.com/sff-8087/</p>
<p>Mini SAS 4i 连接器就是 36 pin 的 SFF-8087，支持四路 SAS。i 表示用于 internal 连接。对应的 external 接口是 SFF-8088。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25823</p>
<p>它的引脚定义可以在 <a href="https://members.snia.org/document/dl/27380">SFF-9402</a> 看到，它的引脚分为 A 面和 B 面，每面有 18 个 PIN，用途如下：</p>
<ul>
<li>A2(Rx0+), A3(Rx0-), B2(Tx0+), B3(Tx0-)：第一组差分对</li>
<li>A4(Rx1+), A5(Rx1-), B4(Tx1+), B5(Tx1-)：第二组差分对</li>
<li>A13(Rx2+), A14(Rx2-), B13(Tx2+), B14(Tx2-)：第三组差分对</li>
<li>A16(Rx3+), A17(Rx3-), B16(Tx3+), B17(Tx3-)：第四组差分对</li>
<li>B8(Sclock), B9(Sload), A10(SDataOut), A11(SDataIn)：SGPIO 协议</li>
<li>B8(2W-CLK), B9(2W-DATA)：用于 SES 的 I2C 协议</li>
</ul>
<p>这四组差分对对应四路 SAS 或者 SATA。SGPIO 协议的标准是 <a href="https://members.snia.org/document/dl/25923">SFF-8485</a>，主要用途是控制硬盘状态灯，以及判断盘是否插入。</p>
<p>相关标准：</p>
<ul>
<li>SFF-8086: Mini Multilane 10 Gb/s 4X Common Elements Connector</li>
</ul>
<h4 id="sff-8088"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8088">SFF-8088</a></h4>
<p>Mini Multilane 4X Shielded Connector Shell and Plug</p>
<p><img alt="" src="/images/sff8088.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/25824</p>
<p>Mini SAS 4x 连接器就是 26 pin 的 SFF-8088，支持四路 SAS。用于 external 连接。对应的 internal 接口是 SFF-8087。</p>
<h4 id="sff-8482sff-8678sff-8680sff-8681"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8482sff-8678sff-8680sff-8681">SFF-8482/SFF-8678/SFF-8680/SFF-8681</a></h4>
<p>SFF-8482: Serial Attachment 2X Unshielded Connector (EIA-966)</p>
<p><img alt="" src="/images/sff8482.png"/></p>
<p>介绍：https://cs-electronics.com/sff-8482/</p>
<p>支持两路 SAS，29 个引脚。和 SATA 的接口大小一样，目的是为了可以兼容 SATA 和 SAS 盘，比较常见。</p>
<p>标准下载地址：https://members.snia.org/document/dl/25920</p>
<p>不同速率的版本：</p>
<ul>
<li>SFF-8678: Serial Attachment 2X 6Gb/s Unshielded Connector</li>
<li>SFF-8680: Serial Attachment 2X 12Gb/s Unshielded Connector, 支持 SAS-2.x 和 SAS-3</li>
<li>SFF-8681: Serial Attachment 2X 24Gb/s Unshielded Connector, 支持 SAS-4</li>
</ul>
<h4 id="sff-86148644"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-86148644">SFF-8614/8644</a></h4>
<p>SFF-8614: Mini Multilane 4/8X Shielded Cage/Connector (HDsh)</p>
<p><img alt="" src="/images/sff8614.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/25939</p>
<p>对应的 internal 版本是 SFF-8643: Mini Multilane 4/8X 12 Gb/s Unshielded Connector</p>
<p>名称：External Mini-SAS HD(High Density)</p>
<p>升级版本：</p>
<p>SFF-8644: Mini Multilane 4/8X 12 Gb/s Shielded Cage/Connector (HD12sh)</p>
<p>标准下载地址：https://members.snia.org/document/dl/25952</p>
<p>支持 SAS-3 和 PCIe 3.0</p>
<h4 id="sff-8639"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8639">SFF-8639</a></h4>
<p>Multifunction 6X Unshielded Connector</p>
<p>又称 U.2</p>
<p><img alt="" src="/images/sff8639.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/26489</p>
<p>用途：</p>
<ul>
<li>Single port SATA (as defined by Serial ATA revision 3.1)</li>
<li>Two port SATA Express (as defined in Serial ATA Technical Proposal #TPR_C109, currently under development)</li>
<li>Dual port SAS (as defined by SFF-8482)</li>
<li>MultiLink SAS (as defined by SFF-8630)</li>
<li>Up to 4 lanes of PCIe (as defined in this specification)</li>
</ul>
<h4 id="sff-8611"><a class="toclink" href="../../hardware/2021/05/06/disk/#sff-8611">SFF-8611</a></h4>
<p>MiniLink 4/8X I/O Cable Assemblies</p>
<p>又称 OCuLink 1.0</p>
<p><img alt="" src="/images/sff8611.png"/></p>
<p>标准下载地址：https://members.snia.org/document/dl/27937</p>
<p>用途：</p>
<ul>
<li>PCIe</li>
<li>SAS</li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2021/05/06/disk/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-04-15 00:00:00">2021年4月15日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="esxi-perccli-raid"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/">在 ESXi 中用 PERCCli 换 RAID 中的盘</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#_1">背景</a></h3>
<p>最近有一台机器的盘出现了报警，需要换掉，然后重建 RAID5 阵列。iDRAC 出现报错：</p>
<ol>
<li>Disk 2 in Backplane 1 of Integrated RAID Controller 1 is not functioning correctly.</li>
<li>Virtual Disk 1 on Integrated RAID Controller 1 has become degraded.</li>
<li>Error occurred on Disk2 in Backplane 1 of Integrated RAID Controller 1 : (Error 2)</li>
</ol>
<h3 id="perccli"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#perccli">安装 PERCCli</a></h3>
<p>首先，因为系统是 VMware ESXi 6.7，所以在<a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=5v7xx">DELL 官网</a>下载对应的文件。按照里面的 README 安装 vib：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>esxcli<span class="w"> </span>software<span class="w"> </span>vib<span class="w"> </span>install<span class="w"> </span>-v<span class="w"> </span>/vmware-perccli-007.1420.vib
</span></code></pre></div>
<p>如果要升级系统，需要先卸载 vib：<code>esxcli software vib remove -n vmware-perccli</code>，因为升级的时候会发现缺少新版系统的 perccli，建议先卸载，升级后再安装新的。</p>
<p>需要注意的是，如果复制上去 Linux 版本的 PERCCli，虽然也可以运行，但是找不到控制器。安装好以后，就可以运行 <code>/opt/lsi/perccli/perccli</code> 。接着，运行 <code>perccli show all</code>，可以看到类似下面的信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-1-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>--------------------------------------------------------------------------------
</span><span id="__span-1-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>EID:Slt<span class="w"> </span>DID<span class="w"> </span>State<span class="w">  </span>DG<span class="w">     </span>Size<span class="w"> </span>Intf<span class="w"> </span>Med<span class="w"> </span>SED<span class="w"> </span>PI<span class="w"> </span>SeSz<span class="w"> </span>Model<span class="w">               </span>Sp<span class="w"> </span>Type
</span><span id="__span-1-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>--------------------------------------------------------------------------------
</span><span id="__span-1-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="m">32</span>:2<span class="w">      </span><span class="m">2</span><span class="w"> </span>Failed<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-1-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="m">32</span>:4<span class="w">      </span><span class="m">4</span><span class="w"> </span>UGood<span class="w">   </span>F<span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-1-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>--------------------------------------------------------------------------------
</span></code></pre></div>
<p>其中 E32S2 是 Failed 的盘，属于 Disk Group 1；E32S4 是新插入的盘，准备替换掉 E32S2，目前不属于任何的 Disk Group。查看一下 Disk Group：<code>perccli /c0/dall show</code></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/dall<span class="w"> </span>show
</span><span id="__span-2-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>-----------------------------------------------------------------------------
</span><span id="__span-2-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">       </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-2-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>-----------------------------------------------------------------------------
</span><span id="__span-2-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">   </span>N<span class="w">    </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-2-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">   </span>N<span class="w">    </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-2-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">   </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-2-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:2<span class="w">     </span><span class="m">2</span><span class="w">   </span>DRIVE<span class="w"> </span>Failed<span class="w"> </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-2-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">   </span>N<span class="w">    </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span></code></pre></div>
<p>可以看到 DG1 处于 Degraded 状态，然后 E32S4 处于 Failed 状态。参考了一下 <a href="https://dl.dell.com/topicspdf/cli_guide_en-us.pdf">PERCCli 文档</a>，它告诉我们要这么做：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span><span class="nb">set</span><span class="w"> </span>offline
</span><span id="__span-3-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span><span class="nb">set</span><span class="w"> </span>missing
</span><span id="__span-3-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>perccli<span class="w"> </span>/cx<span class="w"> </span>/dall<span class="w"> </span>show
</span><span id="__span-3-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span>insert<span class="w"> </span><span class="nv">dg</span><span class="o">=</span>a<span class="w"> </span><span class="nv">array</span><span class="o">=</span>b<span class="w"> </span><span class="nv">row</span><span class="o">=</span>c
</span><span id="__span-3-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>perccli<span class="w"> </span>/cx<span class="o">[</span>/ex<span class="o">]</span>/sx<span class="w"> </span>start<span class="w"> </span>rebuild
</span></code></pre></div>
<p>具体到我们这个情景，就是把 E32S2 设为 offline，然后用 E32S4 来替换它：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span><span class="nb">set</span><span class="w"> </span>offline
</span><span id="__span-4-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span><span class="nb">set</span><span class="w"> </span>missing
</span><span id="__span-4-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>perccli<span class="w"> </span>/cx<span class="w"> </span>/dall<span class="w"> </span>show
</span><span id="__span-4-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>perccli<span class="w"> </span>/cx/e32/s4<span class="w"> </span>insert<span class="w"> </span><span class="nv">dg</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">array</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">row</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-4-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>perccli<span class="w"> </span>/cx/e32/s4<span class="w"> </span>start<span class="w"> </span>rebuild
</span></code></pre></div>
<p>完成以后的状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>TOPOLOGY<span class="w"> </span>:
</span><span id="__span-5-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="o">========</span>
</span><span id="__span-5-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
</span><span id="__span-5-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>---------------------------------------------------------------------------
</span><span id="__span-5-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">     </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-5-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>---------------------------------------------------------------------------
</span><span id="__span-5-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-5-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-5-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-10"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:4<span class="w">     </span><span class="m">4</span><span class="w">   </span>DRIVE<span class="w"> </span>Rbld<span class="w">  </span>Y<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-11"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-5-12"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>---------------------------------------------------------------------------
</span></code></pre></div>
<p>可以看到 E32S4 替换了原来 E32S2 的位置，并且开始重建。查看重建进度：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/32/s4<span class="w"> </span>show<span class="w"> </span>rebuild
</span><span id="__span-6-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>-----------------------------------------------------
</span><span id="__span-6-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>Drive-ID<span class="w">   </span>Progress%<span class="w"> </span>Status<span class="w">      </span>Estimated<span class="w"> </span>Time<span class="w"> </span>Left
</span><span id="__span-6-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>-----------------------------------------------------
</span><span id="__span-6-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>/c0/e32/s4<span class="w">         </span><span class="m">3</span><span class="w"> </span>In<span class="w"> </span>progress<span class="w"> </span>-
</span><span id="__span-6-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>-----------------------------------------------------
</span><span id="__span-6-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>$<span class="w"> </span>perccli<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-6-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>Need<span class="w"> </span>Attention<span class="w"> </span>:
</span><span id="__span-6-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="o">==============</span>
</span><span id="__span-6-10"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>
</span><span id="__span-6-11"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>Controller<span class="w"> </span><span class="m">0</span><span class="w"> </span>:
</span><span id="__span-6-12"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="o">============</span>
</span><span id="__span-6-13"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>
</span><span id="__span-6-14"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>-------------------------------------------------------------------------------
</span><span id="__span-6-15"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>EID:Slt<span class="w"> </span>DID<span class="w"> </span>State<span class="w"> </span>DG<span class="w">     </span>Size<span class="w"> </span>Intf<span class="w"> </span>Med<span class="w"> </span>SED<span class="w"> </span>PI<span class="w"> </span>SeSz<span class="w"> </span>Model<span class="w">               </span>Sp<span class="w"> </span>Type
</span><span id="__span-6-16"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>-------------------------------------------------------------------------------
</span><span id="__span-6-17"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="m">32</span>:4<span class="w">      </span><span class="m">4</span><span class="w"> </span>Rbld<span class="w">   </span><span class="m">1</span><span class="w"> </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>SATA<span class="w"> </span>HDD<span class="w"> </span>N<span class="w">   </span>N<span class="w">  </span>512B<span class="w"> </span>ST4000NM0033-9ZM170<span class="w"> </span>U<span class="w">  </span>-
</span><span id="__span-6-18"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>-------------------------------------------------------------------------------
</span></code></pre></div>
<p>然后，查看一下出错的盘：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span>show<span class="w"> </span>all
</span><span id="__span-7-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>Drive<span class="w"> </span>/c0/e32/s2<span class="w"> </span>State<span class="w"> </span>:
</span><span id="__span-7-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="o">======================</span>
</span><span id="__span-7-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>Shield<span class="w"> </span><span class="nv">Counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>Media<span class="w"> </span>Error<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>Other<span class="w"> </span>Error<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span>
</span><span id="__span-7-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>Drive<span class="w"> </span><span class="nv">Temperature</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>36C<span class="w"> </span><span class="o">(</span><span class="m">96</span>.80<span class="w"> </span>F<span class="o">)</span>
</span><span id="__span-7-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>Predictive<span class="w"> </span>Failure<span class="w"> </span><span class="nv">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-7-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>S.M.A.R.T<span class="w"> </span>alert<span class="w"> </span>flagged<span class="w"> </span>by<span class="w"> </span><span class="nv">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>No
</span></code></pre></div>
<p>果然有错误，但是也看不到更多信息了。</p>
<p>坏块统计：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0<span class="w"> </span>show<span class="w"> </span>badblocks
</span><span id="__span-8-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>Detailed<span class="w"> </span>Status<span class="w"> </span>:
</span><span id="__span-8-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="o">===============</span>
</span><span id="__span-8-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>-------------------------------------------------------------
</span><span id="__span-8-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>Ctrl<span class="w"> </span>Status<span class="w"> </span>Ctrl_Prop<span class="w">       </span>Value<span class="w"> </span>ErrMsg<span class="w">               </span>ErrCd
</span><span id="__span-8-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>-------------------------------------------------------------
</span><span id="__span-8-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">   </span><span class="m">0</span><span class="w"> </span>Failed<span class="w"> </span>Bad<span class="w"> </span>Block<span class="w"> </span>Count<span class="w"> </span>-<span class="w">     </span>BadBlockCount<span class="w"> </span>failed<span class="w">     </span><span class="m">2</span>
</span><span id="__span-8-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>-------------------------------------------------------------
</span></code></pre></div>
<p>经过检查以后，发现 E32S2 盘的 SMART 并没有报告什么问题，所以也没有把盘取走，而是作为 hot spare 当备用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/e32/s2<span class="w"> </span>add<span class="w"> </span>hotsparedrive<span class="w"> </span><span class="nv">DG</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-9-2"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>$<span class="w"> </span>perccli<span class="w"> </span>/c0/d1<span class="w"> </span>show
</span><span id="__span-9-3"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>TOPOLOGY<span class="w"> </span>:
</span><span id="__span-9-4"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="o">========</span>
</span><span id="__span-9-5"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>
</span><span id="__span-9-6"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>---------------------------------------------------------------------------
</span><span id="__span-9-7"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>DG<span class="w"> </span>Arr<span class="w"> </span>Row<span class="w"> </span>EID:Slot<span class="w"> </span>DID<span class="w"> </span>Type<span class="w">  </span>State<span class="w"> </span>BT<span class="w">     </span>Size<span class="w"> </span>PDC<span class="w">  </span>PI<span class="w"> </span>SED<span class="w"> </span>DS3<span class="w">  </span>FSpace<span class="w"> </span>TR
</span><span id="__span-9-8"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>---------------------------------------------------------------------------
</span><span id="__span-9-9"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-9-10"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span>-<span class="w">   </span>-<span class="w">        </span>-<span class="w">   </span>RAID5<span class="w"> </span>Dgrd<span class="w">  </span>N<span class="w">  </span><span class="m">7</span>.276<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>N<span class="w">      </span>N
</span><span id="__span-9-11"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">0</span><span class="w">   </span><span class="m">32</span>:1<span class="w">     </span><span class="m">1</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-12"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">1</span><span class="w">   </span><span class="m">32</span>:4<span class="w">     </span><span class="m">4</span><span class="w">   </span>DRIVE<span class="w"> </span>Rbld<span class="w">  </span>Y<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-13"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w">   </span><span class="m">2</span><span class="w">   </span><span class="m">32</span>:3<span class="w">     </span><span class="m">3</span><span class="w">   </span>DRIVE<span class="w"> </span>Onln<span class="w">  </span>N<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>dflt<span class="w"> </span>N<span class="w">  </span>N<span class="w">   </span>dflt<span class="w"> </span>-<span class="w">      </span>N
</span><span id="__span-9-14"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w">   </span>-<span class="w">   </span><span class="m">32</span>:2<span class="w">     </span><span class="m">2</span><span class="w">   </span>DRIVE<span class="w"> </span>DHS<span class="w">   </span>-<span class="w">  </span><span class="m">3</span>.637<span class="w"> </span>TB<span class="w"> </span>-<span class="w">    </span>-<span class="w">  </span>-<span class="w">   </span>-<span class="w">    </span>-<span class="w">      </span>N
</span><span id="__span-9-15"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>---------------------------------------------------------------------------
</span><span id="__span-9-16"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a>
</span><span id="__span-9-17"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="nv">DG</span><span class="o">=</span>Disk<span class="w"> </span>Group<span class="w"> </span>Index<span class="p">|</span><span class="nv">Arr</span><span class="o">=</span>Array<span class="w"> </span>Index<span class="p">|</span><span class="nv">Row</span><span class="o">=</span>Row<span class="w"> </span>Index<span class="p">|</span><span class="nv">EID</span><span class="o">=</span>Enclosure<span class="w"> </span>Device<span class="w"> </span>ID
</span><span id="__span-9-18"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="nv">DID</span><span class="o">=</span>Device<span class="w"> </span>ID<span class="p">|</span><span class="nv">Type</span><span class="o">=</span>Drive<span class="w"> </span>Type<span class="p">|</span><span class="nv">Onln</span><span class="o">=</span>Online<span class="p">|</span><span class="nv">Rbld</span><span class="o">=</span>Rebuild<span class="p">|</span><span class="nv">Optl</span><span class="o">=</span>Optimal<span class="p">|</span><span class="nv">Dgrd</span><span class="o">=</span>Degraded
</span><span id="__span-9-19"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="nv">Pdgd</span><span class="o">=</span>Partially<span class="w"> </span>degraded<span class="p">|</span><span class="nv">Offln</span><span class="o">=</span>Offline<span class="p">|</span><span class="nv">BT</span><span class="o">=</span>Background<span class="w"> </span>Task<span class="w"> </span>Active
</span><span id="__span-9-20"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="nv">PDC</span><span class="o">=</span>PD<span class="w"> </span>Cache<span class="p">|</span><span class="nv">PI</span><span class="o">=</span>Protection<span class="w"> </span>Info<span class="p">|</span><span class="nv">SED</span><span class="o">=</span>Self<span class="w"> </span>Encrypting<span class="w"> </span>Drive<span class="p">|</span><span class="nv">Frgn</span><span class="o">=</span>Foreign
</span><span id="__span-9-21"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="nv">DS3</span><span class="o">=</span>Dimmer<span class="w"> </span>Switch<span class="w"> </span><span class="m">3</span><span class="p">|</span><span class="nv">dflt</span><span class="o">=</span>Default<span class="p">|</span><span class="nv">Msng</span><span class="o">=</span>Missing<span class="p">|</span><span class="nv">FSpace</span><span class="o">=</span>Free<span class="w"> </span>Space<span class="w"> </span>Present
</span><span id="__span-9-22"><a href="../../devops/2021/04/15/vmware-esxi-perccli/#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="nv">TR</span><span class="o">=</span>Transport<span class="w"> </span>Ready
</span></code></pre></div>
<p>这样就可以做后备盘，当别的盘坏的时候，作为备用。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/04/15/vmware-esxi-perccli/#_2">相关软件下载</a></h3>
<p>可以在<a href="https://www.broadcom.com/products/storage/raid-controllers/megaraid-sas-9361-8i#downloads">这里</a>寻找 StorCLI 版本。</p>
<p>StorCLI：</p>
<ul>
<li>007.1613.0000.0000 Oct 29, 2020 <a href="https://docs.broadcom.com/docs/007.1613.0000.0000_Unified_StorCLI.zip">007.1613.0000.0000_Unified_StorCLI.zip</a></li>
<li>007.1506.0000.0000 Aug 11, 2020 <a href="https://downloadcenter.intel.com/download/30286/StorCLI-Standalone-Utility">StorCLI_MR7.15.zip</a> </li>
<li>1.15.12 Apr 23, 2015 <a href="https://docs.broadcom.com/docs/12354905">MR_SAS_StorCLI_6-7-1-15-12-SCGCQ00852539.zip</a></li>
<li>1.15.05 Jan 22, 2015 <a href="https://docs.broadcom.com/docs/12354804">1-15-05_StorCLI.zip</a></li>
</ul>
<p>MegaCLI:</p>
<ul>
<li>8.07.07 Dec 19, 2012 <a href="https://docs.broadcom.com/docs/12351585">8-07-07_MegaCLI.zip</a></li>
</ul>
<p>PercCLI:</p>
<ul>
<li>007.1420.0000.0000 Dec 10, 2020 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=n65f1">PERCCLI_N65F1_7.1420.00_A10_Linux.tar.gz</a> <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=5v7xx">PERCCLI_5V7XX_7.1420.0_A10_VMware.tar.gz</a></li>
<li>007.1327.0000.0000 July 27, 2020 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=d6ywp">PERCCLI_D6YWP_7.1327.00_A09_Linux.tar.gz</a></li>
<li>007.0127.0000.0000 July 13, 2017 <a href="https://www.dell.com/support/home/zh-cn/drivers/driversdetails?driverid=f48c2">perccli_7.1-007.0127_linux.tar.gz</a></li>
</ul>
<nav class="md-post__action">
<a href="../../devops/2021/04/15/vmware-esxi-perccli/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-04-02 00:00:00">2021年4月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="fluentd-k8s"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/">用 fluentd 收集 k8s 中容器的日志</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#_1">背景</a></h3>
<p>在维护一个 k8s 集群的时候，一个很常见的需求就是把日志持久化存下来，一方面是方便日后回溯，一方面也是聚合 replicate 出来的同一个服务的日志。</p>
<p>在我目前的需求下，只需要把日志持久下来，还不需要做额外的分析。所以我并没有部署类似 ElasticSearch 的服务来对日志进行索引。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2021/04/02/k8s-fluentd-log-collect/#_2">实现</a></h3>
<p>实现主要参考官方的仓库：https://github.com/fluent/fluentd-kubernetes-daemonset。它把一些常用的插件打包到 docker 镜像中，然后提供了一些默认的设置，比如获取 k8s 日志和 pod 日志等等。为了达到我的需求，我希望：</p>
<ol>
<li>每个结点上有一个 fluentd 收集日志，forward 到单独的 log server 上的 fluentd</li>
<li>log server 上的 fluentd 把收到的日志保存到文件</li>
</ol>
<p>由于 log server 不由 k8s 管理，所以按照<a href="https://docs.fluentd.org/installation/install-by-deb">官网</a>的方式手动安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span>https://toolbelt.treasuredata.com/sh/install-debian-buster-td-agent4.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</span></code></pre></div>
<p>然后，编辑配置 <code>/etc/td-agent/td-agent.conf</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>&lt;source&gt;
</span><span id="__span-1-2"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span>@type<span class="w"> </span>forward
</span><span id="__span-1-3"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span>@id<span class="w"> </span>input_forward
</span><span id="__span-1-4"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nb">bind</span><span class="w"> </span>x.x.x.x
</span><span id="__span-1-5"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>&lt;/source&gt;
</span><span id="__span-1-6"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>&lt;match<span class="w"> </span>**&gt;
</span><span id="__span-1-8"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span>@type<span class="w"> </span>file
</span><span id="__span-1-9"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span>path<span class="w"> </span>/var/log/fluentd/k8s
</span><span id="__span-1-10"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span>compress<span class="w"> </span>gzip
</span><span id="__span-1-11"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span>&lt;buffer&gt;
</span><span id="__span-1-12"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span>timekey<span class="w"> </span>1d
</span><span id="__span-1-13"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span>timekey_use_utc<span class="w"> </span><span class="nb">true</span>
</span><span id="__span-1-14"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span>timekey_wait<span class="w"> </span>10m
</span><span id="__span-1-15"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span>&lt;/buffer&gt;
</span><span id="__span-1-16"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>&lt;/match&gt;
</span></code></pre></div>
<p>分别设置输入：监听 fluentd forward 协议；输出：设置输出文件，和 buffer 配置。如有需要，可以加鉴权。</p>
<p>接着，按照 https://github.com/fluent/fluentd-kubernetes-daemonset/blob/master/fluentd-daemonset-forward.yaml，我做了一些修改，得到了下面的配置：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nn">---</span>
</span><span id="__span-2-2"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-3"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-2-4"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-5"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-6"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-7"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nn">---</span>
</span><span id="__span-2-9"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-2-10"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-2-11"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-12"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-13"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-14"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="nt">rules</span><span class="p">:</span>
</span><span id="__span-2-15"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span>
</span><span id="__span-2-16"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">""</span>
</span><span id="__span-2-17"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-2-18"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pods</span>
</span><span id="__span-2-19"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">namespaces</span>
</span><span id="__span-2-20"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span>
</span><span id="__span-2-21"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
</span><span id="__span-2-22"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
</span><span id="__span-2-23"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">watch</span>
</span><span id="__span-2-24"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>
</span><span id="__span-2-25"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="nn">---</span>
</span><span id="__span-2-26"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
</span><span id="__span-2-27"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</span><span id="__span-2-28"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-29"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-30"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="nt">roleRef</span><span class="p">:</span>
</span><span id="__span-2-31"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
</span><span id="__span-2-32"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-33"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</span><span id="__span-2-34"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="nt">subjects</span><span class="p">:</span>
</span><span id="__span-2-35"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
</span><span id="__span-2-36"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-37"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-38"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>
</span><span id="__span-2-39"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="nn">---</span>
</span><span id="__span-2-40"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
</span><span id="__span-2-41"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
</span><span id="__span-2-42"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-43"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-44"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-45"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-46"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-47"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-48"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-49"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
</span><span id="__span-2-50"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
</span><span id="__span-2-51"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-52"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-53"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
</span><span id="__span-2-54"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-55"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-2-56"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-logging</span>
</span><span id="__span-2-57"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-58"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-59"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-60"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-61"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span>
</span><span id="__span-2-62"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/master</span>
</span><span id="__span-2-63"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoSchedule</span>
</span><span id="__span-2-64"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-2-65"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd</span>
</span><span id="__span-2-66"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluent/fluentd-kubernetes-daemonset:v1-debian-forward</span>
</span><span id="__span-2-67"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-2-68"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENT_FOWARD_HOST</span>
</span><span id="__span-2-69"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"x.x.x.x"</span>
</span><span id="__span-2-70"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENT_FOWARD_PORT</span>
</span><span id="__span-2-71"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"24224"</span>
</span><span id="__span-2-72"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FLUENTD_SYSTEMD_CONF</span>
</span><span id="__span-2-73"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">"disable"</span>
</span><span id="__span-2-74"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a><span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
</span><span id="__span-2-75"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a><span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
</span><span id="__span-2-76"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200Mi</span>
</span><span id="__span-2-77"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a><span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
</span><span id="__span-2-78"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
</span><span id="__span-2-79"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200Mi</span>
</span><span id="__span-2-80"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
</span><span id="__span-2-81"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-2-82"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/fluentd/etc/tail_container_parse.conf</span>
</span><span id="__span-2-83"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tail_container_parse.conf</span>
</span><span id="__span-2-84"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
</span><span id="__span-2-85"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
</span><span id="__span-2-86"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
</span><span id="__span-2-87"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker/containers</span>
</span><span id="__span-2-88"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-2-89"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span id="__span-2-90"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-2-91"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config-volume</span>
</span><span id="__span-2-92"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span>
</span><span id="__span-2-93"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
</span><span id="__span-2-94"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlog</span>
</span><span id="__span-2-95"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-2-96"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log</span>
</span><span id="__span-2-97"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">varlibdockercontainers</span>
</span><span id="__span-2-98"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span>
</span><span id="__span-2-99"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker/containers</span>
</span><span id="__span-2-100"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a>
</span><span id="__span-2-101"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="nn">---</span>
</span><span id="__span-2-102"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-2-103"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</span><span id="__span-2-104"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-2-105"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fluentd-config</span>
</span><span id="__span-2-106"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</span><span id="__span-2-107"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="nt">data</span><span class="p">:</span>
</span><span id="__span-2-108"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a><span class="w">  </span><span class="nt">tail_container_parse.conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
</span><span id="__span-2-109"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-109" id="__codelineno-2-109" name="__codelineno-2-109"></a><span class="w">    </span><span class="no">&lt;parse&gt;</span>
</span><span id="__span-2-110"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-110" id="__codelineno-2-110" name="__codelineno-2-110"></a><span class="w">      </span><span class="no">@type cri</span>
</span><span id="__span-2-111"><a href="../../devops/2021/04/02/k8s-fluentd-log-collect/#__codelineno-2-111" id="__codelineno-2-111" name="__codelineno-2-111"></a><span class="w">    </span><span class="no">&lt;/parse&gt;</span>
</span></code></pre></div>
<p>和原版有几点细节上的不同：</p>
<ol>
<li>k8s 启用了 rbac，所以需要对应的配置；照着仓库里其他带 rbac 配置的文件抄一下即可。</li>
<li>禁用了 SYSTEMD 日志的抓取，因为我用的是 k3s，而不是 kubeadm，自然找不到 kubelet 的 systemd service。</li>
<li>覆盖了 container 日志的读取，因为使用的 container runtime 日志格式和默认的不同，这部分设置在仓库的 README 中也有提到。</li>
</ol>
<p>部署到 k8s 中即可。为了保证日志的准确性，建议各个结点都保持 NTP 的同步。</p>
<nav class="md-post__action">
<a href="../../devops/2021/04/02/k8s-fluentd-log-collect/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-29 00:00:00">2021年3月29日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ipmitool-ilo-4"><a class="toclink" href="../../system/2021/03/29/ilo-nic-selection-ipmitool/">通过 ipmitool 配置 iLO 4 管理端口</a></h2>
<p>ipmitool 自带了对 iDRAC 的支持，可以通过 <code>ipmitool delloem</code> 设置 iDRAC 的管理端口。但是对 iLO 的支持并没有实现。研究了一番，找到了通过 raw command 配置 iLO 4 管理端口的方法。</p>
<p><a href="https://computercheese.blogspot.com/2013/05/ipmi-lan-commands.html">这篇文章</a> 讲述了 <code>ipmitool lan</code> 命令实际会发送的命令：</p>
<p>读取配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>SET<span class="w"> </span>BLOCK
</span></code></pre></div>
<p>一般来说 SET 和 BLOCK 都是 0。KEY 的常见取值：</p>
<ul>
<li>3: IP 地址</li>
<li>4: IP 地址来源</li>
<li>5: MAC 地址</li>
<li>6: 子网掩码</li>
<li>12: 默认网关</li>
</ul>
<p>返回的数据中，第一个字节忽略，剩下的就是数据了。</p>
<p>写入配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>CHANNEL<span class="w"> </span>KEY<span class="w"> </span>DATA...
</span></code></pre></div>
<p>知道如何读取配置后，接下来就是找到 iLO 4 配置 NIC 的地方了。一番搜索，找到了 <a href="https://support.hpe.com/hpesc/public/docDisplay?docId=c04530505&amp;docLocale=en_US">HPE iLO IPMI User Guide</a>。在第 101 页，可以找到一个用于配置 iLO NIC 选择的设置：</p>
<div class="language-text highlight"><pre><span></span><code>Index: 224
iLO Dedicated/Shared NIC Selection.
data 3:
• Selected iLO NIC.
◦ 0h = iLO Dedicated NIC is selected.
◦ 1h = iLO Shared NIC is selected.
◦ All others = reserved
• To switch to another iLO NIC:
1. Write this (and possibly parameter 197) to the desired NIC selection
2. Configure all other relevant network parameters for the desin
3. Reset iLO. The desired NIC will be in use after iLO reset.
• When writing changes to data 3, NIC selection:
◦ data 1 must be AAh
◦ data 2 must be 55h
◦ data 4 must be FFh
</code></pre></div>
<p>有这样的信息以后，可以通过下面的命令来设置 Shared NIC：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x01<span class="w"> </span>0x01<span class="w"> </span><span class="m">224</span><span class="w"> </span>0xAA<span class="w"> </span>0x55<span class="w"> </span>0x01<span class="w"> </span>0xFF
</span></code></pre></div>
<p>再读出来 224，发现它的 data 4 表示 <code>iLO reset needed for some settings changes that have been made</code>。于是，执行 <code>ipmitool mc reset warm</code> 之后，就可以看到 NIC 选择已经更新：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>ipmitool<span class="w"> </span>raw<span class="w"> </span>0x0c<span class="w"> </span>0x02<span class="w"> </span>0x01<span class="w"> </span><span class="m">197</span><span class="w"> </span>0x00<span class="w"> </span>0x00
</span><span id="__span-3-2"><a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="m">11</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">02</span>
</span></code></pre></div>
<p>数据分别表示：</p>
<ul>
<li>0x02: Shared NIC Selection = ALOM</li>
<li>0x01: Shared NIC Port Number = Port 1</li>
<li>0x02: Platform supports ALOM shared NIC</li>
</ul>
<p>如果想要的端口和默认选择不一样，可以写入 197 来更新。详见上面的文档链接。</p>
<p>超微的机器也有类似的办法：https://www.supermicro.org.cn/support/faqs/faq.cfm?faq=15868，可以用 <code>ipmiutil smcoem lanport</code> 命令来读取/修改。</p>
<p>Update：我给 IPMITOOL 提交了 <a href="https://github.com/ipmitool/ipmitool/pull/278">PR</a>，来简化这个过程</p>
<nav class="md-post__action">
<a href="../../system/2021/03/29/ilo-nic-selection-ipmitool/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-29 00:00:00">2021年3月29日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ipmitool"><a class="toclink" href="../../system/2021/03/29/static-ipmitool/">静态编译 ipmitool</a></h2>
<p>为了在 ESXi 上运行 ipmitool，需要静态编译 ipmitool。网上已经有一些解决方案：</p>
<p>https://github.com/ryanbarrie/ESXI-ipmitool
https://github.com/hobbsh/static-ipmitool
https://github.com/ewenmcneill/docker-build-static-ipmitool</p>
<p>我稍微修改了一下，用来编译最新 ipmitool：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">##!/bin/bash</span>
</span><span id="__span-0-2"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nb">set</span><span class="w"> </span>-x
</span><span id="__span-0-3"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">VERSION</span><span class="o">=</span><span class="m">1</span>.8.18
</span><span id="__span-0-4"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>rm<span class="w"> </span>-rf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>
</span><span id="__span-0-5"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.bz2<span class="w"> </span>http://deb.debian.org/debian/pool/main/i/ipmitool/ipmitool_<span class="nv">$VERSION</span>.orig.tar.bz2
</span><span id="__span-0-6"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>tar<span class="w"> </span>xvf<span class="w"> </span>ipmitool_<span class="nv">$VERSION</span>.tar.bz2
</span><span id="__span-0-7"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nb">cd</span><span class="w"> </span>ipmitool-<span class="nv">$VERSION</span>
</span><span id="__span-0-8"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nv">CC</span><span class="o">=</span>gcc<span class="w"> </span><span class="nv">CFLAGS</span><span class="o">=</span>-m64<span class="w"> </span><span class="nv">LDFLAGS</span><span class="o">=</span>-static<span class="w"> </span>./configure
</span><span id="__span-0-9"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>make<span class="w"> </span>-j24
</span><span id="__span-0-10"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nb">cd</span><span class="w"> </span>src
</span><span id="__span-0-11"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>../libtool<span class="w"> </span>--silent<span class="w"> </span>--tag<span class="o">=</span>CC<span class="w"> </span>--mode<span class="o">=</span>link<span class="w"> </span>gcc<span class="w"> </span>-m64<span class="w"> </span>-fno-strict-aliasing<span class="w"> </span>-Wreturn-type<span class="w"> </span>-all-static<span class="w"> </span>-o<span class="w"> </span>ipmitool.static<span class="w"> </span>ipmitool.o<span class="w"> </span>ipmishell.o<span class="w"> </span>../lib/libipmitool.la<span class="w"> </span>plugins/libintf.la
</span><span id="__span-0-12"><a href="../../system/2021/03/29/static-ipmitool/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>file<span class="w"> </span><span class="nv">$PWD</span>/ipmitool.static
</span></code></pre></div>
<p>复制下来，编译完成后 scp 到 esxi 中即可使用。</p>
<nav class="md-post__action">
<a href="../../system/2021/03/29/static-ipmitool/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-27 00:00:00">2021年3月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/networking/">networking</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="esxi"><a class="toclink" href="../../networking/2021/03/27/esxi-network-config/">ESXi 网络配置</a></h2>
<p>用过 ESXi 的大家都知道，它网页版对网络的配置功能有限，特别是 IPv6 的部分，有的事情无法实现。更好的办法是 SSH 到 ESXi 上直接用命令行进行配置。</p>
<p>可能会用到的一些命令：</p>
<ol>
<li>esxcfg-vmknic: 用来给 vmkernel 配置地址</li>
<li>esxcfg-route: 设置系统路由表</li>
<li>esxcli: 大杂烩，很多功能都在里面</li>
<li>tcpdump-uw：魔改版 tcpdump</li>
</ol>
<p>一些例子：</p>
<p>设置 IPv6 默认路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../networking/2021/03/27/esxi-network-config/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcfg-route<span class="w"> </span>-f<span class="w"> </span>V6<span class="w"> </span>-a<span class="w"> </span>default<span class="w"> </span><span class="nv">$IPV6</span>
</span></code></pre></div>
<p>删除 vmkernel 的 IPv6 地址：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../networking/2021/03/27/esxi-network-config/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="o">[</span>root@esxi:~<span class="o">]</span>esxcli<span class="w"> </span>network<span class="w"> </span>ip<span class="w"> </span>interface<span class="w"> </span>ipv6<span class="w"> </span>address<span class="w"> </span>remove<span class="w"> </span>-i<span class="w"> </span><span class="nv">$VMKERNEL</span><span class="w"> </span>-I<span class="w"> </span><span class="nv">$IPV6</span>/<span class="nv">$PREFIX</span>
</span></code></pre></div>
<p>参考：https://kb.vmware.com/s/article/1002662</p>
<nav class="md-post__action">
<a href="../../networking/2021/03/27/esxi-network-config/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-18 00:00:00">2021年3月18日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="linksys-e8450-openwrt-w-80211ax"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/">Linksys E8450 OpenWRT 配置 w/ 802.11ax</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#_1">背景</a></h3>
<p>之前用的 newifi 路由器（Lenovo y1s）无线网总是出问题，于是换了一个新的支持 802.11ax 的路由器 Linksys E8450，目前在 openwrt snapshot 支持。Openwrt 的支持页面：<a href="https://openwrt.org/toh/linksys/linksys_e8450">Linksys E8450</a>。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2021/03/18/linksys-e8450-openwrt/#_2">过程</a></h3>
<p>按照支持页面，下载固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>wget<span class="w"> </span>https://downloads.openwrt.org/snapshots/targets/mediatek/mt7622/openwrt-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin
</span></code></pre></div>
<p>更新（2023-02-27）：固件已经从 snapshot 进入正式版，下载链接为 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-squashfs-sysupgrade.bin</a>。如果已经替换为 UBI，则使用 <a href="https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb">https://downloads.openwrt.org/releases/22.03.3/targets/mediatek/mt7622/openwrt-22.03.3-mediatek-mt7622-linksys_e8450-ubi-squashfs-sysupgrade.itb</a> 固件。</p>
<p>然后访问固件升级页面：http://192.168.1.1/config-admin-firmware.html#firmware，选择下载的 bin 文件。点击“开始升级”，然后等待。一段时间后，ssh 到路由器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>root@192.168.1.1
</span><span id="__span-1-2"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>The<span class="w"> </span>authenticity<span class="w"> </span>of<span class="w"> </span>host<span class="w"> </span><span class="s1">'192.168.1.1 (192.168.1.1)'</span><span class="w"> </span>can<span class="s1">'t be established.</span>
</span><span id="__span-1-3"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="s1">ED25519 key fingerprint is SHA256:REDACTED.</span>
</span><span id="__span-1-4"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="s1">No matching host key fingerprint found in DNS.</span>
</span><span id="__span-1-5"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="s1">This key is not known by any other names</span>
</span><span id="__span-1-6"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
</span><span id="__span-1-7"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="s1">Warning: Permanently added '</span><span class="m">192</span>.168.1.1<span class="err">'</span><span class="w"> </span><span class="o">(</span>ED25519<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>known<span class="w"> </span>hosts.
</span><span id="__span-1-8"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>BusyBox<span class="w"> </span>v1.33.0<span class="w"> </span><span class="o">()</span><span class="w"> </span>built-in<span class="w"> </span>shell<span class="w"> </span><span class="o">(</span>ash<span class="o">)</span>
</span><span id="__span-1-11"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>
</span><span id="__span-1-12"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span>_______<span class="w">                     </span>________<span class="w">        </span>__
</span><span id="__span-1-13"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="p">|</span>.-----.-----.-----.<span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span>.----.<span class="p">|</span><span class="w">  </span><span class="p">|</span>_
</span><span id="__span-1-14"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w"> </span><span class="p">|</span><span class="w">   </span>-<span class="w">   </span><span class="o">||</span><span class="w">  </span>_<span class="w">  </span><span class="p">|</span><span class="w">  </span>-__<span class="p">|</span><span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w">  </span><span class="o">||</span><span class="w">   </span>_<span class="o">||</span><span class="w">   </span>_<span class="p">|</span>
</span><span id="__span-1-15"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w"> </span><span class="p">|</span>_______<span class="o">||</span><span class="w">   </span>__<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="o">||</span>________<span class="o">||</span>__<span class="p">|</span><span class="w">  </span><span class="p">|</span>____<span class="p">|</span>
</span><span id="__span-1-16"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">          </span><span class="p">|</span>__<span class="p">|</span><span class="w"> </span>W<span class="w"> </span>I<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>L<span class="w"> </span>E<span class="w"> </span>S<span class="w"> </span>S<span class="w">   </span>F<span class="w"> </span>R<span class="w"> </span>E<span class="w"> </span>E<span class="w"> </span>D<span class="w"> </span>O<span class="w"> </span>M
</span><span id="__span-1-17"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-1-18"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w"> </span>OpenWrt<span class="w"> </span>SNAPSHOT,<span class="w"> </span>r16242-41af8735d4
</span><span id="__span-1-19"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w"> </span>-----------------------------------------------------
</span><span id="__span-1-20"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="o">===</span><span class="w"> </span>WARNING!<span class="w"> </span><span class="o">=====================================</span>
</span><span id="__span-1-21"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>There<span class="w"> </span>is<span class="w"> </span>no<span class="w"> </span>root<span class="w"> </span>password<span class="w"> </span>defined<span class="w"> </span>on<span class="w"> </span>this<span class="w"> </span>device!
</span><span id="__span-1-22"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>Use<span class="w"> </span>the<span class="w"> </span><span class="s2">"passwd"</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>to<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>password
</span><span id="__span-1-23"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>prevent<span class="w"> </span>unauthorized<span class="w"> </span>SSH<span class="w"> </span>logins.
</span><span id="__span-1-24"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>--------------------------------------------------
</span><span id="__span-1-25"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>root@OpenWrt:~#<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-1-26"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>Linux<span class="w"> </span>OpenWrt<span class="w"> </span><span class="m">5</span>.10.23<span class="w"> </span><span class="c1">#0 SMP Wed Mar 17 19:55:38 2021 aarch64 GNU/Linux</span>
</span></code></pre></div>
<p>配置 luci:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>opkg<span class="w"> </span>update
</span><span id="__span-2-2"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>$<span class="w"> </span>opkg<span class="w"> </span>install<span class="w"> </span>luci
</span></code></pre></div>
<p>然后就可以网页访问看到 luci 了：Powered by LuCI Master (git-21.060.51374-cd06e70) / OpenWrt SNAPSHOT r16242-41af8735d4。</p>
<p>由于目前 luci 不支持 802.11ax 的配置，可以直接修改 uci 配置来达到效果：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span>show<span class="w"> </span>wireless
</span><span id="__span-3-2"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>root@OpenWrt:/#<span class="w"> </span>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>wireless.radio1.htmode<span class="o">=</span><span class="s1">'HE80'</span>
</span><span id="__span-3-3"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>root@OpenWrt:/#<span class="w"> </span>/etc/init.d/network<span class="w"> </span>restart
</span><span id="__span-3-4"><a href="../../hardware/2021/03/18/linksys-e8450-openwrt/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="s1">'radio0'</span><span class="w"> </span>is<span class="w"> </span>disabled
</span></code></pre></div>
<p>注：实际上设置为 HE 开头的字符串即可，见 <a href="https://github.com/openwrt/openwrt/blob/8019c54d8a191cfb90c3bf06ff367f601f872fd1/package/kernel/mac80211/files/lib/netifd/wireless/mac80211.sh#L334">mac80211.sh</a>。</p>
<p>再连接上 Wi-Fi 的时候就可以看到是 802.11ax 模式了。也在 <a href="https://forum.openwrt.org/t/got-802-11ax-working-in-linksys-e8450/91533">OpenWRT 论坛</a> 上分享了一下这个方案。</p>
<p>更新（2021-07-31）：目前最新的 luci 版本已经可以在网页上配置 802.11ax 模式了。</p>
<nav class="md-post__action">
<a href="../../hardware/2021/03/18/linksys-e8450-openwrt/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2021-03-16 00:00:00">2021年3月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="gitlab-ci-k8s"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/">用 gitlab ci 构建并部署应用到 k8s</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#_1">背景</a></h3>
<p>在 k8s 集群中部署了 gitlab-runner，并且希望在 gitlab ci 构建完成后，把新的 docker image push 到 private repo，然后更新应用。</p>
<p>参考文档：<a href="https://www.qikqiak.com/post/gitlab-ci-k8s-cluster-feature/">Gitlab CI 与 Kubernetes 的结合</a>，<a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html">Using Docker to build Docker images</a>。</p>
<h3 id="gitlab-ci-docker"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#gitlab-ci-docker">在 gitlab ci 中构建 docker 镜像</a></h3>
<p>这一步需要 DinD 来实现在容器中构建容器。为了达到这个目的，首先要在 gitlab-runner 的配置中添加一个 volume 来共享 DinD 的证书路径：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">gitlabUrl</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-0-2"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">rbac</span><span class="p">:</span>
</span><span id="__span-0-3"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-0-4"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">runnerRegistrationToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">REDACTED</span>
</span><span id="__span-0-5"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">runners</span><span class="p">:</span>
</span><span id="__span-0-6"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-0-7"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="no">[[runners]]</span>
</span><span id="__span-0-8"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">      </span><span class="no">[runners.kubernetes]</span>
</span><span id="__span-0-9"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="no">image = "ubuntu:20.04"</span>
</span><span id="__span-0-10"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span><span class="no">privileged = true</span>
</span><span id="__span-0-11"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">      </span><span class="no">[[runners.kubernetes.volumes.empty_dir]]</span>
</span><span id="__span-0-12"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="no">name = "docker-certs"</span>
</span><span id="__span-0-13"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="no">mount_path = "/certs/client"</span>
</span><span id="__span-0-14"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="no">medium = "Memory"</span>
</span><span id="__span-0-15"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>注意两点：1. privileged 2. 多出来的 volume</p>
<p>用 helm 部署 gitlab runner 之后，按照下面的方式配置 gitlab-ci：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>image: docker:19.03.12
</span><span id="__span-1-2"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>variables:
</span><span id="__span-1-4"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>  DOCKER_HOST: tcp://docker:2376
</span><span id="__span-1-5"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>  #
</span><span id="__span-1-6"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>  # The 'docker' hostname is the alias of the service container as described at
</span><span id="__span-1-7"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>  # https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#accessing-the-services.
</span><span id="__span-1-8"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>  # If you're using GitLab Runner 12.7 or earlier with the Kubernetes executor and Kubernetes 1.6 or earlier,
</span><span id="__span-1-9"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>  # the variable must be set to tcp://localhost:2376 because of how the
</span><span id="__span-1-10"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>  # Kubernetes executor connects services to the job container
</span><span id="__span-1-11"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>  # DOCKER_HOST: tcp://localhost:2376
</span><span id="__span-1-12"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>  #
</span><span id="__span-1-13"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>  # Specify to Docker where to create the certificates, Docker will
</span><span id="__span-1-14"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>  # create them automatically on boot, and will create
</span><span id="__span-1-15"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>  # `/certs/client` that will be shared between the service and job
</span><span id="__span-1-16"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>  # container, thanks to volume mount from config.toml
</span><span id="__span-1-17"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>  DOCKER_TLS_CERTDIR: "/certs"
</span><span id="__span-1-18"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>  # These are usually specified by the entrypoint, however the
</span><span id="__span-1-19"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>  # Kubernetes executor doesn't run entrypoints
</span><span id="__span-1-20"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4125
</span><span id="__span-1-21"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>  DOCKER_TLS_VERIFY: 1
</span><span id="__span-1-22"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
</span><span id="__span-1-23"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>  DOCKER_DAEMON_OPTIONS: "--insecure-registry=${REGISTRY}"
</span><span id="__span-1-24"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>
</span><span id="__span-1-25"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>services:
</span><span id="__span-1-26"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>  - name: docker:19.03.12-dind
</span><span id="__span-1-27"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>    entrypoint: ["sh", "-c", "dockerd-entrypoint.sh $DOCKER_DAEMON_OPTIONS"]
</span><span id="__span-1-28"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>
</span><span id="__span-1-29"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>before_script:
</span><span id="__span-1-30"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>  # Wait until client certs are generated
</span><span id="__span-1-31"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>  # https://gitlab.com/gitlab-org/gitlab-runner/-/issues/27384
</span><span id="__span-1-32"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>  - until docker info; do sleep 1; done
</span><span id="__span-1-33"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>  - echo "$REGISTRY_PASS" | docker login $REGISTRY --username $REGISTRY_USER --password-stdin
</span><span id="__span-1-34"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>
</span><span id="__span-1-35"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>build:
</span><span id="__span-1-36"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>  stage: build
</span><span id="__span-1-37"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>  script: ./build.sh
</span></code></pre></div>
<p>这里有很多细节，包括 DinD 的访问方式，等待 client cert，设置 docker 的 insecure registry 和 login 等等。经过 <a href="https://github.com/CircuitCoder">@CircuitCoder</a> 的不断摸索，终于写出了可以用的配置。</p>
<p>如此配置以后，就可以在 gitlab ci 的构建脚本里用 docker 来 build 并且 push 到自己的 registry 了。为了防止泄露密钥，建议把这些变量放到 gitlab ci 设置的 secrets 中。</p>
<h3 id="k8s"><a class="toclink" href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#k8s">自动部署到 k8s</a></h3>
<p>为了让 k8s 重启一个 deployment，一般的做法是：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl -n NAMESPACE rollout restart deployment/NAME
</span></code></pre></div>
<p>我们希望 gitlab ci 在 build 之后，去执行这一个命令，但又不希望提供太多的权限给 gitlab。所以，我们创建 Service Account 并设置最小权限：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>---
</span><span id="__span-3-2"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>apiVersion: v1
</span><span id="__span-3-3"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>kind: ServiceAccount
</span><span id="__span-3-4"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>metadata:
</span><span id="__span-3-5"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>  name: gitlab
</span><span id="__span-3-6"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>  namespace: default
</span><span id="__span-3-7"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>---
</span><span id="__span-3-9"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-3-10"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>kind: Role
</span><span id="__span-3-11"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>metadata:
</span><span id="__span-3-12"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>  name: gitlab-test
</span><span id="__span-3-13"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>  namespace: test
</span><span id="__span-3-14"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>rules:
</span><span id="__span-3-15"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>- verbs:
</span><span id="__span-3-16"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>    - get
</span><span id="__span-3-17"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>    - patch
</span><span id="__span-3-18"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>  apiGroups:
</span><span id="__span-3-19"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>    - 'apps'
</span><span id="__span-3-20"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>  resources:
</span><span id="__span-3-21"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>    - 'deployments'
</span><span id="__span-3-22"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>  resourceNames:
</span><span id="__span-3-23"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>    - 'test-deployment'
</span><span id="__span-3-24"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>
</span><span id="__span-3-25"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>---
</span><span id="__span-3-26"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>apiVersion: rbac.authorization.k8s.io/v1
</span><span id="__span-3-27"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>kind: RoleBinding
</span><span id="__span-3-28"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>metadata:
</span><span id="__span-3-29"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>  name: gitlab
</span><span id="__span-3-30"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>  namespace: test
</span><span id="__span-3-31"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>subjects:
</span><span id="__span-3-32"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>  - kind: ServiceAccount
</span><span id="__span-3-33"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>    name: gitlab
</span><span id="__span-3-34"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>    namespace: default
</span><span id="__span-3-35"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>roleRef:
</span><span id="__span-3-36"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>  apiGroup: rbac.authorization.k8s.io
</span><span id="__span-3-37"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>  kind: Role
</span><span id="__span-3-38"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>  name: gitlab-test
</span></code></pre></div>
<p>要特别注意这几个配置的 namespace 的对应关系：Role 和 RoleBinding 需要放在同一个 ns 下。</p>
<p>接着，到 GitLab 的 Operations-&gt;Kubernetes 创建 cluster，把 service account 的 token 和 ca.crt 从 secret 里找到并贴到网页上。GitLab 会按照 Environment scope 匹配到 environment，如果某个 stage 的 environment 匹配上了，就会把 kube credentials 配置好。修改 gitlab-ci.yml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>deploy:
</span><span id="__span-4-2"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>  stage: deploy
</span><span id="__span-4-3"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>  image: bitnami/kubectl:1.20
</span><span id="__span-4-4"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>  environment:
</span><span id="__span-4-5"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>    name: production
</span><span id="__span-4-6"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>  only:
</span><span id="__span-4-7"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>    - master
</span><span id="__span-4-8"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>  script:
</span><span id="__span-4-9"><a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>    - kubectl -n test rollout restart deployment/test
</span></code></pre></div>
<p>这样就完成配置了。</p>
<nav class="md-post__action">
<a href="../../devops/2021/03/16/gitlab-ci-k8s-integration/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../9/">9</a> <a class="md-pagination__link" href="../10/">10</a> <span class="md-pagination__current">11</span> <a class="md-pagination__link" href="../12/">12</a> <a class="md-pagination__link" href="../13/">13</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>