
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/16/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-09 00:00:00">2020年2月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="macos-artix7-fpga"><a class="toclink" href="../../hardware/2020/02/09/program-artix7-on-macos/">在 macOS 烧写 Artix7 FPGA</a></h2>
<p>首先安装好 openocd：</p>
<p><code>brew install openocd --HEAD</code></p>
<p>测试所用版本为 <code>0.10.0+dev-01052-g09580964 (2020-02-08-15:09)</code>。</p>
<p>然后编写如下的 openocd.cfg：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>adapter driver ftdi
</span><span id="__span-0-2"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>adapter speed 10000
</span><span id="__span-0-3"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>ftdi_vid_pid 0x0403 0x6014
</span><span id="__span-0-4"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>ftdi_layout_init 0x0008 0x004b
</span><span id="__span-0-5"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>source [find cpld/xilinx-xc7.cfg]
</span><span id="__span-0-7"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>init
</span><span id="__span-0-8"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>xc7_program xc7.tap
</span><span id="__span-0-9"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>pld load 0 /path/to/bitstream.bit
</span><span id="__span-0-10"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>shutdown
</span></code></pre></div>
<p>上面的 ftdi 开头的两行按照实际的 JTAG Adapter 修改。可以参考 openocd 自带的一些 cfg。</p>
<p>然后在 openocd.cfg 的目录运行 <code>openocd</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>openocd
</span><span id="__span-1-2"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.10.0+dev-01052-g09580964<span class="w"> </span><span class="o">(</span><span class="m">2020</span>-02-08-15:09<span class="o">)</span>
</span><span id="__span-1-3"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-1-4"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-1-5"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-1-6"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">"jtag"</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">'transport select &lt;transport&gt;'</span>.
</span><span id="__span-1-7"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>Info<span class="w"> </span>:<span class="w"> </span>ftdi:<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>experience<span class="w"> </span>problems<span class="w"> </span>at<span class="w"> </span>higher<span class="w"> </span>adapter<span class="w"> </span>clocks,<span class="w"> </span>try<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="s2">"ftdi_tdo_sample_edge falling"</span>
</span><span id="__span-1-8"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-1-9"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>xc7.tap<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x0362d093<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x049<span class="w"> </span><span class="o">(</span>Xilinx<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x362d,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-1-10"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-1-11"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>shutdown<span class="w"> </span><span class="nb">command</span><span class="w"> </span>invoked
</span><span id="__span-1-12"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-1-13"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<p>这时 FPGA 已经烧写成功。</p>
<p>参考：</p>
<ol>
<li>https://pansila.github.io/posts/7db4884d</li>
<li>https://numato.com/kb/programming-mimas-a7-using-openocd-and-xc3sprog/</li>
</ol>
<p>更新：OpenOCD 已经更新到 0.11.0，对于 Arty A7，采用下面的脚本进行烧写：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>## OpenOCD 0.11.0
</span><span id="__span-2-2"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>## Adapted from: interface/ftdi/digilent-hs1.cfg
</span><span id="__span-2-3"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>## See also: board/arty_s7.cfg
</span><span id="__span-2-4"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>adapter driver ftdi
</span><span id="__span-2-5"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>adapter speed 25000
</span><span id="__span-2-6"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>ftdi_vid_pid 0x0403 0x6010
</span><span id="__span-2-7"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>ftdi_channel 0
</span><span id="__span-2-8"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>ftdi_layout_init 0x0088 0x008b
</span><span id="__span-2-9"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>reset_config none
</span><span id="__span-2-10"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>source [find cpld/xilinx-xc7.cfg]
</span><span id="__span-2-12"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>init
</span><span id="__span-2-13"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>pld load 0 ./bitstream.bit
</span><span id="__span-2-14"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>shutdown
</span></code></pre></div>
<p>成功输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>openocd
</span><span id="__span-3-2"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0
</span><span id="__span-3-3"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-3-4"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-3-5"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-3-6"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">"jtag"</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">'transport select &lt;transport&gt;'</span>.
</span><span id="__span-3-7"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>Info<span class="w"> </span>:<span class="w"> </span>ftdi:<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>experience<span class="w"> </span>problems<span class="w"> </span>at<span class="w"> </span>higher<span class="w"> </span>adapter<span class="w"> </span>clocks,<span class="w"> </span>try<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="s2">"ftdi_tdo_sample_edge falling"</span>
</span><span id="__span-3-8"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">25000</span><span class="w"> </span>kHz
</span><span id="__span-3-9"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>xc7.tap<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x0362d093<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x049<span class="w"> </span><span class="o">(</span>Xilinx<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x362d,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-3-10"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-3-11"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>shutdown<span class="w"> </span><span class="nb">command</span><span class="w"> </span>invoked
</span><span id="__span-3-12"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-3-13"><a href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../hardware/2020/02/09/program-artix7-on-macos/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-09 00:00:00">2020年2月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rocket-chip-bscan"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/">研究 Rocket Chip 的 BSCAN 调试原理</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#_1">前言</a></h3>
<p>最近 <a href="https://github.com/KireinaHoro">@jsteward</a> 在研究如何通过 JTAG 对 FPGA 里的 Rocket Chip 进行调试。之前 <a href="https://github.com/sequencer">@sequencer</a> 已经做了一些实践，我们在重复他的工作，同时也研究了一下这是怎么工作的。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#_2">原理</a></h3>
<p>我们从 @sequencer 得到了一份可用的 <a href="https://github.com/sequencer/rocket-playground/blob/7fa3c51113be607add2034f3abe0ae973caac04a/playground/src/FPGA.scala#L83">Scala 代码</a> 和 <a href="https://github.com/sequencer/rocket-playground/blob/7fa3c51113be607add2034f3abe0ae973caac04a/playground/debugger/openocd.cfg#L16">OpenOCD 配置</a>，并且了解到：</p>
<ol>
<li>可以通过 openocd 找到并调试 Rocket Chip</li>
<li>openocd 是通过 JTAG 向 FPGA 的 TAP 的 IR 写入 USER4，然后往 DR 写入特定格式的数据，然后控制 Rocket Chip 的 JTAG。</li>
</ol>
<p>这里涉及到一个“封装”的过程，在一个仅可以控制 DR 的 JTAG 中控制另一个 JTAG。首先可以找到 OpenOCD 端的<a href="https://github.com/riscv/riscv-openocd/blob/7cb8843794a258380b7c37509e5c693977675b2a/src/target/riscv/riscv.c#L361">操作代码</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-0-2"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_zero</span><span class="p">;</span>
</span><span id="__span-0-3"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-4"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_tunnel_ir_width</span><span class="p">;</span>
</span><span id="__span-0-5"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir_dtmcontrol</span><span class="p">;</span>
</span><span id="__span-0-6"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-7"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-0-8"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tunneled_ir_width</span><span class="p">;</span>
</span><span id="__span-0-9"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-10"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-11"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_zero</span><span class="p">;</span>
</span><span id="__span-0-12"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></div>
<p>如果画成图，大概是这个样子（IR）：</p>
<table>
<thead>
<tr>
<th>3 bits</th>
<th>IR Width bits</th>
<th>7 bits</th>
<th>1 bit</th>
<th>TDI</th>
<th>Data Register</th>
<th>TDO</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Payload</td>
<td>Tunneled IR Width</td>
<td>0</td>
<td>-&gt;</td>
<td>Rocket Chip TAP</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>DR：</p>
<table>
<thead>
<tr>
<th>3 bits</th>
<th>DR Width bits</th>
<th>7 bits</th>
<th>1 bit</th>
<th>TDI</th>
<th>Data Register</th>
<th>TDO</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Payload</td>
<td>Tunneled DR Width</td>
<td>1</td>
<td>-&gt;</td>
<td>Rocket Chip TAP</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>这里 TDI 和 TDO 是直接接到 Rocket Chip 的 JTAG 中的，所以我们期望，当 Rocket Chip TAP 在 Shift-IR/Shift-DR 阶段的时候，刚好通过的是 Payload 部分。而控制 TAP 状态机，需要控制 TMS，这个则是通过一段 <a href="https://github.com/sifive/fpga-shells/blob/c099bd9b4f916bc0ba88030939a9614d0b0daf2d/src/main/scala/ip/xilinx/Xilinx.scala#L13">HDL</a> 来完成的：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">always</span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-2"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8'h04</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-3"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDI_REG</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-4"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8'h05</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-5"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-6"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mh">8'h08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shiftreg_cnt</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mh">8'h08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shiftreg_cnt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">8'h01</span><span class="p">)))</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-7"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-8"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-9"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">'b0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-10"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span>
</span><span id="__span-1-11"><a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">end</span>
</span></code></pre></div>
<p>这里 <code>TDI_REG</code> 取的是第一个 bit 的反（也就是上面 IR 对应 0，DR 对应 1 的那一位），<code>shiftreg_cnf</code> 则是之后 7 个 bit，对应上面的 Tunneled IR/DR Width。那么，在选择 IR 时 TMS 的序列为：</p>
<table>
<thead>
<tr>
<th>4 cycles</th>
<th>1 cycle</th>
<th>1 cycle</th>
<th>2 cycles</th>
<th>shiftreg_cnt-1 cycles</th>
<th>2 cycles</th>
<th>rest cycles</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>Run-Test/Idle</td>
<td>Select-DR-Scan</td>
<td>Select-IR-Scan</td>
<td>Capture-IR, Shift-IR</td>
<td>Shift-IR</td>
<td>Exit1-IR, Update-IR</td>
<td>Run-Test/Idle</td>
</tr>
</tbody>
</table>
<p>类似地，如果是选择 DR：</p>
<table>
<thead>
<tr>
<th>4 cycles</th>
<th>1 cycle</th>
<th>1 cycle</th>
<th>2 cycles</th>
<th>shiftreg_cnt-1 cycles</th>
<th>2 cycles</th>
<th>rest cycles</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>Run-Test/Idle</td>
<td>Run-Test/Idle</td>
<td>Select-DR-Scan</td>
<td>Capture-DR, Shift-DR</td>
<td>Shift-DR</td>
<td>Exit1-DR, Update-DR</td>
<td>Run-Test/Idle</td>
</tr>
</tbody>
</table>
<p>这样，刚好在 Shift-IR/DR 状态下，Payload 会被写入 IR/DR，从而完成了期望的操作。通过规定一个特定格式的 Data Register，可以实现嵌套的 TAP 的 IR 和 DR 的操作。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#_3">参考</a></h3>
<ol>
<li>JTAG Standard</li>
<li><a href="https://github.com/sequencer/rocket-playground">sequencer/rocket-playground</a></li>
<li>SiFive's JTAG Tunnel: https://github.com/sifive/fpga-shells/blob/c099bd9b4f916bc0ba88030939a9614d0b0daf2d/src/main/scala/ip/xilinx/Xilinx.scala#L13</li>
<li>https://github.com/watz0n/arty_xjtag</li>
<li>https://github.com/riscv/riscv-openocd/blob/7cb8843794a258380b7c37509e5c693977675b2a/src/target/riscv/riscv.c#L361</li>
<li>UG740: 7 Series FPGAs Configuration</li>
</ol>
<nav class="md-post__action">
<a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-02-07 00:00:00">2020年2月7日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="macos-mmap"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/">在 macOS 上带执行权限 mmap 一个已删除文件遇到的问题和解决方案</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#_1">背景</a></h3>
<p>实验环境：macOS Catalina 10.15.2</p>
<p>最近在 <a href="https://github.com/rcore-os/zircon-rs">rcore-rs/zircon-rs</a> 项目中遇到一个比较玄学的问题，首先需求是在 macOS 的用户进程里开辟一段地址空间，然后把这个地址空间多次映射（权限可能不同、同一块内存可能被映射到多个地址），通过 mmap 模拟虚拟地址的映射。采用的是如下的方案：</p>
<ol>
<li>在临时目录创建一个文件，把文件大小设为 16M（暂不考虑扩容）</li>
<li>需要映射一个虚拟地址到物理地址的时候，就对这个文件的物理地址偏移进行 FIXED 映射，虚拟地址就是期望的虚拟地址。</li>
</ol>
<p>这样的方案在 Linux 下运行地很好，但在 macOS 下总是以一定概率在第二部出现 EPERM。网上搜了很多，但也没搜到相关的信息，于是自己断断续续地研究了一下，现在有一个比较初步的结果。</p>
<h3 id="tldr"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#tldr">TL；DR</a></h3>
<p>先说结论：调用一个带 PROT_EXEC 并且映射文件的 mmap 时，macOS 会进行安全检测，如果此时发现文件在文件系统上消失了，它会认为这可能是一个恶意软件行为，进行拦截，返回 EPERM。</p>
<p>而代码实际上在第一步和第二步之间，把临时目录删了：由于进程持有 fd，所以文件并不会真的删掉，当软件退出的时候文件自然会删除，这是临时文件的常见做法（见 tmpfile(3)）。</p>
<h3 id="_2"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#_2">研究过程</a></h3>
<h4 id="console"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#console">查看 Console</a></h4>
<p>在网上一番搜索未果后，就尝试在 Console 里面寻找信息。照着程序名字搜索，可以找到一些信息：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>temporarySigning type=1 matchFlags=0x0 path=/path/to/executable
</span></code></pre></div>
<p>这是编译这个 executable 的时候出现的，好像也没啥问题。然后解除过滤，在这个信息前后按照 syspolicyd 寻找：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>initiating malware scan (... info_path: /path/to/temp/file proc_path: /path/to/executable)
</span><span id="__span-1-2"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>Unable (errno: 2) to read file at &lt;private&gt; for process path: &lt;private&gt; library path: &lt;private&gt;
</span><span id="__span-1-3"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Disallowing load of &lt;private&gt; in 50001, &lt;private&gt;
</span><span id="__span-1-4"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>Library load (/path/to/temp/file) rejected: library load denied by system policy
</span></code></pre></div>
<p>这几条记录比较可疑，每次运行程序，如果跑挂了，就会出现这几条，如果没跑挂，就不会出现这一条。所以很大概率是被 macOS 拦截了。错误信息的用词是 library，所以大概率是被当成加载动态库了，但既然内容是空的，所以我想的是文件名触碰到了什么奇怪的规则，然后文件名又是随机的，随机导致 EPERM 是概率性出现的，这好像很有道理。于是我把 tmpfile 换成了固定的路径，忽然就好了。但固定的路径只能保证同时只有一个程序在跑，如果路径拼接上 pid，怎么删，谁来删又是一个问题。虽然可以放到 /tmp 下面然后随便搞，但 /tmp 的回收并不是那么积极，在临时目录下丢太多文件也会出现问题。</p>
<h4 id="_3"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#_3">一丝曙光</a></h4>
<p>这时候，@wangrunji0408 提供了一个方案：在 System Preferences -&gt; Security &amp; Privacy -&gt; Privacy -&gt; Developer Tools 中添加编译该 executable 的程序（如 iTerm、CLion）可以解决这个问题。那么问题应该比较明确了，就是 malware scan 的问题，如果信任了这个 App 为 Developer Tools，它产生的 executable 也是可信的，应该不是恶意软件。但在 tmux 环境下，它哪个 App 也不属于，没法继承，况且把这个权限开放出去也有潜在的安全问题。并且让每个开发者都要这么操作一遍很不方便。</p>
<h4 id="console_1"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#console_1">回到 Console</a></h4>
<p>今天刚好看到一个 <a href="https://georgegarside.com/blog/macos/sierra-console-private/">post</a>，内容是如何在 macOS Catalina 中查看 log 中标记为 private 的内容。如果你注意到的话，上面的 log 中出现了几处 private，这并不是我改的，而是 macOS 自带的隐私机制（当然这种机制似乎并没有采用的很完全，一些消息源没有打上 private 的标签）。</p>
<p>然后按照上面的 post 的方法（<a href="https://saagarjha.com/blog/2019/09/29/making-os-log-public-on-macos-catalina/">另一个 post</a>）开启了一下标记为 private 的内容，正好我的系统没有升级到 10.15.3 所以还能用。此时上面的第二条和第三条就出现了具体内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Unable (errno: 2) to read file at /path/to/temp/file for process path: /path/to/executable library path: /path/to/temp/file
</span><span id="__span-2-2"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>Disallowing load of /path/to/temp/file in 61254, /path/to/executable
</span></code></pre></div>
<p>这个时候问题就很明显了：读取不到文件。这时候回想起 tmpfile 的工作原理，它会删除生成的文件，在删除文件之后，macOS 进行扫描，发现找不到文件，于是 disallow 了，mmap 就会返回 EPERM。</p>
<p>解决方案也很显然了：把删除目录延后，或者放在 /tmp 下等待清理等待。</p>
<p>我也写了一段 C 代码来验证这个现象：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-3-2"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="cp">##include &lt;stdlib.h&gt;</span>
</span><span id="__span-3-3"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="cp">##include &lt;fcntl.h&gt;</span>
</span><span id="__span-3-4"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="cp">##include &lt;sys/mman.h&gt;</span>
</span><span id="__span-3-5"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="cp">##include &lt;unistd.h&gt;</span>
</span><span id="__span-3-6"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-9"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CREAT</span><span class="p">,</span><span class="w"> </span><span class="mo">0777</span><span class="p">);</span>
</span><span id="__span-3-10"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x200000000</span><span class="p">;</span>
</span><span id="__span-3-11"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
</span><span id="__span-3-12"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="c1">// might not work if unlink is put here (race condition)</span>
</span><span id="__span-3-13"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="c1">// you can use sleep to reproduce</span>
</span><span id="__span-3-14"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="n">unlink</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
</span><span id="__span-3-15"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_FIXED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-3-16"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="c1">// always works if unlink is put here</span>
</span><span id="__span-3-17"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="c1">// unlink("mmap");</span>
</span><span id="__span-3-18"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-19"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>
</span><span id="__span-3-20"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-21"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"good"</span><span class="p">);</span>
</span><span id="__span-3-22"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-23"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-24"><a href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../software/2020/02/07/macos-mmap-exec/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-01-31 00:00:00">2020年1月31日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="55"><a class="toclink" href="../../misc/2020/01/31/weekly-sharing-55/">每周分享第 55 期</a></h2>
<p>一个月后终于复更</p>
<ol>
<li>退出 vim 教程 https://github.com/hakluke/how-to-exit-vim</li>
<li>SHA-1 攻击新进展 https://sha-mbles.github.io/</li>
<li>gmane 近况 https://lars.ingebrigtsen.no/2020/01/06/whatever-happened-to-news-gmane-org/</li>
<li>浏览器能做的事情 https://github.com/luruke/browser-2020</li>
<li>一个 ext2 和 FAT 为一体的 fs https://github.com/NieDzejkob/cursedfs</li>
<li>iptables 规则调试工具 https://github.com/x-way/iptables-tracer</li>
<li>Qt 2020 的变化 https://www.qt.io/blog/qt-offering-changes-2020</li>
<li>后缀自动机可视化 https://yeah.moe/p/a8e74947/</li>
</ol>
<nav class="md-post__action">
<a href="../../misc/2020/01/31/weekly-sharing-55/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-01-05 00:00:00">2020年1月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="tp-link-archer-t4u-v3-linux"><a class="toclink" href="../../system/2020/01/05/archer-t4u-v3-driver/">TP-Link Archer T4U V3 Linux 驱动安装</a></h2>
<p>之前因为 MacBookPro 内置的 Wi-Fi 总是有问题，就找了个 USB 的无线网卡：TP-Link Archer T4U V3（VID：2357，PID：0115），这个网卡也没有主线的驱动，在网上找到了现成的驱动：<a href="https://github.com/cilynx/rtl88x2bu">cilynx/rtl88x2bu</a>，按照 README 用 DKMS 安装即可，实测可用。</p>
<p>Update: Linux 6.2+ 已经支持，见 <a href="https://linux-hardware.org/?id=usb:2357-0115">https://linux-hardware.org/?id=usb:2357-0115</a></p>
<nav class="md-post__action">
<a href="../../system/2020/01/05/archer-t4u-v3-driver/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-01-05 00:00:00">2020年1月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="macbookpro-143-wi-fi"><a class="toclink" href="../../system/2020/01/05/macbookpro-linux-wifi/">MacBookPro 14,3 Wi-Fi 驱动问题解决方案</a></h2>
<p>之前在 MacBookPro 14,3 安装 Linux 后，很多东西的驱动都有了解决方法，<a href="https://gist.github.com/TRPB/437f663b545d23cc8a2073253c774be3">参考 1</a>，<a href="https://github.com/roadrunner2/macbook12-spi-driver">参考 2</a>，触摸板和键盘等等都可以正常使用，触摸板的使用效果比我意料要好一些，虽然还是没有 macOS 原生那么好。但 Wi-Fi 一直有能扫到信号但连不上的问题，最近终于有了比较完善的解决方案，<a href="https://bugzilla.kernel.org/show_bug.cgi?id=193121#c52">地址</a>，也是两个月前才出来的方案，我测试了一下，确实可以很好的解决网络问题，网卡型号是 BCM43602，驱动用的是 brcmfmac。</p>
<p>另一方面，带 T2 的 MacBook 似乎也有了支持，见 <a href="https://github.com/aunali1/linux-mbp-arch">aunali1/linux-mbp-arch</a>，有一些尚未 upstream 的 patch，但我没有设备，就没有测试了。需要吐槽的是 ArchWiki 不怎么更新新 Model 的 MacBook 的教程，都是到处找散落的 github repo 和 gist 找别人的方案。</p>
<p>P.S. 可以正常工作的有：Wi-Fi，键盘，触摸板，Touchbar，内置摄像头，键盘背光，蓝牙
P.P.S MacBookPro11,2 的网卡是 BCM4360，直接用 broadcom-wl 驱动就可以。</p>
<nav class="md-post__action">
<a href="../../system/2020/01/05/macbookpro-linux-wifi/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2020-01-01 00:00:00">2020年1月1日</time></li>
<li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="jielabs"><a class="toclink" href="../../2020/01/01/jielabs/">JieLabs 是如何工作的</a></h2>
<h3 id="_1"><a class="toclink" href="../../2020/01/01/jielabs/#_1">简介</a></h3>
<p>JieLabs 是陈嘉杰、高一川、刘晓义（按姓氏拼音首字母排序）于 2020 年新型冠状病毒疫情期间开发的在线数字逻辑电路实验系统，用于清华大学 2020 年春季学期数字逻辑电路实验课程。其包括前端、后端和固件三部分，分别主要由刘晓义、陈嘉杰和高一川负责开发。核心功能实现用时一周，后续界面和稳定性优化用时两周。本文会详细地介绍 JieLabs 的工作原理和一些技术细节，希望对各位同学有所帮助。</p>
<h4 id="_2"><a class="toclink" href="../../2020/01/01/jielabs/#_2">太长；不看。</a></h4>
<p>采用了如下的技术方案：</p>
<p>前端：React 框架 + Redux 状态管理 + Monaco 编辑器 + WebAssembly 运行 Rust 代码 + WebSocket 实时通信 + SASS 样式</p>
<p>后端：Actix-Web 框架 + Diesel/PostgreSQL 数据库 + Redis 消息队列 + Quartus 构建 + Kubernetes 构建容器编排</p>
<p>固件：Xilinx FPGA 控制 + Buildroot 系统 + Linux 内核</p>
<h3 id="_3"><a class="toclink" href="../../2020/01/01/jielabs/#_3">前端</a></h3>
<p>前端大部分都是刘晓义同学编写的，也是这个项目工作量最大的一部分。除了本文，还可以阅读<a href="https://meow.c-3.moe/sth-about-jielabs">刘晓义同学自己写的总结</a>。主要分以下几部分来谈前端的技术实现：</p>
<h4 id="_4"><a class="toclink" href="../../2020/01/01/jielabs/#_4">第三方库</a></h4>
<p>整体上采用了时下比较流行的 React 框架，配合 Redux 进行状态管理，用 React Hooks 编写组件的逻辑。为了实现 VHDL/Verilog 代码的编辑，采用了来自 VSCode 的独立编辑器空间 Monaco，并自行编写了 VHDL 和 Verilog 语言的支持，一部分在 JS 实现，另一部分在 Rust 中实现，通过 wasm-pack 打包到 JS 中执行。另外为了实现 gzip 格式的解压缩也引入了 pako 库。</p>
<p>在这些第三方库里，Monaco 的体积最大，后面我们针对 JS 体积做了许多优化，在下面会再提。</p>
<h4 id="rust"><a class="toclink" href="../../2020/01/01/jielabs/#rust">Rust 在前端的应用</a></h4>
<p>由于开发者里刘晓义和陈嘉杰都是 Rust 语言的爱好者，考虑到目前 Rust to WASM 的技术比较成熟，WebAssembly 的可用程度也很高，我们把一些功能挪到了 Rust 中执行：</p>
<p>一是布线的计算。这是一个比较纯粹的算法问题，一方面对性能有一定的要求，一方面开发者比较喜欢 Rust，所以就用 Rust 实现了。这里要特别感谢刘光哲同学对布线算法的指点。在此基础上，我们用 Rust <a href="https://github.com/jiegec/maze-routing">实现</a>了几个论文中的布线算法（Maze Router），并且通过和 JS 代码的配合得到了一个比较优秀的效果。</p>
<p>二是 VHDL/Verilog 的语言支持。学过编译原理的同学应该知道，如果要实现一个能够解析代码里的信号的程序，一般是不能通过正则表达式来解决的，况且我们还实现了一些错误信息的显示。VHDL 语言支持采用了已有的比较完善的库，Verilog 由于现有的库都比较庞大，不适合放于前端，于是我们编写了一个最小的 Verilog（实际上算是 SystemVerilog）的解析，仅仅足够满足我们的需求。如果同学们遇到了一些语法上功能的缺少，欢迎提出。</p>
<h4 id="canvas"><a class="toclink" href="../../2020/01/01/jielabs/#canvas">Canvas 的应用</a></h4>
<p>连线部分因为是动态生成的，所以也是动态绘制的，Canvas 就可以派上用场了。我们也利用了 Canvas 的特性，针对每一个网络都画在一个 Canvas 上，那么在检测鼠标位置的时候，只要检查 Canvas 在鼠标所在的点上是否颜色，就知道鼠标是否在它上面了。</p>
<h4 id="_5"><a class="toclink" href="../../2020/01/01/jielabs/#_5">前端加载速度的优化</a></h4>
<p>优化前前端 JS 和 WASM 总大小大约是 4MB，对于网络不好的用户来说，它的加载时间是不能容忍的。于是我们采用了以下的措施：</p>
<ol>
<li>打开 gzip：有很显著的效果，但因为一些未知的原因，在实际部署的时候未能打开</li>
<li>缩小 JS 体积：通过 Webpack Analyzer 分析程序各个部分的大小，删掉了 Monaco 中一些没有用到的功能</li>
<li>缩小 WASM 体积：打开 LTO 和 -Os 选项</li>
<li>代码分割：把不同功能的代码分割开，先让一部分代码加载进来，可以绘制一个部分功能的界面，然后再继续加载剩下的组件</li>
<li>CDN：把一部分外部的依赖放到国内，后续如果有需求的话也可以把内部的依赖也放到国内的 CDN 上</li>
</ol>
<h3 id="_6"><a class="toclink" href="../../2020/01/01/jielabs/#_6">后端</a></h3>
<p>后端用 Rust 语言编写，采用了目前比较成熟的 actix-web 框架，大量使用了 async/await。除此之外，用 Redis 作为消息队列，在 Docker 容器中运行 Quartus，用 Kubernetes 进行容器的动态调度。</p>
<h4 id="_7"><a class="toclink" href="../../2020/01/01/jielabs/#_7">任务调度</a></h4>
<p>对于用户提交的代码和约束，后端需要进行任务的调度，生成一个新的任务，放入到 Redis 消息队列中。另一方面，Docker 中运行的 python 脚本会从 Redis 中取任务，任务完成后把结果上传并回传给后端表示确认。如果一个任务一直没有完成，后端会进行回收并重新分配一个任务到队列中。为了防止这个过程中出现重复任务的提交，为每个提交设置了一个足够长的随机 ID。Docker 容器一开始是通过 docker-compose 进行配置，后来考虑到这个场景比较适合 kubernetes，于是使用了一下，还挺好用的。一开始用的是 minikube，搭好 docker registry，然后往里面部署几个 pod 并设置 hpa，具体可以看我的另一篇博客，后来迁移到了 kubeadm 直接配置。现在迁移到了一个 k3s 搭建的 k8s 集群上。</p>
<h4 id="_8"><a class="toclink" href="../../2020/01/01/jielabs/#_8">板子通信</a></h4>
<p>第二个主要功能是进行板子的分配和通信。每个用户会创建一个 WebSocket 连接到后端，每个板子也是一个 WebSocket。当一个用户分配到一个板子的时候，它可以通过后端发送命令给对应的板子，板子的回复也会原路返回，相当于一个 WebSocket Proxy。另外为了保证资源的利用率，添加了一些限制、心跳包和认证。</p>
<h4 id="_9"><a class="toclink" href="../../2020/01/01/jielabs/#_9">状态监控</a></h4>
<p>为了可以直观地看到各个数据，实现了一个简单的监控接口，接入 Telegraf+InfluxDB+Grafana 的监控系统，可以实时看到各个资源的情况，如用户、板子和任务等等，也方便我们在在线用户比较少的时候进行更新。</p>
<h3 id="_10"><a class="toclink" href="../../2020/01/01/jielabs/#_10">板子</a></h3>
<p>这个平台虽然是用于数字逻辑实验课程，但实际用的板子来自数字逻辑设计课程。我们把其上一个 Altera FPGA 作为实验 FPGA，在控制的 Xilinx FPGA 上运行我们的固件，负责读取和写入 GPIO、下载 bitstream 等等功能。</p>
<nav class="md-post__action">
<a href="../../2020/01/01/jielabs/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2019-12-27 00:00:00">2019年12月27日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="54"><a class="toclink" href="../../misc/2019/12/27/weekly-sharing-54/">每周分享第 54 期</a></h2>
<p>咕了两周</p>
<ol>
<li>ES2019 https://javascript.christmas/2019/7</li>
<li>CSS 技巧 https://github.com/chokcoco/iCSS</li>
<li>Rust 编译器加速 https://blog.mozilla.org/nnethercote/2019/12/11/how-to-speed-up-the-rust-compiler-one-last-time-in-2019/</li>
<li>OSXFuse 不开源 https://colatkinson.site/macos/fuse/2019/09/29/osxfuse/</li>
<li>嵌入式 Rust 的 fmt 优化 https://jamesmunns.com/blog/fmt-unreasonably-expensive/</li>
<li>Docker base image 更新工具 https://github.com/containrrr/watchtower</li>
<li>运行 Linux 的名片 https://www.thirtythreeforty.net/posts/2019/12/my-business-card-runs-linux/</li>
</ol>
<nav class="md-post__action">
<a href="../../misc/2019/12/27/weekly-sharing-54/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2019-12-08 00:00:00">2019年12月8日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="53"><a class="toclink" href="../../misc/2019/12/08/weekly-sharing-53/">每周分享第 53 期</a></h2>
<ol>
<li>GDB Enhanced Features https://github.com/hugsy/gef</li>
<li>Lisp on Lua https://fennel-lang.org/</li>
<li>Django 3.0 https://docs.djangoproject.com/en/3.0/releases/3.0/</li>
<li>Rust Constant Propagation https://blog.rust-lang.org/inside-rust/2019/12/02/const-prop-on-by-default.html</li>
<li>ES2019 features https://javascript.christmas/2019/7</li>
</ol>
<nav class="md-post__action">
<a href="../../misc/2019/12/08/weekly-sharing-53/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2019-12-01 00:00:00">2019年12月1日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/misc/">misc</a></li>
<li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="52"><a class="toclink" href="../../misc/2019/12/01/weekly-sharing-52/">每周分享第 52 期</a></h2>
<ol>
<li>
<p>传递 Rust 闭包到 C https://readhacker.news/s/4dbWL</p>
</li>
<li>
<p>SystemVerilog Online http://sv-lang.com/</p>
</li>
<li>
<p>Java 14 新特性 https://www.javaworld.com/article/3437797/work-begins-on-java-14.html</p>
</li>
<li>
<p>在线 or1k 的模拟器 https://readhacker.news/s/4dfqc</p>
</li>
<li>
<p>在 macOS 上运行 virt-manager https://github.com/jeffreywildman/homebrew-virt-manager</p>
</li>
<li>
<p>关于 SystemVerilog 的博客 http://systemverilog.io/</p>
</li>
<li>
<p>结合 VSCode 和 Docker 的开发环境 https://github.com/cdr/sail</p>
</li>
</ol>
<nav class="md-post__action">
<a href="../../misc/2019/12/01/weekly-sharing-52/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../14/">14</a> <a class="md-pagination__link" href="../15/">15</a> <span class="md-pagination__current">16</span> <a class="md-pagination__link" href="../17/">17</a> <a class="md-pagination__link" href="../18/">18</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>