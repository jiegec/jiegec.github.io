
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/7/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-16 00:00:00">2022年5月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ace"><a class="toclink" href="../../hardware/2022/05/16/ace/">「教学」ACE 缓存一致性协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/16/ace/#_1">背景</a></h3>
<p>最近几天分析了 TileLink 的缓存一致性协议部分内容，见<a href="../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a>，趁此机会研究一下之前尝试过研究，但是因为缺少一些基础知识而弃坑的 ACE 协议分析。</p>
<p>下面主要参考了 IHI0022E 的版本，也就是 AXI4 对应的 ACE 版本。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/16/ace/#_2">回顾</a></h3>
<p>首先回顾一下一个缓存一致性协议需要支持哪些操作。对于较上一级 Cache 来说，它需要这么几件事情：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知，也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</li>
<li>需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>如果之前看过我的 TileLink 分析，那么上面的这些操作对应到 TileLink 就是：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（发送 AcquireBlock，等待 GrantData），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（发送 AcquirePerm，等待 Grant），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（发送 ReleaseData，等待 ReleaseAck），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（发送 Release，等待 ReleaseAck），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（收到 Probe），需要返回当前的缓存数据（发送 ProbeAck/ProbeAckData），并且更新状态。</li>
<li>需要一个方法（发送 GrantAck）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>秉承着这个思路，再往下看 ACE 的设计，就会觉得很自然了。</p>
<h3 id="cache-state-model"><a class="toclink" href="../../hardware/2022/05/16/ace/#cache-state-model">Cache state model</a></h3>
<p>首先来看一下 ACE 的缓存状态模型，我在之前的<a href="../../hardware/2021/12/17/cache-coherency-protocol/">缓存一致性协议分析</a>中也分析过，它有这么五种，就是 MOESI 的不同说法：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>文档中的定义如下：</p>
<ul>
<li>Valid, Invalid: When valid, the cache line is present in the cache. When invalid, the cache line is not present in the cache.</li>
<li>Unique, Shared: When unique, the cache line exists only in one cache. When shared, the cache line might exist in more than one cache, but this is not guaranteed.</li>
<li>Clean, Dirty: When clean, the cache does not have responsibility for updating main memory. When dirty, the cache line has been modified with respect to main memory, and this cache must ensure that main memory is eventually updated.</li>
</ul>
<p>大致理解的话，Unique 表示只有一个缓存有这个缓存行，Shared 表示有可能有多个缓存有这个缓存行；Clean 表示它不负责更新内存，Dirty 表示它负责更新内存。下面的很多操作都是围绕这些状态进行的。</p>
<p>文档中也说，它支持 MOESI 的不同子集：MESI, ESI, MEI, MOESI，所以也许在一个简化的系统里，一些状态可以不存在，实现会有所不同。</p>
<h3 id="channel-usage-examples"><a class="toclink" href="../../hardware/2022/05/16/ace/#channel-usage-examples">Channel usage examples</a></h3>
<p>到目前为止，我还没有介绍 ACE 的信号，但是我们可以尝试一下，如果我们是协议的设计者，我们要如何添加信号来完成这个事情。</p>
<p>首先考虑上面提到的第一件事情：读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</p>
<p>我们知道，AXI 有 AR 和 R channel 用于读取数据，那么遇到读或者写 miss 的时候，可以在 AR channel 上捎带一些信息，让下一级的 Interconnect 知道自己的意图是读还是写，然后 Interconnect 就在 R channel 上返回数据。</p>
<p>那么，具体要捎带什么信息呢？我们“不妨”用这样一种命名方式：<code>操作 + 目的状态</code>，比如我读 miss 的时候，需要读取数据，进入 Shared 状态，那就叫 ReadShared；我写 miss 的时候，需要读取数据（通常写入缓存的只是一个缓存行的一部分，所以先要把完整的读进来），那就叫 ReadUnique。这个操作可以编码到一个信号中，传递给 Interconnect。</p>
<p>再来考虑上面提到的第二件事情：写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</p>
<p>这个操作，需要让 Interconnect 把其他缓存中的这个缓存行数据清空，并且把自己升级到 Unique。根据上面的 <code>操作 + 目的状态</code> 的命名方式，我们可以命名为 CleanUnique，即把其他缓存都 Clean 掉，然后自己变成 Unique。</p>
<p>接下来考虑上面提到的第三件事情：需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。</p>
<p>按照前面的 <code>操作 + 目的状态</code> 命名法，可以命名为 WriteBackInvalid。ACE 实际采用的命名是 WriteBack。</p>
<p>终于到了第四件事情：收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</p>
<p>既然 snoop 是从 Interconnect 发给 Master，在已有的 AR R AW W B channel 里没办法做这个事情，不然会打破已有的逻辑。那不得不添加一对 channel，比如我规定一个 AC channel 发送 snoop 请求，规定一个 C channel 让 master 发送响应，这样就可以了。这就相当于 TileLink 里面的 B channel（Probe 请求）和 C channel（ProbeAck 响应）。实际 ACE 和刚才设计的实际有一些区别，把 C channel 拆成了两个：CR 用于返回所有响应，CD 用于返回那些需要数据的响应。这就像 AW 和 W 的关系，一个传地址，一个传数据；类似地，CR 传状态，CD 传数据。</p>
<p>那么，接下来考虑一下 AC channel 上要发送什么请求呢？我们回顾一下上面已经用到的请求类型：需要 snoop 的有 ReadShared，ReadUnique 和 CleanUnique，不需要 snoop 的有 WriteBack。那我们直接通过 AC channel 把 ReadShared，ReadUnique 和 CleanUnique 这三种请求原样发送给需要 snoop 的 cache 那里就可以了。</p>
<p>Cache 在 AC channel 收到这些请求的时候，可以做相应的动作。由于 MOESI 协议下同样的请求可以有不同的响应方法，这里就不细说了。</p>
<p>这时候我们已经基本把 ACE 协议的信号和大题的工作流程推导出来了。哦，我们还忘了第五件事情：需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。TileLink 添加了一个额外的 E channel 来做这个事情，ACE 更加粗暴：直接用一对 RACK 和 WACK 信号来分别表示最后一次读和写已经完成。</p>
<p>关于 WACK 和 RACK 详见 <a href="https://community.arm.com/support-forums/f/soc-design-and-simulation-forum/9888/what-s-the-purpose-for-wack-and-rack-for-ace-and-what-s-the-relationship-with-wvalid-and-rvalid">What's the purpose for WACK and RACK for ACE and what's the relationship with WVALID and RVALID?</a> 的讨论。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/16/ace/#_3">总结</a></h3>
<p>到这里就暂时不继续分析了，其他的很多请求类型是服务于更多场景，比如一次写整个 Cache Line 的话，就不需要读取已有的数据了；或者一次性读取完就不管了，或者这是一个不带缓存的加速器，DMA 等，有一些针对性的优化或者简化的处理，比如对于不带缓存的 master，可以简化为 ACE-Lite，比如 ARM 的 CCI-400 支持两个 ACE master 和 三个 ACE-Lite Master，这些 Master 可以用来接 GPU 等外设。再简化一下 ACE-Lite，就得到了 ACP（Accelerator Coherency Port）。</p>
<p>最后我们再把文章开头的五件事对应到 ACE 上，作为一个前后的呼应：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（AR 上发送 ReadShared/ReadUnique），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（AR 上发送 CleanUnique），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（AW 上发送 WriteBack），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（AW 上发送 Evict），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（AC 上收到 snoop 请求），需要返回当前的缓存数据（通过 CR 和 CD），并且更新状态。</li>
<li>需要一个方法（读 RACK 写 WACK）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/16/ace/#_4">参考文献</a></h3>
<ul>
<li><a href="https://developer.arm.com/documentation/ihi0022/e/">IHI0022E-AMBA AXI and ACE</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/05/16/ace/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-13 00:00:00">2022年5月13日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rocket-chip"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/">向 Rocket Chip 添加自定义调试信号</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_1">背景</a></h3>
<p>最近在尝试把核心作为一个 Tile 加到 Rocket System 中，所以想要把核心之前自定义的调试信号接到顶层上去。Rocket System 自带的支持是 trace，也就是输出每个周期 retire 的指令信息，但和自定义的不大一样，所以研究了一下怎么添加自定义的调试信号，并且连接到顶层。</p>
<h3 id="trace"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#trace">分析 Trace 信号连接方式</a></h3>
<p>首先，观察 Rocket Chip 自己使用的 Trace 信号是如何连接到顶层的。在顶层上，可以找到使用的是 <code>testchipip.CanHaveTraceIO</code>:</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">trait</span><span class="w"> </span><span class="nc">CanHaveTraceIO</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">HasTiles</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="nc">CanHaveTraceIOModuleImp</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="c1">// Bind all the trace nodes to a BB; we'll use this to generate the IO in the imp</span>
</span><span id="__span-0-5"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeNexusNode</span><span class="p">[</span><span class="nc">Vec</span><span class="p">[</span><span class="nc">TracedInstruction</span><span class="p">]]()</span>
</span><span id="__span-0-6"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">tileTraceNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiles</span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-7"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">ext_tile</span><span class="p">:</span><span class="w"> </span><span class="nc">WithExtendedTraceport</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">None</span>
</span><span id="__span-0-8"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="n">tile</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
</span><span id="__span-0-9"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="p">}.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">traceNode</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-10"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="n">tileTraceNodes</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-12"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它采用了 diplomacy 的 BundleBridgeNexusNode，把每个 tile 取出来，把它的 traceNode 接到 traceNexus 上。再看一下模块 <code>CanHaveTraceIOModuleImp</code> 是怎么实现的：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">trait</span><span class="w"> </span><span class="nc">CanHaveTraceIOModuleImp</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">LazyModuleImpLike</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">outer</span><span class="p">:</span><span class="w"> </span><span class="nc">CanHaveTraceIO</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">HasTiles</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="k">implicit</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="nc">Parameters</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">traceIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="nc">TracePortKey</span><span class="p">)</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">traceParams</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-6"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">extTraceSeqVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">traceNexus</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">_1</span><span class="p">)).</span><span class="n">map</span><span class="p">(</span><span class="nc">ExtendedTracedInstruction</span><span class="p">.</span><span class="n">fromVec</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
</span><span id="__span-1-7"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="nc">Output</span><span class="p">(</span><span class="nc">TraceOutputTop</span><span class="p">(</span><span class="n">extTraceSeqVec</span><span class="p">)))</span>
</span><span id="__span-1-8"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
</span><span id="__span-1-9"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">tileInsts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">outer</span><span class="p">.</span><span class="n">traceNexus</span><span class="p">.</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">tileTrace</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">DeclockedTracedInstruction</span><span class="p">.</span><span class="n">fromVec</span><span class="p">(</span><span class="n">tileTrace</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-1-10"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="c1">// Since clock &amp; reset are not included with the traced instruction, plumb that out manually</span>
</span><span id="__span-1-12"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="p">(</span><span class="n">tio</span><span class="p">.</span><span class="n">traces</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">tile_prci_domains</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">tileInsts</span><span class="p">)).</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">prci</span><span class="p">,</span><span class="w"> </span><span class="n">insts</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-1-13"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">clock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">prci</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">clock</span>
</span><span id="__span-1-14"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">prci</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">reset</span><span class="p">.</span><span class="n">asBool</span>
</span><span id="__span-1-15"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">      </span><span class="n">port</span><span class="p">.</span><span class="n">insns</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">insts</span>
</span><span id="__span-1-16"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-17"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
</span><span id="__span-1-18"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="n">tio</span>
</span><span id="__span-1-19"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="p">})</span>
</span><span id="__span-1-20"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它从 traceNexus 上接了若干的 trace 信号，然后通过 <code>IO(TraceOutputTop())</code> 接到了顶层的输出信号。</p>
<p>再来看看 Rocket 是如何连接的，首先是 <code>traceNode</code> 的定义：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cm">/** Node for the core to drive legacy "raw" instruction trace. */</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">traceSourceNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeSource</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="n">traceRetireWidth</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">TracedInstruction</span><span class="p">()))</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="cm">/** Node for external consumers to source a legacy instruction trace from the core. */</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">traceNode</span><span class="p">:</span><span class="w"> </span><span class="nc">BundleBridgeOutwardNode</span><span class="p">[</span><span class="nc">Vec</span><span class="p">[</span><span class="nc">TracedInstruction</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">traceNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">traceSourceNode</span>
</span></code></pre></div>
<p>然后 Rocket Tile 实现的时候，把自己的 trace 接到 traceSourceNode 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">outer</span><span class="p">.</span><span class="n">traceSourceNode</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">trace</span>
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_2">添加自定义调试信号</a></h3>
<p>到这里，整个思路已经比较清晰了，我们只需要照猫画虎地做一个就行。比如要把自己的 Custom Debug 接口暴露出去，首先也是在 Tile 里面创建一个 SourceNode：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-4-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugSourceNode</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nc">BundleBridgeSource</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">CustomDebug</span><span class="p">())</span>
</span><span id="__span-4-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugNode</span><span class="p">:</span><span class="w"> </span><span class="nc">BundleBridgeOutwardNode</span><span class="p">[</span><span class="nc">CustomDebug</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">customDebugSourceNode</span>
</span></code></pre></div>
<p>在 BaseTileModuleImp 里，进行信号的连接：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">outer</span><span class="p">.</span><span class="n">customDebugSourceNode</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">core</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">debug</span>
</span></code></pre></div>
<p>为了暴露到顶层，我们可以类似地做。在 Subsystem 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">// expose debug</span>
</span><span id="__span-6-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugNexus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">BundleBridgeNexusNode</span><span class="p">[</span><span class="nc">CustomDebug</span><span class="p">]()</span>
</span><span id="__span-6-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">tileCustomDebugNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiles</span>
</span><span id="__span-6-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="p">.</span><span class="n">flatMap</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="n">tile</span><span class="p">:</span><span class="w"> </span><span class="nc">MeowV64Tile</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-6-5"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="nc">Some</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span>
</span><span id="__span-6-6"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-7"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">  </span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">.</span><span class="n">customDebugNode</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-6-8"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>
</span><span id="__span-6-9"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="n">tileCustomDebugNodes</span><span class="p">.</span><span class="n">foreach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">customDebugNexus</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>最后在 SubsystemModule Imp 中连接到 IO：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">// wire custom debug signals</span>
</span><span id="__span-7-2"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebugIO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outer</span><span class="p">.</span><span class="n">customDebugNexus</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">_1</span><span class="p">)</span>
</span><span id="__span-7-3"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">customDebug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span>
</span><span id="__span-7-4"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="nc">Output</span><span class="p">(</span>
</span><span id="__span-7-5"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="nc">Vec</span><span class="p">(</span><span class="n">customDebugIO</span><span class="p">.</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">customDebugIO</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">cloneType</span><span class="p">)</span>
</span><span id="__span-7-6"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-7-7"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="p">)</span>
</span><span id="__span-7-8"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">customDebug</span><span class="p">.</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-9"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="n">customDebug</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">customDebugIO</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-7-10"><a href="../../hardware/2022/05/13/rocket-chip-custom-debug/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就搞定了。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/13/rocket-chip-custom-debug/#_3">总结</a></h3>
<p>找到这个实现方法，基本是对着自带的 trace 接口做的，比较重要的是理解 diplomacy 里面的两层，第一层是把不同的模块进行一些连接，然后第二层在 ModuleImp 中处理实际的信号和逻辑。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/05/13/rocket-chip-custom-debug/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-10 00:00:00">2022年5月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 13 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/">「教学」内存认证算法</a></h2>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_2">背景</a></h3>
<p>之前 @松 给我讲过一些内存认证（Memory Authentication）算法的内容，受益匪浅，刚好今天某硬件群里又讨论到了这个话题，于是趁此机会再学习和整理一下相关的知识。</p>
<p>内存认证计算的背景是可信计算，比如要做一些涉及重要数据的处理，从软件上，希望即使系统被攻击非法进入了，也可以保证重要信息不会泄漏；从硬件上，希望即使系统可以被攻击者进行一些物理的操作（比如导出或者修改内存等等），也可以保证攻击者无法读取或者篡改数据。</p>
<p>下面的内容主要参考了 <a href="https://link.springer.com/chapter/10.1007/978-3-642-01004-0_1">Hardware Mechanisms for Memory Authentication: A Survey of Existing Techniques and Engines</a> 这篇 2009 年的文章。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_3">威胁模型</a></h3>
<p>作为一个防御机制，首先要确定攻击方的能力。一个常见的威胁模型是认为，攻击者具有物理的控制，可以任意操控内存中的数据，但是无法读取或者修改 CPU 内部的数据。也就是说，只有 CPU 芯片内的数据是可信的，离开了芯片都是攻击者掌控的范围。一个简单的想法是让内存中保存的数据是加密的，那么怎样攻击者可以如何攻击加密的数据？下面是几个典型的攻击方法：</p>
<ul>
<li>Spoofing attack：把内存数据改成任意攻击者控制的数据；这种攻击可以通过签名来解决</li>
<li>Splicing or relocation attack：把某一段内存数据挪到另一部分，这样数据的签名依然是正确的；所以计算签名时需要把地址考虑进来，这样地址变了，验证签名就会失败</li>
<li>Replay attack：如果同一个地址的内存发生了改变，攻击者可以把旧的内存数据再写进去，这样签名和地址都是正确的；为了防止重放攻击，还需要引入计数器或者随机 nonce</li>
</ul>
<h3 id="authentication-primitives"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#authentication-primitives">Authentication Primitives</a></h3>
<p>为了防御上面几种攻击方法，上面提到的文章里提到了如下的思路：</p>
<p>一是 Hash Function，把内存分为很多个块，每一块计算一个密码学 Hash 保存在片内，那么读取数据的时候，把整块数据读取进来，计算一次 Hash，和片内保存的结果进行比对；写入数据的时候，重新计算一次修改后数据的 Hash，更新到片内的存储。这个方法的缺点是没有加密，攻击者可以看到内容，只不过一修改就会被 CPU 发现（除非 Hash 冲突），并且存储代价很大：比如 512-bit 的块，每一块计算一个 128-bit 的 Hash，那就浪费了 25% 的空间，而片内空间是十分宝贵的。</p>
<p>二是 MAC Function，也就是密码学的消息验证码，它需要一个 Key，保存在片内；由于攻击者不知道密码，根据 MAC 的性质，攻击者无法篡改数据，也无法伪造 MAC，所以可以直接把计算出来的 MAC 也保存到内存里。为了防御重放攻击，需要引入随机的 nonce，并且把 nonce 保存在片内，比如每 512-bit 的数据，保存 64-bit 的 nonce，这样片内需要保存 12.5% 的空间，依然不少。MAC 本身也不加密，所以如果不希望攻击者看到明文，还需要进行加密。</p>
<p>三是 Block-Level AREA，也就是在把明文和随机的 nonce 拼接起来，采用块加密算法，保存在内存中；解密的时候，验证最后的 nonce 和片内保存的一致。这个方法和 MAC 比较类似，同时做了加密的事情，也需要在片内保存每块数据对应的随机 nonce。</p>
<h3 id="integrity-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#integrity-tree">Integrity Tree</a></h3>
<p>但是上面几种方法开销都比较大，比如要保护 1GB 的内存，那么片内就要保存几百 MB 的数据，这对于片内存储来说太大了。这时候，可以采用区块链里常用的 Merkle Tree 或者类似的方法来用时间换空间。</p>
<p>这种方法的主要思路是，首先把内存划分为很多个块，这些块对应一颗树的叶子结点；自底向上构建一颗树，每个结点可以验证它的子结点的完整性，那么经过 log(n) 层的树，最后只会得到一个很小的根结点，只需要把根结点保存在片内。</p>
<p>为了验证某一个块的完整性，就从这一块对应的叶子结点开始，不断计算出一个值，和父亲结点比较；再递归向上，最后计算出根结点的值，和片内保存的值进行对比。这样验证的复杂度是 O(logn)，但是片内保存的数据变成了 O(1)，所以是以时间换空间。更新数据的时候，也是类似地从叶子结点一步一步计算，最后更新根结点的值。</p>
<p>这个方法浪费的空间，考虑所有非叶子结点保存的数据，如果是二叉树，总的大小就是数据的一半，但是好处是大部分都可以保存在内存里，所以是比较容易实现的。缺点是每次读取和写入都要进行 O(logn) 次的内存访问和计算，开销比较大。</p>
<p>上面提到的父结点的值的计算方法，如果采用密码学 Hash 函数，这棵树就是 Merkle Tree。它的验证过程是只读的，可以并行的，但是更新过程是串行的，因为要从子结点一步一步计算 Hash，父结点依赖子结点的 Hash 结果。</p>
<p>另一种设计是 Parallelizable Authentication Tree（PAT），它采用 MAC 而不是 Hash，每个结点保存了一个随机的 nonce 和计算出来的 MAC 值，最底层的 MAC 输入是实际的数据，其他层的 MAC 输入是子结点的 nonce，最后在片内保存最后一次 MAC 使用的 nonce 值。这样的好处是更新的时候，每一层都可以并行算，因为 MAC 的输入是 nonce 值，不涉及到子结点的 MAC 计算结果。缺点是要保存更多数据，即 MAC 和 nonce。</p>
<p>还有一种设计是 Tamper-Evident Counter Tree（TEC-Tree），计算的方法则是上面提到的 Block-level AREA。类似地，最底层是用数据和随机 nonce 拼起来做加密，而其他层是用子节点的随机 nonce 拼起来，再拼接上这一层的 nonce 做加密。验证的时候，首先对最底层进行解密，然后判断数据是否匹配，然后再解密上一层，判断 nonce 是否匹配，一直递归，最后解密到根的 nonce，和片内保存的进行匹配。更新的时候，也可以类似地一次性生产一系列的 nonce，然后并行地加密每一层的结果。</p>
<p>最后引用文章里的一个对比：</p>
<p><img alt="" src="/images/memory_integrity.png"/></p>
<p>可以看到，后两种算法可以并行地更新树的节点，同时也需要保存更多的数据。</p>
<h3 id="cached-trees"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#cached-trees">Cached Trees</a></h3>
<p>从上面的 Integrity Tree 算法可以发现，每次读取或者写入都要访问内存 O(logn) 次，这个对性能影响是十分巨大的。一个简单的思路是，我把一些经常访问的树结点保存在片内的缓存，这样就可以减少一些内存访问次数；进一步地，如果认为攻击者无法篡改片内的缓存，那就可以直接认为片内的结点都是可信的，在验证和更新的时候，只需要从叶子结点遍历到缓存在片内的结点即可。</p>
<h3 id="the-bonsai-merkle-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#the-bonsai-merkle-tree">The Bonsai Merkle Tree</a></h3>
<p>为了进一步减少空间的占用，Bonsai Merkle Tree（BMT）的思路是，既然对每个内存块都生成一个比较长的（比如 64 位）的 nonce 比较耗费空间，那是否可以减少一下 nonce 的位数，当 nonce 出现重复的时候，换一个密钥重新加密呢？具体的做法是，每个内存块做一次 MAC 计算，输入是数据，地址和 counter：<code>M=MAC(C, addr, ctr)</code>。此时，地址和 <code>ctr</code> 充当了原来的 nonce 的作用，所以类似地，此时的 Merkle Tree 保护的是这些 counter，由于 counter 位数比较少，就可以进一步地减少空间的开销，而且树的层数也更少了。缺点是既然位数少了，如果 counter 出现了重复，就需要更换密钥，重新进行一次加密，这个比较耗费时间，所以还要尽量减少重新加密的次数。</p>
<p>具体来说，为了避免重放攻击，每次更新数据的时候，就让 counter 加一，这和原来采用一个足够长（比如 64-bit）的随机 nonce 是类似的。重新加密是很耗费时间的，因此为了把重新加密的范围局限到一个小的局部，又设计了一个两级的 counter：7-bit 的 local counter，每次更新数据加一；64-bit 的 global counter，当某一个 local counter 溢出的时候加一。这时候实际传入 MAC 计算的 counter 则是 global counter 拼接上 local counter。这样相当于是做了一个 counter 的共同前缀，在内存访问比较均匀的时候，比如每个 local counter 轮流加一，那么每次 local counter 溢出只需要重新加密一个小范围的内存，减少了开销。</p>
<p>文章后续还提到了一些相关的算法，这里就不继续翻译和总结了。</p>
<h3 id="mountable-merkle-tree"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#mountable-merkle-tree">Mountable Merkle Tree</a></h3>
<p>再来看一下 <a href="https://www.usenix.org/system/files/osdi21-feng.pdf">Scalable Memory Protection in the Penglai Enclave</a> 中提到的 Mountable Merkle Tree 设计。它主要考虑的是动态可变的保护内存区域，比如提到的微服务场景，并且被保护内存区域的访问有时间局部性，因此它的思路是，不去构造一个对应完整内存的 Merkle Tree，而是允许一些子树不存在。具体来说，它设计了一个 Sub-root nodes 的概念，对应了 Merkle Tree 中间的一层。这一层往上是预先分配好的，并且大部分保存在内存中，根结点保存在片内，这一层往下是动态分配的。比如应用创建了一个新的 enclave，需要新的一个被保护的内存区域，再动态分配若干个 Merkle Tree，接到 Sub-root nodes 层，成为新的子树。</p>
<p><img alt="" src="/images/mountable_merkle_tree.png"/></p>
<p>由于片内空间是有限的，所以这里采取了缓存的方式，只把一部分常用的树结点保存在片内；如果某一个子树一直没有被访问，就可以换出到内存里。如果删除了一个已有的 enclave，那么相应的子树就可以删掉，减少内存空间的占用。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/10/memory-authentication/#_4">参考文献</a></h3>
<ul>
<li><a href="https://link.springer.com/chapter/10.1007/978-3-642-01004-0_1">Hardware Mechanisms for Memory Authentication: A Survey of Existing Techniques and Engines</a></li>
<li><a href="https://www.usenix.org/system/files/osdi21-feng.pdf">Scalable Memory Protection in the Penglai Enclave</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/05/10/memory-authentication/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-09 00:00:00">2022年5月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 16 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="tilelink"><a class="toclink" href="../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_1">背景</a></h3>
<p>最近在研究一些支持缓存一致性的缓存的实现，比如 rocket-chip 的实现和 sifive 的实现，因此需要研究一些 TileLink 协议。本文讨论的时候默认读者具有一定的 AXI 知识，因此很多内容会直接参考 AXI。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_2">信号</a></h3>
<p>根据 <a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink Spec 1.8.0</a>，TileLink 分为以下三种：</p>
<ul>
<li>TL-UL: 只支持读写，不支持 burst，类比 AXI-Lite</li>
<li>TL-UH：支持读写，原子指令，预取，支持 burst，类比 AXI+ATOP（AXI5 引入的原子操作）</li>
<li>TL-C：在 TL-UH 基础上支持缓存一致性协议，类比 AXI+ACE/CHI</li>
</ul>
<h3 id="tilelink-uncached"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tilelink-uncached">TileLink Uncached</a></h3>
<p>TileLink Uncached(TL-UL 和 TL-UH) 包括了两个 channel：</p>
<ul>
<li>A channel: M-&gt;S 发送请求，类比 AXI 的 AR/AW/W</li>
<li>D channel: S-&gt;M 发送响应，类比 AXI 的 R/W</li>
</ul>
<p>因此 TileLink 每个周期只能发送读或者写的请求，而 AXI 可以同时在 AR 和 AW channel 上发送请求。</p>
<p>一些请求的例子：</p>
<ul>
<li>读：M-&gt;S 在 A channel 上发送 Get，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>写：M-&gt;S 在 A channel 上发送 PutFullData/PutPartialData，S-&gt;M 在 D channel 是发送 AccessAck</li>
<li>原子操作：M-&gt;S 在 A channel 上发送 ArithmeticData/LogicalData，S-&gt;M 在 D channel 上发送 AccessAckData</li>
<li>预取操作：M-&gt;S 在 A channel 上发送 Intent，S-&gt;M 在 D channel 上发送 AccessAck</li>
</ul>
<h3 id="axi4totl"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#axi4totl">AXI4ToTL</a></h3>
<p>针对 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L59">AXI4ToTL</a> 模块的例子，来分析一下如何把一个 AXI4 Master 转换为 TileLink。</p>
<p>首先考虑一下 AXI4 和 TileLink 的区别：一个是读写 channel 合并了，所以这里需要一个 Arbiter；其次 AXI4 中 AW 和 W 是分开的，这里也需要进行合并。这个模块并不考虑 Burst 的情况，而是由 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/Fragmenter.scala#L14=">AXI4Fragmenter</a> 来进行拆分，即添加若干个 AW beat，和 W 进行配对。</p>
<p>具体到代码实现上，首先把 AR channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L86=">对应到</a> 到 A channel 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">r_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">r_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Get</span><span class="p">(</span><span class="n">r_id</span><span class="p">,</span><span class="w"> </span><span class="n">r_addr</span><span class="p">,</span><span class="w"> </span><span class="n">r_size</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>然后 AW+W channel 也<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L119=">连接</a> 到 A channel，由于不用考虑 burst 的情况，这里在 aw 和 w 同时 valid 的时候才认为有请求。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">w_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">last</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">ready</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">w_out</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">w_out</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">valid</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="n">w_out</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:&lt;=</span><span class="w"> </span><span class="n">edgeOut</span><span class="p">.</span><span class="nc">Put</span><span class="p">(</span><span class="n">w_id</span><span class="p">,</span><span class="w"> </span><span class="n">w_addr</span><span class="p">,</span><span class="w"> </span><span class="n">w_size</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">strb</span><span class="p">).</span><span class="n">_2</span>
</span></code></pre></div>
<p>比较有意思的是读写的 id 增加了若干位，最低位 0 表示读，1 表示写，剩下几位是请求编号，这样发出去的是不同 id 的多个请求。</p>
<p>然后，把读和写的 A channel <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/amba/axi4/ToTL.scala#L155=">连接</a>到 Arbiter 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nc">TLArbiter</span><span class="p">(</span><span class="nc">TLArbiter</span><span class="p">.</span><span class="n">roundRobin</span><span class="p">)(</span><span class="n">out</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">r_out</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">w_out</span><span class="p">))</span>
</span></code></pre></div>
<p>其余的部分则是对 D channel 进行判断，有数据的转给 R channel，没有数据的转给 B channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">d_hasData</span><span class="p">,</span><span class="w"> </span><span class="n">ok_r</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">ok_b</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">ok_r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">d_hasData</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">ok_b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">d_hasData</span>
</span></code></pre></div>
<p>最后处理了一下 TileLink 和 AXI4 对写请求返回确认的区别：TileLink 中，可以在第一个 burst beat 就返回确认，而 AXI4 需要在最后一个 burst beat 之后返回确认。</p>
<h3 id="tltoaxi4"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tltoaxi4">TLToAXI4</a></h3>
<p>再来看一下反过来的转换，从 TileLink Master 到 AXI。由于 TileLink 同时只能进行读或者写，所以它首先做了一个虚构的 arw channel，可以理解为合并了 ar 和 aw channel 的 AXI4，这个设计在 SpinalHDL 的代码中也能看到。然后再根据是否是写入，分别<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L153=">连接</a>到 ar 和 aw channel：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">queue_arw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Queue</span><span class="p">.</span><span class="n">irrevocable</span><span class="p">(</span><span class="n">out_arw</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span><span class="o">=</span><span class="n">combinational</span><span class="p">)</span>
</span><span id="__span-4-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span>
</span><span id="__span-4-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span>
</span><span id="__span-4-6"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="n">queue_arw</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">queue_arw</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">wen</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">aw</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">ar</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p><a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L197=">这里</a>处理了 aw 和 w 的 valid 信号：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">out_arw</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">a_isPut</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">doneAW</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">out_w</span><span class="p">.</span><span class="n">ready</span><span class="p">,</span><span class="w"> </span><span class="nc">Bool</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
</span><span id="__span-5-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">out_w</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">stall</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">a_isPut</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">doneAW</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">out_arw</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span>
</span></code></pre></div>
<p>这样做的原因是，在 TileLink 中，每个 burst 都是一个 a channel 上的请求，而 AXI4 中，只有第一个 burst 有 aw 请求，所有 burst 都有 w 请求，因此这里用 doneAW 信号来进行区分。</p>
<p>接着，要把 b 和 r channel 上的结果连接到 d channel，根据上面的经验，<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/ToAXI4.scala#L205=">这里</a> 又是一个 arbitration：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">r_wins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">b_delay</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">r_holds_d</span>
</span><span id="__span-6-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">r_wins</span>
</span><span id="__span-6-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">r_wins</span>
</span><span id="__span-6-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="n">in</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">r_wins</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">valid</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span>
</span></code></pre></div>
<p>最后还处理了一下请求和结果顺序的问题。</p>
<h3 id="tilelink-cached"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#tilelink-cached">TileLink Cached</a></h3>
<p>上面说的两个模块都是 TileLink Uncached，那么它如何支持缓存一致性呢？首先，它引入了三个 channel：B、C 和 E，支持三种操作：</p>
<ul>
<li>Acquire：M-&gt;S 在 A channel 上发送 Acquire，S-&gt;M 在 D channel 上发送 Grant，然后 M-&gt;S 在 E channel 上发送 GrantAck；功能是获取一个 copy，可以看到这个和 Get 是类似的，都是在 A channel 上发送请求，在 D channel 上接受响应，只不过额外需要在 E channel 上发送 GrantAck。</li>
<li>Release：M-&gt;S 在 C channel 上发送 Release，S-&gt;M 在 D channel 上发送 ReleaseAck；功能是删除自己的 copy，一般是缓存行要被换出的时候，发送 ReleaseData 来写回 Dirty 数据</li>
<li>Probe：S-&gt;M 在 B channel 上发送 Probe，M-&gt;S 在 C channel 上发送 ProbeAck；功能是要求 M 删除自己的 copy，通常是有某一个缓存发送了 Acquire，导致其他缓存需要降低权限</li>
</ul>
<p>可以看到，A C E 三个 channel 是 M-&gt;S，B D 两个 channel 是 S-&gt;M。</p>
<p>假如一个缓存（Master A）要写入一块只读数据，或者读取一块 miss 的缓存行，如果是广播式的缓存一致性协议，那么需要经历如下的过程：</p>
<ul>
<li>Master A -&gt; Slave: Acquire</li>
<li>Slave -&gt; Master B: Probe</li>
<li>Master B -&gt; Slave: ProbeAck</li>
<li>Slave -&gt; Master A: Grant</li>
<li>Master A -&gt; Slave: GrantAck</li>
</ul>
<p>首先 Master A 发出 Acquire 请求，然后 Slave 向其他 Master 广播 Probe，等到其他 Master 返回 ProbeAck 后，再向 Master A 返回 Grant，最后 Master A 发送 GrantAck 给 Slave。这样 Master A 就获得了这个缓存行的一份拷贝，并且让 Master B 的缓存行失效或者状态变成只读。</p>
<p>TileLink 的缓存行有三个状态：None，Branch 和 Trunk(Tip)。基本对应 MSI 模型：None-&gt;Invalid，Branch-&gt;Shared 和 Trunk-&gt;Modified。Rocket Chip 代码中 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Metadata.scala#L10=">ClientStates</a> 还定义了 Dirty 状态，大致对应 MESI 模型：None-&gt;Invalid，Branch-&gt;Shared，Trunk-&gt;Exclusive，Dirty-&gt;Modified。</p>
<p>此外，标准还说可以在 B 和 C channel 上进行 TL-UH 的操作。标准这么设计的意图是可以让 Slave 转发操作到拥有缓存数据的 Master 上。比如 Master A 在 A channel 上发送 Put 请求，那么 Slave 向 Master B 的 B channel 上发送 Put 请求，Master B 在 C channel 上发送 AccessAck 响应，Slave 再把响应转回 Master A 的 D channel。这就像是一个片上的网络，Slave 负责在 Master 之间路由请求。</p>
<h3 id="broadcast"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#broadcast">Broadcast</a></h3>
<p>接下来看看 Rocket Chip 自带的基于广播的缓存一致性协议实现。核心实现是 <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala">TLBroadcast</a>，核心的逻辑就是，如果一个 Master A 发送了 Acquire，那么 TLBroadcast 需要发送 Probe 到其他的 Master，当其他的 Master 都响应了 ProbeAck 后，再返回 Grant 到 Master A。</p>
<p>首先来看 B channel 上的 Probe <a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L214=">逻辑</a>。它记录了一个 todo bitmask，表示哪些 Master 需要发送 Probe，这里采用了 Probe Filter 来减少发送 Probe 的次数，因为只需要向拥有这个缓存行的 Master 发送 Probe：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-7-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">())</span>
</span><span id="__span-7-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</span><span id="__span-7-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">leftOR</span><span class="p">(</span><span class="n">probe_todo</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-7-5"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_busy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe_todo</span><span class="p">.</span><span class="n">orR</span><span class="p">()</span>
</span><span id="__span-7-6"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="kd">val</span><span class="w"> </span><span class="n">probe_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nc">Mux1H</span><span class="p">(</span><span class="n">probe_next</span><span class="p">,</span><span class="w"> </span><span class="n">cache_targets</span><span class="p">)</span>
</span><span id="__span-7-7"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>
</span><span id="__span-7-8"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="c1">// Probe whatever the FSM wants to do next</span>
</span><span id="__span-7-9"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_busy</span>
</span><span id="__span-7-10"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">caches</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-11"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">bits</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">edgeIn</span><span class="p">.</span><span class="nc">Probe</span><span class="p">(</span><span class="n">probe_line</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">lineShift</span><span class="p">,</span><span class="w"> </span><span class="n">probe_target</span><span class="p">,</span><span class="w"> </span><span class="n">lineShift</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">probe_perms</span><span class="p">).</span><span class="n">_2</span>
</span><span id="__span-7-12"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="p">}</span>
</span><span id="__span-7-13"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="n">b</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">probe_todo</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">probe_next</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>这里 <code>probe_next</code> 就是被 probe 的那个 Master 对应的 bitmask，<code>probe_target</code> 就是 Master 的 Id。这个 Probe FSM 的输入就是 Probe Filter，它会<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L256=">给出</a>哪些 Cache 拥有当前的缓存行的信息：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">leaveB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">gaveT</span>
</span><span id="__span-8-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">others</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">cacheOH</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">allocOH</span>
</span><span id="__span-8-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kd">val</span><span class="w"> </span><span class="n">todo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">leaveB</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">others</span><span class="p">)</span>
</span><span id="__span-8-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">ready</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">probe_busy</span>
</span><span id="__span-8-5"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">fire</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-6"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="n">probe_todo</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">todo</span>
</span><span id="__span-8-7"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="n">probe_line</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">lineShift</span>
</span><span id="__span-8-8"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="n">probe_perms</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">filter</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">needT</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toN</span><span class="p">,</span><span class="w"> </span><span class="nc">TLPermissions</span><span class="p">.</span><span class="n">toB</span><span class="p">)</span>
</span><span id="__span-8-9"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里又区分两种情况：如果 Acquire 需要进入 Trunk 状态（比如是个写入操作），意味着其他 Master 需要进入 None 状态，所以这里要发送 toN；如果 Acquire 不需要进入 Trunk 状态（比如是个读取操作），那么只需要其他 Master 进入 Branch 状态，所以这里要发送 toB。</p>
<p>在 B channel 发送 Probe 的同时，也要<a href="https://github.com/chipsalliance/rocket-chip/blob/850e1d5d56989f031fe3e7939a15afa1ec165d64/src/main/scala/tilelink/Broadcast.scala#L152=">处理</a> C channel 上的 ProbeAck 和 ProbeAckData：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// Incoming C can be:</span>
</span><span id="__span-9-2"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="c1">// ProbeAck     =&gt; decrement tracker, drop </span>
</span><span id="__span-9-3"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="c1">// ProbeAckData =&gt; decrement tracker, send out A as PutFull(DROP)</span>
</span><span id="__span-9-4"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="c1">// ReleaseData  =&gt;                    send out A as PutFull(TRANSFORM)</span>
</span><span id="__span-9-5"><a href="../../hardware/2022/05/09/tilelink/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="c1">// Release      =&gt; send out D as ReleaseAck</span>
</span></code></pre></div>
<p>由于这里采用的是 invalidation based，所以如果某个 Master 之前处于 Dirty 状态，那么它会发送 ProbeAckData，此时需要把数据写回，所以需要用 PutFull 把数据写出去。</p>
<h3 id="serialization"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#serialization">Serialization</a></h3>
<p>下面来讨论一下 TileLink 对各组信号的一些要求。</p>
<h4 id="flow-control-rules"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#flow-control-rules">Flow Control Rules</a></h4>
<p>首先是 Flow Control Rules，讨论的是 ready 和 valid 信号的关系，目的是防止死锁。首先是两个比较常规的要求：</p>
<ul>
<li>If ready is LOW, the receiver must not process the beat and the sender must not consider the beat processed.</li>
<li>If valid is LOW, the receiver must not expect the control or data signals to be a syntactically correct TileLink beat.</li>
</ul>
<p>第一个说的就是 valid &amp; ready 的时候才认为是一个 beat 处理了，第二个就是如果 valid=LOW，那么信号可能是随机的、不合法的。</p>
<ul>
<li>valid must never depend on ready. If a sender wishes to send a beat, it must assert valid independently of whether the receiver signals that it is ready.</li>
<li>As a consequence, there must be no combinational path from ready to valid or any of the control and data signals.</li>
</ul>
<p>这里是为了防止组合逻辑出现环路，如果 valid 依赖 ready，ready 依赖 valid，就会出现问题，所以这里规定，valid 不能依赖 ready，反过来只能 ready 依赖 valid。类似地，其他的数据和控制信号也不可以依赖 ready。简单理解就是 sender 要主动提供数据，而 receiver 决定了是否接受。</p>
<ul>
<li>A low priority valid may not combinationally depend on a high priority valid. In other words, the decision to send a request may not be based on receiving a response in the same cycle.</li>
<li>A high priority ready may not combinationally depend on a low priority ready. In other words, acceptance of a response may not be made contingent upon a request being accepted the same cycle.</li>
</ul>
<p>这两条的意思是，同一个周期内，我设置发送的请求的 valid，不能依赖于同一个周期内接受到的响应的 valid，比如 A 的 valid 不能组合依赖于 D 的 valid。另一方面，我设置的响应的 ready 不能依赖于同一个周期内的请求，比如 D 的 ready 不能组和依赖于 A 的 ready。</p>
<p>那么，有这么几种用法是可以的：</p>
<ul>
<li>It is acceptable for a receiver to drive ready in response to valid or any of the control and data signals. For example, an arbiter may lower ready if a valid request is made for an address which is busy. However, whenever possible, it is recommended that ready be driven independently so as to reduce the handshaking circuit depth. 接收方可以让 ready 依赖于 valid 或者其他的控制和数据信号，不过这样会让组合逻辑比较长。</li>
<li>A channel may change valid and all control and data signals based on the value of ready in the prior cycle. For example, after a request has been accepted (ready HIGH), a new request may be presented. Only a same-cycle dependency of valid on ready is forbidden. 可以让当前周期的 valid 依赖于上一个周期的 ready 信号，只是不能有同周期的 valid 对 ready 的依赖。</li>
<li>A device may legally drive valid for a response based on valid of a request in the same cycle. For example, a combinational ROM which answers immediately. In this case, presumably ready for the request will likewise be driven by ready for the response. The converse relationship is forbidden. 设备可以让响应的 valid 依赖请求的 valid，比如一个组合的 ROM，它的 D channel 的 valid 可以组合依赖于 A channel 的 valid，同时 A channel 的 ready 组合依赖于 D channel 的 ready。这样就简化了设备的设计，并且可以无延迟地进行访问。</li>
</ul>
<p>和 AXI 不同的一点在于，TileLink 不要求 irrevocable，也就是说如果一个周期内 valid=HIGH 但是 ready=LOW，那么下一个周期 Master 可以修改控制和数据信号，也可以让 valid=LOW。</p>
<div class="language-text highlight"><pre><span></span><code>Note that a sender may raise valid and then lower it on the following
cycle, even if the message was not accepted on the previous cycle. For example,
the sender might have some other higher priority task to perform on the
following cycle, instead of trying to send the rejected message again.
Furthermore, the sender may change the contents of the control and data signals
when a message was not accepted.
</code></pre></div>
<p>TileLink 的 burst 请求是通过比 bus 更宽的 size 的多个 beat 组成的。一旦第一个 beat fire 了，后续只能发送同一个 burst 的数据，不可以交错。</p>
<h4 id="request-response-message-ordering"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#request-response-message-ordering">Request-Response Message Ordering</a></h4>
<p>这里讨论的是请求和响应的顺序关系。TileLink 规定，响应的第一个 beat 不早于第一个请求的 beat，比如：</p>
<ul>
<li>对于 Get 请求，如果响应需要多个 beat，那么第一个 beat 不早于请求的那一个周期，这个比较常规，意思是可以组合返回响应。</li>
<li>对于 Put 请求，如果请求需要多个 beat，那么响应可以在第一个请求的 beat 的周期，这个比较特别，意思是对于多个 beat 的请求，可以立即返回响应，不需要等到所有请求的 beat 完成。</li>
<li>对于 ArithmeticData 请求，响应和请求都可能有多个 beat，那么响应的第一个 beat 不早于请求的第一个 beat 即可，其他没有顺序要求。</li>
</ul>
<h4 id="deadlock-freedom"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#deadlock-freedom">Deadlock Freedom</a></h4>
<p>那么多规则，一个很重要的目的是要防止死锁。为了防止死锁，有这样三条：</p>
<ol>
<li>The agent graph (Section 5.3) contains no cycles</li>
<li>Agents must eventually present all beats of a received message</li>
<li>Unless they have a higher priority message in flight or unanswered<ol>
<li>Agents must eventually accept a presented beat</li>
<li>Agents must eventually answer a received request message</li>
</ol>
</li>
</ol>
<p>大概意思是，beat 不能无限推迟，无论是发送方还是接受方。对于每个请求，它的响应不能无限推迟。</p>
<p>TileLink 定义了各个 channel 的优先级，从低到高是 <code>A&lt;B&lt;C&lt;D&lt;E</code>。对于同一个 channel，A C E 上是 master/sender 优先级更高，B D 上是 slave/receiver 优先级更高。</p>
<p>TileLink 的设计里保证了，每个请求的响应都比请求优先级更高。比如 A channel 的请求（Get/Put/AcquireBlock）的响应在 D channel（AccessAckData/AccessAck/Grant），B channel 的请求（Probe）的响应在 C channel（ProbeAck），C channel 的请求（Release）的响应在 D channel（ReleaseAck），D channel 的请求（Grant）的响应在 E channel（GrantAck）。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/09/tilelink/#_3">参考文档</a></h3>
<ul>
<li><a href="https://github.com/chipsalliance/omnixtend/blob/master/OmniXtend-1.0.3/spec/TileLink-1.8.0.pdf">TileLink spec</a></li>
<li><a href="https://github.com/chipsalliance/rocket-chip">rocket-chip</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/05/09/tilelink/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-05 00:00:00">2022年5月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nuc11-esxi-igpu"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/">NUC11 ESXi 中 iGPU 直通虚拟机</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_1">背景</a></h3>
<p>之前在 NUC11PAKi5 上装了 ESXI 加几个虚拟机系统，但是自带的 iGPU Intel Iris Xe Graphics(Tiger Lake GT-2) 没用上，感觉有些浪费。因此想要给 Windows 直通。在直通到 Windows 后发现会无限重启，最后直通到 Linux 中。</p>
<h3 id="_2"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_2">步骤</a></h3>
<p>第一步是到 esxi 的设备设置的地方，把 iGPU 的 Passthrough 打开，这时候会提示需要重启，但是如果重启，会发现还是处于 Needs reboot 状态。网上进行搜索，发现是 ESXi 自己占用了 iGPU 的输出，<a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">解决方法</a>如下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>esxcli<span class="w"> </span>system<span class="w"> </span>settings<span class="w"> </span>kernel<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-s<span class="w"> </span>vga<span class="w"> </span>-v<span class="w"> </span>FALSE
</span></code></pre></div>
<p>这样设置以后就不会在显卡输出上显示 dcui 了，这是一个比较大的缺点，但是平时也不用自带的显示输出，就无所谓了。</p>
<p>第二步，重启以后，这时候看设备状态就是 Active。回到 Windows 虚拟机，添加 PCI device，然后启动。这时候，我遇到了这样的错误：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>Module ‘DevicePowerOn’ power on failed
</span><span id="__span-1-2"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>Failed to register the device pciPassthru0
</span></code></pre></div>
<p>搜索了一番，<a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">解决方法</a>是关掉 IOMMU。在虚拟机设计中关掉 IOMMU，就可以正常启动了。</p>
<p>第三步，进入 Windows，这时候就可以看到有一个新的未知设备了，VID=8086，PID=9a49；等待一段时间，Windows 自动安装好了驱动，就可以正常识别了。GPU-Z 中可以看到效果如下：</p>
<p><img alt="" src="/images/igpu-passthrough.png"/></p>
<p>不过关机重启的时候会蓝屏，可能还有一些问题，有人在<a href="https://community.intel.com/t5/Graphics/SR-IOV-support-for-intel-Iris-Xe-Graphics-on-i7-1165G7/td-p/1293264">论坛</a>上也说 passthrough 之后会蓝屏。这个问题一直没有解决。</p>
<p>再尝试 Passthrough 到 Linux：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>i915
</span><span id="__span-2-2"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.173500<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>enabling<span class="w"> </span>device<span class="w"> </span><span class="o">(</span><span class="m">0000</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="m">0003</span><span class="o">)</span>
</span><span id="__span-2-3"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.180137<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>VT-d<span class="w"> </span>active<span class="w"> </span><span class="k">for</span><span class="w"> </span>gfx<span class="w"> </span>access
</span><span id="__span-2-4"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182109<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>BAR<span class="w"> </span><span class="m">6</span>:<span class="w"> </span>can<span class="err">'</span>t<span class="w"> </span>assign<span class="w"> </span><span class="o">[</span>???<span class="w"> </span>0x00000000<span class="w"> </span>flags<span class="w"> </span>0x20000000<span class="o">]</span><span class="w"> </span><span class="o">(</span>bogus<span class="w"> </span>alignment<span class="o">)</span>
</span><span id="__span-2-5"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182110<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>VBIOS<span class="w"> </span>tables<span class="w"> </span><span class="o">(</span>VBT<span class="o">)</span>
</span><span id="__span-2-6"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.182541<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>vgaarb:<span class="w"> </span>changed<span class="w"> </span>VGA<span class="w"> </span>decodes:<span class="w"> </span><span class="nv">olddecodes</span><span class="o">=</span>io+mem,decodes<span class="o">=</span>none:owns<span class="o">=</span>none
</span><span id="__span-2-7"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.197374<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span>firmware:<span class="w"> </span>direct-loading<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin
</span><span id="__span-2-8"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="o">[</span><span class="w">    </span><span class="m">2</span>.198037<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Finished<span class="w"> </span>loading<span class="w"> </span>DMC<span class="w"> </span>firmware<span class="w"> </span>i915/tgl_dmc_ver2_08.bin<span class="w"> </span><span class="o">(</span>v2.8<span class="o">)</span>
</span><span id="__span-2-9"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.401676<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>retrieve<span class="w"> </span>link<span class="w"> </span>info,<span class="w"> </span>disabling<span class="w"> </span>eDP
</span><span id="__span-2-10"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.515822<span class="o">]</span><span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Initialized<span class="w"> </span>i915<span class="w"> </span><span class="m">1</span>.6.0<span class="w"> </span><span class="m">20200917</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="m">0000</span>:13:00.0<span class="w"> </span>on<span class="w"> </span>minor<span class="w"> </span><span class="m">0</span>
</span><span id="__span-2-11"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516054<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span><span id="__span-2-12"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="o">[</span><span class="w">    </span><span class="m">3</span>.516144<span class="o">]</span><span class="w"> </span>i915<span class="w"> </span><span class="m">0000</span>:13:00.0:<span class="w"> </span><span class="o">[</span>drm<span class="o">]</span><span class="w"> </span>Cannot<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>crtc<span class="w"> </span>or<span class="w"> </span>sizes
</span></code></pre></div>
<p>OpenCL 也可以检测到：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>intel-opencl-icd<span class="w"> </span>clinfo
</span><span id="__span-3-2"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Number<span class="w"> </span>of<span class="w"> </span>devices<span class="w">                                 </span><span class="m">1</span>
</span><span id="__span-3-3"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span>Device<span class="w"> </span>Name<span class="w">                                     </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Graphics<span class="w"> </span>Gen12LP<span class="w"> </span><span class="o">[</span>0x9a49<span class="o">]</span>
</span><span id="__span-3-4"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w">                                   </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Corporation
</span><span id="__span-3-5"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span>Device<span class="w"> </span>Vendor<span class="w"> </span>ID<span class="w">                                </span>0x8086
</span><span id="__span-3-6"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span>Device<span class="w"> </span>Version<span class="w">                                  </span>OpenCL<span class="w"> </span><span class="m">3</span>.0<span class="w"> </span>NEO
</span><span id="__span-3-7"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span>Device<span class="w"> </span>Numeric<span class="w"> </span>Version<span class="w">                          </span>0xc00000<span class="w"> </span><span class="o">(</span><span class="m">3</span>.0.0<span class="o">)</span>
</span><span id="__span-3-8"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span>Driver<span class="w"> </span>Version<span class="w">                                  </span><span class="m">1</span>.0.0
</span></code></pre></div>
<p>Vulkan：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>vulkaninfo
</span><span id="__span-4-2"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>Group<span class="w"> </span><span class="m">1</span>:
</span><span id="__span-4-3"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span>Properties:
</span><span id="__span-4-4"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">                </span>physicalDevices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-5"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">                        </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-4-6"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">                </span><span class="nv">subsetAllocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-4-7"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">        </span>Present<span class="w"> </span>Capabilities:
</span><span id="__span-4-9"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>:
</span><span id="__span-4-10"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">                        </span>Can<span class="w"> </span>present<span class="w"> </span>images<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>devices:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-11"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">                                </span>Intel<span class="o">(</span>R<span class="o">)</span><span class="w"> </span>Xe<span class="w"> </span>Graphics<span class="w"> </span><span class="o">(</span>TGL<span class="w"> </span>GT2<span class="o">)</span><span class="w"> </span><span class="o">(</span>ID:<span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-4-12"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">                </span>Present<span class="w"> </span>modes:<span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-13"><a href="../../system/2022/05/05/nuc11-igpu-passthrough/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">                        </span>DEVICE_GROUP_PRESENT_MODE_LOCAL_BIT_KHR
</span></code></pre></div>
<p>不过目前还没找到显示输出的方法，只能用 VMware SVGA 或者远程桌面。</p>
<h3 id="_3"><a class="toclink" href="../../system/2022/05/05/nuc11-igpu-passthrough/#_3">吐槽</a></h3>
<p>需要吐槽的是，11 代的核显不再支持 Intel GVT-g，而是提供了 SR-IOV 的虚拟化。但是，Linux i915 驱动没有做相应的支持。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://williamlam.com/2020/06/passthrough-of-integrated-gpu-igpu-for-standard-intel-nuc.html">Passthrough of Integrated GPU (iGPU) for standard Intel NUC</a></li>
<li><a href="https://shuttletitan.com/vsphere/pci-passthrough-module-devicepoweron-power-on-failed/">PCI Passthrough – “Module ‘DevicePowerOn’ power on failed”</a></li>
</ul>
<nav class="md-post__action">
<a href="../../system/2022/05/05/nuc11-igpu-passthrough/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-02 00:00:00">2022年5月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="loongarch64"><a class="toclink" href="../../software/2022/05/02/loongarch64-toolchain/">LoongArch64 工具链构建</a></h2>
<p>最近因为龙芯杯的原因，想自己搞个 LoongArch64 的交叉编译工具链试试，结果遇到了很多坑，最后终于算是搞出来了。</p>
<p>一开始是想搞一个 newlib 的工具链，比较简单，而且之前做过一个仓库：<a href="https://github.com/jiegec/riscv-toolchain">jiegec/riscv-toolchain</a>，就是构建的 riscv64-unknown-elf 工具链，照着 riscv-gnu-toolchain 就可以了。不过研究发现，newlib 还不支持 loongarch，目前只有 glibc 支持，只好硬着头皮上了。</p>
<p>于是我就在 riscv-toolchain 的基础上搞 loongarch64-unknown-linux-gnu，也就是带 glibc 的工具链，结果发现遇到很多坑。首先编译 libgcc 的时候就找不到头文件，于是先要从 glibc 和 linux 安装头文件到 sysroot 里面，对于 sysroot 里面的头文件路径到底是 include 还是 usr/include 也折腾了半天。然后编译 libgcc 又各种出问题，最后折腾了半天，结果是 gcc stage1 和 glibc 都没问题，gcc stage2 会报链接错误，但是不管它也能用，可以编译出正常的程序，毕竟 libc 是好的。</p>
<p>于是转念一想，要不要试试 crosstool-ng。克隆了一份上游的版本，照着 riscv 的部分抄了一份变成了 loongarch，然后把 config 里面的 linux/glibc/gcc/binutils-gdb 都替换为 custom location，这样我就可以用上游的最新版本了。中途还遇到了 <a href="https://github.com/crosstool-ng/crosstool-ng/issues/1564">crosstool-ng 对 gcc 12/13 不兼容的 bug</a>，还好下面有人提出了解决方法。这些都搞定以后，终于构建出了一个完整的 loongarch64-unknown-linux-gnu 工具链。仓库地址是 <a href="https://github.com/jiegec/ct-ng-loongarch64">jiegec/ct-ng-loongarch64</a>，需要配合添加了 LoongArch 的 <a href="https://github.com/jiegec/crosstool-ng/tree/loongarch">jiegec/crosstool-ng loongarch 分支</a> 使用。</p>
<p>最后得到的工具链各组件版本如下：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>loongarch64-unknown-linux-gnu-gcc (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.0 20220502 (experimental)
</span><span id="__span-0-2"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-3"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>This is free software; see the source for copying conditions.  There is NO
</span><span id="__span-0-4"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</span><span id="__span-0-5"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>GNU ld (crosstool-NG 1.25.0_rc2.1_7e21141) 2.38.50.20220502
</span><span id="__span-0-7"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-8"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>This program is free software; you may redistribute it under the terms of
</span><span id="__span-0-9"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>the GNU General Public License version 3 or (at your option) a later version.
</span><span id="__span-0-10"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>This program has absolutely no warranty.
</span><span id="__span-0-11"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>GNU gdb (crosstool-NG 1.25.0_rc2.1_7e21141) 13.0.50.20220502-git
</span><span id="__span-0-12"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>Copyright (C) 2022 Free Software Foundation, Inc.
</span><span id="__span-0-13"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span><span id="__span-0-14"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>This is free software: you are free to change and redistribute it.
</span><span id="__span-0-15"><a href="../../software/2022/05/02/loongarch64-toolchain/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>There is NO WARRANTY, to the extent permitted by law.
</span></code></pre></div>
<p>之后有时间的话，再把 qemu 和系统搞起来跑跑。</p>
<p>UPDATE: GCC 12.1 发布了，试了一下这个正式版本可以正确地编译。目前还需要使用 HEAD 版本的 binutils 和龙芯的 glibc 和 linux。</p>
<p>参考文档：</p>
<ul>
<li><a href="https://github.com/sunhaiyong1978/CLFS-for-LoongArch/blob/main/CLFS_For_LoongArch64-20220108.md">手把手教你构建基于 LoongArch64 架构的 Linux 系统</a></li>
<li><a href="https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/">How to Build a GCC Cross-Compiler</a></li>
</ul>
<nav class="md-post__action">
<a href="../../software/2022/05/02/loongarch64-toolchain/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-04-19 00:00:00">2022年4月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ch32v307"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/">试用沁恒 CH32V307 评估板</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_1">背景</a></h3>
<p>之前有一天看到朋友在捣鼓 CH32V307，因此自己也萌生了试用 CH32V307 评估板的兴趣，于是在<a href="http://www.wch.cn/services/request_sample.html">沁恒官网申请样品</a>，很快就接到电话了解情况，几天后就顺丰送到了，不过因为疫情原因直到现在才拿到手上，只能说疫情期间说不定货比人还快。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_2">开箱</a></h3>
<p>收到的盒子里有一个 <a href="http://special.wch.cn/zh_cn/RISCV_MCU_Index/">CH32V307 评估板</a>，和一个 <a href="http://www.wch.cn/products/WCH-Link.html">WCH-Link</a>，相关资料可以在 <a href="http://www.wch.cn/products/CH32V307.html">官网</a> 或者 <a href="https://github.com/openwch/ch32v307">openwch/ch32v307</a> 下载。在说明书中有如下的图示：</p>
<p><img alt="" src="/images/ch32v307.png"/></p>
<p>板子自带的跳线帽不是很多，建议自备一些，或者用杜邦线替代。比较重要的是 WCH-Link 子板上 CH549 和 CH2V307 连接的几个信号，和下面 BOOT0/1 的选择。</p>
<h3 id="wch-link"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#wch-link">WCH-Link</a></h3>
<p>可以看到评估板自带了一个 WCH-Link，所以不需要附赠的那一个，直接把 11 号 Type-C 连接到电脑上即可。这里还遇到一个小插曲，用 Type-C to Type-C 的线连电脑上不工作，连 PWR LED 都点不亮，换一根 Type-A to Type-C 的就可以，没有继续研究是什么原因。电脑上可以看到 WCH-Link 的设备：VID=1a86, PID=8010。比较有意思的是，在 RISC-V 模式（CON 灯不亮）的时候 PID 是 8010，ARM 模式（CON 灯亮）的时候 PID 是 8011，从 RISC-V 模式切换到 ARM 模式的方法是连接 TX 和 GND 后上电，反过来要用 MounRiver，详见 WCH-Link 使用说明 <a href="http://www.wch.cn/uploads/file/20210707/1625645582172366.pdf">V1.0</a> <a href="http://www.wch.cn/uploads/file/20210906/1630922260396691.pdf">V1.3</a> 和原理图 <a href="http://www.wch.cn/uploads/file/20210104/1609725144187113.pdf">V1.1</a>。</p>
<p>给沁恒开源 WCH-Link 原理图并开放固件点个赞，在淘宝上也可以看到不少 WCH-Link 的仿真器，挺有意思的。</p>
<p>在 ARM 模式下，它实现了类似 <a href="https://www.keil.com/support/man/docs/dapdebug/dapdebug_introduction.htm">CMSIS-DAP</a> 的协议，可以用 OpenOCD 调试：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>interface<span class="o">/</span>cmsis-dap.cfg<span class="k">]</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">1000</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nv">cmsis_dap_vid_pid</span><span class="w"> </span><span class="mh">0x1a86</span><span class="w"> </span><span class="mh">0x8011</span>
</span><span id="__span-0-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-0-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nv">init</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>openocd.cfg
</span><span id="__span-1-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0
</span><span id="__span-1-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-1-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-1-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>SWD<span class="w">  </span>Supported
</span><span id="__span-1-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>FW<span class="w"> </span><span class="nv">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>.0.0
</span><span id="__span-1-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>Initialised<span class="w"> </span><span class="o">(</span>SWD<span class="o">)</span>
</span><span id="__span-1-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>Info<span class="w"> </span>:<span class="w"> </span>SWCLK/TCK<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>SWDIO/TMS<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">TDI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">TDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nTRST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">nRESET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-1-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>Info<span class="w"> </span>:<span class="w"> </span>CMSIS-DAP:<span class="w"> </span>Interface<span class="w"> </span>ready
</span><span id="__span-1-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">1000</span><span class="w"> </span>kHz
</span><span id="__span-1-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-1-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-1-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<p>不过这里我们要用的是 RISC-V 处理器 CH32V307，上面的就当是 WCH-LINK 使用的小贴士。</p>
<p>给评估板插上 USB Type-C 以后，首先上面的 WCH-Link 部分中红色的 PWR 和绿色的 RUN 亮，CON 不亮，说明 WCH-LINK 的 CH549 已经启动，并且处在 RISC-V 模式（CON 不亮）。CH549 是一个 8051 指令集的处理器，上面的跑的 WCH-LINK 固件在网上可以找到，在下面提到的 MounRiver Studio 目录中也有一份。</p>
<h3 id="openocd"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#openocd">OpenOCD</a></h3>
<p>目前开源工具上游还不支持 CH32V307 的开发，需要用 <a href="http://www.mounriver.com/download">MounRiver</a>，支持 Windows 和 Linux，有两部分：</p>
<ul>
<li><a href="http://file.mounriver.com/tools/MRS_Toolchain_Linux_x64_V1.40.tar.xz">MRS_Toolchain_Linux_x64_V1.40.tar.xz</a>: RISC-V GNU Toolchain 和 OpenOCD</li>
<li><a href="http://file.mounriver.com/upgrade/MounRiver_Studio_Community_Linux_x64_V110.tar.xz">MounRiver_Studio_Community_Linux_V110</a>：基于 Eclipse 做的 IDE</li>
</ul>
<p>解压缩后，可以看到它的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c">### wch-arm.cfg</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>cmsis-dap
</span><span id="__span-2-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>swd
</span><span id="__span-2-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nb">source</span><span class="w"> </span><span class="k">[</span><span class="nv">find</span><span class="w"> </span>..<span class="o">/</span>share<span class="o">/</span>openocd<span class="o">/</span>scripts<span class="o">/</span>target<span class="o">/</span>ch32f1x.cfg<span class="k">]</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c">### wch-riscv.cfg</span>
</span><span id="__span-2-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c">##interface wlink</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-2-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nv">wlink_set</span>
</span><span id="__span-2-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-2-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-2-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-2-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>
</span><span id="__span-2-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-2-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-2-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-2-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>
</span><span id="__span-2-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-2-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>
</span><span id="__span-2-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="nv">echo</span><span class="w"> </span><span class="s2">"Ready for Remote Connections"</span>
</span></code></pre></div>
<p>其中 ch32f1x.cfg 就是 stm32f1x.cfg 改了一下名字，可以看到 WCH OpenOCD 把它的 RISC-V 调试协议称为 wlink，估计是取 wch-link 的简称吧。除了 wlink 部分，其他就是正常的 RISC-V CPU 调试的 OpenOCD 配置，比较有意思的就是 IDCODE 设为了 0x00001，比较有个性。</p>
<p>在网上一番搜索，找到了 WCH OpenOCD 的源码 <a href="https://git.minori.work/Embedded_Projects/riscv-openocd-wch">Embedded_Projects/riscv-openocd-wch</a>，是网友向沁恒获取的源代码，毕竟 OpenOCD 是 GPL 软件。简单看了一下代码，是直接把 RISC-V Debug 中的 DMI 操作封装了一下，然后通过 USB Bulk 和 WCH-Link 通信。我从 riscv-openocd 找到了一个比较接近的 <a href="https://github.com/jiegec/riscv-openocd/commit/cc0ecfb6d5b939bd109ea84b07b5eab3cdf80316">commit</a>，然后把 WCH 的代码提交上去，得到了 <a href="https://github.com/jiegec/riscv-openocd/commit/bfa3bc7f98d22fa60ef6d3b2f5d98859fa963f85">diff</a>，有兴趣的可以看看具体实现，甚至把这个支持提交到上游。</p>
<p>有源码以后，就可以在 macOS 上编译了（需要修复三处 clang 报告的编译错误，<a href="https://github.com/jiegec/riscv-openocd/tree/wch">最终代码</a>）：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>./bootstrap
</span><span id="__span-3-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>$<span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/path/to/prefix/openocd<span class="w"> </span>--enable-wlink<span class="w"> </span>--disable-werror<span class="w"> </span><span class="nv">CAPSTONE_CFLAGS</span><span class="o">=</span>-I/opt/homebrew/opt/capstone/include/
</span><span id="__span-3-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>$<span class="w"> </span>make<span class="w"> </span>-j4<span class="w"> </span>install
</span></code></pre></div>
<p>如果遇到 makeinfo 报错，把 homebrew 的 texinfo 加到 PATH 即可。</p>
<p>编译完成后，就可以用前面提到的 wch-riscv.cfg 进行调试了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>/path/to/prefix/openocd<span class="w"> </span>-f<span class="w"> </span>wch-riscv.cfg
</span><span id="__span-4-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-4-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-4-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">'jtag'</span>
</span><span id="__span-4-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-4-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-4-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span><span id="__span-4-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3<span class="w"> </span>
</span><span id="__span-4-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-4-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">'</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-4-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-4-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-4-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-4-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-4-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-4-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-4-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-4-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span></code></pre></div>
<p>这也验证了上面的发现：因为绕过了 jtag，直接发送 dmi，所以 idcode 是假的：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">if</span><span class="p">(</span><span class="n">wchwlink</span><span class="p">){</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">        </span><span class="n">buf_set_u32</span><span class="p">(</span><span class="n">idcode_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00001</span><span class="p">);</span><span class="w">  </span><span class="c1">//Default value,for reuse risc-v jtag debug</span>
</span><span id="__span-5-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="p">}</span>
</span></code></pre></div>
<p>接下来就可以用 GDB 调试了。里面跑了一个样例的程序，就是向串口打印：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>screen<span class="w"> </span>/dev/tty.usbmodem*<span class="w"> </span><span class="m">115200</span>
</span><span id="__span-6-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>SystemClk:72000000
</span><span id="__span-6-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="m">111</span>
</span><span id="__span-6-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">   </span><span class="m">111</span>
</span><span id="__span-6-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">      </span><span class="m">111</span>
</span><span id="__span-6-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">         </span><span class="m">111</span>
</span><span id="__span-6-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">            </span><span class="m">111</span>
</span></code></pre></div>
<p>之后则是针对各个外设，基于沁恒提供的示例代码进行相应的开发了。</p>
<h3 id="baremetal"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#baremetal">Baremetal 代码</a></h3>
<p>接下来看看沁恒提供的代码是如何配置的。在 EVT/EXAM/SRC/Startup/startup_ch32v30x_D8C.S 可以看到初始化的汇编代码。比较有意思的是，这个核心扩展了 mtvec，支持 ARM 的 vector table 模式，即放一个指针数组，而不是指令：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="w">    </span><span class="na">.section</span><span class="w">    </span><span class="no">.vector</span><span class="p">,</span><span class="s">"ax"</span><span class="p">,</span><span class="na">@progbits</span>
</span><span id="__span-7-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">1</span>
</span><span id="__span-7-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nl">_vector_base:</span>
</span><span id="__span-7-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="na">.option</span><span class="w"> </span><span class="no">norvc</span><span class="c1">;</span>
</span><span id="__span-7-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">_start</span>
</span><span id="__span-7-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="mi">0</span>
</span><span id="__span-7-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">NMI_Handler</span><span class="w">                </span><span class="cm">/* NMI */</span>
</span><span id="__span-7-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="na">.word</span><span class="w">   </span><span class="no">HardFault_Handler</span><span class="w">          </span><span class="cm">/* Hard Fault */</span>
</span></code></pre></div>
<p>这些名字如此熟悉，只能说这是 ARVM 了（ARM + RV）。后面的部分比较常规，把 data 段复制到 sram，然后清空 bss：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nl">handle_reset:</span>
</span><span id="__span-8-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="na">.option</span><span class="w"> </span><span class="no">push</span><span class="w"> </span>
</span><span id="__span-8-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="no">.option</span><span class="w"> </span><span class="no">norelax</span><span class="w"> </span>
</span><span id="__span-8-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">        </span><span class="no">la</span><span class="w"> </span><span class="no">gp</span><span class="p">,</span><span class="w"> </span><span class="no">__global_pointer$</span>
</span><span id="__span-8-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="na">.option</span><span class="w"> </span><span class="no">pop</span><span class="w"> </span>
</span><span id="__span-8-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-8-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">_eusrstack</span><span class="w"> </span>
</span><span id="__span-8-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="mi">2</span><span class="p">:</span>
</span><span id="__span-8-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="cm">/* Load data section from flash to RAM */</span>
</span><span id="__span-8-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_data_lma</span>
</span><span id="__span-8-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_data_vma</span>
</span><span id="__span-8-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="no">_edata</span>
</span><span id="__span-8-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-8-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="err">1:</span>
</span><span id="__span-8-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="nf">lw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-8-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span><span id="__span-8-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-8-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="err">2:</span>
</span><span id="__span-8-21"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">        </span><span class="cm">/* Clear bss section */</span>
</span><span id="__span-8-22"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">_sbss</span>
</span><span id="__span-8-23"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">        </span><span class="nf">la</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="no">_ebss</span>
</span><span id="__span-8-24"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="nf">bgeu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="no">f</span>
</span><span id="__span-8-25"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="err">1:</span>
</span><span id="__span-8-26"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">        </span><span class="nf">sw</span><span class="w"> </span><span class="no">zero</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-8-27"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">        </span><span class="nf">addi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
</span><span id="__span-8-28"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">        </span><span class="nf">bltu</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-8-29"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="err">2:</span>
</span></code></pre></div>
<p>最后是进行一些 csr 的配置，然后进入 C 代码：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-9-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0xbc0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>
</span><span id="__span-9-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="cm">/* Enable nested and hardware stack */</span>
</span><span id="__span-9-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1f</span>
</span><span id="__span-9-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="mi">0x804</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>
</span><span id="__span-9-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="cm">/* Enable floating point and interrupt */</span>
</span><span id="__span-9-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x6088</span><span class="w">           </span>
</span><span id="__span-9-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="no">csrs</span><span class="w"> </span><span class="no">mstatus</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>
</span><span id="__span-9-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">_vector_base</span>
</span><span id="__span-9-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="nf">ori</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">           </span>
</span><span id="__span-9-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="no">csrw</span><span class="w"> </span><span class="no">mtvec</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>
</span><span id="__span-9-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="nf">lui</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1ffff</span>
</span><span id="__span-9-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x300</span>
</span><span id="__span-9-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="nf">sh</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x1b0</span><span class="p">(</span><span class="no">a0</span><span class="p">)</span>
</span><span id="__span-9-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="err">1:</span><span class="w">  </span><span class="nf">lui</span><span class="w"> </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="mi">0x40022</span>
</span><span id="__span-9-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="nf">lw</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0xc</span><span class="p">(</span><span class="no">s2</span><span class="p">)</span>
</span><span id="__span-9-21"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="nf">andi</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-9-22"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">    </span><span class="nf">bnez</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="no">b</span>
</span><span id="__span-9-23"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>
</span><span id="__span-9-24"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">    </span><span class="nf">jal</span><span class="w">  </span><span class="no">SystemInit</span>
</span><span id="__span-9-25"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="nf">la</span><span class="w"> </span><span class="no">t0</span><span class="p">,</span><span class="w"> </span><span class="no">main</span>
</span><span id="__span-9-26"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="nf">csrw</span><span class="w"> </span><span class="no">mepc</span><span class="p">,</span><span class="w"> </span><span class="no">t0</span>
</span><span id="__span-9-27"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="nf">mret</span>
</span></code></pre></div>
<p>这里有一些自定义的 csr，比如 corecfgr(0xbc0)，intsyscr(0x804，设置了 HWSTKEN=1, INESTEN=1, PMTCFG=0b11, HWSTKOVEN=1)，具体参考 <a href="http://www.wch.cn/downloads/QingKeV4_Processor_Manual_PDF.html">QingKeV4_Processor_Manual</a>。接着代码往 0x1ffff1b0 写入 0x300，然后不断读取 FLASH Interface (0x40022000) 的 STATR 字段，没有找到代码中相关的定义，简单猜测与 Flash 的零等待/非零等待区有关，因为后续代码要提高频率，因此 Flash 控制器需要增加 wait state。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_3">编译</a></h3>
<p>可以用 MounRiver 编译，也可以用 SiFive 的 riscv64-unknown-elf 工具链进行编译，参考 <a href="https://git.minori.work/Embedded_Projects/CH32V307_Template">Embedded_Projects/CH32V307_Template</a> 项目中的编译方式，修改 <code>riscv64-elf.cmake</code> 为：</p>
<div class="language-cmake highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_SYSTEM_NAME</span><span class="w"> </span><span class="s">Generic</span><span class="p">)</span>
</span><span id="__span-10-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-gcc</span><span class="p">)</span>
</span><span id="__span-10-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER</span><span class="w"> </span><span class="s">riscv64-unknown-elf-g++</span><span class="p">)</span>
</span><span id="__span-10-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="c">## Make CMake happy about those compilers</span>
</span><span id="__span-10-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_TRY_COMPILE_TARGET_TYPE</span><span class="w"> </span><span class="s2">"STATIC_LIBRARY"</span><span class="p">)</span>
</span></code></pre></div>
<p>然后交叉编译就可以了。需要注意的是对 libnosys 的处理，如果没有正确链接，就会出现 syscall，然后在 ecall handler 里面死循环。</p>
<p>如果不想用 CMake，也可以用下面的精简版 Makefile：</p>
<div class="language-make highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nv">USER</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>User/main.c<span class="w"> </span>User/ch32v30x_it.c<span class="w"> </span>User/system_ch32v30x.c
</span><span id="__span-11-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nv">LIBRARY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>../../SRC/Peripheral/src/ch32v30x_misc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_usart.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_gpio.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span>../../SRC/Peripheral/src/ch32v30x_rcc.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span>../../SRC/Debug/debug.c<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span>../../SRC/Startup/startup_ch32v30x_D8C.S
</span><span id="__span-11-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="nv">LDSCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>../../SRC/Ld/Link.ld
</span><span id="__span-11-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="c">## disable libc first</span>
</span><span id="__span-11-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="nv">CFLAGS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>-march<span class="o">=</span>rv32imafc<span class="w"> </span>-mabi<span class="o">=</span>ilp32f<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span>-flto<span class="w"> </span>-ffunction-sections<span class="w"> </span>-fdata-sections<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span>-nostartfiles<span class="w"> </span>-nostdlib<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span>-T<span class="w"> </span><span class="k">$(</span>LDSCRIPT<span class="k">)</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span>-I../../SRC/Debug<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span>-I../../SRC/Core<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span>-I../../SRC/Peripheral/inc<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span>-I./User<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span>-O2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span>-Wl,--print-memory-usage
</span><span id="__span-11-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="c">## link libc &amp; libnosys in the end</span>
</span><span id="__span-11-21"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="nv">CFLAGS_END</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-22"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span>-lc<span class="w"> </span>-lgcc<span class="w"> </span>-lnosys
</span><span id="__span-11-23"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="nv">PREFIX</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span>riscv64-unknown-elf-
</span><span id="__span-11-24"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a>
</span><span id="__span-11-25"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">bin</span>
</span><span id="__span-11-26"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a>
</span><span id="__span-11-27"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="nf">obj/build.bin</span><span class="o">:</span><span class="w"> </span><span class="n">obj</span>/<span class="n">build</span>.<span class="n">elf</span>
</span><span id="__span-11-28"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>objcopy<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>$^<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-11-29"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>
</span><span id="__span-11-30"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="nf">obj/build.elf</span><span class="o">:</span><span class="w"> </span><span class="k">$(</span><span class="nv">USER</span><span class="k">)</span> <span class="k">$(</span><span class="nv">LIBRARY</span><span class="k">)</span>
</span><span id="__span-11-31"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">    </span><span class="k">$(</span>PREFIX<span class="k">)</span>gcc<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>$^<span class="w"> </span><span class="k">$(</span>CFLAGS_END<span class="k">)</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span>
</span><span id="__span-11-32"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a>
</span><span id="__span-11-33"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="nf">clean</span><span class="o">:</span>
</span><span id="__span-11-34"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>obj/*
</span></code></pre></div>
<h3 id="flash"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#flash">烧写 Flash</a></h3>
<p>编译好以后，根据 WCH OpenOCD 的文档，可以用下面的配置来进行烧写：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c">##interface wlink</span>
</span><span id="__span-12-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>wlink
</span><span id="__span-12-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="nv">wlink_set</span>
</span><span id="__span-12-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="k">set</span><span class="w"> </span>_CHIPNAME<span class="w"> </span>riscv
</span><span id="__span-12-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span><span class="nv">$_CHIPNAME</span><span class="w"> </span>cpu<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x00001</span>
</span><span id="__span-12-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="k">set</span><span class="w"> </span>_TARGETNAME<span class="w"> </span><span class="nv">$_CHIPNAME.cpu</span>
</span><span id="__span-12-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="nv">target</span><span class="w"> </span>create<span class="w"> </span><span class="nv">$_TARGETNAME.0</span><span class="w"> </span>riscv<span class="w"> </span><span class="o">-</span>chain-position<span class="w"> </span><span class="nv">$_TARGETNAME</span>
</span><span id="__span-12-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="nv">$_TARGETNAME.0</span><span class="w"> </span><span class="nv">configure</span><span class="w">  </span><span class="o">-</span>work-area-phys<span class="w"> </span><span class="mh">0x80000000</span><span class="w"> </span><span class="o">-</span>work-area-size<span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">-</span>work-area-backup<span class="w"> </span><span class="mi">1</span>
</span><span id="__span-12-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="k">set</span><span class="w"> </span>_FLASHNAME<span class="w"> </span><span class="nv">$_CHIPNAME.flash</span>
</span><span id="__span-12-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>
</span><span id="__span-12-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="nv">flash</span><span class="w"> </span>bank<span class="w"> </span><span class="nv">$_FLASHNAME</span><span class="w"> </span>wch_riscv<span class="w"> </span><span class="mh">0x00000000</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">$_TARGETNAME.0</span>
</span><span id="__span-12-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="nv">init</span>
</span><span id="__span-12-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="nv">halt</span>
</span><span id="__span-12-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a>
</span><span id="__span-12-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="nv">flash</span><span class="w"> </span>erase_sector<span class="w"> </span>wch_riscv<span class="w"> </span><span class="mi">0</span><span class="w"> </span>last
</span><span id="__span-12-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="nv">program</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-12-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="nv">verify_image</span><span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>firmware
</span><span id="__span-12-21"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="nv">wlink_reset_resume</span>
</span><span id="__span-12-22"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="nb">exit</span>
</span></code></pre></div>
<p>输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>$<span class="w"> </span>openocd<span class="w"> </span>-f<span class="w"> </span>program.cfg
</span><span id="__span-13-2"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0+dev-01623-gbfa3bc7f9<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-04-20-09:55<span class="o">)</span>
</span><span id="__span-13-3"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-13-4"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-13-5"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-13-6"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>Info<span class="w"> </span>:<span class="w"> </span>only<span class="w"> </span>one<span class="w"> </span>transport<span class="w"> </span>option<span class="p">;</span><span class="w"> </span>autoselect<span class="w"> </span><span class="s1">'jtag'</span>
</span><span id="__span-13-7"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a>Ready<span class="w"> </span><span class="k">for</span><span class="w"> </span>Remote<span class="w"> </span>Connections
</span><span id="__span-13-8"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a>Info<span class="w"> </span>:<span class="w"> </span>WCH-Link<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>.3
</span><span id="__span-13-9"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a>Info<span class="w"> </span>:<span class="w"> </span>wlink_init<span class="w"> </span>ok
</span><span id="__span-13-10"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>Info<span class="w"> </span>:<span class="w"> </span>This<span class="w"> </span>adapter<span class="w"> </span>doesn<span class="err">'</span>t<span class="w"> </span>support<span class="w"> </span>configurable<span class="w"> </span>speed
</span><span id="__span-13-11"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-13-12"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-13-13"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a>Info<span class="w"> </span>:<span class="w"> </span><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span><span class="nv">datacount</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">progbufsize</span><span class="o">=</span><span class="m">8</span>
</span><span id="__span-13-14"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a>Info<span class="w"> </span>:<span class="w"> </span>Examined<span class="w"> </span>RISC-V<span class="w"> </span>core<span class="p">;</span><span class="w"> </span>found<span class="w"> </span><span class="m">1</span><span class="w"> </span>harts
</span><span id="__span-13-15"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a>Info<span class="w"> </span>:<span class="w">  </span>hart<span class="w"> </span><span class="m">0</span>:<span class="w"> </span><span class="nv">XLEN</span><span class="o">=</span><span class="m">32</span>,<span class="w"> </span><span class="nv">misa</span><span class="o">=</span>0x40901125
</span><span id="__span-13-16"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="o">[</span>riscv.cpu.0<span class="o">]</span><span class="w"> </span>Target<span class="w"> </span>successfully<span class="w"> </span>examined.
</span><span id="__span-13-17"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a>Info<span class="w"> </span>:<span class="w"> </span>starting<span class="w"> </span>gdb<span class="w"> </span>server<span class="w"> </span><span class="k">for</span><span class="w"> </span>riscv.cpu.0<span class="w"> </span>on<span class="w"> </span><span class="m">3333</span>
</span><span id="__span-13-18"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">3333</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>gdb<span class="w"> </span>connections
</span><span id="__span-13-19"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a>Info<span class="w"> </span>:<span class="w"> </span>device<span class="w"> </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>REDACTED
</span><span id="__span-13-20"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a>Info<span class="w"> </span>:<span class="w"> </span>flash<span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>256kbytes
</span><span id="__span-13-21"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>riscv.cpu<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x00000001<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x000<span class="w"> </span><span class="o">(</span>&lt;invalid&gt;<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x0000,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-13-22"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-22" id="__codelineno-13-22" name="__codelineno-13-22"></a>Warn<span class="w"> </span>:<span class="w"> </span>Bypassing<span class="w"> </span>JTAG<span class="w"> </span>setup<span class="w"> </span>events<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>errors
</span><span id="__span-13-23"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-23" id="__codelineno-13-23" name="__codelineno-13-23"></a>**<span class="w"> </span>Programming<span class="w"> </span>Started<span class="w"> </span>**
</span><span id="__span-13-24"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-24" id="__codelineno-13-24" name="__codelineno-13-24"></a>**<span class="w"> </span>Programming<span class="w"> </span>Finished<span class="w"> </span>**
</span><span id="__span-13-25"><a href="../../hardware/2022/04/19/wch-ch32v307-eval/#__codelineno-13-25" id="__codelineno-13-25" name="__codelineno-13-25"></a>Info<span class="w"> </span>:<span class="w"> </span>Verify<span class="w"> </span>Success
</span></code></pre></div>
<p>访问串口 <code>screen /dev/tty.usbmodem* 115200</code>，可以看到正确地输出了内容。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/04/19/wch-ch32v307-eval/#_4">转发</a></h3>
<p>本文已授权转发到以下的地址：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/wJ0X8qdIWRxavGo9N37QSg">公众号 物联网小生 试用沁恒 CH32V307 评估板</a></li>
<li><a href="https://www.yuque.com/zsafly/lfxyfc/zseeyx">语雀 硬件知识库 试用沁恒 CH32V307 评估板</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/04/19/wch-ch32v307-eval/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-04-10 00:00:00">2022年4月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="vivado-bitstream-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/">导出 Vivado 下载 Bitstream 的 SVF 文件</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#_1">背景</a></h3>
<p>最近在研究如何实现一个远程 JTAG 的功能，目前实现在 <a href="https://github.com/jiegec/jtag-remote-server">jiegec/jtag-remote-server</a>，实现了简单的 XVC 协议，底层用的是 libftdi 的 MPSSE 协议来操作 JTAG。但是，在用 Vivado 尝试的时候，SysMon 可以正常使用，但是下载 Bitstream 会失败，所以要研究一下 Vivado 都做了什么（目前已经修好，是最后一个字节的部分位读取的处理问题）。</p>
<h3 id="svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#svf">SVF</a></h3>
<p>SVF 格式其实是一系列的 JTAG 上的操作。想到这个，也是因为在网上搜到了一个 <a href="https://www.asc.ohio-state.edu/physics/cms/firmwares/dcfeb_v45.svf">dcfeb_v45.svf</a>，里面描述的就是一段 JTAG 操作：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>// Created using Xilinx Cse Software [ISE - 12.4]
</span><span id="__span-0-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>// Date: Mon May 09 11:00:32 2011
</span><span id="__span-0-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>TRST OFF;
</span><span id="__span-0-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>ENDIR IDLE;
</span><span id="__span-0-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>ENDDR IDLE;
</span><span id="__span-0-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>STATE RESET;
</span><span id="__span-0-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>STATE IDLE;
</span><span id="__span-0-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>FREQUENCY 1E6 HZ;
</span><span id="__span-0-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>//Operation: Program -p 0 -dataWidth 16 -rs1 NONE -rs0 NONE -bpionly -e -loadfpga 
</span><span id="__span-0-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>TIR 0 ;
</span><span id="__span-0-12"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>HIR 0 ;
</span><span id="__span-0-13"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>TDR 0 ;
</span><span id="__span-0-14"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>HDR 0 ;
</span><span id="__span-0-15"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>TIR 0 ;
</span><span id="__span-0-16"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>HIR 0 ;
</span><span id="__span-0-17"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>HDR 0 ;
</span><span id="__span-0-18"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>TDR 0 ;
</span><span id="__span-0-19"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>//Loading device with 'idcode' instruction.
</span><span id="__span-0-20"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>SIR 10 TDI (03c9) SMASK (03ff) ;
</span><span id="__span-0-21"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>SDR 32 TDI (00000000) SMASK (ffffffff) TDO (f424a093) MASK (0fffffff) ;
</span><span id="__span-0-22"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>//Boundary Scan Chain Contents
</span><span id="__span-0-23"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>//Position 1: xc6vlx130t
</span><span id="__span-0-24"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>TIR 0 ;
</span><span id="__span-0-25"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>HIR 0 ;
</span><span id="__span-0-26"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>TDR 0 ;
</span><span id="__span-0-27"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>HDR 0 ;
</span><span id="__span-0-28"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>TIR 0 ;
</span><span id="__span-0-29"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>HIR 0 ;
</span><span id="__span-0-30"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>TDR 0 ;
</span><span id="__span-0-31"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>HDR 0 ;
</span><span id="__span-0-32"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>TIR 0 ;
</span><span id="__span-0-33"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>HIR 0 ;
</span><span id="__span-0-34"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>HDR 0 ;
</span><span id="__span-0-35"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>TDR 0 ;
</span><span id="__span-0-36"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>//Loading device with 'idcode' instruction.
</span><span id="__span-0-37"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-0-38"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-0-39"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>//Loading device with 'bypass' instruction.
</span><span id="__span-0-40"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>SIR 10 TDI (03ff) ;
</span><span id="__span-0-41"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>//Loading device with 'idcode' instruction.
</span><span id="__span-0-42"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>SIR 10 TDI (03c9) ;
</span><span id="__span-0-43"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>SDR 32 TDI (00000000) TDO (f424a093) ;
</span><span id="__span-0-44"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>// Loading device with a `jprogram` instruction. 
</span><span id="__span-0-45"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>SIR 10 TDI (03cb) ;
</span><span id="__span-0-46"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>// Loading device with a `isc_noop` instruction. 
</span><span id="__span-0-47"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>SIR 10 TDI (03d4) ;
</span><span id="__span-0-48"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>RUNTEST 100000 TCK;
</span><span id="__span-0-49"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>// Check init_complete in ircapture.
</span><span id="__span-0-50"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>//IR Capture using specified instruction.
</span><span id="__span-0-51"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>SIR 10 TDI (03d4) TDO (0010) MASK (0010) ;
</span><span id="__span-0-52"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>// Loading device with a `isc_enable` instruction. 
</span><span id="__span-0-53"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>SIR 10 TDI (03d0) ;
</span><span id="__span-0-54"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a>SDR 5 TDI (00) SMASK (1f) ;
</span><span id="__span-0-55"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>RUNTEST 100 TCK;
</span><span id="__span-0-56"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>// Loading device with a `isc_program` instruction. 
</span><span id="__span-0-57"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>SIR 10 TDI (03d1) ;
</span><span id="__span-0-58"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a>SDR 32 TDI (ffffffff) SMASK (ffffffff) ;
</span><span id="__span-0-59"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>SDR 32 TDI (ffffffff) ;
</span><span id="__span-0-60"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a>SDR 32 TDI (ffffffff) ;
</span></code></pre></div>
<p>它的语法比较简单，大概就是 <code>SIR</code> 就是向 IR 输入，<code>SDR</code> 就是向 DR 输入，后面跟着的 TDO 和 MASK 表示对输出数据进行判断。比较核心的是下面这几步：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>SIR JPROGRAM
</span><span id="__span-1-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>SIR ISC_NOOP
</span><span id="__span-1-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>RUNTEST 10000 TCK
</span><span id="__span-1-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>SIR ISC_NOOP UNTIL ISC_DONE
</span><span id="__span-1-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>SIR ISC_ENABLE
</span><span id="__span-1-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>SIR ISC_PROGRAM
</span></code></pre></div>
<p>之后就是 bitstream 的内容了。</p>
<h4 id="openocd-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#openocd-svf">OpenOCD 烧写 SVF</a></h4>
<p>有了 SVF 以后，就可以用其他的一些支持 SVF 语法的工具来烧写 FPGA，而不需要 Vivado。比如采用如下的 OpenOCD 配置：</p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c">## openocd config</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c">## use ftdi channel 0</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nv">adapter</span><span class="w"> </span>speed<span class="w"> </span><span class="mi">100000</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nv">adapter</span><span class="w"> </span>driver<span class="w"> </span>ftdi
</span><span id="__span-2-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="nv">transport</span><span class="w"> </span>select<span class="w"> </span>jtag
</span><span id="__span-2-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="nv">ftdi_vid_pid</span><span class="w"> </span><span class="mh">0x0403</span><span class="w"> </span><span class="mh">0x6011</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="nv">ftdi_layout_init</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="mh">0x000b</span>
</span><span id="__span-2-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nv">ftdi_tdo_sample_edge</span><span class="w"> </span>falling
</span><span id="__span-2-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="nv">ftdi_channel</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-2-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nv">reset_config</span><span class="w"> </span>none
</span><span id="__span-2-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="nv">jtag</span><span class="w"> </span>newtap<span class="w"> </span>xcvu37p<span class="w"> </span>tap<span class="w"> </span><span class="o">-</span>irlen<span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">-</span>expected-id<span class="w"> </span><span class="mh">0x14b79093</span>
</span><span id="__span-2-13"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>
</span><span id="__span-2-14"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="nv">init</span>
</span><span id="__span-2-15"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>
</span><span id="__span-2-16"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="nv">svf</span><span class="w"> </span><span class="o">-</span>tap<span class="w"> </span>xcvu37p.tap<span class="w"> </span><span class="o">/</span>path<span class="o">/</span>to<span class="o">/</span>program.svf<span class="w"> </span>progress
</span><span id="__span-2-17"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>
</span><span id="__span-2-18"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="nb">exit</span>
</span></code></pre></div>
<h4 id="vivado-svf"><a class="toclink" href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#vivado-svf">从 Vivado 中导出 SVF</a></h4>
<p>从文件头可以推测，这个功能是 Xilinx 官方提供的，一番搜索，果然找到了命令：<a href="https://blog.xjtag.com/2016/07/creating-svf-files-using-xilinx-vivado/">Creating SVF files using Xilinx Vivado</a></p>
<div class="language-tcl highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nv">program_hw_devices</span><span class="w"> </span><span class="o">-</span>force<span class="w"> </span><span class="o">-</span>svf_file<span class="w"> </span><span class="k">{</span><span class="nv">program.svf</span><span class="k">}</span><span class="w"> </span><span class="k">[</span><span class="nv">get_hw_devices</span><span class="w"> </span>xxx<span class="k">]</span>
</span></code></pre></div>
<p>添加一个 <code>-svf_file</code> 参数后，就会生成一个 svf 文件。下面摘录一段：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>// config/idcode
</span><span id="__span-4-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-4-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-4-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>// config/jprog
</span><span id="__span-4-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>STATE RESET;
</span><span id="__span-4-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>STATE IDLE;
</span><span id="__span-4-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-4-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>SIR 18 TDI (014514) ;
</span><span id="__span-4-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-4-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>RUNTEST 0.100000 SEC;
</span><span id="__span-4-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>// config/jprog/poll
</span><span id="__span-4-12"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>RUNTEST 15000 TCK;
</span><span id="__span-4-13"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-4-14"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>// config/slr
</span><span id="__span-4-15"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>SIR 18 TDI (005924) ;
</span><span id="__span-4-16"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span></code></pre></div>
<p>结合 Xilinx 官网可以下载的 BSDL 文件，可以找到每个 IR 对应的是什么：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>// config/idcode
</span><span id="__span-5-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>SIR 18 TDI (009249) ;
</span><span id="__span-5-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>SDR 32 TDI (00000000) TDO (04b79093) MASK (0fffffff) ;
</span><span id="__span-5-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>// BSDL:
</span><span id="__span-5-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>"IDCODE           (001001001001001001)," &amp; --   DEVICE_ID reg
</span><span id="__span-5-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>attribute IDCODE_REGISTER of XCVU37P_FSVH2892 : entity is
</span><span id="__span-5-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>        "XXXX" &amp;        -- version
</span><span id="__span-5-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>        "0100101" &amp;     -- family
</span><span id="__span-5-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>        "101111001" &amp;   -- array size
</span><span id="__span-5-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>        "00001001001" &amp; -- manufacturer
</span><span id="__span-5-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>        "1";            -- required by 1149.1
</span></code></pre></div>
<p>这一段是检查 IDCODE 是否是目标 FPGA 型号。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>// config/jprog
</span><span id="__span-6-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>STATE RESET;
</span><span id="__span-6-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>STATE IDLE;
</span><span id="__span-6-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>SIR 18 TDI (00b2cb) ;
</span><span id="__span-6-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>SIR 18 TDI (014514) ;
</span><span id="__span-6-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>// BSDL
</span><span id="__span-6-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>"JPROGRAM         (001011001011001011)," &amp; --   PRIVATE
</span><span id="__span-6-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>"ISC_NOOP         (010100010100010100)," &amp; --   PRIVATE, ISC_DEFAULT
</span><span id="__span-6-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>// Modify the below delay for config_init operation (0.100000 sec typical, 0.100000 sec maximum)
</span><span id="__span-6-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>RUNTEST 0.100000 SEC;
</span></code></pre></div>
<p>这一段发送了 JPROGRAM 和 ISC_NOOP 的 IR，然后进入 RUNTEST 状态一段时间。</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>// config/jprog/poll
</span><span id="__span-7-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>RUNTEST 15000 TCK;
</span><span id="__span-7-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>SIR 18 TDI (014514) TDO (011000) MASK (031000) ;
</span><span id="__span-7-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>// BSDL
</span><span id="__span-7-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>"ISC_NOOP         (010100010100010100)," &amp; --   PRIVATE, ISC_DEFAULT
</span></code></pre></div>
这里再次设置 ISC_NOOP，检查了 TDO 中的数据，意义不明。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>// config/slr
</span><span id="__span-8-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>SIR 18 TDI (005924) ;
</span><span id="__span-8-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>SDR 226633216 TDI (0000000400000004e00000008001000c00000004d00000008001000c0000000466aa99550000000400000004000000040000000400000004000000040000
</span><span id="__span-8-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>// BSDL
</span><span id="__span-8-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>"CFG_IN_SLR0      (000101100100100100)," &amp; --   PRIVATE
</span></code></pre></div>
<p>从这里就是开始往里面写入 bitstream，可以看到熟悉的 66aa9955 的同步字符，对比 Bitstream 文件内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>000000c0: ffff ffff ffff ffff aa99 5566 2000 0000  ..........Uf ...
</span><span id="__span-9-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>000000d0: 2000 0000 3002 2001 0000 0000 3002 0001   ...0. .....0...
</span><span id="__span-9-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>000000e0: 0000 0000 3000 8001 0000 0000 2000 0000  ....0....... ...
</span><span id="__span-9-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>000000f0: 3000 8001 0000 0007 2000 0000 2000 0000  0....... ... ...
</span><span id="__span-9-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>00000100: 3000 2001 0000 0000 3002 6001 0000 0000  0. .....0.`.....
</span></code></pre></div>
<p>可以发现是每 32 字节按位颠倒：<code>aa995566(10101010 10011001 01010101 01100110) -&gt; 66aa9955(01100110 10101010 10011001 01010101)</code>，后面的 <code>20000000 -&gt; 00000004</code> 也是类似的。</p>
<p>Xilinx UG570 的 Table 6-5 也印证了上面的过程：</p>
<ul>
<li>Start loading the JPROGRAM instruction, LSB first:</li>
<li>Load the MSB of the JPROGRAM instruction when exiting SHIFT-IR, as defined in the IEEE standard.</li>
<li>Start loading the CFG_IN instruction, LSB first:</li>
<li>Load the MSB of the CFG_IN instruction when exiting SHIFT-IR.</li>
<li>Shift in the FPGA bitstream. Bit n (MSB) is the first bit in the bitstream.(3)(4)</li>
<li>Shift in the last bit of the bitstream. Bit 0 (LSB) shifts on the transition to EXIT1-DR.</li>
</ul>
<p>完成 CFG_IN 之后，再进行 JSTART:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>// config/start
</span><span id="__span-10-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>STATE IDLE;
</span><span id="__span-10-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>RUNTEST 100000 TCK;
</span><span id="__span-10-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>SIR 18 TDI (00c30c) ;
</span><span id="__span-10-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>HIR 0 ;
</span><span id="__span-10-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>TIR 0 ;
</span><span id="__span-10-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>HDR 0 ;
</span><span id="__span-10-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>TDR 0 ;
</span><span id="__span-10-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>STATE IDLE;
</span><span id="__span-10-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>RUNTEST 2000 TCK;
</span><span id="__span-10-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>SIR 18 TDI (009249) TDO (031000) MASK (011000) ;
</span><span id="__span-10-12"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>HIR 0 ;
</span><span id="__span-10-13"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>TIR 0 ;
</span><span id="__span-10-14"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>HDR 0 ;
</span><span id="__span-10-15"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>TDR 0 ;
</span><span id="__span-10-16"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>// BSDL
</span><span id="__span-10-17"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>"JSTART           (001100001100001100)," &amp; --   PRIVATE
</span><span id="__span-10-18"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a>"IDCODE           (001001001001001001)," &amp; --   DEVICE_ID reg
</span></code></pre></div>
<p>然后再次进行 CFG_IN_SLR0, CFG_OUT_SLR0，验证是否真的写进去了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>// config/status
</span><span id="__span-11-2"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>STATE RESET;
</span><span id="__span-11-3"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>RUNTEST 5 TCK;
</span><span id="__span-11-4"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>SIR 18 TDI (005924) ;
</span><span id="__span-11-5"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-11-6"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a>SIR 18 TDI (004924) ;
</span><span id="__span-11-7"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-11-8"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a>STATE RESET;
</span><span id="__span-11-9"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>RUNTEST 5 TCK;
</span><span id="__span-11-10"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a>// BSDL
</span><span id="__span-11-11"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a>"CFG_IN_SLR0      (000101100100100100)," &amp; --   PRIVATE
</span><span id="__span-11-12"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a>"CFG_OUT_SLR0     (000100100100100100)," &amp; --   PRIVATE
</span><span id="__span-11-13"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a>// config/status
</span><span id="__span-11-14"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a>STATE RESET;
</span><span id="__span-11-15"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a>RUNTEST 5 TCK;
</span><span id="__span-11-16"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a>SIR 18 TDI (005924) ;
</span><span id="__span-11-17"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a>SDR 160 TDI (0000000400000004800700140000000466aa9955) ;
</span><span id="__span-11-18"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a>SIR 18 TDI (004924) ;
</span><span id="__span-11-19"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>SDR 32 TDI (00000000) TDO (3f5e0d40) MASK (08000000) ;
</span><span id="__span-11-20"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a>STATE RESET;
</span><span id="__span-11-21"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a>RUNTEST 5 TCK;
</span></code></pre></div>
<p>这段操作是进行 Status Register Readback，见 UG570 的 Table 10-4。MASK 设为 <code>08000000</code> 应该是判断它的第 4 位：END_OF_STARTUP_STATUS（Table 9-25）。</p>
<p>如果是 Quartus 用户，也可以 <a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000085709.html">生成 SVF</a>，具体操作是：在 Programmer 中，点击 <code>File-&gt;Create JAM, JBC, SVF or ISC file</code>，然后在弹出的窗口中选择 svf 格式，导出即可。得到的 svf 文件一样可以用 openocd 来下载。</p>
<p>也可以<a href="https://www.intel.com/content/www/us/en/support/programmable/articles/000074062.html">用 <code>quartus_cpf</code> 在命令行</a>中进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>quartus_cpf<span class="w"> </span>-q<span class="w"> </span>18MHz<span class="w"> </span>-g<span class="w"> </span><span class="m">3</span>.3<span class="w"> </span>-c<span class="w"> </span>-n<span class="w"> </span>p<span class="w"> </span>input.sof/pof<span class="w"> </span>output.svf
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../hardware/2022/04/10/vivado-program-bitstream-svf/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-31 00:00:00">2022年3月31日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 21 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="cpu"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/">浅谈乱序执行 CPU（二）</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/ooo_cpu.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_1">背景</a></h3>
<p>之前写过一个<a href="../../hardware/2021/09/14/brief-into-ooo/">浅谈乱序执行 CPU</a>，随着学习的深入，内容越来越多，页面太长，因此把后面的一部分内容独立出来，变成了这篇博客文章。之后也许会有（三）（四）等等。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_2">内存访问</a></h3>
<p>内存访问是一个比较复杂的操作，它涉及到缓存、页表、内存序等问题。在乱序执行中，要尽量优化内存访问对其他指令的延迟的影响，同时也要保证正确性。这里参考的是 <a href="https://docs.boom-core.org/en/latest/sections/load-store-unit.html">BOOM 的 LSU 设计</a>。</p>
<p>首先是正确性。一般来说可以认为，Load 是没有副作用的（实际上，Load 会导致 Cache 加载数据，这也引发了以 Meltdown 为首的一系列漏洞），因此可以很激进地预测执行 Load。但是，Store 是有副作用的，写出去的数据就没法还原了。因此，Store 指令只有在 ROB Head 被 Commit 的时候，才会写入到 Cache 中。</p>
<p>其次是性能，我们希望 Load 指令可以尽快地完成，这样可以使得后续的计算指令可以尽快地开始进行。当 Load 指令的地址已经计算好的时候，就可以去取数据，这时候，首先要去 Store Queue 里面找，如果有 Store 指令要写入的地址等于 Load 的地址，说明后面的 Load 依赖于前面的 Store，如果 Store 的数据已经准备好了，就可以直接把数据转发过来，就不需要从 Cache 中获取，如果数据还没准备好，就需要等待这一条 Store 完成；如果没有找到匹配的 Store 指令，再从内存中取。不过，有一种情况就是，当 Store 指令的地址迟迟没有计算出来，而后面的 Load 已经提前从 Cache 中获取数据了，这时候就会出现错误，所以当 Store 计算出地址的时候，需要检查后面的 Load 指令是否出现地址重合，如果出现了，就要把这条 Load 以及依赖这条 Load 指令的其余指令重新执行。<a href="http://ieeexplore.ieee.org/abstract/document/7029183/">POWER8 处理器微架构论文</a>中对此也有类似的表述：</p>
<div class="language-text highlight"><pre><span></span><code>The POWER8 IFU also implements mechanisms to mitigate performance
degradation associated with pipeline hazards. A Store-Hit-Load (SHL) is
an out-of-order pipeline hazard condition, where an older store executes
after a younger overlapping load, thus signaling that the load received
stale data. The POWER8 IFU has logic to detect when this condition
exists and provide control to avoid the hazard by flushing the load
instruction which received stale data (and any following instructions).
When a load is flushed due to detection of a SHL, the fetch address of
the load is saved and the load is marked on subsequent fetches allowing
the downstream logic to prevent the hazard. When a marked load
instruction is observed, the downstream logic introduces an explicit
register dependency for the load to ensure that it is issued after the
store operation.
</code></pre></div>
<p>下面再详细讨论一下 LSU 的设计。</p>
<h3 id="load-store-unit"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#load-store-unit">Load Store Unit</a></h3>
<p>LSU 是很重要的一个执行单元，负责 Load/Store/Atomic 等指令的实现。最简单的实现方法是按顺序执行，但由于 pipeline 会被清空，Store/Atomic/Uncached Load 这类有副作用（当然了，如果考虑 Meltdown 类攻击的话，Cached Load 也有副作用，这里就忽略了），需要等到 commit 的时候再执行。这样 LSU 很容易成为瓶颈，特别是在访存指令比较多的时候。</p>
<p>为了解决这个问题，很重要的是让读写也乱序起来，具体怎么乱序，受到实现的影响和 Memory Order/Program Order 的要求。从性能的角度上来看，我们肯定希望 Load 可以尽快执行，因为可能有很多指令在等待 Load 的结果。那么，需要提前执行 Load，但是怎么保证正确性呢？在 Load 更早的时候，可能还有若干个 Store 指令尚未执行，一个思路是等待所有的 Store 执行完毕，但是这样性能不好；另一个思路是用地址来搜索 Store 指令，看看是否出现对同一个地址的 Store 和 Load，如果有，直接转发数据，就不需要从 Cache 获取了，不过这种方法相当于做了一个全相连的 Buffer，面积大，延迟高，不好扩展等问题接踵而至。</p>
<p>为了解决 Store Queue 需要相连搜索的问题，<a href="https://repository.upenn.edu/cgi/viewcontent.cgi?article=1001&amp;context=cis_reports">A high-bandwidth load-store unit for single-and multi-threaded processors</a> 的解决思路是，把 Store 指令分为两类，一类是需要转发的，一类是不需要的，那么可以设计一个小的相连存储器，只保存这些需要转发的 Store 指令；同时还有一个比较大的，保存所有 Store 指令的队列，因为不需要相连搜索，所以可以做的比较大。</p>
<p>仔细想想，这里还有一个问题：Load 在执行前，更早的 Store 的地址可能还没有就绪，这时候去搜索 Store Queue 得到的结果可能是错的，这时候要么等待所有的 Store 地址都就绪，要么就先执行，再用一些机制来修复这个问题，显然后者 IPC 要更好。</p>
<p>修复 Load Store 指令相关性问题，一个方法是当一个 Store 提交的时候，检查是否有地址冲突的 Load 指令（那么 Load Queue 也要做成相连搜索的），是否转发了错误的 Store 数据，这也是 <a href="https://docs.boom-core.org/en/latest/sections/load-store-unit.html#memory-ordering-failures">Boom LSU</a> 采用的方法。另一个办法是 Commit 的时候（或者按顺序）重新执行 Load 指令，如果 Load 结果和之前不同，要把后面依赖的刷新掉，这种方式的缺点是每条 Load 指令都要至少访问两次 Cache。<a href="https://repository.upenn.edu/cgi/viewcontent.cgi?article=1228&amp;context=cis_papers">Store Vulnerability Window (SVW): Re-Execution Filtering for Enhanced Load Optimization</a> 属于重新执行 Load 指令的方法，通过 Bloom filter 来减少一些没有必要重复执行的 Load。还有一种办法，就是预测 Load 指令和哪一条 Store 指令有依赖关系，然后直接去访问那一项，如果不匹配，就认为没有依赖。<a href="https://ieeexplore.ieee.org/document/1540957">Scalable Store-Load Forwarding via Store Queue Index Prediction</a> 把 Load 指令分为三类，一类是不确定依赖哪条 Store 指令（Difficult Loads），一类是基本确定依赖哪一条 Store 指令，一类是不依赖 Store 指令。这个有点像 Cache 里面的 Way Prediction 机制。</p>
<p>分析完了上述一些优化方法，我们也来看一些 CPU 设计采用了哪种方案。首先来分析一下 <a href="https://ieeexplore.ieee.org/abstract/document/7029183">IBM POWER8</a> 的 LSU，首先，可以看到它设计了比较多项目的 virtual STAG/LTAG，然后再转换成比较少项目的 physical STAG/LTAG，这样 LSQ 可以做的比较小，原文：</p>
<div class="language-text highlight"><pre><span></span><code>A virtual STAG/LTAG scheme is used to minimize dispatch holds due to
running out of physical SRQ/LRQ entries. When a physical entry in the
LRQ is freed up, a virtual LTAG will be converted to a real LTAG. When a
physical entry in the SRQ is freed up, a virtual STAG will be converted
to a real STAG. Virtual STAG/LTAGs are not issued to the LSU until they
are subsequently marked as being real in the UniQueue. The ISU can
assign up to 128 virtual LTAGs and 128 virtual STAGs to each thread.
</code></pre></div>
<p>这个思路在 2007 年的论文 <a href="https://people.csail.mit.edu/emer/papers/2007.06.isca.late_binding.pdf">Late-Binding: Enabling Unordered Load-Store Queues</a> 里也可以看到，也许 POWER8 参考了这篇论文的设计。可以看到，POWER8 没有采用那些免除 CAM 的方案：</p>
<div class="language-text highlight"><pre><span></span><code>The SRQ is a 40-entry, real address based CAM structure. Similar to the
SRQ, the LRQ is a 44-entry, real address based, CAM structure. The LRQ
keeps track of out-of-order loads, watching for hazards. Hazards
generally exist when a younger load instruction executes out-of-order
before an older load or store instruction to the same address (in part
or in whole). When such a hazard is detected, the LRQ initiates a flush
of the younger load instruction and all its subsequent instructions from
the thread, without impacting the instructions from other threads. The
load is then re-fetched from the I-cache and re-executed, ensuring
proper load/store ordering.
</code></pre></div>
<p>而是在传统的两个 CAM 设计的基础上，做了减少物理 LSQ 项目的优化。比较有意思的是，POWER7 和 POWER8 的 L1 Cache 都是 8 路组相连，并且采用了 set-prediction 的方式（应该是通常说的 way-prediction）。</p>
<p>此外还有一个实现上的小细节，就是在判断 Load 和 Store 指令是否有相关性的时候，由于地址位数比较多，完整比较的延迟比较大，可以牺牲精度的前提下，选取地址的一部分进行比较。<a href="https://ieeexplore.ieee.org/document/8409955">POWER9 论文</a> 提到了这一点：</p>
<div class="language-text highlight"><pre><span></span><code>POWER8 and prior designs matched the effective address (EA) bits 48:63
between the younger load and the older store queue entry. In POWER9,
through a combination of outright matches for EA bits 32:63 and hashed
EA matches for bits 0:31, false positive avoidance is greatly improved.
This reduces the number of flushes, which are compulsory for false
positives.
</code></pre></div>
<p>这里又是一个精确度和时序上的一个 tradeoff。</p>
<p>具体到 Load/Store Queue 的大小，其实都不大：</p>
<ol>
<li><a href="https://ieeexplore.ieee.org/document/9000513">Zen 2</a> Store Queue 48</li>
<li><a href="https://en.wikichip.org/wiki/intel/microarchitectures/skylake_(client)#Memory_subsystem">Intel Skylake</a> Store Buffer 56 Load Buffer 72</li>
<li><a href="https://ieeexplore.ieee.org/document/7029183?arnumber=7029183">POWER 8</a> Store Queue 40 Load Queue 44 (Virtual 128+128)</li>
<li><a href="http://ieeexplore.ieee.org/document/755465/">Alpha 21264</a> Store Queue 32 Load Queue 32</li>
</ol>
<h3 id="vs"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#vs">精确异常 vs 非精确异常</a></h3>
<p>精确异常是指发生异常的指令之前的指令都完成，之后的没有执行。一般来说，实现方式是完成异常指令之前的所有指令，并撤销异常指令之后的指令的作用。非精确异常则是不保证这个性质，<a href="http://bwrcs.eecs.berkeley.edu/Classes/cs152/lectures/lec12-exceptions.pdf">网上资料</a> 说，这种情况下硬件实现更简单，但是软件上处理比较困难。</p>
<p>一个非精确异常的例子是 <a href="https://courses.cs.washington.edu/courses/cse548/99wi/other/alphahb2.pdf">Alpha</a>，在章节 4.7.6.1 中提到，一些浮点计算异常可能是非精确的，并且说了一句：<code>In general, it is not feasible to fix up the result value or to continue from the trap.</code>。同时给出了一些条件，只有当指令序列满足这些条件的时候，异常才是可以恢复的。还有一段描述，摘录在这里：</p>
<div class="language-text highlight"><pre><span></span><code>Alpha lets the software implementor determine the precision of
arithmetic traps.  With the Alpha architecture, arithmetic traps (such
as overflow and underflow) are imprecise—they can be delivered an
arbitrary number of instructions after the instruction that triggered
the trap. Also, traps from many different instructions can be reported
at once. That makes implementations that use pipelining and multiple
issue substantially easier to build.  However, if precise arithmetic
exceptions are desired, trap barrier instructions can be explicitly
inserted in the program to force traps to be delivered at specific
points.
</code></pre></div>
<p>具体来说，在 <a href="http://www.bitsavers.org/pdf/dec/alpha/Sites_AlphaAXPArchitectureReferenceManual_2ed_1995.pdf">Reference Manual</a> 中第 5.4.1 章节，可以看到当触发 Arithmetic Trap 的时候，会进入 Kernel 的 entArith 函数，并提供参数：a0 表示 exception summary，a1 表示 register write mask。exception summary 可以用来判断发生了什么类型的 exception，比如 integer overflow，inexact result 等等。一个比较特别的 exception 类型是 software completion。第二个参数表示的是触发异常的指令（一个或多个）会写入哪些寄存器（64 位，低 32 位对应整数寄存器，高 32 位对应浮点寄存器），然后保存下来的 PC 值为最后一条执行的指令的下一个地址，从触发异常的第一条指令到最后一条指令就是 trap shadow，这部分指令可能执行了一部分，没有执行一部分，一部分执行结果是错误的。</p>
<p>Linux 处理代码在 <code>arch/alpha/kernel/traps.c</code> 的 <code>do_entArith</code> 函数中。首先判断，如果是 software completion，那就要进行处理；否则直接 SIGFPE 让程序自己处理或者退出。如果是精确异常，那就对 PC-4 进行浮点模拟；如果是非精确异常，就从 trap shadow 的最后一条指令开始往前搜索，并同时记录遇到的指令写入的寄存器，如果发现指令的写入的寄存器已经覆盖了 register write mask，就说明找到了 trap shadow 的开头，则模拟这条指令，然后从下一条开始重新执行。具体代码如下：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">long</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nf">alpha_fp_emul_imprecise</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">write_mask</span><span class="p">)</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">{</span>
</span><span id="__span-0-4"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-5"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-6"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="cm">/*</span>
</span><span id="__span-0-8"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="cm">     * Turn off the bits corresponding to registers that are the</span>
</span><span id="__span-0-9"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="cm">     * target of instructions that set bits in the exception</span>
</span><span id="__span-0-10"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="cm">     * summary register.  We have some slack doing this because a</span>
</span><span id="__span-0-11"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="cm">     * register that is the target of a trapping instruction can</span>
</span><span id="__span-0-12"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="cm">     * be written at most once in the trap shadow.</span>
</span><span id="__span-0-13"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="cm">     *</span>
</span><span id="__span-0-14"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="cm">     * Branches, jumps, TRAPBs, EXCBs and calls to PALcode all</span>
</span><span id="__span-0-15"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="cm">     * bound the trap shadow, so we need not look any further than</span>
</span><span id="__span-0-16"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="cm">     * up to the first occurrence of such an instruction.</span>
</span><span id="__span-0-17"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="cm">     */</span>
</span><span id="__span-0-18"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">write_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-19"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="n">get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">__u32</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">trigger_pc</span><span class="p">));</span>
</span><span id="__span-0-20"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">26</span><span class="p">;</span>
</span><span id="__span-0-21"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
</span><span id="__span-0-22"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>
</span><span id="__span-0-23"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-24"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_PAL</span><span class="p">:</span>
</span><span id="__span-0-25"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_JSR</span><span class="p">:</span>
</span><span id="__span-0-26"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="mh">0x30</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">:</span><span class="w">   </span><span class="cm">/* branches */</span>
</span><span id="__span-0-27"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-28"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>
</span><span id="__span-0-29"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_MISC</span><span class="p">:</span>
</span><span id="__span-0-30"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">insn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-31"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">                  </span><span class="k">case</span><span class="w"> </span><span class="no">MISC_TRAPB</span><span class="p">:</span>
</span><span id="__span-0-32"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">                  </span><span class="k">case</span><span class="w"> </span><span class="no">MISC_EXCB</span><span class="p">:</span>
</span><span id="__span-0-33"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">                </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-34"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>
</span><span id="__span-0-35"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">                  </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-0-36"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-37"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-0-38"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-39"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>
</span><span id="__span-0-40"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTA</span><span class="p">:</span>
</span><span id="__span-0-41"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTL</span><span class="p">:</span>
</span><span id="__span-0-42"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTS</span><span class="p">:</span>
</span><span id="__span-0-43"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_INTM</span><span class="p">:</span>
</span><span id="__span-0-44"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">            </span><span class="n">write_mask</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rc</span><span class="p">);</span>
</span><span id="__span-0-45"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-46"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>
</span><span id="__span-0-47"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTC</span><span class="p">:</span>
</span><span id="__span-0-48"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTV</span><span class="p">:</span>
</span><span id="__span-0-49"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTI</span><span class="p">:</span>
</span><span id="__span-0-50"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="no">OPC_FLTL</span><span class="p">:</span>
</span><span id="__span-0-51"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">            </span><span class="n">write_mask</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1UL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="p">));</span>
</span><span id="__span-0-52"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-0-53"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-54"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">write_mask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-55"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">            </span><span class="cm">/* Re-execute insns in the trap-shadow.  */</span>
</span><span id="__span-0-56"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">            </span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-57"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">            </span><span class="n">si_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha_fp_emul</span><span class="p">(</span><span class="n">trigger_pc</span><span class="p">);</span>
</span><span id="__span-0-58"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">egress</span><span class="p">;</span>
</span><span id="__span-0-59"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-0-60"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">        </span><span class="n">trigger_pc</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-0-61"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-62"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>
</span><span id="__span-0-63"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="nl">egress</span><span class="p">:</span>
</span><span id="__span-0-64"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">si_code</span><span class="p">;</span>
</span><span id="__span-0-65"><a href="../../hardware/2022/03/31/brief-into-ooo-2/#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="p">}</span>
</span></code></pre></div>
<p>ARM 架构也有 imprecise asynchronous external abort：</p>
<div class="language-text highlight"><pre><span></span><code>Normally, external aborts are rare. An imprecise asynchronous external
abort is likely to be fatal to the process that is running. An example
of an event that might cause an external abort is an uncorrectable
parity or ECC failure on a Level 2 Memory structure.

Because imprecise asynchronous external aborts are normally fatal to the
process that caused them, ARM recommends that implementations make
external aborts precise wherever possible.
</code></pre></div>
<p>不过这更多是因为内存的无法预知的错误，这种时候机器直接可以拿去维修了。</p>
<p><a href="https://community.arm.com/developer/ip-products/processors/f/cortex-a-forum/5056/can-anyone-provide-an-example-of-asynchronous-exceptions">文章</a> 提到了两个 precise/imprecise async/sync的例子：</p>
<ol>
<li>外部中断是异步的，同时也是 precise 的。</li>
<li>对于一个 Write-allocate 的缓存，如果程序写入一个不存在的物理地址，那么写入缓存的时候不会出现错误，但当这个 cache line 被写入到总线上的时候，就会触发异常，这个异常是异步并且非精确的，因为之前触发这个异常的指令可能已经完成很久了。这种时候这个进程也大概率没救了，直接 SIGBUS 退出。</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_3">处理器前端</a></h3>
<p>再来分析一下乱序执行 CPU 的前端部分。以 RISC-V 为例，指令长度有 4 字节或者 2 字节两种，其中 2 字节属于压缩指令集。如何正确并高效地进行取指令译码？</p>
<p>首先，我们希望前端能够尽可能快地取指令，前端的取指能力要和后端匹配，比如对于一个四发射的 CPU，前端对应地需要一个周期取 <code>4*4=16</code> 字节的指令。但是，这 16 字节可能是 4 条非压缩指令，也可能是 8 条压缩指令，也可能是混合的情况。所以，这里会出现一个可能出现指令条数不匹配的情况，所以中间可以添加一个 Fetch Buffer，比如 <a href="https://github.com/riscv-boom/riscv-boom">BOOM</a> 的实现中，L1 ICache 每周期读取 16 字节，然后进行预译码，出来 8 条指令，保存到 Fetch Buffer 中。这里需要考虑以下几点：首先从 ICache 读取的数据是对齐的，但是 PC 可能不是，比如中间的地址。其次，可能一个 4 字节的非压缩指令跨越了两次 Fetch，比如前 2 个字节在前一个 Fetch Bundle，后 2 个字节在后一个 Fetch Bundle；此外，每个 2 字节的边界都需要判断一下是压缩指令还是非压缩指令。一个非常特殊的情况就是，一个 4 字节的指令跨越了两个页，所以两个页都需要查询页表；如果恰好在第二个页处发生了页缺失，此时 epc 是指令的起始地址，但 tval 是第二个页的地址，这样内核才知道是哪个页发生了缺失。</p>
<p>其次，需要配合分支预测。如果需要保证分支预测正确的情况下，能够在循环中达到接近 100% 的性能，那么，在 Fetch 分支结尾的分支指令的同时，需要保证下一次 Fetch 已经得到了分支预测的目的地址。这个就是 BOOM 里面的 L0 BTB (1-cycle redirect)。但是，一个周期内完成的分支预测，它的面积肯定不能大，否则时序无法满足，所以 BOOM 里面还设计了 2-cycle 和 3-cycle 的比较高级的分支预测器，还有针对函数调用的 RAS（Return Address Stack）。</p>
<p>分支预测也有很多方法。比较简单的方法是实现一个 BHT，每个项是一个 2 位的饱和计数器，超过一半的时候增加，少于一半时减少。但是，如果遇到了跳转/不跳转/跳转/不跳转这种来回切换的情况，准确率就很低。一个复杂一些的设计，就是用 BHR，记录这个分支指令最近几次的历史，对于每种可能的历史，都对应一个 2 位的饱和计数器。这样，遇到刚才所说的情况就会很好地预测。但实践中会遇到问题：如果在写回之前，又进行了一次预测，因为预测是在取指的时候做的，但是更新 BPU 是在写回的时候完成的，这时候预测就是基于旧的状态进行预测，这时候 BHR 就会出现不准确的问题；而且写回 BPU 的时候，会按照原来的状态进行更新，这个状态可能也是错误的，导致丢失一次更新，识别的模式从跳转/不跳转/跳转/不跳转变成了跳转/跳转/跳转/不跳转，这样又会预测错误。一个解决办法是，在取指阶段，BPU 预测完就立即按照预测的结果更新 BHR，之后写回阶段会恢复到实际的 BHR 取值。论文 <a href="https://dl.acm.org/doi/10.1145/192724.192756">The effect of speculatively updating branch history on branch prediction accuracy, revisited</a> 和 <a href="https://jilp.org/vol2/v2paper1.pdf">Speculative Updates of Local and Global Branch History: A Quantitative Analysis</a> 讨论了这个实现方式对性能的影响。</p>
<p>比较容易做预测更新和恢复的是全局分支历史，可以维护两个 GHR（Global History Register），一个是目前取指令最新的，一个是提交的最新的。在预测的时候，用 GHR 去找对应的 2-bit 状态，然后把预测结果更新到 GHR 上。在预测失败的时候，把 GHR 恢复为提交的状态。如果要支持一个 Fetch Packet 中有多个分支，可以让 GHR 对应若干个 2-bit 状态，分别对应相应位置上的分支的状态，当然这样面积也会增加很多。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/03/31/brief-into-ooo-2/#_4">处理器/内存仿真模型</a></h3>
<p>最后列举一下科研里常用的一些处理器/内存仿真模型：</p>
<ul>
<li>gem5: <a href="https://arxiv.org/abs/2007.03152">论文 The gem5 Simulator: Version 20.0+</a> <a href="https://gem5.googlesource.com/public/gem5">代码</a></li>
<li>DRAMSim2: <a href="https://user.eng.umd.edu/~blj/papers/cal10-1.pdf">论文 DRAMSim2: A Cycle Accurate Memory System Simulator</a> <a href="https://github.com/umd-memsys/DRAMSim2">代码</a></li>
<li>DRAMsim3: <a href="https://ieeexplore.ieee.org/document/8999595">论文 DRAMsim3: A Cycle-Accurate, Thermal-Capable DRAM Simulator</a> <a href="https://github.com/umd-memsys/DRAMsim3">代码</a></li>
<li>DRAMSys4.0：<a href="https://link.springer.com/chapter/10.1007/978-3-030-60939-9_8">论文 DRAMSys4.0: A Fast and Cycle-Accurate SystemC/TLM-Based DRAM Simulator</a> <a href="https://github.com/tukl-msd/DRAMSys">代码</a></li>
<li>CACTI: <a href="https://www.hpl.hp.com/research/cacti/cacti2.pdf">论文 CACTI 2.0: An Integrated Cache Timing and Power Model</a> <a href="https://github.com/HewlettPackard/cacti">代码</a></li>
<li>McPAT: <a href="https://ieeexplore.ieee.org/document/5375438">论文 McPAT: An integrated power, area, and timing modeling framework for multicore and manycore architectures</a> <a href="https://github.com/HewlettPackard/mcpat">代码</a></li>
<li>Multi2Sim: <a href="https://ieeexplore.ieee.org/document/7842946">论文 Multi2Sim: A simulation framework for CPU-GPU computing</a> <a href="https://github.com/Multi2Sim/multi2sim">代码</a></li>
<li>Ramulator: <a href="https://users.ece.cmu.edu/~omutlu/pub/ramulator_dram_simulator-ieee-cal15.pdf">论文 Ramulator: A Fast and Extensible DRAM Simulator</a> <a href="https://github.com/CMU-SAFARI/ramulator">代码</a></li>
<li>Scarab: <a href="https://github.com/hpsresearchgroup/scarab">代码</a></li>
<li>Sniper: <a href="https://dl.acm.org/doi/abs/10.1145/2063384.2063454">论文 Sniper: exploring the level of abstraction for scalable and accurate parallel multi-core simulation</a> <a href="https://snipersim.org/w/The_Sniper_Multi-Core_Simulator">官网</a> <a href="https://github.com/snipersim/snipersim">仓库</a></li>
<li>ZSim: <a href="https://people.csail.mit.edu/sanchez/papers/2013.zsim.isca.pdf">论文 ZSim: fast and accurate microarchitectural simulation of thousand-core systems</a> <a href="https://github.com/s5z/zsim">代码</a></li>
<li>PTLsim: <a href="https://ieeexplore.ieee.org/document/4211019">论文 PTLsim: A Cycle Accurate Full System x86-64 Microarchitectural Simulator</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/03/31/brief-into-ooo-2/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-03-30 00:00:00">2022年3月30日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="sv2vyosys-fpnew-verilog"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/">用 sv2v+yosys 把 fpnew 转为 verilog 网表</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/#_1">背景</a></h3>
<p>FPnew 是一个比较好用的浮点计算单元，但它是 SystemVerilog 编写的，并且用了很多高级特性，虽然闭源软件是支持的，但是开源拖拉机经常会遇到这样那样的问题。所以一直想用 sv2v 把它翻译成 Verilog，但此时的 Verilog 还有很多复杂的结构，再用 yosys 转换为一个通用可综合的网表。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/03/30/sv2v-fpnew/#_2">步骤</a></h3>
<p>经过一系列踩坑，一个很重要的点是要用最新的 sv2v(v0.0.9-24-gf868f06) 和 yosys(0.15+70)。Debian 打包的 yosys 版本比较老，不能满足需求。</p>
<p>首先，用 verilator 进行预处理，把一堆 sv 文件合成一个：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>cat<span class="w"> </span>a.sv<span class="w"> </span>b.sv<span class="w"> </span>c.sv<span class="w"> </span>&gt;<span class="w"> </span>test.sv
</span><span id="__span-0-2"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>verilator<span class="w"> </span>-E<span class="w"> </span>test.sv<span class="w"> </span>&gt;<span class="w"> </span>merged.sv
</span><span id="__span-0-3"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'/^`line/d'</span><span class="w"> </span>merged.sv
</span></code></pre></div>
<p>注意这里用 sed 去掉了无用的行号信息。然后，用 sv2v 进行转换：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>sv2v<span class="w"> </span>merged.sv<span class="w"> </span>&gt;<span class="w"> </span>merge.v
</span><span id="__span-1-2"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'/\$$fatal/d'</span><span class="w"> </span>merge.v
</span></code></pre></div>
<p>这里又用 sed 把不支持的 $fatal 去掉。最后，用 yosys 进行处理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>yosys<span class="w"> </span>-p<span class="w"> </span><span class="s1">'read_verilog -defer merge.v'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'hierarchy -p fpnew_top'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'proc'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'opt'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'write_verilog -noattr output.v'</span>
</span></code></pre></div>
<p>注意这里要用 <code>read_verilog -defer</code>，否则 yosys 会遇到 TAG_WIDTH=0 默认参数就直接例化，然后就出现 <code>[0:-1]</code> 这样的下标。<code>read_verilog</code> 的文档告诉了我们可以分两步做：</p>
<div class="language-text highlight"><pre><span></span><code>-defer
    only read the abstract syntax tree and defer actual compilation
    to a later 'hierarchy' command. Useful in cases where the default
    parameters of modules yield invalid or not synthesizable code.
</code></pre></div>
<p>这样就得到了简化后的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">module</span><span class="w"> </span><span class="n">\$paramod$011e4d7ee08c34f246a38322dc9967d23ecc8081\fpnew_opgroup_block_A94B6_B7406</span><span class="w"> </span><span class="p">(</span><span class="n">clk_i</span><span class="p">,</span><span class="w"> </span><span class="n">rst_ni</span><span class="p">,</span><span class="w"> </span><span class="n">operands_i</span><span class="p">,</span><span class="w"> </span><span class="n">is_boxed_i</span><span class="p">,</span><span class="w"> </span><span class="n">rnd_mode_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_i</span><span class="p">,</span><span class="w"> </span><span class="n">op_mod_i</span><span class="p">,</span><span class="w"> </span><span class="n">src_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">int_fmt_i</span><span class="p">,</span><span class="w"> </span><span class="n">vectorial_op_i</span><span class="p">,</span><span class="w"> </span><span class="n">tag_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_valid_i</span><span class="p">,</span><span class="w"> </span><span class="n">in_ready_o</span><span class="p">,</span><span class="w"> </span><span class="n">flush_i</span><span class="p">,</span><span class="w"> </span><span class="n">result_o</span><span class="p">,</span><span class="w"> </span><span class="n">status_o</span><span class="p">,</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">,</span><span class="w"> </span><span class="n">tag_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_valid_o</span><span class="p">,</span><span class="w"> </span><span class="n">out_ready_i</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="p">,</span><span class="w"> </span><span class="n">busy_o</span><span class="p">);</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_0_</span><span class="p">;</span>
</span><span id="__span-3-4"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">_1_</span><span class="p">;</span>
</span><span id="__span-3-5"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">71</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">arbiter_output</span><span class="p">;</span>
</span><span id="__span-3-6"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-3-7"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">busy_o</span><span class="p">;</span>
</span><span id="__span-3-8"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-3-9"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk_i</span><span class="p">;</span>
</span><span id="__span-3-10"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-3-11"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dst_fmt_i</span><span class="p">;</span>
</span><span id="__span-3-12"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-3-13"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">extension_bit_o</span><span class="p">;</span>
</span><span id="__span-3-14"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="n">flush_i</span><span class="p">;</span>
</span><span id="__span-3-15"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-3-16"><a href="../../hardware/2022/03/30/sv2v-fpnew/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="k">endmodule</span>
</span></code></pre></div>
<p>这样虽然比较丑陋，但是解决了 SystemVerilog 的问题。诚然，这样也失去了修改参数的能力，因为参数已经在 yosys 综合途中确定下来了。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/03/30/sv2v-fpnew/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../5/">5</a> <a class="md-pagination__link" href="../6/">6</a> <span class="md-pagination__current">7</span> <a class="md-pagination__link" href="../8/">8</a> <a class="md-pagination__link" href="../9/">9</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>