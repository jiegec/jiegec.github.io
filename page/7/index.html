
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="杰哥的{运维,编程,调板子}小笔记">
      
      
      
        <link rel="canonical" href="https://jia.je/page/7/">
      
      
      
        <link rel="next" href="../../about/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.2.0-b2">
    
    
      
        <title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.83068744.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3109FRSVTT"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3109FRSVTT",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#博客" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              博客
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../open-source-contributions/" class="md-tabs__link">
        
  
    
  
  开源

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/kb/" class="md-tabs__link">
        
  
    
  
  知识库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  项目

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="/feed.xml" class="md-tabs__link">
        
  
    
  
  订阅

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2023/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/crypto/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" aria-label="杰哥的{运维,编程,调板子}小笔记" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../open-source-contributions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/kb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    知识库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="/feed.xml" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    订阅
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2017/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2017
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2016/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2016
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../archive/2014/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/crypto/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    crypto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/csdn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    csdn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/ctf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ctf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    devops
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    life
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/logo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/meta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    meta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    networking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/news/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    news
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/os/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    os
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/speech/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    speech
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../category/unboxing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    unboxing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="博客"><a class="toclink" href="#博客">博客</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-17 00:00:00">2020年3月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-rocket-chip-上挂接-tlram"><a class="toclink" href="../../hardware/2020/03/17/rocket-chip-tlram-load/">在 Rocket Chip 上挂接 TLRAM</a></h2>
<p>最近遇到一个需求，需要在 Rocket Chip 里面开辟一块空间，通过 verilog 的 $readmemh 来进行初始化而不是用 BootROM，这样每次修改内容不需要重新跑一次 Chisel -&gt; Verilog 的流程。然后到处研究了一下，找到了解决的方案：</p>
<p>首先是新建一个 TLRAM 然后挂接到 cbus 上：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-1"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLRAM</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-2"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">tilelink</span><span class="p">.</span><span class="nc">TLFragmenter</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-3"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">LazyModule</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-4"></a><span class="k">import</span><span class="w"> </span><span class="nn">freechips</span><span class="p">.</span><span class="nn">rocketchip</span><span class="p">.</span><span class="nn">diplomacy</span><span class="p">.</span><span class="nc">AddressSet</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-6"></a><span class="k">trait</span><span class="w"> </span><span class="nc">HasTestRAM</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">this</span><span class="p">:</span><span class="w"> </span><span class="nc">BaseSubsystem</span><span class="w"> </span><span class="o">=&gt;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-7"></a><span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">testRAM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LazyModule</span><span class="p">(</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-8"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="nc">TLRAM</span><span class="p">(</span><span class="nc">AddressSet</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1FFF</span><span class="p">),</span><span class="w"> </span><span class="n">beatBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">beatBytes</span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-11"></a><span class="w">  </span><span class="n">testRAM</span><span class="p">.</span><span class="n">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cbus</span><span class="p">.</span><span class="n">coupleTo</span><span class="p">(</span><span class="s">&quot;bootrom&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">TLFragmenter</span><span class="p">(</span><span class="n">cbus</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-0-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的地址和大小都可以自由定义。然后添加到自己的 Top Module 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">(</span><span class="k">implicit</span><span class="w"> </span><span class="n">p</span><span class="p">:</span><span class="nc">Parameters</span><span class="p">)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSystem</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-4"></a><span class="w">    </span><span class="k">with</span><span class="w"> </span><span class="nc">HasTestRAM</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-5"></a><span class="w">    </span><span class="c1">//...</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-7"></a><span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">lazy</span><span class="w"> </span><span class="p">...</span><span class="w">    </span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-1-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际上这时候 TLRAM 就已经加入到了 TileLink 总线中。接着，为了让 firrtl 生成 $readmemh 的代码，需要两个步骤：</p>
<p>首先是用 <code>chisel3.util.experimental.loadMemoryFromFile</code> 函数（文档在 https://github.com/freechipsproject/chisel3/wiki/Chisel-Memories）：</p>
<p>UPDATE：现在的文档在 <a href="https://www.chisel-lang.org/chisel3/docs/appendix/experimental-features#loading-memories-for-simulation-or-fpga-initialization-">Loading Memories for simulation or FPGA initialization</a> 处，并且可以用 loadMemoryFromFileInline。</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestTopImp</span><span class="p">(</span><span class="n">outer</span><span class="p">:</span><span class="w"> </span><span class="nc">TestTop</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-2"></a><span class="w">    </span><span class="k">extends</span><span class="w"> </span><span class="nc">RocketSubsystemModuleImp</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-5"></a><span class="w">    </span><span class="n">loadMemoryFromFile</span><span class="p">(</span><span class="n">outer</span><span class="p">.</span><span class="n">testRAM</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test.hex&quot;</span><span class="p">)</span><span class="w">    </span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-2-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数会生成一个 FIRRTL Annotation，记录了在这里需要对这个 mem 生成对应的 readmemh 调用。然后在 firrtl 的调用里传入 .anno.json 和 transform：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-3-1"></a>$<span class="w"> </span>runMain<span class="w"> </span>firrtl.stage.Main<span class="w"> </span>-i<span class="w"> </span>xxx<span class="w"> </span>-o<span class="w"> </span>xxx<span class="w"> </span>-X<span class="w"> </span>verilog<span class="w"> </span>-faf<span class="w"> </span>/path/to/xxx.anno.json<span class="w"> </span>-fct<span class="w"> </span>chisel3.util.experimental.LoadMemoryTransform
</span></code></pre></div>
<p>UPDATE: 现在不需要 <code>-fct chisel3.util.experimental.LoadMemoryTransform</code> 参数。目前这个功能和生成 blackbox memory 有冲突，不能同时使用，需要等 chisel3 后续修复。</p>
<p>这里的 chisel3.util.experimental.LoadMemoryTransform 会找到 anno.json 里面对应的 Annotation，然后生成类似下面这样的 verilog 代码：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-1"></a><span class="k">module</span><span class="w"> </span><span class="n">xxx</span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-2"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-3"></a><span class="p">);</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-4"></a><span class="w">  </span><span class="c1">// ...</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-5"></a><span class="w">    </span><span class="nb">$readmemh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">mem_xxx</span><span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-6"></a><span class="k">endmodule</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="../../hardware/2020/03/17/rocket-chip-tlram-load/#__codelineno-4-8"></a><span class="n">bind</span><span class="w"> </span><span class="n">TLRAM</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="n">xxx</span><span class="p">(.</span><span class="o">*</span><span class="p">);</span>
</span></code></pre></div>
<p>这里采用了 Verilog 的 bind 功能，可以在不修改模块代码的时候注入，比如上面，就是注入了一个语句 $readmemh，从而达到目的。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2020/03/17/rocket-chip-tlram-load/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-14 00:00:00">2020年3月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-kubernetes-集群上部署-gitlabrunner"><a class="toclink" href="../../devops/2020/03/14/k8s-gitlab-runner/">在 Kubernetes 集群上部署 gitlab—runner</a></h2>
<p>按照 GitLab 上的教程试着把 gitlab-runner 部署到 k8s 集群上，发现异常地简单，所以简单做个笔记：</p>
<p>编辑 <code>values.yaml</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-1"></a>gitlabUrl: GITLAB_URL
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-2"></a>runnerRegistrationToken: &quot;REDACTED&quot;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-3"></a>rbac:
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-0-4"></a>    create: true
</span></code></pre></div>
<p>此处的信息按照 "Set up a specific Runner manually" 下面的提示填写。然后用 Helm 进行安装：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-1"></a>$<span class="w"> </span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>gitlab<span class="w"> </span>https://charts.gitlab.io
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-2"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>gitlab-runner
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2020/03/14/k8s-gitlab-runner/#__codelineno-1-3"></a>$<span class="w"> </span>helm<span class="w"> </span>install<span class="w"> </span>--namespace<span class="w"> </span>gitlab-runner<span class="w"> </span>gitlab-runner<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>gitlab/gitlab-runner
</span></code></pre></div>
<p>然后去 Kubernetes Dashboard 就可以看到部署的情况，回到 GitLab 也可以看到出现了“Runners activated for this project” ，表示配置成功。</p>
<p>参考配置：https://docs.gitlab.com/runner/install/kubernetes.html</p>

    <nav class="md-post__action">
      <a href="../../devops/2020/03/14/k8s-gitlab-runner/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-10 00:00:00">2020年3月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-kubernetes-部署无状态服务"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/">用 Kubernetes 部署无状态服务</a></h2>
<h3 id="背景"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>最近需要部署一个用来跑编译的服务，服务从 MQ 取任务，编译完以后提交任务。最初的做法是包装成 docker，然后用 docker-compose 来 scale up。但既然有 k8s 这么好的工具，就试着学习了一下，踩了很多坑，总结了一些需要用到的命令。</p>
<h3 id="搭建-docker-registry"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#%C3%A6%C2%90%C2%AD%C3%A5%C2%BB%C2%BA-docker-registry">搭建 Docker Registry</a></h3>
<p>首先搭建一个本地的 Docker Repository，首先设置密码：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-0-1"></a>$<span class="w"> </span>mkdir<span class="w"> </span>auth
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-0-2"></a>$<span class="w"> </span>htpasswd<span class="w"> </span>user<span class="w"> </span>pass<span class="w"> </span>&gt;<span class="w"> </span>auth/passwd
</span></code></pre></div>
<p>然后运行 registry：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-1"></a>$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">5000</span>:5000<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-2"></a><span class="w">        </span>--restart<span class="o">=</span>always<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-3"></a><span class="w">        </span>--name<span class="w"> </span>registry<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-4"></a><span class="w">        </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/registry&quot;</span>:/var/lib/registry<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-5"></a><span class="w">        </span>-v<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/auth&quot;</span>:/auth<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-6"></a><span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH=htpasswd&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-7"></a><span class="w">        </span>-e<span class="w"> </span><span class="s2">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-8"></a><span class="w">        </span>-e<span class="w"> </span><span class="nv">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="o">=</span>/auth/htpasswd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-1-9"></a><span class="w">        </span>registry:2
</span></code></pre></div>
<p>简单起见没有配 tls。然后吧本地的 image push 上去：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-2-1"></a>$<span class="w"> </span>docker<span class="w"> </span>tag<span class="w"> </span><span class="nv">$image</span><span class="w"> </span>localhost:5000/<span class="nv">$image</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-2-2"></a>$<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>localhost:5000/<span class="nv">$image</span>
</span></code></pre></div>
<p>这样就可以了。</p>
<h3 id="搭建-k8s-环境"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#%C3%A6%C2%90%C2%AD%C3%A5%C2%BB%C2%BA-k8s-%C3%A7%C2%8E%C2%AF%C3%A5%C2%A2%C2%83">搭建 k8s 环境</a></h3>
<p>考虑到只用了单个物理机，所以采用的是 minikube。首先下载 minikube，下载方法略去。</p>
<p>接着新建 minikube 虚拟机：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-3-1"></a>$<span class="w"> </span>minikube<span class="w"> </span>start<span class="w"> </span>--registry-mirror<span class="o">=</span>https://registry.docker-cn.com<span class="w"> </span>--image-mirror-country<span class="o">=</span>cn<span class="w"> </span>--image-repository<span class="o">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers<span class="w"> </span>--vm-driver<span class="o">=</span>kvm2<span class="w"> </span>--insecure-registry<span class="o">=</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="w"> </span>--disk-size<span class="o">=</span>50GB<span class="w"> </span>--cpus<span class="w"> </span><span class="m">128</span><span class="w"> </span>--memory<span class="w"> </span><span class="m">131072</span>
</span></code></pre></div>
<p>这里的 0.0.0.0/0 可以缩小，磁盘、CPU 和内存需要在这里就设好，之后不能改，要改只能重新开个虚拟机，不过这个过程也挺快的。</p>
<p>然后初始化一些组件（metrics server 和 kubernetes dashboard）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-4-1"></a>$<span class="w"> </span>minikube<span class="w"> </span>addons<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>metrics-server
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-4-2"></a>$<span class="w"> </span>minikube<span class="w"> </span>dashboard
</span></code></pre></div>
<p>如果要访问 dashboard 的话，可以用上面命令输出的链接，或者用 <code>kubectl proxy</code> 然后打开  http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ （注意 http 还是 https）。</p>
<p>如果问到 Access Token，可以用以下 alias 获得（fish/macOS）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-5-1"></a>$<span class="w"> </span><span class="nb">alias</span><span class="w"> </span><span class="nv">kubedashboard</span><span class="o">=</span><span class="s2">&quot;kubectl -n kubernetes-dashboard describe secret (kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#39;{print \$1}&#39;) | tail -n1 | awk &#39;{print \$2}&#39; | pbcopy&quot;</span>
</span></code></pre></div>
<p>接着，配置一下 docker registry 的密钥：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-6-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>regcred<span class="w"> </span>--from-file<span class="o">=</span>.dockerconfigjson<span class="o">=</span>/path/to/config.json<span class="w">  </span>--type<span class="o">=</span>kubernetes.io/dockerconfigjson
</span></code></pre></div>
<p>然后，在 Pod/Deployment 里面设定镜像：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-1"></a>containers:
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-2"></a>  - name: name
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-3"></a>    image: IP:5000/image
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-4"></a>imagePullSecrets:
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-7-5"></a>  - name: regcred
</span></code></pre></div>
<p>然后部署即可。</p>
<h3 id="部署水平自动伸缩hpa"><a class="toclink" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#%C3%A9%C2%83%C2%A8%C3%A7%C2%BD%C2%B2%C3%A6%C2%B0%C2%B4%C3%A5%C2%B9%C2%B3%C3%A8%C2%87%C2%AA%C3%A5%C2%8A%C2%A8%C3%A4%C2%BC%C2%B8%C3%A7%C2%BC%C2%A9hpa">部署水平自动伸缩（HPA）</a></h3>
<p>这一步配置的是自带的 HPA 功能，需要上述的 metrics-server 打开，并且在 Pod/Deployment 里面写明 resources.requests.cpu:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-1"></a>- name: name
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-2"></a>  resources:
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-3"></a>    requests:
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-8-4"></a>      cpu: &quot;xxx&quot;
</span></code></pre></div>
<p>然后创建 HPA 即可：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-9-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>autoscale<span class="w"> </span>deployment<span class="w"> </span><span class="nv">$deployment</span><span class="w"> </span>--cpu-percent<span class="o">=</span><span class="m">50</span><span class="w"> </span>--min<span class="o">=</span><span class="m">1</span><span class="w"> </span>--max<span class="o">=</span><span class="m">10</span>
</span></code></pre></div>
<p>通过压测，可以看到自动伸缩的记录：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-1"></a>$<span class="w"> </span>kubectl<span class="w"> </span>describe<span class="w"> </span>hpa
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-2"></a>Normal<span class="w">  </span>SuccessfulRescale<span class="w">  </span>22s<span class="w">   </span>horizontal-pod-autoscaler<span class="w">  </span>New<span class="w"> </span>size:<span class="w"> </span><span class="m">4</span><span class="p">;</span><span class="w"> </span>reason:<span class="w"> </span>cpu<span class="w"> </span>resource<span class="w"> </span>utilization<span class="w"> </span><span class="o">(</span>percentage<span class="w"> </span>of<span class="w"> </span>request<span class="o">)</span><span class="w"> </span>above<span class="w"> </span>target
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="../../devops/2020/03/10/k8s-deploy-with-hpa/#__codelineno-10-3"></a>Normal<span class="w">  </span>SuccessfulRescale<span class="w">  </span>6s<span class="w">     </span>horizontal-pod-autoscaler<span class="w">  </span>New<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>reason:<span class="w"> </span>All<span class="w"> </span>metrics<span class="w"> </span>below<span class="w"> </span>target
</span></code></pre></div>
<p>参考：Kubernetes 官方文档</p>

    <nav class="md-post__action">
      <a href="../../devops/2020/03/10/k8s-deploy-with-hpa/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-09 00:00:00">2020年3月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-jailkit-限制用户仅-scp"><a class="toclink" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/">用 jailkit 限制用户仅 scp</a></h2>
<p>最近需要用 scp 部署到生产机器，但又不想出现安全问题，所以用了 jailkit 的方法。首先是创建单独的用户，然后生成 ssh key 来认证，不再赘述。此时是可以 scp 了，但用户依然可以获得 shell，不够安全。</p>
<p>然后找到了下面参考链接，大概摘录一下所需要的命令和配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-1"></a>mkdir<span class="w"> </span>/path/to/jail
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-2"></a>chown<span class="w"> </span>root:root<span class="w"> </span>/path/to/jail
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-3"></a>chmod<span class="w"> </span><span class="m">701</span><span class="w"> </span>/path/to/jail
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-4"></a>jk_init<span class="w"> </span>-j<span class="w"> </span>/path/to/jail<span class="w"> </span>scp<span class="w"> </span>sftp<span class="w"> </span>jk_lsh
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-5"></a>jk_jailuser<span class="w"> </span>-m<span class="w"> </span>-j<span class="w"> </span>/path/to/jail<span class="w"> </span>jailed_user
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-6"></a>vim<span class="w"> </span>/path/to/jail/etc/jailkit/jk_lsh.ini
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-7"></a><span class="c1">## Add following lines</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-8"></a><span class="o">[</span>jailed_user<span class="o">]</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-9"></a><span class="nv">paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/bin,<span class="w"> </span>/usr/lib
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/#__codelineno-0-10"></a><span class="nv">exectuables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/bin/scp
</span></code></pre></div>
<p>之后可以发现该用户的 shell 已经更改 jk_chrootsh，并且只能用 scp。</p>
<p>参考：https://blog.tinned-software.net/restrict-linux-user-to-scp-to-his-home-directory/</p>

    <nav class="md-post__action">
      <a href="../../devops/2020/03/09/use-jailkit-for-scp-only-user/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-28 00:00:00">2020年2月28日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-56-期"><a class="toclink" href="../../misc/2020/02/28/weekly-sharing-56/">每周分享第 56 期</a></h2>
<p>咕咕咕</p>
<ol>
<li>SystemVerilog linter https://github.com/dalance/svlint</li>
<li>东北方言编程语言 https://github.com/zhanyong-wan/dongbei</li>
<li>JS LaTeX 渲染到 HTML https://github.com/michael-brade/LaTeX.js</li>
<li>一种对语音助手的攻击 https://surfingattack.github.io/</li>
<li>在线打铃网站 http://thulpwan.net/timer/</li>
<li>网络学堂 PC 端 App https://github.com/jiegec/learn_tsinghua_app/releases</li>
<li>Rust 2020 roadmap https://github.com/rust-lang/rfcs/pull/2857/files</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2020/02/28/weekly-sharing-56/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-10 00:00:00">2020年2月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="通过-bscan-jtag-对-rocket-chip-进行调试"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/">通过 BSCAN JTAG 对 Rocket Chip 进行调试</a></h2>
<h3 id="前言"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#%C3%A5%C2%89%C2%8D%C3%A8%C2%A8%C2%80">前言</a></h3>
<p>在上一个 <a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/">post</a> 里研究了原理，今天也是成功在 Artix 7 上实现了调试。效果如下：</p>
<p>OpenOCD 输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-1"></a>Info : JTAG tap: riscv.cpu tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-2"></a>Info : datacount=1 progbufsize=16
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-3"></a>Info : Disabling abstract command reads from CSRs.
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-4"></a>Info : Examined RISC-V core; found 1 harts
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-5"></a>Info :  hart 0: XLEN=32, misa=0x40801105
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-0-6"></a>Info : Listening on port 3333 for gdb connections
</span></code></pre></div>
<p>GDB 输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-1"></a>Remote debugging using localhost:3333
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-2"></a>0x0001018c in getc () at bootloader.c:36
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-3"></a>36        while (!(*UART_LSR &amp; 0x1))
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-1-4"></a>(gdb) 
</span></code></pre></div>
<p>这里用的 OpenOCD 和 GDB 都是 riscv 版本，上游的支持尚不完善。对于 Homebrew 用户，我在 <a href="https://github.com/jiegec/homebrew-formulas">jiegec/homebrew-formulas</a> 维护了需要的 Formula。</p>
<h3 id="过程"><a class="toclink" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#%C3%A8%C2%BF%C2%87%C3%A7%C2%A8%C2%8B">过程</a></h3>
<p>代码基本借鉴了 <a href="https://github.com/sequencer/rocket-playground/tree/7fa3c51113be607add2034f3abe0ae973caac04a">sequencer/rocket-playground</a> 和 <a href="https://github.com/KireinaHoro/rocket-zcu102/tree/ab9112c951eeeb64482716394d926777862d9e86">KireinaHoro/rocket-zcu102</a> 而来，代码方面主要是添加了 <a href="https://github.com/jiegec/rocket2thinpad/blob/ad1e86620c54bc0be29d08394d04f70031718b6d/src/main/scala/BscanJTAG.scala#L1">BscanJTAG.scala</a>，然后在 Top 模块下把它连接到内部的 JTAG 中：</p>
<div class="language-scala highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-1"></a><span class="kd">val</span><span class="w"> </span><span class="n">boardJTAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">BscanJTAG</span><span class="p">)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-2"></a><span class="kd">val</span><span class="w"> </span><span class="n">jtagBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">systemjtag</span><span class="p">.</span><span class="n">head</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-4"></a><span class="c1">// set JTAG parameters</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-5"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reset</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-6"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">mfr_id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x233</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">11</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-7"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">part_number</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-8"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-9"></a><span class="c1">// connect to BSCAN</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-10"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TCK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tck</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-11"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TMS</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tms</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-12"></a><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDI</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdi</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-13"></a><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="p">.</span><span class="n">data</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-2-14"></a><span class="n">boardJTAG</span><span class="p">.</span><span class="n">tdoEnable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">jtagBundle</span><span class="p">.</span><span class="n">jtag</span><span class="p">.</span><span class="nc">TDO</span><span class="p">.</span><span class="n">driven</span>
</span></code></pre></div>
<p>代码方面就足够了。然后，需要一个 riscv-openocd 和 riscv-gdb，分别从上游 repo 编译得来。然后采用以下的 openocd.cfg：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-1"></a>adapter_khz 20000
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-2"></a>interface ftdi
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-3"></a>ftdi_vid_pid 0x0403 0x6014
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-4"></a>ftdi_layout_init 0x00e8 0x60eb
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-5"></a>ftdi_tdo_sample_edge falling
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-6"></a>reset_config none
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-8"></a>set _CHIPNAME riscv
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-9"></a>jtag newtap $_CHIPNAME cpu -irlen 6
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-11"></a>set _TARGETNAME $_CHIPNAME.cpu
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-13"></a>target create $_TARGETNAME.0 riscv -chain-position $_TARGETNAME
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-14"></a>$_TARGETNAME.0 configure -work-area-phys 0x80000000 -work-area-size 10000 -work-area-backup 1
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../hardware/2020/02/10/rocket-chip-bscan-debug/#__codelineno-3-15"></a>riscv use_bscan_tunnel 5
</span></code></pre></div>
<p>然后就可以用 GDB 调试了。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2020/02/10/rocket-chip-bscan-debug/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-10 00:00:00">2020年2月10日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-vivado-中对-chisel3-产生的-verilog-代码仿真"><a class="toclink" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/">在 Vivado 中对 chisel3 产生的 verilog 代码仿真</a></h2>
<p>默认情况下，chisel3 生成的 verilog 代码在 Vivado 中仿真会出现很多信号大面积变成 X。解决方法在一个不起眼的 Wiki 页面：<a href="https://github.com/freechipsproject/chisel3/wiki/Randomization-flags">Randomization flags</a>：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-1"></a><span class="cp">`define RANDOMIZE_REG_INIT</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-2"></a><span class="cp">`define RANDOMIZE_MEM_INIT</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-3"></a><span class="cp">`define RANDOMIZE_GARBAGE_ASSIGN</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/#__codelineno-0-4"></a><span class="cp">`define RANDOMIZE_INVALID_ASSIGN</span>
</span></code></pre></div>
<p>在生成的 verilog 前面加上这四句，就可以正常仿真了。</p>

    <nav class="md-post__action">
      <a href="../../hardware/2020/02/10/simulate-chisel3-on-vivado/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-09 00:00:00">2020年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-macos-烧写-artix7-fpga"><a class="toclink" href="../../hardware/2020/02/09/program-artix7-on-macos/">在 macOS 烧写 Artix7 FPGA</a></h2>
<p>首先安装好 openocd：</p>
<p><code>brew install openocd --HEAD</code></p>
<p>测试所用版本为 <code>0.10.0+dev-01052-g09580964 (2020-02-08-15:09)</code>。</p>
<p>然后编写如下的 openocd.cfg：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-1"></a>adapter driver ftdi
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-2"></a>adapter speed 10000
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-3"></a>ftdi_vid_pid 0x0403 0x6014
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-4"></a>ftdi_layout_init 0x0008 0x004b
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-6"></a>source [find cpld/xilinx-xc7.cfg]
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-7"></a>init
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-8"></a>xc7_program xc7.tap
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-9"></a>pld load 0 /path/to/bitstream.bit
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-0-10"></a>shutdown
</span></code></pre></div>
<p>上面的 ftdi 开头的两行按照实际的 JTAG Adapter 修改。可以参考 openocd 自带的一些 cfg。</p>
<p>然后在 openocd.cfg 的目录运行 <code>openocd</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-1"></a>$<span class="w"> </span>openocd
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.10.0+dev-01052-g09580964<span class="w"> </span><span class="o">(</span><span class="m">2020</span>-02-08-15:09<span class="o">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">&quot;jtag&quot;</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">&#39;transport select &lt;transport&gt;&#39;</span>.
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-7"></a>Info<span class="w"> </span>:<span class="w"> </span>ftdi:<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>experience<span class="w"> </span>problems<span class="w"> </span>at<span class="w"> </span>higher<span class="w"> </span>adapter<span class="w"> </span>clocks,<span class="w"> </span>try<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="s2">&quot;ftdi_tdo_sample_edge falling&quot;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-8"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">10000</span><span class="w"> </span>kHz
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-9"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>xc7.tap<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x0362d093<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x049<span class="w"> </span><span class="o">(</span>Xilinx<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x362d,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-10"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-11"></a>shutdown<span class="w"> </span><span class="nb">command</span><span class="w"> </span>invoked
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-1-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>
<p>这时 FPGA 已经烧写成功。</p>
<p>参考：</p>
<ol>
<li>https://pansila.github.io/posts/7db4884d</li>
<li>https://numato.com/kb/programming-mimas-a7-using-openocd-and-xc3sprog/</li>
</ol>
<p>更新：OpenOCD 已经更新到 0.11.0，对于 Arty A7，采用下面的脚本进行烧写：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-1"></a>## OpenOCD 0.11.0
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-2"></a>## Adapted from: interface/ftdi/digilent-hs1.cfg
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-3"></a>## See also: board/arty_s7.cfg
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-4"></a>adapter driver ftdi
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-5"></a>adapter speed 25000
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-6"></a>ftdi_vid_pid 0x0403 0x6010
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-7"></a>ftdi_channel 0
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-8"></a>ftdi_layout_init 0x0088 0x008b
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-9"></a>reset_config none
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-11"></a>source [find cpld/xilinx-xc7.cfg]
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-12"></a>init
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-13"></a>pld load 0 ./bitstream.bit
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-2-14"></a>shutdown
</span></code></pre></div>
<p>成功输出：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-1"></a>$<span class="w"> </span>openocd
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-2"></a>Open<span class="w"> </span>On-Chip<span class="w"> </span>Debugger<span class="w"> </span><span class="m">0</span>.11.0
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-3"></a>Licensed<span class="w"> </span>under<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>v2
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-4"></a>For<span class="w"> </span>bug<span class="w"> </span>reports,<span class="w"> </span><span class="nb">read</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-5"></a><span class="w">        </span>http://openocd.org/doc/doxygen/bugs.html
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-6"></a>Info<span class="w"> </span>:<span class="w"> </span>auto-selecting<span class="w"> </span>first<span class="w"> </span>available<span class="w"> </span>session<span class="w"> </span>transport<span class="w"> </span><span class="s2">&quot;jtag&quot;</span>.<span class="w"> </span>To<span class="w"> </span>override<span class="w"> </span>use<span class="w"> </span><span class="s1">&#39;transport select &lt;transport&gt;&#39;</span>.
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-7"></a>Info<span class="w"> </span>:<span class="w"> </span>ftdi:<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>experience<span class="w"> </span>problems<span class="w"> </span>at<span class="w"> </span>higher<span class="w"> </span>adapter<span class="w"> </span>clocks,<span class="w"> </span>try<span class="w"> </span>the<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="s2">&quot;ftdi_tdo_sample_edge falling&quot;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-8"></a>Info<span class="w"> </span>:<span class="w"> </span>clock<span class="w"> </span>speed<span class="w"> </span><span class="m">25000</span><span class="w"> </span>kHz
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-9"></a>Info<span class="w"> </span>:<span class="w"> </span>JTAG<span class="w"> </span>tap:<span class="w"> </span>xc7.tap<span class="w"> </span>tap/device<span class="w"> </span>found:<span class="w"> </span>0x0362d093<span class="w"> </span><span class="o">(</span>mfg:<span class="w"> </span>0x049<span class="w"> </span><span class="o">(</span>Xilinx<span class="o">)</span>,<span class="w"> </span>part:<span class="w"> </span>0x362d,<span class="w"> </span>ver:<span class="w"> </span>0x0<span class="o">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-10"></a>Warn<span class="w"> </span>:<span class="w"> </span>gdb<span class="w"> </span>services<span class="w"> </span>need<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>more<span class="w"> </span>targets<span class="w"> </span>defined
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-11"></a>shutdown<span class="w"> </span><span class="nb">command</span><span class="w"> </span>invoked
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-12"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">6666</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>tcl<span class="w"> </span>connections
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../hardware/2020/02/09/program-artix7-on-macos/#__codelineno-3-13"></a>Info<span class="w"> </span>:<span class="w"> </span>Listening<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4444</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>telnet<span class="w"> </span>connections
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../hardware/2020/02/09/program-artix7-on-macos/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-09 00:00:00">2020年2月9日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/hardware/" class="md-meta__link">hardware</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="研究-rocket-chip-的-bscan-调试原理"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/">研究 Rocket Chip 的 BSCAN 调试原理</a></h2>
<h3 id="前言"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#%C3%A5%C2%89%C2%8D%C3%A8%C2%A8%C2%80">前言</a></h3>
<p>最近 <a href="https://github.com/KireinaHoro">@jsteward</a> 在研究如何通过 JTAG 对 FPGA 里的 Rocket Chip 进行调试。之前 <a href="https://github.com/sequencer">@sequencer</a> 已经做了一些实践，我们在重复他的工作，同时也研究了一下这是怎么工作的。</p>
<h3 id="原理"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#%C3%A5%C2%8E%C2%9F%C3%A7%C2%90%C2%86">原理</a></h3>
<p>我们从 @sequencer 得到了一份可用的 <a href="https://github.com/sequencer/rocket-playground/blob/7fa3c51113be607add2034f3abe0ae973caac04a/playground/src/FPGA.scala#L83">Scala 代码</a> 和 <a href="https://github.com/sequencer/rocket-playground/blob/7fa3c51113be607add2034f3abe0ae973caac04a/playground/debugger/openocd.cfg#L16">OpenOCD 配置</a>，并且了解到：</p>
<ol>
<li>可以通过 openocd 找到并调试 Rocket Chip</li>
<li>openocd 是通过 JTAG 向 FPGA 的 TAP 的 IR 写入 USER4，然后往 DR 写入特定格式的数据，然后控制 Rocket Chip 的 JTAG。</li>
</ol>
<p>这里涉及到一个“封装”的过程，在一个仅可以控制 DR 的 JTAG 中控制另一个 JTAG。首先可以找到 OpenOCD 端的<a href="https://github.com/riscv/riscv-openocd/blob/7cb8843794a258380b7c37509e5c693977675b2a/src/target/riscv/riscv.c#L361">操作代码</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-1"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-2"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_zero</span><span class="p">;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-3"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-4"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_tunnel_ir_width</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-5"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ir_dtmcontrol</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-6"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-7"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-8"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tunneled_ir_width</span><span class="p">;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-9"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-10"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">num_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-11"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">out_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bscan_zero</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-0-12"></a><span class="n">tunneled_ir</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span></code></pre></div>
<p>如果画成图，大概是这个样子（IR）：</p>
<table>
<thead>
<tr>
<th>3 bits</th>
<th>IR Width bits</th>
<th>7 bits</th>
<th>1 bit</th>
<th>TDI</th>
<th>Data Register</th>
<th>TDO</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Payload</td>
<td>Tunneled IR Width</td>
<td>0</td>
<td>-&gt;</td>
<td>Rocket Chip TAP</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>DR：</p>
<table>
<thead>
<tr>
<th>3 bits</th>
<th>DR Width bits</th>
<th>7 bits</th>
<th>1 bit</th>
<th>TDI</th>
<th>Data Register</th>
<th>TDO</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Payload</td>
<td>Tunneled DR Width</td>
<td>1</td>
<td>-&gt;</td>
<td>Rocket Chip TAP</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>这里 TDI 和 TDO 是直接接到 Rocket Chip 的 JTAG 中的，所以我们期望，当 Rocket Chip TAP 在 Shift-IR/Shift-DR 阶段的时候，刚好通过的是 Payload 部分。而控制 TAP 状态机，需要控制 TMS，这个则是通过一段 <a href="https://github.com/sifive/fpga-shells/blob/c099bd9b4f916bc0ba88030939a9614d0b0daf2d/src/main/scala/ip/xilinx/Xilinx.scala#L13">HDL</a> 来完成的：</p>
<div class="language-verilog highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-1"></a><span class="k">always</span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-2"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-3"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TDI_REG</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-4"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h05</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-5"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-6"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mh">8&#39;h08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shiftreg_cnt</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">counter_neg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mh">8&#39;h08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shiftreg_cnt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">8&#39;h01</span><span class="p">)))</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-7"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-8"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-9"></a><span class="w">                </span><span class="n">jtag_tms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-10"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#__codelineno-1-11"></a><span class="k">end</span>
</span></code></pre></div>
<p>这里 <code>TDI_REG</code> 取的是第一个 bit 的反（也就是上面 IR 对应 0，DR 对应 1 的那一位），<code>shiftreg_cnf</code> 则是之后 7 个 bit，对应上面的 Tunneled IR/DR Width。那么，在选择 IR 时 TMS 的序列为：</p>
<table>
<thead>
<tr>
<th>4 cycles</th>
<th>1 cycle</th>
<th>1 cycle</th>
<th>2 cycles</th>
<th>shiftreg_cnt-1 cycles</th>
<th>2 cycles</th>
<th>rest cycles</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>Run-Test/Idle</td>
<td>Select-DR-Scan</td>
<td>Select-IR-Scan</td>
<td>Capture-IR, Shift-IR</td>
<td>Shift-IR</td>
<td>Exit1-IR, Update-IR</td>
<td>Run-Test/Idle</td>
</tr>
</tbody>
</table>
<p>类似地，如果是选择 DR：</p>
<table>
<thead>
<tr>
<th>4 cycles</th>
<th>1 cycle</th>
<th>1 cycle</th>
<th>2 cycles</th>
<th>shiftreg_cnt-1 cycles</th>
<th>2 cycles</th>
<th>rest cycles</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>Run-Test/Idle</td>
<td>Run-Test/Idle</td>
<td>Select-DR-Scan</td>
<td>Capture-DR, Shift-DR</td>
<td>Shift-DR</td>
<td>Exit1-DR, Update-DR</td>
<td>Run-Test/Idle</td>
</tr>
</tbody>
</table>
<p>这样，刚好在 Shift-IR/DR 状态下，Payload 会被写入 IR/DR，从而完成了期望的操作。通过规定一个特定格式的 Data Register，可以实现嵌套的 TAP 的 IR 和 DR 的操作。</p>
<h3 id="参考"><a class="toclink" href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/#%C3%A5%C2%8F%C2%82%C3%A8%C2%80%C2%83">参考</a></h3>
<ol>
<li>JTAG Standard</li>
<li><a href="https://github.com/sequencer/rocket-playground">sequencer/rocket-playground</a></li>
<li>SiFive's JTAG Tunnel: https://github.com/sifive/fpga-shells/blob/c099bd9b4f916bc0ba88030939a9614d0b0daf2d/src/main/scala/ip/xilinx/Xilinx.scala#L13</li>
<li>https://github.com/watz0n/arty_xjtag</li>
<li>https://github.com/riscv/riscv-openocd/blob/7cb8843794a258380b7c37509e5c693977675b2a/src/target/riscv/riscv.c#L361</li>
<li>UG740: 7 Series FPGAs Configuration</li>
</ol>

    <nav class="md-post__action">
      <a href="../../hardware/2020/02/09/rocket-chip-bscan-analysis/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-07 00:00:00">2020年2月7日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/software/" class="md-meta__link">software</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="在-macos-上带执行权限-mmap-一个已删除文件遇到的问题和解决方案"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/">在 macOS 上带执行权限 mmap 一个已删除文件遇到的问题和解决方案</a></h2>
<h3 id="背景"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>实验环境：macOS Catalina 10.15.2</p>
<p>最近在 <a href="https://github.com/rcore-os/zircon-rs">rcore-rs/zircon-rs</a> 项目中遇到一个比较玄学的问题，首先需求是在 macOS 的用户进程里开辟一段地址空间，然后把这个地址空间多次映射（权限可能不同、同一块内存可能被映射到多个地址），通过 mmap 模拟虚拟地址的映射。采用的是如下的方案：</p>
<ol>
<li>在临时目录创建一个文件，把文件大小设为 16M（暂不考虑扩容）</li>
<li>需要映射一个虚拟地址到物理地址的时候，就对这个文件的物理地址偏移进行 FIXED 映射，虚拟地址就是期望的虚拟地址。</li>
</ol>
<p>这样的方案在 Linux 下运行地很好，但在 macOS 下总是以一定概率在第二部出现 EPERM。网上搜了很多，但也没搜到相关的信息，于是自己断断续续地研究了一下，现在有一个比较初步的结果。</p>
<h3 id="tldr"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#tldr">TL；DR</a></h3>
<p>先说结论：调用一个带 PROT_EXEC 并且映射文件的 mmap 时，macOS 会进行安全检测，如果此时发现文件在文件系统上消失了，它会认为这可能是一个恶意软件行为，进行拦截，返回 EPERM。</p>
<p>而代码实际上在第一步和第二步之间，把临时目录删了：由于进程持有 fd，所以文件并不会真的删掉，当软件退出的时候文件自然会删除，这是临时文件的常见做法（见 tmpfile(3)）。</p>
<h3 id="研究过程"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#%C3%A7%C2%A0%C2%94%C3%A7%C2%A9%C2%B6%C3%A8%C2%BF%C2%87%C3%A7%C2%A8%C2%8B">研究过程</a></h3>
<h4 id="查看-console"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#%C3%A6%C2%9F%C2%A5%C3%A7%C2%9C%C2%8B-console">查看 Console</a></h4>
<p>在网上一番搜索未果后，就尝试在 Console 里面寻找信息。照着程序名字搜索，可以找到一些信息：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-0-1"></a>temporarySigning type=1 matchFlags=0x0 path=/path/to/executable
</span></code></pre></div>
<p>这是编译这个 executable 的时候出现的，好像也没啥问题。然后解除过滤，在这个信息前后按照 syspolicyd 寻找：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-1"></a>initiating malware scan (... info_path: /path/to/temp/file proc_path: /path/to/executable)
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-2"></a>Unable (errno: 2) to read file at &lt;private&gt; for process path: &lt;private&gt; library path: &lt;private&gt;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-3"></a>Disallowing load of &lt;private&gt; in 50001, &lt;private&gt;
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-1-4"></a>Library load (/path/to/temp/file) rejected: library load denied by system policy
</span></code></pre></div>
<p>这几条记录比较可疑，每次运行程序，如果跑挂了，就会出现这几条，如果没跑挂，就不会出现这一条。所以很大概率是被 macOS 拦截了。错误信息的用词是 library，所以大概率是被当成加载动态库了，但既然内容是空的，所以我想的是文件名触碰到了什么奇怪的规则，然后文件名又是随机的，随机导致 EPERM 是概率性出现的，这好像很有道理。于是我把 tmpfile 换成了固定的路径，忽然就好了。但固定的路径只能保证同时只有一个程序在跑，如果路径拼接上 pid，怎么删，谁来删又是一个问题。虽然可以放到 /tmp 下面然后随便搞，但 /tmp 的回收并不是那么积极，在临时目录下丢太多文件也会出现问题。</p>
<h4 id="一丝曙光"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#%C3%A4%C2%B8%C2%80%C3%A4%C2%B8%C2%9D%C3%A6%C2%9B%C2%99%C3%A5%C2%85%C2%89">一丝曙光</a></h4>
<p>这时候，@wangrunji0408 提供了一个方案：在 System Preferences -&gt; Security &amp; Privacy -&gt; Privacy -&gt; Developer Tools 中添加编译该 executable 的程序（如 iTerm、CLion）可以解决这个问题。那么问题应该比较明确了，就是 malware scan 的问题，如果信任了这个 App 为 Developer Tools，它产生的 executable 也是可信的，应该不是恶意软件。但在 tmux 环境下，它哪个 App 也不属于，没法继承，况且把这个权限开放出去也有潜在的安全问题。并且让每个开发者都要这么操作一遍很不方便。</p>
<h4 id="回到-console"><a class="toclink" href="../../software/2020/02/07/macos-mmap-exec/#%C3%A5%C2%9B%C2%9E%C3%A5%C2%88%C2%B0-console">回到 Console</a></h4>
<p>今天刚好看到一个 <a href="https://georgegarside.com/blog/macos/sierra-console-private/">post</a>，内容是如何在 macOS Catalina 中查看 log 中标记为 private 的内容。如果你注意到的话，上面的 log 中出现了几处 private，这并不是我改的，而是 macOS 自带的隐私机制（当然这种机制似乎并没有采用的很完全，一些消息源没有打上 private 的标签）。</p>
<p>然后按照上面的 post 的方法（<a href="https://saagarjha.com/blog/2019/09/29/making-os-log-public-on-macos-catalina/">另一个 post</a>）开启了一下标记为 private 的内容，正好我的系统没有升级到 10.15.3 所以还能用。此时上面的第二条和第三条就出现了具体内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-2-1"></a>Unable (errno: 2) to read file at /path/to/temp/file for process path: /path/to/executable library path: /path/to/temp/file
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-2-2"></a>Disallowing load of /path/to/temp/file in 61254, /path/to/executable
</span></code></pre></div>
<p>这个时候问题就很明显了：读取不到文件。这时候回想起 tmpfile 的工作原理，它会删除生成的文件，在删除文件之后，macOS 进行扫描，发现找不到文件，于是 disallow 了，mmap 就会返回 EPERM。</p>
<p>解决方案也很显然了：把删除目录延后，或者放在 /tmp 下等待清理等待。</p>
<p>我也写了一段 C 代码来验证这个现象：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-1"></a><span class="cp">##include &lt;stdio.h&gt;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-2"></a><span class="cp">##include &lt;stdlib.h&gt;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-3"></a><span class="cp">##include &lt;fcntl.h&gt;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-4"></a><span class="cp">##include &lt;sys/mman.h&gt;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-5"></a><span class="cp">##include &lt;unistd.h&gt;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CREAT</span><span class="p">,</span><span class="w"> </span><span class="mo">0777</span><span class="p">);</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-10"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x200000000</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-11"></a><span class="w">    </span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-12"></a><span class="w">    </span><span class="c1">// might not work if unlink is put here (race condition)</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-13"></a><span class="w">    </span><span class="c1">// you can use sleep to reproduce</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-14"></a><span class="w">    </span><span class="n">unlink</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-15"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_FIXED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-16"></a><span class="w">    </span><span class="c1">// always works if unlink is put here</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-17"></a><span class="w">    </span><span class="c1">// unlink(&quot;mmap&quot;);</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-18"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-19"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-21"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;good&quot;</span><span class="p">);</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="../../software/2020/02/07/macos-mmap-exec/#__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div>

    <nav class="md-post__action">
      <a href="../../software/2020/02/07/macos-mmap-exec/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-31 00:00:00">2020年1月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-55-期"><a class="toclink" href="../../misc/2020/01/31/weekly-sharing-55/">每周分享第 55 期</a></h2>
<p>一个月后终于复更</p>
<ol>
<li>退出 vim 教程 https://github.com/hakluke/how-to-exit-vim</li>
<li>SHA-1 攻击新进展 https://sha-mbles.github.io/</li>
<li>gmane 近况 https://lars.ingebrigtsen.no/2020/01/06/whatever-happened-to-news-gmane-org/</li>
<li>浏览器能做的事情 https://github.com/luruke/browser-2020</li>
<li>一个 ext2 和 FAT 为一体的 fs https://github.com/NieDzejkob/cursedfs</li>
<li>iptables 规则调试工具 https://github.com/x-way/iptables-tracer</li>
<li>Qt 2020 的变化 https://www.qt.io/blog/qt-offering-changes-2020</li>
<li>后缀自动机可视化 https://yeah.moe/p/a8e74947/</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2020/01/31/weekly-sharing-55/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-05 00:00:00">2020年1月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="tp-link-archer-t4u-v3-linux-驱动安装"><a class="toclink" href="../../system/2020/01/05/archer-t4u-v3-driver/">TP-Link Archer T4U V3 Linux 驱动安装</a></h2>
<p>之前因为 MacBookPro 内置的 Wi-Fi 总是有问题，就找了个 USB 的无线网卡：TP-Link Archer T4U V3（VID：2357，PID：0115），这个网卡也没有主线的驱动，在网上找到了现成的驱动：<a href="https://github.com/cilynx/rtl88x2bu">cilynx/rtl88x2bu</a>，按照 README 用 DKMS 安装即可，实测可用。</p>
<p>Update: Linux 6.2+ 已经支持，见 <a href="https://linux-hardware.org/?id=usb:2357-0115">https://linux-hardware.org/?id=usb:2357-0115</a></p>

    <nav class="md-post__action">
      <a href="../../system/2020/01/05/archer-t4u-v3-driver/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-05 00:00:00">2020年1月5日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/system/" class="md-meta__link">system</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="macbookpro-143-wi-fi-驱动问题解决方案"><a class="toclink" href="../../system/2020/01/05/macbookpro-linux-wifi/">MacBookPro 14,3 Wi-Fi 驱动问题解决方案</a></h2>
<p>之前在 MacBookPro 14,3 安装 Linux 后，很多东西的驱动都有了解决方法，<a href="https://gist.github.com/TRPB/437f663b545d23cc8a2073253c774be3">参考 1</a>，<a href="https://github.com/roadrunner2/macbook12-spi-driver">参考 2</a>，触摸板和键盘等等都可以正常使用，触摸板的使用效果比我意料要好一些，虽然还是没有 macOS 原生那么好。但 Wi-Fi 一直有能扫到信号但连不上的问题，最近终于有了比较完善的解决方案，<a href="https://bugzilla.kernel.org/show_bug.cgi?id=193121#c52">地址</a>，也是两个月前才出来的方案，我测试了一下，确实可以很好的解决网络问题，网卡型号是 BCM43602，驱动用的是 brcmfmac。</p>
<p>另一方面，带 T2 的 MacBook 似乎也有了支持，见 <a href="https://github.com/aunali1/linux-mbp-arch">aunali1/linux-mbp-arch</a>，有一些尚未 upstream 的 patch，但我没有设备，就没有测试了。需要吐槽的是 ArchWiki 不怎么更新新 Model 的 MacBook 的教程，都是到处找散落的 github repo 和 gist 找别人的方案。</p>
<p>P.S. 可以正常工作的有：Wi-Fi，键盘，触摸板，Touchbar，内置摄像头，键盘背光，蓝牙
P.P.S MacBookPro11,2 的网卡是 BCM4360，直接用 broadcom-wl 驱动就可以。</p>

    <nav class="md-post__action">
      <a href="../../system/2020/01/05/macbookpro-linux-wifi/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-01 00:00:00">2020年1月1日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jielabs-是如何工作的"><a class="toclink" href="../../2020/01/01/jielabs/">JieLabs 是如何工作的</a></h2>
<h3 id="简介"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A7%C2%AE%C2%80%C3%A4%C2%BB%C2%8B">简介</a></h3>
<p>JieLabs 是陈嘉杰、高一川、刘晓义（按姓氏拼音首字母排序）于 2020 年新型冠状病毒疫情期间开发的在线数字逻辑电路实验系统，用于清华大学 2020 年春季学期数字逻辑电路实验课程。其包括前端、后端和固件三部分，分别主要由刘晓义、陈嘉杰和高一川负责开发。核心功能实现用时一周，后续界面和稳定性优化用时两周。本文会详细地介绍 JieLabs 的工作原理和一些技术细节，希望对各位同学有所帮助。</p>
<h4 id="太长不看"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A5%C2%A4%C2%AA%C3%A9%C2%95%C2%BF%C3%A4%C2%B8%C2%8D%C3%A7%C2%9C%C2%8B">太长；不看。</a></h4>
<p>采用了如下的技术方案：</p>
<p>前端：React 框架 + Redux 状态管理 + Monaco 编辑器 + WebAssembly 运行 Rust 代码 + WebSocket 实时通信 + SASS 样式</p>
<p>后端：Actix-Web 框架 + Diesel/PostgreSQL 数据库 + Redis 消息队列 + Quartus 构建 + Kubernetes 构建容器编排</p>
<p>固件：Xilinx FPGA 控制 + Buildroot 系统 + Linux 内核</p>
<h3 id="前端"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A5%C2%89%C2%8D%C3%A7%C2%AB%C2%AF">前端</a></h3>
<p>前端大部分都是刘晓义同学编写的，也是这个项目工作量最大的一部分。除了本文，还可以阅读<a href="https://meow.c-3.moe/sth-about-jielabs">刘晓义同学自己写的总结</a>。主要分以下几部分来谈前端的技术实现：</p>
<h4 id="第三方库"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A7%C2%AC%C2%AC%C3%A4%C2%B8%C2%89%C3%A6%C2%96%C2%B9%C3%A5%C2%BA%C2%93">第三方库</a></h4>
<p>整体上采用了时下比较流行的 React 框架，配合 Redux 进行状态管理，用 React Hooks 编写组件的逻辑。为了实现 VHDL/Verilog 代码的编辑，采用了来自 VSCode 的独立编辑器空间 Monaco，并自行编写了 VHDL 和 Verilog 语言的支持，一部分在 JS 实现，另一部分在 Rust 中实现，通过 wasm-pack 打包到 JS 中执行。另外为了实现 gzip 格式的解压缩也引入了 pako 库。</p>
<p>在这些第三方库里，Monaco 的体积最大，后面我们针对 JS 体积做了许多优化，在下面会再提。</p>
<h4 id="rust-在前端的应用"><a class="toclink" href="../../2020/01/01/jielabs/#rust-%C3%A5%C2%9C%C2%A8%C3%A5%C2%89%C2%8D%C3%A7%C2%AB%C2%AF%C3%A7%C2%9A%C2%84%C3%A5%C2%BA%C2%94%C3%A7%C2%94%C2%A8">Rust 在前端的应用</a></h4>
<p>由于开发者里刘晓义和陈嘉杰都是 Rust 语言的爱好者，考虑到目前 Rust to WASM 的技术比较成熟，WebAssembly 的可用程度也很高，我们把一些功能挪到了 Rust 中执行：</p>
<p>一是布线的计算。这是一个比较纯粹的算法问题，一方面对性能有一定的要求，一方面开发者比较喜欢 Rust，所以就用 Rust 实现了。这里要特别感谢刘光哲同学对布线算法的指点。在此基础上，我们用 Rust <a href="https://github.com/jiegec/maze-routing">实现</a>了几个论文中的布线算法（Maze Router），并且通过和 JS 代码的配合得到了一个比较优秀的效果。</p>
<p>二是 VHDL/Verilog 的语言支持。学过编译原理的同学应该知道，如果要实现一个能够解析代码里的信号的程序，一般是不能通过正则表达式来解决的，况且我们还实现了一些错误信息的显示。VHDL 语言支持采用了已有的比较完善的库，Verilog 由于现有的库都比较庞大，不适合放于前端，于是我们编写了一个最小的 Verilog（实际上算是 SystemVerilog）的解析，仅仅足够满足我们的需求。如果同学们遇到了一些语法上功能的缺少，欢迎提出。</p>
<h4 id="canvas-的应用"><a class="toclink" href="../../2020/01/01/jielabs/#canvas-%C3%A7%C2%9A%C2%84%C3%A5%C2%BA%C2%94%C3%A7%C2%94%C2%A8">Canvas 的应用</a></h4>
<p>连线部分因为是动态生成的，所以也是动态绘制的，Canvas 就可以派上用场了。我们也利用了 Canvas 的特性，针对每一个网络都画在一个 Canvas 上，那么在检测鼠标位置的时候，只要检查 Canvas 在鼠标所在的点上是否颜色，就知道鼠标是否在它上面了。</p>
<h4 id="前端加载速度的优化"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A5%C2%89%C2%8D%C3%A7%C2%AB%C2%AF%C3%A5%C2%8A%C2%A0%C3%A8%C2%BD%C2%BD%C3%A9%C2%80%C2%9F%C3%A5%C2%BA%C2%A6%C3%A7%C2%9A%C2%84%C3%A4%C2%BC%C2%98%C3%A5%C2%8C%C2%96">前端加载速度的优化</a></h4>
<p>优化前前端 JS 和 WASM 总大小大约是 4MB，对于网络不好的用户来说，它的加载时间是不能容忍的。于是我们采用了以下的措施：</p>
<ol>
<li>打开 gzip：有很显著的效果，但因为一些未知的原因，在实际部署的时候未能打开</li>
<li>缩小 JS 体积：通过 Webpack Analyzer 分析程序各个部分的大小，删掉了 Monaco 中一些没有用到的功能</li>
<li>缩小 WASM 体积：打开 LTO 和 -Os 选项</li>
<li>代码分割：把不同功能的代码分割开，先让一部分代码加载进来，可以绘制一个部分功能的界面，然后再继续加载剩下的组件</li>
<li>CDN：把一部分外部的依赖放到国内，后续如果有需求的话也可以把内部的依赖也放到国内的 CDN 上</li>
</ol>
<h3 id="后端"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A5%C2%90%C2%8E%C3%A7%C2%AB%C2%AF">后端</a></h3>
<p>后端用 Rust 语言编写，采用了目前比较成熟的 actix-web 框架，大量使用了 async/await。除此之外，用 Redis 作为消息队列，在 Docker 容器中运行 Quartus，用 Kubernetes 进行容器的动态调度。</p>
<h4 id="任务调度"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A4%C2%BB%C2%BB%C3%A5%C2%8A%C2%A1%C3%A8%C2%B0%C2%83%C3%A5%C2%BA%C2%A6">任务调度</a></h4>
<p>对于用户提交的代码和约束，后端需要进行任务的调度，生成一个新的任务，放入到 Redis 消息队列中。另一方面，Docker 中运行的 python 脚本会从 Redis 中取任务，任务完成后把结果上传并回传给后端表示确认。如果一个任务一直没有完成，后端会进行回收并重新分配一个任务到队列中。为了防止这个过程中出现重复任务的提交，为每个提交设置了一个足够长的随机 ID。Docker 容器一开始是通过 docker-compose 进行配置，后来考虑到这个场景比较适合 kubernetes，于是使用了一下，还挺好用的。一开始用的是 minikube，搭好 docker registry，然后往里面部署几个 pod 并设置 hpa，具体可以看我的另一篇博客，后来迁移到了 kubeadm 直接配置。现在迁移到了一个 k3s 搭建的 k8s 集群上。</p>
<h4 id="板子通信"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A6%C2%9D%C2%BF%C3%A5%C2%AD%C2%90%C3%A9%C2%80%C2%9A%C3%A4%C2%BF%C2%A1">板子通信</a></h4>
<p>第二个主要功能是进行板子的分配和通信。每个用户会创建一个 WebSocket 连接到后端，每个板子也是一个 WebSocket。当一个用户分配到一个板子的时候，它可以通过后端发送命令给对应的板子，板子的回复也会原路返回，相当于一个 WebSocket Proxy。另外为了保证资源的利用率，添加了一些限制、心跳包和认证。</p>
<h4 id="状态监控"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A7%C2%8A%C2%B6%C3%A6%C2%80%C2%81%C3%A7%C2%9B%C2%91%C3%A6%C2%8E%C2%A7">状态监控</a></h4>
<p>为了可以直观地看到各个数据，实现了一个简单的监控接口，接入 Telegraf+InfluxDB+Grafana 的监控系统，可以实时看到各个资源的情况，如用户、板子和任务等等，也方便我们在在线用户比较少的时候进行更新。</p>
<h3 id="板子"><a class="toclink" href="../../2020/01/01/jielabs/#%C3%A6%C2%9D%C2%BF%C3%A5%C2%AD%C2%90">板子</a></h3>
<p>这个平台虽然是用于数字逻辑实验课程，但实际用的板子来自数字逻辑设计课程。我们把其上一个 Altera FPGA 作为实验 FPGA，在控制的 Xilinx FPGA 上运行我们的固件，负责读取和写入 GPIO、下载 bitstream 等等功能。</p>

    <nav class="md-post__action">
      <a href="../../2020/01/01/jielabs/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-12-27 00:00:00">2019年12月27日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-54-期"><a class="toclink" href="../../misc/2019/12/27/weekly-sharing-54/">每周分享第 54 期</a></h2>
<p>咕了两周</p>
<ol>
<li>ES2019 https://javascript.christmas/2019/7</li>
<li>CSS 技巧 https://github.com/chokcoco/iCSS</li>
<li>Rust 编译器加速 https://blog.mozilla.org/nnethercote/2019/12/11/how-to-speed-up-the-rust-compiler-one-last-time-in-2019/</li>
<li>OSXFuse 不开源 https://colatkinson.site/macos/fuse/2019/09/29/osxfuse/</li>
<li>嵌入式 Rust 的 fmt 优化 https://jamesmunns.com/blog/fmt-unreasonably-expensive/</li>
<li>Docker base image 更新工具 https://github.com/containrrr/watchtower</li>
<li>运行 Linux 的名片 https://www.thirtythreeforty.net/posts/2019/12/my-business-card-runs-linux/</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/12/27/weekly-sharing-54/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-12-08 00:00:00">2019年12月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-53-期"><a class="toclink" href="../../misc/2019/12/08/weekly-sharing-53/">每周分享第 53 期</a></h2>
<ol>
<li>GDB Enhanced Features https://github.com/hugsy/gef</li>
<li>Lisp on Lua https://fennel-lang.org/</li>
<li>Django 3.0 https://docs.djangoproject.com/en/3.0/releases/3.0/</li>
<li>Rust Constant Propagation https://blog.rust-lang.org/inside-rust/2019/12/02/const-prop-on-by-default.html</li>
<li>ES2019 features https://javascript.christmas/2019/7</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/12/08/weekly-sharing-53/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-12-01 00:00:00">2019年12月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-52-期"><a class="toclink" href="../../misc/2019/12/01/weekly-sharing-52/">每周分享第 52 期</a></h2>
<ol>
<li>
<p>传递 Rust 闭包到 C https://readhacker.news/s/4dbWL</p>
</li>
<li>
<p>SystemVerilog Online http://sv-lang.com/</p>
</li>
<li>
<p>Java 14 新特性 https://www.javaworld.com/article/3437797/work-begins-on-java-14.html</p>
</li>
<li>
<p>在线 or1k 的模拟器 https://readhacker.news/s/4dfqc</p>
</li>
<li>
<p>在 macOS 上运行 virt-manager https://github.com/jeffreywildman/homebrew-virt-manager</p>
</li>
<li>
<p>关于 SystemVerilog 的博客 http://systemverilog.io/</p>
</li>
<li>
<p>结合 VSCode 和 Docker 的开发环境 https://github.com/cdr/sail</p>
</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/12/01/weekly-sharing-52/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-24 00:00:00">2019年11月24日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-51-期"><a class="toclink" href="../../misc/2019/11/24/weekly-sharing-51/">每周分享第 51 期</a></h2>
<ol>
<li>
<p>一个 LaTeX 的 LSP https://github.com/latex-lsp/texlab</p>
</li>
<li>
<p>Rope 数据结构 https://github.com/cessen/ropey</p>
</li>
<li>
<p>一个把 Vivado 工程放 git 中管理的方法 https://github.com/jhallen/vivado_setup</p>
</li>
<li>
<p>https://github.com/athre0z/color-backtrace</p>
</li>
<li>
<p>拿 Arch 当路由器 https://github.com/archwrt</p>
</li>
<li>
<p>Sourcetrail 开源了 https://www.sourcetrail.com/blog/open_source/</p>
</li>
<li>
<p>NodeJS 正式支持 ES Module https://medium.com/@nodejs/announcing-core-node-js-support-for-ecmascript-modules-c5d6dc29b663</p>
</li>
<li>
<p>Rust 的错误处理 https://blog.yoshuawuyts.com/error-handling-survey/</p>
</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/11/24/weekly-sharing-51/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-17 00:00:00">2019年11月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-50-期"><a class="toclink" href="../../misc/2019/11/17/weekly-sharing-50/">每周分享第 50 期</a></h2>
<p>时间过得真快，忽然就 50 期了。。</p>
<ol>
<li>CLion 的 C++20 Concept 支持 https://blog.jetbrains.com/clion/2019/11/cpp20-concepts-in-clion/</li>
<li>TypeScript 一些工具 https://github.com/pirix-gh/ts-toolbelt</li>
<li>Rust 编写的 SystemVerilog Parser https://github.com/dalance/sv-parser</li>
<li>MacBookPro 16 英寸 发布</li>
<li>用 Rust 写 eBPF 程序 https://blog.redsift.com/labs/putting-rust-in-the-kernel-with-ebpf/</li>
<li>终端里玩蜘蛛纸牌 https://github.com/chrisbouchard/klondike-rs</li>
<li>Rust 的 coverage 工具 https://github.com/mozilla/grcov</li>
<li>在 Menu Bar 或者 Touch Bar 控制 AirPods Pro 模式 https://github.com/insidegui/NoiseBuddy</li>
<li>Demangle Rust 符号的工具 https://github.com/luser/rustfilt</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/11/17/weekly-sharing-50/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-17 00:00:00">2019年11月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="实现一个简单的-decaf-lsp"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/">实现一个简单的 Decaf LSP</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>编译原理课程在做 Decaf 的 PA，之前做了一些比较简单的尝试，包括在线 Decaf、在线 TAC VM 等等，都是套一个前端，然后整个编译到 wasm 跑前端就可以了。如果要做 LSP 的话，工作量会稍微大一些，不过也更加实用。</p>
<p>然后有一天，助教 @equation314 写了 <a href="https://github.com/equation314/decaf-vscode">decaf-vscode</a> 一个 VSCode 对 Decaf 的语法高亮插件，我就 Fork 了一份到 <a href="https://github.com/jiegec/decaf-vscode">jiegec/decaf-vscode</a>，然后添加了 LSP 的支持，让它有了一些更高级的功能。</p>
<h3 id="实现"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A5%C2%AE%C2%9E%C3%A7%C2%8E%C2%B0">实现</a></h3>
<p>LSP 服务端一般是一个命令行程序，通过 JSONRPC 进行消息通讯，然后就上午找有没有现成的框架。比较重要的是 <a href="https://crates.io/crates/lsp-types">lsp-types</a> 和 <a href="https://crates.io/crates/tower-lsp">tower-lsp</a> ，前者封装了 LSP 协议的各个结构体，后者提供了服务端的大概实现。不过由于后者做的不大全，所以我自己 fork 了一份添加了一些。</p>
<p>实际实现的时候，需要实现几个函数，分别相应客户端的请求，比如在 initialize 的时候告诉客户端我都实现了哪些东西，然后相应地提供各种信息，如 symbol，hover，folding，definition 等等。为了实现简单，我要求客户端每次修改的时候都把完整的文件传过来，虽然不是很高效，但是很简单，目前也没有啥很长的 Decaf 程序嘛。</p>
<p>每次拿到 Decaf 程序之后，就按照 decaf-rs 的方法，Lex 然后 Parse，然后遍历 AST，分别把需要的各个信息都存下来，当客户端在请求的时候，直接返回即可。然后就会在 VSCode 中出现，比如实现了 document symbol，在左边的 Outline 中就会出现相应的结构；实现了 hover，当移动到一些地方的时候，客户端发出请求，服务端就把相应的 hover 信息返回给客户端。整个协议并不复杂，后面实际实现其实才是比较复杂的地方。</p>
<p>实现的功能中，symbols hovers ranges definition 都是在得到 AST 后一次遍历都计算好，然后返回，同时在遇到错误的时候，也通过 diagnostic 的形式把检查出来的错误汇报给用户。由于 VSCode 的良好支持，基本不需要写 TypeScript 代码。</p>
<p>至于代码补全，现在做的比较粗糙，仅仅补全了一些内置函数：Print ReadInteger 和 ReadLine。还在考虑支持函数调用的补全，但是在补全的时候会出现语法错误，意味着需要保证在补全的时候我还能拿到之前正确的类型信息，需要一些工作量，现在还没有去做。</p>
<h3 id="使用"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A4%C2%BD%C2%BF%C3%A7%C2%94%C2%A8">使用</a></h3>
<p>我自己测试的方法就是两个窗口，一个是 <a href="https://github.com/jiegec/decaf-lsp">decaf-lsp</a> ，首先克隆下来，然后 <code>cargo install --path . --force</code> 来安装到全局；另一个就是我 Fork 的 <a href="https://github.com/jiegec/decaf-vscode">decaf-vscode</a> ，克隆下来，然后按 <code>F5</code> 进入 VSCode 的调试模式，它会打开一个新窗口，里面启用了 Decaf for VSCode 插件。这个时候看 Decaf 代码就可以看到上面提到的那些东西了。</p>
<h3 id="总结"><a class="toclink" href="../../programming/2019/11/17/rust-decaf-lsp/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93">总结</a></h3>
<p>感觉 LSP 是一个比较好实现的 Protocol，但 Protocol 承载的 Data 才是比较困难的东西。要实现一个完整的 completion 还需要很多东西，现在只能说是个 naive implementation 吧。</p>
<p>刚写完就发现 Neovim 发布了 <a href="https://github.com/neovim/nvim-lsp">官方的 LSP client</a> 。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/11/17/rust-decaf-lsp/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-15 00:00:00">2019年11月15日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/programming/" class="md-meta__link">programming</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 9 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="用-rust-procedure-macro-实现-gll-parser"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/">用 Rust Procedure Macro 实现 GLL Parser</a></h2>
<h3 id="背景"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A8%C2%83%C2%8C%C3%A6%C2%99%C2%AF">背景</a></h3>
<p>在编译原理课上，PA 框架采用的是 <a href="https://github.com/MashPlant/lalr1">MashPlant/lalr1</a> ，是一个比较好用的 Lexer + Parser 的工具，它的大概语法见 <a href="https://mashplant.gitbook.io/decaf-doc/pa1a/lalr1-shi-yong-zhi-dao/yi-ge-wan-zheng-de-li-zi">一个完整的例子</a> 。然后之前看到了 GLL Parser，想着可不可以照着类似的语法也写一个 GLL 的 Parser Generator，也是用 Rust Procedure Macro 的方法，就开始了研究。</p>
<h3 id="尝试"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A5%C2%B0%C2%9D%C3%A8%C2%AF%C2%95">尝试</a></h3>
<p>首先是阅读 GLL 的论文，它并不长，大概的意思就是，LL(1) 文法需要考虑 PS 冲突的情况，而 GLL 的解决方法就是“都试一下”，然后为了效率，用了 GSS 表示解析过程和 SPPF 表示解析结果。然后就开始照着论文手写了不同版本的实现，见 <a href="https://github.com/jiegec/gll-test">jiegec/gll-test</a> 。</p>
<p>第一种就是按照论文里第一段实现直接抄过来，每个可能性作为一个 Continuation 存下来，它有自己的栈和执行位置（Label）。这样 Work 以后呢，我又想到了 async/await，用类似的方法又写了一遍，相对要简洁一些，也是很平常的递归下降的写法，而不是 Loop + Label 的形式。但这些都不能做到合并栈的目的，所以遇到十分有歧义的文法的时候会很糟糕。</p>
<p>然后开始按照论文中的 GSS 进行编写，基本还是按照论文进行翻译，然后一步一步做，做好以后把 GSS 画出来，和论文的图可以对的上；然后照着 GLL parse-tree generation 的论文把 SPPF 实现了，这时候就可以从 recongizer 变成一个 parser 了。</p>
<h3 id="宏"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A5%C2%AE%C2%8F">宏</a></h3>
<p>得到一份可行的代码以后，就要扩展到通用的情况上。学习了一下 MashPlant/lalr1 的实现，实现了一个 proc macro，它读取了用户的程序，从一个模板文件开始，往里面插入一些生成的代码，丢给编译器去编译。这时候就涉及到编译期和运行时的不同了，我把运行时一些通用的结构放到了 <code>gll-pg-core</code> 中，把编译期的代码放到了 <code>gll-pg-macros</code> 。</p>
<p>代码生成的时候，基本按照之前自己写的样子抄，只不过这个时候要按照用户编写的产生式进行生成了，各种名字都要规范化，变得可以复用，然后尽量减少命名空间的污染等等这些常见的写宏需要注意的操作。</p>
<p>不过，考虑到现在还没有实现 Lexer，所以先用了 Logos 库作为 Lexer。但我其实不大喜欢它，因为它太简单，也没有行号的信息，不过暂且先这样吧，以后可能会自己实现。</p>
<p>然后 0.1.0 版本就诞生了，它的样例长这样：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-1"></a><span class="sd">//! This example is taken from MashPlant/lalr1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-3"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_core</span>::<span class="n">LogosToken</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-4"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_macros</span>::<span class="n">gll</span><span class="p">;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-5"></a><span class="k">use</span><span class="w"> </span><span class="n">logos</span>::<span class="n">Logos</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-7"></a>#<span class="cp">#[derive(Logos, Debug, Eq, PartialEq, Clone)]</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-8"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Token</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-9"></a><span class="w">    </span><span class="cp">#[end]</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-10"></a><span class="w">    </span><span class="n">End</span><span class="p">,</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-11"></a><span class="w">    </span><span class="cp">#[error]</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-12"></a><span class="w">    </span><span class="n">Error</span><span class="p">,</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-13"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot; &quot;</span><span class="cp">]</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-14"></a><span class="w">    </span><span class="n">_Eps</span><span class="p">,</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-15"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;+&quot;</span><span class="cp">]</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-16"></a><span class="w">    </span><span class="n">Add</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-17"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;-&quot;</span><span class="cp">]</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-18"></a><span class="w">    </span><span class="n">Sub</span><span class="p">,</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-19"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;*&quot;</span><span class="cp">]</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-20"></a><span class="w">    </span><span class="n">Mul</span><span class="p">,</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-21"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;/&quot;</span><span class="cp">]</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-22"></a><span class="w">    </span><span class="n">Div</span><span class="p">,</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-23"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;%&quot;</span><span class="cp">]</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-24"></a><span class="w">    </span><span class="n">Mod</span><span class="p">,</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-25"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;(&quot;</span><span class="cp">]</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-26"></a><span class="w">    </span><span class="n">LPar</span><span class="p">,</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-27"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;)&quot;</span><span class="cp">]</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-28"></a><span class="w">    </span><span class="n">RPar</span><span class="p">,</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-29"></a><span class="w">    </span><span class="cp">#[regex = </span><span class="s">&quot;[0-9]+&quot;</span><span class="cp">]</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-30"></a><span class="w">    </span><span class="n">IntLit</span><span class="p">,</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-31"></a><span class="p">}</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-32"></a>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-33"></a>#<span class="cp">#[gll(Expr, Token)]</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-34"></a><span class="k">impl</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-35"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Add Expr)]</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-36"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_add</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-37"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-38"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-39"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Sub Expr)]</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-40"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_sub</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-41"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-43"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mul Expr)]</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-44"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mul</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-45"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-47"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Div Expr)]</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-48"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_div</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-49"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-51"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mod Expr)]</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-52"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mod</span><span class="p">(</span><span class="n">l</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-53"></a><span class="w">        </span><span class="n">l</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">r</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-55"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Sub Expr)]</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-56"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_neg</span><span class="p">(</span><span class="n">_op</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-57"></a><span class="w">        </span><span class="o">-</span><span class="n">r</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-58"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-59"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; LPar Expr RPar)]</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-60"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_paren</span><span class="p">(</span><span class="n">_l</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-61"></a><span class="w">        </span><span class="n">i</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-62"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-63"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; IntLit)]</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-64"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_int</span><span class="p">(</span><span class="n">i</span>: <span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-65"></a><span class="w">        </span><span class="n">i</span><span class="p">.</span><span class="n">slice</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-67"></a><span class="p">}</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-68"></a>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-69"></a>#<span class="cp">#[test]</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-70"></a><span class="k">fn</span> <span class="nf">gll</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-71"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Token</span>::<span class="n">lexer</span><span class="p">(</span><span class="s">&quot;1 + 2 * 3&quot;</span><span class="p">);</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-72"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span>::<span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="p">);</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-73"></a><span class="w">    </span><span class="c1">// two ways to parse</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-74"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">]);</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-0-75"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它解析的结果是一个数组，对应所有可能出现的情况。这样比较简单，但是要求中间各种类型都是 Clone，因为同一个结点可能会被用多次。它的计算方法就是在最终的 SPPF 上递归找到所有可能性，然后调用用户代码，最后放到一个 Vec 中。</p>
<h3 id="记忆化"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A8%C2%AE%C2%B0%C3%A5%C2%BF%C2%86%C3%A5%C2%8C%C2%96">记忆化</a></h3>
<p>但是，上面的做法有一个很大的问题，就是，虽然 SPPF 的空间复杂度是有限的，但所有可能的解析树可以有很多，如果把每一个情况都完整的存在一个 Vec 中，空间要求是很高的，中间也有很多重复计算的情况。所以需要做记忆化，然后每次给出一个。因为依赖自己内部的状态，所以不能是 Iterator 只能是 StreamingIterator。</p>
<p>记忆化也花了我一番功夫，现在用了一个比较土的办法，在每个结点上记录了当前遇到过的所有可能，这个是逐渐构造的，意味着如果只需要第一种解析树，不需要额外的空间。然后逐渐扩张，如果有可以重用的结构就重用，把涉及的所有的结构都放在一个 Vec 中，用完之后一起 drop 掉。</p>
<p>当然了，这个时候，各种东西都变成了引用：</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-1"></a><span class="sd">//! This example is taken from MashPlant/lalr1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-3"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_core</span>::<span class="o">*</span><span class="p">;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-4"></a><span class="k">use</span><span class="w"> </span><span class="n">gll_pg_macros</span>::<span class="n">gll</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-5"></a><span class="k">use</span><span class="w"> </span><span class="n">logos</span>::<span class="n">Logos</span><span class="p">;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-7"></a>#<span class="cp">#[derive(Logos, Debug, Eq, PartialEq, Clone)]</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-8"></a><span class="k">enum</span> <span class="nc">Token</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-9"></a><span class="w">    </span><span class="cp">#[end]</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-10"></a><span class="w">    </span><span class="n">End</span><span class="p">,</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-11"></a><span class="w">    </span><span class="cp">#[error]</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-12"></a><span class="w">    </span><span class="n">Error</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-13"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot; &quot;</span><span class="cp">]</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-14"></a><span class="w">    </span><span class="n">_Eps</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-15"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;+&quot;</span><span class="cp">]</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-16"></a><span class="w">    </span><span class="n">Add</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-17"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;-&quot;</span><span class="cp">]</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-18"></a><span class="w">    </span><span class="n">Sub</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-19"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;*&quot;</span><span class="cp">]</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-20"></a><span class="w">    </span><span class="n">Mul</span><span class="p">,</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-21"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;/&quot;</span><span class="cp">]</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-22"></a><span class="w">    </span><span class="n">Div</span><span class="p">,</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-23"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;%&quot;</span><span class="cp">]</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-24"></a><span class="w">    </span><span class="n">Mod</span><span class="p">,</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-25"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;(&quot;</span><span class="cp">]</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-26"></a><span class="w">    </span><span class="n">LPar</span><span class="p">,</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-27"></a><span class="w">    </span><span class="cp">#[token = </span><span class="s">&quot;)&quot;</span><span class="cp">]</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-28"></a><span class="w">    </span><span class="n">RPar</span><span class="p">,</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-29"></a><span class="w">    </span><span class="cp">#[regex = </span><span class="s">&quot;[0-9]+&quot;</span><span class="cp">]</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-30"></a><span class="w">    </span><span class="n">IntLit</span><span class="p">,</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-31"></a><span class="p">}</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-32"></a>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-33"></a>#<span class="cp">#[derive(Default)]</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-34"></a><span class="k">struct</span> <span class="nc">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-35"></a><span class="w">    </span><span class="n">literals</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-36"></a><span class="p">}</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-37"></a>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-38"></a>#<span class="cp">#[gll(Expr, Token)]</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-39"></a><span class="k">impl</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-40"></a><span class="w">    </span><span class="c1">// you can omit self</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-41"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Add Expr)]</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-42"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_add</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-43"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-45"></a><span class="w">    </span><span class="c1">// you can use &amp;self</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-46"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Sub Expr)]</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-47"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_sub</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-48"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-50"></a><span class="w">    </span><span class="c1">// you can use &amp;mut self as well</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-51"></a><span class="w">    </span><span class="c1">// but all of these have &amp;mut self in fact</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-52"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mul Expr)]</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-53"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mul</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-54"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-55"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-56"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Div Expr)]</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-57"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_div</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-58"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-60"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Expr Mod Expr)]</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-61"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_mod</span><span class="p">(</span><span class="n">l</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-62"></a><span class="w">        </span><span class="o">*</span><span class="n">l</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="o">*</span><span class="n">r</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-64"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; Sub Expr)]</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-65"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_neg</span><span class="p">(</span><span class="n">_op</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-66"></a><span class="w">        </span><span class="o">-*</span><span class="n">r</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-67"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-68"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; LPar Expr RPar)]</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-69"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_paren</span><span class="p">(</span><span class="n">_l</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-70"></a><span class="w">        </span><span class="o">*</span><span class="n">i</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-72"></a><span class="w">    </span><span class="c1">// so you can make your IDE happy with &amp;mut self here</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-73"></a><span class="w">    </span><span class="cp">#[rule(Expr -&gt; IntLit)]</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-74"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">expr_int</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="nc">LogosToken</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-75"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">lit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">slice</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-76"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">literals</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">lit</span><span class="p">);</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-77"></a><span class="w">        </span><span class="n">lit</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-79"></a><span class="p">}</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-80"></a>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-81"></a>#<span class="cp">#[test]</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-82"></a><span class="k">fn</span> <span class="nf">ambiguous</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-83"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Token</span>::<span class="n">lexer</span><span class="p">(</span><span class="s">&quot;1 + 2 + 3&quot;</span><span class="p">);</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-84"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Parser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">literals</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[]</span><span class="w"> </span><span class="p">};</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-85"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">lexer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-86"></a><span class="w">    </span><span class="c1">// two ways to parse</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-87"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">cloned</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-88"></a><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]);</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="../../programming/2019/11/15/rust-proc-macro-gll/#__codelineno-1-89"></a><span class="p">}</span>
</span></code></pre></div>
<p>这时候就是 0.3.0 版本，基本达到了我一开始想要的程度。</p>
<h3 id="错误处理"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A9%C2%94%C2%99%C3%A8%C2%AF%C2%AF%C3%A5%C2%A4%C2%84%C3%A7%C2%90%C2%86">错误处理</a></h3>
<p>在之前写编译原理 PA1 的时候，遇到的一个问题就是，如果自己的代码有错，因为宏展开以后丢失了位置信息，所以报错都会在错误的位置。一番查找以后，找到了解决方案：原样记录下原来的代码（syn::Block），然后通过 quote 宏直接拼接到最终的 TokenStream 中，这样在结果里，虽然代码还是那些代码，但部分的 Token 就有了正确的位置，这样就很方便用户代码的修改了。不过还是不方便找模板部分的代码错误，毕竟那部分确实在原来的代码中没有出现过。</p>
<p>对于模板中的代码错误，我最终的解决方案是 <code>cargo-expand</code> ，把我的测试代码和展开后的代码拼接起来，然后在茫茫的无关报错下去找我的错误的地方。虽然不是很好用，但毕竟还是 work 的。另外，宏还需要对用户代码的一些类型进行检查，比如上面的 Expr 对应 i32，这个就需要在各处都保持一致，但这个就需要自己进行检查了。使用了一下 proc_macro_diagnostic 的 API，还不是很好用，等它 stable 吧。</p>
<h3 id="总结"><a class="toclink" href="../../programming/2019/11/15/rust-proc-macro-gll/#%C3%A6%C2%80%C2%BB%C3%A7%C2%BB%C2%93">总结</a></h3>
<p>终于自己手写了一个 Procedure Macro，感觉现有的工具已经比较成熟了，有 syn quote 以后很多操作都很方便。但代码还有很多地方可以优化，慢慢搞吧。</p>

    <nav class="md-post__action">
      <a href="../../programming/2019/11/15/rust-proc-macro-gll/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-11 00:00:00">2019年11月11日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-49-期"><a class="toclink" href="../../misc/2019/11/11/weekly-sharing-49/">每周分享第 49 期</a></h2>
<ol>
<li>
<p>libuv wrapper in C++ https://github.com/skypjack/uvw</p>
</li>
<li>
<p>Visual Studio Online https://visualstudio.microsoft.com/zh-hans/services/visual-studio-online/</p>
</li>
<li>
<p>OpenSSH 的 U2F 支持 https://readhacker.news/s/4carE</p>
</li>
<li>
<p>Rust 1.39 <a href="http://www.phoronix.com/scan.php?page=news_item&amp;px=Rust-1.39-Released">Rust 1.39 Released With Async-Await Support, Attributes On Function Parameters</a></p>
</li>
<li>
<p>Windows 也在用 Rust https://msrc-blog.microsoft.com/2019/11/07/using-rust-in-windows/</p>
</li>
<li>
<p>用 Chrome Dev Tools 调试 Rust https://twitter.com/ChromeDevTools/status/1192803818024710145</p>
</li>
<li>
<p>C++20 的新 Thread 类型 https://medium.com/@vgasparyan1995/a-new-thread-in-c-20-jthread-ebd121ae8906</p>
</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/11/11/weekly-sharing-49/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-11-03 00:00:00">2019年11月3日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-48-期"><a class="toclink" href="../../misc/2019/11/03/weekly-sharing-48/">每周分享第 48 期</a></h2>
<ol>
<li>一个特殊的用于显示数字的字体 https://blog.janestreet.com/commas-in-big-numbers-everywhere/</li>
<li>Intel 的 SPMD 编译器 https://ispc.github.io/</li>
<li>基于 Scala 的 notebook https://polynote.org/</li>
<li>解析登机牌信息 https://github.com/georgesmith46/bcbp</li>
<li>常用的 React Hooks 库 https://github.com/streamich/react-use</li>
<li>jwt 工具 https://github.com/mike-engel/jwt-cli</li>
<li>用过程宏实现的 delegation in Rust https://github.com/chancancode/rust-delegate</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/11/03/weekly-sharing-48/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-10-26 00:00:00">2019年10月26日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/misc/" class="md-meta__link">misc</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="每周分享第-47-期"><a class="toclink" href="../../misc/2019/10/26/weekly-sharing-47/">每周分享第 47 期</a></h2>
<ol>
<li>CLion 完善了 Rust 调试支持 https://blog.jetbrains.com/clion/2019/10/debugging-rust-code-in-clion/</li>
<li>Nginx HTTP3 的 docker 镜像 https://github.com/RanadeepPolavarapu/docker-nginx-http3</li>
<li>手算 Ed25519 https://dang.fan/zh-Hans/posts/25519</li>
<li>Rust 的 QuickCheck https://github.com/BurntSushi/quickcheck</li>
<li>Rust 另一个类似 QuickCheck 的测试框架 https://github.com/AltSysrq/proptest</li>
<li>Cookie 策略要改了 https://readhacker.news/s/4bvGG</li>
</ol>

    <nav class="md-post__action">
      <a href="../../misc/2019/10/26/weekly-sharing-47/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-10-19 00:00:00">2019年10月19日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/devops/" class="md-meta__link">devops</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="为-cisco-wlc-配置-telegraf"><a class="toclink" href="../../devops/2019/10/19/configure-telegraf-for-cisco-wlc/">为 Cisco WLC 配置 Telegraf</a></h2>
<p>最近想到可以给 Cisco WLC 也配置一下监控，查了一下，果然有一些方法。大概研究了一下，找到了方法：</p>
<p>把 https://github.com/haad/net-snmp/tree/master/mibs 和 https://github.com/zampat/neteye4/tree/master/monitoring/monitoring-plugins/wireless/cisco/mibs 目录下的所有 .txt 文件放到 /usr/share/snmp/mibs 目录下。</p>
<p>然后把 https://github.com/zampat/neteye4/blob/master/monitoring/monitoring-plugins/wireless/cisco/telegraf.conf 下面 snmp 的配置复制到 telegraf 配置中，然后修改一下 IP 地址。</p>
<p>确保 Cisco WLC 的 SNMP 的 Public Community 已经配置好，然后就可以拿到数据了。</p>
<p>目前可以拿到 WLC 自身的一些运行˙状态信息、AP 的信息、SSID 的信息和 Client 的信息，基本满足了我们的需求。</p>
<p>参考：https://www.neteye-blog.com/2019/08/monitoring-a-cisco-wireless-controller/</p>

    <nav class="md-post__action">
      <a href="../../devops/2019/10/19/configure-telegraf-for-cisco-wlc/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
      
        



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../5/">5</a> <a class="md-pagination__link" href="../6/">6</a> <span class="md-pagination__current">7</span> <a class="md-pagination__link" href="../8/">8</a> <a class="md-pagination__link" href="../9/">9</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../15/">15</a>
</nav>
      
    </div>
  </div>

          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
          
          <a href="../../about/" class="md-footer__link md-footer__link--next" aria-label="下一页: 关于" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                关于
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jiegec" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.4e31edb1.min.js"></script>
      
        
          <script src="../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
        
      
        
          <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
        
      
    
  </body>
</html>