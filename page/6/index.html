
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/6/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-12 00:00:00">2022年7月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/programming/">programming</a></li>
<li class="md-meta__item">
            
              需要 19 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/">编程作业中的学术诚信</a></h2>
<p>本文是我自己对 <a href="https://integrity.mit.edu/handbook/writing-code">Academic Integrity at MIT: Writing Code</a> 的非官方中文翻译。本文已经得到了官方的邮件授权。</p>
<h3 id="writing-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#writing-code">编写代码 Writing Code</a></h3>
<p>与学术写作类似，当你在做课程项目的时候，如果使用了或者改编了其他人开发的代码，你必须要引用代码的来源。你可以在代码注释中引用代码来源。这些注释不仅保护了他人的劳动成果，也会帮助你理解代码和调试。</p>
<div class="language-text highlight"><pre><span></span><code>Writing code is similar to academic writing in that when you use or
adapt code developed by someone else as part of your project, you must
cite your source. However, instead of quoting or paraphrasing a source,
you include an inline comment in the code. These comments not only
ensure you are giving proper credit, but help with code understanding
and debugging.
</code></pre></div>
<h3 id="when-should-i-cite-a-source-in-my-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#when-should-i-cite-a-source-in-my-code">什么时候应该在代码中引用来源？When should I cite a source in my code?</a></h3>
<ol>
<li>
<p>当你从外部来源复制了代码。无论你是复制了代码片段，还是一整个模块，你都需要引用来源。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy code from an external source. Whether you are copying a
snippet of code or an entire module, you should credit the source.
</code></pre></div>
</li>
<li>
<p>当你复制了代码并做了改动，你依然要引用来源。你并不是代码的原作者。</p>
<div class="language-text highlight"><pre><span></span><code>When you copy the code and adapt it, you should still credit the source.
You were not the original developer of the code.
</code></pre></div>
</li>
</ol>
<h3 id="how-should-i-cite-the-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#how-should-i-cite-the-code">我应该如何引用代码？How should I cite the code?</a></h3>
<ol>
<li>
<p>通常来说，代码的网址和下载时间就足够了。如果可以让读者更加清晰地了解到代码来源，可以增加更多的细节。</p>
<div class="language-text highlight"><pre><span></span><code>Generally, the URL and the date of retrieval are sufficient. Add
more details if it will help the reader get a clearer
understanding of the source.
</code></pre></div>
</li>
<li>
<p>如果你修改了代码，你需要注明：“Adapted from:”（修改自）或者“Based on”（基于）。这样读者就知道你修改了代码。</p>
<div class="language-text highlight"><pre><span></span><code>If you adapted the code, you should indicate “Adapted from:” or
“Based on” so it is understood that you modified the code.
</code></pre></div>
</li>
<li>
<p>你的老师可能会对你如何引用代码有具体的要求。如果你不能确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Your instructor may have specific instructions on how you should
or should not cite your sources. If you are not clear on what is
acceptable, ask your instructor.
</code></pre></div>
</li>
</ol>
<h3 id="use-of-open-source-software"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#use-of-open-source-software">开源软件的使用 Use of Open Source Software</a></h3>
<p>当你使用开源软件项目的代码的时候，你不仅要注明代码的来源，还需要遵循代码的开源软件许可证。请记住：</p>
<div class="language-text highlight"><pre><span></span><code>When you use code from an open source project, you need both to
attribute the source and follow the terms of any open source license
that applies to the code you are using. Keep in mind:
</code></pre></div>
<ol>
<li>
<p>当你下载源码的时候，它的开源软件许可证通常也在源码中。</p>
<div class="language-text highlight"><pre><span></span><code>When you download the source, the license is typically part of the
download.
</code></pre></div>
</li>
<li>
<p>同时，代码里也通常会包括它的版权和使用条款。</p>
<div class="language-text highlight"><pre><span></span><code>Also, the source code itself will typically contain the
copyright and terms of use.
</code></pre></div>
</li>
<li>
<p>当你引入了开源代码，并且它附带了开源软件许可证，你应该把它的版权声明复制到你的代码中，和/或把许可证复制到代码目录中的文件。</p>
<div class="language-text highlight"><pre><span></span><code>When you incorporate open-source-licensed code into a program,
it is good practice to duplicate the copyright in your code,
and/or store the license in a file with the code.
</code></pre></div>
</li>
<li>
<p>如果在下载的文件里没有找到开源软件许可证，你可以在开源项目的网站上找到全文，如 <a href="https://httpd.apache.org/">Apache HTTP Server 网站</a> 或者 <a href="https://opensource.org/">Open Source Initiative (OSI) 网站</a>。</p>
<div class="language-text highlight"><pre><span></span><code>If you don’t obtain the license with the download, you should be
able to find it on the site of the open source project, such as
Apache HTTP Server site, or on the Open Source Initiative (OSI)
site.
</code></pre></div>
</li>
</ol>
<h3 id="instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#instructors-determine-the-specific-expectations-around-re-use-of-code-in-each-class">老师决定具体的代码复用程度 Instructors determine the specific expectations around re-use of code in each class.</a></h3>
<p>通常，老师会确定课程的协作规则。如果这个规则没有明确地给出来，或者你不确认什么是可行的，请询问你的老师。</p>
<div class="language-text highlight"><pre><span></span><code>Often, the requirements are described in the collaboration policy for
the class. If policy is not clearly described in the course materials
and you are not sure what is acceptable, ask your instructor.
</code></pre></div>
<h4 id="_2"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#_2">例子</a></h4>
<p>下面给出一个例子，是课程（Spring 2012 6.005 Elements of Software Construction）的协作规则：</p>
<div class="language-text highlight"><pre><span></span><code>Collaboration policy from Spring 2012 6.005 Elements of Software
Construction: (used with the permission of Professor Rob Miller, Dept of
Electrical Engineering &amp; Computer Science)
</code></pre></div>
<p>我们鼓励同学们互相帮助，但是为了保证每个人都有良好的独立学习体验，我们对你们做了如下的限制：</p>
<div class="language-text highlight"><pre><span></span><code>We encourage you to help each other with work in this class, but there
are limits to what you can do, to ensure that everybody has a good
individual learning experience.
</code></pre></div>
<h5 id="individual-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#individual-work">单人作业 Individual work</a></h5>
<p>课程里的习题都要单人完成。我们鼓励同学们讨论实现方法，但是你的代码和报告都需要自己完成。</p>
<div class="language-text highlight"><pre><span></span><code>Problem sets in this class are intended to be primarily individual
efforts. You are encouraged to discuss approaches with other students
but your code and your write-up must be your own.
</code></pre></div>
<p>你不能使用其他同学编写的资料，无论是这个学期还是以往学期的同学。你也不可以把你的成果提供给其他同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may not use materials produced as course work by other students,
whether in this term or previous terms, nor may you provide work for
other students to use.
</code></pre></div>
<p>帮助其他同学是应该的。但要保证一个原则，当你在帮助其他同学的时候，你自己的答案或代码不应该可以看到，无论是自己还是其他同学。可以养成一个习惯，帮助他人的时候把笔记本电脑合上。</p>
<div class="language-text highlight"><pre><span></span><code>It’s good to help other students. But as a general rule, during the time
that you are helping another student, your own solution should not be
visible, either to you or to them. Make a habit of closing your laptop
while you’re helping.
</code></pre></div>
<p>在帮助其他同学，阅读同学的代码的时候，你会看到同学的解答。你可以从同学的方法里获得灵感，但是不能复制他们的成果。</p>
<div class="language-text highlight"><pre><span></span><code>During code review, you will see classmates’ solutions to a problem set.
While it is fine to take inspiration from their approach, do not copy
their work.
</code></pre></div>
<p>你可以用外部网站上的资料，比如 StackOverflow，但前提是加上引用，并且作业要求里允许这么做。特别地，如果作业要求里写了“实现 X 功能”，那么你必须自己实现 X 功能，而不能复用外部的代码。</p>
<div class="language-text highlight"><pre><span></span><code>It’s fine to use material from external sources like StackOverflow, but
only with proper attribution, and only if the assignment allows it. In
particular, if the assignment says “implement X,” then you must create
your own X, not reuse one from an external source.
</code></pre></div>
<p>你也可以用课程组提供的代码，不需要引用。老师提供的代码在未经允许的情况下，不能公开分享，我们后面会讨论这个问题。</p>
<div class="language-text highlight"><pre><span></span><code>It’s also fine to use any code provided by this semester’s 6.031 staff
(in class, readings, or problem sets), without need for attribution.
Staff-provided code may not be publicly shared without permission,
however, as discussed later in this document.
</code></pre></div>
<p>例子一 Example 1：</p>
<ul>
<li>
<p>A 和 B 做作业的时候坐在一起。他们简略地讨论实现的不同方法。他们在白板上画流程图。当 A 发现 Java 标准库中一个有用的类，她把这个发现告诉了 B。当 B 发现了 StackOverflow 上的一个回答，他给 A 发送了 URL。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Alyssa and Ben sit next to each other with their laptops while
working on a problem set. They talk in general terms about
different approaches to doing the problem set. They draw
diagrams on the whiteboard. When Alyssa discovers a useful class
in the Java library, she mentions it to Ben. When Ben finds a
StackOverflow answer that helps, he sends the URL to Alyssa. OK.
</code></pre></div>
</li>
<li>
<p>在他们编写代码的时候，他们把代码大声念出来，好让双方都可以编写正确的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>As they type lines of code, they speak the code aloud to the
other person, to make sure both people have the right code.
INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>在作业最困难的部分，A 和 B 互相看电脑屏幕，并对比代码，确认他们代码实现都是正确的。错误！</p>
<div class="language-text highlight"><pre><span></span><code>In a tricky part of the problem set, Alyssa and Ben look at each
other’s screens and compare them so that they can get their code
right. INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子二 Example 2：</p>
<ul>
<li>
<p>J 已经完成了作业，但是他的朋友 B 正在努力解决一个 bug。J 坐在 B 旁边，看他的代码，帮他调试出了问题。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Jerry already finished the problem set, but his friend Ben is
now struggling with a nasty bug. Jerry sits next to Ben, looks
at his code, and helps him debug. OK.
</code></pre></div>
</li>
<li>
<p>J 打开了自己的笔记本，找到自己的答案，然后指着自己的代码给 B 纠正错误。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Jerry opens his own laptop, finds his solution to the problem
set, and refers to it while he’s helping Ben correct his code.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子三 Example 3：</p>
<ul>
<li>
<p>L 这周有很多作业，但是因为时间和身体原因来不及做。他已经错过截止时间两天了，但基本没有什么进度。B 觉得 L 可怜，想要帮助 L。在 L 写作业的时候，B 告诉 L 他是怎么做作业的。B 已经提交了自己的答案，并且在帮助 L 的时候，不打开自己的笔记本电脑。可以。</p>
<div class="language-text highlight"><pre><span></span><code>Louis had three problem sets and two quizzes this week, was away
from campus for several days for a track meet, and then got
sick. He’s already taken two slack days on the deadline and has
made almost no progress on the problem set. Ben feels sorry for
Louis and wants to help, so he sits down with Louis and talks
with him about how to do the problem set while Louis is working
on it. Ben already handed in his own solution, but he doesn’t
open his own laptop to look at it while he’s helping Louis. OK.
</code></pre></div>
</li>
<li>
<p>B 打开了自己的笔记本电脑，并且在帮助 L 的时候阅读自己的代码。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben opens his laptop and reads his own code while he’s helping
Louis. INAPPROPRIATE.
</code></pre></div>
</li>
<li>
<p>B 花了几个小时帮助 L，但是 L 还是没有完成。但是 B 需要去做自己的事情了。在 L 承诺只有在必要的时候才会看 B 的代码之后，B 把自己的代码上传到 Dropbox 并且分享给了 L。错误！</p>
<div class="language-text highlight"><pre><span></span><code>Ben has by now spent a couple hours with Louis, and Louis still
needs help, but Ben really needs to get back to his own work. He
puts his code in a Dropbox and shares it with Louis, after Louis
promises only to look at it when he really has to.
INAPPROPRIATE.
</code></pre></div>
</li>
</ul>
<p>例子四 Example 4：</p>
<ul>
<li>J 和 E 独立完成作业。他们交换了自己的测例来检查作业。错误！测例是题目的一部分，也是学习体验的一部分。如果你使用了其他人的测例，就是在抄袭，即使只是临时的。<div class="language-text highlight"><pre><span></span><code>John and Ellen both worked on their problem sets separately.
They exchange their test cases with each other to check their
work. INAPPROPRIATE. Test cases are part of the material for the
problem set, and part of the learning experience of the course.
You are copying if you use somebody else’s test cases, even if
temporarily.
</code></pre></div>
</li>
</ul>
<p>注意，在上面的例子中，双方都负有学术不端的责任。抄袭作业，或者把自己的作业提供给他人，是一个很严重的事情，可能导致分数扣减，课程不及格甚至处分。抄袭作业，或者帮助他人抄袭，可能会给你的成绩单上添加一个不能消除的 F。</p>
<div class="language-text highlight"><pre><span></span><code>Note that in the examples marked inappropriate above, both people are
held responsible for the violation in academic honesty. Copying work, or
knowingly making work available for copying, in contravention of this
policy is a serious offense that may incur reduced grades, failing the
course, and disciplinary action. Copying, or helping somebody copy, may
result in an F on your transcript that you will not be able to drop.
</code></pre></div>
<p>上述的要求对课程所有的单人作业都使用。</p>
<div class="language-text highlight"><pre><span></span><code>This policy applies to all coursework that is handed in by an
individual: problem sets, reading exercises, nanoquiz makeups, etc.
</code></pre></div>
<h5 id="group-work"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#group-work">组队作业 Group work</a></h5>
<p>你应该和你的队友合作完成组队作业，并且每个人都应该有接近的任务量。</p>
<div class="language-text highlight"><pre><span></span><code>You should collaborate with your partners on all aspects of group
project work and in-class collaborative exercises, and each of you is
expected to contribute a roughly equal share to design and
implementation.
</code></pre></div>
<p>你可以复用自己在学期内早些时候编写的代码等（包括之前自己和其他队友完成的）。你也可以用课程提供的任何代码。</p>
<div class="language-text highlight"><pre><span></span><code>You may reuse designs, ideas and code from your own work earlier in the
semester (even if it was done with a different partner). You may also
use any code provided by this semester’s 6.031 staff.
</code></pre></div>
<p>你可以使用外部代码，只要：</p>
<ol>
<li>所有同学都可以访问这个资料</li>
<li>进行了合理的引用</li>
<li>作业允许你这么做</li>
</ol>
<p>特别地，如果作业要求你“实现 X 功能”，你就必须自己实现 X 功能，不能复用他人的。</p>
<p>你们组不能复用其他组的代码和思路，无论是其他组是当前学期还是以往学期的同学。</p>
<div class="language-text highlight"><pre><span></span><code>You may also use material from external sources, so long as: (1) the
material is available to all students in the class; (2) you give proper
attribution; and (3) the assignment itself allows it. In particular, if
the assignment says “implement X,” then you must create your own X, not
reuse someone else’s. Finally, your group may not reuse designs, ideas,
or code created by another group, in this semester or previous
semesters.
</code></pre></div>
<h3 id="although-it-is-common-practice-to-adapt-code-examples-found-on-the-web"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#although-it-is-common-practice-to-adapt-code-examples-found-on-the-web">即使修改网络上的代码很常见 Although it is common practice to adapt code examples found on the web,</a></h3>
<ul>
<li>
<p>你不能抄袭其他同学的代码。你的同学不是一个合法的代码来源。</p>
<div class="language-text highlight"><pre><span></span><code>You should never copy code from other students. Your peers are
not considered an authorized source.
</code></pre></div>
</li>
<li>
<p>你不能简单地复用网上的代码。就像学术写作，你可以采用别人的思路，但是你也要把自己的理解加进去。</p>
<div class="language-text highlight"><pre><span></span><code>You should not simply re-use code as the solution to an
assignment. Like academic writing, your code can incorporate the
ideas of others but should reflect your original approach to the
problem.
</code></pre></div>
</li>
</ul>
<h3 id="examples-of-citing-code-sources"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#examples-of-citing-code-sources">引用代码的例子 Examples of citing code sources</a></h3>
<p>例子一 Example 1：</p>
<p>在 Apache 项目的源码的 PluginProxyUtil 类中，开发者引用了论坛的 URL，作者和时间：</p>
<div class="language-text highlight"><pre><span></span><code>In describing the class PluginProxyUtil in the Apache Project source
code, the developer cites the source as a post in a forum and includes
the URL, author and date:
</code></pre></div>
<div class="language-java highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cm">/**</span>
</span><span id="__span-0-2"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cm">* A utility class that gives applets the ability to detect proxy host settings.</span>
</span><span id="__span-0-3"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="cm">* This was adapted from a post from Chris Forster on 20030227 to a Sun Java</span>
</span><span id="__span-0-4"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="cm">* forum here:</span>
</span><span id="__span-0-5"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="cm">* http://forum.java.sun.com/thread.jspa?threadID=364342&amp;tstart=120</span>
</span><span id="__span-0-6"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="cm">[…]</span>
</span><span id="__span-0-7"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="cm">*/</span>
</span></code></pre></div>
<p>（来源：Apache Project 源代码 http://svn.apache.org 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: Apache Project source code http://svn.apache.org retrieved in
July 2019.)
</code></pre></div>
<p>例子二 Example 2：</p>
<p>在 Google Chrome <code>stack_trace_win</code> 的 <code>OutputTraceToStream</code> 函数中，开发者引用了 Microsoft Developer Network 并且附带了 URL：</p>
<div class="language-text highlight"><pre><span></span><code>In the function OutputTraceToStream in the Google Chrome stack_trace_win
source code, the developer cites the source code as the Microsoft
Developer Network and includes a URL:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// Code adapted from MSDN example:</span>
</span><span id="__span-1-2"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1">// http://msdn.microsoft.com/en-us/library/ms680578(VS.85).aspx </span>
</span></code></pre></div>
<p>（来源：https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc 于 2019 年 7 月获取） </p>
<div class="language-text highlight"><pre><span></span><code>(Source:
https://github.com/adobe/chromium/blob/master/base/debug/stack_trace_win.cc
retrieved in July 2019.)
</code></pre></div>
<h3 id="example-of-open-source-licensed-code"><a class="toclink" href="../../programming/2022/07/12/writing-code-cn/#example-of-open-source-licensed-code">引用附有开源许可证的代码的例子 Example of open-source-licensed code:</a></h3>
<p>在 Google Chrome <code>stack_trace_win</code> 代码的开头，可以看到版权声明和开源许可证的引用：</p>
<div class="language-text highlight"><pre><span></span><code>At the top of the Google Chrome stack_trace_win source file, note the
copyright and reference to the open source license:
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// Copyright (c) 2011 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-2-2"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// Use of this source code is governed by a BSD-style license that can be</span>
</span><span id="__span-2-3"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="c1">// found in the LICENSE file.</span>
</span></code></pre></div>
<p>如果你把这个代码加入到你的程序中，你需要遵守 Chromium 作者的开源许可证协议中的条款。虽然这个开源许可证只要求你在重分发的时候复制一份版权声明和许可证，一个好习惯是无论是否要求，你都要复制它的版权声明到代码中，和/或把它的许可证放到代码目录的文件中。这样的话，如果你在将来想要重分发你的代码，就很容易检查知识产权相关的问题。</p>
<div class="language-text highlight"><pre><span></span><code>If you incorporate this code into a program, you should follow the terms
outlined in The Chromium Authors' open source license file, which is
shown below. While this license only requires that you duplicate the
copyright and license if you are redistributing the code, it is good
practice to always duplicate the copyright in your code, and/or store
the license in a file with the code. This way, if you want to
redistribute the code later, intellectual property reviewing becomes
much easier.
</code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">// Copyright (c) 2014 The Chromium Authors. All rights reserved.</span>
</span><span id="__span-3-2"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">//</span>
</span><span id="__span-3-3"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1">// Redistribution and use in source and binary forms, with or without</span>
</span><span id="__span-3-4"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="c1">// modification, are permitted provided that the following conditions are</span>
</span><span id="__span-3-5"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="c1">// met:</span>
</span><span id="__span-3-6"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="c1">//</span>
</span><span id="__span-3-7"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">//* Redistributions of source code must retain the above copyright</span>
</span><span id="__span-3-8"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="c1">// notice, this list of conditions and the following disclaimer.</span>
</span><span id="__span-3-9"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="c1">//* Redistributions in binary form must reproduce the above</span>
</span><span id="__span-3-10"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// copyright notice, this list of conditions and the following disclaimer</span>
</span><span id="__span-3-11"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="c1">// in the documentation and/or other materials provided with the</span>
</span><span id="__span-3-12"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="c1">// distribution.</span>
</span><span id="__span-3-13"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="c1">//* Neither the name of Google Inc. nor the names of its</span>
</span><span id="__span-3-14"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="c1">// contributors may be used to endorse or promote products derived from</span>
</span><span id="__span-3-15"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="c1">// this software without specific prior written permission.</span>
</span><span id="__span-3-16"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="c1">//</span>
</span><span id="__span-3-17"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="c1">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
</span><span id="__span-3-18"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="c1">// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
</span><span id="__span-3-19"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="c1">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
</span><span id="__span-3-20"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="c1">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
</span><span id="__span-3-21"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="c1">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
</span><span id="__span-3-22"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="c1">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
</span><span id="__span-3-23"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="c1">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
</span><span id="__span-3-24"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="c1">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
</span><span id="__span-3-25"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="c1">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
</span><span id="__span-3-26"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="c1">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
</span><span id="__span-3-27"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="c1">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
</span><span id="__span-3-28"><a href="../../programming/2022/07/12/writing-code-cn/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="c1">//</span>
</span></code></pre></div>
<p>（来源：The Chromium Authors license file https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE 于 2019 年 7 月获取）</p>
<div class="language-text highlight"><pre><span></span><code>(Source: The Chromium Authors license file
https://src.chromium.org/viewvc/chrome/trunk/src/LICENSE retrieved in
July 2019.)
</code></pre></div>
<nav class="md-post__action">
<a href="../../programming/2022/07/12/writing-code-cn/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-11 00:00:00">2022年7月11日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="archive-common"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/">Archive 中 COMMON 符号的链接问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_1">背景</a></h3>
<p>最近看到一个 <a href="https://github.com/NixOS/nixpkgs/issues/180308">issue: irssi 1.4.1 fails to build on darwin arm64</a>，它的现象是，链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Undefined symbols for architecture arm64:
</span><span id="__span-0-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>  "_current_theme", referenced from:
</span><span id="__span-0-3"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>      _format_get_text_theme in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-4"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>      _format_get_text in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-5"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>      _strip_codes in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-6"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>      _format_send_as_gui_flags in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-7"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>      _window_print_daychange in libfe_common_core.a(fe-windows.c.o)
</span><span id="__span-0-8"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>      _printformat_module_dest_charargs in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-9"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-10"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>      ...
</span><span id="__span-0-11"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>  "_default_formats", referenced from:
</span><span id="__span-0-12"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>      _format_find_tag in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-13"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>      _format_get_text_theme_args in libfe_common_core.a(formats.c.o)
</span><span id="__span-0-14"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>      _printformat_module_dest_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-15"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>      _printformat_module_gui_args in libfe_common_core.a(printtext.c.o)
</span><span id="__span-0-16"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>ld: symbol(s) not found for architecture arm64
</span></code></pre></div>
<p>代码 <code>themes.c</code> 定义了这两个全局变量：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">THEME_REC</span><span class="w"> </span><span class="o">*</span><span class="n">current_theme</span><span class="p">;</span>
</span><span id="__span-1-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">GHashTable</span><span class="w"> </span><span class="o">*</span><span class="n">default_formats</span><span class="p">;</span>
</span></code></pre></div>
<p>并且 <code>themes.c</code> 编译出来的 <code>themes.c.o</code> 也在 archive 文件中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>src/fe-common/core/libfe_common_core.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>themes.c.o
</span><span id="__span-2-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>themes.c.o
</span></code></pre></div>
<p>并且 <code>themes.c.o</code> 也定义了这两个符号：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>src/fe-common/core/libfe_common_core.a.p/themes.c.o<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>COM
</span><span id="__span-3-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_current_theme
</span><span id="__span-3-3"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_default_formats
</span><span id="__span-3-4"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="m">0000000000000008</span><span class="w">         </span><span class="m">01</span><span class="w"> </span>COM<span class="w">    </span><span class="m">00</span><span class="w"> </span><span class="m">0300</span><span class="w"> </span>_themes
</span></code></pre></div>
<p>那么，问题在哪呢？看起来，链接的时候提供了 <code>libfe_common_core.a</code> 的参数，并且 <code>.a</code> 里面也有 <code>themes.c.o</code>，我们要找的符号也有定义，那么为什么会出现 <code>Undefined symbols</code> 的问题呢？</p>
<p>答案出在 COMMON 符号上。</p>
<h3 id="common"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#common">COMMON 符号</a></h3>
<p>COMMON 符号的原因和原理，详细可以见 <a href="https://maskray.me/blog/2022-02-06-all-about-common-symbols">MaskRay 的博客 All about COMMON symbols</a>，里面从链接器的角度很详细地讲述了这个问题。</p>
<p>简单来说，COMMON 符号的引入是为了和 Fortran 进行互操作。它在 C 中对应了没有初始化语句的全局变量。实际上到最后，还是会保存到 .bss 段中，默认清零。所以：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">common_symbol</span><span class="p">;</span>
</span><span id="__span-4-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">not_common_symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<p>两个语句最终结果是类似的，只不过第一个是 COMMON Symbol，第二个就是普通的 GLOBAL Symbol。</p>
<p>这看起来和 <code>Undefined symbols</code> 错误还是没有关系。问题在哪？</p>
<h3 id="archive"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#archive">Archive</a></h3>
<p>静态库通常是以 Archive 的方式给出，后缀是 <code>.a</code>。它实际上是一堆 <code>.o</code> 打包的集合，外加一个索引，即单独保存一个表，保存了每个 <code>.o</code> 定义了哪些符号。这样的好处是找符号的时候，不用遍历 <code>.o</code>，而是直接在索引里面找相关的符号。</p>
<p>为了创建一个 Archive，Linux 上可以用 <code>ar</code> 命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>ar<span class="w"> </span>cr<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>其中 <code>c</code> 表示 create，<code>r</code> 表示插入（和覆盖）。</p>
<p>macOS 上要用 <code>libtool -static</code> 来创建 Archive：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>libtool<span class="w"> </span>-static<span class="w"> </span>libxxx.a<span class="w"> </span>a.o<span class="w"> </span>b.o<span class="w"> </span>c.o
</span></code></pre></div>
<p>否则链接的时候会报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>ld: warning: ignoring file libxxx.a, building for macOS-arm64 but attempting to link with file built for unknown-unsupported file format
</span></code></pre></div>
<p>然后用 <code>ar t</code> 命令就可以看 Archive 有哪些内容：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>ar<span class="w"> </span>t<span class="w"> </span>libxxx.a
</span><span id="__span-8-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>a.o
</span><span id="__span-8-3"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>b.o
</span><span id="__span-8-4"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>c.o
</span></code></pre></div>
<p>可以用 <code>nm --print-armap</code> 命令查看 Archive 的索引：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>nm<span class="w"> </span>--print-armap<span class="w"> </span>libxxx.a
</span><span id="__span-9-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>Archive<span class="w"> </span>index:
</span><span id="__span-9-3"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>symbol1<span class="w"> </span><span class="k">in</span><span class="w"> </span>a.o
</span><span id="__span-9-4"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>symbol2<span class="w"> </span><span class="k">in</span><span class="w"> </span>b.o
</span><span id="__span-9-5"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>symbol3<span class="w"> </span><span class="k">in</span><span class="w"> </span>c.o
</span><span id="__span-9-6"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>
</span><span id="__span-9-7"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>a.o:
</span><span id="__span-9-8"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="m">0000000000000000</span><span class="w"> </span>T<span class="w"> </span>symbol1
</span></code></pre></div>
<p>所以我们已经了解了 Archive 的情况：它是多个 <code>.o</code> 文件的集合，并且实现了索引。链接的时候，会通过索引来找 <code>.o</code>，而不是遍历所有的 <code>.o</code> 文件。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_2">链接问题</a></h3>
<p>那么，回到一开始的链接问题，既然我们已经确认了，<code>.o</code> 文件中定义了符号，并且这个 <code>.o</code> 也确实在 <code>.a</code> 文件中，那就只剩下最后一个可能了：索引里面没有这个符号。</p>
<p>用 <code>nm --print-armap</code> 命令尝试，发现上面的 <code>_default_formats</code> 和 <code>_current_theme</code> 只在对应的 <code>.o</code> 中有定义，在 Archive index 部分是没有的。</p>
<p>网友 @ailin-nemui 指出了这个问题，并且提供了一个链接：<a href="https://stackoverflow.com/questions/19398742/os-x-linker-unable-to-find-symbols-from-a-c-file-which-only-contains-variables/26581710#26581710">OS X linker unable to find symbols from a C file which only contains variables</a>。它讲了很重要的一点，是 macOS 的 ar/ranlib/libtool 版本默认情况下不会为 COMMON 符号创建索引。所以，解决方案也很明确了：</p>
<ol>
<li>第一种 不要创建 COMMON 符号：添加编译选项 <code>-fno-common</code>，这个选项在比较新的编译器里都是默认了</li>
<li>第二种 为 COMMON 符号创建索引：用 <code>libtool -static -c</code> 命令，其中 <code>-c</code> 选项就是打开为 COMMON 符号创建索引</li>
<li>第三种 修改代码：给全局变量设置一个初始化值</li>
</ol>
<p>这样，这个问题就得到了妥善的解决。</p>
<h3 id="_3"><a class="toclink" href="../../software/2022/07/11/archive-common-linking/#_3">附录</a></h3>
<p>下面是 <a href="https://www.unix.com/man-page/osx/1/LIBTOOL/">macOS libtool manpage</a> 中写的相关文档：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>-c     Include common symbols as definitions with respect to the table of contents.  This is seldom the intended behavior for linking  from
</span><span id="__span-10-2"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>          a library, as it forces the linking of a library member just because it uses an uninitialized global that is undefined at that point
</span><span id="__span-10-3"><a href="../../software/2022/07/11/archive-common-linking/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>          in the linking.  This option is included only because this was the original behavior of ranlib.  This option is not the default.
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../software/2022/07/11/archive-common-linking/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-06 00:00:00">2022年7月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nvidia-cuda"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/">NVIDIA 驱动和 CUDA 安装速查</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#_1">背景</a></h3>
<p>最近在 Ubuntu 上配置 NVIDIA 驱动和 CUDA 环境的次数比较多，在此总结一下整个流程，作为教程供大家学习。</p>
<h3 id="nvidia-apt"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#nvidia-apt">配置 NVIDIA APT 源</a></h3>
<p>Ubuntu 源有自带的 NVIDIA 驱动版本，但这里我们要使用 NVIDIA 的 APT 源。首先，我们要访问 <a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network">https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network</a>，在网页中选择我们的系统，例如：</p>
<ol>
<li>Operating System: Linux</li>
<li>Architecture: x86_64</li>
<li>Distribution: Ubuntu</li>
<li>Version: 20.04</li>
<li>Installer Type: deb (network)</li>
</ol>
<p>此时，下面就会显示一些命令，复制下来执行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
</span><span id="__span-0-2"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cuda-keyring_1.0-1_all.deb
</span><span id="__span-0-3"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
</span></code></pre></div>
<p>最后一步的 <code>sudo apt-get -y install cuda</code> 可以不着急安装，我们在后面再来讨论 CUDA 版本的问题。</p>
<h3 id="nvidia"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#nvidia">NVIDIA 驱动</a></h3>
<p>配置好源以后，接下来，我们就要安装 NVIDIA 驱动了。首先，我们要选取一个 NVIDIA 版本，选择的标准如下：</p>
<ol>
<li>驱动版本需要支持所使用的显卡</li>
<li>驱动版本需要支持所使用的 CUDA 版本</li>
</ol>
<p>这些信息在网络上都可以查到，也可以参考 <a href="/software/2021/12/26/nvidia-cuda/">NVIDIA 驱动和 CUDA 版本信息速查</a>。</p>
<p>假如我们已经选择了要安装 470.129.06 版本，那么，我们接下来要确认一下 NVIDIA 的 APT 源的版本名称：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>sudo apt show -a nvidia-driver-470
</span></code></pre></div>
<p>在输出的结果中搜索 <code>470.129.06</code>，找到 <code>Version: 470.129.06-0ubuntu1</code>，下面写了 <code>APT-Sources: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64 Packages</code>，这就说明这个版本是从 NVIDIA 的 APT 源来的。</p>
<p>所以，我们要用 <code>470.129.06-0ubuntu1</code>，而不是 <code>470.129.06-0ubuntu0.20.04.1</code>，后者是 Ubuntu 源自带的，我们要用前者。</p>
<p>接下来，指定版本安装驱动：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>如果系统里已经安装了其他版本的 nvidia 驱动，可能会出现冲突。这时候，只需要把冲突的包也写在要安装的包里即可，例如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nvidia-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>cuda-drivers<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>cuda-drivers-470<span class="o">=</span><span class="m">470</span>.129.06-1<span class="w"> </span>nvidia-driver-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-gl-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-compute-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-decode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-encode-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-ifr1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-fbc1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-source-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-dkms-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-kernel-common-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-extra-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-compute-utils-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>xserver-xorg-video-nvidia-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>libnvidia-cfg1-470<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-settings<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span><span class="nv">libxnvctrl0</span><span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>nvidia-modprobe<span class="o">=</span><span class="m">470</span>.129.06-0ubuntu1
</span></code></pre></div>
<p>最终，我们要保证，系统里面所有 nvidia 驱动相关的包都是同一个版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>list<span class="w"> </span>--installed<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia
</span><span id="__span-4-2"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>libnvidia-cfg1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-3"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>libnvidia-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>all<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-4"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>libnvidia-compute-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-5"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>libnvidia-decode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-6"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>libnvidia-encode-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-7"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>libnvidia-extra-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-8"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>libnvidia-fbc1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-9"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>libnvidia-gl-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-10"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>libnvidia-ifr1-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-11"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>nvidia-compute-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-12"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>nvidia-dkms-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-13"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>nvidia-driver-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed<span class="o">]</span>
</span><span id="__span-4-14"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>nvidia-fabricmanager-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-15"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>nvidia-kernel-common-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-16"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>nvidia-kernel-source-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-17"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>nvidia-modprobe/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-4-18"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>nvidia-settings/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,upgradable<span class="w"> </span>to:<span class="w"> </span><span class="m">515</span>.48.07-0ubuntu1<span class="o">]</span>
</span><span id="__span-4-19"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>nvidia-utils-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span><span id="__span-4-20"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>xserver-xorg-video-nvidia-470/unknown,now<span class="w"> </span><span class="m">470</span>.129.06-0ubuntu1<span class="w"> </span>amd64<span class="w"> </span><span class="o">[</span>installed,automatic<span class="o">]</span>
</span></code></pre></div>
<p>接下来，为了防止 apt 升级的时候顺手破坏了一致的版本，我们要把包固定在一个版本里：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>sudo<span class="w"> </span>apt-mark<span class="w"> </span>hold<span class="w"> </span>cuda-drivers<span class="w"> </span>nvidia-modprobe<span class="w"> </span>nvidia-settings<span class="w"> </span>libxnvctrl0
</span></code></pre></div>
<p>如果有其他 nvidia 包说要自动升级，也可以类似地固定住。</p>
<h3 id="cuda"><a class="toclink" href="../../software/2022/07/06/install-nvidia-cuda/#cuda">CUDA</a></h3>
<p>CUDA 实际上是绿色软件，把整个目录放在任意一个目录，都可以使用。</p>
<p>安装 CUDA 的方式有很多，我们可以用 APT 安装全局的，也可以用 Spack 或者 Anaconda 安装到本地目录。实际上这些安装过程都是把同样的文件复制到不同的地方而已。</p>
<p>如果要安装全局的话，还是推荐用 NVIDIA 的 APT 源，以安装 CUDA 11.1 为例：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/07/06/install-nvidia-cuda/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>cuda-11-1
</span></code></pre></div>
<p>那么 CUDA 就会安装到 /usr/local/cuda-11.1 目录下。如果想要用 nvcc，我们可以手动把它加到 PATH 环境变量中。</p>
<p>CUDA 是可以多版本共存的，比如你可以把 CUDA 11.1 到 CUDA 11.7 一口气都装了。不过注意，CUDA 对 NVIDIA 驱动有版本要求，所以有一些可能会不满足 APT 的版本要求；同时，CUDA 对编译器版本有要求，所以如果系统还是 Ubuntu 16.04 或者 18.04，赶紧升级吧。</p>
<nav class="md-post__action">
<a href="../../software/2022/07/06/install-nvidia-cuda/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-02 00:00:00">2022年7月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="connectx-4"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/">切换 ConnectX-4 为以太网模式</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#_1">背景</a></h3>
<p>最近在给机房配置网络，遇到一个需求，就是想要把 ConnectX-4 当成以太网卡用，它既支持 Infiniband，又支持 Ethernet，只不过默认是 Infiniband 模式，所以需要用 mlxconfig 工具来做这个切换。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#_2">切换方法</a></h3>
<p>在 <a href="https://docs.nvidia.com/networking/display/MFTv4110/Using+mlxconfig">Using mlxconfig</a> 文档中，写了如何切换网卡为 Infiniband 模式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mt4103_pci_cr0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-0-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-0-4"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>----------
</span><span id="__span-0-5"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>Device<span class="w"> </span>type:<span class="w">   </span>ConnectX3Pro
</span><span id="__span-0-6"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>PCI<span class="w"> </span>device:<span class="w">    </span>/dev/mst/mt4103_pci_cr0
</span><span id="__span-0-7"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>Configurations:<span class="w">        </span>Next<span class="w"> </span>Boot<span class="w">        </span>New
</span><span id="__span-0-8"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span>LINK_TYPE_P1<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-0-9"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span>LINK_TYPE_P2<span class="w">         </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span><span class="w">           </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span>
</span><span id="__span-0-10"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span>?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-0-12"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-0-13"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>那么，我们只需要反其道而行之，设置模式为 <code>ETH(2)</code> 即可。</p>
<h3 id="mst"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#mst">MST 安装</a></h3>
<p>要使用 mlxconfig，就需要安装 <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">MFT(Mellanox Firmware Tools)</a>。我们用的是 Debian bookworm，于是要下载 DEB：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-1-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>unar<span class="w"> </span>mft-4.20.1-14-x86_64-deb.tgz
</span><span id="__span-1-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.20.1-14-x86_64-deb
</span></code></pre></div>
<p>UPDATE 2022-10-28: 现在最新版本 mft-4.21.0-99 已经修复了下面出现的编译问题。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>wget<span class="w"> </span>https://www.mellanox.com/downloads/MFT/mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-2-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>unar<span class="w"> </span>mft-4.21.0-99-x86_64-deb.tgz
</span><span id="__span-2-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nb">cd</span><span class="w"> </span>mft-4.21.0-99-x86_64-deb
</span></code></pre></div>
<p>尝试用 <code>sudo ./install.sh</code> 安装，发现 dkms 报错。查看日志，发现是因为内核过高（5.18），有函数修改了用法，即要把 pci_unmap_single 的调用改为 dma_unmap_single，并且修改第一个参数，如 <a href="https://github.com/torvalds/linux/commit/a2e759612e5ff3858856fe97be5245eecb84e29b">linux commit a2e759612e5ff3858856fe97be5245eecb84e29b</a> 指出的那样：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>-           pci_unmap_single(dev-&gt;pci_dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span><span id="__span-3-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>+           dma_unmap_single(&amp;dev-&gt;pci_dev-&gt;dev, dev-&gt;dma_props[i].dma_map, DMA_MBOX_SIZE, DMA_BIDIRECTIONAL);
</span></code></pre></div>
<p>修改完以后，手动 <code>sudo dkms install kernel-mft-dkms/4.20.1</code>，发现就编译成功了。再手动安装一下 mft 并启动服务：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$ sudo dpkg -i DEBS/mft_4.20.1-14_amd64.deb
</span><span id="__span-4-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>$ sudo mst start
</span><span id="__span-4-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>Starting MST (Mellanox Software Tools) driver set
</span><span id="__span-4-4"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>Loading MST PCI module - Success
</span><span id="__span-4-5"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>[warn] mst_pciconf is already loaded, skipping
</span><span id="__span-4-6"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>Create devices
</span><span id="__span-4-7"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>Unloading MST PCI module (unused) - Success
</span><span id="__span-4-8"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>$ sudo mst status
</span><span id="__span-4-9"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>MST modules:
</span><span id="__span-4-10"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>------------
</span><span id="__span-4-11"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>    MST PCI module is not loaded
</span><span id="__span-4-12"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>    MST PCI configuration module loaded
</span><span id="__span-4-13"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
</span><span id="__span-4-14"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>MST devices:
</span><span id="__span-4-15"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>------------
</span><span id="__span-4-16"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>/dev/mst/mtxxxx_pciconf0         - PCI configuration cycles access.
</span><span id="__span-4-17"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>                                   domain:bus:dev.fn=0000:xx:xx.0 addr.reg=yy data.reg=zz cr_bar.gw_offset=-1
</span><span id="__span-4-18"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>                                   Chip revision is: 00
</span></code></pre></div>
<p>既然已经安装好了，最后执行 <code>mlxconfig</code> 即可切换为以太网：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mlxconfig<span class="w"> </span>-d<span class="w"> </span>/dev/mst/mtxxxx_pciconf0<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">LINK_TYPE_P1</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">LINK_TYPE_P2</span><span class="o">=</span><span class="m">2</span>
</span><span id="__span-5-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>Device<span class="w"> </span><span class="c1">#1:</span>
</span><span id="__span-5-4"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>----------
</span><span id="__span-5-5"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>
</span><span id="__span-5-6"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>Device<span class="w"> </span>type:<span class="w">    </span>ConnectX4
</span><span id="__span-5-7"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>Name:<span class="w">           </span>REDACTED
</span><span id="__span-5-8"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>Description:<span class="w">    </span>ConnectX-4<span class="w"> </span>VPI<span class="w"> </span>adapter<span class="w"> </span>card<span class="p">;</span><span class="w"> </span>FDR<span class="w"> </span>IB<span class="w"> </span><span class="o">(</span>56Gb/s<span class="o">)</span><span class="w"> </span>and<span class="w"> </span>40GbE<span class="p">;</span><span class="w"> </span>dual-port<span class="w"> </span>QSFP28<span class="p">;</span><span class="w"> </span>PCIe3.0<span class="w"> </span>x8<span class="p">;</span><span class="w"> </span>ROHS<span class="w"> </span>R6
</span><span id="__span-5-9"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>Device:<span class="w">         </span>/dev/mst/mtxxxx_pciconf0
</span><span id="__span-5-10"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>
</span><span id="__span-5-11"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>Configurations:<span class="w">                              </span>Next<span class="w"> </span>Boot<span class="w">       </span>New
</span><span id="__span-5-12"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">         </span>LINK_TYPE_P1<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-5-13"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">         </span>LINK_TYPE_P2<span class="w">                        </span>IB<span class="o">(</span><span class="m">1</span><span class="o">)</span><span class="w">           </span>ETH<span class="o">(</span><span class="m">2</span><span class="o">)</span>
</span><span id="__span-5-14"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>
</span><span id="__span-5-15"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w"> </span>Apply<span class="w"> </span>new<span class="w"> </span>Configuration?<span class="w"> </span><span class="o">(</span>y/n<span class="o">)</span><span class="w"> </span><span class="o">[</span>n<span class="o">]</span><span class="w"> </span>:<span class="w"> </span>y
</span><span id="__span-5-16"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>Applying...<span class="w"> </span>Done!
</span><span id="__span-5-17"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>-I-<span class="w"> </span>Please<span class="w"> </span>reboot<span class="w"> </span>machine<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>new<span class="w"> </span>configurations.
</span></code></pre></div>
<p>显示各个配置可能的选项和内容：<code>sudo mlxconfig -d /dev/mst/mtxxxx_pciconf0 show_confs</code></p>
<p>整个安装流程在仓库 <a href="https://github.com/jiegec/mft-debian-bookworm">https://github.com/jiegec/mft-debian-bookworm</a> 中用脚本实现。</p>
<h3 id="vmware-esxi"><a class="toclink" href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#vmware-esxi">VMware ESXi</a></h3>
<p>如果要在 ESXi 上把网卡改成以太网模式，可以参考下面的文档：</p>
<ul>
<li>https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813</li>
<li>https://docs.nvidia.com/networking/plugins/servlet/mobile?contentId=15051769#content/view/15051769</li>
</ul>
<p>命令（ESXi 7.0U3）：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>scp *.vib root@esxi:/some/path
</span><span id="__span-6-2"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>esxcli software vib install -v /some/path/MEL_bootbank_mft_4.21.0.703-0.vib
</span><span id="__span-6-3"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>esxcli software vib install -v /some/path/MEL_bootbank_nmst_4.21.0.703-1OEM.703.0.0.18434556.vib
</span><span id="__span-6-4"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>reboot
</span><span id="__span-6-5"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>/opt/mellanox/bin/mst start
</span><span id="__span-6-6"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>/opt/mellanox/bin/mst status -vv
</span><span id="__span-6-7"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>/opt/mellanox/bin/mlxfwmanager --query
</span><span id="__span-6-8"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>/opt/mellanox/bin/mlxconfig -d mt4115_pciconf0 set LINK_TYPE_P1=2 LINK_TYPE_P2=2
</span><span id="__span-6-9"><a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>reboot
</span></code></pre></div>
<p>然后就可以看到网卡了。</p>
<nav class="md-post__action">
<a href="../../software/2022/07/02/connectx-4-switch-to-ethernet/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-01 00:00:00">2022年7月1日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rsyslog"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/">rsyslog 收集远程日志</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#_1">背景</a></h3>
<p>最近在运维的时候发现网络设备（如交换机）有一个远程发送日志的功能，即可以通过 syslog udp 协议发送日志到指定的服务器。为此，可以在服务器上运行 rsyslog 并收集日志。</p>
<h3 id="rsyslog_1"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#rsyslog_1">rsyslog 配置</a></h3>
<p>默认的 rsyslog 配置是收集系统本地的配置，因此我们需要编写一个 rsyslog 配置，用于收集远程的日志。</p>
<p>首先复制 <code>/etc/rsyslog.conf</code> 到 <code>/etc/rsyslog-remote.conf</code>，然后修改：</p>
<ol>
<li>注释掉 <code>imuxsock</code> 和 <code>imklog</code> 相关的 module 加载</li>
<li>去掉 <code>imudp</code> 和 <code>imtcp</code> 相关的注释，这样就会监听在相应的端口上</li>
<li>修改 <code>$WorkDirectory</code>，例如 <code>$WorkDirectory /var/spool/rsyslog-remote</code>，防止与已有的 rsyslog 冲突</li>
<li>注释 <code>$IncludeConfig</code>，防止引入了不必要的配置</li>
<li>注释所有已有的 <code>RULES</code> 下面的配置</li>
<li>添加如下配置：</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$template FromIp,"/var/log/rsyslog-remote/%FROMHOST-IP%.log"
</span><span id="__span-0-2"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>*.* ?FromIp
</span></code></pre></div>
<p>这样，就会按照来源的 IP 地址进行分类，然后都写入到 <code>/var/log/rsyslog-remote/x.x.x.x.log</code> 文件里。</p>
<h3 id="systemd-service"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#systemd-service">systemd service</a></h3>
<p>最后，写一个 systemd service 让它自动启动：</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[Unit]</span>
</span><span id="__span-1-2"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">ConditionPathExists</span><span class="o">=</span><span class="err">/</span><span class="n">etc</span><span class="err">/</span><span class="n">rsyslog-remote</span><span class="p">.</span><span class="n">conf</span>
</span><span id="__span-1-3"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">Description</span><span class="o">=</span><span class="n">Remote</span><span class="w"> </span><span class="n">Syslog</span><span class="w"> </span><span class="n">Service</span>
</span><span id="__span-1-4"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">[Service]</span>
</span><span id="__span-1-6"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">Type</span><span class="o">=</span><span class="n">simple</span>
</span><span id="__span-1-7"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="n">PIDFile</span><span class="o">=</span><span class="err">/</span><span class="n">var</span><span class="err">/</span><span class="n">run</span><span class="err">/</span><span class="n">rsyslogd-remote</span><span class="p">.</span><span class="n">pid</span>
</span><span id="__span-1-8"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="n">ExecStart</span><span class="o">=</span><span class="err">/</span><span class="n">usr</span><span class="err">/</span><span class="n">sbin</span><span class="err">/</span><span class="n">rsyslogd</span><span class="w"> </span><span class="err">-</span><span class="n">n</span><span class="w"> </span><span class="err">-</span><span class="n">f</span><span class="w"> </span><span class="err">/</span><span class="n">etc</span><span class="err">/</span><span class="n">rsyslog-remote</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="err">-</span><span class="n">i</span><span class="w"> </span><span class="err">/</span><span class="n">var</span><span class="err">/</span><span class="n">run</span><span class="err">/</span><span class="n">rsyslogd-remote</span><span class="p">.</span><span class="n">pid</span>
</span><span id="__span-1-9"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="n">ExecReload</span><span class="o">=</span><span class="err">/</span><span class="n">bin</span><span class="err">/</span><span class="n">kill</span><span class="w"> </span><span class="err">-</span><span class="n">HUP</span><span class="w"> </span><span class="err">$</span><span class="n">MAINPID</span>
</span><span id="__span-1-10"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">[Install]</span>
</span><span id="__span-1-12"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi-user</span><span class="p">.</span><span class="n">target</span>
</span></code></pre></div>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-2-2"><a href="../../software/2022/07/01/rsyslog-remote/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>rsyslog-remote
</span></code></pre></div>
<p>这样就实现了远程日志的收集。</p>
<h3 id="logrotate"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#logrotate">logrotate 设置</a></h3>
<p>为了防止日志太多，还需要配置 logrotate。</p>
<p>复制 <code>/etc/logrotate.d/rsyslog</code> 到 <code>/etc/logrotate.d/rsyslog-remote</code>，然后修改开头为 <code>/var/log/rsyslog-remote/*.log</code> 即可，路径和上面对应。注意脚本 <code>/usr/lib/rsyslog/rsyslog-remote</code> 也需要复制一份，然后修改一下 systemd service 名字。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/01/rsyslog-remote/#_2">参考文档</a></h3>
<ul>
<li><a href="https://www.makeuseof.com/set-up-linux-remote-logging-using-rsyslog/">How to Set Up Remote Logging on Linux Using rsyslog</a></li>
<li><a href="https://www.thegeekdiary.com/configuring-remote-logging-using-rsyslog-in-centos-rhel/">Configuring Remote Logging using rsyslog in CentOS/RHEL</a></li>
<li><a href="https://www.tecmint.com/install-rsyslog-centralized-logging-in-centos-ubuntu/">How to Setup Central Logging Server with Rsyslog in Linux</a></li>
<li><a href="https://www.tecmint.com/setup-rsyslog-client-to-send-logs-to-rsyslog-server-in-centos-7/">How to Setup Rsyslog Client to Send Logs to Rsyslog Server in CentOS 7</a></li>
</ul>
<nav class="md-post__action">
<a href="../../software/2022/07/01/rsyslog-remote/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-06-19 00:00:00">2022年6月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="wishbone"><a class="toclink" href="../../hardware/2022/06/19/wishbone/">「教学」Wishbone 总线协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/bus_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_1">背景</a></h3>
<p>最近在研究如何把 Wishbone 总线协议引入计算机组成原理课程，因此趁此机会学习了一下 Wishbone 的协议。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_2">总线</a></h3>
<p>总线是什么？总线通常用于连接 CPU 和外设，为了更好的兼容性和可复用性，会想到能否设计一个统一的协议，其中 CPU 实现的是发起请求的一方（又称为 master），外设实现的是接收请求的一方（又称为 slave），那么如果要添加外设、或者替换 CPU 实现，都会变得比较简单，减少了许多适配的工作量。</p>
<p>那么，我们来思考一下，一个总线协议需要包括哪些内容？对于 CPU 来说，程序会读写内存，读写内存就需要以下几个信号传输到内存：</p>
<ol>
<li>地址（<code>addr</code>）：例如 32 位处理器就是 32 位地址，或者按照内存的大小计算地址线的宽度</li>
<li>数据（<code>w_data</code> 和 <code>r_data</code>）：分别是写数据和读数据，宽度通常为 32 位 或 64 位，也就是一个时钟周期可以传输的数据量</li>
<li>读还是写（<code>we</code>）：高表示写，低表示读</li>
<li>字节有效（<code>be</code>）：例如为了实现单字节写，虽然 <code>w_data</code> 可能是 32 位宽，但是实际写入的是其中的一个字节</li>
</ol>
<p>除了请求的内容以外，为了表示 CPU 想要发送请求，还需要添加 <code>valid</code> 信号：高表示发送请求，低表示不发送请求。很多时候，外设的速度比较慢，可能无法保证每个周期都可以处理请求，因此外设可以提供一个 <code>ready</code> 信号：当 <code>valid=1 &amp;&amp; ready=1</code> 的时候，发送并处理请求；当 <code>valid=1 &amp;&amp; ready=0</code> 的时候，表示外设还没有准备好，此时 CPU 需要一直保持 <code>valid=1</code> 不变，等到外设准备好后，<code>valid=1 &amp;&amp; ready=1</code> 请求生效。</p>
<p>简单总结一下上面的需求，可以得到 master 和 slave 端分别的信号列表。这次，我们在命名的时候用 <code>_o</code> 表示输出、<code>_i</code> 表示输入，可以得到 master 端（CPU 端）的信号：</p>
<ol>
<li><code>clock_i</code>：时钟输入</li>
<li><code>valid_o</code>：高表示 master 想要发送请求</li>
<li><code>ready_i</code>：高表示 slave 准备好处理请求</li>
<li><code>addr_o</code>：master 想要读写的地址</li>
<li><code>we_o</code>：master 想要读还是写</li>
<li><code>data_o</code>：master 想要写入的数据</li>
<li><code>be_o</code>：master 读写的字节使能，用于实现单字节写等</li>
<li><code>data_i</code>：slave 提供给 master 的读取的数据</li>
</ol>
<p>除了时钟都是输入以外，把上面其余的信号输入、输出对称一下，就可以得到 slave 端（外设端）的信号：</p>
<ol>
<li><code>clock_i</code>：时钟输入</li>
<li><code>valid_i</code>：高表示 master 想要发送请求</li>
<li><code>ready_o</code>：高表示 slave 准备好处理请求</li>
<li><code>addr_i</code>：master 想要读写的地址</li>
<li><code>we_i</code>：master 想要读还是写</li>
<li><code>data_i</code>：master 想要写入的数据</li>
<li><code>be_i</code>：master 读写的字节使能，用于实现单字节写等</li>
<li><code>data_o</code>：slave 提供给 master 的读取的数据</li>
</ol>
<p>根据我们上面设计的自研总线，可以绘制出下面的波形图（以 master 的信号为例）：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p.........", node: ".abcdefgh"},
      { name: "valid_o", wave: "0101.01..0"},
      { name: "ready_i", wave: "010.101..0"},
      { name: "addr_o", wave: "x=x=.x===x", data: ["0x01", "0x02", "0x03", "0x01", "0x02"]},
      { name: "we_o", wave: "x1x0.x101x"},
      { name: "data_o", wave: "x=xxxx=x=x", data: ["0x12", "0x56", "0x9a"]},
      { name: "be_o", wave: "x=x=.x=x=x", data: ["0x1", "0x1", "0x1", "0x1"]},
      { name: "data_i", wave: "xxxx=xx=xx", data: ["0x34", "0x12"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，此时 <code>we_o=1</code> 说明是一个写操作，并且写入地址是 <code>addr_o=0x01</code>，写入的数据是 <code>data_o=0x12</code></li>
<li><code>b</code> 周期：此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生</li>
<li><code>c</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=0</code> 说明 master 想要从地址 0x02（<code>addr_o=0x02</code>）读取数据（<code>we_o=0</code>），但是 slave 没有接受（<code>ready_i=0</code>）</li>
<li><code>d</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 从地址 0x02（<code>addr_o=0x02</code>）读取数据（<code>we_o=0</code>），读取的数据为 0x34（<code>data_i=0x34</code>）</li>
<li><code>e</code> 周期：此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生</li>
<li><code>f</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 向地址 0x03（<code>addr_o=0x03</code>）写入数据（<code>we_o=1</code>），写入的数据为 0x56（<code>data_i=0x56</code>）</li>
<li><code>g</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 从地址 0x01（<code>addr_o=0x01</code>）读取数据（<code>we_o=0</code>），读取的数据为 0x12（<code>data_i=0x12</code>）</li>
<li><code>h</code> 周期：此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生，master 向地址 0x02（<code>addr_o=0x02</code>）写入数据（<code>we_o=1</code>），写入的数据为 0x9a（<code>data_i=0x9a</code>）</li>
</ul>
<p>从上面的波形中，可以有几点观察：</p>
<ol>
<li>master 想要发起请求的时候，就设置 <code>valid_o=1</code>；当 slave 可以接受请求的时候，就设置 <code>ready_i=1</code>；在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时视为一次请求</li>
<li>如果 master 发起请求，同时 slave 不能接收请求，即 <code>valid_o=1 &amp;&amp; ready_i=0</code>，此时 master 要保持 <code>addr_o</code> <code>we_o</code> <code>data_o</code> 和 <code>be_o</code> 不变，直到请求结束</li>
<li>当 master 不发起请求的时候，即 <code>valid_o=0</code>，此时总线上的信号都视为无效数据，不应该进行处理；对于读操作，只有在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时 <code>data_i</code> 上的数据是有效的</li>
<li>可以连续多个周期发生请求，即 <code>valid_o=1 &amp;&amp; ready_i=1</code> 连续多个周期等于一，此时是理想情况，可以达到总线最高的传输速度</li>
</ol>
<h3 id="wishbone-classic-standard"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#wishbone-classic-standard">Wishbone Classic Standard</a></h3>
<p>首先我们来看最简单的 Wishbone 版本 Wishbone Classic Standard。其设计思路和上面的自研总线非常相似，让我们来看看它的信号，例如 master 端（CPU 端）的信号：</p>
<ol>
<li><code>CLK_I</code>: 时钟输入，即自研总线中的 <code>clock_i</code></li>
<li><code>STB_O</code>：高表示 master 要发送请求，即自研总线中的 <code>valid_o</code></li>
<li><code>ACK_I</code>：高表示 slave 处理请求，即自研总线中的 <code>ready_i</code></li>
<li><code>ADR_O</code>：master 想要读写的地址，即自研总线中的 <code>addr_o</code></li>
<li><code>WE_O</code>：master 想要读还是写，即自研总线中的 <code>we_o</code></li>
<li><code>DAT_O</code>：master 想要写入的数据，即自研总线中的 <code>data_o</code></li>
<li><code>SEL_O</code>：master 读写的字节使能，即自研总线中的 <code>be_o</code></li>
<li><code>DAT_I</code>：master 从 slave 读取的数据，即自研总线中的 <code>data_i</code></li>
<li><code>CYC_O</code>：总线的使能信号，无对应的自研总线信号</li>
</ol>
<p>还有一些可选信号，这里就不赘述了。可以看到，除了最后一个 <code>CYC_O</code>，其他的信号其实就是我们刚刚设计的自研总线。<code>CYC_O</code> 的可以认为是 master 想要占用 slave 的总线接口，在常见的使用场景下，直接认为 <code>CYC_O=STB_O</code>。它的用途是：</p>
<ol>
<li>占用 slave 的总线接口，不允许其他 master 访问</li>
<li>简化 interconnect 的实现</li>
</ol>
<p>把上面自研总线的波形图改成 Wishbone Classic Standard，就可以得到：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p.........", node: ".abcdefgh"},
      { name: "CYC_O", wave: "0101.01..0"},
      { name: "STB_O", wave: "0101.01..0"},
      { name: "ACK_I", wave: "010.101..0"},
      { name: "ADR_O", wave: "x=x=.x===x", data: ["0x01", "0x02", "0x03", "0x01", "0x02"]},
      { name: "WE_O", wave: "x1x0.x101x"},
      { name: "DAT_O", wave: "x=xxxx=x=x", data: ["0x12", "0x56", "0x9a"]},
      { name: "SEL_O", wave: "x=x=.x=x=x", data: ["0x1", "0x1", "0x1", "0x1"]},
      { name: "DAT_I", wave: "xxxx=xx=xx", data: ["0x34", "0x12"]},
    ]
}</script>
<h3 id="wishbone-classic-pipelined"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#wishbone-classic-pipelined">Wishbone Classic Pipelined</a></h3>
<p>上面的 Wishbone Classic Standard 协议非常简单，但是会遇到一个问题：假设实现的是一个 SRAM 控制器，它的读操作有一个周期的延迟，也就是说，在这个周期给出地址，需要在下一个周期才可以得到结果。在 Wishbone Classic Standard 中，就会出现下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p.....", node: ".abcd"},
      { name: "CYC_O", wave: "01...0"},
      { name: "STB_O", wave: "01...0"},
      { name: "ACK_I", wave: "0.1010"},
      { name: "ADR_O", wave: "x=.=.x", data: ["0x01", "0x02"]},
      { name: "WE_O", wave: "x0...x"},
      { name: "DAT_O", wave: "xxxxxx"},
      { name: "SEL_O", wave: "x=...x", data: ["0x1"]},
      { name: "DAT_I", wave: "xx=x=x", data: ["0x12", "0x34"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：master 给出读地址 0x01，此时 SRAM 控制器开始读取，但是此时数据还没有读取回来，所以 <code>ACK_I=0</code></li>
<li><code>b</code> 周期：此时 SRAM 完成了读取，把读取的数据 0x12 放在 <code>DAT_I</code> 并设置 <code>ACK_I=1</code></li>
<li><code>c</code> 周期：master 给出下一个读地址 0x02，SRAM 要重新开始读取</li>
<li><code>d</code> 周期：此时 SRAM 完成了第二次读取，把读取的数据 0x34 放在 <code>DAT_I</code> 并设置 <code>ACK_I=1</code></li>
</ul>
<p>从波形来看，功能没有问题，但是每两个周期才能进行一次读操作，发挥不了最高的性能。那么怎么解决这个问题呢？我们在 <code>a</code> 周期给出第一个地址，在 <code>b</code> 周期得到第一个数据，那么如果能在 <code>b</code> 周期的时候给出第二个地址，就可以在 <code>c</code> 周期得到第二个数据。这样，就可以实现流水线式的每个周期进行一次读操作。但是，Wishbone Classic Standard 要求 <code>b</code> 周期时第一次请求还没有结束，因此我们需要修改协议，来实现流水线式的请求。</p>
<p>实现思路也很简单：既然 Wishbone Classic Standard 认为 <code>b</code> 周期时，第一次请求还没有结束，那就让第一次请求提前在 <code>a</code> 周期完成，只不过它的数据要等到 <code>b</code> 周期才能给出。实际上，这个时候的一次读操作，可以认为分成了两部分：首先是 master 向 slave 发送读请求，这个请求在 <code>a</code> 周期完成；然后是 slave 向 master 发送读的结果，这个结果在 <code>b</code> 周期完成。为了实现这个功能，我们进行如下修改：</p>
<ul>
<li>添加 <code>STALL_I</code> 信号：<code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; STALL_I=0</code> 表示进行一次读请求</li>
<li>修改 <code>ACK_I</code> 信号含义：<code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=1</code> 表示一次读响应</li>
</ul>
<p>进行如上修改以后，我们就得到了 Wishbone Classic Pipelined 总线协议。上面的两次连续读操作波形如下：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "CLK_I", wave: "p....", node: ".abcd"},
      { name: "CYC_O", wave: "01..0"},
      { name: "STB_O", wave: "01.0."},
      { name: "STALL_I", wave: "0...."},
      { name: "ACK_I", wave: "0.1.0"},
      { name: "ADR_O", wave: "x==xx", data: ["0x01", "0x02"]},
      { name: "WE_O", wave: "x0.xx"},
      { name: "DAT_O", wave: "xxxxx"},
      { name: "SEL_O", wave: "x=.xx", data: ["0x1"]},
      { name: "DAT_I", wave: "xx==x", data: ["0x12", "0x34"]},
    ]
}</script>
<ul>
<li><code>a</code> 周期：master 请求读地址 0x01，slave 接收读请求（<code>STALL_O=0</code>）</li>
<li><code>b</code> 周期：slave 返回读请求结果 0x12，并设置 <code>ACK_I=1</code>；同时 master 请求读地址 0x02，slave 接收读请求（<code>STALL_O=0</code>）</li>
<li><code>c</code> 周期：slave 返回读请求结果 0x34，并设置 <code>ACK_I=1</code>；master 不再发起请求，设置 <code>STB_O=0</code></li>
<li><code>d</code> 周期：所有请求完成，master 设置 <code>CYC_O=0</code></li>
</ul>
<p>这样我们就实现了一个每周期进行一次读操作的 slave。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/06/19/wishbone/#_3">参考文档</a></h3>
<ul>
<li><a href="https://cdn.opencores.org/downloads/wbspec_b4.pdf">Wishbone Spec B4</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/06/19/wishbone/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-06-07 00:00:00">2022年6月7日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nix-cookbook"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/">Nix Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_1">背景</a></h3>
<p>最近在尝试 NixOS 和在 macOS 上跑 Nix，下面记录一些我在使用过程中遇到的一些小问题和解决思路。</p>
<h3 id="nixos"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixos">NixOS</a></h3>
<h4 id="_2"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_2">全局配置</a></h4>
<p>NixOS 的全局配置路径：<code>/etc/nixos/configuration.nix</code> 和 <code>/etc/nixos/hardware-configuration.nix</code></p>
<p>应用更新后的全局配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>nixos-rebuild<span class="w"> </span>switch
</span><span id="__span-0-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1">## or</span>
</span><span id="__span-0-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">##!/usr/bin/env python3</span>
</span><span id="__span-1-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-1-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"USER"</span><span class="p">)</span>
</span><span id="__span-1-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"/nix/var/nix/profiles/"</span>
</span><span id="__span-1-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system"</span><span class="p">)</span>
</span><span id="__span-1-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"sudo nixos-rebuild switch --flake ."</span><span class="p">)</span>
</span><span id="__span-1-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">system"</span><span class="p">)</span>
</span><span id="__span-1-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">"nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="_3"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_3">更新大版本</a></h4>
<p>如果要更新 NixOS 21.11 到 22.05:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>nix-channel<span class="w"> </span>--list
</span><span id="__span-2-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>nix-channel<span class="w"> </span>--add<span class="w"> </span>https://nixos.org/channels/nixos-22.05<span class="w"> </span>nixos
</span><span id="__span-2-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--upgrade
</span></code></pre></div>
<p>可以考虑改或者不改 <code>/etc/nixos/configuration.nix</code> 中的 <code>system.stateVersion</code>。</p>
<h4 id="_4"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_4">常用配置</a></h4>
<p>常用的 NixOS 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">## Enable XFCE</span>
</span><span id="__span-3-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>services<span class="o">.</span>xserver<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>services<span class="o">.</span>xserver<span class="o">.</span>desktopManager<span class="o">.</span>xfce<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="c1">## System wide packages</span>
</span><span id="__span-3-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>environment<span class="o">.</span><span class="ss">systemPackages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-3-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>  xxx
</span><span id="__span-3-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">];</span>
</span><span id="__span-3-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">## Fish shell</span>
</span><span id="__span-3-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>users<span class="o">.</span>users<span class="o">.</span><span class="ss">xxx =</span> <span class="p">{</span>
</span><span id="__span-3-13"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>  <span class="ss">shell =</span> pkgs<span class="o">.</span>fish<span class="p">;</span>
</span><span id="__span-3-14"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">}</span>
</span><span id="__span-3-15"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>
</span><span id="__span-3-16"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="c1">## Command not found</span>
</span><span id="__span-3-17"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>programs<span class="o">.</span>command-not-found<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-18"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>
</span><span id="__span-3-19"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="c1">## Steam gaming</span>
</span><span id="__span-3-20"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-21"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>programs<span class="o">.</span>steam<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-22"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>
</span><span id="__span-3-23"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="c1">## NOPASSWD for sudo</span>
</span><span id="__span-3-24"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>security<span class="o">.</span>sudo<span class="o">.</span><span class="ss">wheelNeedsPassword =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-3-25"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>
</span><span id="__span-3-26"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="c1">## QEMU guest</span>
</span><span id="__span-3-27"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>services<span class="o">.</span>qemuGuest<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-28"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>services<span class="o">.</span>spice-vdagentd<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-29"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>
</span><span id="__span-3-30"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="c1">## XRDP</span>
</span><span id="__span-3-31"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-32"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">defaultWindowManager =</span> <span class="s2">"xfce4-session"</span><span class="p">;</span>
</span><span id="__span-3-33"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>services<span class="o">.</span>xrdp<span class="o">.</span><span class="ss">openFirewall =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-34"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>
</span><span id="__span-3-35"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="c1">## OpenSSH server</span>
</span><span id="__span-3-36"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>services<span class="o">.</span>openssh<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-3-37"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>
</span><span id="__span-3-38"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="c1">## Udev rules for Altera USB Blaster</span>
</span><span id="__span-3-39"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>services<span class="o">.</span>udev<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-3-40"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>  usb-blaster-udev-rules
</span><span id="__span-3-41"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="p">];</span>
</span></code></pre></div>
<h4 id="vscode-remote"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#vscode-remote">VSCode Remote</a></h4>
<p>VSCode Remote 会在远程的机器上运行一个预编译的 nodejs，运行的时候会因为路径问题无法执行。</p>
<p>解决方法在 <a href="https://nixos.wiki/wiki/Visual_Studio_Code#Remote_SSH">NixOS Wiki</a> 上有，具体来说，首先，需要安装 <code>nodejs</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>environment<span class="o">.</span><span class="ss">systemPackages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-4-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>  nodejs-16_x <span class="c1"># vscode remote</span>
</span><span id="__span-4-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">];</span>
</span></code></pre></div>
<p>然后，用软链接来覆盖 nodejs：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nb">cd</span><span class="w"> </span>~/.vscode-server/bin/HASH
</span><span id="__span-5-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>ln<span class="w"> </span>-sf<span class="w"> </span>/run/current-system/sw/bin/node
</span></code></pre></div>
<p>这样就可以正常使用 VSCode Remote 了。</p>
<h3 id="home-manager"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#home-manager">Home Manager</a></h3>
<p><a href="https://github.com/nix-community/home-manager">Home Manager</a> 描述用户默认看到的程序，而 NixOS 的配置是所有用户的。</p>
<h4 id="_5"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_5">配置文件</a></h4>
<p>配置文件：<code>~/.config/nixpkgs/home.nix</code></p>
<p>应用配置文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>home-manager<span class="w"> </span>switch
</span></code></pre></div>
<p>应用 Flakes 配置文件并显示变化：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">##!/usr/bin/env python3</span>
</span><span id="__span-7-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="__span-7-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"USER"</span><span class="p">)</span>
</span><span id="__span-7-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="n">home</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"/nix/var/nix/profiles/per-user/</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">/"</span>
</span><span id="__span-7-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">old</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile"</span><span class="p">)</span>
</span><span id="__span-7-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"home-manager switch --flake ."</span><span class="p">)</span>
</span><span id="__span-7-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="n">new</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">home</span><span class="si">}</span><span class="s2">profile"</span><span class="p">)</span>
</span><span id="__span-7-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">"nix store diff-closures </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_6">常用配置</a></h4>
<p>常用的 Home Manager 配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1">## Allow unfree</span>
</span><span id="__span-8-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfree =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-8-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>nixpkgs<span class="o">.</span>config<span class="o">.</span><span class="ss">allowUnfreePredicate =</span> <span class="p">(</span>pkg<span class="p">:</span> <span class="no">true</span><span class="p">);</span>
</span><span id="__span-8-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="c1">## User wide packages</span>
</span><span id="__span-8-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>home<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-8-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>  xxx
</span><span id="__span-8-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成 Nix 配置 <code>~/.config/nix/nix.conf</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">## Enable flakes &amp; setup TUNA mirror</span>
</span><span id="__span-9-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>nix<span class="o">.</span><span class="ss">package =</span> pkgs<span class="o">.</span>nix<span class="p">;</span>
</span><span id="__span-9-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>nix<span class="o">.</span><span class="ss">settings =</span> <span class="p">{</span>
</span><span id="__span-9-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>  <span class="ss">experimental-features =</span> <span class="p">[</span> <span class="s2">"nix-command"</span> <span class="s2">"flakes"</span> <span class="p">];</span>
</span><span id="__span-9-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>  <span class="ss">substituters =</span> <span class="p">[</span> <span class="s2">"https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store"</span> <span class="s2">"https://cache.nixos.org/"</span><span class="p">];</span>
</span><span id="__span-9-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="p">};</span>
</span></code></pre></div>
<p>Shell 环境变量和 PATH：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>home<span class="o">.</span><span class="ss">sessionVariables =</span> <span class="p">{</span>
</span><span id="__span-10-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>  <span class="ss">A =</span> <span class="s2">"B"</span><span class="p">;</span>
</span><span id="__span-10-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">};</span>
</span><span id="__span-10-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>home<span class="o">.</span><span class="ss">sessionPath =</span> <span class="p">[</span>
</span><span id="__span-10-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>  <span class="s2">"$HOME/.local/bin"</span>
</span><span id="__span-10-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="p">];</span>
</span></code></pre></div>
<p>离线 Home Manager 文档（用 <code>home-manager-help</code> 命令打开）：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>manual<span class="o">.</span>html<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="_7"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_7">覆盖依赖版本</a></h4>
<p>设置 JVM 程序依赖的 JDK 版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1">## Maven with java 11</span>
</span><span id="__span-12-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>home<span class="o">.</span><span class="ss">packages =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-12-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>  <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk =</span> jdk11<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="p">];</span>
</span><span id="__span-12-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>
</span><span id="__span-12-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="c1">## Many packages with the same JDK</span>
</span><span id="__span-12-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>home<span class="o">.</span><span class="ss">packages =</span> 
</span><span id="__span-12-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>  <span class="k">let</span> <span class="ss">java =</span> pkgs<span class="o">.</span>jdk11<span class="p">;</span> <span class="k">in</span>
</span><span id="__span-12-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>  <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-12-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="p">(</span>maven<span class="o">.</span>override <span class="p">{</span> <span class="ss">jdk =</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span class="p">(</span>sbt<span class="o">.</span>override <span class="p">{</span> <span class="ss">jre =</span> java<span class="p">;</span> <span class="p">})</span>
</span><span id="__span-12-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>  <span class="p">];</span>
</span></code></pre></div>
<p>具体的参数命名要看 nixpkgs 上对应的包的开头。</p>
<h4 id="direnv"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#direnv">配置 direnv</a></h4>
<p>direnv 是一个 shell 插件，它的用途是进入目录的时候，会根据 .envrc 来执行命令，比如自动进入 nix-shell 等。配置：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>programs<span class="o">.</span>direnv<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span></code></pre></div>
<p>然后在工程路径下，编写 <code>.envrc</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>use_nix
</span></code></pre></div>
<p>那么，在 shell 进入目录的时候，就会自动获得 nix-shell 的环境变量。</p>
<h4 id="fish"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#fish">配置 fish</a></h4>
<p>可以在 home manager 配置中编写 fish 配置，这样它会自动生成 <code>~/.config/fish/config.fish</code> 文件：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-15-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellAliases =</span> <span class="p">{</span>
</span><span id="__span-15-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>  <span class="ss">a =</span> <span class="s2">"b"</span><span class="p">;</span>
</span><span id="__span-15-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="p">};</span>
</span><span id="__span-15-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>programs<span class="o">.</span>fish<span class="o">.</span><span class="ss">shellInit =</span> <span class="s1">''</span>
</span><span id="__span-15-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="s1">  # Rust</span>
</span><span id="__span-15-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="s1">  set -x PATH ~/.cargo/bin $PATH</span>
</span><span id="__span-15-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="s1">''</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="git"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#git">配置 git</a></h4>
<p>同理，也可以在 home manager 中配置 git：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-16-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-16-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>programs<span class="o">.</span>git<span class="o">.</span>lfs<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span>
</span><span id="__span-16-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userName =</span> <span class="s2">"Someone"</span><span class="p">;</span>
</span><span id="__span-16-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">userEmail =</span> <span class="s2">"mail@example.com"</span><span class="p">;</span>
</span><span id="__span-16-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">extraConfig =</span> <span class="p">{</span>
</span><span id="__span-16-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>  <span class="ss">core =</span> <span class="p">{</span>
</span><span id="__span-16-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a>    <span class="ss">quotepath =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-16-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a>  <span class="p">};</span>
</span><span id="__span-16-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a>  <span class="ss">pull =</span> <span class="p">{</span>
</span><span id="__span-16-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a>    <span class="ss">rebase =</span> <span class="no">false</span><span class="p">;</span>
</span><span id="__span-16-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a>  <span class="p">};</span>
</span><span id="__span-16-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="p">};</span>
</span><span id="__span-16-13"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a>programs<span class="o">.</span>git<span class="o">.</span><span class="ss">ignores =</span> <span class="p">[</span>
</span><span id="__span-16-14"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a>  <span class="s2">".DS_Store"</span>
</span><span id="__span-16-15"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="p">];</span>
</span></code></pre></div>
<p>生成的 <code>git</code> 配置在 <code>~/.config/git/config</code> 和 <code>~/.config/git/ignore</code>。</p>
<h3 id="flakes"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#flakes">Flakes</a></h3>
<p>Flakes 可以用来把多个系统的 nix 配置写在一个项目中。例如：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-17-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="p">{</span>
</span><span id="__span-17-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>  <span class="ss">description =</span> <span class="s2">"Nix configuration"</span><span class="p">;</span>
</span><span id="__span-17-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>
</span><span id="__span-17-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-17-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>    home-manager<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:nix-community/home-manager/release-22.05"</span><span class="p">;</span>
</span><span id="__span-17-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:nixos/nixpkgs/nixos-22.05"</span><span class="p">;</span>
</span><span id="__span-17-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a>  <span class="p">};</span>
</span><span id="__span-17-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>
</span><span id="__span-17-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> home-manager <span class="p">}:</span>
</span><span id="__span-17-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a>    <span class="p">{</span>
</span><span id="__span-17-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a>      nixosConfigurations<span class="o">.</span><span class="ss">xxxx =</span> nixpkgs<span class="o">.</span>lib<span class="o">.</span>nixosSystem <span class="p">{</span>
</span><span id="__span-17-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a>        <span class="ss">system =</span> <span class="s2">"x86_64-linux"</span><span class="p">;</span>
</span><span id="__span-17-13"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a>        <span class="ss">modules =</span> <span class="p">[</span>
</span><span id="__span-17-14"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a>          <span class="o">.</span><span class="l">/nixos/xxxx/configuration.nix</span>
</span><span id="__span-17-15"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a>          home-manager<span class="o">.</span>nixosModules<span class="o">.</span>home-manager
</span><span id="__span-17-16"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a>          <span class="o">.</span><span class="l">/nixos/xxxx/home.nix</span>
</span><span id="__span-17-17"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a>        <span class="p">];</span>
</span><span id="__span-17-18"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a>      <span class="p">};</span>
</span><span id="__span-17-19"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a>      homeConfigurations<span class="o">.</span><span class="ss">yyyy =</span> home-manager<span class="o">.</span>lib<span class="o">.</span>homeManagerConfiguration <span class="p">{</span>
</span><span id="__span-17-20"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="ss">configuration =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/home-manager/yyyy/home.nix</span><span class="p">;</span>
</span><span id="__span-17-21"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="ss">system =</span> <span class="s2">"aarch64-darwin"</span><span class="p">;</span>
</span><span id="__span-17-22"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a>        <span class="ss">homeDirectory =</span> <span class="s2">"/Users/yyyy"</span><span class="p">;</span>
</span><span id="__span-17-23"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a>        <span class="ss">username =</span> <span class="s2">"yyyy"</span><span class="p">;</span>
</span><span id="__span-17-24"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a>        <span class="ss">stateVersion =</span> <span class="s2">"22.05"</span><span class="p">;</span>
</span><span id="__span-17-25"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a>      <span class="p">};</span>
</span><span id="__span-17-26"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a>    <span class="p">};</span>
</span><span id="__span-17-27"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后，要应用上面的配置，运行：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">## NixOS</span>
</span><span id="__span-18-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span><span id="__span-18-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="c1">## Home manager</span>
</span><span id="__span-18-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>home-manager<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.
</span></code></pre></div>
<p>这样就可以把若干个系统上的 nix 配置管理在一个仓库中了。</p>
<h3 id="_8"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_8">实用工具</a></h3>
<h4 id="nixpkgs-fmt"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs-fmt">nixpkgs-fmt</a></h4>
<p><a href="https://github.com/nix-community/nixpkgs-fmt">nixpkgs-fmt</a> 用来格式化 Nix 代码。</p>
<h4 id="searchnixosorg"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#searchnixosorg">search.nixos.org</a></h4>
<p><a href="https://search.nixos.org/">search.nixos.org</a> 可以搜索 nixpkgs 上的各种包，也可以看到不同平台支持情况。缺点是看不出是否 unfree 和 broken，并且一些 darwin os-specific 的包不会显示。</p>
<h4 id="nix-tree"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nix-tree">nix-tree</a></h4>
<p>显示各个 nix derivation 的硬盘占用和依赖关系。</p>
<h3 id="_9"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_9">打包</a></h3>
<p>可以很容易地编写 <code>default.nix</code> 来给自己的项目打包。</p>
<h4 id="cmake"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#cmake">CMake</a></h4>
<p>对于一个简单的 cmake 程序，可以按照如下的格式编写 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-19-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-19-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>
</span><span id="__span-19-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-19-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>  <span class="ss">name =</span> <span class="s2">"xyz"</span><span class="p">;</span>
</span><span id="__span-19-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a>  <span class="ss">version =</span> <span class="s2">"1.0"</span><span class="p">;</span>
</span><span id="__span-19-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a>
</span><span id="__span-19-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a>  <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-19-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a>
</span><span id="__span-19-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a>  <span class="ss">nativeBuildInputs =</span> <span class="p">[</span>
</span><span id="__span-19-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a>    cmake
</span><span id="__span-19-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a>  <span class="p">];</span>
</span><span id="__span-19-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a>
</span><span id="__span-19-13"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>  <span class="ss">buildInputs =</span> <span class="p">[</span>
</span><span id="__span-19-14"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>    xxx
</span><span id="__span-19-15"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a>    yyy
</span><span id="__span-19-16"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a>  <span class="p">];</span>
</span><span id="__span-19-17"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以用 <code>nix-build</code> 命令来构建，生成结果会在当前目录下创建一个 <code>result</code> 的软链接，里面就是安装目录。</p>
<p>由于 <code>nix-build</code> 的时候也会创建 <code>build</code> 目录，为了防止冲突，建议开发的时候用其他的名字。</p>
<h4 id="qt"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#qt">Qt</a></h4>
<p>对于 Qt 项目来说，由于有不同的 Qt 大版本，所以实现的时候稍微复杂一些，要拆成两个文件，首先是 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-20-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">with</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{};</span>
</span><span id="__span-20-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>
</span><span id="__span-20-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>libsForQt5<span class="o">.</span>callPackage <span class="o">.</span><span class="l">/xxx.nix</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></div>
<p>这里就表示用 <code>qt5</code> 来编译，那么编写 <code>xxx.nix</code> 的时候，传入的 <code>qtbase</code> 等库就是 <code>qt5</code> 的版本：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-21-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="p">{</span> stdenv<span class="p">,</span> qtbase<span class="p">,</span> wrapQtAppsHook<span class="p">,</span> cmake <span class="p">}:</span>
</span><span id="__span-21-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>
</span><span id="__span-21-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a>stdenv<span class="o">.</span>mkDerivation <span class="p">{</span>
</span><span id="__span-21-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a>  <span class="ss">name =</span> <span class="s2">"xxx"</span><span class="p">;</span>
</span><span id="__span-21-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>  <span class="ss">version =</span> <span class="s2">"1.0"</span><span class="p">;</span>
</span><span id="__span-21-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a>
</span><span id="__span-21-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a>  <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-21-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a>
</span><span id="__span-21-9"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-9" id="__codelineno-21-9" name="__codelineno-21-9"></a>  <span class="ss">nativeBuildInputs =</span> <span class="p">[</span>
</span><span id="__span-21-10"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-10" id="__codelineno-21-10" name="__codelineno-21-10"></a>    cmake
</span><span id="__span-21-11"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-11" id="__codelineno-21-11" name="__codelineno-21-11"></a>    wrapQtAppsHook <span class="c1"># must-have for qt apps</span>
</span><span id="__span-21-12"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-12" id="__codelineno-21-12" name="__codelineno-21-12"></a>  <span class="p">];</span>
</span><span id="__span-21-13"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-13" id="__codelineno-21-13" name="__codelineno-21-13"></a>
</span><span id="__span-21-14"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-14" id="__codelineno-21-14" name="__codelineno-21-14"></a>  <span class="ss">buildInputs =</span> <span class="p">[</span>
</span><span id="__span-21-15"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-15" id="__codelineno-21-15" name="__codelineno-21-15"></a>    qtbase
</span><span id="__span-21-16"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-16" id="__codelineno-21-16" name="__codelineno-21-16"></a>  <span class="p">];</span>
</span><span id="__span-21-17"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-21-17" id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>实际测试中发现，运行的程序可能会报告 <code>Could not initialize GLX</code> 的错误，这个方法可以通过 <code>wrapProgram</code> 添加环境变量解决：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>  # https://github.com/NixOS/nixpkgs/issues/66755#issuecomment-657305962
</span><span id="__span-22-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>  # Fix "Could not initialize GLX" error
</span><span id="__span-22-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>  postInstall = ''
</span><span id="__span-22-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a>    wrapProgram "$out/bin/xxx" --set QT_XCB_GL_INTEGRATION none
</span><span id="__span-22-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a>  '';
</span></code></pre></div>
<h3 id="_10"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_10">开发环境</a></h3>
<p>除了打包以外，通常还会在 <code>shell.nix</code> 中定义开发环境需要的包：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-23-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{}</span>
</span><span id="__span-23-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="p">}:</span>
</span><span id="__span-23-3"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a>
</span><span id="__span-23-4"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a>pkgs<span class="o">.</span>mkShell <span class="p">{</span>
</span><span id="__span-23-5"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a>  <span class="ss">buildInputs =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-23-6"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>    cmake
</span><span id="__span-23-7"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a>  <span class="p">];</span>
</span><span id="__span-23-8"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后可以用 <code>nix-shell</code> 来进入开发环境。如果不希望外面的环境变量传递进去，可以用 <code>nix-shell --pure</code>。</p>
<h3 id="_11"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_11">搜索</a></h3>
<p>按名字搜索一个包：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>nix<span class="w"> </span>search<span class="w"> </span>nixpkgs<span class="w"> </span>xxx
</span><span id="__span-24-2"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>nix-env<span class="w"> </span>-qaP<span class="w"> </span>yyy
</span></code></pre></div>
<h3 id="nixpkgs"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs">Nixpkgs</a></h3>
<p>可以从 TUNA 镜像上先 clone 一份到本地，然后再添加 github 上游作为 remote。</p>
<p>从本地 nixpkgs 安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>nix-env<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-iA<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>nix-build<span class="w"> </span><span class="nv">$PWD</span><span class="w"> </span>-A<span class="w"> </span>xxx
</span></code></pre></div>
<p>从本地 nixpkgs 开一个 shell：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a href="../../software/2022/06/07/nix-cookbook/#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>nix-shell<span class="w"> </span>-I<span class="w"> </span><span class="nv">nixpkgs</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>-p<span class="w"> </span>xxx
</span></code></pre></div>
<h4 id="nixpkgs_1"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#nixpkgs_1">Nixpkgs 的分支</a></h4>
<p>Nixpkgs 开发分支主要有三个：</p>
<ol>
<li>master</li>
<li>staging-next</li>
<li>staging</li>
</ol>
<p>发 PR 的时候，如果需要重新编译的包比较多，就要往 staging 提交；比较少，就往 staging-next 提交。</p>
<p>CI 会自动把 master 合并到 staging-next，也会把 staging-next 合并到 staging。这样 master 上的改动也会同步到 staging 上。</p>
<p>维护者会定义把 staging 手动合并到 staging-next，然后手动合并 staging-next 到 staging。这个的周期一般是一周多，可以在 pr 里搜索 staging-next。</p>
<p>Hydra 会编译 master 分支和 staging-next 分支上的包，不会编译 staging 分支上的包。同理，binary cache 上前两个分支上有的，而 staging 上没有的。</p>
<p>参考：<a href="https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy">https://nixos.org/manual/nixpkgs/stable/#submitting-changes-commit-policy</a></p>
<h4 id="_12"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_12">提交贡献</a></h4>
<p>注意事项：</p>
<ol>
<li>升级一些比较老的写法，例如 mkDerivation -&gt; stdenv.mkDerivation，Qt 的 hook</li>
<li>引入 patch 的时候，建议先向上游提 PR，如果合并了，就直接用上游的 commit；如果没有合并，退而求其次可以用 pr 的 patch；如果没有提 PR 的渠道，或者上游的 commit 无法应用到当前的版本，或者这个 patch 没有普适性，再写本地的 patch；注释里要写打 patch 的原因和相关的 issue 链接，什么时候不再需要这个 patch，并且起个名字</li>
<li>不知道 SHA256 的时候，可以注释掉或者随便写一个，这样 nix build 的时候会重新下载，然后把正确的显示出来</li>
<li>对于有命令的包，可以添加 testVersion 测试</li>
<li>长时间没有 review 的 pr，可以在 discourse 上回复帖子。</li>
<li>更新之前，可以搜索一下，有没有相关的 issue 或者 pr；如果有 issue，新建 pr 的时候要提一下</li>
</ol>
<p>一些常见的问题：</p>
<ol>
<li>编译器打开 <code>-fno-common</code> 后，可能会导致一些链接问题</li>
<li>Darwin 上的 clang 没有打开 LTO，也没有打开 Universal 支持</li>
<li>AArch64 Darwin 上的 gfortran 的 stack protector 不工作，需要把 hardening 关掉</li>
<li>当编译报错是 <code>-Werror</code> 导致的时候，按照 warning 类型在 NIX_CFLAGS_COMPILE 中添加 <code>-Wno-error=warning-type</code></li>
<li>configure 版本较老，需要引入 autoreconfHook</li>
</ol>
<p>阅读文档：<a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/quick-start.chapter.md</a> 和 <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md">https://github.com/NixOS/nixpkgs/blob/master/doc/contributing/coding-conventions.chapter.md</a></p>
<h3 id="vscode"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#vscode">VSCode</a></h3>
<p>可以安装 <a href="https://github.com/nix-community/vscode-nix-ide/">https://github.com/nix-community/vscode-nix-ide/</a> 插件，配合 <code>rnix-lsp</code> 来使用。</p>
<h3 id="_13"><a class="toclink" href="../../software/2022/06/07/nix-cookbook/#_13">杂项</a></h3>
<p>可以用 <code>nix copy</code> 命令在不同机器的 store 之间复制文件，见 <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-copy.html">nix copy - copy paths between Nix stores</a>。</p>
<nav class="md-post__action">
<a href="../../software/2022/06/07/nix-cookbook/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-31 00:00:00">2022年5月31日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="libvirt-risc-v"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/">在 libvirt 中运行 RISC-V 虚拟机</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#_1">背景</a></h3>
<p>我在 libvirt 中跑了几个 KVM 加速的虚拟机，然后突发奇想，既然 libvirt 背后是 qemu，然后 qemu 是支持跨指令集的，那是否可以让 libvirt 来运行 RISC-V 架构的虚拟机？经过一番搜索，发现可以跑 ARM：<a href="https://fedoraproject.org/wiki/Architectures/ARM/HowToQemu#Using_QEMU_with_libvirt">How To: Running Fedora-ARM under QEMU</a>，既然如此，我们也可以试试用 libvirt 来运行 RV64 虚拟机。</p>
<h3 id="rootfs"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#rootfs">准备 rootfs</a></h3>
<p>第一步是根据 Debian 的文档 <a href="https://wiki.debian.org/RISC-V#Creating_a_riscv64_chroot">Creating a riscv64 chroot</a> 来创建 rootfs，然后再用 virt-make-fs 来打包。</p>
<p>首先是用 mmdebstrap 来生成一个 chroot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-0-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>mmdebstrap<span class="w"> </span>qemu-user-static<span class="w"> </span>binfmt-support<span class="w"> </span>debian-ports-archive-keyring
</span><span id="__span-0-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>mmdebstrap<span class="w"> </span>--architectures<span class="o">=</span>riscv64<span class="w"> </span>--include<span class="o">=</span><span class="s2">"debian-ports-archive-keyring"</span><span class="w"> </span>sid<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span><span class="s2">"deb http://deb.debian.org/debian-ports sid main"</span><span class="w"> </span><span class="s2">"deb http://deb.debian.org/debian-ports unreleased main"</span>
</span></code></pre></div>
<p>进入 chroot 以后，进行一些配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>chroot<span class="w"> </span>/tmp/riscv64-chroot
</span><span id="__span-1-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>$<span class="w"> </span>apt<span class="w"> </span>update
</span><span id="__span-1-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>$<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-image-riscv64<span class="w"> </span>u-boot-menu<span class="w"> </span>vim
</span><span id="__span-1-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1">## set root password</span>
</span><span id="__span-1-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>$<span class="w"> </span>passwd
</span></code></pre></div>
<p>然后修改 <code>/etc/default/u-boot</code> 文件，添加如下的配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">## change ro to rw, set root device</span>
</span><span id="__span-2-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nv">U_BOOT_PARAMETERS</span><span class="o">=</span><span class="s2">"rw noquiet root=/dev/vda1"</span>
</span><span id="__span-2-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="c1">## fdt is provided by qemu</span>
</span><span id="__span-2-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nv">U_BOOT_FDT_DIR</span><span class="o">=</span><span class="s2">"noexist"</span>
</span></code></pre></div>
<p>然后运行 <code>u-boot-update</code> 生成配置文件 <code>/boot/extlinux/extlinux.conf</code>。</p>
<p>到这里，rootfs 已经准备完毕。</p>
<h3 id="qemu"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#qemu">尝试在 QEMU 中启动</a></h3>
<p>接下来，可以参考 <a href="https://wiki.debian.org/RISC-V#Setting_up_a_riscv64_virtual_machine">Setting up a riscv64 virtual machine</a> 先启动一个 qemu 来测试一下是否可以正常工作：</p>
<p>首先制作一个 qcow2 格式的镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>virt-make-fs<span class="w"> </span>--partition<span class="o">=</span>gpt<span class="w"> </span>--type<span class="o">=</span>ext4<span class="w"> </span>--size<span class="o">=</span>+10G<span class="w"> </span>--format<span class="o">=</span>qcow2<span class="w"> </span>/tmp/riscv64-chroot<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>$<span class="w"> </span>qemu-img<span class="w"> </span>info<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>image:<span class="w"> </span>rootfs.qcow2
</span><span id="__span-3-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>file<span class="w"> </span>format:<span class="w"> </span>qcow2
</span><span id="__span-3-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>virtual<span class="w"> </span>size:<span class="w"> </span><span class="m">11</span>.4<span class="w"> </span>GiB<span class="w"> </span><span class="o">(</span><span class="m">12231971328</span><span class="w"> </span>bytes<span class="o">)</span>
</span><span id="__span-3-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>disk<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span>.33<span class="w"> </span>GiB
</span><span id="__span-3-7"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>cluster_size:<span class="w"> </span><span class="m">65536</span>
</span><span id="__span-3-8"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>Format<span class="w"> </span>specific<span class="w"> </span>information:
</span><span id="__span-3-9"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span>compat:<span class="w"> </span><span class="m">1</span>.1
</span><span id="__span-3-10"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span>compression<span class="w"> </span>type:<span class="w"> </span>zlib
</span><span id="__span-3-11"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span>lazy<span class="w"> </span>refcounts:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-3-12"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span>refcount<span class="w"> </span>bits:<span class="w"> </span><span class="m">16</span>
</span><span id="__span-3-13"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span>corrupt:<span class="w"> </span><span class="nb">false</span>
</span><span id="__span-3-14"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span>extended<span class="w"> </span>l2:<span class="w"> </span><span class="nb">false</span>
</span></code></pre></div>
<p>然后启动 qemu，配置好 OpenSBI 和 U-Boot 的路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>qemu-system-misc<span class="w"> </span>opensbi<span class="w"> </span>u-boot-qemu
</span><span id="__span-4-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>$<span class="w"> </span>sudo<span class="w"> </span>qemu-system-riscv64<span class="w"> </span>-nographic<span class="w"> </span>-machine<span class="w"> </span>virt<span class="w"> </span>-m<span class="w"> </span>8G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span>-bios<span class="w"> </span>/usr/lib/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span>-kernel<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode/uboot.elf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span>-object<span class="w"> </span>rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0<span class="w"> </span>-device<span class="w"> </span>virtio-rng-device,rng<span class="o">=</span>rng0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span>-append<span class="w"> </span><span class="s2">"console=ttyS0 rw root=/dev/vda1"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-7"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span>-device<span class="w"> </span>virtio-blk-device,drive<span class="o">=</span>hd0<span class="w"> </span>-drive<span class="w"> </span><span class="nv">file</span><span class="o">=</span>rootfs.qcow2,format<span class="o">=</span>qcow2,id<span class="o">=</span>hd0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-8"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span>-device<span class="w"> </span>virtio-net-device,netdev<span class="o">=</span>usernet<span class="w"> </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>usernet,hostfwd<span class="o">=</span>tcp::22222-:22
</span></code></pre></div>
<p>如果系统可以正常工作，看到下面的输出，下一步就可以配置 libvirt 了。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>[    6.285024] Run /init as init process
</span><span id="__span-5-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>Loading, please wait...
</span><span id="__span-5-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>Starting version 251.1-1
</span><span id="__span-5-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>[    7.743714] virtio_ring: module verification failed: signature and/or required key missing - tainting kernel
</span><span id="__span-5-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>[    8.071762] virtio_blk virtio1: [vda] 23838189 512-byte logical blocks (12.2 GB/11.4 GiB)
</span><span id="__span-5-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>[    8.181210]  vda: vda1
</span><span id="__span-5-7"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>Begin: Loading essential drivers ... done.
</span><span id="__span-5-8"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>Begin: Running /scripts/init-premount ... done.
</span><span id="__span-5-9"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>Begin: Mounting root file system ... Begin: Running /scripts/local-top ... done.
</span><span id="__span-5-10"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>Begin: Running /scripts/local-premount ... done.
</span><span id="__span-5-11"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>Warning: fsck not present, so skipping root file system
</span><span id="__span-5-12"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>[    9.003143] EXT4-fs (vda1): mounted filesystem with ordered data mode. Quota mode: none.
</span><span id="__span-5-13"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>done.
</span><span id="__span-5-14"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>Begin: Running /scripts/local-bottom ... done.
</span><span id="__span-5-15"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>Begin: Running /scripts/init-bottom ... done.
</span><span id="__span-5-16"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>[    9.754151] Not activating Mandatory Access Control as /sbin/tomoyo-init does not exist.
</span><span id="__span-5-17"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>[    9.808860] random: fast init done
</span><span id="__span-5-18"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>[   10.651361] systemd[1]: Inserted module 'autofs4'
</span><span id="__span-5-19"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>[   10.735574] systemd[1]: systemd 251.1-1 running in system mode (+PAM +AUDIT +SELINUX +APPARMOR +IMA +SMACK +SECCOMP +GCRYPT -GNUTLS +OPENSSL +ACL +BLKID +CURL +ELFUTILS +FIDO2 +IDN2 -IDN +IPTC +KMOD +LIBCRYPTSETUP +LIBFDISK +PCRE2 -PWQUALITY -P11KIT -QRENCODE +TPM2 +BZIP2 +LZ4 +XZ +ZLIB +ZSTD -BPF_FRAMEWORK -XKBCOMMON +UTMP +SYSVINIT default-hierarchy=unified)
</span><span id="__span-5-20"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>[   10.736902] systemd[1]: Detected architecture riscv64.
</span><span id="__span-5-21"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>
</span><span id="__span-5-22"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a>Welcome to Debian GNU/Linux bookworm/sid!
</span></code></pre></div>
<h3 id="libvirt"><a class="toclink" href="../../software/2022/05/31/qemu-rv64-in-libvirt/#libvirt">配置 libvirt</a></h3>
<p>首先，打开 virt-manager，在向导中，可以在下拉菜单选择自定义的架构，选择 riscv64 和 virt，然后选择 Import existing disk image，找到刚刚创建的 qcow2 文件。</p>
<p>创建好以后，我们还不能直接启动，因为此时还没有配置 OpenSBI 和 U-Boot。由于 virt-aa-helper 会<a href="https://github.com/wiedi/libvirt/blob/435b4ad22bf812d97f30e4d6b71e6b3a967f4f75/src/security/virt-aa-helper.c#L529">检查 OpenSBI 和 U-Boot 的路径，要求它们不能在 /usr/lib 路径下</a>：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="cm">/*</span>
</span><span id="__span-6-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="cm"> * Don't allow access to special files or restricted paths such as /bin, /sbin,</span>
</span><span id="__span-6-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="cm"> * /usr/bin, /usr/sbin and /etc. This is in an effort to prevent read/write</span>
</span><span id="__span-6-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="cm"> * access to system files which could be used to elevate privileges. This is a</span>
</span><span id="__span-6-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="cm"> * safety measure in case libvirtd is under a restrictive profile and is</span>
</span><span id="__span-6-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="cm"> * subverted and trying to escape confinement.</span>
</span><span id="__span-6-7"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="cm"> *</span>
</span><span id="__span-6-8"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="cm"> * Note that we cannot exclude block devices because they are valid devices.</span>
</span><span id="__span-6-9"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="cm"> * The TEMPLATE file can be adjusted to explicitly disallow these if needed.</span>
</span><span id="__span-6-10"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="cm"> *</span>
</span><span id="__span-6-11"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="cm"> * RETURN: -1 on error, 0 if ok, 1 if blocked</span>
</span><span id="__span-6-12"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="cm"> */</span>
</span><span id="__span-6-13"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">restricted</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-14"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">        </span><span class="s">"/bin/"</span><span class="p">,</span>
</span><span id="__span-6-15"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">        </span><span class="s">"/etc/"</span><span class="p">,</span>
</span><span id="__span-6-16"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">        </span><span class="s">"/lib"</span><span class="p">,</span>
</span><span id="__span-6-17"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">        </span><span class="s">"/lost+found/"</span><span class="p">,</span>
</span><span id="__span-6-18"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">        </span><span class="s">"/proc/"</span><span class="p">,</span>
</span><span id="__span-6-19"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">        </span><span class="s">"/sbin/"</span><span class="p">,</span>
</span><span id="__span-6-20"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">        </span><span class="s">"/selinux/"</span><span class="p">,</span>
</span><span id="__span-6-21"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">        </span><span class="s">"/sys/"</span><span class="p">,</span>
</span><span id="__span-6-22"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">        </span><span class="s">"/usr/bin/"</span><span class="p">,</span>
</span><span id="__span-6-23"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">        </span><span class="s">"/usr/lib"</span><span class="p">,</span>
</span><span id="__span-6-24"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">        </span><span class="s">"/usr/sbin/"</span><span class="p">,</span>
</span><span id="__span-6-25"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">        </span><span class="s">"/usr/share/"</span><span class="p">,</span>
</span><span id="__span-6-26"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">        </span><span class="s">"/usr/local/bin/"</span><span class="p">,</span>
</span><span id="__span-6-27"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">        </span><span class="s">"/usr/local/etc/"</span><span class="p">,</span>
</span><span id="__span-6-28"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="s">"/usr/local/lib"</span><span class="p">,</span>
</span><span id="__span-6-29"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">        </span><span class="s">"/usr/local/sbin/"</span>
</span><span id="__span-6-30"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="p">};</span>
</span></code></pre></div>
<p>所以，我手动把 U-Boot 和 OpenSBI 复制一份到 /var/lib 下：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/var/lib/custom
</span><span id="__span-7-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/var/lib/custom
</span><span id="__span-7-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/u-boot/qemu-riscv64_smode<span class="w"> </span>.
</span><span id="__span-7-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>$<span class="w"> </span>sudo<span class="w"> </span>cp<span class="w"> </span>-r<span class="w"> </span>/usr/lib/riscv64-linux-gnu<span class="w"> </span>.
</span></code></pre></div>
<p>此时，再去配置 libvirt 的 XML 配置文件：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="w">  </span><span class="nt">&lt;os&gt;</span>
</span><span id="__span-8-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="nt">&lt;type</span><span class="w"> </span><span class="na">arch=</span><span class="s">'riscv64'</span><span class="w"> </span><span class="na">machine=</span><span class="s">'virt'</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
</span><span id="__span-8-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="nt">&lt;loader</span><span class="w"> </span><span class="na">type=</span><span class="s">'rom'</span><span class="nt">&gt;</span>/var/lib/custom/riscv64-linux-gnu/opensbi/generic/fw_jump.elf<span class="nt">&lt;/loader&gt;</span>
</span><span id="__span-8-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="nt">&lt;kernel&gt;</span>/var/lib/custom/qemu-riscv64_smode/uboot.elf<span class="nt">&lt;/kernel&gt;</span>
</span><span id="__span-8-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="nt">&lt;boot</span><span class="w"> </span><span class="na">dev=</span><span class="s">'hd'</span><span class="nt">/&gt;</span>
</span><span id="__span-8-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="nt">&lt;/os&gt;</span>
</span></code></pre></div>
<p>其余部分不用修改。在下面可以看到 virt-manager 已经设置好了 qemu-system-riscv64:</p>
<div class="language-XML highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nt">&lt;devices&gt;</span>
</span><span id="__span-9-2"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="nt">&lt;emulator&gt;</span>/usr/bin/qemu-system-riscv64<span class="nt">&lt;/emulator&gt;</span>
</span><span id="__span-9-3"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="nt">&lt;disk</span><span class="w"> </span><span class="na">type=</span><span class="s">'file'</span><span class="w"> </span><span class="na">device=</span><span class="s">'disk'</span><span class="nt">&gt;</span>
</span><span id="__span-9-4"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="nt">&lt;driver</span><span class="w"> </span><span class="na">name=</span><span class="s">'qemu'</span><span class="w"> </span><span class="na">type=</span><span class="s">'qcow2'</span><span class="nt">/&gt;</span>
</span><span id="__span-9-5"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="nt">&lt;source</span><span class="w"> </span><span class="na">file=</span><span class="s">'/path/to/rootfs.qcow2'</span><span class="nt">/&gt;</span>
</span><span id="__span-9-6"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="nt">&lt;target</span><span class="w"> </span><span class="na">dev=</span><span class="s">'vda'</span><span class="w"> </span><span class="na">bus=</span><span class="s">'virtio'</span><span class="nt">/&gt;</span>
</span><span id="__span-9-7"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="nt">&lt;address</span><span class="w"> </span><span class="na">type=</span><span class="s">'pci'</span><span class="w"> </span><span class="na">domain=</span><span class="s">'0x0000'</span><span class="w"> </span><span class="na">bus=</span><span class="s">'0x04'</span><span class="w"> </span><span class="na">slot=</span><span class="s">'0x00'</span><span class="w"> </span><span class="na">function=</span><span class="s">'0x0'</span><span class="nt">/&gt;</span>
</span><span id="__span-9-8"><a href="../../software/2022/05/31/qemu-rv64-in-libvirt/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="nt">&lt;/disk&gt;</span>
</span></code></pre></div>
<p>保存以后直接启动，就完成了在 libvirt 中运行 Debian RV64 虚拟机的目的。</p>
<nav class="md-post__action">
<a href="../../software/2022/05/31/qemu-rv64-in-libvirt/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-19 00:00:00">2022年5月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 16 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="sram"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/">「教学」异步 SRAM 时序</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_1">背景</a></h3>
<p>在一些场合里，我们会使用异步的（即没有时钟信号的）外部 SRAM 来存储数据，而我们经常使用的很多外部接口都是同步接口（即有时钟信号的接口），比如 SPI 和 I2C 等等，UART 虽然是异步，但是它速度很低，不怎么需要考虑时序的问题。所以在 FPGA 上编写一个正确的异步 SRAM 控制器是具有一定的挑战的。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_2">寄存器时序</a></h3>
<p>考虑到读者可能已经不记得寄存器的时序了，这里首先来复习一下 setup 和 hold 的概念。如果你已经比较熟悉了，可以直接阅读下一节。</p>
<p>寄存器在时钟的上升沿（下图的 <code>a</code>）进行采样，为了保证采样的稳定性，输入引脚 <code>D</code> 需要在时钟上升沿之前 <span class="arithmatex">\(t_{su}\)</span> 的时刻（下图的 <code>b</code>）到时钟上升沿之后 <span class="arithmatex">\(t_h\)</span> 的时刻（下图的 <code>c</code>）保持稳定，输出引脚 <code>Q</code> 会在时钟上升沿之后 <span class="arithmatex">\(t_{cko}\)</span> 的时刻（下图的 <code>d</code>）变化：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "C", wave: "p.", period: 4, node: ".a"},
      { name: "D", wave: "x..3.x", phase: 0.2, node: "...b.c"},
      { name: "Q", wave: "x...3.", node: "....d"}
    ]
}</script>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_3">接口</a></h3>
<p>首先我们来看看异步 SRAM 的接口。下文中，采用 <a href="https://www.issi.com/WW/pdf/61WV102416ALL.pdf">IS61WV102416BLL-10TLI</a> 和 <a href="https://www.alliancememory.com/wp-content/uploads/pdf/sram/fa/Alliance%C2%A0Memory_4M%C2%A0Fast_SRAM_AS7C34098A_Sep2021_v2.3.pdf">AS7C34098A-10TCN</a> 作为例子：</p>
<p><img alt="" src="/images/sram.png"/></p>
<p>可以看到，它有 20 位的地址，16 位的数据，若干个控制信号，同时只能进行读或者写（简称 <code>1RW</code>）。它没有时钟信号，所以是异步 SRAM。</p>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_4">时序</a></h3>
<p>对于一个同步接口，我们通常只需要给一个满足时钟周期的时钟，然后通过约束文件保证 setup 和 hold 条件满足即可。但是对于异步接口，由于输出的时候没有时钟，我们需要更小心地完成这件事情。</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_5">读时序</a></h4>
<p>首先来看一下比较简单的读时序：</p>
<p><img alt="" src="/images/sram_read.png"/></p>
<p>可以看到地址和数据的关系：首先是地址需要稳定 <span class="arithmatex">\(t_{RC}\)</span> 的时间，那么数据合法的范围是地址稳定的初始时刻加上 <span class="arithmatex">\(t_{AA}\)</span>，到地址稳定的结束时刻加上 <span class="arithmatex">\(t_{OH}\)</span>。我们再来看一下这几个时间的范围：</p>
<p><img alt="" src="/images/sram_read_param.png"/></p>
<p>首先可以看到读周期时间 <span class="arithmatex">\(t_{RC}\)</span> 至少是 10ns，这对应了型号中最后的数字，这表示了这个 SRAM 最快的读写速度。比较有意思的是 <span class="arithmatex">\(t_{AA}\)</span> 最多是 10ns，刚好和 <span class="arithmatex">\(t_{RC}\)</span> 的最小值相等。</p>
<p>接下来我们考虑一下如何为 SRAM 控制器时序读取的功能。看到上面的波形图，大概可以想到几条设计思路：</p>
<ol>
<li>首先输出要读取的地址，为了让它稳定（<span class="arithmatex">\(t_{RC}\)</span> 的时间内不能变化），要直接从 FPGA 内部寄存器的输出端口输出</li>
<li>等待若干个周期，确保数据已经稳定，在满足 FPGA 内部寄存器的 setup 和 hold 约束的情况下，把结果保存在内部寄存器中。</li>
</ol>
<p>简单起见，先设置一个非常快的 SRAM 控制器频率：500MHz，每个周期 2ns，假如在 <code>a</code> 时刻地址寄存器输出了当前要读取的地址，那么数据会在一段时间后变为合法。这里 <code>a-&gt;b</code> 是读取周期时间 <span class="arithmatex">\(t_{RC}\)</span>，<code>a-&gt;c</code> 是地址到数据的延迟 <span class="arithmatex">\(t_{AA}\)</span>，<code>b-&gt;d</code> 是地址改变后数据的保持时间 <span class="arithmatex">\(t_{OH}\)</span>。</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "xxx4....x", node: "...c....d"},
    ]
}</script>
<p>那么根据这个图，很自然的想法是，我先给出地址，然后数周期，数了五个周期后，此时 <span class="arithmatex">\(t_{RC}=10\mathrm{ns}\)</span>，然后我就在 <code>e</code> 的上升沿上把输入数据锁存到寄存器中，例如下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "xxx4....x", node: "...c....d"},
      { name: "data_reg", wave: "x.....4..", node: "......f"},
    ]
}</script>
<p>这个时候 <code>data_reg</code> 的 setup 时间是 <code>c-&gt;e</code>，hold 时间是 <code>e-&gt;d</code>。从图中看起来还有很多的余量，但如果考虑最坏情况，<span class="arithmatex">\(t_{AA}=10\mathrm{ns}\)</span>，就会变成下面的波形：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk", wave: "p........", node: "......e"},
      { name: "addr", wave: "x3....xxx", node: ".a....b"},
      { name: "data", wave: "x.....4.x", node: "......c.d"},
      { name: "data_reg", wave: "x.....x4.", node: "......."},
    ]
}</script>
<p>这个时候在 <code>e</code> 时刻不再满足 setup 约束。这个问题在仿真中，可能会“极限操作”表现为没有问题，但实际上，地址从 FPGA 到 SRAM 的延迟有：</p>
<ol>
<li>地址寄存器从时钟上升沿到输出变化的延迟：<span class="arithmatex">\(T_{CKO}=0.40\mathrm{ns}\)</span></li>
<li>寄存器输出到 FPGA 输出引脚的延迟：<span class="arithmatex">\(T_{IOOP} \in (2.56, 3.80)\mathrm{ns}\)</span></li>
<li>FPGA 输出的地址信号通过信号线到 SRAM 的延迟：<span class="arithmatex">\(T_{PD}\)</span></li>
</ol>
<p>数据从 SRAM 到 FPGA 的延迟有：</p>
<ol>
<li>SRAM 数据信号通过信号线到 FPGA 的延迟：<span class="arithmatex">\(T_{PD}\)</span></li>
<li>FPGA 的输入引脚到内部寄存器输入端的延迟：<span class="arithmatex">\(T_{IOPI}=1.26ns\)</span></li>
<li>FPGA 内部寄存器的 setup 时间：<span class="arithmatex">\(T_{AS}=0.07\mathrm{ns}\)</span></li>
</ol>
<p><img alt="" src="/images/sram_read_diagram.drawio.png"/></p>
<p>上面的一些数据可以从 <a href="https://docs.xilinx.com/v/u/en-US/ds181_Artix_7_Data_Sheet">Artix-7 FPGA Datasheet</a> 里查到，取的是速度等级 <code>-3</code> 的数据，IO 标准是 <code>LVCMOS33</code>。其中寄存器到 FPGA 输入输出引脚的延迟，实际上由两部分组成：从寄存器到 IOB（IO Block）的延迟，以及 IOB 到 FPGA 输入输出引脚的延迟。我们把地址寄存器的输出作为地址输出，这样 Vivado 就会把寄存器放到 IOB，于是可以忽略寄存器到 IOB 的延迟，详情可以阅读文档 <a href="https://support.xilinx.com/s/article/66668?language=en_US">Successfully packing a register into an IOB with Vivado</a>。</p>
<p>把上面一串加起来，已经有大概 4 到 5ns 了。考虑了延迟以后，上面的图可能实际上是这个样子：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p.........."},
      { name: "addr_fpga", wave: "x3....x...."},
      { name: "addr_sram", wave: "x.3....x....", phase: 0.3},
      { name: "data_sram", wave: "x......4.x..", phase: 0.3},
      { name: "data_fpga", wave: "x.......4.x"},
    ]
}</script>
<p>考虑了这么多实际的延迟因素以后，会发现这个事情并不简单，需要预先估计出数据在大概什么时候稳定，这时候才能保证数据寄存器上保存的数据是正确的。</p>
<p>转念一想，我们的 SRAM Controller 肯定不会跑在 500MHz 这么高的频率下。假如采用 100MHz，可以每两个周期进行一次读操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p...", period: 5, phase: 4.0, node: "..ab"},
      { name: "addr_fpga", wave: "x3.........5...."},
      { name: "addr_sram", wave: "x.3.........5...", phase: 0.3},
      { name: "data_sram", wave: "x......4.....x..", phase: 0.3},
      { name: "data_fpga", wave: "x.......4.....x."},
    ]
}</script>
<p>此时在 <code>b</code> 时钟上边沿对 <code>data_fpga</code> 采样就可以保证满足时序的要求。注意这里第二个周期（上图的 <code>a</code>）不能给出第二次读取的地址，否则稳定时间太短，不满足 hold 约束。</p>
<p>如果频率继续降低，使得一个时钟周期大于 <span class="arithmatex">\(t_{AA}\)</span> 加上各种延迟和 setup 时间，那就可以每个周期进行一次读操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clk_fpga", wave: "p...", period: 8, phase: 7.0, node: "..a."},
      { name: "addr_fpga", wave: "x3.......5.......7..."},
      { name: "addr_sram", wave: "x.3.......5.......7..", phase: 0.3},
      { name: "data_sram", wave: "x......4....x..6...x.", phase: 0.3},
      { name: "data_fpga", wave: "x.......4....x..6...x"},
    ]
}</script>
<p>此时在 <code>a</code> 时钟上升沿上，对 <code>data_fpga</code> 进行采样，并且输出下一次读请求的地址。</p>
<h4 id="_6"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_6">写时序</a></h4>
<p>接下来再看看写时序。写时序涉及的信号更多，更加复杂一些，但好处是信号都是从 FPGA 到 SRAM，因此考虑延迟的时候会比较简单，比如上面读时序中需要考虑从 FPGA 到 SRAM 的地址，再从 SRAM 到 FPGA 的数据的路径。时序图如下：</p>
<p><img alt="" src="/images/sram_write.png"/></p>
<p>这个写的时序图，从时间顺序来看有这么几件事情按顺序发生：</p>
<ol>
<li>地址保持稳定</li>
<li>经过 <span class="arithmatex">\(t_{AS}\)</span> 时间后，写使能信号 <span class="arithmatex">\(\overline{WE}\)</span> 变为低电平，表示“开始写入操作”，此时地址是稳定的</li>
<li>经过 <span class="arithmatex">\(t_{WP}\)</span> 时间后，写使能信号<span class="arithmatex">\(\overline{WE}\)</span> 变为高电平，表示“结束写入操作”，此时地址和数据都是稳定的，并且数据满足 setup（<span class="arithmatex">\(t_{DW}\)</span>）和 hold（<span class="arithmatex">\(t_{DH}\)</span>）约束</li>
<li>继续保持地址稳定，直到已经稳定了 <span class="arithmatex">\(t_{WC}\)</span> 时间</li>
</ol>
<p>这些数据的范围如下：</p>
<p><img alt="" src="/images/sram_write_timing.png"/></p>
<p>根据上面的分析，还是先考虑一个 500MHz 的 SRAM 控制器。控制器要写入的话，可以按照如下的顺序操作：</p>
<ol>
<li>第一个周期（下图的 <code>a</code>）先输出要写入的地址和数据，并且设置好 <code>ce_n</code>, <code>oe_n</code>, <code>we_n</code>, <code>ub_n</code> 和 <code>lb_n</code>。</li>
<li>第二个周期（下图的 <code>c</code>）设置 <span class="arithmatex">\(\overline{WE}\)</span> 为低电平，这是为了满足 <span class="arithmatex">\(t_{AS}\)</span> （下图的 <code>a -&gt; c</code>）的条件</li>
<li>等待若干个周期（下图的 <code>c -&gt; d</code>），直到 <span class="arithmatex">\(t_{WP}\)</span> （下图的 <code>c -&gt; d</code>）和 <span class="arithmatex">\(t_{AW}\)</span> （下图的 <code>a -&gt; d</code>）时间满足条件</li>
<li>设置 <span class="arithmatex">\(\overline{WE}\)</span> 为高电平（下图的 <code>d</code>），等待若干个周期（下图的 <code>d -&gt; b</code>），直到满足图中的 <span class="arithmatex">\(t_{WC}\)</span> （下图的 <code>a -&gt; b</code>）时间满足条件</li>
</ol>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p........", node: ".a.....b"},
      { name: "addr", wave: "x3.....5."},
      { name: "data", wave: "x4.....6."},
      { name: "we_n", wave: "1.0...1.0", node: "..c...d"},
      { name: "oe_n", wave: "x1......."},
      { name: "ce_n", wave: "x0......."},
    ]
}</script>
<p>这时候你可能有点疑惑，之前分析读时序的时候，考虑了那么多延迟，为什么写的时候不考虑了？这是因为，写的时候所有的信号都是从 FPGA 输出到 SRAM 的，只要这些信号都是从寄存器直接输出，它们的延迟基本是一样的，所以在 FPGA 侧是什么波形，在 SRAM 侧也是什么波形（准确来说，数据信号因为输出是三态门，所以延迟会稍微高一点，但是由于数据信号的时序余量很大，这个额外的延迟可以忽略不计）。</p>
<p>这时候你可能又有一个疑惑了，在阅读 Datasheet 后发现，<span class="arithmatex">\(t_{AS}\)</span> 最小是 0ns，那能不能在上图的 <code>a</code> 时刻就输出 <code>we_n=0</code>？答案是不行，虽然从波形上来看，是在同一个时钟上升沿更新，但实际上会有一微小的延迟差距，可能导致 <code>we_n</code> 在 <code>addr</code> 之前变化，这时候就可能导致 SRAM 观察到的地址是不稳定的。</p>
<p>再考虑一个比较实际的 100MHz 主频 SRAM 控制器，按照如下的波形，则是每三个周期进行一次写操作：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5, phase: 4.0},
      { name: "addr", wave: "x3..............5"},
      { name: "data", wave: "x4..............6"},
      { name: "we_n", wave: "1.....0....1....."},
      { name: "oe_n", wave: "x1..............."},
      { name: "ce_n", wave: "x0..............."},
    ]
}</script>
<p>如果觉得这样做太过保守，想要提升性能，有如下几个可能的思路：</p>
<ol>
<li>让 <code>we_n=0</code> 在时钟下降沿输出，但是编写的时候需要比较谨慎，比如先设置一个上升沿触发的寄存器，然后用另一个寄存器在下降沿对这个寄存器进行采样，再输出。</li>
<li>用一个更高频率的时钟驱动 <code>we_n</code> 的寄存器。</li>
<li>用 FPGA 提供的 <code>ODELAY</code> 自定义输出延迟原语，设置一个固定的输出延迟，比如 1ns。</li>
<li>用 <code>ODDR</code> 原语，人为地添加一个大约 0.50ns 的延迟。</li>
<li>对 <code>we_n</code> 设置一个最小的输出延迟（设置了一个很大的 hold），并且不允许输出 <code>we_n</code> 的寄存器放在 IOB 中（否则无法人为增加信号传播的路径长度）。约束：<code>set_output_delay -clock [get_clocks sram_clk] -min -5.00 [get_ports sram_we_n]</code> 和 <code>set_property IOB FALSE [get_cells top/sram_controller/we_n_reg]</code>。这里的信号和寄存器名称需要按照实际情况修改，第二个不允许放置在 IOB 的约束也可以在 Verilog 代码中用 <code>(* IOB = "FALSE" *)</code> 来实现。</li>
</ol>
<p>按照上面的思路实现，下面是可能达到的效果：</p>
<p>单周期：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5, phase: 4.0},
      { name: "addr", wave: "x3....5....7...."},
      { name: "data", wave: "x4....6....8...."},
      { name: "we_n", wave: "1.0...10...10....", phase: 0.8},
      { name: "oe_n", wave: "x1.............."},
      { name: "ce_n", wave: "x0.............."},
    ]
}</script>
<p>双周期：</p>
<script type="WaveDrom">{
  signal:
    [
      { name: "clock", wave: "p...", period: 5.0, phase: 4.0},
      { name: "addr", wave: "x3.........5...."},
      { name: "data", wave: "x4.........6...."},
      { name: "we_n", wave: "1.0....1....0....", phase: 0.8},
      { name: "oe_n", wave: "x1.............."},
      { name: "ce_n", wave: "x0.............."},
    ]
}</script>
<h3 id="pl241-sram"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#pl241-sram">PL241 SRAM 控制器</a></h3>
<p>刚刚我们已经设计好了我们的 SRAM 控制器，再让我们来看看 ARM 提供的 SRAM 控制器时序是怎么样的：ARM 文档提供了 <a href="https://developer.arm.com/documentation/ddi0389/b/functional-overview/smc-functional-operation/memory-interface-operation?lang=en">PrimeCell AHB SRAM/NOR Memory Controller (PL241)</a> 的时序图。</p>
<p>读时序：</p>
<p><img alt="" src="/images/pl241_async_read.svg"/></p>
<p>它第一个周期设置了 <code>ce_n=0</code> 和 <code>addr</code>，等待一个周期后，设置 <code>oe_n=0</code>，再等待两个周期，得到数据。</p>
<p>写时序：</p>
<p><img alt="" src="/images/pl241_async_write.svg"/></p>
<p>它第一个周期设置了 <code>ce_n=0</code> <code>addr</code> 和 <code>data</code>，等待一个周期后，设置 <code>we_n=0</code>，等待两个周期，再设置 <code>we_n=1</code>，这样就完成了写入。这和我们的实现是类似的：等待一个额外的周期，保证满足 <code>we_n</code> 下降时地址已经是稳定的。ARM 的文档里也写了如下的备注：</p>
<div class="language-text highlight"><pre><span></span><code>The timing parameter tWC is controlling the deassertion of smc_we_n_0. You can
use it to vary the hold time of smc_cs_n_0[3:0], smc_add_0[31:0] and
smc_data_out_0[31:0]. This differs from the read case where the timing
parameter tCEOE controls the delay in the assertion of smc_oe_n_0.
Additionally, smc_we_n_0 is always asserted one cycle after smc_cs_n_0[3:0] to
ensure the address bus is valid.
</code></pre></div>
<h3 id="_7"><a class="toclink" href="../../hardware/2022/05/19/async-sram-timing/#_7">参考文档</a></h3>
<ul>
<li><a href="https://www.issi.com/WW/pdf/61WV102416ALL.pdf">1M x 16 HIGH-SPEED ASYNCHRONOUS CMOS STATIC RAM WITH 3.3V SUPPLY</a></li>
<li><a href="https://docs.xilinx.com/v/u/en-US/ds181_Artix_7_Data_Sheet">Artix-7 FPGAs Data Sheet: DC and AC Switching Characteristics</a></li>
<li><a href="https://support.xilinx.com/s/question/0D52E00006iHkeRSAS/timing-constraints-for-an-asynchronous-sram-interface?language=en_US">Timing constraints for an Asynchronous SRAM interface</a></li>
<li><a href="https://support.xilinx.com/s/article/66668?language=en_US">Successfully packing a register into an IOB with Vivado</a></li>
<li><a href="https://support.xilinx.com/s/article/62661?language=en_US">How to verify whether an I/O register is packed into IOB</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0389/b/functional-overview/smc-functional-operation/memory-interface-operation?lang=en">PrimeCell AHB SRAM/NOR Memory Controller (PL241) - Memory interface operation</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/05/19/async-sram-timing/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-05-16 00:00:00">2022年5月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ace"><a class="toclink" href="../../hardware/2022/05/16/ace/">「教学」ACE 缓存一致性协议</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/05/16/ace/#_1">背景</a></h3>
<p>最近几天分析了 TileLink 的缓存一致性协议部分内容，见<a href="../../hardware/2022/05/09/tilelink/">TileLink 总线协议分析</a>，趁此机会研究一下之前尝试过研究，但是因为缺少一些基础知识而弃坑的 ACE 协议分析。</p>
<p>下面主要参考了 IHI0022E 的版本，也就是 AXI4 对应的 ACE 版本。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/05/16/ace/#_2">回顾</a></h3>
<p>首先回顾一下一个缓存一致性协议需要支持哪些操作。对于较上一级 Cache 来说，它需要这么几件事情：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知，也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</li>
<li>需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>如果之前看过我的 TileLink 分析，那么上面的这些操作对应到 TileLink 就是：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（发送 AcquireBlock，等待 GrantData），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（发送 AcquirePerm，等待 Grant），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（发送 ReleaseData，等待 ReleaseAck），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（发送 Release，等待 ReleaseAck），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（收到 Probe），需要返回当前的缓存数据（发送 ProbeAck/ProbeAckData），并且更新状态。</li>
<li>需要一个方法（发送 GrantAck）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<p>秉承着这个思路，再往下看 ACE 的设计，就会觉得很自然了。</p>
<h3 id="cache-state-model"><a class="toclink" href="../../hardware/2022/05/16/ace/#cache-state-model">Cache state model</a></h3>
<p>首先来看一下 ACE 的缓存状态模型，我在之前的<a href="../../hardware/2021/12/17/cache-coherency-protocol/">缓存一致性协议分析</a>中也分析过，它有这么五种，就是 MOESI 的不同说法：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>文档中的定义如下：</p>
<ul>
<li>Valid, Invalid: When valid, the cache line is present in the cache. When invalid, the cache line is not present in the cache.</li>
<li>Unique, Shared: When unique, the cache line exists only in one cache. When shared, the cache line might exist in more than one cache, but this is not guaranteed.</li>
<li>Clean, Dirty: When clean, the cache does not have responsibility for updating main memory. When dirty, the cache line has been modified with respect to main memory, and this cache must ensure that main memory is eventually updated.</li>
</ul>
<p>大致理解的话，Unique 表示只有一个缓存有这个缓存行，Shared 表示有可能有多个缓存有这个缓存行；Clean 表示它不负责更新内存，Dirty 表示它负责更新内存。下面的很多操作都是围绕这些状态进行的。</p>
<p>文档中也说，它支持 MOESI 的不同子集：MESI, ESI, MEI, MOESI，所以也许在一个简化的系统里，一些状态可以不存在，实现会有所不同。</p>
<h3 id="channel-usage-examples"><a class="toclink" href="../../hardware/2022/05/16/ace/#channel-usage-examples">Channel usage examples</a></h3>
<p>到目前为止，我还没有介绍 ACE 的信号，但是我们可以尝试一下，如果我们是协议的设计者，我们要如何添加信号来完成这个事情。</p>
<p>首先考虑上面提到的第一件事情：读或写 miss 的时候，需要请求这个缓存行的数据，并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</p>
<p>我们知道，AXI 有 AR 和 R channel 用于读取数据，那么遇到读或者写 miss 的时候，可以在 AR channel 上捎带一些信息，让下一级的 Interconnect 知道自己的意图是读还是写，然后 Interconnect 就在 R channel 上返回数据。</p>
<p>那么，具体要捎带什么信息呢？我们“不妨”用这样一种命名方式：<code>操作 + 目的状态</code>，比如我读 miss 的时候，需要读取数据，进入 Shared 状态，那就叫 ReadShared；我写 miss 的时候，需要读取数据（通常写入缓存的只是一个缓存行的一部分，所以先要把完整的读进来），那就叫 ReadUnique。这个操作可以编码到一个信号中，传递给 Interconnect。</p>
<p>再来考虑上面提到的第二件事情：写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态，比如从 Shared 到 Modified。</p>
<p>这个操作，需要让 Interconnect 把其他缓存中的这个缓存行数据清空，并且把自己升级到 Unique。根据上面的 <code>操作 + 目的状态</code> 的命名方式，我们可以命名为 CleanUnique，即把其他缓存都 Clean 掉，然后自己变成 Unique。</p>
<p>接下来考虑上面提到的第三件事情：需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回，并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。</p>
<p>按照前面的 <code>操作 + 目的状态</code> 命名法，可以命名为 WriteBackInvalid。ACE 实际采用的命名是 WriteBack。</p>
<p>终于到了第四件事情：收到 snoop 请求的时候，需要返回当前的缓存数据，并且更新状态。</p>
<p>既然 snoop 是从 Interconnect 发给 Master，在已有的 AR R AW W B channel 里没办法做这个事情，不然会打破已有的逻辑。那不得不添加一对 channel，比如我规定一个 AC channel 发送 snoop 请求，规定一个 C channel 让 master 发送响应，这样就可以了。这就相当于 TileLink 里面的 B channel（Probe 请求）和 C channel（ProbeAck 响应）。实际 ACE 和刚才设计的实际有一些区别，把 C channel 拆成了两个：CR 用于返回所有响应，CD 用于返回那些需要数据的响应。这就像 AW 和 W 的关系，一个传地址，一个传数据；类似地，CR 传状态，CD 传数据。</p>
<p>那么，接下来考虑一下 AC channel 上要发送什么请求呢？我们回顾一下上面已经用到的请求类型：需要 snoop 的有 ReadShared，ReadUnique 和 CleanUnique，不需要 snoop 的有 WriteBack。那我们直接通过 AC channel 把 ReadShared，ReadUnique 和 CleanUnique 这三种请求原样发送给需要 snoop 的 cache 那里就可以了。</p>
<p>Cache 在 AC channel 收到这些请求的时候，可以做相应的动作。由于 MOESI 协议下同样的请求可以有不同的响应方法，这里就不细说了。</p>
<p>这时候我们已经基本把 ACE 协议的信号和大题的工作流程推导出来了。哦，我们还忘了第五件事情：需要一个方法来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。TileLink 添加了一个额外的 E channel 来做这个事情，ACE 更加粗暴：直接用一对 RACK 和 WACK 信号来分别表示最后一次读和写已经完成。</p>
<p>关于 WACK 和 RACK 详见 <a href="https://community.arm.com/support-forums/f/soc-design-and-simulation-forum/9888/what-s-the-purpose-for-wack-and-rack-for-ace-and-what-s-the-relationship-with-wvalid-and-rvalid">What's the purpose for WACK and RACK for ACE and what's the relationship with WVALID and RVALID?</a> 的讨论。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/05/16/ace/#_3">总结</a></h3>
<p>到这里就暂时不继续分析了，其他的很多请求类型是服务于更多场景，比如一次写整个 Cache Line 的话，就不需要读取已有的数据了；或者一次性读取完就不管了，或者这是一个不带缓存的加速器，DMA 等，有一些针对性的优化或者简化的处理，比如对于不带缓存的 master，可以简化为 ACE-Lite，比如 ARM 的 CCI-400 支持两个 ACE master 和 三个 ACE-Lite Master，这些 Master 可以用来接 GPU 等外设。再简化一下 ACE-Lite，就得到了 ACP（Accelerator Coherency Port）。</p>
<p>最后我们再把文章开头的五件事对应到 ACE 上，作为一个前后的呼应：</p>
<ol>
<li>读或写 miss 的时候，需要请求这个缓存行的数据（AR 上发送 ReadShared/ReadUnique），并且更新自己的状态，比如读取到 Shared，写入到 Modified 等。</li>
<li>写入一个 valid &amp;&amp; !dirty 的缓存行的时候，需要升级自己的状态（AR 上发送 CleanUnique），比如从 Shared 到 Modified。</li>
<li>需要 evict 一个 valid &amp;&amp; dirty 的缓存行的时候，需要把 dirty 数据写回（AW 上发送 WriteBack），并且降级自己的状态，比如 Modified -&gt; Shared/Invalid。如果需要 evict 一个 valid &amp;&amp; !dirty 的缓存行，可以选择通知（AW 上发送 Evict），也可以选择不通知下一级。</li>
<li>收到 snoop 请求的时候（AC 上收到 snoop 请求），需要返回当前的缓存数据（通过 CR 和 CD），并且更新状态。</li>
<li>需要一个方法（读 RACK 写 WACK）来通知下一级 Cache/Interconnect，告诉它第一和第二步完成了。</li>
</ol>
<h3 id="_4"><a class="toclink" href="../../hardware/2022/05/16/ace/#_4">参考文献</a></h3>
<ul>
<li><a href="https://developer.arm.com/documentation/ihi0022/e/">IHI0022E-AMBA AXI and ACE</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/05/16/ace/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../4/">4</a> <a class="md-pagination__link" href="../5/">5</a> <span class="md-pagination__current">6</span> <a class="md-pagination__link" href="../7/">7</a> <a class="md-pagination__link" href="../8/">8</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
<script>window.addEventListener('load', function() {WaveDrom.ProcessAll();});</script></body>
</html>