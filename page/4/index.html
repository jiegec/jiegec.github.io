
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/4/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-02-03 00:00:00">2023年2月3日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="solaris-114"><a class="toclink" href="../../system/2023/02/03/solaris/">Solaris 11.4 安装</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/02/03/solaris/#_1">下载安装镜像</a></h3>
<p>访问 <a href="https://www.oracle.com/solaris/solaris11/downloads/solaris-downloads.html">https://www.oracle.com/solaris/solaris11/downloads/solaris-downloads.html</a>，点击下载，登录后跳转到一个新的页面。在 Platform 下拉框选择 x86，会出现一系列可以下载的文件。以 11.4.42.111.0 为例，需要下载的是：V1019840-01.iso Oracle Solaris 11.4.42.111.0 Interactive Text Install ISO (x86) for (Oracle Solaris on x86-64 (64-bit)), 890.5 MB。可以直接在浏览器中下载，也可以点击网页中的 WGET Options，用 wget 脚本下载。</p>
<p>下载以后，挂载 ISO 到虚拟机，正常按照指示进行安装</p>
<h3 id="_2"><a class="toclink" href="../../system/2023/02/03/solaris/#_2">配置软件源</a></h3>
<p>Solaris 的在线软件源需要订阅，如果不想订阅，需要下载和 Solaris <strong>版本一致</strong> 的 IPS 仓库。下载的地址和上面一样，需要 7 个 zip 文件，如 V1019847-01_1of7.zip Oracle Solaris 11.4.42.111.0 IPS Repository (SPARC, x86) for (Oracle Solaris on x86-64 (64-bit)), 2.2 GB。建议用 wget 脚本批量下载。</p>
<p>UPDATE: 根据 <a href="https://blogs.oracle.com/solaris/post/building-open-source-software-on-oracle-solaris-114-cbe-release">https://blogs.oracle.com/solaris/post/building-open-source-software-on-oracle-solaris-114-cbe-release</a>，实际上可以不下载 IPS 仓库，而是用在线的仓库，内容和下载的一致：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2023/02/03/solaris/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>set-publisher<span class="w"> </span>-G<span class="w"> </span><span class="s1">'*'</span><span class="w"> </span>-g<span class="w"> </span>http://pkg.oracle.com/solaris/release/<span class="w"> </span>solaris
</span></code></pre></div>
<p>下载好了以后，全部解压到一个目录中，如 <code>/export/home/user/solaris</code>，然后启动本地的软件源服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../system/2023/02/03/solaris/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/inst_root<span class="o">=</span>/export/home/user/solaris
</span><span id="__span-1-2"><a href="../../system/2023/02/03/solaris/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/readonly<span class="o">=</span><span class="nb">true</span>
</span><span id="__span-1-3"><a href="../../system/2023/02/03/solaris/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>sudo<span class="w"> </span>svccfg<span class="w"> </span>-s<span class="w"> </span>application/pkg/server<span class="w"> </span>setprop<span class="w"> </span>pkg/port<span class="o">=</span><span class="m">8081</span>
</span><span id="__span-1-4"><a href="../../system/2023/02/03/solaris/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>sudo<span class="w"> </span>svcadm<span class="w"> </span>refresh<span class="w"> </span>application/pkg/server
</span><span id="__span-1-5"><a href="../../system/2023/02/03/solaris/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>sudo<span class="w"> </span>svcadm<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>application/pkg/server
</span></code></pre></div>
<p>然后配置 <code>pkg</code> 使用本地软件源：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../system/2023/02/03/solaris/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>set-publisher<span class="w"> </span>-G<span class="w"> </span><span class="s1">'*'</span><span class="w"> </span>-g<span class="w"> </span>http://localhost:8081<span class="w"> </span>solaris
</span></code></pre></div>
<p>之后就可以正常使用了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../system/2023/02/03/solaris/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>gcc-11
</span></code></pre></div>
<p>命令参考：<a href="https://www.oracle.com/docs/tech/solaris-11-cheat-sheet.pdf">https://www.oracle.com/docs/tech/solaris-11-cheat-sheet.pdf</a></p>
<nav class="md-post__action">
<a href="../../system/2023/02/03/solaris/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-21 00:00:00">2023年1月21日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/system/">system</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="freebsdnetbsdopenbsddragonflybsd-cookbook"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/">FreeBSD/NetBSD/OpenBSD/DragonFlyBSD Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_1">背景</a></h3>
<p>最近在维护 lsof 的时候，需要在 FreeBSD/NetBSD/OpenBSD/DragonFlyBSD 上进行开发和测试，于是就装了虚拟机，特此记录我在使用过程中，与 Linux 不一样的一些常用 FreeBSD/NetBSD/OpenBSD/DragonFlyBSD 命令。</p>
<h3 id="freebsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#freebsd">FreeBSD</a></h3>
<p>文档参考：<a href="https://docs.freebsd.org/en/books/handbook">https://docs.freebsd.org/en/books/handbook</a></p>
<h4 id="_2"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_2">安装</a></h4>
<p>在 <a href="https://www.freebsd.org/where/">https://www.freebsd.org/where/</a> 找到最新版下载，对于虚拟机的需求，用 <code>-disk1.iso</code>，1 GB 左右。安装过程按照 UI 一步步走即可。</p>
<h4 id="root"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#root">root 权限</a></h4>
<p>FreeBSD 的 su 默认只有 wheel 组可以 su 到 root，所以安装的时候，建议给创建的帐号加上 wheel 组。也可以通过 pw 命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>pw<span class="w"> </span>groupmod<span class="w"> </span>wheel<span class="w"> </span>-m<span class="w"> </span>freebsd
</span></code></pre></div>
<p>sudo 需要通过包管理器安装，用法和 Linux 一样。</p>
<h4 id="_3"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_3">包管理</a></h4>
<p>使用 <code>pkg</code> 命令进行包管理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>pkg<span class="w"> </span>update
</span><span id="__span-1-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>pkg<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span></code></pre></div>
<p><code>-U</code> 表示在 install 的时候不要再 update。</p>
<p>也可以从 Ports 源码编译，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://git.FreeBSD.org/ports.git<span class="w"> </span>/usr/ports
</span><span id="__span-2-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/ports/sysutils/lsof
</span><span id="__span-2-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>make<span class="w"> </span>install
</span></code></pre></div>
<h4 id="_4"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_4">升级</a></h4>
<p>使用 <code>freebsd-update</code> 命令升级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>freebsd-update<span class="w"> </span>fetch
</span><span id="__span-3-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>freebsd-update<span class="w"> </span>install
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_5">网络配置</a></h4>
<p>显示路由表：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>netstat<span class="w"> </span>-nr
</span></code></pre></div>
<p>修改路由：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">## ip route add 1.2.3.0/24 via 4.5.6.7</span>
</span><span id="__span-5-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>route<span class="w"> </span>add<span class="w"> </span>-net<span class="w"> </span><span class="m">1</span>.2.3.0/24<span class="w"> </span><span class="m">4</span>.5.6.7
</span><span id="__span-5-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="c1">## ip route del 1.2.3.0/24</span>
</span><span id="__span-5-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>route<span class="w"> </span>delete<span class="w"> </span>-net<span class="w"> </span><span class="m">1</span>.2.3.0/24
</span></code></pre></div>
<p>网络接口：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">## ip a</span>
</span><span id="__span-6-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>ifconfig
</span><span id="__span-6-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">## ip link set dev abc up</span>
</span><span id="__span-6-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>ifconfig<span class="w"> </span>abc<span class="w"> </span>up
</span><span id="__span-6-5"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="c1">## ip a add 1.2.3.4/24 dev abc</span>
</span><span id="__span-6-6"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>iconfig<span class="w"> </span>abc<span class="w"> </span>inet<span class="w"> </span><span class="m">1</span>.2.3.4/24
</span></code></pre></div>
<p>网路配置在 <code>/etc/rc.conf</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>## DHCP
</span><span id="__span-7-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>ifconfig_xxx="DHCP"
</span><span id="__span-7-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>## Default Gateway
</span><span id="__span-7-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>defaultrouter="1.2.3.4"
</span><span id="__span-7-5"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>## Static IP
</span><span id="__span-7-6"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>ifconfig_xxx="inet 1.2.3.4/24"
</span><span id="__span-7-7"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>## Static route
</span><span id="__span-7-8"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>static_routes="name1 name2"
</span><span id="__span-7-9"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>route_name1="-net 1.2.3.0/24 4.5.6.7"
</span><span id="__span-7-10"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>route_name2="-net 3.2.1.0/24 7.6.5.4"
</span><span id="__span-7-11"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>## Bridge
</span><span id="__span-7-12"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>cloned_interfaces="bridge0"
</span><span id="__span-7-13"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>ifconfig_bridge0="addm net0 addm net1 up"
</span><span id="__span-7-14"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>ifconfig_net0="up"
</span><span id="__span-7-15"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>ifconfig_net1="up"
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_6">换源</a></h4>
<p>USTC <a href="https://mirrors.ustc.edu.cn/help/freebsd-pkg.html">https://mirrors.ustc.edu.cn/help/freebsd-pkg.html</a>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/usr/local/etc/pkg/repos/
</span><span id="__span-8-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'FreeBSD: { url: "pkg+http://mirrors.ustc.edu.cn/freebsd-pkg/${ABI}/quarterly" }'</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">        </span>&gt;<span class="w"> </span>/usr/local/etc/pkg/repos/FreeBSD.conf
</span><span id="__span-8-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>pkg<span class="w"> </span>update
</span></code></pre></div>
<h4 id="truss"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#truss">truss</a></h4>
<p>truss 相当于 Linux 中的 strace。</p>
<h4 id="_7"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_7">编译内核</a></h4>
<p>文档：<a href="https://docs.freebsd.org/en/books/handbook/kernelconfig/">https://docs.freebsd.org/en/books/handbook/kernelconfig/</a></p>
<p>首先下载内核源码，然后创建内核配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nb">cd</span><span class="w"> </span>/path/to/kernel/src
</span><span id="__span-9-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nb">cd</span><span class="w"> </span>sys/amd64/conf
</span><span id="__span-9-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>cp<span class="w"> </span>GENERIC<span class="w"> </span>MYKERNEL
</span></code></pre></div>
<p>编译和安装：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>make<span class="w"> </span>buildkernel<span class="w"> </span><span class="nv">KERNCONF</span><span class="o">=</span>MYKERNEL
</span><span id="__span-10-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>make<span class="w"> </span>installkernel<span class="w"> </span><span class="nv">KERNCONF</span><span class="o">=</span>MYKERNEL
</span></code></pre></div>
<p>提交 patch：<a href="https://wiki.freebsd.org/Phabricator">https://wiki.freebsd.org/Phabricator</a></p>
<h4 id="_8"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_8">关机</a></h4>
<p>FreeBSD 的 shutdown 默认会停留在 halt 的状态，但是不会断电，需要添加 <code>-p</code> 选项。</p>
<h3 id="netbsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#netbsd">NetBSD</a></h3>
<h4 id="_9"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_9">包管理</a></h4>
<p>参考：<a href="https://www.netbsd.org/docs/pkgsrc/using.html">https://www.netbsd.org/docs/pkgsrc/using.html</a></p>
<p>使用 pkgin 做二进制包的包管理，首先安装 pkgin：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/usr/pkg/sbin:/usr/pkg/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
</span><span id="__span-11-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nv">PKG_PATH</span><span class="o">=</span><span class="s2">"https://cdn.NetBSD.org/pub/pkgsrc/packages"</span>
</span><span id="__span-11-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="nv">PKG_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PKG_PATH</span><span class="s2">/NetBSD/amd64/9.3/All/"</span>
</span><span id="__span-11-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="nb">export</span><span class="w"> </span>PATH<span class="w"> </span>PKG_PATH
</span><span id="__span-11-5"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>pkg_add<span class="w"> </span>pkgin
</span></code></pre></div>
<p>包管理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>pkgin<span class="w"> </span>install<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span><span id="__span-12-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>pkgin<span class="w"> </span>upgrade
</span></code></pre></div>
<p>和 FreeBSD 一样，NetBSD 的 su 默认只有 wheel 组可以 su 到 root，建议在安装创建新用户的时候就把自己的帐号加入到 wheel 组中。sudo 使用之前需要 visudo 修改配置。</p>
<p>也可以从源码 pkgsrc 进行编译，在 /usr/pkgsrc 路径下，编译好的程序会安装到 /usr/pkg/bin。</p>
<p>克隆并初始化 pkgsrc：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nb">cd</span><span class="w"> </span>/usr<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cvs<span class="w"> </span>-q<span class="w"> </span>-z2<span class="w"> </span>-d<span class="w"> </span>anoncvs@anoncvs.NetBSD.org:/cvsroot<span class="w"> </span>checkout<span class="w"> </span>-P<span class="w"> </span>pkgsrc
</span><span id="__span-13-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/pkgsrc/bootstrap
</span><span id="__span-13-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>./bootstrap
</span></code></pre></div>
<p>编译 pkgsrc 中的软件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nb">cd</span><span class="w"> </span>/usr/pkgsrc/sysutils/lsof
</span><span id="__span-14-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>make
</span></code></pre></div>
<h4 id="_10"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_10">网络配置</a></h4>
<p>网络配置的命令和 FreeBSD 基本一样：</p>
<ul>
<li><code>netstat -nr</code>：查看路由表</li>
<li><code>route</code>：修改路由表</li>
<li><code>ifconfig</code>：配置网络接口</li>
</ul>
<p>但是 <code>/etc/rc.conf</code> 的配置语法不同，见 <code>man rc.conf</code> 和 <a href="https://www.netbsd.org/docs/network/#configuration_files">https://www.netbsd.org/docs/network/#configuration_files</a>。</p>
<h4 id="_11"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_11">升级</a></h4>
<p>参考 <a href="https://www.netbsd.org/docs/guide/en/chap-upgrading.html">https://www.netbsd.org/docs/guide/en/chap-upgrading.html</a></p>
<p>使用 sysupgrade 命令升级：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>pkgin install sysupgrade
</span><span id="__span-15-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>sysupgrade auto https://cdn.NetBSD.org/pub/NetBSD/NetBSD-9.3/amd64
</span></code></pre></div>
<h4 id="_12"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_12">安装内核源码</a></h4>
<p>内核源码可以从 <a href="https://mirrors.tuna.tsinghua.edu.cn/NetBSD/NetBSD-9.3/source/sets/">https://mirrors.tuna.tsinghua.edu.cn/NetBSD/NetBSD-9.3/source/sets/</a> 下载。对于 lsof 只需要其中的 syssrc.tgz。</p>
<p>解压：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>tar<span class="w"> </span>-xzf<span class="w"> </span>syssrc.tgz<span class="w"> </span>-C<span class="w"> </span>/
</span></code></pre></div>
<h3 id="openbsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#openbsd">OpenBSD</a></h3>
<h4 id="_13"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_13">安装</a></h4>
<p>文档：<a href="https://www.openbsd.org/faq/faq4.html">https://www.openbsd.org/faq/faq4.html</a></p>
<p>下载 <a href="https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/amd64/install72.iso">https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/amd64/install72.iso</a>，然后按照 UI 提示进行安装。使用 virt-manager 安装 OpenBSD 虚拟机的时候，在安装界面会遇到无法输入的问题，可以创建一个 USB Keyboard 来解决。</p>
<h4 id="_14"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_14">包管理</a></h4>
<p>文档：<a href="https://www.openbsdhandbook.com/package_management/">https://www.openbsdhandbook.com/package_management/</a></p>
<p>常用命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">## Use TUNA Mirrors</span>
</span><span id="__span-17-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/"</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/installurl
</span><span id="__span-17-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="c1">## Search</span>
</span><span id="__span-17-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>pkg_info<span class="w"> </span>-Q<span class="w"> </span>fish
</span><span id="__span-17-5"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="c1">## Install</span>
</span><span id="__span-17-6"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>pkg_add<span class="w"> </span>sudo<span class="w"> </span>fish<span class="w"> </span>vim
</span><span id="__span-17-7"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="c1">## Update packages</span>
</span><span id="__span-17-8"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>pkg_add<span class="w"> </span>-u
</span></code></pre></div>
<p>另一个方法是从源码编译，首先下载 ports：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>wget<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/ports.tar.gz
</span><span id="__span-18-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nb">cd</span><span class="w"> </span>/usr/src
</span><span id="__span-18-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>tar<span class="w"> </span>xzf<span class="w"> </span>/path/to/ports.tar.gz
</span></code></pre></div>
<h4 id="_15"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_15">系统升级</a></h4>
<p>参考：<a href="https://www.openbsdhandbook.com/system_management/updates/">https://www.openbsdhandbook.com/system_management/updates/</a></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>syspatch<span class="w"> </span>-c
</span><span id="__span-19-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>syspatch
</span></code></pre></div>
<h4 id="autotools"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#autotools">autotools</a></h4>
<p>OpenBSD 允许存在多个版本的 autoconf/automake，所以在运行的时候需要用环境变量指定版本，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AUTOCONF_VERSION</span><span class="o">=</span><span class="m">2</span>.71
</span><span id="__span-20-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AUTOMAKE_VERSION</span><span class="o">=</span><span class="m">1</span>.16
</span></code></pre></div>
<h4 id="_16"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_16">获取内核源码</a></h4>
<p>文档：<a href="https://www.openbsd.org/faq/faq5.html">https://www.openbsd.org/faq/faq5.html</a></p>
<p>命令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">## Add exampleuser to group wsrc</span>
</span><span id="__span-21-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>user<span class="w"> </span>mod<span class="w"> </span>-G<span class="w"> </span>wsrc<span class="w"> </span>exampleuser
</span><span id="__span-21-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="c1">## Download and extract</span>
</span><span id="__span-21-4"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a>wget<span class="w"> </span>https://mirrors.tuna.tsinghua.edu.cn/OpenBSD/7.2/sys.tar.gz
</span><span id="__span-21-5"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="nb">cd</span><span class="w"> </span>/usr/src
</span><span id="__span-21-6"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a>tar<span class="w"> </span>xzf<span class="w"> </span>/path/to/sys.tar.gz
</span></code></pre></div>
<h4 id="ktrace"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#ktrace">ktrace</a></h4>
<p>ktrace 相当于 Linux 中的 strace。结果会保存在文件中，用 kdump 命令显示。</p>
<h3 id="dragonflybsd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#dragonflybsd">DragonFlyBSD</a></h3>
<h4 id="_17"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_17">安装</a></h4>
<p>下载 ISO 文件：<a href="https://mirror-master.dragonflybsd.org/iso-images/dfly-x86_64-6.4.0_REL.iso">https://mirror-master.dragonflybsd.org/iso-images/dfly-x86_64-6.4.0_REL.iso</a></p>
<p>用 installer 用户登录开始安装。</p>
<h4 id="_18"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_18">用户管理</a></h4>
<p>和 FreeBSD 一样，su 需要 wheel 组，所以需要手动添加用户到 wheel 组中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>pw<span class="w"> </span>groupmod<span class="w"> </span>wheel<span class="w"> </span>-m<span class="w"> </span>username
</span></code></pre></div>
<h4 id="sshd"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#sshd">SSHD</a></h4>
<p>DragonFlyBSD 默认 sshd 配置不允许密码登录，如果要允许，需要修改 <code>/etc/ssh/sshd_config</code>，然后重启 ssh：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>/etc/rc.d/sshd<span class="w"> </span>restart
</span></code></pre></div>
<h4 id="_19"><a class="toclink" href="../../system/2023/01/21/bsd-cookbook/#_19">包管理</a></h4>
<p>DragonFlyBSD 可以下载二进制包：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>pkg<span class="w"> </span>update
</span><span id="__span-24-2"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>pkg<span class="w"> </span>upgrade
</span><span id="__span-24-3"><a href="../../system/2023/01/21/bsd-cookbook/#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a>pkg<span class="w"> </span>install<span class="w"> </span>sudo<span class="w"> </span>vim<span class="w"> </span>fish
</span></code></pre></div>
<p>也可以从源码编译，见 <a href="https://www.dragonflybsd.org/docs/howtos/HowToDPorts/">https://www.dragonflybsd.org/docs/howtos/HowToDPorts/</a></p>
<nav class="md-post__action">
<a href="../../system/2023/01/21/bsd-cookbook/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-13 00:00:00">2023年1月13日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="freebsd-code-server"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/">在 FreeBSD 上运行 code-server</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/#_1">背景</a></h3>
<p>最近在 FreeBSD 上移植开源软件，但是因为 vscode 官方不支持 FreeBSD，所以尝试使用 code-server</p>
<h3 id="_2"><a class="toclink" href="../../software/2023/01/13/vscode-server-on-freebsd/#_2">使用</a></h3>
<p>首先按照官方文档安装 code-server：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://code-server.dev/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
</span></code></pre></div>
<p>启动 code-server：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>code-server<span class="w"> </span>--bind-addr<span class="w"> </span><span class="m">0</span>.0.0.0:8080
</span></code></pre></div>
<p>但是很快你会发现，运行日志中会报告很多错误，缺少了一些包：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>sudo<span class="w"> </span>npm<span class="w"> </span>i<span class="w"> </span>-g<span class="w"> </span>yazl<span class="w"> </span>yauzl<span class="w"> </span>@microsoft/1ds-core-js<span class="w"> </span>vscode-regexpp<span class="w"> </span>xterm-headless<span class="w"> </span>vscode-proxy-agent<span class="w"> </span>--unsafe-perm
</span></code></pre></div>
<p>到这里就能在网页里看到 UI 了，但是发现很多功能都不工作。例如搜索的时候，会告诉你找不到 rg，是因为 ripgrep 没有提供 FreeBSD 的 prebuilt binary，但是可以用 pkg 安装：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>sudo pkg install ripgrep
</span><span id="__span-3-2"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>cd /usr/local/lib/node_modules/@vscode/ripgrep/bin &amp;&amp; ln -s /usr/local/bin/rg
</span><span id="__span-3-3"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>cd /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@vscode/ripgrep/bin &amp;&amp; ln -s /usr/local/bin/rg
</span></code></pre></div>
<p>然后，日志中会显示 @parcel/watcher 启动失败，显示 Undefined symbol，这是因为这个库没有做 FreeBSD 支持。需要使用 https://github.com/parcel-bundler/watcher/pull/128 版本，编译出 watcher.node 文件，替换：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>cd watcher
</span><span id="__span-4-2"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>npm install
</span><span id="__span-4-3"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/@parcel/watcher/build/Release/
</span><span id="__span-4-4"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@parcel/watcher/build/Release/watcher.node
</span></code></pre></div>
<p>这样就解决了 watcher 的问题。</p>
<p>最后一个问题是无法打开 Terminal，因为在 VSCode 代码中，检测到不支持的 Platform 的时候，会抛出异常：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>[IPC Library: Pty Host] The factory function of "vs/platform/terminal/node/ptyHostMain" has thrown an exception
</span><span id="__span-5-2"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>[IPC Library: Pty Host] Error: Platform not supported
</span></code></pre></div>
<p>可以修改源码：<code>sudo vim /usr/local/lib/node_modules/code-server/lib/vscode/out/vs/platform/terminal/node/ptyHostMain.js</code> 把这个检查改掉，例如替换 linux 为 freebsd，当成 linux 来检测。</p>
<p>接下来的问题和 https://github.com/coder/code-server/issues/5760 一致，安装依赖，重新 <code>npm install</code>：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>sudo pkg install libsecret pkgconf
</span><span id="__span-6-2"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>cd /usr/local/lib/node_modules/code-server
</span><span id="__span-6-3"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>sudo npm install --unsafe-perm
</span><span id="__span-6-4"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>## go back to @parcel/watcher
</span><span id="__span-6-5"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>cd watcher
</span><span id="__span-6-6"><a href="../../software/2023/01/13/vscode-server-on-freebsd/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>sudo cp build/Release/watcher.node /usr/local/lib/node_modules/code-server/lib/vscode/node_modules/@parcel/watcher/build/Release
</span></code></pre></div>
<p>完成这些步骤以后，Terminal 也正常了。</p>
<nav class="md-post__action">
<a href="../../software/2023/01/13/vscode-server-on-freebsd/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-12 00:00:00">2023年1月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="chi"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/">CHI 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/cache_coherence_protocol.html">知识库</a>中。</p>
<h3 id="chi_1"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#chi_1">CHI 介绍</a></h3>
<p>CHI 协议是 AMBA 5 标准中的缓存一致性协议，前身是 ACE 协议。最新的 CHI 标准可以从 <a href="https://developer.arm.com/documentation/ihi0050/latest">AMBA 5 CHI Architecture Specification</a> 处下载。</p>
<p>相比 AXI，CHI 更加复杂，进行了分层：协议层，物理层和链路层。因此，CHI 适用于片上网络，支持根据 Node ID 进行路由，而不像 AXI 那样只按照物理地址进行路由。CHI 的地位就相当于 Intel 的环形总线。CHI 也可以桥接到 CCIX 上，用 CCIX 连接 SMP 的的多个 Socket，或者连接支持 CCIX 的显卡等等。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_1">缓存行状态</a></h3>
<p>首先回顾 ACE 的缓存行状态，共有五种，与 MOESI 相对应：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>在此基础上，CHI 考虑缓存行只有部分字节有效的情况，即 Full，Partial 或者 Empty。因此 CHI 的缓存行状态共有七种：</p>
<ol>
<li>UniqueDirty: Modified</li>
<li>UniqueDirtyPartial: 新增，可能有部分字节合法，在写回的时候，需要和下一级缓存或者内存中的合法缓存行内容进行合并</li>
<li>SharedDirty: Owned</li>
<li>UniqueClean: Exclusive</li>
<li>UniqueCleanEmpty: 新增，所有字节都不合法，但是本缓存占有该缓存行，如果要修改的话，不需要通知其他缓存</li>
<li>SharedClean: Shared</li>
<li>Invalid: Invalid</li>
</ol>
<p>可以看到，比较特别的就是 UniqueDirtyPartial 和 UniqueCleanEmpty。CHI 标准在 4.1.1 章节给出了使用场景：如果一个 CPU 即将要写入一片内存，那么可以先转换到 UniqueCleanEmpty 状态中，把其他缓存中的数据都清空，这样后续写入的时候，不需要询问其他缓存，性能比较好。但此时因为数据还没写进去，所以就是 Empty，只更新状态，不占用缓存的空间。另一方面，如果 CPU 只写了缓存行的一部分字节，其他部分没有碰，那么引入 UniqueDirtyPartial 以后，可以把合并新旧缓存行数据这一步，下放到比较靠近内存的层级上，减少了数据搬运的次数。</p>
<h3 id="chi_2"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#chi_2">CHI 网络节点</a></h3>
<p>CHI 的节点组织成一个网络，可能是片上网络，也可能是片间的连接。CHI 的节点分成三种类型：</p>
<ol>
<li>Request Node：发起 CHI 请求的节点，对应 CPU 的缓存，或者是网卡等外设</li>
<li>Home Node：管理 Request Node 来的请求，对应最后一级缓存</li>
<li>Subordinate Node：处理 Home Node 来的请求，对应内存或者显存等有内存的外设</li>
</ol>
<p>在这种设计下，Node 之间可以互相通信，因此方便做一些新的优化。例如传统的缓存层次里，请求是一级一级下去，响应再一级一级上来。但是 CHI 可能是 Request Node 发给 Home Node 的请求，响应直接由 Subordinate Node 发送回 Request Node 了。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_2">读请求</a></h3>
<p>CHI 提供了复杂性的同时，也带来了很多的灵活性，也意味着潜在的性能优化的可能。例如在 CHI 中实现一个读操作，可能有很多种过程（CHI 标准第 2.3.1 章节）：</p>
<p>第一种是 Home Node 直接提供了数据（Combined response from home）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: CompData
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第二种是 Home Node 把响应拆成两份，一份表示读取结果，一份携带读取的数据（Separate data and response from Home）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: RespSepData
    Home-&gt;&gt;Requester: DataSepResp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第三种是 Home Node 没有数据，转而询问 Subordinate，Subordinate 把结果直接发回给了 Requester（Combined response from Subordinate）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Subordinate: ReadNoSnp
    Subordinate-&gt;&gt;Requester: CompData
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第四种是 Home Node 没有数据，转而询问 Subordinate，但这次提前告诉 Requester 读取的结果，最后 Subordinate 把结果发回给了 Requester（Response from Home, Data from Subordinate）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Requester: RespSepData
    Home-&gt;&gt;Subordinate: ReadNoSnpSep
    Subordinate-&gt;&gt;Home: ReadReceipt
    Subordinate-&gt;&gt;Requester: DataSepResp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第五种是数据在其他的 Requester Node 中，此时 Home 负责 Snoop（Forwarding snoop）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Snoopee
    Requester-&gt;&gt;Home: Read*
    Home-&gt;&gt;Snoopee: Snp*Fwd
    Snoopee-&gt;&gt;Requester: CompData
    Snoopee-&gt;&gt;Home: SnpRespFwded
    Requester-&gt;&gt;Home: CompAck</code></pre>
<p>第六种是 MakeReadUnique，此时只更新权限，不涉及数据的传输（MakeReadUnique only）：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: MakeReadUnique
    Home-&gt;&gt;Requester: Comp
    Requester-&gt;&gt;Home: CompAck</code></pre>
<h3 id="_3"><a class="toclink" href="../../hardware/2023/01/12/chi-notes/#_3">写请求</a></h3>
<p>CHI 标准第 2.3.2 描述了写请求的流程。和读请求一样，写请求也有很多类型，下面进行介绍。与读请求不同的点在于，写入的时候，并不是直接把写入的地址和数据等一次性发送过去，而是先发一个写消息，对方回复可以发送数据了（DBIDResp），再把实际的数据传输过去（NCBWrData）。当然了，也可以中途反悔（WriteDataCancel）。</p>
<p>第一种是 Direct Write-data Transfer，意思是数据要从 Requester 直接传到 Subordinate 上：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    participant Subordinate
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Subordinate: Write*
    Subordinate-&gt;&gt;Requester: DBIDResp
    Requester-&gt;&gt;Subordinate: NCBWrData/WriteDataCancel
    Subordinate-&gt;&gt;Home: Comp
    Home-&gt;&gt;Requester: Comp</code></pre>
<p>第二种比较常规，就是把数据写给 Home Node，其中 Comp 表示读取结果，DBIDResp 表示可以发写入的内容了：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Requester: DBIDResp/DBIDRespOrd
    Home-&gt;&gt;Requester: Comp
    Requester-&gt;&gt;Home: NCBWrData/WriteDataCancel</code></pre>
<p>第三种是把第二种的 DBIDResp 和 Comp 合并成一个响应：</p>
<pre class="mermaid"><code>sequenceDiagram
    participant Requester
    participant Home
    Requester-&gt;&gt;Home: Write*
    Home-&gt;&gt;Requester: CompDBIDResp
    Requester-&gt;&gt;Home: NCBWrData/WriteDataCancel</code></pre>
<nav class="md-post__action">
<a href="../../hardware/2023/01/12/chi-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-11 00:00:00">2023年1月11日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="intel"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/">Intel 处理器</a></h2>
<h3 id="xeon"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#xeon">Xeon 系列</a></h3>
<p><a href="https://www.intel.com/content/www/us/en/support/articles/000059657/processors/intel-xeon-processors.html">命名方式</a>：</p>
<ul>
<li>第一位数字：8-9 对应 Platinum，5-6 对应 Gold，4 对应 Silver，3 对应 Bronze</li>
<li>第二位数字：对应代次，1 对应 1st Generation，2 对应 2nd Generation，依此类推</li>
<li>第三位第四位数字：一般越大性能越好</li>
<li>后缀：H/L/M/N/P/Q/S/T/U/V/Y/Y+/+</li>
<li>L：大内存</li>
<li>M：媒体/大内存</li>
<li>N：网络</li>
<li>P：虚拟化，IaaS</li>
<li>Q: 水冷</li>
<li>S：存储/搜索</li>
<li>T：长寿命</li>
<li>U：单插槽</li>
<li>V：虚拟化，SaaS</li>
<li>Y: Speed Select</li>
</ul>
<h4 id="4th-generation-intel-xeon-scalable-processorsxeon-cpu-max-series"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#4th-generation-intel-xeon-scalable-processorsxeon-cpu-max-series">4th Generation Intel® Xeon® Scalable Processors/Xeon CPU Max Series</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/228622/4th-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/232643/intel-xeon-cpu-max-series.html">Xeon CPU Max 型号列表</a></li>
<li>发布时间：Q1'23</li>
<li>代号：Sapphire Rapids/Sapphire Rapids HBM</li>
<li>用途：Server</li>
<li>旗舰：Xeon CPU Max 9480(56C112T，112.5 MB L3，HBM)/Xeon Platinum 8490H(60C120T，Golden Cove，112.5 MB L3)/Xeon Platinum 8480+(56C112T，105 MB L3)</li>
</ul>
<h4 id="3rd-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#3rd-generation-intel-xeon-scalable-processors">3rd Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/204098/3rd-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q2'21(Ice Lake), Q2'20(Cooper Lake)</li>
<li>代号：Cooper Lake/Ice Lake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 8380(40C80T，Sunny Cove，60 MB L3)</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/16594/intel-3rd-gen-xeon-scalable-review">Ice Lake</a></li>
</ul>
<h4 id="2nd-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#2nd-generation-intel-xeon-scalable-processors">2nd Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/192283/2nd-generation-intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q1'20, Q2'19</li>
<li>代号：Cascade Lake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 9282(56C112T)，Xeon Platinum 8280(28C56T，38.5 MB L3)</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/14146/intel-xeon-scalable-cascade-lake-deep-dive-now-with-optane">Cascade Lake</a></li>
</ul>
<h4 id="1st-generation-intel-xeon-scalable-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#1st-generation-intel-xeon-scalable-processors">1st Generation Intel® Xeon® Scalable Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/125191/intel-xeon-scalable-processors.html">CPU 型号列表</a></li>
<li>发布时间：Q2'18, Q3'17</li>
<li>代号：Skylake</li>
<li>用途：Server</li>
<li>旗舰：Xeon Platinum 8180(28C56T)</li>
</ul>
<h3 id="core"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#core">Core 系列</a></h3>
<p><a href="https://www.intel.com/content/www/us/en/processors/processor-numbers.html">命名方式</a></p>
<ul>
<li>i3/i5/i7/i9：数字越大越高端</li>
<li>万位 + 千位：对应代次，13 对应 13 代</li>
<li>百位 + 十位 + 千位：型号，一般越大越高端</li>
<li>后缀：F/H/HK/HX/K/P/U/X/XE/Y</li>
<li>F：桌面，无核显</li>
<li>H：笔记本，高性能</li>
<li>HK：笔记本，高性能，可超频</li>
<li>HX：笔记本，高高性能，可超频</li>
<li>K：桌面，高性能，可超频</li>
<li>P：笔记本，轻薄本</li>
<li>S：桌面，特别版</li>
<li>U：笔记本，节能</li>
<li>X/XE：桌面，高高性能，可超频</li>
<li>Y：特别节能</li>
</ul>
<h4 id="13th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#13th-generation-intel-coretm-processors">13th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/230485/13th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230486/13th-generation-intel-core-i7-processors.html">i7 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230487/13th-generation-intel-core-i5-processors.html">i5 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/230488/13th-generation-intel-core-i3-processors.html">i3 CPU 型号列表</a></li>
<li>发布时间：Q1'23，Q4'22</li>
<li>代号：Raptor Lake，大小核</li>
<li>用途：桌面，笔记本</li>
<li>旗舰：i9-13900K（8+16C32T）/i9-13900KF</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/17601/intel-core-i9-13900k-and-i5-13600k-review">Intel Core i9-13900K and i5-13600K Review: Raptor Lake Brings More Bite</a></li>
</ul>
<h4 id="12th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#12th-generation-intel-coretm-processors">12th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/217839/12th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a></li>
<li>发布时间：Q1'22，Q4'21</li>
<li>代号：Alder Lake，大小核</li>
<li>旗舰：i9-12900KS（8+8C24T）</li>
<li>相关阅读：<a href="https://www.anandtech.com/show/17479/the-intel-core-i9-12900ks-review-the-best-of-intel-s-alder-lake-and-the-hottest">The Intel Core i9-12900KS Review: The Best of Intel's Alder Lake, and the Hottest</a></li>
</ul>
<h4 id="11th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#11th-generation-intel-coretm-processors">11th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/202984/11th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a></li>
<li>发布时间：Q2'21，Q1'21</li>
<li>代号：Rocket Lake</li>
<li>旗舰：i9-11900K（8C16T）</li>
</ul>
<h4 id="10th-generation-intel-coretm-processors"><a class="toclink" href="../../hardware/2023/01/11/intel-cpu/#10th-generation-intel-coretm-processors">10th Generation Intel® Core™ Processors</a></h4>
<ul>
<li><a href="https://ark.intel.com/content/www/us/en/ark/products/series/195735/10th-generation-intel-core-i9-processors.html">i9 CPU 型号列表</a> <a href="https://ark.intel.com/content/www/us/en/ark/products/series/123588/intel-core-x-series-processors.html">Intel® Core™ X-series Processors</a></li>
<li>发布时间：Q3'20，Q2'20，Q4'19</li>
<li>代号：Comet Lake</li>
<li>旗舰：i9-10900K（10C20T，Comet Lake）；特别地，在 X-series 系列中还有 i9-10980XE（18C36T，Cascade Lake）</li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2023/01/11/intel-cpu/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-09 00:00:00">2023年1月9日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="amd"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/">AMD 处理器</a></h2>
<h3 id="ryzen"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen">Ryzen 系列</a></h3>
<h4 id="ryzen-5000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-5000">Ryzen 5000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Vermeer</td>
<td>桌面</td>
<td>无</td>
<td>AM4</td>
<td>Zen 3</td>
<td>5950X/5900(X)/5800(X(3D))/5700X/5600(X)</td>
</tr>
<tr>
<td>Chagall</td>
<td>工作站</td>
<td>无</td>
<td>sWRX8</td>
<td>Zen 3</td>
<td>5995WX/5975WX/5965WX/5955WX/5945WX</td>
</tr>
<tr>
<td>Cezanne</td>
<td>桌面</td>
<td>GCN5</td>
<td>AM4</td>
<td>Zen 3</td>
<td>5750G/5700G(E)/5650G/5600G(E)/5500/5300G(E)</td>
</tr>
<tr>
<td>Cezanne</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>5980HX/5980HS/5900HX/5900HS/5800H(S)/5800U/5600H(S)/5600U/5560U/5400U</td>
</tr>
<tr>
<td>Barceló</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>5825U/5825C/5625U/5625C/5425U/5425C/5125C</td>
</tr>
<tr>
<td>Lucienne</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 2</td>
<td>5700U/5500U/5300U</td>
</tr>
</tbody>
</table>
<p>注：Ryzen 5 5500 虽然代号是 Cezanne，但是去掉了核显。</p>
<h4 id="ryzen-6000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-6000">Ryzen 6000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rembrandt</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FP7</td>
<td>Zen 3+</td>
<td>6980HX/6980HS/6900HX/6900HS/6800H(S)/6800U/6600H(S)/6600U</td>
</tr>
</tbody>
</table>
<h4 id="ryzen-7000"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#ryzen-7000">Ryzen 7000</a></h4>
<table>
<thead>
<tr>
<th>代号</th>
<th>用途</th>
<th>核显</th>
<th>插槽</th>
<th>微架构</th>
<th>型号</th>
</tr>
</thead>
<tbody>
<tr>
<td>Raphael</td>
<td>桌面</td>
<td>RDNA2</td>
<td>AM5</td>
<td>Zen 4</td>
<td>7950X(3D)/7900(X(3D))/7800X3D/7700(X)/7600(X)</td>
</tr>
<tr>
<td>Dragon Range</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FL1</td>
<td>Zen 4</td>
<td>7945HX/7845HX/7745HX/7645HX</td>
</tr>
<tr>
<td>Phoenix</td>
<td>笔记本</td>
<td>RDNA3</td>
<td>FP7/FP7r2/FP8</td>
<td>Zen 4</td>
<td>7940H(S)/7840H(S)/7840U/7640H(S)/7640U/7540U/7440U</td>
</tr>
<tr>
<td>Rembrandt R</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FP7/FP7r2</td>
<td>Zen 3+</td>
<td>7735HS/7736U/7735U/7535HS/7535U/7335U</td>
</tr>
<tr>
<td>Barcelo R</td>
<td>笔记本</td>
<td>GCN5</td>
<td>FP6</td>
<td>Zen 3</td>
<td>7730U/7530U/7330U</td>
</tr>
<tr>
<td>Mendocino</td>
<td>笔记本</td>
<td>RDNA2</td>
<td>FT6</td>
<td>Zen 2</td>
<td>7520U/7320U</td>
</tr>
</tbody>
</table>
<p>AMD 笔记本处理器产品从 2023 年到 2025 年采用新的<a href="https://www.anandtech.com/show/18718/amd-2023-ryzen-mobile-7000-cpus-unveiled-zen-4-phoenix-takes-point">命名方式</a>：</p>
<ul>
<li>数字第一位：7 对应 2023，8 对应 2024，9 对应 2025，约等于 Intel 的代次</li>
<li>数字第二位：1 对应 Athlon Silver，2 对应 Athlon Gold，3-4 对应 Ryzen 3，5-6 对应 Ryzen 5，7-8 对应 Ryzen 7，8-9 对应 Ryzen 9，类似 Intel 的 i3/i5/i7/i9</li>
<li>数字第三位：1 对应 Zen/Zen+，2 对应 Zen 2，依次类推</li>
<li>数字第四位：0 表示低端，5 表示高端</li>
<li>后缀：性能从高到低 HX，HS，U/C</li>
</ul>
<p>因此代号和编号有直接的对应关系：</p>
<ul>
<li>Dragon Range: 7045, Extreme Gaming and Creator</li>
<li>Phoenix: 7040, Elite Ultrathin</li>
<li>Rembrandt R: 7035, Premium Thin &amp; Light</li>
<li>Bracelo R: 7030, Mainstream Thin &amp; Light</li>
<li>Mendocino: 7020, Everyday Computing</li>
</ul>
<h4 id="_1"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#_1">参考资料</a></h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/List_of_AMD_Ryzen_processors">List of AMD Ryzen processors</a></li>
<li>Vermeer: <a href="https://www.anandtech.com/show/16214/amd-zen-3-ryzen-deep-dive-review-5950x-5900x-5800x-and-5700x-tested">AMD Zen 3 Ryzen Deep Dive Review: 5950X, 5900X, 5800X and 5600X Tested</a></li>
<li>Chagall: <a href="https://www.anandtech.com/show/17296/amd-announces-ryzen-threadripper-pro-5000-wx-series-zen-3-core-for-oem-workstations">AMD Announces Ryzen Threadripper Pro 5000 WX-Series: Zen 3 For OEM Workstations</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16405/amd-launches-ryzen-5000-mobile-zen-3-and-cezanne-for-notebooks">AMD Launches Ryzen 5000 Mobile: Zen 3 and Cezanne for Notebooks</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16446/amd-ryzen-9-5980hs-cezanne-review-ryzen-5000-mobile-tested">AMD Ryzen 9 5980HS Cezanne Review: Ryzen 5000 Mobile Tested</a></li>
<li>Cezanne: <a href="https://www.anandtech.com/show/16824/amd-ryzen-7-5700g-and-ryzen-5-5600g-apu-review">The AMD Ryzen 7 5700G, Ryzen 5 5600G, and Ryzen 3 5300G Review</a></li>
<li>Barcelo: <a href="https://www.anandtech.com/show/17190/amds-barcelo-zen-3-apu-refresh-for-2022">AMD’s Barcelo: Zen 3 APU Refresh for 2022</a></li>
<li>Barcelo: <a href="https://www.anandtech.com/show/17373/amd-announces-ryzen-5000-cseries-for-highend-chromebooks">AMD Announces Ryzen 5000 C-Series For High-End Chromebooks</a></li>
<li>Lucienne: <a href="https://www.anandtech.com/show/16451/amds-ryzen-5000-lucienne-not-simply-rebranded-ryzen-4000-renoir-">AMD's Ryzen 5000 Lucienne: Not Simply Rebranded Ryzen 4000 Renoir</a></li>
<li>Rembrandt: <a href="https://www.anandtech.com/show/17276/amd-ryzen-9-6900hs-rembrandt-benchmark-zen3-plus-scaling">AMD's Ryzen 9 6900HS Rembrandt Benchmarked: Zen3+ Power and Performance Scaling</a></li>
<li>Raphael: <a href="https://www.anandtech.com/show/17585/amd-zen-4-ryzen-9-7950x-and-ryzen-5-7600x-review-retaking-the-high-end">AMD Zen 4 Ryzen 9 7950X and Ryzen 5 7600X Review: Retaking The High-End</a></li>
<li>Mendocino: <a href="https://www.anandtech.com/show/17584/amd-launches-mendocino-apus-zen-2-ryzen-and-athlon-7020-series-with-rdna-2-graphics">AMD Launches Mendocino APUs: Zen 2-based Ryzen and Athlon 7020 Series with RDNA 2 Graphics</a></li>
<li>Barcelo R: <a href="https://www.notebookcheck.net/Barcelo-R-Ryzen-5-7530U-brings-Zen-3-into-the-mix-for-the-messy-AMD-Ryzen-7000-mobile-APU-lineup.662046.0.html">Barcelo-R Ryzen 5 7530U brings Zen 3 into the mix for the messy AMD Ryzen 7000 mobile APU lineup</a></li>
<li>Dragon Range: <a href="https://www.anandtech.com/show/18716/amd-announces-ryzen-7045-hx-series-cpus-for-laptops-up-to-16-cores-and-5-4-ghz">AMD Announces Ryzen Mobile 7045 HX-Series CPUs, Up to 16-Cores and 5.4 GHz for Laptops</a></li>
<li>Phoenix/Rembrandt R: <a href="https://www.anandtech.com/show/18718/amd-2023-ryzen-mobile-7000-cpus-unveiled-zen-4-phoenix-takes-point">AMD Lays Out 2023 Ryzen Mobile 7000 CPUs: Top-to-Bottom Updates, New Zen 4 'Phoenix' CPU Takes Point</a></li>
</ul>
<h3 id="epyc"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#epyc">EPYC 系列</a></h3>
<table>
<thead>
<tr>
<th>代号</th>
<th>编号</th>
<th>最大核心数</th>
<th>微架构</th>
<th>插槽</th>
</tr>
</thead>
<tbody>
<tr>
<td>Naples</td>
<td>7001</td>
<td>32</td>
<td>Zen 1</td>
<td>SP3</td>
</tr>
<tr>
<td>Rome</td>
<td>7002</td>
<td>64</td>
<td>Zen 2</td>
<td>SP3</td>
</tr>
<tr>
<td>Milan</td>
<td>7003</td>
<td>64</td>
<td>Zen 3</td>
<td>SP3</td>
</tr>
<tr>
<td>Milan-X</td>
<td>7003</td>
<td>64</td>
<td>Zen 3</td>
<td>SP3</td>
</tr>
<tr>
<td>Genoa</td>
<td>9004</td>
<td>96</td>
<td>Zen 4</td>
<td>SP5</td>
</tr>
<tr>
<td>Bergamo</td>
<td>?</td>
<td>128</td>
<td>Zen 4c</td>
<td>SP5</td>
</tr>
</tbody>
</table>
<h4 id="_2"><a class="toclink" href="../../hardware/2023/01/09/amd-cpu/#_2">参考资料</a></h4>
<ul>
<li><a href="https://www.anandtech.com/show/17055/amd-gives-details-on-epyc-zen4-genoa-and-bergamo-up-to-96-and-128-cores">AMD Gives Details on EPYC Zen4: Genoa and Bergamo, up to 96 and 128 Cores</a></li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2023/01/09/amd-cpu/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-01-05 00:00:00">2023年1月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="pcie-bifurcation"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/">PCIe Bifurcation</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_1">背景</a></h3>
<p>最近看到两篇关于 PCIe Bifurcation 的文章：</p>
<ul>
<li><a href="https://www.bilibili.com/read/cv15596863">intel 部分桌面级 CPU 的 pcie 通道拆分另类低成本实现</a></li>
<li><a href="https://www.bilibili.com/read/cv16530665">Intel Alder Lake 12 代酷睿 CPU PCIe 拆分实现方法</a></li>
</ul>
<p>文章讲的是如何在 CPU 上进行跳线，从而实现 PCIe Bifurcation 的配置。正好借此机会来研究一下 PCIe Bifurcation。</p>
<h3 id="pcie-bifurcation_1"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#pcie-bifurcation_1">PCIe Bifurcation</a></h3>
<p>PCIe Bifurcation 的目的是让 PCIe 有更好的灵活性。从 CPU 出来的几路 PCIe，它的宽度一般是确定的，比如有一个 x16，但是实际使用的时候，想要接多个设备，例如把 x16 当成两个 x8 来用，这就是 PCIe Bifurcation。这需要 PCIe 两端的支持，CPU 端需要可配置 PCIe Bifurcation，不然只能从一个 x16 降级到一个 x8，剩下的 8x 就没法利用了；设备端需要拆分卡，把 x16 的信号分成两路，然后提供两个 PCIe 插槽以及使用 Clock Buffer 来提供下游设备的时钟，有时则是主板设计时就做了拆分，不需要额外的拆分卡。</p>
<p>那么怎么配置 CPU 端的 PCIe Bifurcation 呢？其实就是上面两篇文章提到的办法：CPU 根据 CFG 信号来决定 PCIe Bifurcation 配置，例如要选择 1x16，2x8 还是 1x8+2x4 等等。简单总结一下实现思路都是：</p>
<ol>
<li>根据 CPU 型号（如 i7-12700K）找到 datasheet，如 <a href="https://cdrdv2.intel.com/v1/dl/getContent/655258">12th Generation Intel Core Processors Datasheet Volume 1</a></li>
<li>寻找 datasheet 中关于 PCIe Bifurcation 的配置，找到 CFG 信号的取值</li>
<li>找到 CPU 的引脚定义图（如 LGA1700），找到 CFG 引脚，然后找到附近的地或者电源</li>
<li>连接跳线</li>
</ol>
<p>具体细节这里就不赘述了，可以查看上面的两篇文章。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_2">可配置性</a></h3>
<p>这时候就有一个疑问了，如果 PCIe Bifurcation 配置是通过引脚输入的，一般电路是固定的，那是不是就不可以动态配置了？</p>
<h4 id="_3"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_3">桌面平台</a></h4>
<p>实际找一个主板来研究一下。型号是 ASRock Fatal1ty Z97X Killer，从主板的描述中，可以看到：<code>3 x PCI Express 3.0 x16 Slots (PCIE2/PCIE4/PCIE6: single at x16 (PCIE2); dual at x8 (PCIE2) / x8 (PCIE4); triple at x8 (PCIE2) / x4 (PCIE4) / x4 (PCIE6)</code>，说明它是支持 PCIe Bifurcation 的，涉及到三个 PCIe Slot，支持三种模式：</p>
<ul>
<li>PCIE2 Slot x16</li>
<li>PCIE2 Slot x8, PCIE4 Slot x8</li>
<li>PCIE2 Slot x8, PCIE4 Slot x4, PCIE6 Slot x4</li>
</ul>
<p>在 <a href="https://schematic-x.blogspot.com/2018/04/asus-pack-198-files.html">网上</a> 找到该主板的 <a href="https://drive.google.com/file/d/1j9tUFJ7n60OLIoboVuPIWZA9cNJtwsCt/view">原理图</a>，可以用 <a href="https://github.com/OpenBoardView/OpenBoardView">OpenBoardView</a> 软件打开。这个主板上的 CPU 插槽是 LGA1150，找到一个兼容的 CPU 版本 i7-4771，下载 <a href="https://cdrdv2.intel.com/v1/dl/getcontent/328897">Datasheet</a>，可以看到决定 PCIe Bifurcation 的引脚是 <code>CFG[6:5]</code>：</p>
<ul>
<li><code>CFG[6:5]=00</code>: 1x8, 2x4</li>
<li><code>CFG[6:5]=10</code>: 2x8</li>
<li><code>CFG[6:5]=11</code>: 1x16</li>
</ul>
<p>可以看到，这三种配置和主板网站上描述的是一致的。既然主板支持 Bifurcation，说明一定有办法设置 <code>CFG[6:5]</code> 为以上三种取值。</p>
<p>接下来，要找到主板上怎么连接 <code>CFG[6:5]</code>。在原理图中，可以找到 LGA1150 的 <code>U39 CPU_CFG5</code> 和 <code>U40 V_CFG6</code>，继续往下找，可以看到它们通过电阻连到了同一个 <a href="https://www.vishay.com/docs/85508/bat54.pdf">BAT54C</a> 芯片上，所以只需要看 BAT54C 第三个引脚 N105955695 的电平。N105955695 接到了一个 <a href="https://assets.nexperia.com/documents/data-sheet/2N7002BKS.pdf">2N7002BKS</a> 芯片上，根据电路图，最后是要看 <code>X4_PRSNT1#</code> 信号。</p>
<p><code>X4_PRSTN1#</code> 信号连接到了 PCIE6 上，如果 PCIE6 Slot 插入了设备，那么 <code>X4_PRSTN1#</code> 信号生效，根据分析出来的电路，它会使得 <code>CFG[6:0]</code> 变为 00，对应 1x8+2x4 的 Bifurcation 模式。回想一下，在主板支持的三种 PCIe Bifurcation 模式下，只有这一种涉及到了 PCIE6 Slot。所以如果用户在 PCIE6 Slot 插入了设备，那说明用户需要的是 1x8+2x4 的模式，自动配置 CPU 的 <code>CFG[6:5]</code> 信号为预期值。</p>
<p>另一方面，设置 <code>CFG[6:5]</code> 还不够，上面提到过，主板需要负责把 PCIE2/4/6 的信号连接到原来的完整的 x16 上，并且根据实际情况连接不同的线。具体的实现方式也可以在原理图中找到：信号 <code>X4_PRSTN1#</code> 连接到了 <a href="https://www.nxp.com.cn/docs/en/data-sheet/CBTL04083A_CBTL04083B.pdf">CBTL04083BBS</a>，这是一个 PCIe Mux/Demux 芯片，也就是把同样一组差分线连到不同 PCIe Slot 上所需要的芯片。</p>
<p>于是目前推断出了一部分的工作原理：用户在 PCIE6 Slot 插入设备，电路计算出 <code>CFG[6:5]=00</code>，同时配置好了 PCIe Mux/Demux 芯片，把 1x16 切分为 1x8+2x4。</p>
<p>继续往下看，主板如何实现剩下两种配置：<code>CFG[6:5]=10</code> 对应 2x8，<code>CFG[6:5]=11</code> 对应 1x16。这两种编码里，CFG6 都为 1，只需要考虑如何处理 CFG5。CFG5 除了连接上面提到的 BAT54C 以外，还通过另一个 2N7002BKS 芯片连接到了 <code>NB_X8_PRSENT#</code> 信号上。如果你想明白了前面的过程，应该可以推断出来，这里的 <code>NB_X8_PRSENT#</code> 连接到了 PCIE4 Slot 上。当 PCIE4 Slot 插入了设备，同时 PCIE6 Slot 没有插入设备，那么根据相应的 PRESENT 信号，可以得到 <code>CFG[6:5]=10</code>。如果 PCIE4 Slot 和 PCIE6 Slot 都没有插入设备，那就 <code>CFG[6:5]=11</code>。</p>
<p>总结一下，动态检测并计算出 <code>CFG[6:5]</code> 的逻辑：</p>
<ol>
<li>如果 PCIE6 Slot 插入了设备，说明要配置为 1x8+2x4，设置 <code>CFG[6:5]=00</code></li>
<li>否则，如果 PCIE4 Slot 插入了设备，说明要配置为 2x8，设置 <code>CFG[6:5]=10</code></li>
<li>否则，说明要配置为 1x16，设置 <code>CFG[6:5]=11</code></li>
</ol>
<p>而主板设计者就是要把这个逻辑转化为电路，用 BAT54C 和 CBTL04083BBS 芯片来实现逻辑运算。</p>
<p>顺便一提，这里的 PCIE2/4/6 物理尺寸都是 x16，只不过实际分配到的宽度不一定与物理尺寸一致。</p>
<h4 id="_4"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_4">服务器平台</a></h4>
<p>在服务器平台上，Intel CPU 的 Bifurcation 变成运行时可配置的，例如在 <a href="https://cdrdv2-public.intel.com/333810/xeon-e5-v4-datasheet-vol-2.pdf">Xeon E5 v4 Datasheet Volume 2</a> 中，可以找到寄存器 <code>pcie_iou_bif_ctrl</code> 寄存器的定义：</p>
<p><img alt="" src="/images/pcie_bifurcation.png"/></p>
<p>这个寄存器在 PCIe 配置空间中，可以通过 <code>setpci</code> 命令来读取或写入：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:00.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-2"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="m">00</span>
</span><span id="__span-0-3"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:01.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-4"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="m">01</span><span class="w"> </span><span class="c1"># x8</span>
</span><span id="__span-0-5"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:02.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-6"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="m">04</span><span class="w"> </span><span class="c1"># x16</span>
</span><span id="__span-0-7"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">00</span>:03.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-8"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="m">03</span><span class="w"> </span><span class="c1"># x8x8</span>
</span><span id="__span-0-9"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>$<span class="w"> </span>setpci<span class="w"> </span>-s<span class="w"> </span><span class="m">80</span>:02.0<span class="w"> </span><span class="m">190</span>.B
</span><span id="__span-0-10"><a href="../../hardware/2023/01/05/pcie-bifurcation/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="m">04</span><span class="w"> </span><span class="c1"># x16</span>
</span></code></pre></div>
<p>通过 <code>lspci -bPP</code> 命令以及 <code>lspci -vvv</code>，可以看到在这几个 PCIe Root Port 下的设备以及速度：</p>
<ul>
<li>00:01.0(x8)/02:00.0 RAID 控制器 PCIe 3.0 x8</li>
<li>00:02.0(x16)/03:00.0 NVIDIA 显卡 PCIe 3.0 x16</li>
<li>00:03.0(x8x8)/01:00.0 BCM 2x10G+2x1G 网卡 PCIe 2.0 x8</li>
<li>80:02.0(x16)/82:00.0 NVIDIA 显卡 PCIe 3.0 x16</li>
</ul>
<p>其中前三个设备连接到 CPU1，后三个设备连接到 CPU2</p>
<p>在 BIOS 设置中，进入 Integrated Devices -&gt; Slot Bifurcation 可以看到设置，可选项有：</p>
<ul>
<li>Slot 1/2/3/5: Default Bifurcation, x4+x4 Bifurcation</li>
<li>Slot 4/6: Default Bifurcation, x4+x4+x4+x4 Bifurcation, x8+x8 Bifurcation</li>
</ul>
<p>阅读 R730 文档，可以发现它最多可以有 7 个 Slot，其中 Slot 1/2/3/5/7 是 PCIe 3.0x8，Slot 4 是 PCIe 3.0 x16，Slot 6 根据不同的 Riser 可以提供 PCIe 3.0 x8 或 x16，对应关系如下：</p>
<ul>
<li>PCIe Slot 1: x8, CPU2</li>
<li>PCIe Slot 2: x8, CPU2</li>
<li>PCIe Slot 3: x8, CPU2</li>
<li>PCIe Slot 4: x16, CPU2</li>
<li>PCIe Slot 5: x8, CPU1</li>
<li>PCIe Slot 6: x8/x16, CPU1</li>
<li>PCIe Slot 7: x8, CPU1</li>
</ul>
<p>阅读 E5 v4 CPU 文档，可以发现它有三个 PCIe Port，一共有 40 PCIe lanes（x8+x16+x16）。由此可知，其中一个 x16 连接到 Slot4/6 上，另一个 x16 拆分成 x8+x8，连接到其余的 Slot。有些奇怪的是 CPU1 少了一个 x8 不知去向，怀疑是连接到了 RAID 卡或者网卡上。缺少主板的原理图，无法继续深入研究。</p>
<p>遗憾的是，这个寄存器的 <code>iou_start_bifurcation</code> 字段只能写入一次 1 来初始化 Bifurcation，而这一般是由 BIOS 完成的。如果 BIOS 没有做，或许可以后面再写入一次；如果 BIOS 已经写入了，但是没有提供可选项，那么可以考虑逆向 BIOS，使用 UEFITool 查看是否有隐藏的配置，如果有，则可以尝试绕过 BIOS 设置去修改隐藏的配置，如果没有，可以考虑修改 BIOS 的指令。</p>
<h3 id="_5"><a class="toclink" href="../../hardware/2023/01/05/pcie-bifurcation/#_5">总结</a></h3>
<p>简单总结一下，PCIe Bifurcation 的目的是保证总 lane 数不变的情况下，连接更多设备的较低成本的方法。它需要 CPU 一侧和设备一侧的支持。桌面级别的 CPU 通过 CFG 信号来配置，服务器端的 CPU 通过 PCIe 配置空间来配置。设备一侧，可以由主板进行拆分，此时主板上会有多余的 PCIe 接口，根据插在主板上的设备的情况，主板自适应出一个 PCIe Bifurcation 配置；主板也可以什么都不做，直接把 CPU 的 PCIe 接到 Slot 上，此时需要用户自己购买 PCIe 拆分卡。淘宝上可以搜到不少 <a href="https://www.taobao.com/list/product/pcie%E6%8B%86%E5%88%86%E5%8D%A1.htm">PCIe 拆分卡</a>，其中用于 NVMe 的较多，毕竟 M.2 接口面积小，而且只需要 PCIe x4。</p>
<p>另一种方案是 PCIe 交换机（如 <a href="https://docs.broadcom.com/doc/12351854">PEX 8747</a>），缺点是成本较高，增加了延迟，好处是灵活性很强，不需要 CPU 额外配置，可以外接更多设备，并且设备空闲时可以让出带宽。例如一个 x16 使用 Bifurcation 方法可以拆成两个 x8，也可以使用 PCIe 交换机连接两个 x16，类似网络，这两个 x16 共享带宽，下游的两个设备之间也可以直接通信，这个在 HPC 场景下会比较常见，例如使用 PCIe 交换机连接显卡和 IB 网卡。</p>
<nav class="md-post__action">
<a href="../../hardware/2023/01/05/pcie-bifurcation/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-12-10 00:00:00">2022年12月10日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 34 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="acpi"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/">ACPI 学习笔记</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_1">标准</a></h3>
<p>ACPI 标准可以从<a href="https://uefi.org/specifications">官网</a>下载。</p>
<p>ACPI 的表现形式为一颗树加若干个表，表的结构比较规整，里面每个字段都有固定的含义。树的结点可能是属性，或者是一些函数。操作系统可以操作上面的属性，调用 ACPI 中的函数，来进行一些硬件相关的操作。ACPI 一般与主板密切相关，主板厂家配置好 ACPI 后，操作系统就不需要给每个主板都写一遍代码了。</p>
<h3 id="asl"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#asl">ASL</a></h3>
<p>为了开发 ACPI，需要使用 ACPI Source Language(ASL) 来进行编程，使用 iasl 编译成 ACPI 表以后，由操作系统进行解释执行。推荐阅读一个比较好的 ASL 教程：<a href="https://acpica.org/sites/acpica/files/asl_tutorial_v20190625.pdf">ACPI Source Language (ASL) Tutorial</a>。</p>
<p>简单来说，ASL 中的变量类型：</p>
<ul>
<li>Integer: <code>int32_t/int64_t</code></li>
<li>String: <code>char *</code></li>
<li>Buffer: <code>uint8_t []</code></li>
<li>Package: <code>object []</code></li>
<li>Object Reference: <code>object &amp;</code></li>
<li>Method</li>
</ul>
<p>ACPI 需要访问硬件，一般是通过 MMIO 或者 IO Port 来进行访问。在内核开发的时候，MMIO 一般是用一系列 volatile 指针来对应硬件的寄存器定义。ASL 中也可以做类似的事情，分为两步：<code>OperationRegion</code> 和 <code>Field</code>。</p>
<p><code>OperationRegion</code> 就是声明了一片地址空间，以及对应的类型，常见的类型有 SystemMemory、SystemIO、PCI_Config、SMBus 等等。当 ACPI 中的代码要访问 <code>OperationRegion</code> 中的数据的时候，内核按照类型去进行实际的访问。</p>
<p>有了地址空间以后，还需要根据寄存器的定义，给各个字段起个名字，这就是 <code>Field</code>。<code>Field</code> 给 <code>OperationRegion</code> 中的字段起名，与硬件的定义想对应，这就像在内核中定义一个结构体，保证结构体的成员的偏移和硬件是一致的。这样就可以通过成员来访问，而不是每次都去计算一次偏移。</p>
<h3 id="acpi_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_1">获取当前系统的 ACPI 表</a></h3>
<p>使用以下命令获取 ACPI 表并转换为可以阅读的格式：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>acpidump<span class="w"> </span>-o<span class="w"> </span>acpi.raw
</span><span id="__span-0-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>acpixtract<span class="w"> </span>-a<span class="w"> </span>acpi.raw
</span><span id="__span-0-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>iasl<span class="w"> </span>-d<span class="w"> </span>*.dat
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_2">串口</a></h3>
<h4 id="x86_64"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#x86_64">x86_64</a></h4>
<p>下面来看一个具体的例子，主板 <code>WS X299 PRO/SE</code> 的 ACPI 表中记录的串口信息：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// UART 1</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">UAR1</span><span class="p">)</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="p">{</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0501"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* 16550A-compatible COM Serial Port */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_UID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _UID: Unique ID</span>
</span><span id="__span-1-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">LDN</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span>
</span><span id="__span-1-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-1-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DSTA</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">))</span><span class="w"> </span><span class="c1">// Device Status</span>
</span><span id="__span-1-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>
</span><span id="__span-1-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_DIS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _DIS: Disable Device</span>
</span><span id="__span-1-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DCNT</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Control</span>
</span><span id="__span-1-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-1-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DCRS</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">))</span>
</span><span id="__span-1-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
</span><span id="__span-1-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_SRS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _SRS: Set Resource Settings</span>
</span><span id="__span-1-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">        </span><span class="o">^^</span><span class="n">SIO1</span><span class="p">.</span><span class="n">DSRS</span><span class="w"> </span><span class="p">(</span><span class="n">Arg0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-1-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>
</span><span id="__span-1-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_PRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _PRS: Possible Resource Settings</span>
</span><span id="__span-1-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-1-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="n">StartDependentFn</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-1-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-44"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-45"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-46"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">                </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-47"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-48"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-49"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-50"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-51"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-52"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-53"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-54"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-55"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-56"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-57"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-58"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">                </span><span class="mh">0x02F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-59"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">                </span><span class="mh">0x02F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-60"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-61"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-62"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-63"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-64"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">                </span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
</span><span id="__span-1-65"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-66"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-67"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-68"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-69"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-70"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-71"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a><span class="w">                </span><span class="mh">0x03E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-72"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">                </span><span class="mh">0x03E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-73"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-74"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-75"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-76"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-77"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="w">                </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-1-78"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-79"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-80"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-81"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">        </span><span class="n">StartDependentFnNoPri</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-82"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-1-83"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="w">            </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-1-84"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="w">                </span><span class="mh">0x02E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-1-85"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">                </span><span class="mh">0x02E8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-1-86"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="w">                </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-1-87"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">                </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-1-88"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">                </span><span class="p">)</span>
</span><span id="__span-1-89"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="w">            </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-90"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="w">                </span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
</span><span id="__span-1-91"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="w">            </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-1-92"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">                </span><span class="p">{}</span>
</span><span id="__span-1-93"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-94"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a><span class="w">        </span><span class="n">EndDependentFn</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-1-95"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-1-96"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个设备在 Linux 中的路径是 <code>/sys/devices/LNXSYSTM:00/LNXSYBUS:00/PNP0A08:00/device:86/PNP0501:00</code>，进一步可以发现，它的 <code>path</code> 是 <code>\_SB_.PC00.LPC0.UAR1</code>，与 DSDT 中的路径一致。进一步探索，可以发现它匹配到了 Linux 的 <code>serial</code> 驱动，并且最终对应到了 <code>/dev/ttyS0</code> 设备。还可以看到 Linux 生成的 <code>resources</code> 描述：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>state = active
</span><span id="__span-2-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>io 0x3f8-0x3ff
</span><span id="__span-2-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>irq 4
</span><span id="__span-2-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>dma disabled
</span></code></pre></div>
<p>这和上面看到的是一致的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="mh">0x03F8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-3-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-3-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-3-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="p">)</span>
</span></code></pre></div>
<p>这里表达的正是 <code>0x3F8-0x3FF</code> 这一段 IO Port。这个地址和 <a href="https://wiki.osdev.org/Serial_Ports#Port_Addresses">OSDev</a> 上看到的也是吻合的。</p>
<p>进一步分析代码，<code>_STA</code> 函数返回设备当前的状态。可以在 Linux 的 ACPI 结点路径下看 <code>status</code> 文件，其内容是 <code>15</code>，表示工作正常。实现中，它调用了 <code>^^SIO1.DSTA(0x00)</code>，这里的 <code>^</code> 表示上一级命名空间。进一步找到 <code>DSTA</code> 的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Device Status</span>
</span><span id="__span-4-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">DSTA</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-4-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">{</span>
</span><span id="__span-4-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="c1">// Enter Configuration Mode</span>
</span><span id="__span-4-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">ENFG</span><span class="w"> </span><span class="p">(</span><span class="n">CGLD</span><span class="w"> </span><span class="p">(</span><span class="n">Arg0</span><span class="p">))</span>
</span><span id="__span-4-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">Local0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ACTR</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SIO1.ACTR */</span>
</span><span id="__span-4-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="c1">// Exit Configuration Mode</span>
</span><span id="__span-4-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">EXFG</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-4-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Local0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">))</span>
</span><span id="__span-4-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
</span><span id="__span-4-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">Local0</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-4-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-4-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">        </span><span class="c1">// IO State</span>
</span><span id="__span-4-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">        </span><span class="n">IOST</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">Local0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Arg0</span><span class="p">)</span>
</span><span id="__span-4-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>
</span><span id="__span-4-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">Local0</span><span class="p">)</span>
</span><span id="__span-4-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-4-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">    </span><span class="n">ElseIf</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-4-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(((</span><span class="mh">0x01</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Arg0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IOST</span><span class="p">))</span>
</span><span id="__span-4-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-4-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0D</span><span class="p">)</span>
</span><span id="__span-4-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-4-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-4-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">    </span><span class="n">Else</span>
</span><span id="__span-4-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-4-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-4-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，核心是要判断 <code>ACTR</code> 的取值，继续寻找，可以发现 <code>ACTR</code> 是一个 SuperIO 的寄存器：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">// Super IO</span>
</span><span id="__span-5-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">SP1O</span><span class="p">,</span><span class="w"> </span><span class="mh">0x2E</span><span class="p">)</span>
</span><span id="__span-5-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
</span><span id="__span-5-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">IOID</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="n">SP1O</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">)</span>
</span><span id="__span-5-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">IOID</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-5-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">{</span>
</span><span id="__span-5-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="n">INDX</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-5-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="n">DATA</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span>
</span><span id="__span-5-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</span><span id="__span-5-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>
</span><span id="__span-5-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="n">IndexField</span><span class="w"> </span><span class="p">(</span><span class="n">INDX</span><span class="p">,</span><span class="w"> </span><span class="n">DATA</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-5-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="p">{</span>
</span><span id="__span-5-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-5-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="n">Offset</span><span class="w"> </span><span class="p">(</span><span class="mh">0x30</span><span class="p">),</span><span class="w"> </span>
</span><span id="__span-5-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="n">ACTR</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span><span class="p">,</span><span class="w">  </span><span class="c1">// Activate Register</span>
</span><span id="__span-5-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>ACTR</code> 寄存器需要通过 0x2E/0x2F 这两个 IO Port 来访问，所以这里使用了 <code>IndexField</code>，例如要读取 <code>ACTR</code> 的当前值的话，首先要往 <code>0x2E</code> 处写入 <code>ACTR</code> 的偏移，再从 <code>0x2F</code> 处读出当前值。这些寄存器应该就属于 SuperIO 了。</p>
<p>其他的几个函数含义是，<code>_CRS</code> 返回当前的资源配置，<code>_SRS</code> 可以修改资源配置，<code>_PRS</code> 列出可能的资源配置，<code>_DIS</code> 禁用设备。</p>
<p>从 Linux 内核日志，可以发现这款主板用的是 NCT6796D 兼容的 SuperIO 芯片：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>nct6775: Found NCT6796D or compatible chip at 0x2e:0x290
</span></code></pre></div>
<p>查询 <a href="https://www.nuvoton.com/resource-files/NCT6796D_Datasheet_V0_6.pdf">NCT6796D Datasheet</a>，可以发现：</p>
<ul>
<li>芯片通过 LPC 总线与 CPU 连接，支持多种外设接口，包括 UART，PS/2，红外，GPIO，SMBus 等等</li>
<li>偏移 0x30 的寄存器 <code>ACTR</code> 的最低位表示了 logical device 的当前状态。</li>
<li>读取 <code>ACTR</code> 之前需要设置 LDN(Logical Device Number) 为 2，2 对应 Serial Port 1(UARTA)。这一步是在 <code>ENFG(CGLD(Arg0))</code> 中完成的。</li>
<li><code>CGLD</code> 函数查询了 <code>DCAT</code>，可以发现，串口在 <code>DCAT</code> 的下标是 0，查表得到的是 2，也就是 Logial Device Number 为 2，和上面的发现是吻合的。<code>DCAT</code> 的下一项是 <code>0x3</code>，也就是 Logical Device Number 为 3，在 Datasheet 中可以看到是 Serial Port 2(UARTB)。</li>
<li>DSDT 中还可以找到 <code>PS2K</code> 的结点，就是 PS/2 键鼠，属性中标记了 <code>LDN=5</code>，和 Datasheet 也是一致的。</li>
</ul>
<h4 id="arm64"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#arm64">ARM64</a></h4>
<p>前面看过了 x86_64 平台的串口，是需要通过 IO Port 进行访问的。在 ARM 平台上，则一般是通过 MMIO 访问。搜索内核日志，可以发现内核从 SPCR(Serial Port Console Redirection table) 表获取得到串口的信息：</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="err">ACPI: SPCR: console: uart,mmio,0x3f00002f8,115200</span>
</span></code></pre></div>
<p>SPCR 表的内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>[024h 0036   1]               Interface Type : 00
</span><span id="__span-8-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>[025h 0037   3]                     Reserved : 000000
</span><span id="__span-8-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>
</span><span id="__span-8-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>[028h 0040  12]         Serial Port Register : [Generic Address Structure]
</span><span id="__span-8-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>[028h 0040   1]                     Space ID : 00 [SystemMemory]
</span><span id="__span-8-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>[029h 0041   1]                    Bit Width : 08
</span><span id="__span-8-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>[02Ah 0042   1]                   Bit Offset : 00
</span><span id="__span-8-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>[02Bh 0043   1]         Encoded Access Width : 01 [Byte Access:8]
</span><span id="__span-8-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>[02Ch 0044   8]                      Address : 00000003F00002F8
</span><span id="__span-8-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>
</span><span id="__span-8-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>[034h 0052   1]               Interrupt Type : 08
</span><span id="__span-8-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>[035h 0053   1]          PCAT-compatible IRQ : 00
</span><span id="__span-8-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>[036h 0054   4]                    Interrupt : 000001E4
</span><span id="__span-8-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>[03Ah 0058   1]                    Baud Rate : 07
</span><span id="__span-8-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>[03Bh 0059   1]                       Parity : 00
</span><span id="__span-8-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>[03Ch 0060   1]                    Stop Bits : 01
</span><span id="__span-8-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>[03Dh 0061   1]                 Flow Control : 00
</span><span id="__span-8-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>[03Eh 0062   1]                Terminal Type : 03
</span></code></pre></div>
<p>SPCR 表的定义可以在 <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/serports/serial-port-console-redirection-table">Serial Port Console Redirection Table (SPCR)</a> 处看到：</p>
<ul>
<li>Interface Type(00): Full 16550 interface</li>
<li>Interrupt Type(08): ARMH GIC interrupt (Global System Interrupt)</li>
<li>Baud Rate(07): 115200</li>
<li>Terminal Type(03): ANSI</li>
</ul>
<p>和内核得到的信息是一致的。内核中解析 SPCR 表的函数是 <code>acpi_sparse_spcr</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">acpi_parse_spcr</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_earlycon</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable_console</span><span class="p">)</span>
</span><span id="__span-9-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="p">{</span>
</span><span id="__span-9-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-9-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">space_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ACPI_ADR_SPACE_SYSTEM_MEMORY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ACPI_ACCESS_BIT_WIDTH</span><span class="p">((</span><span class="n">bit_width</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span>
</span><span id="__span-9-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">            </span><span class="n">iotype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mmio"</span><span class="p">;</span>
</span><span id="__span-9-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-9-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>
</span><span id="__span-9-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">interface_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">ACPI_DBG2_16550_COMPATIBLE</span><span class="p">:</span>
</span><span id="__span-9-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">        </span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"uart"</span><span class="p">;</span>
</span><span id="__span-9-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>
</span><span id="__span-9-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">        </span><span class="c1">// omitted</span>
</span><span id="__span-9-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span>
</span><span id="__span-9-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">        </span><span class="n">baud_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">115200</span><span class="p">;</span>
</span><span id="__span-9-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-9-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>
</span><span id="__span-9-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">baud_rate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span><span class="w"> </span><span class="s">"%s,%s,0x%llx"</span><span class="p">,</span><span class="w"> </span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">iotype</span><span class="p">,</span>
</span><span id="__span-9-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">             </span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
</span><span id="__span-9-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="c1">// uart,mmio,0x3f00002f8,115200</span>
</span><span id="__span-9-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span><span class="w"> </span><span class="s">"%s,%s,0x%llx,%d"</span><span class="p">,</span><span class="w"> </span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">iotype</span><span class="p">,</span>
</span><span id="__span-9-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">             </span><span class="n">table</span><span class="o">-&gt;</span><span class="n">serial_port</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">baud_rate</span><span class="p">);</span>
</span><span id="__span-9-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a>
</span><span id="__span-9-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-9-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-9-37" id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="ipmi"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#ipmi">IPMI</a></h3>
<h4 id="x86_65"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#x86_65">x86_64</a></h4>
<p>接下来，再来看 ACPI 中是如何声明 IPMI 的。主板依然是 <code>WS X299 PRO/SE</code>，主板自带了 BMC，可以在 DSDT 中搜到相关的部分：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">IDTP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0CA2</span><span class="p">)</span>
</span><span id="__span-10-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">ICDP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0CA3</span><span class="p">)</span>
</span><span id="__span-10-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">SRVV</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0200</span><span class="p">)</span>
</span><span id="__span-10-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>
</span><span id="__span-10-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">SPMI</span><span class="p">)</span>
</span><span id="__span-10-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="p">{</span>
</span><span id="__span-10-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"IPI0001"</span><span class="p">))</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-10-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_STR</span><span class="p">,</span><span class="w"> </span><span class="n">Unicode</span><span class="w"> </span><span class="p">(</span><span class="s">"IPMI_KCS"</span><span class="p">))</span><span class="w">  </span><span class="c1">// _STR: Description String</span>
</span><span id="__span-10-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_UID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _UID: Unique ID</span>
</span><span id="__span-10-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="c1">// IPMI Status</span>
</span><span id="__span-10-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">IPST</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="n">ICDP</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span>
</span><span id="__span-10-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">IPST</span><span class="p">,</span><span class="w"> </span><span class="n">ByteAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">Preserve</span><span class="p">)</span>
</span><span id="__span-10-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">        </span><span class="n">STAS</span><span class="p">,</span><span class="w">   </span><span class="mi">8</span>
</span><span id="__span-10-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>
</span><span id="__span-10-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-10-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">        </span><span class="n">Local0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STAS</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SPMI.STAS */</span>
</span><span id="__span-10-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Local0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">))</span>
</span><span id="__span-10-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-10-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-10-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-10-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a>
</span><span id="__span-10-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-10-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-10-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-10-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-10-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-10-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-10-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">            </span><span class="n">_Y1E</span><span class="p">)</span>
</span><span id="__span-10-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-10-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-10-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-10-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-10-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-10-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="w">            </span><span class="n">_Y1F</span><span class="p">)</span>
</span><span id="__span-10-44"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-10-45"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-10-46"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-47"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">IDTP</span><span class="p">)</span>
</span><span id="__span-10-48"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-49"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_MIN</span><span class="p">,</span><span class="w"> </span><span class="n">IPDB</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MIN: Minimum Base Address</span>
</span><span id="__span-10-50"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">IPDH</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MAX: Maximum Base Address</span>
</span><span id="__span-10-51"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">            </span><span class="n">CreateByteField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1E</span><span class="p">.</span><span class="n">_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">IPDL</span><span class="p">)</span><span class="w">  </span><span class="c1">// _LEN: Length</span>
</span><span id="__span-10-52"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="w">            </span><span class="n">IPDB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDTP</span><span class="w"> </span><span class="cm">/* \IDTP */</span>
</span><span id="__span-10-53"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">            </span><span class="n">IPDH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDTP</span><span class="w"> </span><span class="cm">/* \IDTP */</span>
</span><span id="__span-10-54"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="w">            </span><span class="n">IPDL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-10-55"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-56"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a>
</span><span id="__span-10-57"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">ICDP</span><span class="p">)</span>
</span><span id="__span-10-58"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-10-59"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_MIN</span><span class="p">,</span><span class="w"> </span><span class="n">IPCB</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MIN: Minimum Base Address</span>
</span><span id="__span-10-60"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="w">            </span><span class="n">CreateWordField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_MAX</span><span class="p">,</span><span class="w"> </span><span class="n">IPCH</span><span class="p">)</span><span class="w">  </span><span class="c1">// _MAX: Maximum Base Address</span>
</span><span id="__span-10-61"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a><span class="w">            </span><span class="n">CreateByteField</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">,</span><span class="w"> </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PC00</span><span class="p">.</span><span class="n">LPC0</span><span class="p">.</span><span class="n">SPMI</span><span class="p">.</span><span class="n">_Y1F</span><span class="p">.</span><span class="n">_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">IPCL</span><span class="p">)</span><span class="w">  </span><span class="c1">// _LEN: Length</span>
</span><span id="__span-10-62"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">            </span><span class="n">IPCB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICDP</span><span class="w"> </span><span class="cm">/* \ICDP */</span>
</span><span id="__span-10-63"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="w">            </span><span class="n">IPCH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICDP</span><span class="w"> </span><span class="cm">/* \ICDP */</span>
</span><span id="__span-10-64"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-64" id="__codelineno-10-64" name="__codelineno-10-64"></a><span class="w">            </span><span class="n">IPCL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01</span>
</span><span id="__span-10-65"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-65" id="__codelineno-10-65" name="__codelineno-10-65"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-66"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-66" id="__codelineno-10-66" name="__codelineno-10-66"></a>
</span><span id="__span-10-67"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-67" id="__codelineno-10-67" name="__codelineno-10-67"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">ICRS</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.LPC0.SPMI.ICRS */</span>
</span><span id="__span-10-68"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-68" id="__codelineno-10-68" name="__codelineno-10-68"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-69"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-69" id="__codelineno-10-69" name="__codelineno-10-69"></a>
</span><span id="__span-10-70"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-70" id="__codelineno-10-70" name="__codelineno-10-70"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_IFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _IFT: IPMI Interface Type</span>
</span><span id="__span-10-71"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-71" id="__codelineno-10-71" name="__codelineno-10-71"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-72"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-72" id="__codelineno-10-72" name="__codelineno-10-72"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span>
</span><span id="__span-10-73"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-73" id="__codelineno-10-73" name="__codelineno-10-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-74"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-74" id="__codelineno-10-74" name="__codelineno-10-74"></a>
</span><span id="__span-10-75"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-75" id="__codelineno-10-75" name="__codelineno-10-75"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_SRV</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _SRV: IPMI Spec Revision</span>
</span><span id="__span-10-76"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-76" id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-10-77"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-77" id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">SRVV</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \SRVV */</span>
</span><span id="__span-10-78"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-78" id="__codelineno-10-78" name="__codelineno-10-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-79"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-10-79" id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="p">}</span>
</span></code></pre></div>
<p>在 Linux 中可以找到相应的结点：<code>/sys/devices/LNXSYSTM:00/LNXSYBUS:00/PNP0A08:00/device:86/IPI0001:00</code>。可以发现匹配到了 <code>ipmi_si</code> 驱动，并且可以正常工作。</p>
<p>函数 <code>_STA</code> 返回设备的当前状态，它读取了 IO Port 0x0CA3 的内容，进而判断 IPMI 是否正常。</p>
<p>函数 <code>_CRS</code> 返回当前的资源配置，它动态地计算出一个资源配置，对应 IO Port 是 0x0CA2 和 0x0CA3。</p>
<p>函数 <code>_IFT</code> 返回 IPMI Interface Type，0x01 表示 KCS(Keyboard Controller Style)，<code>_SRV</code> 返回 IPMI Spec Revision，在这里是 0x0200，也就是 IPMI 2.0。</p>
<p>这些内容可以在 Linux 下 ACPI 结点的 <code>physical_node/params</code> 文件中看到：<code>kcs,i/o,0xca2,rsp=1,rsi=1,rsh=0,irq=0,ipmb=32</code>。</p>
<p>查阅 Linux 源码，可以找到 <code>acpi_ipmi_probe</code> 函数，这个函数负责从 ACPI 中寻找 IPMI 配置：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">acpi_ipmi_probe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">platform_device</span><span class="w"> </span><span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
</span><span id="__span-11-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="p">{</span>
</span><span id="__span-11-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-11-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">"probing via ACPI</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</span><span id="__span-11-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>
</span><span id="__span-11-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="cm">/* _IFT tells us the interface type: KCS, BT, etc */</span>
</span><span id="__span-11-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="s">"_IFT"</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
</span><span id="__span-11-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a>
</span><span id="__span-11-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-11-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_KCS</span><span class="p">;</span>
</span><span id="__span-11-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
</span><span id="__span-11-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_SMIC</span><span class="p">;</span>
</span><span id="__span-11-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
</span><span id="__span-11-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">        </span><span class="n">io</span><span class="p">.</span><span class="n">si_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SI_BT</span><span class="p">;</span>
</span><span id="__span-11-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-11-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="cm">/* SSIF, just ignore */</span>
</span><span id="__span-11-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
</span><span id="__span-11-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-11-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">        </span><span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="s">"unknown IPMI type %lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">);</span>
</span><span id="__span-11-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-11-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a>
</span><span id="__span-11-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipmi_get_info_from_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
</span><span id="__span-11-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
</span><span id="__span-11-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span><span id="__span-11-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>
</span><span id="__span-11-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-11-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="p">}</span>
</span><span id="__span-11-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a>
</span><span id="__span-11-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_device_id</span><span class="w"> </span><span class="n">acpi_ipmi_match</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">"IPI0001"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-11-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-35" id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-11-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-11-36" id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="p">};</span>
</span></code></pre></div>
<p>和上面的分析是可以对上的。</p>
<h5 id="ipmi-kcs"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#ipmi-kcs">IPMI KCS</a></h5>
<p>查阅 IPMI 标准文档，可以看到 KCS(Keyboard Controller Style) Interface 下，操作系统通过两个 IO Port 来访问 BMC：</p>
<p><img alt="" src="/images/ipmi_kcs.png"/></p>
<p>图中的 <code>base</code> 就是上面 ACPI 表记录的 <code>IDTP=0x0CA2</code>，<code>base+1</code> 就是 ACPI 表记录的 <code>ICDP=0x0CA3</code>。结合寄存器的用途，可以猜测 IDTP 是 IPMI Data Transfer Port 的缩写，因为这个 Port 对应的是 <code>Data_In</code> 和 <code>Data_Out</code>；ICDP 是 IPMI Command Data Port 的缩写。</p>
<h4 id="arm64_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#arm64_1">ARM64</a></h4>
<p>再看一个 ARM64 平台上的 IPMI：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IPI0</span><span class="p">)</span>
</span><span id="__span-12-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="p">{</span>
</span><span id="__span-12-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="s">"IPI0001"</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-12-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_IFT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _IFT: IPMI Interface Type</span>
</span><span id="__span-12-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// BT</span>
</span><span id="__span-12-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-12-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">        </span><span class="n">QWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceConsumer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-12-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Granularity</span>
</span><span id="__span-12-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">            </span><span class="mh">0x00000003F00000E4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Minimum</span>
</span><span id="__span-12-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">            </span><span class="mh">0x00000003F00000E7</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Maximum</span>
</span><span id="__span-12-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Translation Offset</span>
</span><span id="__span-12-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">            </span><span class="mh">0x0000000000000004</span><span class="p">,</span><span class="w"> </span><span class="c1">// Length</span>
</span><span id="__span-12-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-12-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">        </span><span class="n">Interrupt</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceConsumer</span><span class="p">,</span><span class="w"> </span><span class="n">Level</span><span class="p">,</span><span class="w"> </span><span class="n">ActiveHigh</span><span class="p">,</span><span class="w"> </span><span class="n">Shared</span><span class="p">,</span><span class="w"> </span><span class="p">,,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-12-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-12-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">            </span><span class="mh">0x000001E4</span><span class="p">,</span>
</span><span id="__span-12-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-12-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-12-23" id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>_IFT</code> 返回值是 0x3，查阅文档可知这表示的是 BT 类型。<code>_CRS</code> 中使用了 QWordMemory 宏来描述地址空间，这里实际上就是表示内存地址 <code>0x3F00000E4-0x3F00000E7</code>。</p>
<h3 id="io-apic"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#io-apic">IO APIC</a></h3>
<p>在 DSDT 中，可以找到 IO APIC 的基地址：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">APIC</span><span class="p">)</span>
</span><span id="__span-13-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="p">{</span>
</span><span id="__span-13-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0003"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* IO-APIC Interrupt Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-13-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-13-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-13-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">        </span><span class="n">Memory32Fixed</span><span class="w"> </span><span class="p">(</span><span class="n">ReadOnly</span><span class="p">,</span>
</span><span id="__span-13-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">            </span><span class="mh">0xFEC00000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Address Base</span>
</span><span id="__span-13-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">            </span><span class="mh">0x00100000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Address Length</span>
</span><span id="__span-13-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-13-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-13-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到 IO APIC 基地址是 0xFEC00000，在网上也可以查到同样的结果。实际上，在 Multiple APIC Description Table (MADT) 中也可以找到 IO APIC 的基地址：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>[1ECh 0492   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>[1EDh 0493   1]                       Length : 0C
</span><span id="__span-14-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>[1EEh 0494   1]                  I/O Apic ID : 08
</span><span id="__span-14-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>[1EFh 0495   1]                     Reserved : 00
</span><span id="__span-14-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>[1F0h 0496   4]                      Address : FEC00000
</span><span id="__span-14-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>[1F4h 0500   4]                    Interrupt : 00000000
</span><span id="__span-14-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>
</span><span id="__span-14-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>[1F8h 0504   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>[1F9h 0505   1]                       Length : 0C
</span><span id="__span-14-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a>[1FAh 0506   1]                  I/O Apic ID : 09
</span><span id="__span-14-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>[1FBh 0507   1]                     Reserved : 00
</span><span id="__span-14-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a>[1FCh 0508   4]                      Address : FEC01000
</span><span id="__span-14-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a>[200h 0512   4]                    Interrupt : 00000018
</span><span id="__span-14-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a>
</span><span id="__span-14-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a>[204h 0516   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>[205h 0517   1]                       Length : 0C
</span><span id="__span-14-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a>[206h 0518   1]                  I/O Apic ID : 0A
</span><span id="__span-14-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a>[207h 0519   1]                     Reserved : 00
</span><span id="__span-14-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a>[208h 0520   4]                      Address : FEC08000
</span><span id="__span-14-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a>[20Ch 0524   4]                    Interrupt : 00000020
</span><span id="__span-14-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a>
</span><span id="__span-14-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a>[210h 0528   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a>[211h 0529   1]                       Length : 0C
</span><span id="__span-14-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a>[212h 0530   1]                  I/O Apic ID : 0B
</span><span id="__span-14-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a>[213h 0531   1]                     Reserved : 00
</span><span id="__span-14-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a>[214h 0532   4]                      Address : FEC10000
</span><span id="__span-14-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>[218h 0536   4]                    Interrupt : 00000028
</span><span id="__span-14-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a>
</span><span id="__span-14-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a>[21Ch 0540   1]                Subtable Type : 01 [I/O APIC]
</span><span id="__span-14-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a>[21Dh 0541   1]                       Length : 0C
</span><span id="__span-14-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a>[21Eh 0542   1]                  I/O Apic ID : 0C
</span><span id="__span-14-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a>[21Fh 0543   1]                     Reserved : 00
</span><span id="__span-14-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a>[220h 0544   4]                      Address : FEC18000
</span><span id="__span-14-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a>[224h 0548   4]                    Interrupt : 00000030
</span></code></pre></div>
<h3 id="dma"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#dma">DMA</a></h3>
<p>继续搜索 <code>_HID</code>，还可以找到一些传统的设备，比如 DMA Controller：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1">// DMA Controller</span>
</span><span id="__span-15-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMAC</span><span class="p">)</span>
</span><span id="__span-15-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="p">{</span>
</span><span id="__span-15-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0200"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class DMA Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-15-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-15-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-15-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">            </span><span class="mh">0x10</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">            </span><span class="mh">0x0081</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">            </span><span class="mh">0x0081</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">            </span><span class="mh">0x03</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">            </span><span class="mh">0x0087</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">            </span><span class="mh">0x0087</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">            </span><span class="mh">0x0089</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">            </span><span class="mh">0x0089</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">            </span><span class="mh">0x03</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">            </span><span class="mh">0x008F</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">            </span><span class="mh">0x008F</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-35" id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-36" id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-37" id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-15-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-38" id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">            </span><span class="mh">0x00C0</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-15-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-39" id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="w">            </span><span class="mh">0x00C0</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-15-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-40" id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">            </span><span class="mh">0x00</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-15-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-41" id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">            </span><span class="mh">0x20</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-15-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-42" id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-15-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-43" id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="w">        </span><span class="n">DMA</span><span class="w"> </span><span class="p">(</span><span class="n">Compatibility</span><span class="p">,</span><span class="w"> </span><span class="n">NotBusMaster</span><span class="p">,</span><span class="w"> </span><span class="n">Transfer8</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-15-44"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-44" id="__codelineno-15-44" name="__codelineno-15-44"></a><span class="w">            </span><span class="p">{</span><span class="mi">4</span><span class="p">}</span>
</span><span id="__span-15-45"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-45" id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-15-46"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-15-46" id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它定义了如下的 IO Port 范围：</p>
<ul>
<li><code>0x00-0x0F</code></li>
<li>0x81, 0x87, 0x89, 0x8F</li>
<li><code>0xC0-0xDE</code></li>
</ul>
<p>寄存器定义可以在 <a href="https://wiki.osdev.org/ISA_DMA">ISA DMA - OSDev</a> 处找到。</p>
<h3 id="cmosrtc"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#cmosrtc">CMOS/RTC</a></h3>
<p>经典的 CMOS/RTC 的 IO 端口定义也可以找到：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">RTC</span><span class="p">)</span>
</span><span id="__span-16-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="p">{</span>
</span><span id="__span-16-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0B00"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* AT Real-Time Clock */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-16-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-16-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-16-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">            </span><span class="mh">0x0070</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-16-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">            </span><span class="mh">0x0070</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-16-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-16-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">            </span><span class="mh">0x02</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-16-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-16-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-16-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">            </span><span class="mh">0x0074</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-16-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">            </span><span class="mh">0x0074</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-16-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-16-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">            </span><span class="mh">0x04</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-16-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-17" id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-16-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-18" id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">        </span><span class="n">IRQNoFlags</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-16-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-19" id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">            </span><span class="p">{</span><span class="mi">8</span><span class="p">}</span>
</span><span id="__span-16-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-20" id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-16-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-21" id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_STA</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _STA: Status</span>
</span><span id="__span-16-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-22" id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-23" id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">        </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">STAS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="p">))</span>
</span><span id="__span-16-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-24" id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-16-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-25" id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)</span>
</span><span id="__span-16-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-26" id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-27" id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">        </span><span class="n">Else</span>
</span><span id="__span-16-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-28" id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-16-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-29" id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">            </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>
</span><span id="__span-16-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-30" id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-31" id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-16-32" id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，它的 IO Port 是 0x70-0x71 和 0x74-0x78，中断号 8，和 <a href="https://wiki.osdev.org/CMOS">CMOS - OSDev</a> 是一致的。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_3">启动图片</a></h3>
<p>启动图片以 BMP 格式保存在内存中，基地址记录在 BGRT 表中。可以直接从 <code>/sys/firmware/acpi/bgrt/image</code> 获取启动的图片内容。</p>
<h3 id="pcie"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie">PCIe</a></h3>
<h4 id="root-bridge"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#root-bridge">Root Bridge</a></h4>
<p>PCIe 总线是自带枚举功能的，所以只需要找到 Root Bridge，其他设备都可以枚举出来。而 ACPI 就提供了寻找 Root Bridge 的方法。</p>
<p>搜索 <code>PNP0A08</code> 可以找到 PCIe 总线：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">// PCIe Bus 00</span>
</span><span id="__span-17-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-17-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="p">{</span>
</span><span id="__span-17-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0A08"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PCI Express Bus */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-17-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_CID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0A03"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PCI Bus */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CID: Compatible ID</span>
</span><span id="__span-17-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">P0RS</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceTemplate</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-17-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-17-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">        </span><span class="n">WordBusNumber</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span>
</span><span id="__span-17-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">            </span><span class="mh">0x0015</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">            </span><span class="mh">0x0016</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-17-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">        </span><span class="n">IO</span><span class="w"> </span><span class="p">(</span><span class="n">Decode16</span><span class="p">,</span>
</span><span id="__span-17-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">            </span><span class="mh">0x01</span><span class="p">,</span><span class="w">               </span><span class="c1">// Alignment</span>
</span><span id="__span-17-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">            </span><span class="mh">0x08</span><span class="p">,</span><span class="w">               </span><span class="c1">// Length</span>
</span><span id="__span-17-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">            </span><span class="p">)</span>
</span><span id="__span-17-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">        </span><span class="n">WordIO</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">EntireRange</span><span class="p">,</span>
</span><span id="__span-17-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">            </span><span class="mh">0x0CF7</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">            </span><span class="mh">0x0CF8</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-28" id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">,</span><span class="w"> </span><span class="n">DenseTranslation</span><span class="p">)</span>
</span><span id="__span-17-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-29" id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">        </span><span class="n">WordIO</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">EntireRange</span><span class="p">,</span>
</span><span id="__span-17-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-30" id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Granularity</span>
</span><span id="__span-17-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-31" id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="w">            </span><span class="mh">0x1000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-32" id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="w">            </span><span class="mh">0x57FF</span><span class="p">,</span><span class="w">             </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-33" id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="w">            </span><span class="mh">0x0000</span><span class="p">,</span><span class="w">             </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-34" id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="w">            </span><span class="mh">0x4800</span><span class="p">,</span><span class="w">             </span><span class="c1">// Length</span>
</span><span id="__span-17-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-35" id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">,</span><span class="w"> </span><span class="n">DenseTranslation</span><span class="p">)</span>
</span><span id="__span-17-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-36" id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-37" id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-38" id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="w">            </span><span class="mh">0x000A0000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-39" id="__codelineno-17-39" name="__codelineno-17-39"></a><span class="w">            </span><span class="mh">0x000BFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-40" id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-41" id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="w">            </span><span class="mh">0x00020000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-42" id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-43" id="__codelineno-17-43" name="__codelineno-17-43"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">Cacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-44"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-44" id="__codelineno-17-44" name="__codelineno-17-44"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-45"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-45" id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-46"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-46" id="__codelineno-17-46" name="__codelineno-17-46"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-47"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-47" id="__codelineno-17-47" name="__codelineno-17-47"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-48"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-48" id="__codelineno-17-48" name="__codelineno-17-48"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-49"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-49" id="__codelineno-17-49" name="__codelineno-17-49"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="n">_Y00</span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-50"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-50" id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-51"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-51" id="__codelineno-17-51" name="__codelineno-17-51"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-52"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-52" id="__codelineno-17-52" name="__codelineno-17-52"></a><span class="w">            </span><span class="mh">0xFE010000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-53"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-53" id="__codelineno-17-53" name="__codelineno-17-53"></a><span class="w">            </span><span class="mh">0xFE010FFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-54"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-54" id="__codelineno-17-54" name="__codelineno-17-54"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-55"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-55" id="__codelineno-17-55" name="__codelineno-17-55"></a><span class="w">            </span><span class="mh">0x00001000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-56"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-56" id="__codelineno-17-56" name="__codelineno-17-56"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-57"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-57" id="__codelineno-17-57" name="__codelineno-17-57"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-58"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-58" id="__codelineno-17-58" name="__codelineno-17-58"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-59"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-59" id="__codelineno-17-59" name="__codelineno-17-59"></a><span class="w">            </span><span class="mh">0xFD000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-60"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-60" id="__codelineno-17-60" name="__codelineno-17-60"></a><span class="w">            </span><span class="mh">0xFE7FFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-61"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-61" id="__codelineno-17-61" name="__codelineno-17-61"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-62"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-62" id="__codelineno-17-62" name="__codelineno-17-62"></a><span class="w">            </span><span class="mh">0x01800000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-63"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-63" id="__codelineno-17-63" name="__codelineno-17-63"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-64"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-64" id="__codelineno-17-64" name="__codelineno-17-64"></a><span class="w">        </span><span class="n">DWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-65"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-65" id="__codelineno-17-65" name="__codelineno-17-65"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Granularity</span>
</span><span id="__span-17-66"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-66" id="__codelineno-17-66" name="__codelineno-17-66"></a><span class="w">            </span><span class="mh">0x70000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-67"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-67" id="__codelineno-17-67" name="__codelineno-17-67"></a><span class="w">            </span><span class="mh">0x92FFFFFF</span><span class="p">,</span><span class="w">         </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-68"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-68" id="__codelineno-17-68" name="__codelineno-17-68"></a><span class="w">            </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-69"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-69" id="__codelineno-17-69" name="__codelineno-17-69"></a><span class="w">            </span><span class="mh">0x23000000</span><span class="p">,</span><span class="w">         </span><span class="c1">// Length</span>
</span><span id="__span-17-70"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-70" id="__codelineno-17-70" name="__codelineno-17-70"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-71"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-71" id="__codelineno-17-71" name="__codelineno-17-71"></a><span class="w">        </span><span class="n">QWordMemory</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceProducer</span><span class="p">,</span><span class="w"> </span><span class="n">PosDecode</span><span class="p">,</span><span class="w"> </span><span class="n">MinFixed</span><span class="p">,</span><span class="w"> </span><span class="n">MaxFixed</span><span class="p">,</span><span class="w"> </span><span class="n">NonCacheable</span><span class="p">,</span><span class="w"> </span><span class="n">ReadWrite</span><span class="p">,</span>
</span><span id="__span-17-72"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-72" id="__codelineno-17-72" name="__codelineno-17-72"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Granularity</span>
</span><span id="__span-17-73"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-73" id="__codelineno-17-73" name="__codelineno-17-73"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Minimum</span>
</span><span id="__span-17-74"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-74" id="__codelineno-17-74" name="__codelineno-17-74"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Range Maximum</span>
</span><span id="__span-17-75"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-75" id="__codelineno-17-75" name="__codelineno-17-75"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Translation Offset</span>
</span><span id="__span-17-76"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-76" id="__codelineno-17-76" name="__codelineno-17-76"></a><span class="w">            </span><span class="mh">0x0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Length</span>
</span><span id="__span-17-77"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-77" id="__codelineno-17-77" name="__codelineno-17-77"></a><span class="w">            </span><span class="p">,,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">AddressRangeMemory</span><span class="p">,</span><span class="w"> </span><span class="n">TypeStatic</span><span class="p">)</span>
</span><span id="__span-17-78"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-78" id="__codelineno-17-78" name="__codelineno-17-78"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-17-79"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-79" id="__codelineno-17-79" name="__codelineno-17-79"></a>
</span><span id="__span-17-80"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-80" id="__codelineno-17-80" name="__codelineno-17-80"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_CRS</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _CRS: Current Resource Settings</span>
</span><span id="__span-17-81"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-81" id="__codelineno-17-81" name="__codelineno-17-81"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-17-82"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-82" id="__codelineno-17-82" name="__codelineno-17-82"></a><span class="w">        </span><span class="n">EROM</span><span class="w"> </span><span class="p">()</span>
</span><span id="__span-17-83"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-83" id="__codelineno-17-83" name="__codelineno-17-83"></a><span class="w">        </span><span class="n">Return</span><span class="w"> </span><span class="p">(</span><span class="n">P0RS</span><span class="p">)</span><span class="w"> </span><span class="cm">/* \_SB_.PC00.P0RS */</span>
</span><span id="__span-17-84"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-84" id="__codelineno-17-84" name="__codelineno-17-84"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-85"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-17-85" id="__codelineno-17-85" name="__codelineno-17-85"></a><span class="p">}</span>
</span></code></pre></div>
<p>上面省略掉了很多内容，只保留了 Root Bridge 的资源 <code>_CRS</code>，这部分内容和 Linux 的 dmesg 是一致的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>ACPI: PCI Root Bridge [PC00] (domain 0000 [bus 00-15])
</span><span id="__span-18-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>acpi PNP0A08:00: _OSC: OS supports [ExtendedConfig ASPM ClockPM Segments MSI]
</span><span id="__span-18-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>acpi PNP0A08:00: _OSC: platform does not support [SHPCHotplug AER LTR]
</span><span id="__span-18-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>acpi PNP0A08:00: _OSC: OS now controls [PCIeHotplug PME PCIeCapability]
</span><span id="__span-18-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a>acpi PNP0A08:00: host bridge window expanded to [mem 0xfd000000-0xfe7fffff window]; [mem 0xfd000000-0xfe7fffff window] ignored
</span><span id="__span-18-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a>PCI host bridge to bus 0000:00
</span><span id="__span-18-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a>pci_bus 0000:00: root bus resource [io  0x0000-0x0cf7 window]
</span><span id="__span-18-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a>pci_bus 0000:00: root bus resource [io  0x1000-0x57ff window]
</span><span id="__span-18-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a>pci_bus 0000:00: root bus resource [mem 0x000a0000-0x000bffff window]
</span><span id="__span-18-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-10" id="__codelineno-18-10" name="__codelineno-18-10"></a>pci_bus 0000:00: root bus resource [mem 0x000c4000-0x000c7fff window]
</span><span id="__span-18-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-11" id="__codelineno-18-11" name="__codelineno-18-11"></a>pci_bus 0000:00: root bus resource [mem 0xfd000000-0xfe7fffff window]
</span><span id="__span-18-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-12" id="__codelineno-18-12" name="__codelineno-18-12"></a>pci_bus 0000:00: root bus resource [mem 0x70000000-0x92ffffff window]
</span><span id="__span-18-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-18-13" id="__codelineno-18-13" name="__codelineno-18-13"></a>pci_bus 0000:00: root bus resource [bus 00-15]
</span></code></pre></div>
<p>Linux 相关代码在 <code>acpi_pci_root_create</code> 函数中：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">pci_bus</span><span class="w"> </span><span class="o">*</span><span class="n">acpi_pci_root_create</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">,</span>
</span><span id="__span-19-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root_ops</span><span class="w"> </span><span class="o">*</span><span class="n">ops</span><span class="p">,</span>
</span><span id="__span-19-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">                     </span><span class="k">struct</span><span class="w"> </span><span class="nc">acpi_pci_root_info</span><span class="w"> </span><span class="o">*</span><span class="n">info</span><span class="p">,</span>
</span><span id="__span-19-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">                     </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sysdata</span><span class="p">)</span>
</span><span id="__span-19-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="p">{</span>
</span><span id="__span-19-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-19-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pci_probe_root_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span><span id="__span-19-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-19-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">    </span><span class="n">pci_acpi_root_add_resources</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span><span id="__span-19-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">    </span><span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">);</span>
</span><span id="__span-19-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pci_create_root_bus</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">busnum</span><span class="p">,</span><span class="w"> </span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pci_ops</span><span class="p">,</span>
</span><span id="__span-19-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">                  </span><span class="n">sysdata</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">);</span>
</span><span id="__span-19-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="mcfg"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#mcfg">MCFG</a></h4>
<p>除了上面的 Root Bridge 以外，还有一个很重要的问题是，如何访问 PCIe 的 Configuration Space。传统的办法是通过 IO Port 0xCF8 和 0xCFC，但是这个方法慢，并且有局限性。而较新的办法是 Enhanced Configuration Access Mechanism (ECAM)，把 PCIe 设备的 Configuration Space 映射到内存中，那么就需要一个基地址。这个基地址是在 MCFG 表中给出的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>[02Ch 0044   8]                 Base Address : 0000000060000000
</span><span id="__span-20-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>[034h 0052   2]         Segment Group Number : 0000
</span><span id="__span-20-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>[036h 0054   1]             Start Bus Number : 00
</span><span id="__span-20-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>[037h 0055   1]               End Bus Number : FF
</span><span id="__span-20-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>[038h 0056   4]                     Reserved : 00000000
</span></code></pre></div>
<p>内核输出：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>PCI: MMCONFIG for domain 0000 [bus 00-ff] at [mem 0x60000000-0x6fffffff] (base 0x60000000)
</span><span id="__span-21-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>PCI: MMCONFIG at [mem 0x60000000-0x6fffffff] reserved in E820
</span></code></pre></div>
<p>有了这个信息以后，就可以计算出要访问 Configuration Space 时 MMIO 的地址了：</p>
<p><img alt="" src="/images/pcie_ecam.png"/></p>
<h4 id="_4"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_4">相关文档</a></h4>
<p>Linux 的文档 <a href="https://docs.kernel.org/PCI/acpi-info.html">ACPI considerations for PCI host bridges</a> 对 ACPI PCIe 描述的比较详细，摘录如下：</p>
<div class="language-text highlight"><pre><span></span><code>The general rule is that the ACPI namespace should describe everything the
OS might use unless there’s another way for the OS to find it [1, 2].

For example, there’s no standard hardware mechanism for enumerating PCI host
bridges, so the ACPI namespace must describe each host bridge, the method
for accessing PCI config space below it, the address space windows the host
bridge forwards to PCI (using _CRS), and the routing of legacy INTx
interrupts (using _PRT).

PCI devices, which are below the host bridge, generally do not need to be
described via ACPI. The OS can discover them via the standard PCI
enumeration mechanism, using config accesses to discover and identify
devices and read and size their BARs. However, ACPI may describe PCI devices
if it provides power management or hotplug functionality for them or if the
device has INTx interrupts connected by platform interrupt controllers and a
_PRT is needed to describe those connections.
</code></pre></div>
<p>文档和上面讲的是一致的，对于 PCIe 自己可以枚举出来的，ACPI 就不需要再重复；但是枚举需要首先知道有哪些 Root Bridge 以及 ECAM 的基地址，这个信息只能由 ACPI 来提供。</p>
<div class="language-text highlight"><pre><span></span><code>The PCIe spec requires the Enhanced Configuration Access Method (ECAM)
unless there’s a standard firmware interface for config access, e.g., the
ia64 SAL interface [7]. A host bridge consumes ECAM memory address space and
converts memory accesses into PCI configuration accesses. The spec defines
the ECAM address space layout and functionality; only the base of the
address space is device-specific. An ACPI OS learns the base address from
either the static MCFG table or a _CBA method in the PNP0A03 device.
</code></pre></div>
<p>这一段讲的其实就是 ECAM 与 MCFG 的关系。</p>
<h4 id="pcie_1"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie_1">PCIe 设备</a></h4>
<p>虽然有了 Root Bridge 以后，PCIe 总线下的设备都可以枚举出来，但是 ACPI 表中也可以记录 PCIe 设备，可以提供更多信息，例如 Power State 等等。具体来说，只需要在 Root Bridge 的结点下继续增加 Device 就可以了：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-22-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_SB</span><span class="p">)</span>
</span><span id="__span-22-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="p">{</span>
</span><span id="__span-22-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-22-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-22-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">        </span><span class="c1">// 00:00.0 DMI3 Registers</span>
</span><span id="__span-22-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMI0</span><span class="p">)</span>
</span><span id="__span-22-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a>
</span><span id="__span-22-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">        </span><span class="c1">// 00:04.0 CBDMA Registers</span>
</span><span id="__span-22-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CB0A</span><span class="p">)</span>
</span><span id="__span-22-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00040000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a>
</span><span id="__span-22-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CB0B</span><span class="p">)</span>
</span><span id="__span-22-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00040001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-21" id="__codelineno-22-21" name="__codelineno-22-21"></a>
</span><span id="__span-22-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-22" id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">        </span><span class="c1">// 00:05.0 MM/Vt-d Configuration Registers</span>
</span><span id="__span-22-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-23" id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IIM0</span><span class="p">)</span>
</span><span id="__span-22-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-24" id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-25" id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00050000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-26" id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-27" id="__codelineno-22-27" name="__codelineno-22-27"></a>
</span><span id="__span-22-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-28" id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="w">        </span><span class="c1">// 00:08.0 Ubox Registers</span>
</span><span id="__span-22-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-29" id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">UBX0</span><span class="p">)</span>
</span><span id="__span-22-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-30" id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-31" id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00080000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-32" id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-33" id="__codelineno-22-33" name="__codelineno-22-33"></a>
</span><span id="__span-22-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-34" id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">ALZA</span><span class="p">)</span>
</span><span id="__span-22-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-35" id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-36" id="__codelineno-22-36" name="__codelineno-22-36"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000E0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-37" id="__codelineno-22-37" name="__codelineno-22-37"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-38" id="__codelineno-22-38" name="__codelineno-22-38"></a>
</span><span id="__span-22-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-39" id="__codelineno-22-39" name="__codelineno-22-39"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DISP</span><span class="p">)</span>
</span><span id="__span-22-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-40" id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-41" id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000F0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-42" id="__codelineno-22-42" name="__codelineno-22-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-43" id="__codelineno-22-43" name="__codelineno-22-43"></a>
</span><span id="__span-22-44"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-44" id="__codelineno-22-44" name="__codelineno-22-44"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC1</span><span class="p">)</span>
</span><span id="__span-22-45"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-45" id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-46"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-46" id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-47"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-47" id="__codelineno-22-47" name="__codelineno-22-47"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-48"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-48" id="__codelineno-22-48" name="__codelineno-22-48"></a>
</span><span id="__span-22-49"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-49" id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC2</span><span class="p">)</span>
</span><span id="__span-22-50"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-50" id="__codelineno-22-50" name="__codelineno-22-50"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-51"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-51" id="__codelineno-22-51" name="__codelineno-22-51"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-52"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-52" id="__codelineno-22-52" name="__codelineno-22-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-53"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-53" id="__codelineno-22-53" name="__codelineno-22-53"></a>
</span><span id="__span-22-54"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-54" id="__codelineno-22-54" name="__codelineno-22-54"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IIDR</span><span class="p">)</span>
</span><span id="__span-22-55"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-55" id="__codelineno-22-55" name="__codelineno-22-55"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-56"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-56" id="__codelineno-22-56" name="__codelineno-22-56"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-57"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-57" id="__codelineno-22-57" name="__codelineno-22-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-58"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-58" id="__codelineno-22-58" name="__codelineno-22-58"></a>
</span><span id="__span-22-59"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-59" id="__codelineno-22-59" name="__codelineno-22-59"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IMKT</span><span class="p">)</span>
</span><span id="__span-22-60"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-60" id="__codelineno-22-60" name="__codelineno-22-60"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-61"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-61" id="__codelineno-22-61" name="__codelineno-22-61"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-62"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-62" id="__codelineno-22-62" name="__codelineno-22-62"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-63"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-63" id="__codelineno-22-63" name="__codelineno-22-63"></a>
</span><span id="__span-22-64"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-64" id="__codelineno-22-64" name="__codelineno-22-64"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IHC3</span><span class="p">)</span>
</span><span id="__span-22-65"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-65" id="__codelineno-22-65" name="__codelineno-22-65"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-66"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-66" id="__codelineno-22-66" name="__codelineno-22-66"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00100004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-67"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-67" id="__codelineno-22-67" name="__codelineno-22-67"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-68"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-68" id="__codelineno-22-68" name="__codelineno-22-68"></a>
</span><span id="__span-22-69"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-69" id="__codelineno-22-69" name="__codelineno-22-69"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MRO0</span><span class="p">)</span>
</span><span id="__span-22-70"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-70" id="__codelineno-22-70" name="__codelineno-22-70"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-71"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-71" id="__codelineno-22-71" name="__codelineno-22-71"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00110000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-72"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-72" id="__codelineno-22-72" name="__codelineno-22-72"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-73"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-73" id="__codelineno-22-73" name="__codelineno-22-73"></a>
</span><span id="__span-22-74"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-74" id="__codelineno-22-74" name="__codelineno-22-74"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MRO1</span><span class="p">)</span>
</span><span id="__span-22-75"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-75" id="__codelineno-22-75" name="__codelineno-22-75"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-76"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-76" id="__codelineno-22-76" name="__codelineno-22-76"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00110001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-77"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-77" id="__codelineno-22-77" name="__codelineno-22-77"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-78"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-78" id="__codelineno-22-78" name="__codelineno-22-78"></a>
</span><span id="__span-22-79"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-79" id="__codelineno-22-79" name="__codelineno-22-79"></a><span class="w">        </span><span class="c1">// 00:14.0 USB 3.0 xHCI Controller</span>
</span><span id="__span-22-80"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-80" id="__codelineno-22-80" name="__codelineno-22-80"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">XHCI</span><span class="p">)</span>
</span><span id="__span-22-81"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-81" id="__codelineno-22-81" name="__codelineno-22-81"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-82"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-82" id="__codelineno-22-82" name="__codelineno-22-82"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-83"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-83" id="__codelineno-22-83" name="__codelineno-22-83"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-84"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-84" id="__codelineno-22-84" name="__codelineno-22-84"></a>
</span><span id="__span-22-85"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-85" id="__codelineno-22-85" name="__codelineno-22-85"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">OTG0</span><span class="p">)</span>
</span><span id="__span-22-86"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-86" id="__codelineno-22-86" name="__codelineno-22-86"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-87"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-87" id="__codelineno-22-87" name="__codelineno-22-87"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-88"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-88" id="__codelineno-22-88" name="__codelineno-22-88"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-89"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-89" id="__codelineno-22-89" name="__codelineno-22-89"></a>
</span><span id="__span-22-90"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-90" id="__codelineno-22-90" name="__codelineno-22-90"></a><span class="w">        </span><span class="c1">// 00:14.2 PCH Thermal Subsystem</span>
</span><span id="__span-22-91"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-91" id="__codelineno-22-91" name="__codelineno-22-91"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">TERM</span><span class="p">)</span>
</span><span id="__span-22-92"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-92" id="__codelineno-22-92" name="__codelineno-22-92"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-93"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-93" id="__codelineno-22-93" name="__codelineno-22-93"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-94"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-94" id="__codelineno-22-94" name="__codelineno-22-94"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-95"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-95" id="__codelineno-22-95" name="__codelineno-22-95"></a>
</span><span id="__span-22-96"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-96" id="__codelineno-22-96" name="__codelineno-22-96"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">CAMR</span><span class="p">)</span>
</span><span id="__span-22-97"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-97" id="__codelineno-22-97" name="__codelineno-22-97"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-98"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-98" id="__codelineno-22-98" name="__codelineno-22-98"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-99"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-99" id="__codelineno-22-99" name="__codelineno-22-99"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-100"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-100" id="__codelineno-22-100" name="__codelineno-22-100"></a>
</span><span id="__span-22-101"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-101" id="__codelineno-22-101" name="__codelineno-22-101"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">NTHP</span><span class="p">)</span>
</span><span id="__span-22-102"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-102" id="__codelineno-22-102" name="__codelineno-22-102"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-103"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-103" id="__codelineno-22-103" name="__codelineno-22-103"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00140004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-104"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-104" id="__codelineno-22-104" name="__codelineno-22-104"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-105"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-105" id="__codelineno-22-105" name="__codelineno-22-105"></a>
</span><span id="__span-22-106"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-106" id="__codelineno-22-106" name="__codelineno-22-106"></a><span class="w">        </span><span class="c1">// 00:16.0 PCH CSME HECI #1</span>
</span><span id="__span-22-107"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-107" id="__codelineno-22-107" name="__codelineno-22-107"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC1</span><span class="p">)</span>
</span><span id="__span-22-108"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-108" id="__codelineno-22-108" name="__codelineno-22-108"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-109"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-109" id="__codelineno-22-109" name="__codelineno-22-109"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-110"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-110" id="__codelineno-22-110" name="__codelineno-22-110"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-111"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-111" id="__codelineno-22-111" name="__codelineno-22-111"></a>
</span><span id="__span-22-112"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-112" id="__codelineno-22-112" name="__codelineno-22-112"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC2</span><span class="p">)</span>
</span><span id="__span-22-113"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-113" id="__codelineno-22-113" name="__codelineno-22-113"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-114"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-114" id="__codelineno-22-114" name="__codelineno-22-114"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160001</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-115"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-115" id="__codelineno-22-115" name="__codelineno-22-115"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-116"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-116" id="__codelineno-22-116" name="__codelineno-22-116"></a>
</span><span id="__span-22-117"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-117" id="__codelineno-22-117" name="__codelineno-22-117"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">IDER</span><span class="p">)</span>
</span><span id="__span-22-118"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-118" id="__codelineno-22-118" name="__codelineno-22-118"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-119"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-119" id="__codelineno-22-119" name="__codelineno-22-119"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160002</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-120"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-120" id="__codelineno-22-120" name="__codelineno-22-120"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-121"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-121" id="__codelineno-22-121" name="__codelineno-22-121"></a>
</span><span id="__span-22-122"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-122" id="__codelineno-22-122" name="__codelineno-22-122"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">MEKT</span><span class="p">)</span>
</span><span id="__span-22-123"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-123" id="__codelineno-22-123" name="__codelineno-22-123"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-124"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-124" id="__codelineno-22-124" name="__codelineno-22-124"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160003</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-125"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-125" id="__codelineno-22-125" name="__codelineno-22-125"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-126"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-126" id="__codelineno-22-126" name="__codelineno-22-126"></a>
</span><span id="__span-22-127"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-127" id="__codelineno-22-127" name="__codelineno-22-127"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HEC3</span><span class="p">)</span>
</span><span id="__span-22-128"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-128" id="__codelineno-22-128" name="__codelineno-22-128"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-129"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-129" id="__codelineno-22-129" name="__codelineno-22-129"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00160004</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-130"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-130" id="__codelineno-22-130" name="__codelineno-22-130"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-131"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-131" id="__codelineno-22-131" name="__codelineno-22-131"></a>
</span><span id="__span-22-132"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-132" id="__codelineno-22-132" name="__codelineno-22-132"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">NAN1</span><span class="p">)</span>
</span><span id="__span-22-133"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-133" id="__codelineno-22-133" name="__codelineno-22-133"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-22-134"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-134" id="__codelineno-22-134" name="__codelineno-22-134"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00180000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-22-135"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-135" id="__codelineno-22-135" name="__codelineno-22-135"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-22-136"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-136" id="__codelineno-22-136" name="__codelineno-22-136"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-137"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-22-137" id="__codelineno-22-137" name="__codelineno-22-137"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里的 <code>_ADR</code> 编码了设备的 Device 和 Function，ACPI 标准 Table 6.2 定义：高 word 表示 Device，低 word 表示 Function。所以上面的 <code>DMI0</code> 就是 <code>Device=0, Function=0</code>，<code>CB0A</code> 就是 <code>Device=4, Function=0</code>，<code>CB0B</code> 就是 <code>Device=4, Function=1</code>。这些与 <code>lspci</code> 的输出基本是一致的，有一些设备没有出现，可能和具体的 CPU 型号有关：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>00:00.0 Host bridge: Intel Corporation Sky Lake-E DMI3 Registers (rev 07)
</span><span id="__span-23-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a>00:04.0 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a>00:04.1 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a>00:04.2 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a>00:04.3 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>00:04.4 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a>00:04.5 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a>00:04.6 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a>00:04.7 System peripheral: Intel Corporation Sky Lake-E CBDMA Registers (rev 07)
</span><span id="__span-23-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a>00:05.0 System peripheral: Intel Corporation Sky Lake-E MM/Vt-d Configuration Registers (rev 07)
</span><span id="__span-23-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a>00:05.2 System peripheral: Intel Corporation Sky Lake-E RAS (rev 07)
</span><span id="__span-23-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a>00:05.4 PIC: Intel Corporation Sky Lake-E IOAPIC (rev 07)
</span><span id="__span-23-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a>00:08.0 System peripheral: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a>00:08.1 Performance counters: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a>00:08.2 System peripheral: Intel Corporation Sky Lake-E Ubox Registers (rev 07)
</span><span id="__span-23-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-16" id="__codelineno-23-16" name="__codelineno-23-16"></a>00:14.0 USB controller: Intel Corporation 200 Series/Z370 Chipset Family USB 3.0 xHCI Controller
</span><span id="__span-23-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-17" id="__codelineno-23-17" name="__codelineno-23-17"></a>00:14.2 Signal processing controller: Intel Corporation 200 Series PCH Thermal Subsystem
</span><span id="__span-23-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-18" id="__codelineno-23-18" name="__codelineno-23-18"></a>00:16.0 Communication controller: Intel Corporation 200 Series PCH CSME HECI #1
</span><span id="__span-23-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-23-19" id="__codelineno-23-19" name="__codelineno-23-19"></a>00:17.0 SATA controller: Intel Corporation 200 Series PCH SATA controller [AHCI mode]
</span></code></pre></div>
<p>前面提到的一些传统的设备，比如 DMA Controller，RTC 等，其实就是在 PCIe 下的 ISA bridge 下声明的：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-24-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_SB</span><span class="p">)</span>
</span><span id="__span-24-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="p">{</span>
</span><span id="__span-24-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PC00</span><span class="p">)</span>
</span><span id="__span-24-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-24-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">        </span><span class="c1">// 00:1f.0 ISA bridge: Intel Corporation X299 Chipset LPC/eSPI Controller</span>
</span><span id="__span-24-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">        </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">LPC0</span><span class="p">)</span>
</span><span id="__span-24-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-24-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">            </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_ADR</span><span class="p">,</span><span class="w"> </span><span class="mh">0x001F0000</span><span class="p">)</span><span class="w">  </span><span class="c1">// _ADR: Address</span>
</span><span id="__span-24-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a>
</span><span id="__span-24-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">DMAC</span><span class="p">)</span>
</span><span id="__span-24-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0200"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class DMA Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a>
</span><span id="__span-24-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">RTC</span><span class="p">)</span>
</span><span id="__span-24-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0B00"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* AT Real-Time Clock */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a>
</span><span id="__span-24-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">PIC</span><span class="p">)</span>
</span><span id="__span-24-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0000"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* 8259-compatible Programmable Interrupt Controller */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a>
</span><span id="__span-24-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">FPU</span><span class="p">)</span>
</span><span id="__span-24-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0C04"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* x87-compatible Floating Point Processing Unit */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-29" id="__codelineno-24-29" name="__codelineno-24-29"></a>
</span><span id="__span-24-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-30" id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">TMR</span><span class="p">)</span>
</span><span id="__span-24-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-31" id="__codelineno-24-31" name="__codelineno-24-31"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-32" id="__codelineno-24-32" name="__codelineno-24-32"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0100"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* PC-class System Timer */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-33" id="__codelineno-24-33" name="__codelineno-24-33"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-34" id="__codelineno-24-34" name="__codelineno-24-34"></a>
</span><span id="__span-24-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-35" id="__codelineno-24-35" name="__codelineno-24-35"></a><span class="w">            </span><span class="n">Device</span><span class="w"> </span><span class="p">(</span><span class="n">HPET</span><span class="p">)</span>
</span><span id="__span-24-36"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-36" id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="w">            </span><span class="p">{</span>
</span><span id="__span-24-37"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-37" id="__codelineno-24-37" name="__codelineno-24-37"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="n">EisaId</span><span class="w"> </span><span class="p">(</span><span class="s">"PNP0103"</span><span class="p">)</span><span class="w"> </span><span class="cm">/* HPET System Timer */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-24-38"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-38" id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-24-39"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-39" id="__codelineno-24-39" name="__codelineno-24-39"></a>
</span><span id="__span-24-40"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-40" id="__codelineno-24-40" name="__codelineno-24-40"></a><span class="w">            </span><span class="c1">// omitted</span>
</span><span id="__span-24-41"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-41" id="__codelineno-24-41" name="__codelineno-24-41"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-24-42"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-42" id="__codelineno-24-42" name="__codelineno-24-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-43"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-24-43" id="__codelineno-24-43" name="__codelineno-24-43"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="acpi_2"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_2">修改 ACPI 表内容</a></h3>
<p>想要修改 ACPI 表内容，最根本的办法是修改固件，但是修改起来比较麻烦。Linux 提供了一些方法来运行时打补丁：</p>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/acpi/initrd_table_override.html">Upgrading ACPI tables via initrd</a>：覆盖 ACPI 表</li>
<li><a href="https://www.kernel.org/doc/html/latest/admin-guide/acpi/ssdt-overlays.html">SSDT Overlays</a>：添加额外的 SSDT 表，类似 DT Overlay</li>
</ul>
<p>在黑苹果中，一般则是在 Bootloader(Clover/OpenCore) 一步把 ACPI 表修改了，如 <a href="https://elitemacx86.com/threads/how-to-patch-laptop-dsdt-and-ssdts.178/">How to Patch Laptop DSDT and SSDTs</a>。</p>
<h3 id="acpi_3"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#acpi_3">ACPI 硬件规范</a></h3>
<p>除了用来描述系统中已有的设备，ACPI 还对硬件做出了一些要求，在标准的 Chapter 4 ACPI Hardware Specification 中定义。例如，电源按钮是如何通知操作系统的？操作系统的重启和关机是怎么实现的？</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_5">电源按钮</a></h4>
<p>首先来看电源按钮（Power Button）。在 ACPI 中，定义了两种 Power Button 的实现方法，第一种就是比较经典的硬件按钮 + 中断的模式，当按下按钮的时候，中断状态（<code>PWRBTN_STS</code>）拉高，如果此时中断使能（<code>PWRBTN_EN</code>）也为高，就触发中断。这时候操作系统就知道电源键被按下了，开始进行关机操作。</p>
<p>第二种实现方法则利用了 ACPI 的可编程性。具体来说，当按下电源键的时候，操作系统会收到一个 SCI（System Control Interrupt），此时操作系统会根据中断编号，去执行 ACPI 中的函数，函数去读取当前的电源键状态，然后调用 <code>Notify</code> 函数来通知操作系统，电源键被按下了。</p>
<p>在使用虚拟机的时候，会知道 ACPI Shutdown 的说法，其实就是模拟了按下电源键的行为。QEMU 的相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-25-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pm1_evt_power_down</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">)</span>
</span><span id="__span-25-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="p">{</span>
</span><span id="__span-25-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">evt</span><span class="p">.</span><span class="n">en</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_BITMASK_POWER_BUTTON_ENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">        </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">evt</span><span class="p">.</span><span class="n">sts</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ACPI_BITMASK_POWER_BUTTON_STATUS</span><span class="p">;</span>
</span><span id="__span-25-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">        </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">.</span><span class="n">update_sci</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
</span><span id="__span-25-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个函数模拟了电源按钮，如果 <code>PWRBTN_EN=1</code>，就设置 <code>PWRBTN_STS=1</code> 并发送 SCI 中断。</p>
<p>那么，操作系统如何访问 <code>PWRBTN_EN</code> 和 <code>PWRBTN_STS</code> 呢？在 FADP(Fixed ACPI Descrption Table) 表中，可以找到 PM1A/B Event Block Address 和 PM1A/B Control Block Address：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>[038h 0056   4]     PM1A Event Block Address : 0000B000
</span><span id="__span-26-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>[03Ch 0060   4]     PM1B Event Block Address : 00000000
</span><span id="__span-26-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>[040h 0064   4]   PM1A Control Block Address : 0000B004
</span><span id="__span-26-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a>[044h 0068   4]   PM1B Control Block Address : 00000000
</span><span id="__span-26-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a>
</span><span id="__span-26-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a>[058h 0088   1]       PM1 Event Block Length : 04
</span><span id="__span-26-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a>[059h 0089   1]     PM1 Control Block Length : 02
</span></code></pre></div>
<p>那么就可以通过 IO Port 来访问这些寄存器了。<code>PWNBTN_STS</code> 属于 PM1 Status Registers，地址是 <code>PM1A/B Event Block Address=0xB000</code>；<code>PWNBTN_EN</code> 属于 PM1 Enable Registers，地址是 <code>PM1A/B Event Block Register + PM1 Event Block Length / 2=0xB002</code>。</p>
<p>这里的 PM1A/B 是 Register Grouping，使得硬件上可以把寄存器实现在两个不同的芯片上，分别实现一部分功能。操作系统读取的时候，要读取 A 和 B 然后 OR 起来，写入的时候则是 A 和 B 都要写。像上面的情况，就是只有 A 没有 B，那就直接读写 A 就可以了。</p>
<h4 id="_6"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#_6">关机</a></h4>
<p>另一方面，如果 OS 想要关机，那要怎么告诉硬件呢？还是通过 ACPI。在 PM1 Control Registers 中，可以通过写入 <code>SLP_TYPx</code> 和 <code>SLP_EN</code> 字段来进行休眠或者关机操作。</p>
<p>下面是 QEMU 针对 <code>SLP_EN</code> 写入的处理代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="cm">/* ACPI PM1aCNT */</span>
</span><span id="__span-27-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pm1_cnt_write</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
</span><span id="__span-27-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="p">{</span>
</span><span id="__span-27-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">cnt</span><span class="p">.</span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">ACPI_BITMASK_SLEEP_ENABLE</span><span class="p">);</span>
</span><span id="__span-27-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a>
</span><span id="__span-27-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_BITMASK_SLEEP_ENABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">        </span><span class="cm">/* change suspend type */</span>
</span><span id="__span-27-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">        </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">sus_typ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-27-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">sus_typ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-10" id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* soft power off */</span>
</span><span id="__span-27-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-11" id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">            </span><span class="n">qemu_system_shutdown_request</span><span class="p">(</span><span class="n">SHUTDOWN_CAUSE_GUEST_SHUTDOWN</span><span class="p">);</span>
</span><span id="__span-27-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-12" id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-13" id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
</span><span id="__span-27-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-14" id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">            </span><span class="n">qemu_system_suspend_request</span><span class="p">();</span>
</span><span id="__span-27-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-15" id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-16" id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-27-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-17" id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sus_typ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">pm1</span><span class="p">.</span><span class="n">cnt</span><span class="p">.</span><span class="n">s4_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* S4 request */</span>
</span><span id="__span-27-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-18" id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">                </span><span class="n">qapi_event_send_suspend_disk</span><span class="p">();</span>
</span><span id="__span-27-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-19" id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">                </span><span class="n">qemu_system_shutdown_request</span><span class="p">(</span><span class="n">SHUTDOWN_CAUSE_GUEST_SHUTDOWN</span><span class="p">);</span>
</span><span id="__span-27-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-20" id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-27-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-21" id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-27-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-22" id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-27-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-23" id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-27-24" id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="pm-timer"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pm-timer">PM Timer</a></h4>
<p>ACPI 还提供了一个 3.579545 MHz 的时钟 PM_TMR。QEMU 相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-28-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="cm">/* PM Timer ticks per second (HZ) */</span>
</span><span id="__span-28-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="cp">##define PM_TIMER_FREQUENCY  3579545</span>
</span><span id="__span-28-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a>
</span><span id="__span-28-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="nf">acpi_pm_tmr_get_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-28-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="p">{</span>
</span><span id="__span-28-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">muldiv64</span><span class="p">(</span><span class="n">qemu_clock_get_ns</span><span class="p">(</span><span class="n">QEMU_CLOCK_VIRTUAL</span><span class="p">),</span><span class="w"> </span><span class="n">PM_TIMER_FREQUENCY</span><span class="p">,</span>
</span><span id="__span-28-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">                    </span><span class="n">NANOSECONDS_PER_SECOND</span><span class="p">);</span>
</span><span id="__span-28-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>Linux 也可以把它当成一个时钟源：</p>
<div class="language-dmesg highlight"><pre><span></span><code><span id="__span-29-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="err">clocksource: acpi_pm: mask: 0xffffff max_cycles: 0xffffff, max_idle_ns: 2085701024 ns</span>
</span></code></pre></div>
<p>相关代码：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="cm">/*</span>
</span><span id="__span-30-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="cm"> * The I/O port the PMTMR resides at.</span>
</span><span id="__span-30-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="cm"> * The location is detected during setup_arch(),</span>
</span><span id="__span-30-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-4" id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="cm"> * in arch/i386/kernel/acpi/boot.c</span>
</span><span id="__span-30-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-5" id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="cm"> */</span>
</span><span id="__span-30-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-6" id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="n">u32</span><span class="w"> </span><span class="n">pmtmr_ioport</span><span class="w"> </span><span class="n">__read_mostly</span><span class="p">;</span>
</span><span id="__span-30-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-7" id="__codelineno-30-7" name="__codelineno-30-7"></a>
</span><span id="__span-30-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-8" id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="nf">read_pmtmr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-30-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-9" id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="p">{</span>
</span><span id="__span-30-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-10" id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="cm">/* mask the output to 24 bits */</span>
</span><span id="__span-30-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-11" id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">inl</span><span class="p">(</span><span class="n">pmtmr_ioport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ACPI_PM_MASK</span><span class="p">;</span>
</span><span id="__span-30-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-12" id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="p">}</span>
</span><span id="__span-30-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-13" id="__codelineno-30-13" name="__codelineno-30-13"></a>
</span><span id="__span-30-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-14" id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="k">static</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="nf">acpi_pm_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="o">*</span><span class="n">cs</span><span class="p">)</span>
</span><span id="__span-30-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-15" id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="p">{</span>
</span><span id="__span-30-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-16" id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">read_pmtmr</span><span class="p">();</span>
</span><span id="__span-30-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-17" id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="p">}</span>
</span><span id="__span-30-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-18" id="__codelineno-30-18" name="__codelineno-30-18"></a>
</span><span id="__span-30-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-19" id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">clocksource</span><span class="w"> </span><span class="n">clocksource_acpi_pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-20" id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">    </span><span class="p">.</span><span class="n">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">"acpi_pm"</span><span class="p">,</span>
</span><span id="__span-30-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-21" id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="p">.</span><span class="n">rating</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-30-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-22" id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="w">    </span><span class="p">.</span><span class="n">read</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pm_read</span><span class="p">,</span>
</span><span id="__span-30-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-23" id="__codelineno-30-23" name="__codelineno-30-23"></a><span class="w">    </span><span class="p">.</span><span class="n">mask</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ACPI_PM_MASK</span><span class="p">,</span>
</span><span id="__span-30-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-24" id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">CLOCK_SOURCE_IS_CONTINUOUS</span><span class="p">,</span>
</span><span id="__span-30-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-25" id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="p">};</span>
</span><span id="__span-30-26"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-26" id="__codelineno-30-26" name="__codelineno-30-26"></a>
</span><span id="__span-30-27"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-27" id="__codelineno-30-27" name="__codelineno-30-27"></a><span class="cm">/* Number of PMTMR ticks expected during calibration run */</span>
</span><span id="__span-30-28"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-28" id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="cp">##define PMTMR_TICKS_PER_SEC 3579545</span>
</span><span id="__span-30-29"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-29" id="__codelineno-30-29" name="__codelineno-30-29"></a>
</span><span id="__span-30-30"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-30" id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_acpi_pm_clocksource</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-30-31"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-31" id="__codelineno-30-31" name="__codelineno-30-31"></a><span class="p">{</span>
</span><span id="__span-30-32"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-32" id="__codelineno-30-32" name="__codelineno-30-32"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-30-33"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-33" id="__codelineno-30-33" name="__codelineno-30-33"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clocksource_register_hz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clocksource_acpi_pm</span><span class="p">,</span>
</span><span id="__span-30-34"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-34" id="__codelineno-30-34" name="__codelineno-30-34"></a><span class="w">                        </span><span class="n">PMTMR_TICKS_PER_SEC</span><span class="p">);</span>
</span><span id="__span-30-35"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-30-35" id="__codelineno-30-35" name="__codelineno-30-35"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="gpe"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#gpe">GPE</a></h4>
<p>除了上面 PM1 中提到的一些中断来源，ACPI 还提供了通用的 General Purpose Event，硬件可以自定义一些中断编号，依然是通过 SCI 中断通知操作系统，操作系统根据 GPE 的 STS 寄存器来判断哪个 GPE 触发了中断，然后执行对应的 ACPI 函数。GPE 的地址也是在 FADT 中提供：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a>[050h 0080   4]           GPE0 Block Address : 0000AFE0
</span><span id="__span-31-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a>
</span><span id="__span-31-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a>[05Ch 0092   1]            GPE0 Block Length : 04
</span></code></pre></div>
<p>在 DSDT 的 <code>\_GPE</code> 下面，可以定义函数，在 GPE 到达的时候，会被操作系统执行。格式是 <code>\_GPE._Exx</code> 或 <code>\_GPE._Lxx</code>，E 表示 Edge sensitive，L 表示 Level sensitive。例如操作系统判断收到了 GPE 4，那可能会执行 <code>\_GPE._L04</code> 或 <code>\_GPE._E04</code> 函数。</p>
<h3 id="pcie-hot-plug"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#pcie-hot-plug">PCIe Hot Plug</a></h3>
<p>在 QEMU 中，如果虚拟机要进行 PCIe Hot Plug 的时候，例如要增加 PCIe 设备，或者删除已有的 PCIe 设备，需要设法通知操作系统，告知操作系统哪个地方有新的设备，或者哪个已有的设备被弹出。QEMU 的实现文档是<a href="https://www.qemu.org/docs/master/specs/acpi_pci_hotplug.html">QEMU&lt;-&gt;ACPI BIOS PCI hotplug interface</a>，这里结合代码来解释一下。</p>
<p>在 QEMU 中，要插入一个新的 PCIe 设备的时候，按照设备的 bus 和 slot 设置位为 1，并且发送 GPE：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-32-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_pcihp_device_plug_cb</span><span class="p">(</span><span class="n">HotplugHandler</span><span class="w"> </span><span class="o">*</span><span class="n">hotplug_dev</span><span class="p">,</span><span class="w"> </span><span class="n">AcpiPciHpState</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">,</span>
</span><span id="__span-32-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">                               </span><span class="n">DeviceState</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="o">**</span><span class="n">errp</span><span class="p">)</span>
</span><span id="__span-32-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="p">{</span>
</span><span id="__span-32-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-4" id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-32-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-5" id="__codelineno-32-5" name="__codelineno-32-5"></a>
</span><span id="__span-32-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-6" id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">    </span><span class="n">bsel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acpi_pcihp_get_bsel</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
</span><span id="__span-32-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-7" id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">    </span><span class="n">g_assert</span><span class="p">(</span><span class="n">bsel</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-32-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-8" id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slot</span><span class="p">);</span>
</span><span id="__span-32-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-9" id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="n">acpi_send_event</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">(</span><span class="n">hotplug_dev</span><span class="p">),</span><span class="w"> </span><span class="n">ACPI_PCI_HOTPLUG_STATUS</span><span class="p">);</span>
</span><span id="__span-32-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-10" id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="p">}</span>
</span><span id="__span-32-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-11" id="__codelineno-32-11" name="__codelineno-32-11"></a>
</span><span id="__span-32-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-12" id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="c1">// acpi_send_event eventually calls piix4_send_gpe</span>
</span><span id="__span-32-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-13" id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">piix4_send_gpe</span><span class="p">(</span><span class="n">AcpiDeviceIf</span><span class="w"> </span><span class="o">*</span><span class="n">adev</span><span class="p">,</span><span class="w"> </span><span class="n">AcpiEventStatusBits</span><span class="w"> </span><span class="n">ev</span><span class="p">)</span>
</span><span id="__span-32-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-14" id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="p">{</span>
</span><span id="__span-32-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-15" id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="w">    </span><span class="n">PIIX4PMState</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PIIX4_PM</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
</span><span id="__span-32-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-16" id="__codelineno-32-16" name="__codelineno-32-16"></a>
</span><span id="__span-32-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-17" id="__codelineno-32-17" name="__codelineno-32-17"></a><span class="w">    </span><span class="n">acpi_send_gpe_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">ev</span><span class="p">);</span>
</span><span id="__span-32-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-18" id="__codelineno-32-18" name="__codelineno-32-18"></a><span class="p">}</span>
</span><span id="__span-32-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-19" id="__codelineno-32-19" name="__codelineno-32-19"></a>
</span><span id="__span-32-20"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-20" id="__codelineno-32-20" name="__codelineno-32-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">acpi_send_gpe_event</span><span class="p">(</span><span class="n">ACPIREGS</span><span class="w"> </span><span class="o">*</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">qemu_irq</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span>
</span><span id="__span-32-21"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-21" id="__codelineno-32-21" name="__codelineno-32-21"></a><span class="w">                         </span><span class="n">AcpiEventStatusBits</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
</span><span id="__span-32-22"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-22" id="__codelineno-32-22" name="__codelineno-32-22"></a><span class="p">{</span>
</span><span id="__span-32-23"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-23" id="__codelineno-32-23" name="__codelineno-32-23"></a><span class="w">    </span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">gpe</span><span class="p">.</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-32-24"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-24" id="__codelineno-32-24" name="__codelineno-32-24"></a><span class="w">    </span><span class="n">acpi_update_sci</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="w"> </span><span class="n">irq</span><span class="p">);</span>
</span><span id="__span-32-25"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-32-25" id="__codelineno-32-25" name="__codelineno-32-25"></a><span class="p">}</span>
</span></code></pre></div>
<p>查看头文件，可知 <code>ACPI_PCI_HOTPLUG_STATUS=2</code>，根据上面的代码，可知这实际上就是发送了 GPE1。操作系统会执行 <code>\_GPE._E01</code> 函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="n">Scope</span><span class="w"> </span><span class="p">(</span><span class="n">_GPE</span><span class="p">)</span>
</span><span id="__span-33-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="p">{</span>
</span><span id="__span-33-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">_HID</span><span class="p">,</span><span class="w"> </span><span class="s">"ACPI0006"</span><span class="w"> </span><span class="cm">/* GPE Block Device */</span><span class="p">)</span><span class="w">  </span><span class="c1">// _HID: Hardware ID</span>
</span><span id="__span-33-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-4" id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">_E01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span><span class="w">  </span><span class="c1">// _Exx: Edge-Triggered GPE, xx=0x00-0xFF</span>
</span><span id="__span-33-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-5" id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-33-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-6" id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">        </span><span class="n">Acquire</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">BLCK</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">)</span>
</span><span id="__span-33-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-7" id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">        </span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">PCNT</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="c1">// PCIe Notify</span>
</span><span id="__span-33-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-8" id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">        </span><span class="n">Release</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="n">_SB</span><span class="p">.</span><span class="n">PCI0</span><span class="p">.</span><span class="n">BLCK</span><span class="p">)</span>
</span><span id="__span-33-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-9" id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-33-10" id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>这个代码上了锁，然后调用 <code>\_SB.PCI0.PCNT</code> 函数，<code>PCNT</code> 函数定义如下：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="c1">// PCIe Status</span>
</span><span id="__span-34-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="n">OperationRegion</span><span class="w"> </span><span class="p">(</span><span class="n">PCST</span><span class="p">,</span><span class="w"> </span><span class="n">SystemIO</span><span class="p">,</span><span class="w"> </span><span class="mh">0xAE00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">)</span>
</span><span id="__span-34-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-3" id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="n">Field</span><span class="w"> </span><span class="p">(</span><span class="n">PCST</span><span class="p">,</span><span class="w"> </span><span class="n">DWordAcc</span><span class="p">,</span><span class="w"> </span><span class="n">NoLock</span><span class="p">,</span><span class="w"> </span><span class="n">WriteAsZeros</span><span class="p">)</span>
</span><span id="__span-34-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-4" id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="p">{</span>
</span><span id="__span-34-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-5" id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="n">PCIU</span><span class="p">,</span><span class="w">   </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="c1">// Up</span>
</span><span id="__span-34-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-6" id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">    </span><span class="n">PCID</span><span class="p">,</span><span class="w">   </span><span class="mi">32</span><span class="w">  </span><span class="c1">// Down</span>
</span><span id="__span-34-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-7" id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="p">}</span>
</span><span id="__span-34-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-8" id="__codelineno-34-8" name="__codelineno-34-8"></a>
</span><span id="__span-34-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-9" id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="c1">// PCIe Notify</span>
</span><span id="__span-34-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-10" id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">PCNT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-34-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-11" id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="p">{</span>
</span><span id="__span-34-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-12" id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">    </span><span class="n">BNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="c1">// Bus Num = 0</span>
</span><span id="__span-34-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-13" id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCIU</span><span class="p">,</span><span class="w"> </span><span class="n">One</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify</span>
</span><span id="__span-34-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-14" id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify</span>
</span><span id="__span-34-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-34-15" id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>上面的代码中，PCIU 的意思是 PCIe Up，就是新出现的设备；PCID 的意思是 PCIe Down，就是要删除的设备。PCIU 和 PCID 都要通过 IO Port 访问，根据上面的 <code>OperationRegion</code> 可知 <code>PCIU=0xAE00</code>，<code>PCID=0xAE04</code>。你可能已经猜到了 <code>PCIU</code> 和 <code>PCID</code> 的实现：当 CPU 读取这两个 IO Port 的时候，就会返回前面 <code>acpi_pcihp_device_plug_cb</code> 函数写入的 <code>acpi_pcihp_pci_status</code> 数组：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-35-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">pci_read</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">hwaddr</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-35-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="p">{</span>
</span><span id="__span-35-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-3" id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-35-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-4" id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-5" id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PCI_UP_BASE</span><span class="p">:</span>
</span><span id="__span-35-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-6" id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="p">;</span>
</span><span id="__span-35-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-7" id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">legacy_piix</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-8" id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">            </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-35-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-9" id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-35-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-10" id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">        </span><span class="n">trace_acpi_pci_up_read</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-35-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-11" id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-35-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-12" id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PCI_DOWN_BASE</span><span class="p">:</span>
</span><span id="__span-35-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-13" id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">acpi_pcihp_pci_status</span><span class="p">[</span><span class="n">bsel</span><span class="p">].</span><span class="n">down</span><span class="p">;</span>
</span><span id="__span-35-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-14" id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">        </span><span class="n">trace_acpi_pci_down_read</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-35-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-15" id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-35-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-16" id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-17" id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-35-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-35-18" id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>因此在 <code>PCNT</code> 函数中，读取 <code>PCIU</code> 和 <code>PCID</code> 就可以知道一个 Bitmap，记录了哪些设备出现了变化。最后一步就是通知操作系统了。在 ACPI 中，可以调用 <code>Notify</code> 函数，用于通知操作系统，通知的参数见 Table 5.187，这里列出来前面几种：</p>
<ul>
<li>0: Bus Check, This notification is performed on a device object to indicate to OSPM that it needs to perform a Plug and Play re-enumeration operation on the device tree starting from the point where it has been notified</li>
<li>1: Device Check, Used to notify OSPM that the device either appeared or disappeared. If the device has appeared, OSPM will re-enumerate from the parent.</li>
<li>2: Device Wake, Used to notify OSPM that the device has signaled its wake event, and that OSPM needs to notify OSPM native device driver for the device.</li>
<li>3: Eject Request, Used to notify OSPM that the device should be ejected, and that OSPM needs to perform the Plug and Play ejection operation.</li>
</ul>
<p><code>PCNT</code> 函数调用 <code>DVNT</code> 函数来进行最终的 <code>Notify</code>，对于 PCI Up，需要发送 1(Device Check) 让操作系统新的设备出现；对于 PCI Down，需要发送 3(Eject Request) 让操作系统弹出设备。这就解释了 <code>PCNT</code> 为什么要这样实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="c1">// PCIe Notify</span>
</span><span id="__span-36-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">PCNT</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-36-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="p">{</span>
</span><span id="__span-36-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">    </span><span class="n">BNUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zero</span><span class="w"> </span><span class="c1">// Bus Num = 0</span>
</span><span id="__span-36-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-5" id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCIU</span><span class="p">,</span><span class="w"> </span><span class="n">One</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify(1=Device Check)</span>
</span><span id="__span-36-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-6" id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">    </span><span class="n">DVNT</span><span class="w"> </span><span class="p">(</span><span class="n">PCID</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">)</span><span class="w"> </span><span class="c1">// Device Notify(3=Eject Request)</span>
</span><span id="__span-36-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-36-7" id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>DVNT</code> 的实现方法很粗暴，就是检查各个位，然后发送 <code>Notify</code> 到相应的 PCIe Slot 上：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-37-1"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="c1">// Device Notify</span>
</span><span id="__span-37-2"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="n">Method</span><span class="w"> </span><span class="p">(</span><span class="n">DVNT</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">NotSerialized</span><span class="p">)</span>
</span><span id="__span-37-3"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-3" id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="p">{</span>
</span><span id="__span-37-4"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-4" id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x08</span><span class="p">))</span>
</span><span id="__span-37-5"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-5" id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-6"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-6" id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S18</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-7"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-7" id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-8"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-8" id="__codelineno-37-8" name="__codelineno-37-8"></a>
</span><span id="__span-37-9"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-9" id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x10</span><span class="p">))</span>
</span><span id="__span-37-10"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-10" id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-11"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-11" id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S20</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-12"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-12" id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-13"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-13" id="__codelineno-37-13" name="__codelineno-37-13"></a>
</span><span id="__span-37-14"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-14" id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">    </span><span class="n">If</span><span class="w"> </span><span class="p">((</span><span class="n">Arg0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x20</span><span class="p">))</span>
</span><span id="__span-37-15"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-15" id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-37-16"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-16" id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="w">        </span><span class="n">Notify</span><span class="w"> </span><span class="p">(</span><span class="n">S28</span><span class="p">,</span><span class="w"> </span><span class="n">Arg1</span><span class="p">)</span>
</span><span id="__span-37-17"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-17" id="__codelineno-37-17" name="__codelineno-37-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-18"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-18" id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="w">    </span><span class="c1">// omitted</span>
</span><span id="__span-37-19"><a href="../../hardware/2022/12/10/acpi-notes/#__codelineno-37-19" id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就完成了整个 PCIe Hot Plug 的过程。回顾一下：</p>
<ul>
<li>QEMU 要进行 PCIe Hot Plug</li>
<li>QEMU 记录要 Hot Plug 设备到数组中</li>
<li>QEMU 发送 GPE</li>
<li>OS 执行 GPE 1 Handler</li>
<li>Handler 读取 PCIU/PCID，根据 Bitmap 去 Notify</li>
<li>OS 根据 Notify 的设备进行对应的操作</li>
</ul>
<p>可以看到，大部分的工作其实是 QEMU 完成的，OS 只需要在收到 SCI 的时候，判断是 GPE 1 事件，执行对应的处理函数，等待 Notify 的到来。</p>
<h3 id="power-state"><a class="toclink" href="../../hardware/2022/12/10/acpi-notes/#power-state">Power State</a></h3>
<p>ACPI 定义的 Power State：</p>
<p><img alt="" src="/images/acpi_power.png"/></p>
<ul>
<li>G0-G3: 全局状态，G0 表示正在工作</li>
<li>S0-S5：睡眠状态，S0 表示正在工作，S5 表示关机</li>
<li>D0-D3：设备状态</li>
<li>C0-Cn：CPU 状态</li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/12/10/acpi-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-12-06 00:00:00">2022年12月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="infiniband"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/">InfiniBand 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/networking/infiniband.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_1">参考文献</a></h3>
<ul>
<li><a href="https://www.snia.org/sites/default/files/files2/files2/SDC2013/presentations/Hardware/DavidDeming_Infiniband_Architectural_Overview.pdf">Infiniband Architecture Overview</a></li>
<li><a href="https://www.afs.enea.it/asantoro/V1r1_2_1.Release_12062007.pdf">InfiniBand Architecture Specification Volume 1 Release 1.2.1</a></li>
<li><a href="https://cw.infinibandta.org/document/dl/8566">InfiniBand Architecture Specification Volume 2 Release 1.4</a></li>
<li><a href="https://cali-doc.unilim.fr/_media/mpi/intel-mpi/infinibandchap42.pdf">An Introduction to the InfiniBand Architecture</a></li>
<li>InfiniBand Network Architecture - MindShare</li>
<li><a href="https://wiki.archlinux.org/title/InfiniBand">ArchWiki - InfiniBand</a></li>
</ul>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_2">概览</a></h3>
<p>InfiniBand 的网络分为两层，第一层是由 End Node 和 Switch 组成的 Subnet，第二层是由 Router 连接起来的若干个 Subnet。有点类似以太网以及 IP 的关系，同一个二层内通过 MAC 地址转发，三层间通过 IP 地址转发。</p>
<p>在 IB 网络中，End Node 一般是插在结点上的 IB 卡（Host Channel Adapter，HCA）或者是存储结点上的 Target Channel Adapter。End Node 之间通过 Switch 连接成一个 Subnet，由 Subnet Manager 给每个 Node 和 Switch 分配 Local ID，同一个 Subnet 中通过 LID（Local ID）来路由。但是 LID 位数有限，为了进一步扩展，可以用 Router 连接多个 Subnet，此时要通过 GID（Global ID）来路由。</p>
<p><img alt="" src="/images/iba.png"/></p>
<p><img alt="" src="/images/ib_am.png"/></p>
<h3 id="queue-pair"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#queue-pair">Queue Pair</a></h3>
<p>回顾一下，以太网网卡在传输的时候，涉及到两类队列，分别用于发送和接收，由操作系统来负责维护。当要发送的时候，操作系统向发送队列上插入一项，并提供要发送的数据的指针，然后让网卡自己进行 DMA 并发送；同时，操作系统也会分配一些缓冲区，填入接收队列，当网卡接收到新的数据的时候，就会进行 DMA 把数据填入缓冲区，然后通过中断让操作系统去进行处理。</p>
<p>在 IB 中，也有类似的概念，就是 Queue Pair（QP），其实就是 Send Queue 和 Receive Queue 成对出现。另外还有 Completion Queue，当请求完成的时候，会在 CQ 上得到结果。</p>
<p><img alt="" src="/images/ib_qp.png"/></p>
<h3 id="transport-functions"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#transport-functions">Transport Functions</a></h3>
<p>有了 Queue Pair 以后，上层应用就可以进行一些操作了：</p>
<ul>
<li>SEND：发送数据</li>
<li>RESYNC：同步 PSN</li>
<li>RDMA WRITE：远程写入内存</li>
<li>RDMA READ：远程读取内存</li>
<li>ATOMIC：远程进行内存原子操作</li>
</ul>
<p>有发就有收，接收方需要在 Receive Queue 中准备好接受数据的缓冲区。</p>
<p>此外，为了在保证安全性以及正确性的前提下，允许 RDMA 操作，应用需要首先进行 Memory Binding 操作，标记哪些内存区域可以通过 RDMA 访问，并且生成一个 <code>R_KEY</code> 来标记这片内存区域。之后的 RDMA WRITE 和 RDMA READ 需要使用同样的 <code>R_KEY</code> 来进行访问。</p>
<h3 id="transport-services"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#transport-services">Transport Services</a></h3>
<p>IB 支持四种 Transport Service，当 QP 在创建的时候，就需要从以下的四种中选择：</p>
<ol>
<li>Reliable Connection(RC)</li>
<li>Reliable Datagram(RD)</li>
<li>Unreliable Datagram(UD)</li>
<li>Unreliable Connection(UC)</li>
</ol>
<p>对于 IPoIB 等传输其他协议的情况，也可以直接封装：</p>
<ol>
<li>Raw IPv6 Datagram</li>
<li>Raw Ethertype Datagram</li>
</ol>
<p>几种 Transport Service 的对比：</p>
<p><img alt="" src="/images/ib_comparison.png"/></p>
<p>在编程的时候，需要知道对端的 LID（Local ID）、QPN（Queue Pair Number）和 PSN（Packet Sequence Number），才能进行通信。如果要进行 RDMA，还需要知道 <code>R_Key</code> 和内存地址。这些信息一般是通过 TCP 来传输的。</p>
<h3 id="switches"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#switches">Switches</a></h3>
<p>在 IB 网络中，交换机用来连接同一个 IB Subnet 中的 End Node。在 Subnet 中，通过 Local ID 来路由，而 Local ID 是由 Subnet Manager 负责分配的。Subnet Manager 扫描网络中的交换机和节点，动态分配 LID，并且根据网络拓扑，计算出交换机的转发表。</p>
<p>交换机的转发表就是一个 LID 到端口号的映射，可以实现为线性表（数组，下标是 LID）或随机访问表（CAM，用 LID 查端口号）。</p>
<p>由于 LID 唯一确定了转发路径，所以如果网络有冗余，从一个 End Node 到另一个 End Node 有多条路径，那么为了利用上不同路径的带宽，每条路径都要分配一个 LID。为了简化，在分配的时候，Subnet Manager 会分配一段连续的 LID，具体来说，是 <code>2^{LMC}</code> 个，LMC 是 LID Mask Control，表示低多少位 Mask 掉属于同一个 Endpoint。例如 Base LID=4，LMC=2，那么实际上分配的 LID 是 <code>{4,5,6,7}</code>。</p>
<p>opensm 的 LID 分配算法可以在<a href="https://github.com/linux-rdma/opensm/blob/844ab3b7edaad983449b5d3a4a773088b8daa299/opensm/osm_lid_mgr.c#L290">代码</a>中找到。</p>
<p>LID 是一个 16 位的整数，所以同一个 Subnet 中可以连接的设备数量有限。更多的话就需要多个 Subnet。LID 定义：</p>
<ul>
<li>0x0000：Reserved</li>
<li>0xFFFF：Permissive，目标 QP0</li>
<li>0x0001-0xBFFF：Unicast</li>
<li>0xC000-0xFFFE：Multicast</li>
</ul>
<p>如果想要做隔离，可以创建一个 Partition，类似 VLAN 的概念，通过 <code>P_Key</code> 来判断是否属于同一个 Partition。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/12/06/infiniband-notes/#_3">常用命令</a></h3>
<p>常用的可以用来调试 IB 的命令：</p>
<ul>
<li>ibstat</li>
<li>ibhosts</li>
<li>ibswitches</li>
<li>iblinkinfo</li>
<li>ibping</li>
<li>ibdiagnet</li>
<li>qperf</li>
</ul>
<p>使用 qperf/ib_send_lat 可以测量带宽和延迟。一个测试例子：</p>
<ul>
<li>以太网（udp_lat）：24.5 us</li>
<li>IPoIB (udp_lat): 8.7 us</li>
<li>IB (rc, ib_send_lat): 1.02 us</li>
<li>IB (rc_lat): 3.6 ~ 4.6 us</li>
<li>IB (uc_lat): 4.2 ~ 5.5 us</li>
<li>IB (ud_lat): 5.5 ~ 6.4 us</li>
</ul>
<nav class="md-post__action">
<a href="../../hardware/2022/12/06/infiniband-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-11-23 00:00:00">2022年11月23日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="mellanox"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/">升级 Mellanox 网卡固件</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_1">背景</a></h3>
<p>最近发现有一台机器，插上 ConnectX-4 IB 网卡后，内核模块可以识别到设备，但是无法使用，现象是 <code>ibstat</code> 等命令都看不到设备。降级 OFED 从 5.8 到 5.4 以后问题消失，所以认为可能是新的 OFED 与比较旧的固件版本有兼容性问题，所以尝试升级网卡固件。升级以后，问题就消失了。</p>
<h3 id="mft"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#mft">安装 MFT</a></h3>
<p>首先，在 https://network.nvidia.com/products/adapter-software/firmware-tools/ 下载 MFT，按照指示解压，安装后，启动 mst 服务，就可以使用 <code>mlxfwmanager</code> 得到网卡的型号以及固件版本：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Device Type: ConnectX4
</span><span id="__span-0-2"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>Description: Mellanox ConnectX-4 Single Port EDR PCIE Adapter LP
</span><span id="__span-0-3"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>PSID:        DEL2180110032
</span><span id="__span-0-4"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>Versions:    Current
</span><span id="__span-0-5"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>  FW         12.20.1820
</span></code></pre></div>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_2">升级固件</a></h3>
<p>从 PSID 可以看到，这是 DELL OEM 版本的网卡，可以在 https://network.nvidia.com/support/firmware/dell/ 处寻找最新固件，注意需要保证 PSID 一致，可以找到这个 PSID 的 DELL 固件地址：https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin.zip。</p>
<p>下载以后，解压，然后就可以升级固件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>mlxfwmanager<span class="w"> </span>-u<span class="w"> </span>-i<span class="w"> </span>fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin
</span></code></pre></div>
<p>升级以后重启就工作了。</p>
<p>考虑到类似的情况之后还可能发生，顺便还升级了其他几台机器的网卡，下面是一个例子：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Device Type: ConnectX4
</span><span id="__span-2-2"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>Description: ConnectX-4 VPI adapter card; FDR IB (56Gb/s) and 40GbE; dual-port QSFP28; PCIe3.0 x8; ROHS R6
</span><span id="__span-2-3"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>PSID:        MT_2170110021
</span><span id="__span-2-4"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>Versions:    Current
</span><span id="__span-2-5"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>  FW         12.25.1020
</span></code></pre></div>
<p>注意这里的 PSID 是 MT_ 开头，说明是官方版本。这个型号可以在 https://network.nvidia.com/support/firmware/connectx4ib/ 找到最新的固件，注意 PSID 要正确，可以找到固件下载地址 https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_2006-MCX454A-FCA_Ax-UEFI-14.21.17-FlexBoot-3.6.102.bin.zip。用同样的方法更新即可。</p>
<p>还有一个 ConnectX-3 的例子：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>Device Type: ConnectX3
</span><span id="__span-3-2"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Description: ConnectX-3 VPI adapter card; single-port QSFP; FDR IB (56Gb/s) and 40GigE; PCIe3.0 x8 8GT/s; RoHS R6
</span><span id="__span-3-3"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>PSID:        MT_1100120019
</span><span id="__span-3-4"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>Versions:    Current
</span><span id="__span-3-5"><a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>  FW         2.36.5150
</span></code></pre></div>
<p>ConnectX-3 系列的网卡固件可以在 https://network.nvidia.com/support/firmware/connectx3ib/ 找，根据 PSID，可以找到固件下载地址是 http://www.mellanox.com/downloads/firmware/fw-ConnectX3-rel-2_42_5000-MCX353A-FCB_A2-A5-FlexBoot-3.4.752.bin.zip。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/11/23/upgrade-mlnx-firmware/#_3">小结</a></h3>
<p>如果遇到 Mellanox 网卡能识别 PCIe，但是不能使用，可以考虑降级 OFED 或者升级网卡固件。</p>
<p>可以用 mlxfwmanager 查看 PSID 和更新固件。根据 PSID，判断是 OEM（DELL）版本还是官方版本。如果是 OEM 版本，要到对应 OEM 的固件下载地址找，例如 https://network.nvidia.com/support/firmware/dell/；如果是官方版，在 https://network.nvidia.com/support/firmware/firmware-downloads/ 找。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/11/23/upgrade-mlnx-firmware/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <a class="md-pagination__link" href="../2/">2</a> <a class="md-pagination__link" href="../3/">3</a> <span class="md-pagination__current">4</span> <a class="md-pagination__link" href="../5/">5</a> <a class="md-pagination__link" href="../6/">6</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>