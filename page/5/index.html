
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/page/5/" rel="canonical"/>
<link href="../../about/" rel="next"/>
<link href="../../feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="../../feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>博客 - 杰哥的{运维,编程,调板子}小笔记</title>
<link href="../../assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../..">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    博客
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1"><a class="toclink" href="#_1">博客</a></h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-11-20 00:00:00">2022年11月20日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="cxl"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/">CXL 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_1">背景</a></h3>
<p>前段时间学习了 PCIe，趁此机会，进一步学习一下密切相关的 CXL。</p>
<p>CXL 的标准是公开下载的：https://www.computeexpresslink.org/download-the-specification，我目前参考的是 2022 年 8 月 1 日的 CXL 3.0 版本。</p>
<h3 id="cxl_1"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxl_1">CXL 设备类型</a></h3>
<p>CXL 对 PCIe 的重要的扩展，一是在于让设备可以和 CPU 实现缓存一致性（CXL.cache），二是可以做远程的内存（CXL.mem）。</p>
<p>具体下来，CXL 标准主要定义了三类设备：</p>
<ul>
<li>CXL Type 1: 设备带有与 CPU 一致的缓存，实现 CXL.io 和 CXL.cache</li>
<li>CXL Type 2: 设备带有自己的内存和与 CPU 一致的缓存，实现 CXL.io，CXL.cache 和 CXL.mem</li>
<li>CXL Type 3: 设备带有自己的内存，实现 CXL.io 和 CXL.mem</li>
</ul>
<h3 id="cxl_2"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxl_2">CXL 传输层</a></h3>
<h4 id="cxlio"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlio">CXL.io</a></h4>
<p>CXL.io 基本上就是 PCIe 协议：</p>
<div class="language-text highlight"><pre><span></span><code>CXL.io provides a non-coherent load/store interface for I/O devices. Figure
3-1 shows where the CXL.io transaction layer exists in the Flex Bus layered
hierarchy. Transaction types, transaction packet formatting, credit-based
flow control, virtual channel management, and transaction ordering rules
follow the PCIe* definition; please refer to the “Transaction Layer
Specification” chapter of PCIe Base Specification for details. This chapter
highlights notable PCIe operational modes or features that are used for
CXL.io.
</code></pre></div>
<p>CXL 3.0 速度是 64.0 GT/s，使用 PAM4 编码，对应的是 PCIe 6.0。</p>
<h4 id="cxlcache"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlcache">CXL.cache</a></h4>
<p>CXL.cache 每个方向上有三个 channel：请求，响应和数据。考虑到 Host 和 Device 的传输方向，就是六个 channel：D2H Req，D2H Resp，D2H Data，H2D Req，H2D Resp，H2D Data。在 Data channel 上传输的缓存行大小是 64 字节。</p>
<p>CXL.cache 的缓存行状态采用的是 MESI。</p>
<p>CXL.cache 传输有三种模式：68B Flit，256B Flit 和 PBR Flit。</p>
<p>H2D Request 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li><code>Address[51:6]</code>: 物理地址</li>
<li>UQID: Unique Queue ID</li>
<li>CacheID: Only in 256B Flit</li>
<li>SPID/DPID: Only in PBR Flit</li>
</ul>
<p>D2H Response 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>UQID: Unique Queue ID</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>D2H Data 的字段：</p>
<ul>
<li>Valid</li>
<li>UQID: Unique Queue ID</li>
<li>ChunkValid: Only in 68B Flit</li>
<li>Bogus</li>
<li>Poison: data is corrupted</li>
<li>BEP: Only in 256B Flit &amp; PBR Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>D2H Request 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>CQID: Command Queue ID</li>
<li>NT: Non Temporal</li>
<li>CacheID: Only in 256B Flit</li>
<li>Address: 46 位物理地址</li>
<li>SPID/DPID: Only in PBR Flit</li>
</ul>
<p>H2D Response 的字段：</p>
<ul>
<li>Valid</li>
<li>Opcode</li>
<li>RspData</li>
<li>RSP_PRE</li>
<li>CQID: Command Queue ID</li>
<li>CacheID: Only in 256B Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<p>H2D Data 的字段：</p>
<ul>
<li>Valid</li>
<li>CQID: Command Queue ID</li>
<li>ChunkValid: Only in 68B Flit</li>
<li>Bogus</li>
<li>GO-Err</li>
<li>CacheID: Only in 256B Flit</li>
<li>DPID: Only in PBR Flit</li>
</ul>
<h5 id="_2"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_2">请求类型</a></h5>
<p>首先考虑 Host 会发送的请求。</p>
<p>第一种是 SnpData，例如在 Host 在读取的时候出现缺失，此时需要向 Device 发送 Snoop，获取最新的 Dirty 的 Data，或者让 Device 的缓存行降级为 Shared 状态。</p>
<p>Device 收到 SnpData 后，如果发现缓存行不在缓存中（状态是 I），会回复一个 RspIHitI；如果缓存行在缓存中且数据没有修改（状态是 S 或者 E），降级到 S，会回复一个 RspSHitSE；如果缓存行是 dirty（状态是 M），可以选择降级到 S，然后回复 RspSFwdM 以及缓存行的数据，也可以选择变成 Invalid，回复 RspIFwdM 以及缓存行的数据。</p>
<p>可以看到，这些 D2H Response 的 Opcode 的名字格式很有规律，<code>Rsp+A+Hit/Fwd+B</code>，A 表示新的缓存行状态，B 是原来的缓存行状态，Hit 不附带数据，Fwd 附带数据。</p>
<p>第二种是 SnpInv，例如 Host 要写入缓存，就要 invalidate 其他缓存。Device 收到以后，可能返回 RspIHitI、RspIHitSE 和 RspIFwdM，分别对应不同的初始状态，最终都是 Invalid 态。</p>
<p>第三种是 SnpCur，获取当前的缓存行状态。Device 可以修改缓存行状态，但是不建议。可能的返回有 RspIHitI，RspVHitV，RspSHitSE，RspSFwdM，RspIFwdM 和 RspVFwdV。这里的 V 表示 Valid，对应 MESI 中的 MES 三种状态。所以如果缓存行状态不变的话，就是 RspIHitI，RspVHitV 和 RspVFwdV 三种响应。</p>
<p>再考虑 Device 会发送的请求。首先，请求可以分为四类：</p>
<ol>
<li>Read：发送 D2H Request，接收 H2D Response 和 H2D Data</li>
<li>Read0：发送 D2H Request，接收 H2D Response</li>
<li>Write：发送 D2H Request，接收 H2D Response，发送 D2H Data，可选接收 H2D Response</li>
<li>
<p>Read0-Write：发送 D2H Request，接收 H2D Response，发送 D2H Data</p>
</li>
<li>
<p>RdCurr(Read)，Device 读取 Host 的缓存行，不造成任何的缓存状态的修改。Device 缓存还是处于 Invalid 状态。</p>
</li>
<li>RdOwn(Read)，Device 读取 Host 的缓存行，可以进入 E 态或者 M 态。Host 响应 GO-Err/GO-I/GO-E/GO-M。</li>
<li>RdShared(Read)，Device 读取 Host 的缓存行，进入 S 态。Host 响应 GO-Err/GO-I/GO-S。</li>
<li>RdAny(Read)，Device 读取 Host 的缓存行，进入 M 态，E 态或 S 态。Host 响应 GO-Err/GO-I/GO-S/GO-E/GO-M。</li>
<li>RdOwnNoData(Read0)，Device 不读取现在缓存行的数据，进入 E 态。一般用于整个缓存行的数据都要更新的情况，所以不需要或许当前缓存行的数据。</li>
<li>ItoMWr(Read0-Write)，Device 写入新的完整缓存行到 Host 中，并且进入 M 态。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>WrCur(Read0-Write)，和 ItoMWr 基本一样，区别在于，如果缓存行命中了，就写入到缓存中；如果缺失了，就写入到内存中。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>CLFlush(Read0)，要求 Host Invalidate 一个缓存行。Host 响应 GO-Err/GO-I。</li>
<li>CleanEvict(Write)，Device 要 Evict 一个 Exclusive 的缓存行。Host 响应 GO_WritePull/GO_WritePull_Drop。</li>
<li>DirtyEvict(Write)，Device 要 Evict 一个 Modified 的缓存行。Host 响应 GO_WritePull/GO_ERR_WritePull。</li>
<li>CleanEvictNoData(Write)，Device 要 Evict 一个 Exclusive 的缓存行，但是不传输数据，只用于更新 Snoop Filter。Host 响应 GO-I。</li>
<li>WrInv(Write)，Write Invalidate Line，向 Host 写入 0-64 字节的数据，并且 Invalidate 缓存。Host 响应 WritePull/GO-Err/GO-I。</li>
<li>WOWrInv(Write)，Weakly Ordered 版本的 WrInV，写入 0-63 字节的数据。Host 响应 ExtCmp/FastGO_WritePull/GO_ERR_WritePull。</li>
<li>WOWrInvF(Write)，Weakly Ordered 版本的 WrInv，写入 64 字节的数据。Host 响应 ExtCmp/FastGO_WritePull/GO_ERR_WritePull。</li>
<li>CacheFlushed(Read0)，告诉 Host 自己的缓存都被清空了，所有缓存行都在 I 状态。Host 响应 GO-I。</li>
</ol>
<h5 id="_3"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#_3">和其他协议的对比</a></h5>
<p>之前在 <a href="/hardware/2022/05/09/tilelink/#tilelink-cached">TileLink 总线协议分析</a> 分析过 TileLink 的缓存一致性实现方法，如果某一个缓存（Master A）出现了缺失，需要经过如下的过程：</p>
<ul>
<li>Master A -&gt; Slave: Acquire</li>
<li>Slave -&gt; Master B: Probe</li>
<li>Master B -&gt; Slave: ProbeAck</li>
<li>Slave -&gt; Master A: Grant</li>
<li>Master A -&gt; Slave: GrantAck</li>
</ul>
<p>在 TileLink Cached 里面，所有的 Master 都是平等的。而在 CXL 中，需要维护缓存一致性的，有 CPU 内部的各个缓存之间，还有 CPU 和设备之间。而 CXL.cache 主要负责的是与设备的缓存一致性部分，维护缓存一致性的核心是在 CPU 一侧，Host 相当于 TileLink 的 Slave，Device 相当于 TileLink 的 Master A。可以说 CXL.cache 是不对称的缓存一致性协议。</p>
<p>另一个相关的协议是 <a href="/hardware/2022/05/16/ace">ACE 缓存一致性协议</a>，和 TileLink 类似。</p>
<p>例如 CXL 中设备读取缓存的时候，出现了缺失，那么需要经过如下的过程：</p>
<ul>
<li>Device -&gt; Host: RdShared/RdOwn</li>
<li>Host -&gt; CPU Caches: Custom Snoop Messages</li>
<li>Host -&gt; Other CXL Device: SnpData</li>
<li>Other CXL Device -&gt; Host: RspSHitSE/RspSFwdM</li>
<li>Host -&gt; Device: GO-S</li>
</ul>
<p>可以看到，整体的流程也是差不多的。</p>
<h4 id="cxlmem"><a class="toclink" href="../../hardware/2022/11/20/cxl-notes/#cxlmem">CXL.mem</a></h4>
<p>CXL.mem 用于扩展内存，根据类型的不同，它可能单独使用，也可能和 CXL.cache 配合使用。具体来说，有三种一致性模型：</p>
<ol>
<li>HDM-H(Host-only Coherent)：仅 Type 3 设备，也就是无 CXL.cache</li>
<li>HDM-D(Device Coherent)：仅 Legacy Type 2 设备，也就是有 CXL.cache</li>
<li>HDM-DB(Device Coherent using Back-Invalidation)：Type 2 或 Type 3 设备</li>
</ol>
<p>在 CXL.cache 中，两端是 Host 和 Device；而 CXL.mem，两端是 Master 和 Subordinate。</p>
<p>从 Master 到 Subordinate 的消息（M2S）有三类：</p>
<ol>
<li>Request(Req)</li>
<li>Request with Data(RwD)</li>
<li>Back-Invalidation Response(BIRsp)</li>
</ol>
<p>从 Subordinate 到 Master 的消息（S2M）有三类：</p>
<ol>
<li>Response without data(NDR, No Data Response)</li>
<li>Response with Data(DRS, Data Response)</li>
<li>Back-Invalidation Snoop(BiSnp)</li>
</ol>
<p>其中比较特别的是 Back-Invalidation，这个的目的是让 Device 可以通过 Snoop 修改 Host 中缓存了 Device 内存中的数据的缓存行。</p>
<p>对于 Type 3 的设备（无 CXL.cache）来说，Device 就是一个扩展的内存，比较简单，只需要支持读写内存就可以了。Host 发送 <code>MemRd*</code>，Device 响应 MemData；Host 发送 <code>MemWr*</code>，Device 响应 Cmp。</p>
<p>对于 Type 2 的设备（有 CXL.cache）来说，Device 既有自己的缓存，又有自己的内存，所以这时候就比较复杂了。例如 Host 在读取数据的时候（MemRd，SnpData/SnpInv/SnpCur），还需要对 Device Cache 进行 Snoop（SnpData/SnpInv/SnpCur），保证缓存的一致性。Host 想要写入数据到 Device Memory 的时候，如果此时 Device Cache 中有 Dirty 数据，需要进行写合并，再把合并后的数据写入到 Device Memory。当 Device 想要从自己的缓存读取数据，又缺失的时候，首先需要判断数据在 Host 端的缓存中，还是在 Device Memory 中，不同的偏置（Bias）模式决定了数据应该放在 Host 还是 Device 的缓存上。Device 要写入数据的时候，如果 Host 中缓存了该缓存行，则需要 Back-Invalidation。为了支持这些场景，CXL.cache 和 CXL.mem 会比较复杂。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/11/20/cxl-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-11-12 00:00:00">2022年11月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 20 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="pcie"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/">PCIe 学习笔记</a></h2>
<p>本文的内容已经整合到<a href="/kb/hardware/pcie.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_1">背景</a></h3>
<p>最近在知乎上看到 <a href="https://www.zhihu.com/people/ljgibbs">LogicJitterGibbs</a> 的 <a href="https://zhuanlan.zhihu.com/p/447134701">资料整理：可以学习 1W 小时的 PCIe</a>，我跟着资料学习了一下，然后在这里记录一些我学习 PCIe 的笔记。</p>
<p>下面的图片主要来自 PCIe 3.0 标准以及 MindShare 的 PCIe 3.0 书本。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_2">分层</a></h3>
<p>PCIe 定义了三个层：Transaction Layer，Data Link Layer，Physical Layer，和 TCP/IP 四层模型很像。PCIe 也是基于 Packet 传输的。</p>
<p><img alt="" src="/images/pcie_layer.png"/></p>
<h4 id="transaction-layer"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#transaction-layer">Transaction Layer</a></h4>
<p>Transaction Layer 的核心是 Transaction Layer Packet(TLP)。TLP 格式：</p>
<p><img alt="" src="/images/pcie_tlp.png"/></p>
<p>即可选的若干个 Prefix，一个 Header，可选的 Data Payload，可选的 Digest。</p>
<p>Prefix 和 Header 开头的一个字节是 <code>Fmt[2:0]</code> 和 <code>Type[4:0]</code> 字段。Fmt 决定了 header 的长度，有无数据，或者这是一个 Prefix。</p>
<p>它支持几类 Packet：</p>
<ul>
<li>Memory: MMIO<ul>
<li>Read Request(MRd)/Completion(CplD)</li>
<li>Write Request(MWr): 注意只有 Request，没有 Completion</li>
<li>AtomicOp Request(FetchAdd/Swap/CAS)/Completion(CplD)</li>
<li>Locked Memory Read(MRdLk)/Completion(CplDLk): Legacy</li>
</ul>
</li>
<li>IO: Legacy<ul>
<li>Read Request(IORd)/Completion(CplD)</li>
<li>Write Request(IOWr)/Completion(Cpl)</li>
</ul>
</li>
<li>Configuration: 访问配置空间<ul>
<li>Read Request(CfgRd0/CfgRd1)/Completion(CplD)</li>
<li>Write Request(CfgWr0/CfgWr1)/Completion(Cpl)</li>
</ul>
</li>
<li>Message: 传输 event<ul>
<li>Request(Msg/MsgD)</li>
</ul>
</li>
</ul>
<p>括号里的是 TLP Type，对应了它 Fmt 和 Type 字段的取值。如果 Completion 失败了，原来应该是 CplD/CplDLk 的 Completion 会变成不带数据的 Cpl/CplLk。</p>
<p>在 PCIe 3.0 标准的表 2-3 中列出了 TLP Type 以及对应的 Fmt 和 Type 编码。</p>
<p>TLP 路由有三个方法，决定了这个 TLP 目的地是哪里：</p>
<ul>
<li>Address-based: 32 位或 64 位地址，用于 Memory 和 IO 请求</li>
<li>ID-based：lspci 看到的地址，也就是 Bus Device Function，用于 Configuration 请求</li>
<li>Implicit：用于 Message 请求，路由方法：<ul>
<li>Routed to Root Complex</li>
<li>Routed by Address: PCIe 3.0 标准中没有用这个路由方法的 Message</li>
<li>Routed by ID</li>
<li>Broadcast from Root Complex</li>
<li>Local - Terminate at Receiver</li>
<li>Gathered and router to Root Complex</li>
</ul>
</li>
</ul>
<h4 id="data-link-layer"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#data-link-layer">Data Link Layer</a></h4>
<p>Data Link Layer 的主要功能是进行 TLP 的可靠传输。它在传输 TLP 的时候，会在开头加上一个两字节的 Sequence Number，最后加上一个四字节的 LCRC（Link CRC）。</p>
<p><img alt="" src="/images/pcie_tlp_link.png"/></p>
<p>除了传输 TLP，Data Link Layer 还会传输 Data Link Layer Packet(DLLP)，类型包括：</p>
<ul>
<li>Ack DLLP: 告诉对方自己已经成功收到了 TLP</li>
<li>Nak DLLP：告诉对方自己接收 TLP 失败，请重试</li>
<li>InitFC1/InitFC2/UpdateFC DLLPs：流量控制</li>
<li>PM_Enter_L1/PM_Enter_L23/PM_Active_State_Request_L1/PM_Request_Ack：用于电源管理</li>
</ul>
<p>Data Link Layer 收到上层要发送 TLP 时候，首先拼接 Sequence Number 和 LCRC，然后会保存在 retry buffer 中，通过 Physical Layer 发送。从 Physical Layer 收到新的 TLP/DLLP 时，会检查它的完整性（CRC），如果正确，就向发送方发送一个 Ack DLLP，并把 TLP 提交给 Transaction Layer；如果不正确，就向发送方发送一个 Nak DLLP。如果收到了 Ack DLLP，就可以把相应的 TLP 从 retry buffer 中删掉；如果收到了 Nak DLLP，则要重传。这样就实现了 TLP 的可靠传输。</p>
<p>需要注意的是，TLP 和 DLLP 的区别：TLP 就像 IP，目的地址可能会跨越多跳；而 DLLP 是点对点地工作，所以一个 TLP 在转发的每一跳中，接受方都会发送一次 Ack DLLP。</p>
<p>Data Link Layer 的流量是 Credit-based 的：接受方会告诉发送方自己的 Buffer 还有多少空间（Credit），然后发送方根据 Credit 来控制是否继续发送 TLP。</p>
<h3 id="_3"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_3">配置</a></h3>
<p>接触 PCIe 的时候可能会有一个疑惑，就是这些 Bus Device Function 都是怎么分配的，分配完之后，访问请求又是怎么路由的。</p>
<h4 id="_4"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_4">路由</a></h4>
<p>首先回顾一下，上面提到了 TLP 的 Memory 和 IO 是根据地址路由，Configuration 是根据 Bus Device Function 路由，而 PCIe 大概是一个树形的结构，叶子结点就是 PCIe 设备，非叶子结点是桥或者交换机。回想一下，IP 的路由是按照最长前缀匹配，如果在 PCIe 中还这样做的话，又太过于复杂了，毕竟 PCIe 可以人为地设定每个设备的地址，让地址满足一定的连续性和局部性，这样路由选择就非常简单了。</p>
<p>观察 PCIe 标准中 7.3.3 Configuration Request Routing Rules，结合 MindShare 的书，看 Root Ports，Switches 和 Bridges 的要求，就知道 Configuration 请求是如何路由的：</p>
<ul>
<li>Configuration 请求只能由 Host Bridge 发起</li>
<li>如果 Configuration 请求是 Type0，那么这个请求的目的设备就是当前设备</li>
<li>如果 Configuration 请求是 Type1，<ul>
<li>如果请求的 Bus Number 等于某一个 Downstream Port 的 Secondary Bus Number，则把 Configuration 请求转换为 Type0，然后发给该 Downstream Port</li>
<li>如果不等于，但是 Bus Number 属于某一个 Downstream Port 的 Secondary Bus Number 和 Subordinate Bus Number 之间，则不修改 Configuration 请求，发送给该 Downstream Port。</li>
</ul>
</li>
</ul>
<p>如果类比一下 IP，那么分组在中途路由器转发的时候就是 Type1，Type0 就是最后一跳。路由就是直接按照几个不重合的 Bus Number 区间进行判断，没有复杂的最长前缀匹配。但是又有一个问题，如果按照 Bus 路由，那同一个 Bus 下不同的 Device 咋办？这就像是以太网，最后一跳的时候，如果同一个链路上有多个设备，那么多个设备都能收到，每个设备根据自己的 Device 号判断是否是发给自己的。PCI（注意不是 PCIe）总线也类似。随着速度越来越高，通过交换机，以太网已经变成了点对点，所以很少见到一个链路上同时有多个设备的情况了。PCIe 也一样，所以根据 Bus 路由就足够了。至于 lspci 看到的那些 Device 不等于 0 的设备，要么是兼容 PCI 设备的，要么是虚拟的，在设备内部进行路由的，并不是真的有一个 PCIe link 连了多个物理设备。</p>
<p>所以简单理解一下，PCI 总线确实是一条总线，一条总线上很多设备。而 PCIe 实际上是一个网络，可以看作是很多个 PCI 总线连接在一起，可以把 Root Complex 或者 Switch 内部看成一个虚拟的有很多设备的 PCI 总线，而 PCIe Link 可以看成是只有一个设备的 PCI 总线。这样 PCIe 交换机可以看成若干个 PCI-PCI Bridge：</p>
<p><img alt="" src="/images/pcie_bridge.png"/></p>
<p>还有 MindShare 书中的图 3-5:</p>
<p><img alt="" src="/images/pcie_system.png"/></p>
<p>可以看到，这里的每一个 Bus 就是一个 PCI 总线，既有内部的虚拟 PCI 总线（Bus 0/2/6），也有 PCIe Link 充当的 PCI 总线（Bus 1/3/4/5/7/8/9）。在虚拟的 PCI 总线里，比如 PCIe Switch，一个 Device 对应一个 Downstream Port；而 PCIe Link 对应的 PCI 总线上就只有一个 Device。然后 PCIe Switch 的每个 Upstream Port 和 Downstream Port 里会记录三个 Bus Number：Primary(Pri)，Secondary(Sec) 和 Subordinate(Sub)。Primary 指的就是它上游直接连接的 PCI 总线编号，Sec 指的是下游直接连接的 PCI 总线编号，Sub 指的是它下游的最大 PCI 总线编号。</p>
<p>这样，收到 Type1 的时候，Switch 按照各个 Downstream Port 的 Sec 和 Sub 进行判断，如果目标 Bus Number 等于 Sec，就转换为 Type0 发出去；如果大于 Sec，但是小于或等于 Sub，就原样发出去。可以看到，从 Host Bridge 到每个设备都可以通过这样的方式一路转发。</p>
<p>既然 BDF 是把 Bus 划分为多个区间来路由的，那么 Memory 和 IO 请求也类似地可以对地址进行划分，变成多个区间，然后用类似的方法进行路由。</p>
<p>这些用于路由的区间上下界，可以在各个端口的 Type1 Configuration Space 中找到：</p>
<p><img alt="" src="/images/pcie_type1.png"/></p>
<ul>
<li>路由 Type1 Configuration Request：Primary Bus Number, Secondary Bus Number, Subordinate Bus Number<ul>
<li><code>Request Bus Number == Secondary Bus Number</code>: Type1 -&gt; Type0</li>
<li><code>Secondary Bus Number &lt; Request Bus Number &lt;= Subordinate Bus Number</code>: Type1 -&gt; Type1</li>
</ul>
</li>
<li>路由 IO Request：<code>I/O Base &lt;= IO Address &lt;= I/O Limit</code></li>
<li>路由 Prefetchable Memory Request：<code>Prefetchable Memory Base &lt;= Memory Address &lt;= Prefetchable Memory Limit</code></li>
<li>路由 Non-Prefetchable Memory Request：<code>Memory Base &lt;= Memory Address &lt;= Memory Limit</code></li>
</ul>
<p>而具体到每一个设备上，设备会提供若干个 BAR（Base Address Register），在枚举设备的时候，会给 BAR 分配地址，然后把设备的地址进行合并，记录到 Switch 上的 Base 和 Limit，然后一直递归，一路更新到 Root Complex。这样，就完成了地址分配，以及请求的路由。</p>
<h4 id="_5"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_5">分配</a></h4>
<p>既然知道了 BDF 是如何路由的，那么接下来的问题是，怎么枚举设备和交换机，分配 Bus Number。这个事情在系统启动的时候会做（例如 UEFI），Linux 中也有相关的代码。下面就来对着 <a href="https://github.com/tianocore/edk2">edk2</a> 的源代码来看看它是怎么做的。</p>
<p>在 edk2 中，分配 Bus Number 的核心代码是 <code>PciScanBus</code> 函数：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cm">/**</span>
</span><span id="__span-0-2"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cm">  Scan pci bus and assign bus number to the given PCI bus system.</span>
</span><span id="__span-0-3"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="cm">  @param  Bridge           Bridge device instance.</span>
</span><span id="__span-0-5"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="cm">  @param  StartBusNumber   start point.</span>
</span><span id="__span-0-6"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="cm">  @param  SubBusNumber     Point to sub bus number.</span>
</span><span id="__span-0-7"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="cm">  @param  PaddedBusRange   Customized bus number.</span>
</span><span id="__span-0-8"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="cm">  @retval EFI_SUCCESS      Successfully scanned and assigned bus number.</span>
</span><span id="__span-0-10"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="cm">  @retval other            Some error occurred when scanning pci bus.</span>
</span><span id="__span-0-11"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="cm">  @note   Feature flag PcdPciBusHotplugDeviceSupport determine whether need support hotplug.</span>
</span><span id="__span-0-13"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="cm">**/</span>
</span><span id="__span-0-15"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="n">EFI_STATUS</span>
</span><span id="__span-0-16"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nf">PciScanBus</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-17"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">  </span><span class="n">IN</span><span class="w"> </span><span class="n">PCI_IO_DEVICE</span><span class="w">  </span><span class="o">*</span><span class="n">Bridge</span><span class="p">,</span>
</span><span id="__span-0-18"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="n">IN</span><span class="w"> </span><span class="n">UINT8</span><span class="w">          </span><span class="n">StartBusNumber</span><span class="p">,</span>
</span><span id="__span-0-19"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">  </span><span class="n">OUT</span><span class="w"> </span><span class="n">UINT8</span><span class="w">         </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span>
</span><span id="__span-0-20"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">  </span><span class="n">OUT</span><span class="w"> </span><span class="n">UINT8</span><span class="w">         </span><span class="o">*</span><span class="n">PaddedBusRange</span>
</span><span id="__span-0-21"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="p">);</span>
</span></code></pre></div>
<p>输入一个桥设备和初始的 Bus Number，输出 Subordinate Bus Number，也就是分配的最大的 Bus Number，以及 Padded Bus Range，例如如果要考虑热插拔的话，就需要预留一些 Bus Number。它在 <code>PciRootBridgeEnumerator</code> 函数中被调用，传入的是 RootBridgeDev。你可能也猜到了，这个函数可以递归调用，从 Root Bridge 开始往下，遇到新的桥设备的时候，就继续递归，然后根据下一层分配的 Bus Number 来计算上一层的 Subordinate Bus Number。</p>
<p><code>PciScanBus</code> 首先枚举当前桥设备下的所有 Device 和 Function，因为当前的桥设备已经被分配了 Bus Number，所以是可以访问它下面的 Device 和 Function 的。</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Device</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PCI_MAX_DEVICE</span><span class="p">;</span><span class="w"> </span><span class="n">Device</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-1-3"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">Func</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PCI_MAX_FUNC</span><span class="p">;</span><span class="w"> </span><span class="n">Func</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-5"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="c1">// Check to see whether a pci device is present</span>
</span><span id="__span-1-6"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-7"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-8"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="n">PciDevicePresent</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">,</span><span class="w"> </span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">);</span>
</span><span id="__span-1-9"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-11"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-12"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">      </span><span class="c1">// go to next device if there is no Function 0</span>
</span><span id="__span-1-13"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-14"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-1-15"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-18"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-1-19"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-20"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>
</span><span id="__span-1-21"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-22"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="c1">// Get the PCI device information</span>
</span><span id="__span-1-23"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-1-24"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-25"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">        </span><span class="n">PciSearchDevice</span><span class="p">(</span><span class="n">Bridge</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">,</span><span class="w"> </span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PciDevice</span><span class="p">);</span>
</span><span id="__span-1-26"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>
</span><span id="__span-1-27"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-28"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">      </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-1-29"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-30"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
</span><span id="__span-1-31"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="n">PciAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-1-32"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>
</span><span id="__span-1-33"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_PCI_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">IS_CARDBUS_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-34"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-35"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">      </span><span class="c1">// For PPB</span>
</span><span id="__span-1-36"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-37"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>
</span><span id="__span-1-38"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span><span class="n">Bridge</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-1-39"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-40"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-1-41"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-1-42"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>
</span><span id="__span-1-43"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">      </span><span class="n">SecondBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">;</span>
</span><span id="__span-1-44"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>
</span><span id="__span-1-45"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">      </span><span class="n">Register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UINT16</span><span class="p">)((</span><span class="n">SecondBus</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">UINT16</span><span class="p">)</span><span class="n">StartBusNumber</span><span class="p">);</span>
</span><span id="__span-1-46"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">      </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-47"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">                                </span><span class="n">PCI_BRIDGE_PRIMARY_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-48"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>
</span><span id="__span-1-49"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint16</span><span class="p">,</span>
</span><span id="__span-1-50"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">                                          </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Register</span><span class="p">);</span>
</span><span id="__span-1-51"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>
</span><span id="__span-1-52"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-53"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">      </span><span class="c1">// If it is PPB, recursively search down this bridge</span>
</span><span id="__span-1-54"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-55"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_PCI_BRIDGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-56"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-1-57"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">        </span><span class="c1">// Temporarily initialize SubBusNumber to maximum bus number to ensure</span>
</span><span id="__span-1-58"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">        </span><span class="c1">// the PCI configuration transaction to go through any PPB</span>
</span><span id="__span-1-59"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-1-60"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">        </span><span class="n">Register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciGetMaxBusNumber</span><span class="p">(</span><span class="n">Bridge</span><span class="p">);</span>
</span><span id="__span-1-61"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">        </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-62"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">                                  </span><span class="n">PCI_BRIDGE_SUBORDINATE_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-63"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">        </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint8</span><span class="p">,</span>
</span><span id="__span-1-64"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">                                            </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Register</span><span class="p">);</span>
</span><span id="__span-1-65"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>
</span><span id="__span-1-66"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">        </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciScanBus</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="n">SecondBus</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">PaddedBusRange</span><span class="p">);</span>
</span><span id="__span-1-67"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-68"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-1-69"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-1-70"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-1-71"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>
</span><span id="__span-1-72"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-73"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">      </span><span class="c1">// Set the current maximum bus number under the PPB</span>
</span><span id="__span-1-74"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-75"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">      </span><span class="n">Address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EFI_PCI_ADDRESS</span><span class="p">(</span><span class="n">StartBusNumber</span><span class="p">,</span><span class="w"> </span><span class="n">Device</span><span class="p">,</span><span class="w"> </span><span class="n">Func</span><span class="p">,</span>
</span><span id="__span-1-76"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="w">                                </span><span class="n">PCI_BRIDGE_SUBORDINATE_BUS_REGISTER_OFFSET</span><span class="p">);</span>
</span><span id="__span-1-77"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>
</span><span id="__span-1-78"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciRootBridgeIo</span><span class="o">-&gt;</span><span class="n">Pci</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">PciRootBridgeIo</span><span class="p">,</span><span class="w"> </span><span class="n">EfiPciWidthUint8</span><span class="p">,</span>
</span><span id="__span-1-79"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="w">                                          </span><span class="n">Address</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-1-80"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-81"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-82"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="w">      </span><span class="c1">// It is device. Check PCI IOV for Bus reservation</span>
</span><span id="__span-1-83"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="w">      </span><span class="c1">// Go through each function, just reserve the MAX ReservedBusNum for one</span>
</span><span id="__span-1-84"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="w">      </span><span class="c1">// device</span>
</span><span id="__span-1-85"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-86"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>
</span><span id="__span-1-87"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">      </span><span class="c1">// OMITTED</span>
</span><span id="__span-1-88"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-89"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>
</span><span id="__span-1-90"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">IS_PCI_MULTI_FUNC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Pci</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-91"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-92"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">      </span><span class="c1">// Skip sub functions, this is not a multi function device</span>
</span><span id="__span-1-93"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-1-94"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>
</span><span id="__span-1-95"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">      </span><span class="n">Func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCI_MAX_FUNC</span><span class="p">;</span>
</span><span id="__span-1-96"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-97"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-98"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a><span class="p">}</span>
</span></code></pre></div>
<p>从代码中去掉了一些热插拔相关的代码，简单来说，它的思路如下：</p>
<ol>
<li>枚举当前设备下的 Device 和 Function</li>
<li>如果找到了一个桥设备，为它分配一个新的 Bus Number<ol>
<li>设置这个新的桥设备的 Primary Bus Number 为 Start Bus Number（也就是上一级的 Secondary Bus Number），Secondary Bus 是新分配的 Bus Number，Subordinate Bus Number 是最大值</li>
<li>这样设置完成后，相当于所有的在 <code>[Secondary Bus Number, Max Bus Number]</code> 范围中的 Bus 请求都会路由到新的桥设备上</li>
<li>递归调用 PciScanBus，参数是新的桥设备，Start Bus Number 为新的 Secondary Bus Number</li>
<li>递归调用返回以后，新的桥设备下面所有的设备都分配到了自己的 Bus Number，这时候就可以知道准确的 Subordinate Bus Number 了，不再是刚才临时设置的 Max Bus Number，因此这时候再把准确的 Subordinate Bus Number 写入桥设备的 Subordinate Bus Number 中</li>
</ol>
</li>
<li>枚举完所有设备以后，返回目前递归分配得到的最大的 Bus Number</li>
</ol>
<p>这样整理出来一看，其实很清楚，这就是一个 DFS 算法，在搜索过程中，为了保证当前的结点可达，保证从 Root Bridge 到当前的结点路径上的 Bus Number 范围都是 <code>[Secondary Bus Number, Max Bus Number]</code>；当结点搜索完以后，再回溯，回溯的时候就知道了实际分配到多大的 Bus Number，这时候再填回 Subordinate Bus Number，最后保证这个树上每一层的 <code>[Secondary Bus Number, Subordinate Bus Number]</code> 区间不重合，且每个子结点的区间都包含于父结点的区间。</p>
<p>最后的结果，类似 MindShare 书中的这个图：</p>
<p><img alt="" src="/images/pcie_enum.png"/></p>
<p>为了支持 PCIe 热插拔，或者可能会动态产生新设备的 SR-IOV，代码中做了相应的预留：</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FeaturePcdGet</span><span class="p">(</span><span class="n">PcdPciBusHotplugDeviceSupport</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-3"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="c1">// If Hot Plug is supported,</span>
</span><span id="__span-2-4"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="c1">// Get the bridge information</span>
</span><span id="__span-2-5"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-6"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="n">BusPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
</span><span id="__span-2-7"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gPciHotPlugInit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-8"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsPciHotPlugBus</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-9"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-2-10"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">      </span><span class="c1">// If it is initialized, get the padded bus range</span>
</span><span id="__span-2-11"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">      </span><span class="c1">//</span>
</span><span id="__span-2-12"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gPciHotPlugInit</span><span class="o">-&gt;</span><span class="n">GetResourcePadding</span><span class="p">(</span>
</span><span id="__span-2-13"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">          </span><span class="n">gPciHotPlugInit</span><span class="p">,</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">DevicePath</span><span class="p">,</span><span class="w"> </span><span class="n">PciAddress</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">State</span><span class="p">,</span>
</span><span id="__span-2-14"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">          </span><span class="p">(</span><span class="n">VOID</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Descriptors</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Attributes</span><span class="p">);</span>
</span><span id="__span-2-15"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>
</span><span id="__span-2-16"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-17"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-18"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-19"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>
</span><span id="__span-2-20"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">      </span><span class="n">BusRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-2-21"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">      </span><span class="n">NextDescriptors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Descriptors</span><span class="p">;</span>
</span><span id="__span-2-22"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">      </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciGetBusRange</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NextDescriptors</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BusRange</span><span class="p">);</span>
</span><span id="__span-2-23"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>
</span><span id="__span-2-24"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">      </span><span class="n">FreePool</span><span class="p">(</span><span class="n">Descriptors</span><span class="p">);</span>
</span><span id="__span-2-25"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>
</span><span id="__span-2-26"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-27"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">        </span><span class="n">BusPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
</span><span id="__span-2-28"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EFI_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-29"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-2-30"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">        </span><span class="c1">// EFI_NOT_FOUND is not a real error. It indicates no bus number padding</span>
</span><span id="__span-2-31"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">        </span><span class="c1">// requested.</span>
</span><span id="__span-2-32"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">        </span><span class="c1">//</span>
</span><span id="__span-2-33"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-34"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-2-35"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-36"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-37"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="p">}</span>
</span><span id="__span-2-38"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>
</span><span id="__span-2-39"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FeaturePcdGet</span><span class="p">(</span><span class="n">PcdPciBusHotplugDeviceSupport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">BusPadding</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-40"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-41"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">  </span><span class="c1">// Ensure the device is enabled and initialized</span>
</span><span id="__span-2-42"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="w">  </span><span class="c1">//</span>
</span><span id="__span-2-43"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">Attributes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EfiPaddingPciRootBridge</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-2-44"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">      </span><span class="p">((</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EFI_HPC_STATE_ENABLED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><span id="__span-2-45"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">      </span><span class="p">((</span><span class="n">State</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EFI_HPC_STATE_INITIALIZED</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-46"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">    </span><span class="o">*</span><span class="n">PaddedBusRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)((</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">BusRange</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">PaddedBusRange</span><span class="p">);</span>
</span><span id="__span-2-47"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-48"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-2-49"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">    </span><span class="c1">// Reserve the larger one between the actual occupied bus number and padded</span>
</span><span id="__span-2-50"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">    </span><span class="c1">// bus number</span>
</span><span id="__span-2-51"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">    </span><span class="c1">//</span>
</span><span id="__span-2-52"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="n">SecondBus</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">BusRange</span><span class="p">),</span>
</span><span id="__span-2-53"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a><span class="w">                                  </span><span class="o">&amp;</span><span class="n">PaddedSubBus</span><span class="p">);</span>
</span><span id="__span-2-54"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-55"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-2-56"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-57"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a>
</span><span id="__span-2-58"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a><span class="w">    </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX</span><span class="p">(</span><span class="n">PaddedSubBus</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-2-59"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-60"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a><span class="p">}</span>
</span></code></pre></div>
<p>SR-IOV:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">//</span>
</span><span id="__span-3-2"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">// It is device. Check PCI IOV for Bus reservation</span>
</span><span id="__span-3-3"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1">// Go through each function, just reserve the MAX ReservedBusNum for one device</span>
</span><span id="__span-3-4"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="c1">//</span>
</span><span id="__span-3-5"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PcdGetBool</span><span class="p">(</span><span class="n">PcdSrIovSupport</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">SrIovCapabilityOffset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-7"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="n">Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciAllocateBusNumber</span><span class="p">(</span>
</span><span id="__span-3-8"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">        </span><span class="n">PciDevice</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">,</span>
</span><span id="__span-3-9"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">        </span><span class="p">(</span><span class="n">UINT8</span><span class="p">)(</span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TempReservedBusNum</span><span class="p">),</span><span class="w"> </span><span class="n">SubBusNumber</span><span class="p">);</span>
</span><span id="__span-3-10"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EFI_ERROR</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-11"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="p">;</span>
</span><span id="__span-3-12"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-13"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>
</span><span id="__span-3-14"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="n">TempReservedBusNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PciDevice</span><span class="o">-&gt;</span><span class="n">ReservedBusNum</span><span class="p">;</span>
</span><span id="__span-3-15"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>
</span><span id="__span-3-16"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Func</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-17"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">DEBUG_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">"PCI-IOV ScanBus - SubBusNumber - 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
</span><span id="__span-3-18"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">             </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">));</span>
</span><span id="__span-3-19"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-20"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">      </span><span class="n">DEBUG</span><span class="p">((</span><span class="n">DEBUG_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">"PCI-IOV ScanBus - SubBusNumber - 0x%x (Update)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
</span><span id="__span-3-21"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">             </span><span class="o">*</span><span class="n">SubBusNumber</span><span class="p">));</span>
</span><span id="__span-3-22"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-23"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-24"><a href="../../hardware/2022/11/12/pcie-notes/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="p">}</span>
</span></code></pre></div>
<p>分配好 Bus 以后，就可以对所有设备进行 Configuration Request 了，后续的 Memory 和 IO 地址的分配和路由，也是类似地递归地进行分配，然后回溯的时候合并地址区间即可。</p>
<h3 id="_6"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#_6">物理层</a></h3>
<p>物理层编码上，PCIe 1.0 和 2.0 采用的是 NRZ 8b/10b，PCIe 3.0 到 5.0 用的是 NRZ 128b/130b，最新的 PCIe 6.0 和 7.0 则换成了 PAM4 FLIT。可以计算出每一代 x16 Lane 情况下的最大数据带宽：</p>
<ul>
<li>PCIe 1.0: <code>2.5 * 8 / 10 * 16 = 32 Gb/s</code></li>
<li>PCIe 2.0: <code>5.0 * 8 / 10 * 16 = 64 Gb/s</code></li>
<li>PCIe 3.0: <code>8.0 * 128 / 130 * 16 = 126 Gb/s</code></li>
<li>PCIe 4.0: <code>16.0 * 128 / 130 * 16 = 252 Gb/s</code></li>
<li>PCIe 5.0: <code>32.0 * 128 / 130 * 16 = 504 Gb/s</code></li>
<li>PCIe 6.0: <code>64.0 * 16 = 1024 Gb/s</code>，如果考虑 FLIT 引入的开销，则是 <code>64.0 * 242 / 256 * 16 = 968 Gb/s</code></li>
<li>PCIe 7.0: <code>128.0 * 16 = 2048 Gb/s</code>，如果考虑 FLIT 引入的开销，则是 <code>128.0 * 242 / 256 * 16 = 1936 Gb/s</code></li>
</ul>
<h3 id="pcie-60"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#pcie-60">PCIe 6.0</a></h3>
<p>PCIe 6.0 引入了 PAM4 来替代原来的 NRZ，实现了波特率不变的情况下速度翻倍，并且不再使用 128b/130b，为了解决 PAM4 带来的更高的错误率，引入了 FEC，CRC 还有格雷码，以及新的 FLIT。</p>
<p>网上可以搜到关于 PCIe 的 PPT：https://pcisig.com/sites/default/files/files/PCIe%206.0%20Webinar_Final_.pdf 和 https://www.openfabrics.org/wp-content/uploads/2022-workshop/2022-workshop-presentations/206_DDasSharma.pdf，以及关于 FLIT 的博客：https://pcisig.com/blog/pcie%C2%AE-60-specification-webinar-qa-deeper-dive-flit-mode-pam4-and-forward-error-correction-fec</p>
<p>总结 FLIT 的要点：</p>
<ol>
<li>每个 FLIT 固定长度 256 字节，其中 236 字节传输 TLP，6 字节传输 DLLP，8 字节传输 CRC，6 字节传输 FEC。</li>
<li>接受方接受到 FLIT 后，会尝试进行 FEC 解码，并且尝试修复错误，再进行 CRC 校验。如果中途出现了错误，则会发送一个 NAK 给发送方。</li>
<li>一个 TLP 可能跨越多个 FLIT，一个 FLIT 可能包括多个 TLP，根据 TLP 大小而定。TLP 不需要对齐到 FLIT 的开头或者结尾。</li>
</ol>
<p>可以发现，FLIT 的 CRC 用了 8 个字节，不再需要原来 TLP 和 DLLP 中的 ECRC 和 LCRC。在之前的 PCIe 版本，TLP 的可选 Digest 是 4 个字节的 ECRC，TLP+DLLP 的 LCRC 是 4 字节。具体采用多少字节的 CRC，和目标的错误率，以及传输的字节数相关。</p>
<h3 id="ats"><a class="toclink" href="../../hardware/2022/11/12/pcie-notes/#ats">ATS</a></h3>
<p>ATS（Address Translation Service）是在 PCIe 上给外设提供查询页表的方式，从而可以使用虚拟地址。标准可以在 https://composter.com.ua/documents/ats_r1.1_26Jan09.pdf 处下载，以及关于 ATS 的 PPT：https://composter.com.ua/documents/Address_Translation_Services.pdf。</p>
<p>它的整体工作方式如图：</p>
<p><img alt="" src="/images/pcie_ats.png"/></p>
<p>就是在 Root Complex 和 Memory 之间设置一个 Translation Agent，负责查表，也就是 Page Table Walker。它会接收来自 PCIe 设备的地址翻译请求，然后它获取到页表地址后，根据虚拟地址去查内存中的页表。TLB（在标准中叫做 Address Translation Cache，ATC）是实现在 PCIe 设备侧的，而不是统一的 TLB，也不是 CPU 核心的 TLB。</p>
<p>为了支持 ATS，需要支持如下的操作：</p>
<ol>
<li>PCIe Device 向 Translation Agent 发送 Translation Request；Translation Agent 向 PCIe Device 回复 Translation Completion；</li>
<li>当页表出现变化的时候，需要通知 PCIe 设备端的 TLB，因此需要向 PCIe 设备发送 Invalidate Request Message；PCIe 设备完成 TLB 刷新后，回复一个 Invalidate Complete Message。</li>
</ol>
<p>ATS 标准还定义了一个可选功能，就是 Page Request Interface（PRI），其实就是缺页的时候，设备可以去发送 Page Request，要求操作系统去分配一个物理页。这就像用户程序里 mmap 一个匿名的页，一开始是没有分配的，直到第一次访问的时候，出现缺页异常，然后 OS 分配一个物理页，再更新页表。这样的好处是用于 DMA 的物理页也可以 Swap 或者延迟分配。</p>
<nav class="md-post__action">
<a href="../../hardware/2022/11/12/pcie-notes/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-10-29 00:00:00">2022年10月29日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ppc64le-linux-nix"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/">在 ppc64le Linux 上运行 Nix</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_1">背景</a></h3>
<p>之前尝试过在 ppc64le 的机器上运行 Nix，当时的尝试是把代码克隆下来编译，我还写了一个 Docker 脚本：</p>
<div class="language-docker highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c">## Based on https://github.com/NixOS/nix/issues/6048</span>
</span><span id="__span-0-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c">## Build nixos/nix from source</span>
</span><span id="__span-0-3"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:20.04</span>
</span><span id="__span-0-4"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">RUN</span><span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">'s/ports.ubuntu.com/mirrors.tuna.tsinghua.edu.cn/g'</span><span class="w"> </span>/etc/apt/sources.list
</span><span id="__span-0-6"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update
</span><span id="__span-0-7"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="k">RUN</span><span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-8"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span>autoconf-archive<span class="w"> </span>autoconf<span class="w"> </span>automake<span class="w"> </span>pkg-config<span class="w"> </span>build-essential<span class="w"> </span>git<span class="w"> </span>gcc<span class="w"> </span>g++<span class="w"> </span>jq<span class="w"> </span>libboost-all-dev<span class="w"> </span>libcrypto++-dev<span class="w"> </span>libcurl4-openssl-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-9"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span>libssh-dev<span class="w"> </span>libarchive-dev<span class="w"> </span>libsqlite3-dev<span class="w"> </span>libbz2-dev<span class="w"> </span>wget<span class="w"> </span>liblzma-dev<span class="w"> </span>libbrotli-dev<span class="w"> </span>libseccomp-dev<span class="w"> </span>bison<span class="w"> </span>flex<span class="w"> </span>libsodium-dev<span class="w"> </span>libgc-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-0-10"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span>libgtest-dev<span class="w"> </span>libgmock-dev<span class="w"> </span>cmake<span class="w"> </span>unzip
</span><span id="__span-0-11"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c">## Install editline - newer version required</span>
</span><span id="__span-0-13"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-14"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/troglobit/editline/releases/download/1.17.1/editline-1.17.1.tar.xz
</span><span id="__span-0-15"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>editline-1.17.1.tar.xz
</span><span id="__span-0-16"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/editline-1.17.1</span>
</span><span id="__span-0-17"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">RUN</span><span class="w"> </span>./configure<span class="w"> </span>--prefix<span class="o">=</span>/usr
</span><span id="__span-0-18"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>all
</span><span id="__span-0-19"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-0-20"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>
</span><span id="__span-0-21"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="c">## Install lowdown - not available via apt</span>
</span><span id="__span-0-22"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-23"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/kristapsdz/lowdown/archive/refs/tags/VERSION_0_10_0.tar.gz
</span><span id="__span-0-24"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>VERSION_0_10_0.tar.gz
</span><span id="__span-0-25"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/lowdown-VERSION_0_10_0</span>
</span><span id="__span-0-26"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="k">RUN</span><span class="w"> </span>./configure
</span><span id="__span-0-27"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>all
</span><span id="__span-0-28"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install<span class="w">  </span>
</span><span id="__span-0-29"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="c">## Install nlohmann_json - newer version required</span>
</span><span id="__span-0-31"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-32"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/nlohmann/json/archive/refs/tags/v3.10.5.tar.gz
</span><span id="__span-0-33"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="k">RUN</span><span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>v3.10.5.tar.gz
</span><span id="__span-0-34"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/json-3.10.5</span>
</span><span id="__span-0-35"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>build
</span><span id="__span-0-36"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/json-3.10.5/build</span>
</span><span id="__span-0-37"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="k">RUN</span><span class="w"> </span>cmake<span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-0-38"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install
</span><span id="__span-0-39"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-40"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">RUN</span><span class="w"> </span>wget<span class="w"> </span>https://github.com/nlohmann/json/releases/download/v3.10.5/include.zip<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>unzip<span class="w"> </span>include.zip
</span><span id="__span-0-41"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="k">RUN</span><span class="w"> </span>mv<span class="w"> </span>include/nlohmann/*<span class="w"> </span>/usr/local/include/nlohmann/
</span><span id="__span-0-42"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>
</span><span id="__span-0-43"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="c">## Compile &amp; build nix</span>
</span><span id="__span-0-44"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root</span>
</span><span id="__span-0-45"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span><span class="m">2</span>.8.1<span class="w"> </span>https://github.com/NixOS/nix.git
</span><span id="__span-0-46"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/root/nix</span>
</span><span id="__span-0-47"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="k">RUN</span><span class="w"> </span>./bootstrap.sh
</span><span id="__span-0-48"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="k">RUN</span><span class="w"> </span>./configure
</span><span id="__span-0-49"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-0-50"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="k">RUN</span><span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span>-k<span class="w"> </span><span class="o">||</span><span class="w"> </span>true
</span></code></pre></div>
<p>但是发现问题在于，离开了 nix install 脚本，我并不知道如何配置一个 multi-user install。但是官方的 nix install 脚本会报错，因为没有 ppc64le 的 prebuilt tarball。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_2">解决办法</a></h3>
<h4 id="binarytarballcross"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#binarytarballcross">binaryTarballCross 方法</a></h4>
<p>该方法学自 @NickCao，在 NixOS/nix 的 flake 中，有生成 tarball 的方法，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">".#hydraJobs.binaryTarballCross.x86_64-linux.armv7l-linux"</span>
</span></code></pre></div>
<p>这样就可以在 x86_64-linux 的 host 上，交叉编译生成一个用于 armv7l-linux 的安装 tarball。类似地，可以修改 flake.nix 来加入其他架构，如：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="gh">diff --git a/flake.nix b/flake.nix</span>
</span><span id="__span-2-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="gh">index cc2a48d9c..c55a267e2 100644</span>
</span><span id="__span-2-3"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="gd">--- a/flake.nix</span>
</span><span id="__span-2-4"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="gi">+++ b/flake.nix</span>
</span><span id="__span-2-5"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="gu">@@ -21,7 +21,7 @@</span>
</span><span id="__span-2-6"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w"> </span>      linuxSystems = linux64BitSystems ++ [ "i686-linux" ];
</span><span id="__span-2-7"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w"> </span>      systems = linuxSystems ++ [ "x86_64-darwin" "aarch64-darwin" ];
</span><span id="__span-2-8"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>
</span><span id="__span-2-9"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="gd">-      crossSystems = [ "armv6l-linux" "armv7l-linux" ];</span>
</span><span id="__span-2-10"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="gi">+      crossSystems = [ "armv6l-linux" "armv7l-linux" "powerpc64le-linux" "riscv64-linux" ];</span>
</span><span id="__span-2-11"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>
</span><span id="__span-2-12"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w"> </span>      stdenvs = [ "gccStdenv" "clangStdenv" "clang11Stdenv" "stdenv" "libcxxStdenv" "ccacheStdenv" ];
</span></code></pre></div>
<p>就可以用下面的命令来生成 riscv64-linux 和 powerpc64le-linux 架构的安装 tarball 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">".#hydraJobs.binaryTarballCross.x86_64-linux.powerpc64le-linux"</span>
</span><span id="__span-3-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>nix<span class="w"> </span>build<span class="w"> </span><span class="s2">".#hydraJobs.binaryTarballCross.x86_64-linux.riscv64-linux"</span>
</span></code></pre></div>
<p>生成的 tarball 可以在 result 中找到。</p>
<h4 id="_3"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_3">手动替换法</a></h4>
<p>因此，我在网上进行搜索，发现 <a href="https://discourse.nixos.org/t/getting-started-with-nix-on-ppc64le/12712/8?u=jiegec">Getting started with Nix on ppc64le</a> 中有人提到，可以先在 x86 的机器上交叉编译出 ppc64le 的 nix，然后把 nix tarball 中的 x86 nix 替换成 ppc64le 版本，再复制到 ppc64le 上安装，其余的步骤就一样了。</p>
<p>我把脚本更新了一下，适配了最新的 nix 版本，最后得到了如下的脚本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">##!/bin/sh</span>
</span><span id="__span-4-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">## Based on https://discourse.nixos.org/t/getting-started-with-nix-on-ppc64le/12712/8?u=jiegec</span>
</span><span id="__span-4-3"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>nix-build<span class="w"> </span><span class="s1">'&lt;nixpkgs&gt;'</span><span class="w"> </span>-A<span class="w"> </span>pkgsCross.powernv.nix
</span><span id="__span-4-4"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1">## Get a donor copy of the installer</span>
</span><span id="__span-4-6"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>wget<span class="w"> </span>-c<span class="w"> </span>https://releases.nixos.org/nix/nix-2.11.1/nix-2.11.1-x86_64-linux.tar.xz
</span><span id="__span-4-7"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>tar<span class="w"> </span>xf<span class="w"> </span>nix-2.11.1-x86_64-linux.tar.xz
</span><span id="__span-4-8"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">## Keep the cert package</span>
</span><span id="__span-4-10"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>nix-ppc64le-linux/store
</span><span id="__span-4-11"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>cp<span class="w"> </span>-r<span class="w"> </span>nix-2.11.1-x86_64-linux/store/*nss-cacert*<span class="w"> </span>nix-ppc64le-linux/store/
</span><span id="__span-4-12"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="c1">## Toss other packages, keep the scripts</span>
</span><span id="__span-4-14"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>rm<span class="w"> </span>-rf<span class="w"> </span>nix-2.11.1-x86_64-linux/store
</span><span id="__span-4-15"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>mv<span class="w"> </span>nix-2.11.1-x86_64-linux/*<span class="w"> </span>nix-ppc64le-linux/
</span><span id="__span-4-16"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>
</span><span id="__span-4-17"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="c1">## Add ppc64le packages</span>
</span><span id="__span-4-18"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>cp<span class="w"> </span>-r<span class="w"> </span><span class="k">$(</span>nix-store<span class="w"> </span>-qR<span class="w"> </span>result<span class="k">)</span><span class="w"> </span>nix-ppc64le-linux/store/
</span><span id="__span-4-19"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="c1">## Generate a .reginfo for those ppc64le packages</span>
</span><span id="__span-4-21"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>nix-store<span class="w"> </span>--dump-db<span class="w"> </span><span class="k">$(</span>nix-store<span class="w"> </span>-qR<span class="w"> </span>result<span class="k">)</span><span class="w"> </span>&gt;<span class="w"> </span>nix-ppc64le-linux/.reginfo
</span><span id="__span-4-22"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>
</span><span id="__span-4-23"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="c1">## Replace NIX_INSTALLED_NIX in install script</span>
</span><span id="__span-4-24"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="nb">export</span><span class="w"> </span><span class="nv">NIX_INSTALLED_NIX</span><span class="o">=</span><span class="k">$(</span>readlink<span class="w"> </span>result<span class="k">)</span>
</span><span id="__span-4-25"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>sed<span class="w"> </span>-i<span class="w"> </span><span class="s2">"s#NIX_INSTALLED_NIX=\".*\"#NIX_INSTALLED_NIX=\"</span><span class="nv">$NIX_INSTALLED_NIX</span><span class="s2">\"#"</span><span class="w"> </span>nix-ppc64le-linux/install-multi-user
</span><span id="__span-4-26"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>
</span><span id="__span-4-27"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"Done! Copy nix-ppc64le-linux to ppc64le machine and run ./install --daemon"</span>
</span></code></pre></div>
<p>把生成的目录复制到 ppc64le 机器上就可以了。</p>
<h3 id="_4"><a class="toclink" href="../../software/2022/10/29/nix-on-ppc64le/#_4">编译问题</a></h3>
<p>当然了，既然 ppc64le 的 Nixpkgs 没有什么人测试，所以肯定会遇到一些问题。下面是遇到的几个比较主要的问题，以及相应的解决方法：</p>
<ul>
<li>boehm-gc checkPhase 会失败，见 <a href="https://github.com/ivmai/bdwgc/issues/376">ivmai/bdwgc#376</a>，一直没有修复。解决办法是添加 overlay，让它不要跑测试：</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>custom-overlay = final: prev: {
</span><span id="__span-5-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>  # https://github.com/ivmai/bdwgc/issues/376
</span><span id="__span-5-3"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>  boehmgc = prev.boehmgc.overrideAttrs (_: { doCheck = false; });
</span><span id="__span-5-4"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>};
</span></code></pre></div>
<p>UPDATE: 向 nixpkgs 提交了 pr: https://github.com/NixOS/nixpkgs/pull/198591</p>
<p>另外根据 bdwgc 的 issue 提示，添加下列的选项可以让它测试通过：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>makeFlags = ["CFLAGS_EXTRA=\"-DNO_SOFT_VDB\""];
</span></code></pre></div>
<p>但是 issue 也说，这个方法对于 Power9 不工作。</p>
<ul>
<li>linux-headers 编译失败，报告 unknown type name __vector128，见 <a href="https://www.spinics.net/lists/netdev/msg694314.html">tools/bpf: Compilation issue on powerpc: unknown type name '__vector128'
</a> <a href="https://github.com/NixOS/nixpkgs/pull/192670">bpftools: add enableDebugger, set to false on Power64 (WIP)</a>。目前的解决办法是让 procps/tmux 等包不要依赖 systemd，进而不会依赖 linux-headers：</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>custom-overlay = final: prev: {
</span><span id="__span-7-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>  # systemd cannot build due to linux-headers
</span><span id="__span-7-3"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>  procps = prev.procps.override { withSystemd = false; };
</span><span id="__span-7-4"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>  tmux = prev.tmux.override { withSystemd = false; };
</span><span id="__span-7-5"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>};
</span></code></pre></div>
<p>对于 home-manager，可以用下面的配置让它不要编译 systemd：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>## systemd does not build
</span><span id="__span-8-2"><a href="../../software/2022/10/29/nix-on-ppc64le/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>systemd.user.systemctlPath = "/bin/systemctl";
</span></code></pre></div>
<p>当然了，这个治标不治本，还是要等上游修复。</p>
<p>UPDATE: 向 nixpkgs 提交了 pr: https://github.com/NixOS/nixpkgs/pull/198587</p>
<nav class="md-post__action">
<a href="../../software/2022/10/29/nix-on-ppc64le/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-10-24 00:00:00">2022年10月24日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="gnuradio-companion-fm"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/">在 GNURadio Companion 中收听 FM 广播</a></h2>
<h3 id="_1"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#_1">背景</a></h3>
<p>以前买过 RTL-SDR，用 Gqrx 做过收音机，当时还给 Homebrew 尝试提交过几个 sdr 相关的 <a href="https://github.com/Homebrew/legacy-homebrew/pulls?q=is%3Apr+author%3Ajiegec+">pr</a>，但是限于知识的缺乏，后来就没有再继续尝试了。</p>
<p>前两天，@OceanS2000 讲了一次 <a href="https://tuna.moe/event/2022/hacking-radio/">Tunight: 高级收音机使用入门</a>，又勾起了我的兴趣，所以我来尝试一下在 GNURadio Companion 中收听 FM 广播电台。</p>
<p>我没有上过无线电相关课程，所以下面有一些内容可能不正确或者不准确。</p>
<h3 id="_2"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#_2">安装</a></h3>
<p>我的实验环境是 NixOS，所以是用下面的配置来安装 gnuradio 的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>## SDR
</span><span id="__span-0-2"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>## https://github.com/NixOS/nixpkgs/pull/170253
</span><span id="__span-0-3"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>(gnuradio.override { extraMakeWrapperArgs = [ "--prefix" "SOAPY_SDR_PLUGIN_PATH" ":" (soapyrtlsdr + "/lib/SoapySDR/modules0.8/") ]; })
</span><span id="__span-0-4"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>soapysdr-with-plugins
</span></code></pre></div>
<p>其中 gnuradio 的 override 是为了让它可以找到 soapyrtlsdr 的库，否则它会找不到设备；<code>soapysdr-with-plugins</code> 是为了提供 <code>SoapySDRUtil</code> 命令，来确认它可以找到 RTL-SDR 设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>SoapySDRUtil<span class="w"> </span>--probe
</span><span id="__span-1-2"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>----------------------------------------------------
</span><span id="__span-1-3"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>--<span class="w"> </span>Device<span class="w"> </span>identification
</span><span id="__span-1-4"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>----------------------------------------------------
</span><span id="__span-1-5"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nv">driver</span><span class="o">=</span>RTLSDR
</span><span id="__span-1-6"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="nv">hardware</span><span class="o">=</span>R820T
</span><span id="__span-1-7"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="nv">origin</span><span class="o">=</span>https://github.com/pothosware/SoapyRTLSDR
</span><span id="__span-1-8"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nv">rtl</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-9"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>----------------------------------------------------
</span><span id="__span-1-11"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>--<span class="w"> </span>Peripheral<span class="w"> </span>summary
</span><span id="__span-1-12"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>----------------------------------------------------
</span><span id="__span-1-13"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span>Channels:<span class="w"> </span><span class="m">1</span><span class="w"> </span>Rx,<span class="w"> </span><span class="m">0</span><span class="w"> </span>Tx
</span><span id="__span-1-14"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span>Timestamps:<span class="w"> </span>NO
</span><span id="__span-1-15"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span>Other<span class="w"> </span>Settings:
</span><span id="__span-1-16"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">     </span>*<span class="w"> </span>Direct<span class="w"> </span>Sampling<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>Direct<span class="w"> </span>Sampling<span class="w"> </span>Mode
</span><span id="__span-1-17"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>direct_samp,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>string,<span class="w"> </span><span class="nv">options</span><span class="o">=(</span><span class="m">0</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">2</span><span class="o">)]</span>
</span><span id="__span-1-18"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">     </span>*<span class="w"> </span>Offset<span class="w"> </span>Tune<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>Offset<span class="w"> </span>Tuning<span class="w"> </span>Mode
</span><span id="__span-1-19"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>offset_tune,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-20"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">     </span>*<span class="w"> </span>I/Q<span class="w"> </span>Swap<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>I/Q<span class="w"> </span>Swap<span class="w"> </span>Mode
</span><span id="__span-1-21"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>iq_swap,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-22"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">     </span>*<span class="w"> </span>Digital<span class="w"> </span>AGC<span class="w"> </span>-<span class="w"> </span>RTL-SDR<span class="w"> </span>digital<span class="w"> </span>AGC<span class="w"> </span>Mode
</span><span id="__span-1-23"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>digital_agc,<span class="w"> </span><span class="nv">default</span><span class="o">=</span>false,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bool<span class="o">]</span>
</span><span id="__span-1-24"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>
</span><span id="__span-1-25"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>----------------------------------------------------
</span><span id="__span-1-26"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>--<span class="w"> </span>RX<span class="w"> </span>Channel<span class="w"> </span><span class="m">0</span>
</span><span id="__span-1-27"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>----------------------------------------------------
</span><span id="__span-1-28"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">  </span>Full-duplex:<span class="w"> </span>NO
</span><span id="__span-1-29"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">  </span>Supports<span class="w"> </span>AGC:<span class="w"> </span>YES
</span><span id="__span-1-30"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">  </span>Stream<span class="w"> </span>formats:<span class="w"> </span>CS8,<span class="w"> </span>CS16,<span class="w"> </span>CF32
</span><span id="__span-1-31"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span>Native<span class="w"> </span>format:<span class="w"> </span>CS8<span class="w"> </span><span class="o">[</span>full-scale<span class="o">=</span><span class="m">128</span><span class="o">]</span>
</span><span id="__span-1-32"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span>Stream<span class="w"> </span>args:
</span><span id="__span-1-33"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">     </span>*<span class="w"> </span>Buffer<span class="w"> </span>Size<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>bytes<span class="w"> </span>per<span class="w"> </span>buffer,<span class="w"> </span>multiples<span class="w"> </span>of<span class="w"> </span><span class="m">512</span><span class="w"> </span>only.
</span><span id="__span-1-34"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>bufflen,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>bytes,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">262144</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-35"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">     </span>*<span class="w"> </span>Ring<span class="w"> </span>buffers<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>buffers<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>ring.
</span><span id="__span-1-36"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">15</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-37"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">     </span>*<span class="w"> </span>Async<span class="w"> </span>buffers<span class="w"> </span>-<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>async<span class="w"> </span>usb<span class="w"> </span>buffers<span class="w"> </span><span class="o">(</span>advanced<span class="o">)</span>.
</span><span id="__span-1-38"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">       </span><span class="o">[</span><span class="nv">key</span><span class="o">=</span>asyncBuffs,<span class="w"> </span><span class="nv">units</span><span class="o">=</span>buffers,<span class="w"> </span><span class="nv">default</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">type</span><span class="o">=</span>int<span class="o">]</span>
</span><span id="__span-1-39"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">  </span>Antennas:<span class="w"> </span>RX
</span><span id="__span-1-40"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">  </span>Full<span class="w"> </span>gain<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">0</span>,<span class="w"> </span><span class="m">49</span>.6<span class="o">]</span><span class="w"> </span>dB
</span><span id="__span-1-41"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">    </span>TUNER<span class="w"> </span>gain<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">0</span>,<span class="w"> </span><span class="m">49</span>.6<span class="o">]</span><span class="w"> </span>dB
</span><span id="__span-1-42"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">  </span>Full<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">23</span>.999,<span class="w"> </span><span class="m">1764</span><span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-43"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span>RF<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span><span class="m">24</span>,<span class="w"> </span><span class="m">1764</span><span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-44"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">    </span>CORR<span class="w"> </span>freq<span class="w"> </span>range:<span class="w"> </span><span class="o">[</span>-0.001,<span class="w"> </span><span class="m">0</span>.001<span class="o">]</span><span class="w"> </span>MHz
</span><span id="__span-1-45"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">  </span>Sample<span class="w"> </span>rates:<span class="w"> </span><span class="m">0</span>.25,<span class="w"> </span><span class="m">1</span>.024,<span class="w"> </span><span class="m">1</span>.536,<span class="w"> </span><span class="m">1</span>.792,<span class="w"> </span><span class="m">1</span>.92,<span class="w"> </span><span class="m">2</span>.048,<span class="w"> </span><span class="m">2</span>.16,<span class="w"> </span><span class="m">2</span>.56,<span class="w"> </span><span class="m">2</span>.88,<span class="w"> </span><span class="m">3</span>.2<span class="w"> </span>MSps
</span></code></pre></div>
<h3 id="fm"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#fm">寻找 FM 广播</a></h3>
<p>接着，就可以在 GRC(GNURadio Companion) 中从 RTL-SDR 读取数据了。首先，我按照 <a href="https://wiki.gnuradio.org/index.php/Guided_Tutorial_Hardware_Considerations">Guided Tutorial Hardware Considerations</a> 的方法进行分析，可以看到哪些频率上有信号：</p>
<p><img alt="" src="/images/rtlsdr-analyze.png"/></p>
<p>图中的参数：</p>
<ul>
<li>Sample Rate: 3.2MHz，这里要取比较大，如果太小可能找不到信号</li>
</ul>
<p><img alt="" src="/images/rtlsdr-analyze-waterfall.png"/></p>
<p>可以看到在 100.6MHz 附近有比较明显的信号，查询了一下，这对应了北京新闻广播 FM100.6，确实是一个 FM 广播电台。通过修改中心频率，还可以找到附近的 FM97.4 音乐广播和 FM 103.9 交通广播。</p>
<p><img alt="" src="/images/rtlsdr-analyze-waterfall-fm974.png"/></p>
<h3 id="fm_1"><a class="toclink" href="../../hardware/2022/10/24/gnuradio-fm-radio/#fm_1">收听 FM 广播</a></h3>
<p>找到频率以后，就可以进行 FM 解调了。我继续按照 <a href="https://wiki.gnuradio.org/index.php/FM_Demod">FM Demod</a> 的方法进行搭建，由于我用的是 RTL-SDR，考虑到它支持的采样率，我选取了 2.88MHz 采样率，经过一个 1/10 的 Rational Resampler 变成 288KHz 采样率，再进行 FM 解调，最后得到 <code>288KHz / 6 = 48KHz</code> 的音频，然后保存在 WAV 文件中：</p>
<p><img alt="" src="/images/rtlsdr-fm.png"/></p>
<p>图中的参数：</p>
<ul>
<li>Sample Rate: 2.88MHz，这里取了 48KHz 的整数倍数</li>
<li>Rational Resampler - Decimation: FM Demod 的 Decimation 不能太大，所以这里先进行 10 倍降采样，把采样率从 2.88MHz 降到 288KHz</li>
<li>FM Demod - Channel Rate: 输入的采样率是 288KHz</li>
<li>FM Demod - Audio Decimation: 6 倍降采样，这样输出就是 48KHz</li>
<li>FM Demod - Deviation: 75KHz，维基百科：<code>The maximum frequency deviation of the carrier is usually specified and regulated by the licensing authorities in each country. For a stereo broadcast, the maximum permitted carrier deviation is invariably ±75 kHz, although a little higher is permitted in the United States when SCA systems are used. For a monophonic broadcast, again the most common permitted maximum deviation is ±75 kHz. However, some countries specify a lower value for monophonic broadcasts, such as ±50 kHz.[5]</code></li>
<li>FM Demod - Audio Pass/Audio Stop: 低通滤波器参数，保留 0-16 KHz 的频率（Passband），到 20KHz 截止（Stopband）</li>
</ul>
<p>运行一段时间，收听保存下来的 wav 文件，发现可以清晰地听到广播电台的声音。</p>
<p>把输出改成 Audio Sink(Sample Rate = 48KHz)，然后就可以当成收音机应用来跑了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../hardware/2022/10/24/gnuradio-fm-radio/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>grcc<span class="w"> </span>-r<span class="w"> </span>rtlsdr_fm_play.grc
</span></code></pre></div>
<nav class="md-post__action">
<a href="../../hardware/2022/10/24/gnuradio-fm-radio/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-09-24 00:00:00">2022年9月24日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="esxi-lacp"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/">ESXi 配置 LACP 链路聚合</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#_1">背景</a></h3>
<p>给 ESXi 接了两路 10Gbps 的以太网，需要用 LACP 来聚合。ESXi 自己不能配置 LACP，需要配合 vCenter Server 的 Distributed Switch 来配置。</p>
<h3 id="_2"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#_2">步骤</a></h3>
<p>参考文档：<a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-0D1EF5B4-7581-480B-B99D-5714B42CD7A9.html">LACP Support on a vSphere Distributed Switch</a></p>
<p>第一步是创建一个 Distributed Switch。找到 Cluster，点击 ACTIONS，在 Distributed Switch 里面选择 New Distributed Switch。里面的选项都可以用默认的，按需修改。</p>
<p>第二步，找到刚刚创建的 Distributed Switch，点击 Configure，在 Settings 下点击 LACP，点击 NEW，选项可以用默认的，按需修改。</p>
<p>第三步，找到 Distributed Switch，点击 ACTIONS，点击 Add and Manage Hosts，找到要配置的主机，在 Manage physical adapters 这一步，找到要加入到链路聚合的 vmnic，每个要聚合的 vmnic 都在右边的 Assign uplink 处选择刚刚创建的 LAG 下的 Uplink，按顺序，一一对应。其余选项可以使用默认的。这一步配置好以后，在交换机上应该就可以看到 LACP 正常运转。</p>
<p>第四步，如果要把虚拟机连到链路聚合的网络上，找到虚拟机，点击 ACTIONS，点击 Edit Settings，新建一个网卡，Network adapter 处选择刚刚创建的 Distributed Port Group。这一步是让虚拟机多一个网卡，可以连接到 Distributed Switch 上。这一步配置好以后，虚拟机就可以收到来自其他物理机的网络流量，但是发送不出去。</p>
<p>注：Static Binding 和 Ephemeral Binding 的区别见 <a href="https://kb.vmware.com/s/article/1022312">Static (non-ephemeral) or ephemeral port binding on a vSphere Distributed Switch (1022312)</a>。在 vCenter 上可以给虚拟机分配到 Static binding 的 Distributed Port Group 上，而在 ESXi 上只可以分配到 Ephemeral Port Group。通常来讲，只需要 Static binding，而 Ephemeral binding 是在紧急情况下使用的。</p>
<p>第五步，如果要把 VMKernel 连到链路聚合的网络上，找到虚拟机，添加一个 VMKernel adapter，端口组为 Distributed Port Group，如默认创建的第一个 Distributed Port Group。类似地，此时 VMKernel 配置的 IP 地址还不能从外面访问，但是可以从同一个 Distributed Switch 的虚拟机中访问。</p>
<p>第六步，修改 Failover 配置，找到 Distributed Switch，点击 ACTIONS，在 Distributed Port Group 里点击 Manager Distributed Port Groups，勾选 Teaming and failover，勾上所有的 Distributed Port Group，修改下面的 Failover Order，默认状态是 Active uplinks 只有 Uplink，没有 LAG，需要修改为 Active uplinks 只有 LAG，而 Uplink 都在 Unused Uplinks 中。这样才可以让虚拟机和 VMKernel 出去的流量走链路聚合。</p>
<p>参考文档：<a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-9454ED41-6CFC-49F1-9982-34C1276F775A.html">LACP Teaming and Failover Configuration for Distributed Port Groups</a> 和 <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-45DF45A6-DBDB-4386-85BF-400797683D05.html">Configure a Link Aggregation Group to Handle the Traffic for Distributed Port Groups</a></p>
<p>这样就配置完成了。</p>
<h3 id="lacp"><a class="toclink" href="../../devops/2022/09/24/vmware-esxi-lacp/#lacp">非 LACP 的链路聚合</a></h3>
<p>如果想要链路聚合，但是又不想用 Virtual Distributed Switch，可以在交换机上配置 Static Link Aggregation，然后在 ESXi 上添加多个 Uplink，配置 NIC teaming 为 <code>Route based on IP hash</code> 模式即可。</p>
<p>参考：<a href="https://kb.vmware.com/s/article/1004088">NIC teaming in ESXi and ESX</a></p>
<nav class="md-post__action">
<a href="../../devops/2022/09/24/vmware-esxi-lacp/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-09-19 00:00:00">2022年9月19日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="buildroot-202008-fakeroot"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/">Buildroot 2020.08 的 Fakeroot 版本过旧导致的兼容性问题</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_1">背景</a></h3>
<p>最近在给之前的 Buildroot 2020.09 增加新的软件包，结果编译的时候报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>mknod: ....../dev/console: Operation not permitted
</span></code></pre></div>
<p>还有一个背景是前段时间把系统升级到了 Ubuntu 22.04 LTS。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_2">研究</a></h3>
<p>跑的时候没有用 root，而是用 fakeroot 跑的，按理说在 fakeroot 里跑 mknod 是不会报错的，我直接运行系统的 fakeroot 是正常的：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>fakeroot<span class="w"> </span>--<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span></code></pre></div>
<p>此时 fakeroot 会生成一个空文件，这是正常现象。那么为什么 Buildroot 里跑就不对了呢？</p>
<p>我仔细观察了一下，buildroot 用的是自己编译的 fakeroot，版本是 1.20.2，用这个版本跑就会报错：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>./output/host/bin/fakeroot<span class="w"> </span>--<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-2-2"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>mknod:<span class="w"> </span>test:<span class="w"> </span>Operation<span class="w"> </span>not<span class="w"> </span>permitted
</span></code></pre></div>
<p>果然就出问题了。</p>
<p>用 strace 观察下区别：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>fakeroot<span class="w"> </span>--<span class="w"> </span>strace<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-3-2"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>newfstatat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"test"</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_SYMLINK_NOFOLLOW<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-3"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>msgget<span class="o">(</span>0x4b33194b,<span class="w"> </span>IPC_CREAT<span class="p">|</span><span class="m">0600</span><span class="o">)</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">32771</span>
</span><span id="__span-3-4"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>msgget<span class="o">(</span>0x4b33194c,<span class="w"> </span>IPC_CREAT<span class="p">|</span><span class="m">0600</span><span class="o">)</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="m">32772</span>
</span><span id="__span-3-5"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>msgsnd<span class="o">(</span>...<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-6"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>newfstatat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"test"</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_SYMLINK_NOFOLLOW<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-7"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>msgsnd<span class="o">(</span>...<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-8"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>openat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"test"</span>,<span class="w"> </span>O_RDONLY<span class="p">|</span>O_NOFOLLOW<span class="p">|</span>O_CLOEXEC<span class="p">|</span>O_PATH<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
</span><span id="__span-3-9"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>newfstatat<span class="o">(</span><span class="m">3</span>,<span class="w"> </span><span class="s2">""</span>,<span class="w"> </span><span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span><span class="m">0644</span>,<span class="w"> </span><span class="nv">st_size</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span>...<span class="o">}</span>,<span class="w"> </span>AT_EMPTY_PATH<span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-10"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>fchmodat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"/proc/self/fd/3"</span>,<span class="w"> </span><span class="m">0622</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-3-11"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>$<span class="w"> </span>./output/host/bin/fakeroot<span class="w"> </span>--<span class="w"> </span>strace<span class="w"> </span>mknod<span class="w"> </span>-m<span class="w"> </span><span class="m">0622</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>c<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-3-12"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>umask<span class="o">(</span><span class="m">000</span><span class="o">)</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="m">002</span>
</span><span id="__span-3-13"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>umask<span class="o">(</span><span class="m">002</span><span class="o">)</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="m">000</span>
</span><span id="__span-3-14"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>mknodat<span class="o">(</span>AT_FDCWD,<span class="w"> </span><span class="s2">"test"</span>,<span class="w"> </span>S_IFCHR<span class="p">|</span><span class="m">0622</span>,<span class="w"> </span>makedev<span class="o">(</span>0x5,<span class="w"> </span>0x1<span class="o">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-1<span class="w"> </span>EPERM<span class="w"> </span><span class="o">(</span>Operation<span class="w"> </span>not<span class="w"> </span>permitted<span class="o">)</span>
</span></code></pre></div>
<p>可以看到，正常情况下，mknodat 系统调用被拦截，由 fakeroot 来创建空文件；而错误的 fakeroot 版本下，没有拦截成功，就出现了 EPERM。</p>
<h3 id="_3"><a class="toclink" href="../../software/2022/09/19/buildroot-fakeroot-incompat/#_3">解决</a></h3>
<p>一个粗暴的解决办法是，直接修改 buildroot 源代码，让它用系统的 fakeroot：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="w">        </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$$</span><span class="o">(</span>BR_PATH<span class="o">)</span><span class="w"> </span><span class="nv">FAKEROOTDONTTRYCHOWN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>/usr/bin/fakeroot<span class="w"> </span>--<span class="w"> </span><span class="nv">$$</span><span class="o">(</span>FAKEROOT_SCRIPT<span class="o">)</span>
</span></code></pre></div>
<p>我还尝试重新编译 fakeroot 1.20.2，会出现编译错误，采用类似 <a href="https://bugs.archlinux.org/task/69572">bug 69572 fakeroot failes to build: _STAT_VER undeclared</a> 的方法可以解决编译的问题，但是还是出现 EPERM。<a href="https://github.com/buildroot/buildroot/commit/f45925a951318e9e53bead80b363e004301adc6f">Buildroot</a> 后来也引入了类似的修复。</p>
<p>于是在<a href="https://salsa.debian.org/clint/fakeroot">源代码</a>历史中搜寻了一番，发现了一个疑似的修复 commit：<a href="https://salsa.debian.org/clint/fakeroot/-/commit/c3eebec293e35b997bb46c22fb5a4e114afb5e7f">configure.ac: fix __xmknod{,at} pointer argument</a>，不过我并不能确定是不是这个问题。</p>
<p>进一步，我在 Docker 镜像中手动下载并编译 fakeroot 1.20.2、1.21 和 1.25.3，都可以复现这个问题，编译 1.29 版本则没有问题。用 git 克隆<a href="https://salsa.debian.org/clint/fakeroot">仓库</a>，进一步定位到 upstream/1.26 和 upstream/1.27 版本都是正常的。而 upstream/1.25.2 会出错。进一步二分，找到修复的 commit 是 <a href="https://salsa.debian.org/clint/fakeroot/-/commit/feda578ca3608b7fc9a28a3a91293611c0ef47b7">libfakeroot.c: add wrappers for new glibc 2.33+ symbols</a>，相关的代码如下：</p>
<div class="language-diff highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="gi">+  int mknod(const char *pathname, mode_t mode, dev_t dev) {</span>
</span><span id="__span-5-2"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="gi">+     return WRAP_MKNOD MKNOD_ARG(_STAT_VER, pathname, mode, &amp;dev);</span>
</span><span id="__span-5-3"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="gi">+  }</span>
</span><span id="__span-5-4"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="gi">+</span>
</span><span id="__span-5-5"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="gi">+  #if defined(HAVE_FSTATAT) &amp;&amp; defined(HAVE_MKNODAT)</span>
</span><span id="__span-5-6"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="gi">+    int mknodat(int dir_fd, const char *pathname, mode_t mode, dev_t dev) {</span>
</span><span id="__span-5-7"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="gi">+       return WRAP_MKNODAT MKNODAT_ARG(_STAT_VER, dir_fd, pathname, mode, &amp;dev);</span>
</span><span id="__span-5-8"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="gi">+    }</span>
</span><span id="__span-5-9"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="gi">+  #endif</span>
</span><span id="__span-5-10"><a href="../../software/2022/09/19/buildroot-fakeroot-incompat/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="gi">+#endif /* GLIBC_PREREQ */</span>
</span></code></pre></div>
<p>这说明在这个修复之前，不能正确地拦截 mknod 的调用。所以 glibc 2.33+ 要配合 fakeroot 1.26+ 版本才可以正确地运行 fakeroot。</p>
<p>结论：找个时间用新版的 Buildroot 重新构建一份。</p>
<nav class="md-post__action">
<a href="../../software/2022/09/19/buildroot-fakeroot-incompat/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-08-05 00:00:00">2022年8月5日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="tex-pdf"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/">从 TeX 到 PDF 的过程</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#_1">背景</a></h3>
<p>今天跑 <code>xdvipdfmx</code> 的时候出现了报错，忽然想研究一下，DVI 格式是什么，TeX 是如何一步步变成 PDF 的。</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#_2">流程</a></h3>
<p>实际上从 TeX 到 PDF 有不同的工具，其中可能经历了不同的转化过程。</p>
<p>我们今天来看一种比较原始的转换方式：从 TeX 到 DVI，从 DVI 到 PS，再 PS 到 PDF，主要目的是看看这些格式内部都是什么样子的。</p>
<h3 id="tex-dvi"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#tex-dvi">从 TeX 到 DVI</a></h3>
<p>举一个很小的例子，例如 <code>test.tex</code> 有如下的内容：</p>
<div class="language-tex highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Hello, world!
</span><span id="__span-0-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">\bye</span>
</span></code></pre></div>
<p>在命令行中运行 <code>tex test.tex</code>，可以看到它生成了 <code>test.dvi</code> 文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>tex<span class="w"> </span>test.tex
</span><span id="__span-1-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="o">(</span>test.tex<span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">)</span>
</span><span id="__span-1-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Output<span class="w"> </span>written<span class="w"> </span>on<span class="w"> </span>test.dvi<span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="w"> </span>page,<span class="w"> </span><span class="m">228</span><span class="w"> </span>bytes<span class="o">)</span>.
</span><span id="__span-1-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>Transcript<span class="w"> </span>written<span class="w"> </span>on<span class="w"> </span>test.log.
</span></code></pre></div>
<p>那么 DVI 就是 TeX 引擎输出的默认格式了。我们可以用 dviinfox 和 dviasm 工具来看它的一些信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>dviinfox<span class="w"> </span>test.dvi
</span><span id="__span-2-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>test.dvi:<span class="w"> </span>DVI<span class="w"> </span>format<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>page
</span><span id="__span-2-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span>Magnification:<span class="w"> </span><span class="m">1000</span>/1000
</span><span id="__span-2-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span>Size<span class="w"> </span>unit:<span class="w"> </span>1000x25400000/<span class="o">(</span>1000x473628672<span class="o">)</span><span class="nv">dum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.054dum<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>.000sp
</span><span id="__span-2-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span>Page<span class="w"> </span>size:<span class="w"> </span><span class="nv">469ptx667pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>.510cmx23.449cm
</span><span id="__span-2-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span>Stack<span class="w"> </span>size:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span>Comment:<span class="w"> </span><span class="s2">" TeX output 2022.08.05:2055"</span>
</span><span id="__span-2-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span>Font<span class="w">   </span><span class="m">0</span>:<span class="w">     </span>cmr10<span class="w"> </span>at<span class="w"> </span><span class="m">10</span>.000<span class="w"> </span><span class="o">(</span>design<span class="w"> </span>size<span class="w"> </span><span class="m">10</span>.000,<span class="w"> </span><span class="nv">checksum</span><span class="o">=</span><span class="m">1274110073</span><span class="o">)</span>
</span><span id="__span-2-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>$<span class="w"> </span>dviasm<span class="w"> </span>test.dvi
</span><span id="__span-2-10"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="o">[</span>preamble<span class="o">]</span>
</span><span id="__span-2-11"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>id:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-12"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>numerator:<span class="w"> </span><span class="m">25400000</span>
</span><span id="__span-2-13"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>denominator:<span class="w"> </span><span class="m">473628672</span>
</span><span id="__span-2-14"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>magnification:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-2-15"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>comment:<span class="w"> </span><span class="s1">' TeX output 2022.08.05:2058'</span>
</span><span id="__span-2-16"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>
</span><span id="__span-2-17"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="o">[</span>postamble<span class="o">]</span>
</span><span id="__span-2-18"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>maxv:<span class="w"> </span><span class="m">667</span>.202545pt
</span><span id="__span-2-19"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>maxh:<span class="w"> </span><span class="m">469</span>.754990pt
</span><span id="__span-2-20"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>maxs:<span class="w"> </span><span class="m">2</span>
</span><span id="__span-2-21"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>pages:<span class="w"> </span><span class="m">1</span>
</span><span id="__span-2-22"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>
</span><span id="__span-2-23"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="o">[</span>font<span class="w"> </span>definitions<span class="o">]</span>
</span><span id="__span-2-24"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>fntdef:<span class="w"> </span>cmr10<span class="w"> </span>at<span class="w"> </span>10pt
</span><span id="__span-2-25"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>
</span><span id="__span-2-26"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="o">[</span>page<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-2-27"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>push:
</span><span id="__span-2-28"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">  </span>down:<span class="w"> </span>-14pt
</span><span id="__span-2-29"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>pop:
</span><span id="__span-2-30"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>down:<span class="w"> </span><span class="m">643</span>.202545pt
</span><span id="__span-2-31"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>push:
</span><span id="__span-2-32"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">  </span>down:<span class="w"> </span>-633.202545pt
</span><span id="__span-2-33"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">  </span>push:
</span><span id="__span-2-34"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">    </span>right:<span class="w"> </span>20pt
</span><span id="__span-2-35"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">    </span>fnt:<span class="w"> </span>cmr10<span class="w"> </span>at<span class="w"> </span>10pt
</span><span id="__span-2-36"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">'Hello,'</span>
</span><span id="__span-2-37"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">    </span>right:<span class="w"> </span><span class="m">3</span>.333328pt
</span><span id="__span-2-38"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">'w'</span>
</span><span id="__span-2-39"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="w">    </span>right:<span class="w"> </span>-0.277786pt
</span><span id="__span-2-40"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">    </span>set:<span class="w"> </span><span class="s1">'orld!'</span>
</span><span id="__span-2-41"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">  </span>pop:
</span><span id="__span-2-42"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>pop:
</span><span id="__span-2-43"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>down:<span class="w"> </span>24pt
</span><span id="__span-2-44"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>push:
</span><span id="__span-2-45"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">  </span>right:<span class="w"> </span><span class="m">232</span>.377487pt
</span><span id="__span-2-46"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">  </span>set:<span class="w"> </span><span class="s1">'1'</span>
</span><span id="__span-2-47"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>pop:
</span></code></pre></div>
<p>可以看到，它定义了文档的一些尺寸和字体信息，然后主体部分就是每个页面上需要绘制的内容：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>push:
</span><span id="__span-3-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>  down: -14pt
</span><span id="__span-3-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>pop:
</span><span id="__span-3-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>down: 643.202545pt
</span><span id="__span-3-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>push:
</span><span id="__span-3-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>  down: -633.202545pt
</span><span id="__span-3-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>  push:
</span><span id="__span-3-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    right: 20pt
</span><span id="__span-3-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>    fnt: cmr10 at 10pt
</span><span id="__span-3-10"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    set: 'Hello,'
</span><span id="__span-3-11"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>    right: 3.333328pt
</span><span id="__span-3-12"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>    set: 'w'
</span><span id="__span-3-13"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    right: -0.277786pt
</span><span id="__span-3-14"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    set: 'orld!'
</span><span id="__span-3-15"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>  pop:
</span><span id="__span-3-16"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>pop:
</span><span id="__span-3-17"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>down: 24pt
</span><span id="__span-3-18"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>push:
</span><span id="__span-3-19"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>  right: 232.377487pt
</span><span id="__span-3-20"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>  set: '1'
</span><span id="__span-3-21"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>pop:
</span></code></pre></div>
<p>可以看到，它保存了一些命令，就像是在移动光标，然后输出文字：</p>
<ol>
<li>向下移动 643.20 pt</li>
<li>向上移动 633.20 pt</li>
<li>向右移动 20.00 pt</li>
<li>设置字体为 cmr10</li>
<li>输出 "Hello,"</li>
<li>向右移动 3.33 pt</li>
<li>输出 "w"</li>
<li>向左移动 0.28 pt</li>
<li>输出 "orld!"</li>
</ol>
<p>实际上，它的编码也比较简单，就是一个字节的命令加上若干字节的参数。DVI 二进制格式详细的文档可见 <a href="https://www.mn.uio.no/ifi/tjenester/it/hjelp/latex/dvi.pdf">https://www.mn.uio.no/ifi/tjenester/it/hjelp/latex/dvi.pdf</a>。</p>
<h3 id="dvi-ps"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#dvi-ps">从 DVI 到 PS</a></h3>
<p>有了 DVI 文件以后，下一步是用 <code>dvips</code> 工具来生成 PS 文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>dvips<span class="w"> </span>test.dvi
</span><span id="__span-4-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>This<span class="w"> </span>is<span class="w"> </span>dvips<span class="o">(</span>k<span class="o">)</span><span class="w"> </span><span class="m">2020</span>.1<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2020</span><span class="w"> </span>Radical<span class="w"> </span>Eye<span class="w"> </span>Software<span class="w"> </span><span class="o">(</span>www.radicaleye.com<span class="o">)</span>
</span><span id="__span-4-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="s1">' TeX output 2022.08.05:2058'</span><span class="w"> </span>-&gt;<span class="w"> </span>test.ps
</span><span id="__span-4-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>&lt;/usr/share/texlive/texmf-dist/dvips/base/tex.pro&gt;
</span><span id="__span-4-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>&lt;/usr/share/texlive/texmf-dist/dvips/base/texps.pro&gt;.
</span><span id="__span-4-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>&lt;/usr/share/texlive/texmf-dist/fonts/type1/public/amsfonts/cm/cmr10.pfb&gt;<span class="o">[</span><span class="m">1</span><span class="o">]</span>
</span></code></pre></div>
<p>DVI 是二进制格式，而 PS 是纯文本格式，我们可以用编辑器打开，看到里面大概有几部分内容：</p>
<ol>
<li>开头的元数据</li>
<li>tex.pro 文件的内容</li>
<li>texps.pro 文件的内容</li>
<li>定义 CMR10 字体</li>
<li>描述文档内容</li>
</ol>
<p>让我们直接来看最后一部分：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">39158280</span><span class="w"> </span><span class="mf">55380996</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="mf">600</span><span class="w"> </span><span class="mf">600</span><span class="w"> </span><span class="s">(test.dvi)</span>
</span><span id="__span-5-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nf">@start</span><span class="w"> </span><span class="nv">/Fa</span><span class="w"> </span><span class="mf">136</span><span class="p">[</span><span class="mf">60</span><span class="w"> </span><span class="mf">4</span><span class="p">[</span><span class="mf">33</span><span class="w"> </span><span class="mf">2</span><span class="p">[</span><span class="mf">42</span><span class="w"> </span><span class="mf">2</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">6</span><span class="p">[</span><span class="mf">37</span><span class="w"> </span><span class="mf">46</span><span class="w"> </span><span class="mf">27</span><span class="p">[</span><span class="mf">62</span><span class="w"> </span><span class="mf">22</span><span class="p">[</span><span class="mf">42</span>
</span><span id="__span-5-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="mf">4</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">10</span><span class="p">[</span><span class="mf">23</span><span class="w"> </span><span class="mf">33</span><span class="p">[{}</span><span class="mf">10</span><span class="w"> </span><span class="mf">83.022</span><span class="w"> </span><span class="nv">/CMR10</span><span class="w"> </span><span class="nf">rf</span><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="cs">%%EndProlog</span>
</span><span id="__span-5-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="cs">%%BeginSetup</span>
</span><span id="__span-5-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="cs">%%Feature: *Resolution 600dpi</span>
</span><span id="__span-5-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span>
</span><span id="__span-5-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="cs">%%BeginPaperSize: a4</span>
</span><span id="__span-5-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="nv">/setpagedevice</span><span class="w"> </span><span class="nf">where</span>
</span><span id="__span-5-10"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="p">{</span><span class="w"> </span><span class="nf">pop</span><span class="w"> </span><span class="p">&lt;&lt;</span><span class="w"> </span><span class="nv">/PageSize</span><span class="w"> </span><span class="p">[</span><span class="mf">595</span><span class="w"> </span><span class="mf">842</span><span class="p">]</span><span class="w"> </span><span class="p">&gt;&gt;</span><span class="w"> </span><span class="nf">setpagedevice</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-5-11"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">{</span><span class="w"> </span><span class="nv">/a4</span><span class="w"> </span><span class="nf">where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">pop</span><span class="w"> </span><span class="nf">a4</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">if</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-5-12"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="nf">ifelse</span>
</span><span id="__span-5-13"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="cs">%%EndPaperSize</span>
</span><span id="__span-5-14"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-15"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="cs">%%EndSetup</span>
</span><span id="__span-5-16"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="cs">%%Page: 1 1</span>
</span><span id="__span-5-17"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">bop</span><span class="w"> </span><span class="mf">166</span><span class="w"> </span><span class="mf">83</span><span class="w"> </span><span class="nf">a</span><span class="w"> </span><span class="nf">Fa</span><span class="s">(Hello,)</span><span class="mf">28</span><span class="w"> </span><span class="nf">b</span><span class="s">(w)</span><span class="nf">n</span><span class="s">(orld!)</span><span class="mf">1929</span>
</span><span id="__span-5-18"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="mf">5539</span><span class="w"> </span><span class="nf">y</span><span class="s">(1)</span><span class="nf">p</span><span class="w"> </span><span class="nf">eop</span><span class="w"> </span><span class="nf">end</span>
</span><span id="__span-5-19"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="cs">%%Trailer</span>
</span><span id="__span-5-20"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>
</span><span id="__span-5-21"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="nf">if</span>
</span><span id="__span-5-22"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="cs">%%EOF</span>
</span></code></pre></div>
<p>看到这个，肯定觉得很疑惑，这都是啥？除了隐约可以看到的 <code>Hello,</code> <code>w</code> <code>orld!</code> 字样以外，有很多不明含义的字母和代码。</p>
<p>为了读懂这些代码在做什么，首先来学习一下 PostScript。PostScript 是一个基于栈的语言，类似 Forth，所以很多运算都和我们平时看到的不一样。例如：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="nf">if</span>
</span></code></pre></div>
<p>实际上做的事情是，判断 userdict 中是否存在 <code>/end-hook</code>，如果存在，则展开它。它的计算过程是：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nf">userdict</span>
</span><span id="__span-7-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span>
</span><span id="__span-7-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nf">userdict</span><span class="w"> </span><span class="nv">/end-hook</span><span class="w"> </span><span class="nf">known</span>
</span><span id="__span-7-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="nf">true</span>
</span><span id="__span-7-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="nf">true</span><span class="w"> </span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span>
</span><span id="__span-7-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="nf">true</span><span class="w"> </span><span class="p">{</span><span class="nf">end-hook</span><span class="p">}</span><span class="w"> </span><span class="nf">if</span>
</span><span id="__span-7-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="nf">end-hook</span>
</span></code></pre></div>
<p>那么回过头来看 <code>Hello, world!</code> 相关的代码：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nf">TeXDict</span><span class="w"> </span><span class="nf">begin</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">bop</span><span class="w"> </span><span class="mf">166</span><span class="w"> </span><span class="mf">83</span><span class="w"> </span><span class="nf">a</span><span class="w"> </span><span class="nf">Fa</span><span class="s">(Hello,)</span><span class="mf">28</span><span class="w"> </span><span class="nf">b</span><span class="s">(w)</span><span class="nf">n</span><span class="s">(orld!)</span><span class="mf">1929</span>
</span><span id="__span-8-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="mf">5539</span><span class="w"> </span><span class="nf">y</span><span class="s">(1)</span><span class="nf">p</span><span class="w"> </span><span class="nf">eop</span><span class="w"> </span><span class="nf">end</span>
</span></code></pre></div>
<p>这里出现的 <code>TeXDict</code> <code>bop</code> <code>a</code> 等等应该也是在前面定义的了。往回翻，发现正是 <code>tex.pro</code> 文件定义了这些对象。让我们一点点来看：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nv">/TeXDict</span><span class="w"> </span><span class="mf">300</span><span class="w"> </span><span class="nf">dict</span><span class="w"> </span><span class="nf">def</span><span class="w">   </span><span class="c1">% define a working dictionary</span>
</span></code></pre></div>
<p>表示 <code>TexDict</code> 会展开为 <code>300 dict</code>，即创建一个最大容量为 300 的 dict。接下来的 begin 和 end 就是在这个 dict 的作用域中进行运算。</p>
<p>接下来是 <code>1 0 bop</code>，那么我们要看 <code>bop</code> 的定义，根据 DVI 中同名的命令，我们知道它的意思是 <code>begin of page</code>:</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nv">/bop</span><span class="w">           </span><span class="c1">% %t %d bop -  -- begin a brand new page, %t=pageno %d=seqno</span>
</span><span id="__span-10-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="p">{</span>
</span><span id="__span-10-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="nf">userdict</span><span class="w"> </span><span class="nv">/bop-hook</span><span class="w"> </span><span class="nf">known</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">bop-hook</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">if</span>
</span><span id="__span-10-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="nv">/SI</span><span class="w"> </span><span class="nf">save</span><span class="w"> </span><span class="nf">N</span>
</span><span id="__span-10-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="nf">@rigin</span>
</span><span id="__span-10-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="cm">%</span>
</span><span id="__span-10-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="cm">%   Now we check the resolution.  If it's correct, we use RV as V,</span>
</span><span id="__span-10-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="cm">%   otherwise we use QV.</span>
</span><span id="__span-10-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="cm">%</span>
</span><span id="__span-10-10"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="mf">0</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">moveto</span>
</span><span id="__span-10-11"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="nv">/V</span><span class="w"> </span><span class="nf">matrix</span><span class="w"> </span><span class="nf">currentmatrix</span>
</span><span id="__span-10-12"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="nf">A</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="nf">get</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nf">mul</span><span class="w"> </span><span class="nf">exch</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">get</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nf">mul</span><span class="w"> </span><span class="nf">add</span><span class="w"> </span><span class="mf">.99</span><span class="w"> </span><span class="nf">lt</span>
</span><span id="__span-10-13"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="p">{</span><span class="nv">/QV</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="nv">/RV</span><span class="p">}</span><span class="w"> </span><span class="nf">ifelse</span><span class="w"> </span><span class="nf">load</span><span class="w"> </span><span class="nf">def</span>
</span><span id="__span-10-14"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="nf">pop</span>
</span><span id="__span-10-15"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="nf">N</span>
</span></code></pre></div>
<p>这里有一些代码的含义我还不清楚，先跳过。</p>
<p>接下来的 <code>166 83 a</code>，根据定义就可以判断出来它是在移动位置：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nv">/a</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">moveto</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span><span class="w">    </span><span class="c1">% absolute positioning</span>
</span></code></pre></div>
<p>紧随其后的 <code>Fa</code> 指的是字体。</p>
<p>接下来是 <code>(Hello,)</code>，即把 <code>Hello,</code> 这些文字压入栈。</p>
<p>接下来看到 <code>28 b</code>，它输出了栈顶的文本，进行了一个相对的水平移动，并且更新了 delta：</p>
<div class="language-postscript highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nv">/delta</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">N</span><span class="w">         </span><span class="c1">% we need a variable to hold space moves</span>
</span><span id="__span-12-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="cm">%</span>
</span><span id="__span-12-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="cm">%   The next ten macros allow us to make horizontal motions that</span>
</span><span id="__span-12-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="cm">%   are within 4 of the previous horizontal motion with a single</span>
</span><span id="__span-12-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="cm">%   character.  These are typically used for spaces.</span>
</span><span id="__span-12-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="cm">%</span>
</span><span id="__span-12-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="nv">/tail</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">A</span><span class="w"> </span><span class="nv">/delta</span><span class="w"> </span><span class="nf">X</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="nf">rmoveto</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span>
</span><span id="__span-12-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="nv">/M</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">S</span><span class="w"> </span><span class="nf">p</span><span class="w"> </span><span class="nf">delta</span><span class="w"> </span><span class="nf">add</span><span class="w"> </span><span class="nf">tail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span>
</span><span id="__span-12-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="nv">/b</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">S</span><span class="w"> </span><span class="nf">p</span><span class="w"> </span><span class="nf">tail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">B</span><span class="w">      </span><span class="c1">% show and tail!</span>
</span></code></pre></div>
<p>后面的也都是类似的操作，让我们简单来总结一下 <code>TeXDict begin 1 0 bop 166 83 a Fa(Hello,)28 b(w)n(orld!)1929 5539 y(1)p eop end</code> 都做了什么：</p>
<ol>
<li><code>1 0 bop</code>: 创建了新页面</li>
<li><code>166 83 a</code>: 移动坐标到 <code>(166, 83)</code></li>
<li><code>Fa</code>: 设置字体</li>
<li><code>(Hello,)</code>: 压栈 "Hello,"</li>
<li><code>28 b</code>: 输出栈顶，移动坐标，对应 <code>dviasm</code> 输出中的 <code>right: 3.333328pt</code></li>
<li><code>(w)</code>: 压栈 "w"</li>
<li><code>n</code>: 输出栈顶，移动坐标，对应 <code>dviasm</code> 输出中的 <code>right: -0.277786pt</code></li>
<li><code>(orld!)</code>: 压栈 "orld!"</li>
<li><code>1929 5539 y</code>: 输出栈顶，移动坐标到页码的位置，对应 <code>dviasm</code> 输出中的 <code>down: 24pt</code> 和 <code>right: 232.377487.pt</code></li>
<li><code>(1)</code>: 压栈 "1"</li>
<li><code>p</code>: 输出栈顶</li>
<li><code>eop</code>: 结束页面</li>
</ol>
<p>由此我们基本明白了从 DVI 到 PS 是怎么一个流程：</p>
<ol>
<li>首先在 <code>tex.pro</code> 中定义了一些函数，来实现 DVI 中的命令</li>
<li>把 DVI 中的命令翻译成 PS 代码</li>
<li>把 <code>tex.pro</code>、字体等还有翻译出来的 PS 拼接起来作为最终的输出</li>
</ol>
<p>这算是一种元编程，在 PS 中定义了一个 DSL，可以很方便地执行 DVI 指令。</p>
<p>在 <a href="https://github.com/MiKTeX/miktex/blob/ab8ebca7c70fe8c9a1392dfb2393a0a7683e14cc/Programs/DviWare/dvips/source/tex.lpro">这里</a> 可以看到原始的带注释的 <code>tex.lpro</code> 实现，上面涉及 <code>tex.pro</code> 的代码内容也是从这里复制来的。</p>
<h3 id="ps-pdf"><a class="toclink" href="../../software/2022/08/05/from-tex-to-pdf/#ps-pdf">从 PS 到 PDF</a></h3>
<p>最后一步，我们可以用 <code>ps2pdf</code> 把 PS 转换为 PDF。转换以后，就可以用常见的 PDF 浏览器来阅读了。让我们解压缩其中被压缩的部分，这样就方便阅读它的内容了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>ps2pdf<span class="w"> </span>test.ps
</span><span id="__span-13-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>pdftk<span class="w"> </span>test.pdf<span class="w"> </span>output<span class="w"> </span>test.unc.pdf<span class="w"> </span>uncompress
</span></code></pre></div>
<p>在里面就可以找到我们的 <code>Hello, world!</code> 了：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>5 0 obj
</span><span id="__span-14-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>
</span><span id="__span-14-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>&lt;&lt;
</span><span id="__span-14-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>/Length 225
</span><span id="__span-14-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>&gt;&gt;
</span><span id="__span-14-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>stream
</span><span id="__span-14-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>q 0.1 0 0 0.1 0 0 cm
</span><span id="__span-14-8"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>0 g
</span><span id="__span-14-9"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>q
</span><span id="__span-14-10"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a>10 0 0 10 0 0 cm BT
</span><span id="__span-14-11"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>/R7 9.96264 Tf
</span><span id="__span-14-12"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a>1 0 0 1 91.9199 710.04 Tm
</span><span id="__span-14-13"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a>[(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ
</span><span id="__span-14-14"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a>211.56 -654.72 Td
</span><span id="__span-14-15"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a>[(1)-5.8887]TJ
</span><span id="__span-14-16"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>ET
</span><span id="__span-14-17"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a>Q
</span><span id="__span-14-18"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a>Q
</span><span id="__span-14-19"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a>
</span><span id="__span-14-20"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a>endstream
</span><span id="__span-14-21"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a>endobj
</span></code></pre></div>
<p>阅读 <a href="https://opensource.adobe.com/dc-acrobat-sdk-docs/pdfstandards/PDF32000_2008.pdf">PDF 标准</a>，可以发现它的输出文本部分是这样的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>BT
</span><span id="__span-15-2"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>    /R7 9.96264 Tf
</span><span id="__span-15-3"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>    1 0 0 1 91.9199 710.04 Tm
</span><span id="__span-15-4"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>    [(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ
</span><span id="__span-15-5"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>    211.56 -654.72 Td
</span><span id="__span-15-6"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>    [(1)-5.8887]TJ
</span><span id="__span-15-7"><a href="../../software/2022/08/05/from-tex-to-pdf/#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a>ET
</span></code></pre></div>
<p>其中：</p>
<ol>
<li><code>/R7 9.96264 Tf</code> 设置了字体 <code>/R7</code>，大小是 <code>9.96264</code></li>
<li><code>1 0 0 1 91.9199 710.04 Tm</code> 设置 Text matrix</li>
<li><code>[(H)3.21024(e)-1.66516(llo)-5.88993(,)-337.276(w)23.3747(o)-5.88993(r)-6.48419(ld)0.929988(!)]TJ</code> 输出一系列的 <code>Hello, world!</code>，中间的数字表示的是文字之间移动的坐标</li>
<li><code>211.56 -654.72 Td</code> 移动坐标到页码的位置</li>
<li><code>[(1)-5.8887]TJ</code> 输出页码</li>
</ol>
<p>可以看到，从 PS 到 PDF 这一步就不是简单的映射了，例如在 DVI 和 PS 中都是 <code>Hello,</code> <code>w</code> <code>orld!</code> 这样断开，而在 PDF 里面则是 <code>H</code> <code>e</code> <code>llo</code> <code>,</code> <code>w</code> <code>o</code> <code>r</code> <code>ld</code> <code>!</code>。</p>
<nav class="md-post__action">
<a href="../../software/2022/08/05/from-tex-to-pdf/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-08-02 00:00:00">2022年8月2日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 11 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="nix-rust"><a class="toclink" href="../../software/2022/08/02/rust-nix/">用 Nix 编译 Rust 项目</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_1">背景</a></h3>
<p>Rust 项目一般是用 Cargo 管理，但是它的缺点是每个项目都要重新编译一次所有依赖，硬盘空间占用较大，不能跨项目共享编译缓存。调研了一下，有若干基于 Nix 的 Rust 构建工具：</p>
<ul>
<li>cargo2nix: https://github.com/cargo2nix/cargo2nix</li>
<li>carnix: 不再更新</li>
<li>crane: https://github.com/ipetkov/crane</li>
<li>crate2nix: https://github.com/kolloch/crate2nix</li>
<li>naersk: https://github.com/nix-community/naersk</li>
<li>nocargo: https://github.com/oxalica/nocargo</li>
</ul>
<p>下面我分别来尝试一下这几个工具的使用。</p>
<p>下面出现的一些命令参考了对应项目的文档。</p>
<h3 id="cargo2nix"><a class="toclink" href="../../software/2022/08/02/rust-nix/#cargo2nix">cargo2nix</a></h3>
<h4 id="_2"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_2">卖点</a></h4>
<p>cargo2nix 的 README 提到了它的卖点：</p>
<ul>
<li>Development Shell - knowing all the dependencies means easy creation of complete shells. Run nix develop or direnv allow in this repo and see!</li>
<li>Caching - CI &amp; CD pipelines move faster when purity guarantees allow skipping more work!</li>
<li>Reproducibility - Pure builds. Access to all of nixpkgs for repeatable environment setup across multiple distributions and platforms</li>
</ul>
<h4 id="_3"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_3">安装</a></h4>
<p>cargo2nix 提供了 flakes 支持，不需要单独安装。</p>
<h4 id="_4"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_4">使用</a></h4>
<p>cargo2nix 的运行比较简单，利用 flakes 的特性，直接 <code>nix run</code> 即可：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>nix<span class="w"> </span>run<span class="w"> </span>github:cargo2nix/cargo2nix
</span></code></pre></div>
<p>它会生成一个 Cargo.nix 文件，还需要编写一个 <code>flake.nix</code> 配合使用，这里以 <code>jiegec/webhookd</code> 为例：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">{</span>
</span><span id="__span-1-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-1-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>    cargo2nix<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:cargo2nix/cargo2nix/release-0.11.0"</span><span class="p">;</span>
</span><span id="__span-1-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    flake-utils<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"cargo2nix/flake-utils"</span><span class="p">;</span>
</span><span id="__span-1-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>    nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"cargo2nix/nixpkgs"</span><span class="p">;</span>
</span><span id="__span-1-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>  <span class="p">};</span>
</span><span id="__span-1-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>  <span class="ss">outputs =</span> inputs<span class="p">:</span> <span class="k">with</span> inputs<span class="p">;</span>
</span><span id="__span-1-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-1-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>      <span class="k">let</span>
</span><span id="__span-1-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
</span><span id="__span-1-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>          <span class="k">inherit</span> system<span class="p">;</span>
</span><span id="__span-1-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>          <span class="ss">overlays =</span> <span class="p">[</span>cargo2nix<span class="o">.</span>overlays<span class="o">.</span>default<span class="p">];</span>
</span><span id="__span-1-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>        <span class="p">};</span>
</span><span id="__span-1-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>
</span><span id="__span-1-16"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="ss">rustPkgs =</span> pkgs<span class="o">.</span>rustBuilder<span class="o">.</span>makePackageSet <span class="p">{</span>
</span><span id="__span-1-17"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>          <span class="ss">rustVersion =</span> <span class="s2">"1.61.0"</span><span class="p">;</span>
</span><span id="__span-1-18"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>          <span class="ss">packageFun =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/Cargo.nix</span><span class="p">;</span>
</span><span id="__span-1-19"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="p">};</span>
</span><span id="__span-1-20"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>
</span><span id="__span-1-21"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-1-22"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-1-23"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>          <span class="ss">webhookd =</span> <span class="p">(</span>rustPkgs<span class="o">.</span>workspace<span class="o">.</span>webhookd <span class="p">{})</span><span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-1-24"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-1-25"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="p">};</span>
</span><span id="__span-1-26"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>      <span class="p">}</span>
</span><span id="__span-1-27"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>    <span class="p">);</span>
</span><span id="__span-1-28"><a href="../../software/2022/08/02/rust-nix/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="p">}</span>
</span></code></pre></div>
<p>然后编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-2-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-2-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>$<span class="w"> </span>./result-bin/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-2-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_5">原理</a></h4>
<p>cargo2nix 解析了 Cargo.lock，生成 Cargo.nix 文件，最后包装成 flake.nix。</p>
<h3 id="crane"><a class="toclink" href="../../software/2022/08/02/rust-nix/#crane">crane</a></h3>
<h4 id="_6"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_6">卖点</a></h4>
<p>crane 的 README 提到了它的卖点：</p>
<ul>
<li>Source fetching: automatically done using a Cargo.lock file</li>
<li>Incremental: build your workspace dependencies just once, then quickly lint, build, and test changes to your project without slowing down</li>
<li>Composable: split builds and tests into granular steps. Gate CI without burdening downstream consumers building from source.</li>
</ul>
<h4 id="_7"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_7">安装</a></h4>
<p>crane 不需要安装，直接用 flakes 即可。</p>
<h4 id="_8"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_8">使用</a></h4>
<p>crane 使用的时候，直接在项目中编写 <code>flake.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
</span><span id="__span-3-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-3-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:NixOS/nixpkgs/nixpkgs-unstable"</span><span class="p">;</span>
</span><span id="__span-3-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    crane<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:ipetkov/crane"</span><span class="p">;</span>
</span><span id="__span-3-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>    crane<span class="o">.</span>inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>
</span><span id="__span-3-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:numtide/flake-utils"</span><span class="p">;</span>
</span><span id="__span-3-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>  <span class="p">};</span>
</span><span id="__span-3-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> crane<span class="p">,</span> flake-utils<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
</span><span id="__span-3-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>      packages<span class="o">.</span><span class="ss">default =</span> crane<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>buildPackage <span class="p">{</span>
</span><span id="__span-3-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-3-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>      <span class="p">};</span>
</span><span id="__span-3-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="p">});</span>
</span><span id="__span-3-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>这样就可以了，不需要使用工具从 Cargo.lock 生成对应的 Cargo.nix。</p>
<p>但是由于 webhookd 依赖 native 库，所以还需要需要手动加入 native 依赖：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p">{</span>
</span><span id="__span-4-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-4-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:NixOS/nixpkgs/nixpkgs-unstable"</span><span class="p">;</span>
</span><span id="__span-4-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    crane<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:ipetkov/crane"</span><span class="p">;</span>
</span><span id="__span-4-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>    crane<span class="o">.</span>inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>
</span><span id="__span-4-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:numtide/flake-utils"</span><span class="p">;</span>
</span><span id="__span-4-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>  <span class="p">};</span>
</span><span id="__span-4-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>  <span class="ss">outputs =</span> <span class="p">{</span> self<span class="p">,</span> nixpkgs<span class="p">,</span> crane<span class="p">,</span> flake-utils<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
</span><span id="__span-4-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-4-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>      <span class="k">let</span>
</span><span id="__span-4-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
</span><span id="__span-4-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>          <span class="k">inherit</span> system<span class="p">;</span>
</span><span id="__span-4-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>        <span class="p">};</span>
</span><span id="__span-4-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>      <span class="k">in</span>
</span><span id="__span-4-16"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>      <span class="p">{</span>
</span><span id="__span-4-17"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>        packages<span class="o">.</span><span class="ss">default =</span> crane<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>buildPackage <span class="p">{</span>
</span><span id="__span-4-18"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-4-19"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>          <span class="ss">buildInputs =</span> <span class="k">with</span> pkgs<span class="p">;</span> <span class="p">[</span>
</span><span id="__span-4-21"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>            libiconv
</span><span id="__span-4-22"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>            darwin<span class="o">.</span>apple_sdk<span class="o">.</span>frameworks<span class="o">.</span>Security
</span><span id="__span-4-23"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>          <span class="p">];</span>
</span><span id="__span-4-24"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="p">};</span>
</span><span id="__span-4-25"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>      <span class="p">});</span>
</span><span id="__span-4-26"><a href="../../software/2022/08/02/rust-nix/#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-5-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-5-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_9"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_9">原理</a></h4>
<p>crane 会把所有的依赖下载起来用 cargo 进行一次构建，把生成的 target 目录打成 <code>target.tar.zst</code>，然后再加上项目的源代码再构建一次，这样来实现 incremental compilation。它还提供了一些 check lint 等实用的命令。但是，它的目的和其他项目不大一样，它并不考虑跨项目的依赖缓存。</p>
<h3 id="crate2nix"><a class="toclink" href="../../software/2022/08/02/rust-nix/#crate2nix">crate2nix</a></h3>
<h4 id="_10"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_10">卖点</a></h4>
<p>crate2nix 在 README 中写的卖点：</p>
<ul>
<li>Same dependency tree as cargo: It uses cargo_metadata to obtain the dependency tree from cargo. Therefore, it will use the exact same library versions as cargo and respect any locked down version in Cargo.lock.</li>
<li>Smart caching: It uses smart crate by crate caching so that nix rebuilds exactly the crates that need to be rebuilt. Compare that to docker layers...</li>
<li>Nix ecosystem goodness: You can use all things that make the nix/NixOS ecosystem great, e.g. distributed/remote builds, build minimal docker images, deploy your binary as a service to the cloud with NixOps, ...</li>
<li>Out of the box support for libraries with non-rust dependencies: It builds on top of the buildRustCrate function from NixOS so that native dependencies of many rust libraries are already correctly fetched when needed. If your library with native dependencies is not yet supported, you can customize defaultCrateOverrides / crateOverrides, see below.</li>
<li>Easy to understand nix template: The actual nix code is generated via templates/build.nix.tera so you can fix/improve the nix code without knowing rust if all the data is already there.</li>
</ul>
<h4 id="_11"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_11">安装</a></h4>
<p>首先要安装 crate2nix，由于它的稳定版本 0.10.0 已经是去年的版本了，我直接用了 master 分支。如果是直接安装，用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>nix-env<span class="w"> </span>-i<span class="w"> </span>-f<span class="w"> </span>https://github.com/kolloch/crate2nix/tarball/master
</span></code></pre></div>
<p>但我是用 flakes + home-manager 管理的，所以我实际的配置方法是：</p>
<ol>
<li>向 flake.nix 添加 crate2nix 到 inputs，并且设置 <code>crate2nix.flake = false</code></li>
<li>把 crate2nix 从 inputs 传到实际的 home manager 配置，然后在 <code>home.packages</code> 里加入 <code>callPackage crate2nix {}</code></li>
</ol>
<h4 id="_12"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_12">使用</a></h4>
<p>接下来，找到一个 Rust 项目，在其中运行 <code>crate2nix generate</code>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>crate2nix<span class="w"> </span>generate
</span><span id="__span-7-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>Generated<span class="w"> </span>./Cargo.nix<span class="w"> </span>successfully.
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>Cargo.nix<span class="w"> </span>rootCrate.build
</span></code></pre></div>
<p>编译的结果可以在 <code>result/bin</code> 下看到。</p>
<p>我编译的是 <code>jiegec/webhookd</code>，编译过程中出现了报错：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>&gt;   = note: ld: framework not found Security
</span><span id="__span-9-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>&gt;           clang-11: error: linker command failed with exit code 1 (use -v to see invocation)
</span><span id="__span-9-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>&gt;
</span><span id="__span-9-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>&gt;
</span><span id="__span-9-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>&gt; error: aborting due to previous error
</span></code></pre></div>
<p>前面的 cargo2nix 没有出现这样的问题，应该是因为 cargo2nix 帮我们引入了 Security 的依赖，见 <a href="https://github.com/cargo2nix/cargo2nix/blob/9c3b846c727300f8146f20f01c5387b398d1e0e4/overlay/overrides.nix">overrides.nix</a>。</p>
<p>根据 crate2nix 的文档，需要添加额外的 native 依赖：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p">{</span> pkgs <span class="o">?</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}:</span>
</span><span id="__span-10-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="k">let</span>
</span><span id="__span-10-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>  <span class="ss">generatedBuild =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/Cargo.nix</span> <span class="p">{</span>
</span><span id="__span-10-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="k">inherit</span> pkgs<span class="p">;</span>
</span><span id="__span-10-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="ss">defaultCrateOverrides =</span> <span class="k">with</span> pkgs<span class="p">;</span> defaultCrateOverrides <span class="o">//</span> <span class="p">{</span>
</span><span id="__span-10-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>      <span class="ss">webhookd =</span> attrs<span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="ss">buildInputs =</span>
</span><span id="__span-10-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>          lib<span class="o">.</span>optionals
</span><span id="__span-10-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>            stdenv<span class="o">.</span>isDarwin
</span><span id="__span-10-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>            <span class="p">[</span> darwin<span class="o">.</span>apple_sdk<span class="o">.</span>frameworks<span class="o">.</span>Security <span class="p">];</span>
</span><span id="__span-10-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>      <span class="p">};</span>
</span><span id="__span-10-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="p">};</span>
</span><span id="__span-10-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>  <span class="p">};</span>
</span><span id="__span-10-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="k">in</span>
</span><span id="__span-10-16"><a href="../../software/2022/08/02/rust-nix/#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>generatedBuild<span class="o">.</span>rootCrate<span class="o">.</span>build
</span></code></pre></div>
<p>然后构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>default.nix
</span><span id="__span-11-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-11-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<p>这样就可以正常运行了。</p>
<h4 id="_13"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_13">原理</a></h4>
<p>它的原理是使用 <code>cargo_metadata</code> 库从 Cargo.lock 中获取各个 crate 的信息，然后翻译成 <code>Cargo.nix</code>，之后就是由 nix 来编译各个 crate 的内容。所以一开始还是需要先用 Cargo 创建项目，添加依赖，生成 <code>Cargo.lock</code>；之后再用 <code>crate2nix generate</code> 同步依赖信息到 <code>Cargo.nix</code> 文件，构建的时候就不需要 Cargo 参与了，直接 rustc。</p>
<h3 id="naersk"><a class="toclink" href="../../software/2022/08/02/rust-nix/#naersk">naersk</a></h3>
<h4 id="_14"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_14">安装</a></h4>
<p>需要安装 <a href="https://github.com/nmattia/niv">niv</a>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>nix-env<span class="w"> </span>-iA<span class="w"> </span>nixpkgs.niv
</span></code></pre></div>
<h4 id="_15"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_15">使用</a></h4>
<p>在项目目录下，首先用 <code>niv</code> 导入 naersk：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>niv<span class="w"> </span>init
</span><span id="__span-13-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>niv<span class="w"> </span>add<span class="w"> </span>nix-community/naersk
</span></code></pre></div>
<p>然后编写一个 <code>default.nix</code>：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">let</span>
</span><span id="__span-14-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>  <span class="ss">pkgs =</span> <span class="nb">import</span> <span class="l">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">};</span>
</span><span id="__span-14-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>  <span class="ss">sources =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/nix/sources.nix</span><span class="p">;</span>
</span><span id="__span-14-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>  <span class="ss">naersk =</span> pkgs<span class="o">.</span>callPackage sources<span class="o">.</span>naersk <span class="p">{</span> <span class="p">};</span>
</span><span id="__span-14-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="k">in</span>
</span><span id="__span-14-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>naersk<span class="o">.</span>buildPackage <span class="o">.</span><span class="l">/.</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>default.nix
</span><span id="__span-15-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-15-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h4 id="_16"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_16">原理</a></h4>
<p>naersk 的原理和 crane 是类似的：把所有依赖下载下来，创建一个只有依赖的项目，然后用 cargo 预编译，编译完得到的 target 目录打成 <code>target.tar.zst</code>；然后基于预编译的结果再编译整个项目。</p>
<h3 id="nocargo"><a class="toclink" href="../../software/2022/08/02/rust-nix/#nocargo">nocargo</a></h3>
<h4 id="_17"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_17">卖点</a></h4>
<p>nocargo 的 README 提到了以下卖点：</p>
<ul>
<li>No IFDs (import-from-derivation). See meme.</li>
<li>No cargo dependency during building. Only rustc.</li>
<li>No need for hash prefetching or code generation1.</li>
<li>Crate level caching, globally shared.</li>
<li>nixpkgs integration for non-Rust dependencies.</li>
</ul>
<p>README 也提到了 nocargo, cargo2nix, naersk 和 buildRustPackage 的对比。</p>
<h4 id="_18"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_18">使用</a></h4>
<p>nocargo 目前<a href="https://github.com/oxalica/nocargo/blob/90a6d0e8dcfc2205fa69423d42bff6fd1b997121/flake.nix#L13">仅支持 x86_64-linux 平台</a>。</p>
<p>在一个 Cargo 项目中，运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>nix<span class="w"> </span>run<span class="w"> </span>github:oxalica/nocargo<span class="w"> </span>init
</span></code></pre></div>
<p>它会生成 <code>flake.nix</code> 文件如下：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-17-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">## See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span><span id="__span-17-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="p">{</span>
</span><span id="__span-17-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>  <span class="ss">description =</span> <span class="s2">"Rust package webhookd"</span><span class="p">;</span>
</span><span id="__span-17-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>
</span><span id="__span-17-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-17-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:NixOS/nixpkgs"</span><span class="p">;</span>
</span><span id="__span-17-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:numtide/flake-utils"</span><span class="p">;</span>
</span><span id="__span-17-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>    <span class="ss">nocargo =</span> <span class="p">{</span>
</span><span id="__span-17-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>      <span class="ss">url =</span> <span class="s2">"github:oxalica/nocargo"</span><span class="p">;</span>
</span><span id="__span-17-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a>      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>
</span><span id="__span-17-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a>      <span class="c1"># inputs.registry-crates-io.follows = "registry-crates-io";</span>
</span><span id="__span-17-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a>    <span class="p">};</span>
</span><span id="__span-17-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a>    <span class="c1"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span><span id="__span-17-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a>    <span class="c1"># registry-crates-io = { url = "github:rust-lang/crates.io-index"; flake = false; };</span>
</span><span id="__span-17-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a>  <span class="p">};</span>
</span><span id="__span-17-16"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a>
</span><span id="__span-17-17"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a>  <span class="ss">outputs =</span> <span class="p">{</span> nixpkgs<span class="p">,</span> flake-utils<span class="p">,</span> nocargo<span class="p">,</span> <span class="o">...</span> <span class="p">}@</span>inputs<span class="p">:</span>
</span><span id="__span-17-18"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachSystem <span class="p">[</span> <span class="s2">"x86_64-linux"</span> <span class="p">]</span> <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-17-19"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a>      <span class="k">let</span>
</span><span id="__span-17-20"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="ss">ws =</span> nocargo<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>mkRustPackageOrWorkspace <span class="p">{</span>
</span><span id="__span-17-21"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-17-22"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a>        <span class="p">};</span>
</span><span id="__span-17-23"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-17-24"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-17-25"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-17-26"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a>          <span class="ss">webhookd =</span> ws<span class="o">.</span>release<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-17-27"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a>          <span class="ss">webhookd-dev =</span> ws<span class="o">.</span>dev<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-17-28"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-28" id="__codelineno-17-28" name="__codelineno-17-28"></a>        <span class="p">};</span>
</span><span id="__span-17-29"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-29" id="__codelineno-17-29" name="__codelineno-17-29"></a>      <span class="p">});</span>
</span><span id="__span-17-30"><a href="../../software/2022/08/02/rust-nix/#__codelineno-17-30" id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="p">}</span>
</span></code></pre></div>
<p>构建：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>.
</span><span id="__span-18-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span></code></pre></div>
<p>出现了编译错误，说明 crates.io index 版本不是最新的：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>error: Package bytes doesn't have version 1.2.0 in index. Available versions: 0.0.1 0.1.0 0.1.1 0.1.2 0.2.0 0.2.1 0.2.10 0.2.11 0.2.2 0.2.3 0.2.4 0.2.5 0.2.6 0.2.7 0.2.8 0.2.9 0.3.0 0.4.0 0.4.1 0.4.10 0.4.11 0.4.12 0.4.2 0.4.3 0.4.4 0.4.5 0.4.6 0.4.7 0.4.8 0.4.9 0.5.0 0.5.1 0.5.2 0.5.3 0.5.4 0.5.5 0.5.6 0.6.0 1.0.0 1.0.1 1.1.0
</span><span id="__span-19-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>(use '--show-trace' to show detailed location information)
</span></code></pre></div>
<p>按照 <code>flake.nix</code> 中的提示，使用最新的 crates.io index：</p>
<div class="language-nix highlight"><pre><span></span><code><span id="__span-20-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">## See more usages of nocargo at https://github.com/oxalica/nocargo#readme</span>
</span><span id="__span-20-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="p">{</span>
</span><span id="__span-20-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>  <span class="ss">description =</span> <span class="s2">"Rust package webhookd"</span><span class="p">;</span>
</span><span id="__span-20-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>
</span><span id="__span-20-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>  <span class="ss">inputs =</span> <span class="p">{</span>
</span><span id="__span-20-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>    nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:NixOS/nixpkgs"</span><span class="p">;</span>
</span><span id="__span-20-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>    flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">"github:numtide/flake-utils"</span><span class="p">;</span>
</span><span id="__span-20-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a>    <span class="ss">nocargo =</span> <span class="p">{</span>
</span><span id="__span-20-9"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a>      <span class="ss">url =</span> <span class="s2">"github:oxalica/nocargo"</span><span class="p">;</span>
</span><span id="__span-20-10"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>      inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"nixpkgs"</span><span class="p">;</span>
</span><span id="__span-20-11"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a>      inputs<span class="o">.</span>registry-crates-io<span class="o">.</span><span class="ss">follows =</span> <span class="s2">"registry-crates-io"</span><span class="p">;</span>
</span><span id="__span-20-12"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a>    <span class="p">};</span>
</span><span id="__span-20-13"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-13" id="__codelineno-20-13" name="__codelineno-20-13"></a>    <span class="c1"># Optionally, you can override crates.io index to get cutting-edge packages.</span>
</span><span id="__span-20-14"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-14" id="__codelineno-20-14" name="__codelineno-20-14"></a>    <span class="ss">registry-crates-io =</span> <span class="p">{</span> <span class="ss">url =</span> <span class="s2">"github:rust-lang/crates.io-index"</span><span class="p">;</span> <span class="ss">flake =</span> <span class="no">false</span><span class="p">;</span> <span class="p">};</span>
</span><span id="__span-20-15"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-15" id="__codelineno-20-15" name="__codelineno-20-15"></a>  <span class="p">};</span>
</span><span id="__span-20-16"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-16" id="__codelineno-20-16" name="__codelineno-20-16"></a>
</span><span id="__span-20-17"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-17" id="__codelineno-20-17" name="__codelineno-20-17"></a>  <span class="ss">outputs =</span> <span class="p">{</span> nixpkgs<span class="p">,</span> flake-utils<span class="p">,</span> nocargo<span class="p">,</span> <span class="o">...</span> <span class="p">}@</span>inputs<span class="p">:</span>
</span><span id="__span-20-18"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-18" id="__codelineno-20-18" name="__codelineno-20-18"></a>    flake-utils<span class="o">.</span>lib<span class="o">.</span>eachSystem <span class="p">[</span> <span class="s2">"x86_64-linux"</span> <span class="p">]</span> <span class="p">(</span>system<span class="p">:</span>
</span><span id="__span-20-19"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-19" id="__codelineno-20-19" name="__codelineno-20-19"></a>      <span class="k">let</span>
</span><span id="__span-20-20"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-20" id="__codelineno-20-20" name="__codelineno-20-20"></a>        <span class="ss">ws =</span> nocargo<span class="o">.</span>lib<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>mkRustPackageOrWorkspace <span class="p">{</span>
</span><span id="__span-20-21"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-21" id="__codelineno-20-21" name="__codelineno-20-21"></a>          <span class="ss">src =</span> <span class="o">.</span><span class="l">/.</span><span class="p">;</span>
</span><span id="__span-20-22"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-22" id="__codelineno-20-22" name="__codelineno-20-22"></a>        <span class="p">};</span>
</span><span id="__span-20-23"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-23" id="__codelineno-20-23" name="__codelineno-20-23"></a>      <span class="k">in</span> <span class="k">rec</span> <span class="p">{</span>
</span><span id="__span-20-24"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-24" id="__codelineno-20-24" name="__codelineno-20-24"></a>        <span class="ss">packages =</span> <span class="p">{</span>
</span><span id="__span-20-25"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-25" id="__codelineno-20-25" name="__codelineno-20-25"></a>          <span class="ss">default =</span> packages<span class="o">.</span>webhookd<span class="p">;</span>
</span><span id="__span-20-26"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-26" id="__codelineno-20-26" name="__codelineno-20-26"></a>          <span class="ss">webhookd =</span> ws<span class="o">.</span>release<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-20-27"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-27" id="__codelineno-20-27" name="__codelineno-20-27"></a>          <span class="ss">webhookd-dev =</span> ws<span class="o">.</span>dev<span class="o">.</span>webhookd<span class="o">.</span>bin<span class="p">;</span>
</span><span id="__span-20-28"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-28" id="__codelineno-20-28" name="__codelineno-20-28"></a>        <span class="p">};</span>
</span><span id="__span-20-29"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-29" id="__codelineno-20-29" name="__codelineno-20-29"></a>      <span class="p">});</span>
</span><span id="__span-20-30"><a href="../../software/2022/08/02/rust-nix/#__codelineno-20-30" id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="p">}</span>
</span></code></pre></div>
<p>继续构建就成功了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>$<span class="w"> </span>nix<span class="w"> </span>build
</span><span id="__span-21-2"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>•<span class="w"> </span>Updated<span class="w"> </span>input<span class="w"> </span><span class="s1">'nocargo/registry-crates-io'</span>:
</span><span id="__span-21-3"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="s1">'github:rust-lang/crates.io-index/1ce12a7e3367a2a673f91f07ab7cc505a0b8f069'</span><span class="w"> </span><span class="o">(</span><span class="m">2022</span>-07-17<span class="o">)</span>
</span><span id="__span-21-4"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-4" id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">  </span>→<span class="w"> </span>follows<span class="w"> </span><span class="s1">'registry-crates-io'</span>
</span><span id="__span-21-5"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-5" id="__codelineno-21-5" name="__codelineno-21-5"></a>•<span class="w"> </span>Added<span class="w"> </span>input<span class="w"> </span><span class="s1">'registry-crates-io'</span>:
</span><span id="__span-21-6"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-6" id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">    </span><span class="s1">'github:rust-lang/crates.io-index/627caba32f416e706bf3f2ceac55230ec79710c5'</span><span class="w"> </span><span class="o">(</span><span class="m">2022</span>-08-02<span class="o">)</span>
</span><span id="__span-21-7"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-7" id="__codelineno-21-7" name="__codelineno-21-7"></a>$<span class="w"> </span>./result/bin/webhookd<span class="w"> </span>--version
</span><span id="__span-21-8"><a href="../../software/2022/08/02/rust-nix/#__codelineno-21-8" id="__codelineno-21-8" name="__codelineno-21-8"></a>webhookd<span class="w"> </span><span class="m">0</span>.2.1
</span></code></pre></div>
<h3 id="_19"><a class="toclink" href="../../software/2022/08/02/rust-nix/#_19">总结</a></h3>
<p>可以看到，上面的不同工具采用了不同的方法，如果要比较的话：</p>
<ul>
<li>Nix drv 粒度：每个依赖（cargo2nix，crate2nix，nocargo）、所有依赖（crane，naersk）。前者的好处是会跨项目共享依赖，进一步可以传到 binary cache。</li>
<li>是否生成包括完整依赖信息的 nix 文件：是（cargo2nix，crate2nix）、否（crane，naersk，nocargo）。生成的话，仓库里的 Cargo.lock 和 Cargo.nix 的信息是重复的，如果修改了 Cargo.lock，需要重新同步 Cargo.nix。</li>
</ul>
<nav class="md-post__action">
<a href="../../software/2022/08/02/rust-nix/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-26 00:00:00">2022年7月26日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="invalid-date"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/">invalid date 报错与时区的关系</a></h2>
<h3 id="_1"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/#_1">背景</a></h3>
<p>最近在验题的时候，@HarryChen 发现了一个现象：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">"1919-04-13"</span>
</span><span id="__span-0-2"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>date:<span class="w"> </span>invalid<span class="w"> </span>date<span class="w"> </span>‘1919-04-13’
</span><span id="__span-0-3"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>$<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>UTC<span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">"1919-04-13"</span>
</span><span id="__span-0-4"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">00</span>:00:00<span class="w"> </span>UTC<span class="w"> </span><span class="m">1919</span>
</span></code></pre></div>
<p>也就是说，这个现象与时区有关，那么为啥 <code>1919-04-13</code> 是一个不合法的日期呢？</p>
<h3 id="_2"><a class="toclink" href="../../software/2022/07/26/invalid-date-timezone/#_2">时区</a></h3>
<p>实际上，对于某一个时区来说，有的时间是不存在的，最常见的就是夏令时。在 <a href="https://timezonedb.com/time-zones/Asia/Shanghai">Timezone DB</a> 里可以看到，恰好在 1919 年 4 月 13 日发生了一次 UTC+8 到 UTC+9 的变化，因此零点变成了一点，就变成了不合法的日期。</p>
<p>这个数据，实际上保存在 tzdata 中，可以用 zdump 工具查看：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>$<span class="w"> </span>tzdata<span class="w"> </span>-v<span class="w"> </span>Asia/Shanghai
</span><span id="__span-1-2"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Dec<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-3"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Dec<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">20</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Dec<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">04</span>:45:52<span class="w"> </span><span class="m">1901</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-4"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-5"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-6"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-7"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1919</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-8"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-9"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jun<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-10"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-11"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Oct<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1940</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-12"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-13"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Mar<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Mar<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-14"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-15"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Nov<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1941</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-16"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-17"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Jan<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Jan<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1942</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-18"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-19"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Sep<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1945</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-20"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-21"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>May<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Wed<span class="w"> </span>May<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-22"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-23"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1946</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-24"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-25"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-26"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-27"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Oct<span class="w"> </span><span class="m">31</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1947</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-28"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-29"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-30"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-31"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>Asia/Shanghai<span class="w">  </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Thu<span class="w"> </span>Sep<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1948</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-32"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">15</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-33"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">16</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-34"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">14</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:59:59<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-35"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>Asia/Shanghai<span class="w">  </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">15</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Fri<span class="w"> </span>May<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">23</span>:00:00<span class="w"> </span><span class="m">1949</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-36"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-37"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>May<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>May<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-38"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-39"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1986</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-40"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-41"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-42"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-43"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1987</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-44"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-45"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-46"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-47"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1988</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-48"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-49"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-50"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-51"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1989</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-52"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-53"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-54"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-55"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1990</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-56"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">17</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-57"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Apr<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">18</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Apr<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">03</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-58"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">16</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:59:59<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CDT<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-1-59"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>Asia/Shanghai<span class="w">  </span>Sat<span class="w"> </span>Sep<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">17</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Sun<span class="w"> </span>Sep<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">01</span>:00:00<span class="w"> </span><span class="m">1991</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-60"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>Asia/Shanghai<span class="w">  </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Mon<span class="w"> </span>Jan<span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-1-61"><a href="../../software/2022/07/26/invalid-date-timezone/#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>Asia/Shanghai<span class="w">  </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">03</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span><span class="nv">UTC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Tue<span class="w"> </span>Jan<span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">11</span>:14:07<span class="w"> </span><span class="m">2038</span><span class="w"> </span>CST<span class="w"> </span><span class="nv">isdst</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>可以看到，它列出来了历史上 Asia/Shanghai 时区的变化历史。具体的历史，可以查看 <a href="https://zh.wikipedia.org/zh-cn/%E4%B8%AD%E5%9C%8B%E6%99%82%E5%8D%80">中国时区</a>。</p>
<p>此外，历史上，从儒略历到格里高利历的演变过程，也出现了一段“不存在”的日期，如 <a href="https://stackoverflow.com/questions/35194544/setting-october-14-1582-fails-in-java-sql-date">Setting October 14 ,1582 fails in java.sql.Date</a>。</p>
<nav class="md-post__action">
<a href="../../software/2022/07/26/invalid-date-timezone/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2022-07-16 00:00:00">2022年7月16日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="../../category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 14 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ceph-cookbook"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/">Ceph Cookbook</a></h2>
<h3 id="_1"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_1">概念</a></h3>
<ul>
<li>OSD：负责操作硬盘的程序，一个硬盘一个 OSD</li>
<li>MON：管理集群状态，比较重要，可以在多个节点上各跑一个</li>
<li>MGR：监测集群状态</li>
<li>RGW(optional)：提供对象存储 API</li>
<li>MDS(optional)：提供 CephFS</li>
</ul>
<p>使用 Ceph 做存储的方式：</p>
<ol>
<li>librados: 库</li>
<li>radosgw: 对象存储 HTTP API</li>
<li>rbd: 块存储</li>
<li>cephfs: 文件系统</li>
</ol>
<h3 id="_2"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_2">认证</a></h3>
<p>Ceph 客户端认证需要用户名 + 密钥。默认情况下，用户名是 <code>client.admin</code>，密钥路径是 <code>/etc/ceph/ceph.用户名.keyring</code>。<code>ceph --user abc</code> 表示以用户 <code>client.abc</code> 的身份访问集群。</p>
<p>用户的权限是按照服务类型决定的。可以用 <code>ceph auth ls</code> 显示所有的用户以及权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>auth<span class="w"> </span>ls
</span><span id="__span-0-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>osd.0
</span><span id="__span-0-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span>key:<span class="w"> </span>REDACTED
</span><span id="__span-0-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mgr<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>profile<span class="w"> </span>osd
</span><span id="__span-0-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mon<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>profile<span class="w"> </span>osd
</span><span id="__span-0-6"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>osd<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-7"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>client.admin
</span><span id="__span-0-8"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span>key:<span class="w"> </span>REDACTED
</span><span id="__span-0-9"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mds<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-10"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mgr<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-11"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>mon<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span><span id="__span-0-12"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span>caps:<span class="w"> </span><span class="o">[</span>osd<span class="o">]</span><span class="w"> </span>allow<span class="w"> </span>*
</span></code></pre></div>
<p>可以看到，<code>osd.0</code> 对 OSD 有所有权限，对 mgr 和 mon 都只有 osd 相关功能的权限；<code>client.admin</code> 有所有权限。<code>profile</code> 可以认为是预定义的一些权限集合。</p>
<p>新建用户并赋予权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get-or-create<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">'allow r'</span>
</span></code></pre></div>
<p>修改权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>caps<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">'allow rw'</span>
</span></code></pre></div>
<p>获取权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get<span class="w"> </span>client.abc
</span></code></pre></div>
<p>删除用户：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>print-key<span class="w"> </span>client.abc
</span></code></pre></div>
<h3 id="osd"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#osd">OSD</a></h3>
<p>管理 OSD 实际上就是管理存储数据的硬盘。</p>
<p>查看状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>stat
</span></code></pre></div>
<p>显示有多少个在线和离线的 OSD。</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>tree
</span></code></pre></div>
<p>显示了存储的层级，其中 ID 非负数是实际的 OSD，负数是其他层级，例如存储池，机柜，主机等等。</p>
<h3 id="crush"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#crush">CRUSH</a></h3>
<p>CRUSH 是一个算法，指定了如何给 PG 分配 OSD，到什么类型的设备，确定它的 failure domain 等等。例如，如果指定 failure domain 为 host，那么它就会分配到不同 host 上的 osd，这样一个 host 挂了不至于全军覆没。类似地，还可以设定更多级别的 failure domain，例如 row，rack，chassis 等等。</p>
<p>OSD 可以设置它的 CRUSH Location，在 ceph.conf 中定义。</p>
<p>为了配置数据置放的规则，需要设置 CRUSH Rule。</p>
<p>列举 CRUSH Rule：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>ls
</span><span id="__span-7-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>dump
</span></code></pre></div>
<p>查看 CRUSH 层级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>tree<span class="w"> </span>--show-shadow
</span></code></pre></div>
<p>在里面可能会看到 <code>default~ssd</code>，它指的意思就是只保留 default 下面的 ssd 设备。</p>
<p>文本形式导出 CRUSH 配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>getcrushmap<span class="w"> </span><span class="p">|</span><span class="w"> </span>crushtool<span class="w"> </span>-d<span class="w"> </span>-<span class="w"> </span>-o<span class="w"> </span>crushmap
</span><span id="__span-9-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>cat<span class="w"> </span>crushmap
</span></code></pre></div>
<p>可以看到 Rule 的定义，如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>## simple replicated
</span><span id="__span-10-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>rule replicated_rule {
</span><span id="__span-10-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>        id 0
</span><span id="__span-10-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>        # a replicated rule
</span><span id="__span-10-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>        type replicated
</span><span id="__span-10-6"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>        # iterate all devices of "default"
</span><span id="__span-10-7"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>        step take default
</span><span id="__span-10-8"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>        # select n osd with failure domain "osd"
</span><span id="__span-10-9"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>        # firstn: continuous
</span><span id="__span-10-10"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>        step chooseleaf firstn 0 type osd
</span><span id="__span-10-11"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>        step emit
</span><span id="__span-10-12"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>}
</span><span id="__span-10-13"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>
</span><span id="__span-10-14"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>## erasure on hdd
</span><span id="__span-10-15"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>rule erasure-hdd {
</span><span id="__span-10-16"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>        id 4
</span><span id="__span-10-17"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>        # an erasure rule
</span><span id="__span-10-18"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a>        type erasure
</span><span id="__span-10-19"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a>        # try more times to find a good mapping
</span><span id="__span-10-20"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>        step set_chooseleaf_tries 5
</span><span id="__span-10-21"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a>        step set_choose_tries 100
</span><span id="__span-10-22"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a>        # iterate hdd devices of "default", i.e. "default~hdd"
</span><span id="__span-10-23"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a>        step take default class hdd
</span><span id="__span-10-24"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a>        # select n osd with failure domain "osd"
</span><span id="__span-10-25"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a>        # indep: replace failed osd with another
</span><span id="__span-10-26"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a>        step choose indep 0 type osd
</span><span id="__span-10-27"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a>        step emit
</span><span id="__span-10-28"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a>}
</span><span id="__span-10-29"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a>
</span><span id="__span-10-30"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a>## replicated on hdd
</span><span id="__span-10-31"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a>rule replicated-hdd-osd {
</span><span id="__span-10-32"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a>        id 5
</span><span id="__span-10-33"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a>        # a replicated rule
</span><span id="__span-10-34"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a>        type replicated
</span><span id="__span-10-35"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a>        # iterate hdd devices of "default", i.e. "default~hdd"
</span><span id="__span-10-36"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a>        step take default class hdd
</span><span id="__span-10-37"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a>        # select n osd with failure domain "osd"
</span><span id="__span-10-38"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a>        # firstn: continuous
</span><span id="__span-10-39"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a>        step choose firstn 0 type osd
</span><span id="__span-10-40"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a>        step emit
</span><span id="__span-10-41"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a>}
</span><span id="__span-10-42"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a>
</span><span id="__span-10-43"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a>## replicated on different hosts
</span><span id="__span-10-44"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a>rule replicated-host {
</span><span id="__span-10-45"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a>        id 6
</span><span id="__span-10-46"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a>        # a replicated rule
</span><span id="__span-10-47"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a>        type replicated
</span><span id="__span-10-48"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a>        # iterate all devices of "default"
</span><span id="__span-10-49"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a>        step take default
</span><span id="__span-10-50"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a>        # select n osd with failure domain "host"
</span><span id="__span-10-51"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a>        # firstn: continuous
</span><span id="__span-10-52"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a>        step chooseleaf firstn 0 type host
</span><span id="__span-10-53"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a>        step emit
</span><span id="__span-10-54"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a>}
</span><span id="__span-10-55"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a>
</span><span id="__span-10-56"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a>## replicate one on ssd, two on hdd
</span><span id="__span-10-57"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a>rule replicated-ssd-primary {
</span><span id="__span-10-58"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a>        id 7
</span><span id="__span-10-59"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a>        # a replicated rule
</span><span id="__span-10-60"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a>        type replicated
</span><span id="__span-10-61"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a>
</span><span id="__span-10-62"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a>        # iterate ssd devices of "default"
</span><span id="__span-10-63"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a>        step take default class ssd
</span><span id="__span-10-64"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-64" id="__codelineno-10-64" name="__codelineno-10-64"></a>        step chooseleaf firstn 1 type host
</span><span id="__span-10-65"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-65" id="__codelineno-10-65" name="__codelineno-10-65"></a>        step emit
</span><span id="__span-10-66"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-66" id="__codelineno-10-66" name="__codelineno-10-66"></a>
</span><span id="__span-10-67"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-67" id="__codelineno-10-67" name="__codelineno-10-67"></a>        # iterate hdd devices of "default"
</span><span id="__span-10-68"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-68" id="__codelineno-10-68" name="__codelineno-10-68"></a>        step take default class hdd
</span><span id="__span-10-69"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-69" id="__codelineno-10-69" name="__codelineno-10-69"></a>        step chooseleaf firstn 2 type host
</span><span id="__span-10-70"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-70" id="__codelineno-10-70" name="__codelineno-10-70"></a>        step emit
</span><span id="__span-10-71"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-10-71" id="__codelineno-10-71" name="__codelineno-10-71"></a>}
</span></code></pre></div>
<p>choose 和 chooseleaf 的区别是，前者可以 choose 到中间层级，例如先选择 host，再在 host 里面选 osd；而 chooseleaf 是直接找到 osd。所以 <code>choose type osd</code> 和 <code>chooseleaf type osd</code> 是等价的。</p>
<p>如果这个搜索条件比较复杂，例如找到了某一个 host，里面的 osd 个数不够，就需要重新搜。</p>
<p>新建一个 Replicated CRUSH Rule：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">## root=default, failure domain=osd</span>
</span><span id="__span-11-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>create-replicated<span class="w"> </span>xxx<span class="w"> </span>default<span class="w"> </span>osd
</span><span id="__span-11-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="c1">## root=default, failure domain=host, class=ssd</span>
</span><span id="__span-11-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>rule<span class="w"> </span>create-replicated<span class="w"> </span>yyy<span class="w"> </span>default<span class="w"> </span>host<span class="w"> </span>ssd
</span></code></pre></div>
<p>如果指定了 device class，它只会在对应类型的设备上存储。</p>
<h3 id="pool"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#pool">Pool</a></h3>
<p>Pool 是存储池，后续的 RBD/CephFS 功能都需要指定存储池来工作。</p>
<p>创建存储池：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>create<span class="w"> </span>xxx
</span><span id="__span-12-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>create<span class="w"> </span>PG_NUM
</span></code></pre></div>
<p>为了性能考虑，可以设置 PG（Placement Group）数量。默认情况下，会创建 replicated 类型的存储池，也就是会存多份，类似 RAID1。也可以设置成 erasure 类型的存储池，类似 RAID5。</p>
<p>每个 Placement Group 里的数据会保存在同一组 OSD 中。数据通过 hash，会分布在不同的 PG 里。</p>
<p>列举所有的存储池：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>lspools
</span></code></pre></div>
<p>查看存储池的使用量：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>rados<span class="w"> </span>df
</span></code></pre></div>
<p>存储池的 IO 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>stats
</span></code></pre></div>
<p>对存储池做快照：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>mksnap<span class="w"> </span>xxx<span class="w"> </span>snap-xxx-123
</span></code></pre></div>
<h4 id="pg"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#pg">PG</a></h4>
<p>PG 是数据存放的组，每个对象都会放到一个 PG 里面，而 PG 会决定它保存到哪些 OSD 上（具体哪些 OSD 是由 CRUSH 决定的）。PG 数量只有一个的话，那么一个 pool 的所有数据都会存放在某几个 OSD 中，一旦这几个 OSD 都不工作了，那么整个 pool 的数据都不能访问了。PG 增多了以后，就会分布到不同的 OSD 上，并且各个 OSD 的占用也会比较均匀。</p>
<p>查看 PG 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a>ceph<span class="w"> </span>pg<span class="w"> </span>dump
</span></code></pre></div>
<h5 id="auto-scale"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#auto-scale">Auto Scale</a></h5>
<p>PG 数量可以让集群自动调整：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">set</span><span class="w"> </span>xxx<span class="w"> </span>pg_autoscale_mode<span class="w"> </span>on
</span></code></pre></div>
<p>设置 autoscale 目标为每个 OSD 平均 100 个 PG：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>global<span class="w"> </span>mon_target_pg_per_osd<span class="w"> </span><span class="m">100</span>
</span></code></pre></div>
<p>全局 autoscale 开关：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">## Enable</span>
</span><span id="__span-20-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">unset</span><span class="w"> </span>noautoscale
</span><span id="__span-20-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="c1">## Disable</span>
</span><span id="__span-20-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span><span class="nb">set</span><span class="w"> </span>unautoscale
</span><span id="__span-20-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="c1">## Read</span>
</span><span id="__span-20-6"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>get<span class="w"> </span>noautoscale
</span></code></pre></div>
<p>查看 autoscale 状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>autoscale-status
</span></code></pre></div>
<p>如果没有显示，说明 autoscale 没有工作，可能的原因是，部分 pool 采用了指定 osd class 的 crush rule，例如指定了 hdd 盘，但是也有部分 pool 没有指定盘的类型，例如默认的 replicated_rule。这时候，把这些盘也设置成一个指定 osd class 的 crush rule 即可。</p>
<h3 id="rbd"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#rbd">RBD</a></h3>
<p>RBD 把 Ceph 暴露为块设备。</p>
<h4 id="_3"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_3">创建</a></h4>
<p>初始化 Pool 用于 RBD：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>rbd<span class="w"> </span>pool<span class="w"> </span>init<span class="w"> </span>xxx
</span></code></pre></div>
<p>为了安全性考虑，一般会为 RBD 用户创建单独的用户：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>ceph<span class="w"> </span>auth<span class="w"> </span>get-or-create<span class="w"> </span>client.abc<span class="w"> </span>mon<span class="w"> </span><span class="s1">'profile rbd'</span><span class="w"> </span>osd<span class="w"> </span><span class="s1">'profile rbd pool=xxx'</span><span class="w"> </span>mgr<span class="w"> </span><span class="s1">'profile rbd pool=xxx'</span>
</span></code></pre></div>
<p>创建 RBD 镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>rbd<span class="w"> </span>create<span class="w"> </span>--size<span class="w"> </span><span class="m">1024</span><span class="w"> </span>xxx/yyy
</span></code></pre></div>
<p>表示在 Pool xxx 上面创建了一个名字为 yyy 大小为 1024MB 的镜像。</p>
<h4 id="_4"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_4">状态</a></h4>
<p>列举 Pool 里的镜像：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>rbd<span class="w"> </span>ls
</span><span id="__span-25-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>rbd<span class="w"> </span>ls<span class="w"> </span>xxx
</span></code></pre></div>
<p>默认的 Pool 名字是 <code>rbd</code>。</p>
<p>查看镜像信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>rbd<span class="w"> </span>info<span class="w"> </span>yyy
</span><span id="__span-26-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>rbd<span class="w"> </span>info<span class="w"> </span>xxx/yyy
</span></code></pre></div>
<h4 id="_5"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_5">扩容</a></h4>
<p>修改镜像的容量：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>rbd<span class="w"> </span>resize<span class="w"> </span>--size<span class="w"> </span><span class="m">2048</span><span class="w"> </span>yyy
</span><span id="__span-27-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a>rbd<span class="w"> </span>resize<span class="w"> </span>--size<span class="w"> </span><span class="m">512</span><span class="w"> </span>yyy<span class="w"> </span>--allow-shrink
</span></code></pre></div>
<h4 id="_6"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_6">挂载</a></h4>
<p>在其他机器挂载 RBD 的时候，首先要修改 <code>/etc/ceph</code> 下配置，确认有用户，密钥和 MON 的地址。</p>
<p>然后，用 rbd 挂载设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-28-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a>rbd<span class="w"> </span>device<span class="w"> </span>map<span class="w"> </span>xxx/yyy<span class="w"> </span>--id<span class="w"> </span>abc
</span></code></pre></div>
<p>以用户 abc 的身份挂载 Pool xxx 下面的 yyy 镜像。</p>
<p>这时候就可以在 <code>/dev/rbd*</code> 或者 <code>/dev/rbd/</code> 下面看到设备文件了。</p>
<p>显示已经挂载的设备：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-29-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a>rbd<span class="w"> </span>device<span class="w"> </span>list
</span></code></pre></div>
<h3 id="cephfs"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#cephfs">CephFS</a></h3>
<h4 id="_7"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_7">创建</a></h4>
<p>如果配置了编排器（Orchestrator），可以直接用命令：</p>
<p><div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a>ceph<span class="w"> </span>fs<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>xxx
</span></code></pre></div>
创建一个名为 <code>xxx</code> 的 CephFS。</p>
<p>也可以手动创建：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a>ceph osd pool create xxx_data0
</span><span id="__span-31-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a>ceph osd pool create xxx_metadata
</span><span id="__span-31-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a>ceph fs new xxx xxx_metadata xxx_data0
</span></code></pre></div>
<p>这样就创建了两个 pool，分别用于存储元数据和文件数据。一个 CephFS 需要一个 pool 保存元数据，若干个 pool 保存文件数据。</p>
<p>创建了 CephFS 以后，相应的 MDS 也会启动。</p>
<h4 id="_8"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_8">状态</a></h4>
<p>查看 MDS 状态：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a>ceph mds stat
</span></code></pre></div>
<h4 id="_9"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_9">客户端配置</a></h4>
<p>在挂载 CephFS 之前，首先要配置客户端。</p>
<p>在集群里运行 <code>ceph config generate-minimal-conf</code>，它会生成一个配置文件：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-33-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>config<span class="w"> </span>generate-minimal-conf
</span><span id="__span-33-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="c1">## minimal ceph.conf for &lt;fsid&gt;</span>
</span><span id="__span-33-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="o">[</span>global<span class="o">]</span>
</span><span id="__span-33-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-4" id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">        </span><span class="nv">fsid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;fsid&gt;
</span><span id="__span-33-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-33-5" id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">        </span><span class="nv">mon_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>v2:x.x.x.x:3300/0,v1:x.x.x.x:6789/0<span class="o">]</span>
</span></code></pre></div>
<p>把内容复制到客户端的 <code>/etc/ceph/ceph.conf</code>。这样客户端就能找到集群的 MON 地址和 FSID。</p>
<p>接着，我们在集群上给客户端创建一个用户：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a>ceph fs authorize xxx client.abc / rw
</span></code></pre></div>
<p>创建一个用户 abc，对 CephFS xxx 有读写的权限。把输出保存到客户端的 <code>/etc/ceph/ceph.client.abc.keyring</code> 即可。</p>
<h4 id="_10"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_10">挂载</a></h4>
<p>挂载：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-35-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@.xxx<span class="o">=</span>/<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="c1">## or</span>
</span><span id="__span-35-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-3" id="__codelineno-35-3" name="__codelineno-35-3"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@&lt;fsid&gt;.xxx<span class="o">=</span>/<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-4" id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="c1">## or</span>
</span><span id="__span-35-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-5" id="__codelineno-35-5" name="__codelineno-35-5"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@&lt;fsid&gt;.xxx<span class="o">=</span>/<span class="w"> </span>-o<span class="w"> </span><span class="nv">mon_addr</span><span class="o">=</span>x.x.x.x:6789,secret<span class="o">=</span>REDACTED<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-6"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-6" id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="c1">##or</span>
</span><span id="__span-35-7"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-7" id="__codelineno-35-7" name="__codelineno-35-7"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>abc@.xxx<span class="o">=</span>/<span class="w"> </span>-o<span class="w"> </span><span class="nv">mon_addr</span><span class="o">=</span>x.x.x.x:6789/y.y.y.y:6789,secretfile<span class="o">=</span>/etc/ceph/xxx.secret<span class="w"> </span>MOUNTPOINT
</span><span id="__span-35-8"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-8" id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="c1">## or</span>
</span><span id="__span-35-9"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-35-9" id="__codelineno-35-9" name="__codelineno-35-9"></a>mount<span class="w"> </span>-t<span class="w"> </span>ceph<span class="w"> </span>-o<span class="w"> </span><span class="nv">name</span><span class="o">=</span>client.abc,secret<span class="o">=</span>REDACTED,mds_namespace<span class="o">=</span>xxx<span class="w"> </span>MON_IP:/<span class="w"> </span>MOUNTPOINT
</span></code></pre></div>
<p>以用户 <code>client.abc</code> 的身份登录，挂载 CepFS <code>xxx</code> 下面的 <code>/</code> 目录到 <code>MOUNTPOINT</code>。它会读取 <code>/etc/ceph</code> 下面的配置，如果已经 <code>ceph.conf</code> 写了，命令行里就可以不写。</p>
<p>fsid 指的不是 CephFS 的 ID，实际上是集群的 ID：<code>ceph fsid</code>。</p>
<h4 id="_11"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_11">限额</a></h4>
<p>CephFS 可以对目录进行限额：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-36-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a>setfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_bytes<span class="w"> </span>-v<span class="w"> </span>LIMIT<span class="w"> </span>PATH
</span><span id="__span-36-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a>setfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_files<span class="w"> </span>-v<span class="w"> </span>LIMIT<span class="w"> </span>PATH
</span><span id="__span-36-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a>getfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_bytes<span class="w"> </span>PATH
</span><span id="__span-36-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a>getfattr<span class="w"> </span>-n<span class="w"> </span>ceph.quota.max_files<span class="w"> </span>PATH
</span></code></pre></div>
<p>限制目录大小和文件数量。LIMIT 是 0 的时候表示没有限制。</p>
<h4 id="nfs"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#nfs">NFS</a></h4>
<p>可以把 CephFS 或者 RGW 通过 NFS 的方式共享出去。</p>
<p>启动 NFS 服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-37-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>create<span class="w"> </span>xxx
</span><span id="__span-37-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>create<span class="w"> </span>xxx<span class="w"> </span><span class="s2">"host1,host2"</span>
</span></code></pre></div>
<p>在主机上运行 NFS 服务器，NFS 集群的名字叫做 xxx。</p>
<p>查看 NFS 集群信息：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-38-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>info<span class="w"> </span>xxx
</span></code></pre></div>
<p>列举所有 NFS 集群：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span>cluster<span class="w"> </span>ls
</span></code></pre></div>
<p>NFS 导出 CephFS：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a>ceph<span class="w"> </span>nfs<span class="w"> </span><span class="nb">export</span><span class="w"> </span>create<span class="w"> </span>cephfs<span class="w"> </span>--cluster-id<span class="w"> </span>xxx<span class="w"> </span>--pseudo-path<span class="w"> </span>/a/b/c<span class="w"> </span>--fsname<span class="w"> </span>some-cephfs-name<span class="w"> </span><span class="o">[</span>--path<span class="o">=</span>/d/e/f<span class="o">]</span><span class="w"> </span><span class="o">[</span>--client_addr<span class="w"> </span>y.y.y.y<span class="o">]</span>
</span></code></pre></div>
<p>这样就导出了 CephFS 内的一个目录，客户端可以通过 NFS 挂载 /a/b/c 路径（pseudo path）来访问。可以设置客户端的 IP 访问权限。</p>
<p>这样在客户端就可以 mount：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-41-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a>mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>x.x.x.x:/a/b/c<span class="w"> </span>/mnt
</span></code></pre></div>
<h3 id="radosgw"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#radosgw">RadosGW</a></h3>
<p>RGW 提供了 S3 或者 OpenStack Swift 兼容的对象存储 API。</p>
<p>TODO</p>
<h3 id="_12"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_12">编排器</a></h3>
<p>由于 Ceph 需要运行多个 daemon，并且都在不同的容器中运行，所以一般会跑一个系统级的编排器，用于新增和管理这些容器。</p>
<p>查看当前编排器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a>$<span class="w"> </span>ceph<span class="w"> </span>orch<span class="w"> </span>status
</span><span id="__span-42-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a>Backend:<span class="w"> </span>cephadm
</span><span id="__span-42-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-3" id="__codelineno-42-3" name="__codelineno-42-3"></a>Available:<span class="w"> </span>Yes
</span><span id="__span-42-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-42-4" id="__codelineno-42-4" name="__codelineno-42-4"></a>Paused:<span class="w"> </span>No
</span></code></pre></div>
<p>比较常见的就是 cephadm，安装的时候如果用了 cephadm，那么编排器也是它。</p>
<p>被编排的服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-43-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ls
</span></code></pre></div>
<p>被编排的容器：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-44-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ps
</span></code></pre></div>
<p>被编排的主机：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>host<span class="w"> </span>ls
</span></code></pre></div>
<h4 id="_13"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_13">添加新机器</a></h4>
<p>首先，复制 <code>/etc/ceph/ceph.pub</code> 到新机器的 <code>/root/.ssh/authorized_keys</code> 中</p>
<p>接着，添加机器到编排器中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-46-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>host<span class="w"> </span>add<span class="w"> </span>xxxx<span class="w"> </span>y.y.y.y
</span></code></pre></div>
<p>导出编排器配置：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-47-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ls<span class="w"> </span>--export<span class="w"> </span>&gt;<span class="w"> </span>cephadm.yaml
</span></code></pre></div>
<p>如果想让一些 daemon 只运行在部分主机上，可以修改：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-48-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="c1">## change</span>
</span><span id="__span-48-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="nt">placement</span><span class="p">:</span>
</span><span id="__span-48-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-3" id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">  </span><span class="nt">host_pattern</span><span class="p">:</span><span class="w"> </span><span class="s">'*'</span>
</span><span id="__span-48-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-4" id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="c1">## to</span>
</span><span id="__span-48-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-5" id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="nt">placement</span><span class="p">:</span>
</span><span id="__span-48-6"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-48-6" id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">  </span><span class="nt">host_pattern</span><span class="p">:</span><span class="w"> </span><span class="s">'xxx'</span>
</span></code></pre></div>
<p>然后应用：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-49-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>-i<span class="w"> </span>cephadm.yaml
</span></code></pre></div>
<h4 id="_14"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_14">配置监控</a></h4>
<p>添加监控相关的服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-50-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>node-exporter
</span><span id="__span-50-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-2" id="__codelineno-50-2" name="__codelineno-50-2"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>alertmanager
</span><span id="__span-50-3"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-3" id="__codelineno-50-3" name="__codelineno-50-3"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>prometheus
</span><span id="__span-50-4"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-4" id="__codelineno-50-4" name="__codelineno-50-4"></a>ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>grafana
</span><span id="__span-50-5"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-50-5" id="__codelineno-50-5" name="__codelineno-50-5"></a>ceph<span class="w"> </span>orch<span class="w"> </span>ps
</span></code></pre></div>
<p>然后就可以访问 Grafana 看到集群的状态。</p>
<h3 id="_15"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_15">更新</a></h3>
<p>使用容器编排器来升级：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-51-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>start<span class="w"> </span>--ceph-version<span class="w"> </span>x.x.x
</span><span id="__span-51-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-51-2" id="__codelineno-51-2" name="__codelineno-51-2"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>start<span class="w"> </span>--image<span class="w"> </span>quay.io/ceph/ceph:vx.x.x
</span></code></pre></div>
<p>如果 docker hub 上找不到 image，就从 quay.io 拉取。</p>
<p>查看升级状态：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-52-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a>ceph<span class="w"> </span>orch<span class="w"> </span>upgrade<span class="w"> </span>status
</span><span id="__span-52-2"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-52-2" id="__codelineno-52-2" name="__codelineno-52-2"></a>ceph<span class="w"> </span>-s
</span></code></pre></div>
<p>查看 cephadm 日志：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-53-1"><a href="../../devops/2022/07/16/ceph-cookbook/#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a>ceph<span class="w"> </span>-W<span class="w"> </span>cephadm
</span></code></pre></div>
<h3 id="_16"><a class="toclink" href="../../devops/2022/07/16/ceph-cookbook/#_16">参考文档</a></h3>
<ul>
<li><a href="https://docs.ceph.com/en/latest/architecture/">Ceph Architecture</a></li>
<li><a href="https://docs.ceph.com/en/latest/rados/operations/user-management/">Ceph User Management</a></li>
<li><a href="https://docs.ceph.com/en/latest/cephfs/createfs/">Ceph Create a Ceph File System</a></li>
<li><a href="https://docs.ceph.com/en/latest/man/8/mount.ceph/">mount.ceph</a></li>
<li><a href="https://docs.ceph.com/en/latest/cephfs/quota/">Ceph CephFS Quota</a></li>
<li><a href="https://docs.ceph.com/en/latest/rbd/rados-rbd-cmds/">Ceph Basic Block Device Commands</a></li>
<li><a href="https://docs.ceph.com/en/quincy/cephadm/upgrade/">Ceph Upgrade</a></li>
<li><a href="https://docs.ceph.com/en/latest/mgr/nfs/">Ceph CephFS &amp; RGW Exports Over NFS</a></li>
<li><a href="https://docs.ceph.com/en/quincy/rados/operations/crush-map/">CRUSH Maps</a></li>
<li><a href="https://docs.ceph.com/en/latest/rados/operations/crush-map-edits/">CRUSH Map Edits</a></li>
<li><a href="https://llussy.github.io/2019/08/17/ceph-architecture/">ceph 架构和概念</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/5/html/object_gateway_guide/the-ceph-object-gateway_rgw">RedHat Object Gateway Guide</a></li>
</ul>
<nav class="md-post__action">
<a href="../../devops/2022/07/16/ceph-cookbook/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../3/">3</a> <a class="md-pagination__link" href="../4/">4</a> <span class="md-pagination__current">5</span> <a class="md-pagination__link" href="../6/">6</a> <a class="md-pagination__link" href="../7/">7</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="../../about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>