<!DOCTYPE html>
<html>
<head>
    <title>杰哥的{运维,编程,调板子}小笔记</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="杰哥的{运维,编程,调板子}小笔记" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://jia.je/" />
    
<link href="/feed.xml" rel="alternate" type="application/rss+xml" title="杰哥的{运维,编程,调板子}小笔记" />
    <link rel="shortcut icon" href="/favicon.ico">

    <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/style.css">
    
    <script src="/js/wavedrom/default.js" type="text/javascript"></script>
    <script src="/js/wavedrom/wavedrom.min.js" type="text/javascript" /></script>

    <meta name="generator" content="Hugo 0.113.0">
</head>

<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="/">杰哥的{运维,编程,调板子}小笔记</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">关于</a>
                
                <a class="main-nav-link" href="/category/">分类</a>
                
                <a class="main-nav-link" href="/open-source-contributions/">开源</a>
                
                <a class="main-nav-link" href="/tags/">标签</a>
                
                <a class="main-nav-link" href="/kb/">知识库</a>
                
                <a class="main-nav-link" href="/series/">系列</a>
                
                <a class="main-nav-link" href="/feed.xml">订阅</a>
                
                <a class="main-nav-link" href="/projects/readme/">项目</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/06/15/libvirtd-migrate-proxmox-ve/">从 libvirtd 迁移到 Proxmox VE</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/06/15/libvirtd-migrate-proxmox-ve/" class="article-date">
                        <time datetime='2023-06-15T16:03:00.000&#43;08:00' itemprop="datePublished">2023-06-15</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/06/15/libvirtd-migrate-proxmox-ve/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 之前用 libvirtd + virt-manager 做 Linux 上的虚拟化，好处是比较轻量级，但是远程控制起来比较麻烦，要么通过 RDP 访问 virt-manager 的 UI，要么就用 cockpit 在网页里去配置虚拟机。此时就会比较怀念 VMware ESXi 的网页，但是 ESXi 装完以后，宿主机就很不自由了，很多东西没法自定义。最后就想到在 Debian 上装一个 Proxmox VE，希望得到一个比较好的中间态。
Proxmox VE 安装 按照官方的 Install Proxmox VE on Debian 11 Bullseye 去安装即可。我的环境是 Debian Bookworm，把路径改成 Bookworm 的 pvetest 即可。安装的时候可能会遇到一些小问题，例如用 ifupdown2 替换 ifupdown 的时候会检查 config 是否正确等等。安装完以后重启，就可以用 root 用户访问 Proxmox VE 了。
迁移 libvirtd 虚拟机 下一步是迁移 libvirtd 虚拟机。在网上搜索，会看到提供的方法是，在 Proxmox VE 里创建一个同样大小的镜像，然后把原来的 qcow2 的数据复制一份，但是这样复制的时候得存两份数据，而且对稀疏 qcow2 的支持也不太好。
最后实际的解决办法是：在 Proxmox VE 里创建一个和 qcow2 大小一样的镜像，设置为 qcow2 格式，然后去 /var/lib/vz/images 路径下找到新建的 qcow2，直接用原来 libvirtd 创建的 qcow2 覆盖过去。目前来看，还没有遇到问题，毕竟 ProxmoxVE 用的也是 QEMU，和 libvirtd 一样。
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/06/15/libvirtd-migrate-proxmox-ve/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/libvirtd">libvirtd
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/qemu">qemu
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/proxmoxve">proxmoxve
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/pve">pve
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/hardware/2023/06/12/try-loongarch/">LoongArch 初尝试</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/hardware/2023/06/12/try-loongarch/" class="article-date">
                        <time datetime='2023-06-12T22:51:00.000&#43;08:00' itemprop="datePublished">2023-06-12</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/hardware/2023/06/12/try-loongarch/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近应龙芯要求把监控程序移植到了 LoongArch 32 Reduced 架构上，趁此机会体验了一下 LoongArch 相关的软件和系统。
在 QEMU 中运行 LoongArch Arch Linux 主页：https://github.com/loongarchlinux
环境：Debian Bookworm
QEMU 启动流程，参考官方文档：
wget https://mirrors.wsyu.edu.cn/loongarch/archlinux/images/archlinux-xfce4-2023.05.10-loong64.qcow2.zst zstd -d archlinux-xfce4-2023.05.10-loong64.qcow2.zst wget https://mirrors.wsyu.edu.cn/loongarch/archlinux/images/QEMU_EFI_7.2.fd 然后就可以启动 QEMU 7.2.2 了：
qemu-system-loongarch64 \ -m 4G \ -cpu la464-loongarch-cpu \ -machine virt \ -smp 4 \ -bios ./QEMU_EFI_7.2.fd \ -serial stdio \ -device virtio-gpu-pci \ -net nic -net user \ -device nec-usb-xhci,id=xhci,addr=0x1b \ -device usb-tablet,id=tablet,bus=xhci.0,port=1 \ -device usb-kbd,id=keyboard,bus=xhci.0,port=2 \ -hda archlinux-xfce4-2023.05.10-loong64.qcow2 启动后，可以正常看到 Xfce4 的界面，用 loongarch:loongarch 登录：
                    </p>
                    <p class="article-more-link">
                        <a href="/hardware/2023/06/12/try-loongarch/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/loongarch">loongarch
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/la64">la64
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/la32">la32
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/la32r">la32r
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/qemu">qemu
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/05/23/tar-format/">Tar 文件格式</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/05/23/tar-format/" class="article-date">
                        <time datetime='2023-05-23T21:24:00.000&#43;08:00' itemprop="datePublished">2023-05-23</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/05/23/tar-format/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    本文的内容已经整合到知识库中。
背景 最近在解压 tar.gz 文件的时候，发现如果用 unar 解压，就会出现文件名截断到 100 个字节的问题，而如果用 gnu tar 解压，文件名就是正常的，因此深入研究了一下 Tar 的文件格式。实际上，这是因为早期 tar 格式设计的时候，就设定了路径最长 100 字节的限制，后来的扩展解决了这个问题，但是 unar 没能正确地识别扩展，导致解压路径出错。
Tar 文件格式 Tar 的文件格式比较简单，就是一系列的 File Entry，最后是两个 512 字节的全 0，表示结束。每个 File Entry 由头部和数据组成，头部的格式是：
/* tar Header Block, from POSIX 1003.1-1990. */ /* POSIX header. */ struct posix_header { /* byte offset */ char name[100]; /* 0 */ char mode[8]; /* 100 */ char uid[8]; /* 108 */ char gid[8]; /* 116 */ char size[12]; /* 124 */ char mtime[12]; /* 136 */ char chksum[8]; /* 148 */ char typeflag; /* 156 */ char linkname[100]; /* 157 */ char magic[6]; /* 257 */ char version[2]; /* 263 */ char uname[32]; /* 265 */ char gname[32]; /* 297 */ char devmajor[8]; /* 329 */ char devminor[8]; /* 337 */ char prefix[155]; /* 345 */ /* 500 */ }; 来源：Basic Tar Format
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/05/23/tar-format/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/tar">tar
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/05/13/openldap-in-docker/">使用 Docker 部署 OpenLDAP</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/05/13/openldap-in-docker/" class="article-date">
                        <time datetime='2023-05-13T15:57:00.000&#43;08:00' itemprop="datePublished">2023-05-13</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/05/13/openldap-in-docker/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    Docker-Compose OpenLDAP 可以用现成的 Docker 镜像：bitnami/openldap，配合 Docker-Compose 进行部署：
version: &#39;2&#39; services: openldap: image: bitnami/openldap:2.6 ports: - &#39;1389:1389&#39; # LDAP environment: - LDAP_ROOT=dc=example,dc=com # example.com env_file: .env # admin password volumes: - &#39;./data:/bitnami/openldap&#39; # data storage admin 密码建议单独保存，例如写在 .env 中：
LDAP_ADMIN_PASSWORD=12345678REDACTED 启动服务：
# prepare data folder sudo rm -rf data sudo mkdir data sudo chown 1001:root data # launch docker compose sudo docker-compose up -d 然后就可以通过 ldapsearch 列出所有对象，默认情况下不需要登录（Bind DN），可以只读访问：
# search elements under dc=example,dc=com # -x: Simple authentication without user and password # -b dc=example,dc=com: base dn for search # -H: ldap server $ ldapsearch -x -b dc=example,dc=com -H ldap://localhost:1389/ # user01, users, example.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/05/13/openldap-in-docker/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/ldap">ldap
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/openldap">openldap
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/docker">docker
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/hardware/2023/05/08/jlink-spi-nor-flash/">使用 JLink 操作 SPI NOR Flash</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/hardware/2023/05/08/jlink-spi-nor-flash/" class="article-date">
                        <time datetime='2023-05-08T23:18:00.000&#43;08:00' itemprop="datePublished">2023-05-08</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/hardware/2023/05/08/jlink-spi-nor-flash/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近设计了一款 PMOD SPI NOR Flash 扩展板，搭载了 W25Q128 SPI NOR Flash 芯片。在 jlc 生产回来以后，通过 JLink 连接到电脑上进行测试。
连接到 JLink JLink 提供了 20 pin 的引脚，如果要连接 SPI，那么引脚定义如下：
图源 JFlash SPI 文档。
连接的时候，至少需要连接以下的引脚：
JLink GND(pin 4/6/8/10) - SPI NOR Flash GND JLink VTref(pin 1) - 3.3V - SPI NOR Flash VCC JLink CLK(pin 9) - SPI NOR Flash CLK JLink DI(pin 5) - SPI NOR Flash D0/DI/MOSI JLink DO(pin 13) - SPI NOR Flash D1/DO/MISO JLink nCS(pin 7) - SPI NOR Flash CS# 由于 SPI NOR Flash 无法接受 5V 的电压，所以要用额外的 3.
                    </p>
                    <p class="article-more-link">
                        <a href="/hardware/2023/05/08/jlink-spi-nor-flash/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/spi">spi
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/nor">nor
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/flash">flash
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/jlink">jlink
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/jflash">jflash
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/05/06/linux-regression-vivado-en/">How a Linux 6.2.13 BUG stops Vivado from recognizing FPGA</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/05/06/linux-regression-vivado-en/" class="article-date">
                        <time datetime='2023-05-06T22:16:00.000&#43;08:00' itemprop="datePublished">2023-05-06</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/05/06/linux-regression-vivado-en/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    中文版本
TLDR In short, the commit introduced by Linux 6.2.13:
commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt; Date: Fri Apr 14 14:59:19 2023 -0400 mm/mmap: regression fix for unmapped_area{_topdown} commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream. The maple tree limits the gap returned to a window that specifically fits what was asked. This may not be optimal in the case of switching search directions or a gap that does not satisfy the requested space for other reasons.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/05/06/linux-regression-vivado-en/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linux">linux
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/vivado">vivado
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/05/06/linux-regression-vivado/">Linux 6.2.13 引入的 BUG 导致 Vivado 无法识别 FPGA</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/05/06/linux-regression-vivado/" class="article-date">
                        <time datetime='2023-05-06T22:16:00.000&#43;08:00' itemprop="datePublished">2023-05-06</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/05/06/linux-regression-vivado/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    English version
TLDR 简单来说，Linux 6.2.13 引入的 commit：
commit 0d30989fe9a176565d360376d4bc2ea1c61cbbac Author: Liam R. Howlett &lt;Liam.Howlett@oracle.com&gt; Date: Fri Apr 14 14:59:19 2023 -0400 mm/mmap: regression fix for unmapped_area{_topdown} commit 58c5d0d6d522112577c7eeb71d382ea642ed7be4 upstream. The maple tree limits the gap returned to a window that specifically fits what was asked. This may not be optimal in the case of switching search directions or a gap that does not satisfy the requested space for other reasons. Fix the search by retrying the operation and limiting the search window in the rare occasion that a conflict occurs.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/05/06/linux-regression-vivado/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linux">linux
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/vivado">vivado
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2023/05/06/linker/">链接器的工作原理</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2023/05/06/linker/" class="article-date">
                        <time datetime='2023-05-06T12:09:00.000&#43;08:00' itemprop="datePublished">2023-05-06</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2023/05/06/linker/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近和同学讨论一些比较复杂的链接问题，遇到一些比较复杂的情况，因此复习一遍链接器的工作原理。
编译 编译器会把源文件编译成 obj，obj 里面有符号表，定义了不同的符号类型。常见的代码与符号的对应关系：
// global in .bss section if -fno-common // common symbol if -fcommon int uninitialized; // global in .bss section int initialized = 0; // global in .data section int initialized_one = 1; // global in .rodata section const int const_initialized = 0; // global in .rodata section const int const_initialized_one = 1; // global undefined symbol extern int external; // local in .bss section static int static_uninitialized; // local in .
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2023/05/06/linker/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linker">linker
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/ld">ld
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/hardware/2023/05/03/i2c/">I2C 协议</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/hardware/2023/05/03/i2c/" class="article-date">
                        <time datetime='2023-05-03T22:53:00.000&#43;08:00' itemprop="datePublished">2023-05-03</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/hardware/2023/05/03/i2c/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    本文的内容已经整合到知识库中。
背景 最近数设课上，同学们开始购买外设，其中就涉及到 I2C 协议，因此顺带写一下 I2C 协议的教程，帮助同学们进行理解。
接口 I2C 协议涉及到两个信号：
SCL: 时钟信号，Master -&gt; Slave SDA：数据信号，Master &lt;-&gt; Slave 由于只有一个数据信号，所以 SDA 由 Master 和 Slave 轮流输出。一次请求的开始条件是，SDA 从 1 变成 0，之后 SCL 从 1 变成 0。开始请求以后，每次 SCL 上升沿采样一位的数据。请求结束时，SCL 从 0 变成 1，然后 SDA 从 0 变成 1。一次请求的波形如下：
idle 阶段，scl 和 sda 都是 1 start 阶段，首先是 sda 变成 0，之后是 scl 变成 0 data/ack 阶段，在 scl 上升沿采样数据，在 scl 下降沿（准确来说，负半周期）修改数据 stop 阶段，首先是 scl 变成 1，之后是 sda 变成 1 传输数据的时候，需要保证 sda 在 scl 正半周期的时候保持不变。如果变了，那就是 start 或者 stop。因此，在 data/ack 阶段，建议 sda 的变化相比 scl 下降沿有一个延迟（Hold Time，一般的要求是 Min 0us）。实现方法可能是在分频的时候，延迟一个周期。
                    </p>
                    <p class="article-more-link">
                        <a href="/hardware/2023/05/03/i2c/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/i2c">i2c
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/hardware/2023/04/26/spi/">SPI 协议</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/hardware/2023/04/26/spi/" class="article-date">
                        <time datetime='2023-04-26T00:28:00.000&#43;08:00' itemprop="datePublished">2023-04-26</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/hardware/2023/04/26/spi/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    本文的内容已经整合到知识库中。
背景 最近数设课上，同学们开始购买外设，其中就涉及到 SPI 协议，因此顺带写一下 SPI 协议的教程，帮助同学们进行理解。
接口 SPI 协议涉及到四个信号：
SCLK: 时钟信号，Master -&gt; Slave MOSI：数据信号，Master -&gt; Slave MISO：数据信号，Slave -&gt; Master CS：芯片使能，一般是低有效 要通过 SPI 协议发送命令的时候，通常需要先拉低 CS，然后启动 SCLK 时钟，同时收发数据。注意 SPI 是全双工的，也就是发送的同时也在接收，只不过通常来说，外设等到主机发送了命令本身，才知道要回复什么，所以很多时候命令设计成了事实上的半双工：前半部分主机在发命令，外设发送无用的数据；后半部分外设在发送响应，主机发送无用的数据。
波形 SPI 有不同的类型，下面讲一种比较常见的配置（即 CPOL=0，CPHA=0），在这种模式下，Master 和 Slave 都是在时钟的下降沿修改输出的数据，然后在时钟（sclk）的上升沿对接收到的数据进行采样：
波形图中，时钟（sclk）上升沿时，数据处于稳定的状态，所以此时 Master 对 MISO 采样，Slave 对 MOSI 采样，可以得到稳定的数据；时钟下降沿时，Master 和 Slave 修改输出的数据。
实际在 RTL 中实现的时候，Master 可以不写 negedge 逻辑，而是写一个分频器，在分频出来的负半周期里，实现数据的修改，如上图中的 clk 分频到 sclk。一般使用一个状态机来实现 SPI Master，记录当前传输到哪一个 bit，以及记录当前是 sclk 的正半周期还是负半周期。
SPI 本身很简单，所以核心不在 SPI，而是在 SPI 之上定义的各种协议。
SPI Flash SPI Flash 是一种很常见的 SPI 外设，可以用来访问 NAND/NOR Flash。
                    </p>
                    <p class="article-more-link">
                        <a href="/hardware/2023/04/26/spi/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/spi">spi
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        

        

<nav id="page-nav">
    
    
    
    <span class="page-number current">1</span>
    
    
    
    <a href="/page/2/">2</a>
    
    
    
    <a href="/page/3/">3</a>
    
    
    
    <a href="/page/4/">4</a>
    
    
    
    <a href="/page/5/">5</a>
    
    
    
    <a href="/page/6/">6</a>
    
    
    
    <a href="/page/7/">7</a>
    
    
    
    <a href="/page/8/">8</a>
    
    
    
    <a href="/page/9/">9</a>
    
    
    
    <a href="/page/10/">10</a>
    
    
    
    <a href="/page/11/">11</a>
    
    
    
    <a href="/page/12/">12</a>
    
    
    
    <a href="/page/13/">13</a>
    
    
    
    <a href="/page/14/">14</a>
    
    
    
    <a href="/page/15/">15</a>
    
    
    
    <a href="/page/16/">16</a>
    
    
    
    <a href="/page/17/">17</a>
    
    
    
    <a href="/page/18/">18</a>
    
    
    
    <a href="/page/19/">19</a>
    
    
    
    <a href="/page/20/">20</a>
    
    
    
    <a href="/page/21/">21</a>
    
    
    
    <a href="/page/22/">22</a>
    
    
    
    <a href="/page/23/">23</a>
    
    
    
    <a href="/page/24/">24</a>
    
    
    
    <a href="/page/25/">25</a>
    
    
    
    <a href="/page/26/">26</a>
    
    
    
    <a href="/page/27/">27</a>
    
    
    
    <a href="/page/28/">28</a>
    
    
    
    <a href="/page/29/">29</a>
    
    
    
    <a href="/page/30/">30</a>
    
    
    
    <a href="/page/31/">31</a>
    
    
    
    <a href="/page/32/">32</a>
    
    
    
    <a href="/page/33/">33</a>
    
    
    
    <a href="/page/34/">34</a>
    
    
    
    <a href="/page/35/">35</a>
    
    
    
    <a href="/page/36/">36</a>
    
    

    
    <a href="/page/2/" rel="next" class="extend next">Next &raquo;</a>
    
</nav>


    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2023 杰哥的{运维,编程,调板子}小笔记
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-3109FRSVTT', { 'anonymize_ip': false });
}
</script>


    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.css" integrity="sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.js" integrity="sha384-ljao5I1l+8KYFXG7LNEA7DyaFvuvSCmedUf6Y6JI7LJqiu8q5dEivP2nDdFH31V4" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>