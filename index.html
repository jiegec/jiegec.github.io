<!DOCTYPE html>
<html>
<head>
    <title>杰哥的{运维,编程,调板子}小笔记</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="杰哥的{运维,编程,调板子}小笔记" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://jia.je/" />
    
<link href="/feed.xml" rel="alternate" type="application/rss+xml" title="杰哥的{运维,编程,调板子}小笔记" />
    <link rel="shortcut icon" href="/favicon.ico">

    <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/style.css">
    
    <script src="/js/wavedrom/default.js" type="text/javascript"></script>
    <script src="/js/wavedrom/wavedrom.min.js" type="text/javascript" /></script>

    <meta name="generator" content="Hugo 0.101.0" />
</head>

<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="/">杰哥的{运维,编程,调板子}小笔记</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">关于</a>
                
                <a class="main-nav-link" href="/category/">分类</a>
                
                <a class="main-nav-link" href="/open-source-contributions/">开源</a>
                
                <a class="main-nav-link" href="/tags/">标签</a>
                
                <a class="main-nav-link" href="/series/">系列</a>
                
                <a class="main-nav-link" href="/feed.xml">订阅</a>
                
                <a class="main-nav-link" href="/projects/readme/">项目</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/08/02/rust-nix/">用 Nix 编译 Rust 项目</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/08/02/rust-nix/" class="article-date">
                        <time datetime='2022-08-02T14:28:00.000&#43;08:00' itemprop="datePublished">2022-08-02</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/08/02/rust-nix/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 Rust 项目一般是用 Cargo 管理，但是它的缺点是每个项目都要重新编译一次所有依赖，硬盘空间占用较大，不能跨项目共享编译缓存。调研了一下，有若干基于 Nix 的 Rust 构建工具：
cargo2nix: https://github.com/cargo2nix/cargo2nix carnix: 不再更新 crane: https://github.com/ipetkov/crane crate2nix: https://github.com/kolloch/crate2nix naersk: https://github.com/nix-community/naersk nocargo: https://github.com/oxalica/nocargo 下面我分别来尝试一下这几个工具的使用。
下面出现的一些命令参考了对应项目的文档。
cargo2nix 卖点 cargo2nix 的 README 提到了它的卖点：
Development Shell - knowing all the dependencies means easy creation of complete shells. Run nix develop or direnv allow in this repo and see! Caching - CI &amp; CD pipelines move faster when purity guarantees allow skipping more work! Reproducibility - Pure builds.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/08/02/rust-nix/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/nix">nix
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rust">rust
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/07/26/invalid-date-timezone/">invalid date 报错与时区的关系</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/07/26/invalid-date-timezone/" class="article-date">
                        <time datetime='2022-07-26T21:51:00.000&#43;08:00' itemprop="datePublished">2022-07-26</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/07/26/invalid-date-timezone/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在验题的时候，@HarryChen 发现了一个现象：
$ date -d &#34;1919-04-13&#34; date: invalid date ‘1919-04-13’ $ TZ=UTC date -d &#34;1919-04-13&#34; Sun Apr 13 00:00:00 UTC 1919 也就是说，这个现象与时区有关，那么为啥 1919-04-13 是一个不合法的日期呢？
时区 实际上，对于某一个时区来说，有的时间是不存在的，最常见的就是夏令时。在 Timezone DB 里可以看到，恰好在 1919 年 4 月 13 日发生了一次 UTC+8 到 UTC+9 的变化，因此零点变成了一点，就变成了不合法的日期。
这个数据，实际上保存在 tzdata 中，可以用 zdump 工具查看：
$ tzdata -v Asia/Shanghai Asia/Shanghai Fri Dec 13 20:45:52 1901 UTC = Sat Dec 14 04:45:52 1901 CST isdst=0 Asia/Shanghai Sat Dec 14 20:45:52 1901 UTC = Sun Dec 15 04:45:52 1901 CST isdst=0 Asia/Shanghai Sat Apr 12 15:59:59 1919 UTC = Sat Apr 12 23:59:59 1919 CST isdst=0 Asia/Shanghai Sat Apr 12 16:00:00 1919 UTC = Sun Apr 13 01:00:00 1919 CDT isdst=1 Asia/Shanghai Tue Sep 30 14:59:59 1919 UTC = Tue Sep 30 23:59:59 1919 CDT isdst=1 Asia/Shanghai Tue Sep 30 15:00:00 1919 UTC = Tue Sep 30 23:00:00 1919 CST isdst=0 Asia/Shanghai Fri May 31 15:59:59 1940 UTC = Fri May 31 23:59:59 1940 CST isdst=0 Asia/Shanghai Fri May 31 16:00:00 1940 UTC = Sat Jun 1 01:00:00 1940 CDT isdst=1 Asia/Shanghai Sat Oct 12 14:59:59 1940 UTC = Sat Oct 12 23:59:59 1940 CDT isdst=1 Asia/Shanghai Sat Oct 12 15:00:00 1940 UTC = Sat Oct 12 23:00:00 1940 CST isdst=0 Asia/Shanghai Fri Mar 14 15:59:59 1941 UTC = Fri Mar 14 23:59:59 1941 CST isdst=0 Asia/Shanghai Fri Mar 14 16:00:00 1941 UTC = Sat Mar 15 01:00:00 1941 CDT isdst=1 Asia/Shanghai Sat Nov 1 14:59:59 1941 UTC = Sat Nov 1 23:59:59 1941 CDT isdst=1 Asia/Shanghai Sat Nov 1 15:00:00 1941 UTC = Sat Nov 1 23:00:00 1941 CST isdst=0 Asia/Shanghai Fri Jan 30 15:59:59 1942 UTC = Fri Jan 30 23:59:59 1942 CST isdst=0 Asia/Shanghai Fri Jan 30 16:00:00 1942 UTC = Sat Jan 31 01:00:00 1942 CDT isdst=1 Asia/Shanghai Sat Sep 1 14:59:59 1945 UTC = Sat Sep 1 23:59:59 1945 CDT isdst=1 Asia/Shanghai Sat Sep 1 15:00:00 1945 UTC = Sat Sep 1 23:00:00 1945 CST isdst=0 Asia/Shanghai Tue May 14 15:59:59 1946 UTC = Tue May 14 23:59:59 1946 CST isdst=0 Asia/Shanghai Tue May 14 16:00:00 1946 UTC = Wed May 15 01:00:00 1946 CDT isdst=1 Asia/Shanghai Mon Sep 30 14:59:59 1946 UTC = Mon Sep 30 23:59:59 1946 CDT isdst=1 Asia/Shanghai Mon Sep 30 15:00:00 1946 UTC = Mon Sep 30 23:00:00 1946 CST isdst=0 Asia/Shanghai Mon Apr 14 15:59:59 1947 UTC = Mon Apr 14 23:59:59 1947 CST isdst=0 Asia/Shanghai Mon Apr 14 16:00:00 1947 UTC = Tue Apr 15 01:00:00 1947 CDT isdst=1 Asia/Shanghai Fri Oct 31 14:59:59 1947 UTC = Fri Oct 31 23:59:59 1947 CDT isdst=1 Asia/Shanghai Fri Oct 31 15:00:00 1947 UTC = Fri Oct 31 23:00:00 1947 CST isdst=0 Asia/Shanghai Fri Apr 30 15:59:59 1948 UTC = Fri Apr 30 23:59:59 1948 CST isdst=0 Asia/Shanghai Fri Apr 30 16:00:00 1948 UTC = Sat May 1 01:00:00 1948 CDT isdst=1 Asia/Shanghai Thu Sep 30 14:59:59 1948 UTC = Thu Sep 30 23:59:59 1948 CDT isdst=1 Asia/Shanghai Thu Sep 30 15:00:00 1948 UTC = Thu Sep 30 23:00:00 1948 CST isdst=0 Asia/Shanghai Sat Apr 30 15:59:59 1949 UTC = Sat Apr 30 23:59:59 1949 CST isdst=0 Asia/Shanghai Sat Apr 30 16:00:00 1949 UTC = Sun May 1 01:00:00 1949 CDT isdst=1 Asia/Shanghai Fri May 27 14:59:59 1949 UTC = Fri May 27 23:59:59 1949 CDT isdst=1 Asia/Shanghai Fri May 27 15:00:00 1949 UTC = Fri May 27 23:00:00 1949 CST isdst=0 Asia/Shanghai Sat May 3 17:59:59 1986 UTC = Sun May 4 01:59:59 1986 CST isdst=0 Asia/Shanghai Sat May 3 18:00:00 1986 UTC = Sun May 4 03:00:00 1986 CDT isdst=1 Asia/Shanghai Sat Sep 13 16:59:59 1986 UTC = Sun Sep 14 01:59:59 1986 CDT isdst=1 Asia/Shanghai Sat Sep 13 17:00:00 1986 UTC = Sun Sep 14 01:00:00 1986 CST isdst=0 Asia/Shanghai Sat Apr 11 17:59:59 1987 UTC = Sun Apr 12 01:59:59 1987 CST isdst=0 Asia/Shanghai Sat Apr 11 18:00:00 1987 UTC = Sun Apr 12 03:00:00 1987 CDT isdst=1 Asia/Shanghai Sat Sep 12 16:59:59 1987 UTC = Sun Sep 13 01:59:59 1987 CDT isdst=1 Asia/Shanghai Sat Sep 12 17:00:00 1987 UTC = Sun Sep 13 01:00:00 1987 CST isdst=0 Asia/Shanghai Sat Apr 16 17:59:59 1988 UTC = Sun Apr 17 01:59:59 1988 CST isdst=0 Asia/Shanghai Sat Apr 16 18:00:00 1988 UTC = Sun Apr 17 03:00:00 1988 CDT isdst=1 Asia/Shanghai Sat Sep 10 16:59:59 1988 UTC = Sun Sep 11 01:59:59 1988 CDT isdst=1 Asia/Shanghai Sat Sep 10 17:00:00 1988 UTC = Sun Sep 11 01:00:00 1988 CST isdst=0 Asia/Shanghai Sat Apr 15 17:59:59 1989 UTC = Sun Apr 16 01:59:59 1989 CST isdst=0 Asia/Shanghai Sat Apr 15 18:00:00 1989 UTC = Sun Apr 16 03:00:00 1989 CDT isdst=1 Asia/Shanghai Sat Sep 16 16:59:59 1989 UTC = Sun Sep 17 01:59:59 1989 CDT isdst=1 Asia/Shanghai Sat Sep 16 17:00:00 1989 UTC = Sun Sep 17 01:00:00 1989 CST isdst=0 Asia/Shanghai Sat Apr 14 17:59:59 1990 UTC = Sun Apr 15 01:59:59 1990 CST isdst=0 Asia/Shanghai Sat Apr 14 18:00:00 1990 UTC = Sun Apr 15 03:00:00 1990 CDT isdst=1 Asia/Shanghai Sat Sep 15 16:59:59 1990 UTC = Sun Sep 16 01:59:59 1990 CDT isdst=1 Asia/Shanghai Sat Sep 15 17:00:00 1990 UTC = Sun Sep 16 01:00:00 1990 CST isdst=0 Asia/Shanghai Sat Apr 13 17:59:59 1991 UTC = Sun Apr 14 01:59:59 1991 CST isdst=0 Asia/Shanghai Sat Apr 13 18:00:00 1991 UTC = Sun Apr 14 03:00:00 1991 CDT isdst=1 Asia/Shanghai Sat Sep 14 16:59:59 1991 UTC = Sun Sep 15 01:59:59 1991 CDT isdst=1 Asia/Shanghai Sat Sep 14 17:00:00 1991 UTC = Sun Sep 15 01:00:00 1991 CST isdst=0 Asia/Shanghai Mon Jan 18 03:14:07 2038 UTC = Mon Jan 18 11:14:07 2038 CST isdst=0 Asia/Shanghai Tue Jan 19 03:14:07 2038 UTC = Tue Jan 19 11:14:07 2038 CST isdst=0 可以看到，它列出来了历史上 Asia/Shanghai 时区的变化历史。具体的历史，可以查看 中国时区。
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/07/26/invalid-date-timezone/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linux">linux
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/timezone">timezone
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/date">date
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/tzdata">tzdata
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/devops/2022/07/16/ceph-cookbook/">Ceph Cookbook</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/devops/2022/07/16/ceph-cookbook/" class="article-date">
                        <time datetime='2022-07-16T19:32:00.000&#43;08:00' itemprop="datePublished">2022-07-16</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/devops/2022/07/16/ceph-cookbook/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    概念 OSD：负责操作硬盘的程序，一个硬盘一个 OSD MON：管理集群状态，比较重要，可以在多个节点上各跑一个 MGR：监测集群状态 RGW(optional)：提供对象存储 API MDS(optional)：提供 CephFS 使用 Ceph 做存储的方式：
librados: 库 radosgw: 对象存储 HTTP API rbd: 块存储 cephfs: 文件系统 认证 Ceph 客户端认证需要用户名+密钥。默认情况下，用户名是 client.admin，密钥路径是 /etc/ceph/ceph.用户名.keyring。ceph --user abc 表示以用户 client.abc 的身份访问集群。
用户的权限是按照服务类型决定的。可以用 ceph auth ls 显示所有的用户以及权限：
$ ceph auth ls osd.0 key: REDACTED caps: [mgr] allow profile osd caps: [mon] allow profile osd caps: [osd] allow * client.admin key: REDACTED caps: [mds] allow * caps: [mgr] allow * caps: [mon] allow * caps: [osd] allow * 可以看到，osd.
                    </p>
                    <p class="article-more-link">
                        <a href="/devops/2022/07/16/ceph-cookbook/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/ceph">ceph
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/07/11/archive-common-linking/">Archive 中 COMMON 符号的链接问题</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/07/11/archive-common-linking/" class="article-date">
                        <time datetime='2022-07-11T22:53:00.000&#43;08:00' itemprop="datePublished">2022-07-11</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/07/11/archive-common-linking/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近看到一个 issue: irssi 1.4.1 fails to build on darwin arm64，它的现象是，链接的时候会报错：
Undefined symbols for architecture arm64: &#34;_current_theme&#34;, referenced from: _format_get_text_theme in libfe_common_core.a(formats.c.o) _format_get_text in libfe_common_core.a(formats.c.o) _strip_codes in libfe_common_core.a(formats.c.o) _format_send_as_gui_flags in libfe_common_core.a(formats.c.o) _window_print_daychange in libfe_common_core.a(fe-windows.c.o) _printformat_module_dest_charargs in libfe_common_core.a(printtext.c.o) _printformat_module_gui_args in libfe_common_core.a(printtext.c.o) ... &#34;_default_formats&#34;, referenced from: _format_find_tag in libfe_common_core.a(formats.c.o) _format_get_text_theme_args in libfe_common_core.a(formats.c.o) _printformat_module_dest_args in libfe_common_core.a(printtext.c.o) _printformat_module_gui_args in libfe_common_core.a(printtext.c.o) ld: symbol(s) not found for architecture arm64 代码 themes.c 定义了这两个全局变量：
THEME_REC *current_theme; GHashTable *default_formats; 并且 themes.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/07/11/archive-common-linking/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/macos">macos
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/ld">ld
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linking">linking
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/common">common
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/fortran">fortran
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/07/06/install-nvidia-cuda/">NVIDIA 驱动和 CUDA 安装速查</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/07/06/install-nvidia-cuda/" class="article-date">
                        <time datetime='2022-07-06T11:42:00.000&#43;08:00' itemprop="datePublished">2022-07-06</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/07/06/install-nvidia-cuda/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在 Ubuntu 上配置 NVIDIA 驱动和 CUDA 环境的次数比较多，在此总结一下整个流程，作为教程供大家学习。
配置 NVIDIA APT 源 Ubuntu 源有自带的 NVIDIA 驱动版本，但这里我们要使用 NVIDIA 的 APT 源。首先，我们要访问 https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_network，在网页中选择我们的系统，例如：
Operating System: Linux Architecture: x86_64 Distribution: Ubuntu Version: 20.04 Installer Type: deb (network) 此时，下面就会显示一些命令，复制下来执行：
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600 sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub sudo add-apt-repository &#34;deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /&#34; sudo apt-get update 最后一步的 sudo apt-get -y install cuda 可以不着急安装，我们在后面再来讨论 CUDA 版本的问题。
NVIDIA 驱动 配置好源以后，接下来，我们就要安装 NVIDIA 驱动了。首先，我们要选取一个 NVIDIA 版本，选择的标准如下：
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/07/06/install-nvidia-cuda/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/nvidia">nvidia
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/cuda">cuda
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/07/02/connectx-4-switch-to-ethernet/">切换 ConnectX-4 为以太网模式</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/07/02/connectx-4-switch-to-ethernet/" class="article-date">
                        <time datetime='2022-07-02T20:26:00.000&#43;08:00' itemprop="datePublished">2022-07-02</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/07/02/connectx-4-switch-to-ethernet/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在给机房配置网络，遇到一个需求，就是想要把 ConnectX-4 当成以太网卡用，它既支持 Infiniband，又支持 Ethernet，只不过默认是 Infiniband 模式，所以需要用 mlxconfig 工具来做这个切换。
切换方法 在 Using mlxconfig 文档中，写了如何切换网卡为 Infiniband 模式：
$ mlxconfig -d /dev/mst/mt4103_pci_cr0 set LINK_TYPE_P1=1 LINK_TYPE_P2=1 Device #1: ---------- Device type: ConnectX3Pro PCI device: /dev/mst/mt4103_pci_cr0 Configurations: Next Boot New LINK_TYPE_P1 ETH(2) IB(1) LINK_TYPE_P2 ETH(2) IB(1) Apply new Configuration? ? (y/n) [n] : y Applying... Done! -I- Please reboot machine to load new configurations. 那么，我们只需要反其道而行之，设置模式为 ETH(2) 即可。
MST 安装 要使用 mlxconfig，就需要安装 MFT(Mellanox Firmware Tools)。我们用的是 Debian bookworm，于是要下载 DEB：
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/07/02/connectx-4-switch-to-ethernet/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linux">linux
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/mellanox">mellanox
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/connectx4">connectx4
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/ethernet">ethernet
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/infiniband">infiniband
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/mst">mst
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/mft">mft
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/07/01/rsyslog-remote/">rsyslog 收集远程日志</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/07/01/rsyslog-remote/" class="article-date">
                        <time datetime='2022-07-01T20:14:00.000&#43;08:00' itemprop="datePublished">2022-07-01</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/07/01/rsyslog-remote/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在运维的时候发现网络设备（如交换机）有一个远程发送日志的功能，即可以通过 syslog udp 协议发送日志到指定的服务器。为此，可以在服务器上运行 rsyslog 并收集日志。
rsyslog 配置 默认的 rsyslog 配置是收集系统本地的配置，因此我们需要编写一个 rsyslog 配置，用于收集远程的日志。
首先复制 /etc/rsyslog.conf 到 /etc/rsyslog-remote.conf，然后修改：
注释掉 imuxsock 和 imklog 相关的 module 加载 去掉 imudp 和 imtcp 相关的注释，这样就会监听在相应的端口上 修改 $WorkDirectory，例如 $WorkDirectory /var/spool/rsyslog-remote，防止与已有的 rsyslog 冲突 注释 $IncludeConfig，防止引入了不必要的配置 注释所有已有的 RULES 下面的配置 添加如下配置： $template FromIp,&#34;/var/log/rsyslog-remote/%FROMHOST-IP%.log&#34; *.* ?FromIp 这样，就会按照来源的 IP 地址进行分类，然后都写入到 /var/log/rsyslog-remote/x.x.x.x.log 文件里。
systemd service 最后，写一个 systemd service 让它自动启动：
[Unit] ConditionPathExists=/etc/rsyslog-remote.conf Description=Remote Syslog Service [Service] Type=simple PIDFile=/var/run/rsyslogd-remote.pid ExecStart=/usr/sbin/rsyslogd -n -f /etc/rsyslog-remote.conf -i /var/run/rsyslogd-remote.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/07/01/rsyslog-remote/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/linux">linux
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rsyslog">rsyslog
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/remote">remote
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/logging">logging
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/hardware/2022/06/19/wishbone/">「教学」Wishbone 总线协议</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/hardware/2022/06/19/wishbone/" class="article-date">
                        <time datetime='2022-06-19T17:05:00.000&#43;08:00' itemprop="datePublished">2022-06-19</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/hardware/2022/06/19/wishbone/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在研究如何把 Wishbone 总线协议引入计算机组成原理课程，因此趁此机会学习了一下 Wishbone 的协议。
总线 总线是什么？总线通常用于连接 CPU 和外设，为了更好的兼容性和可复用性，会想到能否设计一个统一的协议，其中 CPU 实现的是发起请求的一方（又称为 master），外设实现的是接收请求的一方（又称为 slave），那么如果要添加外设、或者替换 CPU 实现，都会变得比较简单，减少了许多适配的工作量。
那么，我们来思考一下，一个总线协议需要包括哪些内容？对于 CPU 来说，程序会读写内存，读写内存就需要以下几个信号传输到内存：
地址（addr）：例如 32 位处理器就是 32 位地址，或者按照内存的大小计算地址线的宽度 数据（w_data 和 r_data）：分别是写数据和读数据，宽度通常为 32 位 或 64 位，也就是一个时钟周期可以传输的数据量 读还是写（we）：高表示写，低表示读 字节有效（be）：例如为了实现单字节写，虽然 w_data 可能是 32 位宽，但是实际写入的是其中的一个字节 除了请求的内容以外，为了表示 CPU 想要发送请求，还需要添加 valid 信号：高表示发送请求，低表示不发送请求。很多时候，外设的速度比较慢，可能无法保证每个周期都可以处理请求，因此外设可以提供一个 ready 信号：当 valid=1 &amp;&amp; ready=1 的时候，发送并处理请求；当 valid=1 &amp;&amp; ready=0 的时候，表示外设还没有准备好，此时 CPU 需要一直保持 valid=1 不变，等到外设准备好后，valid=1 &amp;&amp; ready=1 请求生效。
简单总结一下上面的需求，可以得到 master 和 slave 端分别的信号列表。这次，我们在命名的时候用 _o 表示输出、_i 表示输入，可以得到 master 端（CPU 端）的信号：
                    </p>
                    <p class="article-more-link">
                        <a href="/hardware/2022/06/19/wishbone/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/wishbone">wishbone
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/bus">bus
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/teaching">teaching
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/06/07/nix-cookbook/">Nix Cookbook</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/06/07/nix-cookbook/" class="article-date">
                        <time datetime='2022-06-07T22:29:00.000&#43;08:00' itemprop="datePublished">2022-06-07</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/06/07/nix-cookbook/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 最近在尝试 NixOS 和在 macOS 上跑 Nix，下面记录一些我在使用过程中遇到的一些小问题和解决思路。
NixOS 全局配置 NixOS 的全局配置路径：/etc/nixos/configuration.nix 和 /etc/nixos/hardware-configuration.nix
应用更新后的全局配置：
nixos-rebuild switch # or nixos-rebuild switch --upgrade 应用 Flakes 配置文件并显示变化：
#!/usr/bin/env python3 import os user = os.getenv(&#34;USER&#34;) home = f&#34;/nix/var/nix/profiles/&#34; old = home + os.readlink(f&#34;{home}system&#34;) os.system(&#34;sudo nixos-rebuild switch --flake .&#34;) new = home + os.readlink(f&#34;{home}system&#34;) os.system(f&#34;nix store diff-closures {old} {new}&#34;) 更新大版本 如果要更新 NixOS 21.11 到 22.05:
nix-channel --list nix-channel --add https://nixos.org/channels/nixos-22.05 nixos nixos-rebuild switch --upgrade 可以考虑改或者不改 /etc/nixos/configuration.
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/06/07/nix-cookbook/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/nix">nix
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/nixos">nixos
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/cookbook">cookbook
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        
        <article class="article article-type-post" itemscope itemprop="blogPost">
            <div class="article-inner">
                
                
                <header class="article-header">
                    <h1 itemprop="name"><a class="article-title" href="/software/2022/05/31/qemu-rv64-in-libvirt/">在 libvirt 中运行 RISC-V 虚拟机</a></h1>
                </header>
                
                <div class="article-meta">
                    <a href="/software/2022/05/31/qemu-rv64-in-libvirt/" class="article-date">
                        <time datetime='2022-05-31T09:22:00.000&#43;08:00' itemprop="datePublished">2022-05-31</time>
                    </a>
                    
                    
                    
                    <div class="article-comment-link-wrap">
                        <a href="/software/2022/05/31/qemu-rv64-in-libvirt/#disqus_thread" class="article-comment-link">Comments</a>
                    </div>
                    
                </div>
                <div class="article-entry" itemprop="articleBody">
                    <p>
                        
                    背景 我在 libvirt 中跑了几个 KVM 加速的虚拟机，然后突发奇想，既然 libvirt 背后是 qemu，然后 qemu 是支持跨指令集的，那是否可以让 libvirt 来运行 RISC-V 架构的虚拟机？经过一番搜索，发现可以跑 ARM：How To: Running Fedora-ARM under QEMU，既然如此，我们也可以试试用 libvirt 来运行 RV64 虚拟机。
准备 rootfs 第一步是根据 Debian 的文档 Creating a riscv64 chroot 来创建 rootfs，然后再用 virt-make-fs 来打包。
首先是用 mmdebstrap 来生成一个 chroot：
$ sudo mkdir -p /tmp/riscv64-chroot $ sudo apt install mmdebstrap qemu-user-static binfmt-support debian-ports-archive-keyring $ sudo mmdebstrap --architectures=riscv64 --include=&#34;debian-ports-archive-keyring&#34; sid /tmp/riscv64-chroot &#34;deb http://deb.debian.org/debian-ports sid main&#34; &#34;deb http://deb.debian.org/debian-ports unreleased main&#34; 进入 chroot 以后，进行一些配置：
                    </p>
                    <p class="article-more-link">
                        <a href="/software/2022/05/31/qemu-rv64-in-libvirt/">Read More</a>
                    </p>
                </div>

                
                <footer class="article-footer">
                    <ul class="article-tag-list">
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/qemu">qemu
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/libvirt">libvirt
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/virtmanager">virtmanager
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/debian">debian
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/riscv">riscv
                            </a>
                        </li>
                        
                        <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rv64">rv64
                            </a>
                        </li>
                        
                    </ul>
                </footer>
                
            </div>
        </article>
        

        

<nav id="page-nav">
    
    
    
    <span class="page-number current">1</span>
    
    
    
    <a href="/page/2/">2</a>
    
    
    
    <a href="/page/3/">3</a>
    
    
    
    <a href="/page/4/">4</a>
    
    
    
    <a href="/page/5/">5</a>
    
    
    
    <a href="/page/6/">6</a>
    
    
    
    <a href="/page/7/">7</a>
    
    
    
    <a href="/page/8/">8</a>
    
    
    
    <a href="/page/9/">9</a>
    
    
    
    <a href="/page/10/">10</a>
    
    
    
    <a href="/page/11/">11</a>
    
    
    
    <a href="/page/12/">12</a>
    
    
    
    <a href="/page/13/">13</a>
    
    
    
    <a href="/page/14/">14</a>
    
    
    
    <a href="/page/15/">15</a>
    
    
    
    <a href="/page/16/">16</a>
    
    
    
    <a href="/page/17/">17</a>
    
    
    
    <a href="/page/18/">18</a>
    
    
    
    <a href="/page/19/">19</a>
    
    
    
    <a href="/page/20/">20</a>
    
    
    
    <a href="/page/21/">21</a>
    
    
    
    <a href="/page/22/">22</a>
    
    
    
    <a href="/page/23/">23</a>
    
    
    
    <a href="/page/24/">24</a>
    
    
    
    <a href="/page/25/">25</a>
    
    
    
    <a href="/page/26/">26</a>
    
    
    
    <a href="/page/27/">27</a>
    
    
    
    <a href="/page/28/">28</a>
    
    
    
    <a href="/page/29/">29</a>
    
    
    
    <a href="/page/30/">30</a>
    
    
    
    <a href="/page/31/">31</a>
    
    
    
    <a href="/page/32/">32</a>
    
    

    
    <a href="/page/2/" rel="next" class="extend next">Next &raquo;</a>
    
</nav>


    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2022 杰哥的{运维,编程,调板子}小笔记
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-3109FRSVTT', { 'anonymize_ip': false });
}
</script>


    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.css" integrity="sha384-ZPe7yZ91iWxYumsBEOn7ieg8q/o+qh/hQpSaPow8T6BwALcXSCS6C6fSRPIAnTQs" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/katex.min.js" integrity="sha384-ljao5I1l+8KYFXG7LNEA7DyaFvuvSCmedUf6Y6JI7LJqiu8q5dEivP2nDdFH31V4" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.15.6/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>