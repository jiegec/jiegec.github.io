
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="杰哥的{运维,编程,调板子}小笔记" name="description"/>
<link href="https://jia.je/" rel="canonical"/>
<link href="about/" rel="next"/>
<link href="feed_rss_created.xml" rel="alternate" title="RSS 订阅" type="application/rss+xml"/>
<link href="feed_rss_updated.xml" rel="alternate" title="已更新内容的 RSS 订阅" type="application/rss+xml"/>
<link href="assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.2.0-b0" name="generator"/>
<title>杰哥的{运维,编程,调板子}小笔记</title>
<link href="assets/stylesheets/main.0c456da8.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-header__button md-logo" data-md-component="logo" href="." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            杰哥的{运维,编程,调板子}小笔记
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              博客
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href=".">
        
  
    
  
  博客

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="about/">
        
  
    
  
  关于

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="open-source-contributions/">
        
  
    
  
  开源

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="tags/">
        
  
    
  
  标签

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/kb/">
        
  
    
  
  知识库

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="series/">
        
  
    
  
  系列

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="projects/">
        
  
    
  
  项目

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="tools/">
        
  
    
  
  工具

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="/feed.xml">
        
  
    
  
  订阅

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="archive/2023/">
          
  
  归档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="category/crypto/">
          
  
  分类

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="杰哥的{运维,编程,调板子}小笔记" class="md-nav__button md-logo" data-md-component="logo" href="." title="杰哥的{运维,编程,调板子}小笔记">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    杰哥的{运维,编程,调板子}小笔记
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    博客
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href=".">
<span class="md-ellipsis">
    博客
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#hugo-mkdocs">
    把博客生成器从 Hugo 迁移到 Mkdocs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ecdsa">
    ECDSA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#apple-m1-gentooprefix">
    在 Apple M1 上试用 Gentoo/Prefix
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    生成树协议
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#libvirtd-proxmox-ve">
    从 libvirtd 迁移到 Proxmox VE
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#loongarch">
    LoongArch 初尝试
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tar">
    Tar 文件格式
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#docker-openldap">
    使用 Docker 部署 OpenLDAP
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#jlink-spi-nor-flash">
    使用 JLink 操作 SPI NOR Flash
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    链接器的工作原理
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="about/">
<span class="md-ellipsis">
    关于
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="open-source-contributions/">
<span class="md-ellipsis">
    开源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="tags/">
<span class="md-ellipsis">
    标签
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/kb/">
<span class="md-ellipsis">
    知识库
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="series/">
<span class="md-ellipsis">
    系列
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="projects/">
<span class="md-ellipsis">
    项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="tools/">
<span class="md-ellipsis">
    工具
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="/feed.xml">
<span class="md-ellipsis">
    订阅
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    归档
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2023/">
<span class="md-ellipsis">
    2023
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2022/">
<span class="md-ellipsis">
    2022
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2021/">
<span class="md-ellipsis">
    2021
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2020/">
<span class="md-ellipsis">
    2020
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2019/">
<span class="md-ellipsis">
    2019
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2018/">
<span class="md-ellipsis">
    2018
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2017/">
<span class="md-ellipsis">
    2017
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2016/">
<span class="md-ellipsis">
    2016
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="archive/2014/">
<span class="md-ellipsis">
    2014
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
<span class="md-ellipsis">
    分类
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_11_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_11">
<span class="md-nav__icon md-icon"></span>
            分类
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="category/crypto/">
<span class="md-ellipsis">
    crypto
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/csdn/">
<span class="md-ellipsis">
    csdn
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/ctf/">
<span class="md-ellipsis">
    ctf
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/devops/">
<span class="md-ellipsis">
    devops
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/hardware/">
<span class="md-ellipsis">
    hardware
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/life/">
<span class="md-ellipsis">
    life
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/logo/">
<span class="md-ellipsis">
    logo
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/meta/">
<span class="md-ellipsis">
    meta
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/misc/">
<span class="md-ellipsis">
    misc
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/networking/">
<span class="md-ellipsis">
    networking
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/news/">
<span class="md-ellipsis">
    news
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/os/">
<span class="md-ellipsis">
    os
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/others/">
<span class="md-ellipsis">
    others
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/programming/">
<span class="md-ellipsis">
    programming
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/software/">
<span class="md-ellipsis">
    software
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/speech/">
<span class="md-ellipsis">
    speech
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/system/">
<span class="md-ellipsis">
    system
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="category/unboxing/">
<span class="md-ellipsis">
    unboxing
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="_1">博客</h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-07-15 00:00:00">2023年7月15日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/meta/">meta</a></li>
<li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="hugo-mkdocs"><a class="toclink" href="meta/2023/07/15/migrate-from-hugo-to-mkdocs/">把博客生成器从 Hugo 迁移到 Mkdocs</a></h2>
<p>距离上一次 <a href="meta/2019/05/02/migrate-from-jekyll-to-hugo/">Jekyll 迁移到 Hugo</a> 已经过去了四年，这次正好 mkdocs-material 发了新的 beta 版本，加入了对博客的支持，所以就当小白鼠，把博客迁移到了 Mkdocs + Mkdocs-Material。</p>
<p>这次迁移比较顺利，除了 tag 和 category 少了一些页面以外，原来的文章的链接都是正常的。为什么要迁移呢，主要是最近写各种文档，Mkdocs 用的比较多，但是 Mkdocs 的 Markdown 很多地方和 Hugo 不太一样，下面列一些最难以忍受的 Hugo 的问题：</p>
<ol>
<li>数学公式：Hugo 的 <code>\</code> 需要转义，导致很多地方写数学公式都很麻烦，然后因为我经常要在 Hugo 和 Mkdocs 之间复制 Markdown，此时就需要很多手动工作。</li>
<li>资源路径：Hugo 的资源路径默认都是绝对路径，要引用其他文章的话，要么用啰嗦的 relref，要么就写绝对路径，比较头疼。Mkdocs 就很好，自动检测，帮我计算出实际的地址。</li>
</ol>
<p>迁移的时候有很多细节上的不同，不过基本靠 VSCode 的正则表达式替换解决了。</p>
<p>不过，Mkdocs 又出现了 Jekyll 的老问题，就是性能比较差。当然了，不一定是 Mkdocs 本身的问题，也可能是 Mkdocs-Material 加各种插件的问题，目前还有待观察。无论如何，Python 调起来总归是比 Ruby 要容易。希望不要在未来的某一天，由从 Mkdocs 迁移回 Hugo。</p>
<nav class="md-post__action">
<a href="meta/2023/07/15/migrate-from-hugo-to-mkdocs/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-07-14 00:00:00">2023年7月14日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/crypto/">crypto</a></li>
<li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ecdsa"><a class="toclink" href="crypto/2023/07/14/ecdsa/">ECDSA</a></h2>
<p>本文参考 <a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm">ECDSA - Wikipedia</a>。</p>
<p>ECDSA 是一个基于椭圆曲线的签名算法，使用时需要确定一个椭圆曲线，以及它的 base point <span class="arithmatex">\(G\)</span>，且 <span class="arithmatex">\(G\)</span> 的阶是素数 <span class="arithmatex">\(n\)</span>。</p>
<h3 id="key-pair"><a class="toclink" href="crypto/2023/07/14/ecdsa/#key-pair">生成 key pair</a></h3>
<p>生成 key pair 的时候，私钥是整数 <span class="arithmatex">\(d_A \in [1, n-1]\)</span>，那么公钥就是圆锥曲线上一点 <span class="arithmatex">\(Q_A = d_A \times G\)</span>，这里 <span class="arithmatex">\(\times\)</span> 表示整数与圆锥曲线上一点的乘法。</p>
<h3 id="_1"><a class="toclink" href="crypto/2023/07/14/ecdsa/#_1">签名</a></h3>
<p>签名的时候，对于给定的消息 <span class="arithmatex">\(m\)</span>，签名流程如下：</p>
<ol>
<li>计算哈希：<span class="arithmatex">\(e = \mathrm{HASH}(m)\)</span>，例如用 SHA 系列的哈希算法</li>
<li>考虑到 <span class="arithmatex">\(e\)</span> 的位数可能比 <span class="arithmatex">\(n\)</span> 的位数更多，取 <span class="arithmatex">\(e\)</span> 的高位，使得位数和 <span class="arithmatex">\(n\)</span> 一致，得到的结果记为 <span class="arithmatex">\(z\)</span></li>
<li>生成一个密码学安全的随机数 <span class="arithmatex">\(k \in [1, n-1]\)</span></li>
<li>计算 <span class="arithmatex">\(k \times G\)</span>，取它的 X 坐标为 <span class="arithmatex">\(x_1\)</span></li>
<li>计算 <span class="arithmatex">\(r = x_1 \bmod n\)</span></li>
<li>计算 <span class="arithmatex">\(s = k^{-1}(z + r d_A) \bmod n\)</span></li>
<li>如果 <span class="arithmatex">\(r\)</span> 或者 <span class="arithmatex">\(s\)</span> 等于 0，取新的 <span class="arithmatex">\(k\)</span> 再重试</li>
<li>得到的 ECDSA 签名就是 <span class="arithmatex">\((r, s)\)</span> 两个数</li>
</ol>
<h3 id="_2"><a class="toclink" href="crypto/2023/07/14/ecdsa/#_2">验证</a></h3>
<p>验证签名的时候，已知 <span class="arithmatex">\(r, s, m, Q_A\)</span>，按照下面的流程进行：</p>
<ol>
<li>前两步和计算签名的算法一致，求哈希和截断后得到 <span class="arithmatex">\(z\)</span></li>
<li>计算 <span class="arithmatex">\(u_1 = zs^{-1} \bmod n, u_2 = rs^{-1} \bmod n\)</span></li>
<li>计算 <span class="arithmatex">\(u_1 \times G + u_2 \times Q_A\)</span>，取它的 X 坐标为 <span class="arithmatex">\(x_2\)</span></li>
<li>如果 <span class="arithmatex">\(r \equiv x_2 \pmod n\)</span>，则签名合法</li>
</ol>
<p>上面的过程忽略了一些边界情况的检查，详细版本见 Wikipedia。</p>
<p>下面进行验算：</p>
<div class="arithmatex">\[\begin{align}
&amp; u_1 \times G + u_2 \times Q_A \\\
&amp;= zs^{-1} \times G + rs^{-1} \times Q_A \\\
&amp;= zs^{-1} \times G + rs^{-1}d_A \times G \\\
&amp;= (zs^{-1} + rs^{-1}d_A) \times G \\\
&amp;= (z+rd_A)s^{-1} \times G \\\
&amp;= (z+rd_A)k(z+rd_A)^{-1} \times G \\\
&amp;= k \times G
\end{align}\]</div>
<p>等式左边的 X 坐标等于等式右边的 X 坐标，等价于 <span class="arithmatex">\(r \equiv x_2 \pmod n\)</span>，验算没问题。</p>
<h3 id="_3"><a class="toclink" href="crypto/2023/07/14/ecdsa/#_3">公钥恢复</a></h3>
<p>ECDSA 支持公钥恢复算法，已知 <span class="arithmatex">\(r, s, m\)</span>，恢复 <span class="arithmatex">\(Q_A\)</span>。首先进行推导：</p>
<div class="arithmatex">\[\begin{align}
Q_A &amp;= d_A \times G \\\
s &amp;= k^{-1}(z + rd_A) \bmod n \\\
sk &amp;= z + rd_A \bmod n \\\
sk \times G &amp;= (z + rd_A) \times G \\\
rd_A \times G &amp;= (z - sk) \times G \\\
Q_A &amp;= d_A \times G = r^{-1}(z-sk) \times G \\\
Q_A &amp;= r^{-1}(z \times G - s(k \times G))
\end{align}\]</div>
<p>上式中 <span class="arithmatex">\(r, s\)</span> 已知，<span class="arithmatex">\(z\)</span> 可以从 <span class="arithmatex">\(m\)</span> 通过哈希计算得出，<span class="arithmatex">\(k \times G\)</span> 的 X 坐标 <span class="arithmatex">\(x_1\)</span> 满足 <span class="arithmatex">\(r = x_1 \bmod n\)</span>，因此恢复过程就是：</p>
<ol>
<li>在椭圆曲线上找到 X 坐标模 <span class="arithmatex">\(n\)</span> 等于 <span class="arithmatex">\(r\)</span> 的点，这个点就是 <span class="arithmatex">\(k \times G\)</span></li>
<li>按照计算哈希的前两步，从 <span class="arithmatex">\(m\)</span> 计算出 <span class="arithmatex">\(z\)</span></li>
<li>按照上述公式，计算出 <span class="arithmatex">\(Q_A\)</span></li>
</ol>
<p>但是实际上第一步没有这么简单：首先同一个 X 坐标对应椭圆曲线上的两个点，其次 <span class="arithmatex">\(r\)</span> 和 <span class="arithmatex">\(x_1\)</span> 只是同余关系，可能二者之间差了一个倍数。因此实际在 BTC 或者 ETH 里使用的时候，还额外附加了一个参数 recid，范围是 0 到 3，对应 Y 坐标是正还是负，<span class="arithmatex">\(r\)</span> 和 <span class="arithmatex">\(x_1\)</span> 之间差 0 还是 <span class="arithmatex">\(n\)</span>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// Source: https://github.com/ethereum/go-ethereum/blob/e1fe6bc8469c626afaa86b1dfb819737e980a574/crypto/secp256k1/libsecp256k1/src/modules/recovery/main_impl.h#L104-L112</span>
</span><span id="__span-0-2"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recid</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secp256k1_fe_cmp_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">secp256k1_ecdsa_const_p_minus_order</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-5"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-6"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">secp256k1_fe_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">secp256k1_ecdsa_const_order_as_fe</span><span class="p">);</span>
</span><span id="__span-0-7"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="p">}</span>
</span><span id="__span-0-8"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">secp256k1_ge_set_xo_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fx</span><span class="p">,</span><span class="w"> </span><span class="n">recid</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-9"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-10"><a href="crypto/2023/07/14/ecdsa/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>参考：<a href="https://medium.com/asecuritysite-when-bob-met-alice/crypto-magic-recovering-alices-public-key-from-an-ecdsa-signature-e7193df8df6e">Crypto Magic: Recovering Alice’s Public Key From An ECDSA Signature</a> 和 <a href="https://medium.com/asecuritysite-when-bob-met-alice/can-we-recover-the-public-key-from-an-ecdsa-signature-7af4b56a8a0f">Can We Recover The Public Key from an ECDSA Signature?</a></p>
<nav class="md-post__action">
<a href="crypto/2023/07/14/ecdsa/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-07-08 00:00:00">2023年7月8日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/devops/">devops</a></li>
<li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="apple-m1-gentooprefix"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/">在 Apple M1 上试用 Gentoo/Prefix</a></h2>
<h3 id="_1"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/#_1">背景</a></h3>
<p>上一次折腾 Gentoo/Prefix 是<a href="/devops/2017/12/27/try-gentoo-prefix-on-macos/">五年多以前</a>，当时还是用的 Intel Mac，最近需要探索一下在现在的 macOS 系统上用 Gentoo/Prefix 会遇到哪些问题，因此今天在 Apple M1 上重新尝试一次。</p>
<h3 id="_2"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/#_2">安装</a></h3>
<p>按照<a href="https://wiki.gentoo.org/wiki/Project:Prefix/Bootstrap">官网</a>的文档，下载脚本并运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>wget<span class="w"> </span>https://gitweb.gentoo.org/repo/proj/prefix.git/plain/scripts/bootstrap-prefix.sh
</span><span id="__span-0-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>chmod<span class="w"> </span>+x<span class="w"> </span>bootstrap-prefix.sh
</span><span id="__span-0-3"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>./bootstrap-prefix.sh
</span></code></pre></div>
<p>按照提示输入即可。</p>
<p>编译使用了四到五个多小时，占用 3GB 的硬盘空间。成功以后进入 Gentoo Prefix：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>./startprefix
</span></code></pre></div>
<h3 id="_3"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/#_3">折腾</a></h3>
<p>编译并运行大概两个小时以后，遇到了编译错误：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>Undefined<span class="w"> </span>symbols<span class="w"> </span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>arm64:
</span><span id="__span-2-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">  </span><span class="s2">"_libintl_bindtextdomain"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-3"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">      </span>__locale_bindtextdomain<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-4"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="s2">"_libintl_dcgettext"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-5"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">      </span>__locale_dcgettext<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-6"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="s2">"_libintl_dgettext"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-7"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">      </span>__locale_dgettext<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-8"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="s2">"_libintl_gettext"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-9"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">      </span>__locale_gettext<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-10"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="s2">"_libintl_setlocale"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-11"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">      </span>__locale_setlocale<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-12"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">      </span>__locale_localeconv<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-13"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">  </span><span class="s2">"_libintl_textdomain"</span>,<span class="w"> </span>referenced<span class="w"> </span>from:
</span><span id="__span-2-14"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span>__locale_textdomain<span class="w"> </span><span class="k">in</span><span class="w"> </span>_localemodule.o
</span><span id="__span-2-15"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>ld:<span class="w"> </span>symbol<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span>architecture<span class="w"> </span>arm64
</span></code></pre></div>
<p>是在编译 python3.11.3 的时候遇到的问题，经过一番搜索，发现有一个错误信息比较相关：<a href="https://bugs.gentoo.org/906507">dev-lang/python-3.11.3: bootstrap-prefix.sh stage3 fails (on MacOS/Darwin)</a>，也是在编译 python3.11.3 的时候出错，只不过错误信息不太一样。</p>
<p>我看到这个 bug report 时，里面说问题在新的 commit 已经修复了，但是我仔细看了一下，修复的时间正好在我跑 bootstrap 脚本后几个小时，也就是说我跑的版本是修复前的版本。于是我重新下载了最新版，重新 bootstrap，又等了两个小时，还是出现了同样的问题，说明问题并没有被解决。</p>
<h4 id="libintl"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/#libintl">libintl</a></h4>
<p>观察错误信息，发现是 libintl 相关的符号缺失。向 @heroxbd 学习到了 libintl 的机制：它是一套 API，在 glibc 和 musl 等一些 libc 中有实现，在 gettext 中也有实现，系统里只需要有一份就行。因此在常见的 Linux 发行版里，libintl 是由 libc 提供的，此时 gettext 编译的时候就不会附带 libintl；而如果在 macOS 上，由于 macOS 的 libc 没有 libintl 的 API，所以 gettext 编译的时候就要附带 libintl。</p>
<p>例如 Homebrew 的编译脚本里，就做了这个特殊处理：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>brew<span class="w"> </span>cat<span class="w"> </span>gettext
</span><span id="__span-3-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">## omitted</span>
</span><span id="__span-3-3"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span>args<span class="w"> </span><span class="s">&lt;&lt; if OS.mac?</span>
</span><span id="__span-3-4"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="s">      # Shi</span>p<span class="w"> </span>libintl.h.<span class="w"> </span>Disabled<span class="w"> </span>on<span class="w"> </span>linux<span class="w"> </span>as<span class="w"> </span>libintl.h<span class="w"> </span>is<span class="w"> </span>provided<span class="w"> </span>by<span class="w"> </span>glibc
</span><span id="__span-3-5"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">      </span><span class="c1"># https://gcc-help.gcc.gnu.narkive.com/CYebbZqg/cc1-undefined-reference-to-libintl-textdomain</span>
</span><span id="__span-3-6"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">      </span><span class="c1"># There should never be a need to install gettext's libintl.h on</span>
</span><span id="__span-3-7"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">      </span><span class="c1"># GNU/Linux systems using glibc. If you have it installed you've borked</span>
</span><span id="__span-3-8"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">      </span><span class="c1"># your system somehow.</span>
</span><span id="__span-3-9"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">      </span><span class="s2">"--with-included-gettext"</span>
</span><span id="__span-3-10"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="k">else</span>
</span><span id="__span-3-11"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">      </span><span class="s2">"--with-libxml2-prefix=#{Formula["</span>libxml2<span class="s2">"].opt_prefix}"</span>
</span><span id="__span-3-12"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span>end
</span><span id="__span-3-13"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="c1">## omitted</span>
</span></code></pre></div>
<p>在 Gentoo 中，处理方式是这样的：把 gettext 的源码编译两份，对应两个包，一个包叫做 gettext，也就是 gettext 去掉 libintl 的部分；另一个包叫做 libintl，也就是 gettext 的 libintl 部分。两个包用同一份源码，只是编译选项不同，因此得到了不同的结果。</p>
<p>那么，接下来的问题就是，为什么会缺符号呢？比较一下 homebrew 和 gentoo 编译出来的 libintl.dylib 符号，可以发现区别：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/opt/homebrew/opt/gettext/lib/libintl.a<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>bindtextdomain
</span><span id="__span-4-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="m">0000000000000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_libintl_bindtextdomain
</span><span id="__span-4-3"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>000000000000001c<span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_bindtextdomain
</span><span id="__span-4-4"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_libintl_bindtextdomain
</span><span id="__span-4-5"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span><span class="nv">$EPREFIX</span>/tmp/usr/lib/libintl.dylib<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>bindtextdomain
</span><span id="__span-4-6"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>0000000000009a34<span class="w"> </span>l<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_bindtextdomain
</span><span id="__span-4-7"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="m">0000000000004800</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_libintl_bindtextdomain
</span></code></pre></div>
<p>可以看到，两者的区别是 visibility 从 global 变成了 local，链接的时候也出现了 warning：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>ld: warning: cannot export hidden symbol _bindtextdomain from .libs/intl-compat.o
</span></code></pre></div>
<p>@heroxbd 给出了临时的解决方法：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span><span class="nv">gl_cv_cc_visibility</span><span class="o">=</span>no<span class="w"> </span><span class="nv">$EPREFIX</span>/tmp/usr/bin/emerge<span class="w"> </span>-1v<span class="w"> </span>libintl
</span></code></pre></div>
<p>编译的时候强制把 <code>-fvisibility=hidden</code> 覆盖掉，这样就不会有 visibility 的问题：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>/Volumes/Data/gentoo/tmp/usr/lib/libintl.dylib<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>bindtextdomain
</span><span id="__span-7-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>0000000000009a34<span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_bindtextdomain
</span><span id="__span-7-3"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="m">0000000000004800</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_libintl_bindtextdomain
</span></code></pre></div>
<p>此时问题就解决了，可以正常编译 python3。</p>
<h4 id="_4"><a class="toclink" href="devops/2023/07/08/gentoo-prefix-m1/#_4">其他问题</a></h4>
<p>目前还遇到了一个小 bug：gettext 强制打开了 xattr（https://bugs.gentoo.org/910070），但是 attr 在 macOS 上编译不过，解决办法是再 force 把 xattr USE 删掉：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>cat<span class="w"> </span>/etc/portage/profile/package.use.force
</span><span id="__span-8-2"><a href="devops/2023/07/08/gentoo-prefix-m1/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>&gt;<span class="o">=</span>sys-devel/gettext-0.22-r1<span class="w"> </span>-xattr
</span></code></pre></div>
<nav class="md-post__action">
<a href="devops/2023/07/08/gentoo-prefix-m1/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-06-20 00:00:00">2023年6月20日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/networking/">networking</a></li>
<li class="md-meta__item">
            
              需要 10 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/">生成树协议</a></h2>
<h3 id="spanning-tree-protocol"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#spanning-tree-protocol">Spanning Tree Protocol</a></h3>
<p>STP（Spanning Tree Protocol）可以在 <a href="https://ieeexplore.ieee.org/document/1389253">802.1D-1998</a> 第 8 章中找到。STP 协议工作在交换机上，需要根据交换机连接的拓扑，自动计算出一个生成树，并且把不在生成树上的边禁用，这样即使连接的拓扑有环路，禁用以后就没有环了。有了 STP 以后，连接交换机的时候就可以刻意连成环，从而提供冗余。</p>
<p>在 STP 协议提出的时候，网络还不像现在这样以点对点为主，因此需要考虑共享介质的场景，也就是多个交换机连到同一个局域网，并且这个局域网通过 Hub 来共享介质。因此，实际上局域网也属于拓扑的一部分，对应生成树的一个结点。为了统一点对点和共享介质，不妨认为点对点连接中，也连接了一个共享介质的局域网，只不过这个局域网没有其他网络设备。这样设定以后，从网络拓扑上来看，就是很多个独立的局域网，用交换机连接起来。</p>
<p>STP 协议工作的第一步是选举出一个 Root Bridge，也就是生成树的根结点。为了保证选举出唯一的 Root Bridge，选择的标准是，找到最小的 Bridge ID，ID 由人为设定的优先级以及 MAC 地址组成。由于 MAC 地址是唯一的，所以 Bridge ID 也是唯一的，因此一定可以找到一个最小的 ID，那么它就是 Root Bridge。</p>
<p>实际工作的时候，交换机会收发 BPDU，并且把其他交换机发给自己的 Root ID 和自己的 ID 进行比较：如果自己的 ID 比别人发的 Root ID 都小，那么自己是 Root；如果别人发的 Root ID 比自己小，那自己肯定不是 Root。经过一段时间，拥有最小 ID 的 Bridge 信息会逐渐传播到整个网络，最后所有交换机都会对 Root Bridge 达成共识。</p>
<p>确定好 Root Bridge 之后，接下来就是得到生成树。每个交换机会接收相邻交换机发送的 BPDU，得知相邻交换机到 Root Bridge 的距离，然后像路由协议那样，计算出走从哪个 Port 走到达 Root Bridge 的距离最短，就把这个 Port 标记为 Root Port，意思是沿着这个方向走，就会一跳一跳地到达 Root Bridge。同时也会更新自己到 Root Bridge 的距离，发给相邻的交换机。这些 Root Port 的方向就对应了生成树里面的父亲节点。</p>
<p>得到生成树以后，就知道如何禁用不在生成树的边了：如果在某个非 Root 端口上监听到了其他交换机发送的 BPDU，那就说明交换机在这个端口方向上存在一条不在生成树上的边。但是，这条边上有一个局域网（前面提到，即使是交换机之间点对点连接，也可以认为有一个没有网络设备的局域网在中间），这个局域网依然需要能够访问其他局域网。因此，连接到同一个局域网的多个交换机，需要选择出一个交换机，负责这个局域网的所有流量，也就是 Designated Bridge。Designated Bridge 连向局域网的 Port 就是 Designated Port。而连接到局域网的非 Designated Bridge，就需要禁用端口，不收不发数据，只处理 BPDU，此时就是 Block Port。</p>
<p>因此，从交换机的视角，如果是 Root Bridge，看到的就是若干个 Designated Port；如果不是 Root Bridge，那么会看到一个 Root Port，若干个 Designated Port，可能还有 Blocked Port。</p>
<p>需要区分两个概念：Role 和 State。每个交换机在每个 Port 上，都有一个 Role 和一个 State：</p>
<ul>
<li>Role：Root，Designated，Blocked</li>
<li>State：Disabled，Blocking，Listening，Learning，Forwarding</li>
</ul>
<p>Role 指的是端口的属性，用于 STP 内部：</p>
<ul>
<li>Root：连向 Root 的最短路径的方向</li>
<li>Designated：负责转发局域网流量</li>
<li>Blocked：出现了环导致不能转发</li>
</ul>
<p>State 指的是端口的状态，可以认为是 STP 的输出，把端口设置为对应的状态：</p>
<ul>
<li>Blocking：不转发以太网帧</li>
<li>Listening：不转发以太网帧，但是收发 BPDU</li>
<li>Learning：在 Listening 的基础上，监听流量，学习 MAC 地址，添加到转发表</li>
<li>Forwarding：正常工作</li>
<li>Disabled：被管理员禁用</li>
</ul>
<p>小结一下 STP 的工作流程：</p>
<ol>
<li>选举出 Root Bridge</li>
<li>对于每个 LAN Segment，选举出 Designated Switch</li>
<li>把不在生成树上的端口设置为 Blocking</li>
</ol>
<h3 id="rapid-spanning-tree-protocol"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#rapid-spanning-tree-protocol">Rapid Spanning Tree Protocol</a></h3>
<p>RSTP（Rapid Spanning Tree Protocol）是 STP 协议的升级，在 <a href="https://ieeexplore.ieee.org/document/1309630">802.1D-2004</a> 标准中定义。</p>
<p>和 STP 不同，RSTP 定义了五个 Role：</p>
<ul>
<li>Root：连向 Root 的最短路径的方向</li>
<li>Designated：负责转发局域网流量</li>
<li>Alternate：连向 Root 的另一条路径的方向</li>
<li>Backup：已经有另一个交换机连接的局域网方向</li>
<li>Disabled：被管理员禁用</li>
</ul>
<p>除了 Disabled 以外，RSTP 和 STP 的区别在于，RSTP 把 Blocked 改成了 Alternate 和 Backup：</p>
<ul>
<li>Alternate 作为 Root 的备份：记录交换机到 Root 的第二条路径，当 Root Port 出问题了，那么 Alternate Port 可以成为新的 Root Port</li>
<li>Backup 作为 Designated 的备份：连接的局域网有别的 Designated Bridge，如果 Designated Bridge 出问题了，自己可以成为新的 Designated Bridge</li>
</ul>
<p>这样的好处是，如果 Root Port 出问题了，可以及时切换到别的路径上，提高收敛速度。</p>
<p>相比 STP，RSTP 把 State 简化成了三个：</p>
<ul>
<li>Discarding：不转发以太网帧，对应 STP 的 Blocking 和 Listening</li>
<li>Learning：不转发以太网帧，学习 MAC 地址</li>
<li>Forwarding：正常工作</li>
</ul>
<h3 id="vlan"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#vlan">VLAN</a></h3>
<p>STP 和 RSTP 都没有考虑 VLAN，只考虑了交换机的拓扑。但实际上，每个 VLAN 可能是不同的一个拓扑，可能只有部分交换机参与到特定的 VLAN 中，这时候就希望可以做一个 Per VLAN 的 STP。</p>
<p>Per VLAN 的 STP 相关协议有：</p>
<ul>
<li>STP + VLAN: Per-VLAN Spanning Tree(PVST/PVST+) by Cisco</li>
<li>RSTP + VLAN: Rapid Per-VLAN Spanning Tree(Rapid PVST/Rapid PVST+) by Cisco</li>
<li>RSTP + VLAN: Vlan-based Spanning Tree(VBST) by Huawei</li>
</ul>
<p>根据文档，VBST 和 Rapid PVST 是兼容的，虽然名字不同，但大概率是一样的协议。</p>
<p>此外还有 Multiple Spanning Tree Protocol(MSTP)，定义在 IEEE 802.1s-2002 标准中，它并不是 Per-VLAN Spanning Tree，而支持跨 VLAN 的生成树计算。</p>
<p>下面是在不同型号的交换机上观察到支持的协议：</p>
<ul>
<li>Dell：stp pvst rstp rapid-pvst mstp</li>
<li>Huawei：stp rstp mstp vbst</li>
<li>Mellanox：rst mst rpvst</li>
<li>Cisco：mst rapid-pvst</li>
</ul>
<p>实践中，可以使用 rapid-pvst/vbst/rpvst 的配置。</p>
<h3 id="stp-port-type"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#stp-port-type">STP Port Type</a></h3>
<p>在交换机设置中，经常可以看到对 STP Port Type 的支持：</p>
<ul>
<li>Edge：仅主机</li>
<li>Network：仅交换机</li>
<li>Normal：自适应</li>
</ul>
<p>STP 协议在工作的时候，为了防止协议初始化过程中引入了不必要的环路，初始化时是不转发流量的。那么，如果事先知道端口连接的只有主机，没有交换机，就可以跳过这个过程，直接开始进入 Forwarding 状态，此时就可以设置为 Edge 模式。在 Edge 模式下，交换机不会发送 BPDU。</p>
<p>如果事先知道连接的是交换机，可以选择 Network，但是需要注意的是，Cisco 实现了 Bridge Assurance，也就是说，如果设置为 Network 模式，<strong>必须要求对方也设置为 Network 模式</strong>，否则就不会工作。</p>
<p>普适的方法是设置为 Normal，此时就会按照正常的方法来初始化。</p>
<h3 id="bpdu-filter"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#bpdu-filter">BPDU Filter</a></h3>
<p>BPDU Filter 顾名思义，在特定端口上禁用 STP 协议：不发送 BPDU，收到的 BPDU 都忽略，可以用来限制 STP 工作的范围。</p>
<h3 id="virtual-port-channel-vpc"><a class="toclink" href="networking/2023/06/20/spanning-tree-protocol/#virtual-port-channel-vpc">Virtual Port Channel (vPC)</a></h3>
<p>STP 解决了环路的问题，使得网络管理员在设计拓扑的时候，可以添加更多边来提供冗余。但是，STP 的工作原理决定了，冗余链路平时是被禁用的，不会走流量。是否有办法，在提供冗余的同时，又能够利用上冗余链路的带宽？</p>
<p>针对这个场景，厂商提供了不同的解决方案，这里以 Cisco 的 vPC 作为一个例子来介绍。vPC 就是虚拟的 Port Channel 的意思，Port Channel 就是链路聚合，把两个交换机之间的多条链路当成一个用；Virtual Port Channel(vPC) 则是把 Port Channel 扩展到了跨交换机，二对一，一部分链路连到 Switch 1，剩下的链路连到 Switch 2，但是从外面看过来，等价于只有一个交换机：</p>
<p><img alt="" src="/images/vpc.png"/></p>
<p>来源：<a href="https://www.ciscopress.com/articles/article.asp?p=3150966&amp;seqNum=2">Port Channels and vPCs</a></p>
<p>这样就实现了对冗余链路的利用。</p>
<p>在 vPC 的 Peer Switch 模式下，为了让 Switch 3 看到的只是一个交换机，它把 Switch 1 和 Switch 2 伪装成同一个交换机：STP 的 Bridge ID 相同，在 STP 协议中看起来到就是一个 Root Bridge。</p>
<p>在 Dell 和 Mellanox 交换机中，类似的功能叫做 MLAG(Multi-switch LAG/Multi-chassis LAG)。</p>
<nav class="md-post__action">
<a href="networking/2023/06/20/spanning-tree-protocol/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-06-15 00:00:00">2023年6月15日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="libvirtd-proxmox-ve"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/">从 libvirtd 迁移到 Proxmox VE</a></h2>
<h3 id="_1"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#_1">背景</a></h3>
<p>之前用 libvirtd + virt-manager 做 Linux 上的虚拟化，好处是比较轻量级，但是远程控制起来比较麻烦，要么通过 RDP 访问 virt-manager 的 UI，要么就用 cockpit 在网页里去配置虚拟机。此时就会比较怀念 VMware ESXi 的网页，但是 ESXi 装完以后，宿主机就很不自由了，很多东西没法自定义。最后就想到在 Debian 上装一个 Proxmox VE，希望得到一个比较好的中间态。</p>
<h3 id="proxmox-ve"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#proxmox-ve">Proxmox VE 安装</a></h3>
<p>按照官方的 <a href="https://pve.proxmox.com/wiki/Install_Proxmox_VE_on_Debian_11_Bullseye">Install Proxmox VE on Debian 11 Bullseye</a> 去安装即可。我的环境是 Debian Bookworm，把路径改成 Bookworm 的 pvetest 即可。安装的时候可能会遇到一些小问题，例如用 ifupdown2 替换 ifupdown 的时候会检查 config 是否正确等等。安装完以后重启，就可以用 root 用户访问 Proxmox VE 了。</p>
<h3 id="libvirtd"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#libvirtd">迁移 libvirtd 虚拟机</a></h3>
<p>下一步是迁移 libvirtd 虚拟机。在网上搜索，会看到提供的方法是，在 Proxmox VE 里创建一个同样大小的镜像，然后把原来的 qcow2 的数据复制一份，但是这样复制的时候得存两份数据，而且对稀疏 qcow2 的支持也不太好。</p>
<p>最后实际的解决办法是：在 Proxmox VE 里创建一个和 qcow2 大小一样的镜像，设置为 qcow2 格式，然后去 <code>/var/lib/vz/images</code> 路径下找到新建的 qcow2，直接用原来 libvirtd 创建的 qcow2 覆盖过去。目前来看，还没有遇到问题，毕竟 ProxmoxVE 用的也是 QEMU，和 libvirtd 一样。</p>
<h3 id="uefi"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#uefi">UEFI</a></h3>
<p>在 Proxmox VE 创建虚拟机，如果选的是 UEFI，由于它会采用新的 EFI vars 镜像，所以原来的 UEFI vars 就丢失了，启动的时候，如果 grub 的 EFI 程序不在标准的路径下，可能会找不到 grub。</p>
<p>解决办法是，先删掉网卡，然后修改 boot order，把 ESP 分区所在的盘加上去，这样 UEFI 启动的时候直接进 shell，然后在 fs0 里找到 grub 的 EFI 程序再启动。</p>
<p>在启动 NixOS 的时候，还发现运行 systemd-boot 的 EFI 程序的时候会 Access Denied，查询了一下，是因为 Secure Boot。进入 UEFI Firmware Setup，把 Secure Boot 关掉再重启，就可以正常进入了。</p>
<h3 id="windows"><a class="toclink" href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#windows">Windows</a></h3>
<p>在创建虚拟机的时候，如果指定了 Windows 11，就会自动勾选上 TPM 相关的配置。但启动的时候，说 swtpm 报错无法启动，按照错误信息查询了一下，找到了 <a href="https://github.com/quickemu-project/quickemu/issues/487">Apparmor &gt; swtpm: Could not open UnixIO socket: Permission denied</a>：原因是 AppArmor 拦截了 swtpm 的操作，可以用命令来解除 AppArmor 的拦截：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>sudo<span class="w"> </span>aa-complain<span class="w"> </span>/usr/bin/swtpm
</span><span id="__span-0-2"><a href="software/2023/06/15/libvirtd-migrate-proxmox-ve/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>sudo<span class="w"> </span>apparmor_parser<span class="w"> </span>-r<span class="w"> </span>/etc/apparmor.d/usr.bin.swtpm
</span></code></pre></div>
<p>这样处理以后就可以正常启动 Windows 了。</p>
<nav class="md-post__action">
<a href="software/2023/06/15/libvirtd-migrate-proxmox-ve/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-06-12 00:00:00">2023年6月12日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 12 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="loongarch"><a class="toclink" href="hardware/2023/06/12/try-loongarch/">LoongArch 初尝试</a></h2>
<h3 id="_1"><a class="toclink" href="hardware/2023/06/12/try-loongarch/#_1">背景</a></h3>
<p>最近应龙芯要求把监控程序移植到了 LoongArch 32 Reduced 架构上，趁此机会体验了一下 LoongArch 相关的软件和系统。</p>
<h3 id="qemu-loongarch-arch-linux"><a class="toclink" href="hardware/2023/06/12/try-loongarch/#qemu-loongarch-arch-linux">在 QEMU 中运行 LoongArch Arch Linux</a></h3>
<p>主页：https://github.com/loongarchlinux</p>
<p>环境：Debian Bookworm</p>
<p>QEMU 启动流程，参考<a href="https://mirrors.wsyu.edu.cn/loongarch/archlinux/images/README.html">官方文档</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>wget<span class="w"> </span>https://mirrors.wsyu.edu.cn/loongarch/archlinux/images/archlinux-xfce4-2023.05.10-loong64.qcow2.zst
</span><span id="__span-0-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>zstd<span class="w"> </span>-d<span class="w"> </span>archlinux-xfce4-2023.05.10-loong64.qcow2.zst
</span><span id="__span-0-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>wget<span class="w"> </span>https://mirrors.wsyu.edu.cn/loongarch/archlinux/images/QEMU_EFI_7.2.fd
</span></code></pre></div>
<p>然后就可以启动 QEMU 7.2.2 了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>qemu-system-loongarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span>-m<span class="w"> </span>4G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span>-cpu<span class="w"> </span>la464-loongarch-cpu<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-4"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span>-machine<span class="w"> </span>virt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-5"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-6"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span>-bios<span class="w"> </span>./QEMU_EFI_7.2.fd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-7"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span>-serial<span class="w"> </span>stdio<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-8"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span>-device<span class="w"> </span>virtio-gpu-pci<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-9"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span>-net<span class="w"> </span>nic<span class="w"> </span>-net<span class="w"> </span>user<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-10"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span>-device<span class="w"> </span>nec-usb-xhci,id<span class="o">=</span>xhci,addr<span class="o">=</span>0x1b<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-11"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span>-device<span class="w"> </span>usb-tablet,id<span class="o">=</span>tablet,bus<span class="o">=</span>xhci.0,port<span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-12"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span>-device<span class="w"> </span>usb-kbd,id<span class="o">=</span>keyboard,bus<span class="o">=</span>xhci.0,port<span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-13"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span>-hda<span class="w"> </span>archlinux-xfce4-2023.05.10-loong64.qcow2
</span></code></pre></div>
<p>启动后，可以正常看到 Xfce4 的界面，用 loongarch:loongarch 登录：</p>
<p><img alt="" src="/images/loongarchlinux.png"/></p>
<p>如果不想用 UI，可以先在虚拟机里启动 SSHD，再打开 SSH 转发：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">## in vm</span>
</span><span id="__span-2-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>sshd
</span><span id="__span-2-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="c1">## in host</span>
</span><span id="__span-2-4"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>qemu-system-loongarch64<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-5"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span>-m<span class="w"> </span>4G<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-6"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span>-cpu<span class="w"> </span>la464-loongarch-cpu<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-7"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span>-machine<span class="w"> </span>virt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-8"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span>-smp<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-9"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span>-bios<span class="w"> </span>./QEMU_EFI_7.2.fd<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-10"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span>-nographic<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-11"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span>-device<span class="w"> </span>virtio-net,netdev<span class="o">=</span>net0<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-12"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span>-netdev<span class="w"> </span>user,id<span class="o">=</span>net0,hostfwd<span class="o">=</span>tcp::4444-:22<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-13"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span>-hda<span class="w"> </span>archlinux-xfce4-2023.05.10-loong64.qcow2
</span></code></pre></div>
<p>然后就可以通过 SSH 访问 LoongArch 虚拟机了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>ssh<span class="w"> </span>loongarch@localhost<span class="w"> </span>-p<span class="w"> </span><span class="m">4444</span>
</span><span id="__span-3-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>loongarch@localhost<span class="err">'</span>s<span class="w"> </span>password:
</span><span id="__span-3-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="o">[</span>loongarch@archlinux<span class="w"> </span>~<span class="o">]</span>$<span class="w"> </span>uname<span class="w"> </span>-a
</span><span id="__span-3-4"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>Linux<span class="w"> </span>archlinux<span class="w"> </span><span class="m">6</span>.3.0-12<span class="w"> </span><span class="c1">#1 SMP Thu, 27 Apr 2023 12:24:56 +0000 loongarch64 GNU/Linux</span>
</span></code></pre></div>
<h3 id="loongarch_1"><a class="toclink" href="hardware/2023/06/12/try-loongarch/#loongarch_1">LoongArch 架构</a></h3>
<p>LoongArch 分为三个版本：</p>
<ol>
<li>LoongArch 32 Reduced：精简版本，系统和用户态都是 32 位</li>
<li>LoongArch 32：系统和用户态都是 32 位</li>
<li>LoongArch 64：系统是 64 位，用户态可以是 32 位，也可以是 64 位</li>
</ol>
<p>目前上游工具链支持的是 LoongArch 64。</p>
<p>龙芯杯采用的是 LoongArch 32 Reduced 版本，相比 LoongArch 32 的区别有：</p>
<ol>
<li>删掉了部分算术指令</li>
<li>删掉了位操作指令</li>
<li>删除了边界检查访存指令</li>
<li>删除了 Atomic 原子指令，只保留了 LL+SC</li>
<li>删除了部分浮点运算指令</li>
<li>删除了 IOCSR 访问指令</li>
<li>删除了软件页表遍历指令</li>
<li>TLB Refill 异常的相关 CSR（ERA/BADV/PRMD/EHI/ELO0/ELO1/SAVE）不再单独提供一份，而是和其他异常共用</li>
<li>去掉了 STLB，只保留了 MTLB</li>
<li>去掉了部分 CSR</li>
<li>直接映射配置窗口数量砍到了两个</li>
<li>删除了 RAS，PMU，Watchpoint 和硬件调试功能</li>
</ol>
<p>从用户态来看，主要是差了一些运算指令，需要编译器注意生成的指令范围。内核态上删减的比较多。</p>
<h3 id="loongarch-32-reduced"><a class="toclink" href="hardware/2023/06/12/try-loongarch/#loongarch-32-reduced">LoongArch 32 Reduced</a></h3>
<p>龙芯提供了一些 LoongArch 32 Reduced 的工具链：</p>
<ol>
<li>GCC + Binutils：<a href="https://gitee.com/loongson-edu/la32r-toolchains/releases/download/v0.0.2/loongarch32r-linux-gnusf-2022-05-20-x86.tar.gz">loongarch32r-linux-gnusf-2022-05-20-x86.tar.gz
</a>，有源码。</li>
<li>GDB：<a href="https://gitee.com/loongson-edu/la32r-toolchains/releases/download/v0.0.2/loongarch32r-linux-gnusf-gdb-x86">loongarch32r-linux-gnusf-gdb-x86</a>，依赖的动态库较多，建议起一个 CentOS Docker。没有找到源码。</li>
<li>QEMU：<a href="https://gitee.com/loongson-edu/la32r-QEMU/releases/download/v0.0.1-alpha/qemu-system-loongarch32_centos_x86_64">qemu-system-loongarch32_centos_x86_64</a>，依赖的动态库较多，建议克隆下来自己编译：<code>mkdir build; cd build; ../configure --target-list=loongarch32-softmmu --disable-werror --enable-debug</code></li>
</ol>
<p>在 <a href="https://gitee.com/loongson-edu/la32r-QEMU">la32r-QEMU</a> 中运行 <a href="https://gitee.com/loongson-edu/la32r-Linux/">la32r-Linux</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>wget<span class="w"> </span>https://gitee.com/loongson-edu/la32r-Linux/releases/download/v0.2/vmlinux
</span><span id="__span-4-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>qemu-system-loongarch32<span class="w"> </span>-m<span class="w"> </span>4G<span class="w"> </span>-kernel<span class="w"> </span>vmlinux<span class="w"> </span>-M<span class="w"> </span>ls3a5k32<span class="w"> </span>-nographic
</span><span id="__span-4-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>loongson32_init:<span class="w"> </span>num_nodes<span class="w"> </span><span class="m">1</span>
</span><span id="__span-4-4"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>loongson32_init:<span class="w"> </span>node<span class="w"> </span><span class="m">0</span><span class="w"> </span>mem<span class="w"> </span>0x100000000
</span><span id="__span-4-5"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Linux<span class="w"> </span>version<span class="w"> </span><span class="m">5</span>.14.0-rc2-g32a8c74db8fc-dirty<span class="w"> </span><span class="o">(</span>mengfanrui@5.5<span class="o">)</span><span class="w"> </span><span class="o">(</span>loongarch32r-linux-gnusf-gcc<span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span><span class="m">8</span>.3.0,<span class="w"> </span>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>GNU<span class="w"> </span>Binutils<span class="o">)</span><span class="w"> </span><span class="m">2</span>.31.1.20190122<span class="o">)</span><span class="w"> </span><span class="c1">#26 PREEMPT Tue May 31 13:46:54 CST 2022</span>
</span><span id="__span-4-6"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Standard<span class="w"> </span><span class="m">32</span>-bit<span class="w"> </span>Loongson<span class="w"> </span>Processor<span class="w"> </span>probed
</span><span id="__span-4-7"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>the<span class="w"> </span>link<span class="w"> </span>is<span class="w"> </span>empty!
</span><span id="__span-4-8"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Scan<span class="w"> </span>bootparam<span class="w"> </span>failed
</span><span id="__span-4-9"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>bootconsole<span class="w"> </span><span class="o">[</span>early0<span class="o">]</span><span class="w"> </span>enabled
</span><span id="__span-4-10"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Can<span class="s1">'t find EFI system table.</span>
</span><span id="__span-4-11"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="s1">[    0.000000] start_pfn=0x0, end_pfn=0x8000, num_physpages:0x8000</span>
</span><span id="__span-4-12"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="s1">[    0.000000] The BIOS Version: (null)</span>
</span><span id="__span-4-13"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="s1">[    0.000000] Initrd not found or empty - disabling initrd</span>
</span><span id="__span-4-14"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="s1">[    0.000000] CPU0 revision is: 00004200 (Loongson-32bit)</span>
</span><span id="__span-4-15"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="s1">[    0.000000] Primary instruction cache 8kB, 2-way, VIPT, linesize 16 bytes.</span>
</span><span id="__span-4-16"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="s1">[    0.000000] Primary data cache 8kB, 2-way, VIPT, no aliases, linesize 16 bytes</span>
</span><span id="__span-4-17"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="s1">[    0.000000] Zone ranges:</span>
</span><span id="__span-4-18"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="s1">[    0.000000]   DMA32    [mem 0x0000000000000000-0x00000000ffffffff]</span>
</span><span id="__span-4-19"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="s1">[    0.000000]   Normal   empty</span>
</span><span id="__span-4-20"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="s1">[    0.000000] Movable zone start for each node</span>
</span><span id="__span-4-21"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="s1">[    0.000000] Early memory node ranges</span>
</span><span id="__span-4-22"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="s1">[    0.000000]   node   0: [mem 0x0000000000000000-0x0000000007ffffff]</span>
</span><span id="__span-4-23"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="s1">[    0.000000] Initmem setup node 0 [mem 0x0000000000000000-0x0000000007ffffff]</span>
</span><span id="__span-4-24"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="s1">[    0.000000] eentry = 0xa0210000,tlbrentry = 0xa0201000</span>
</span><span id="__span-4-25"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="s1">[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 32480</span>
</span><span id="__span-4-26"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="s1">[    0.000000] Kernel command line: earlycon</span>
</span><span id="__span-4-27"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="s1">[    0.000000] Dentry cache hash table entries: 16384 (order: 4, 65536 bytes, linear)</span>
</span><span id="__span-4-28"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="s1">[    0.000000] Inode-cache hash table entries: 8192 (order: 3, 32768 bytes, linear)</span>
</span><span id="__span-4-29"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="s1">[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off</span>
</span><span id="__span-4-30"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="s1">[    0.000000] Memory: 117732K/131072K available (4926K kernel code, 1114K rwdata, 944K rodata, 2480K init, 473K bss, 13340K reserved, 0K cma-reserved)</span>
</span><span id="__span-4-31"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="s1">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1</span>
</span><span id="__span-4-32"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="s1">[    0.000000] rcu: Preemptible hierarchical RCU implementation.</span>
</span><span id="__span-4-33"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="s1">[    0.000000] rcu:     RCU event tracing is enabled.</span>
</span><span id="__span-4-34"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="s1">[    0.000000]  Trampoline variant of Tasks RCU enabled.</span>
</span><span id="__span-4-35"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="s1">[    0.000000]  Tracing variant of Tasks RCU enabled.</span>
</span><span id="__span-4-36"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="s1">[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.</span>
</span><span id="__span-4-37"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="s1">[    0.000000] NR_IRQS: 320</span>
</span><span id="__span-4-38"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="s1">[    0.000000] ------------[ cut here ]------------</span>
</span><span id="__span-4-39"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="s1">[    0.000000] WARNING: CPU: 0 PID: 0 at kernel/time/clockevents.c:38 cev_delta2ns.isra.15+0x17c/0x1c8</span>
</span><span id="__span-4-40"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="s1">[    0.000000] CPU: 0 PID: 0 Comm: swapper Not tainted 5.14.0-rc2-g32a8c74db8fc-dirty #26</span>
</span><span id="__span-4-41"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="s1">[    0.000000] Stack :</span>
</span><span id="__span-4-42"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="s1">[    0.000000] Call Trace:</span>
</span><span id="__span-4-43"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="s1">[    0.000000]</span>
</span><span id="__span-4-44"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="s1">[    0.000000]</span>
</span><span id="__span-4-45"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="s1">[    0.000000] random: get_random_bytes called from print_oops_end_marker+0x30/0x68 with crng_init=0</span>
</span><span id="__span-4-46"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="s1">[    0.000000] ---[ end trace a8581308883ff14d ]---</span>
</span><span id="__span-4-47"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="s1">[    0.000000] Constant clock event device register</span>
</span><span id="__span-4-48"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="s1">[    0.000000] clocksource: Constant: mask: 0xffffffffffffffff max_cycles: 0xffffffffffffffff, max_idle_ns: 9007199254740991 ns</span>
</span><span id="__span-4-49"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="s1">[    0.000000] Constant clock source device register</span>
</span><span id="__span-4-50"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="s1">[    0.752000] Console: colour dummy device 80x25</span>
</span><span id="__span-4-51"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="s1">[    0.816000] printk: console [tty0] enabled</span>
</span><span id="__span-4-52"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="s1">[    0.856000] printk: bootconsole [early0] disabled</span>
</span><span id="__span-4-53"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-53" id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="s1">[    0.000000] Linux version 5.14.0-rc2-g32a8c74db8fc-dirty (mengfanrui@5.5) (loongarch32r-linux-gnusf-gcc (GCC) 8.3.0, GNU ld (GNU Binutils) 2.31.1.20190122) #26 PREEMPT Tue May 31 13:46:54 CST 2022</span>
</span><span id="__span-4-54"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-54" id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="s1">[    0.000000] Standard 32-bit Loongson Processor probed</span>
</span><span id="__span-4-55"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-55" id="__codelineno-4-55" name="__codelineno-4-55"></a><span class="s1">[    0.000000] the link is empty!</span>
</span><span id="__span-4-56"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-56" id="__codelineno-4-56" name="__codelineno-4-56"></a><span class="s1">[    0.000000] Scan bootparam failed</span>
</span><span id="__span-4-57"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-57" id="__codelineno-4-57" name="__codelineno-4-57"></a><span class="s1">[    0.000000] printk: bootconsole [early0] enabled</span>
</span><span id="__span-4-58"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-58" id="__codelineno-4-58" name="__codelineno-4-58"></a><span class="s1">[    0.000000] Can'</span>t<span class="w"> </span>find<span class="w"> </span>EFI<span class="w"> </span>system<span class="w"> </span>table.
</span><span id="__span-4-59"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-59" id="__codelineno-4-59" name="__codelineno-4-59"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span><span class="nv">start_pfn</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">end_pfn</span><span class="o">=</span>0x8000,<span class="w"> </span>num_physpages:0x8000
</span><span id="__span-4-60"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-60" id="__codelineno-4-60" name="__codelineno-4-60"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>The<span class="w"> </span>BIOS<span class="w"> </span>Version:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
</span><span id="__span-4-61"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-61" id="__codelineno-4-61" name="__codelineno-4-61"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Initrd<span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span>or<span class="w"> </span>empty<span class="w"> </span>-<span class="w"> </span>disabling<span class="w"> </span>initrd
</span><span id="__span-4-62"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-62" id="__codelineno-4-62" name="__codelineno-4-62"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>CPU0<span class="w"> </span>revision<span class="w"> </span>is:<span class="w"> </span><span class="m">00004200</span><span class="w"> </span><span class="o">(</span>Loongson-32bit<span class="o">)</span>
</span><span id="__span-4-63"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-63" id="__codelineno-4-63" name="__codelineno-4-63"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Primary<span class="w"> </span>instruction<span class="w"> </span>cache<span class="w"> </span>8kB,<span class="w"> </span><span class="m">2</span>-way,<span class="w"> </span>VIPT,<span class="w"> </span>linesize<span class="w"> </span><span class="m">16</span><span class="w"> </span>bytes.
</span><span id="__span-4-64"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-64" id="__codelineno-4-64" name="__codelineno-4-64"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Primary<span class="w"> </span>data<span class="w"> </span>cache<span class="w"> </span>8kB,<span class="w"> </span><span class="m">2</span>-way,<span class="w"> </span>VIPT,<span class="w"> </span>no<span class="w"> </span>aliases,<span class="w"> </span>linesize<span class="w"> </span><span class="m">16</span><span class="w"> </span>bytes
</span><span id="__span-4-65"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-65" id="__codelineno-4-65" name="__codelineno-4-65"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Zone<span class="w"> </span>ranges:
</span><span id="__span-4-66"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-66" id="__codelineno-4-66" name="__codelineno-4-66"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>DMA32<span class="w">    </span><span class="o">[</span>mem<span class="w"> </span>0x0000000000000000-0x00000000ffffffff<span class="o">]</span>
</span><span id="__span-4-67"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-67" id="__codelineno-4-67" name="__codelineno-4-67"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>Normal<span class="w">   </span>empty
</span><span id="__span-4-68"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-68" id="__codelineno-4-68" name="__codelineno-4-68"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Movable<span class="w"> </span>zone<span class="w"> </span>start<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>node
</span><span id="__span-4-69"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-69" id="__codelineno-4-69" name="__codelineno-4-69"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Early<span class="w"> </span>memory<span class="w"> </span>node<span class="w"> </span>ranges
</span><span id="__span-4-70"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-70" id="__codelineno-4-70" name="__codelineno-4-70"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>node<span class="w">   </span><span class="m">0</span>:<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000000000000-0x0000000007ffffff<span class="o">]</span>
</span><span id="__span-4-71"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-71" id="__codelineno-4-71" name="__codelineno-4-71"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Initmem<span class="w"> </span>setup<span class="w"> </span>node<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000000000000-0x0000000007ffffff<span class="o">]</span>
</span><span id="__span-4-72"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-72" id="__codelineno-4-72" name="__codelineno-4-72"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span><span class="nv">eentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0xa0210000,tlbrentry<span class="w"> </span><span class="o">=</span><span class="w"> </span>0xa0201000
</span><span id="__span-4-73"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-73" id="__codelineno-4-73" name="__codelineno-4-73"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Built<span class="w"> </span><span class="m">1</span><span class="w"> </span>zonelists,<span class="w"> </span>mobility<span class="w"> </span>grouping<span class="w"> </span>on.<span class="w">  </span>Total<span class="w"> </span>pages:<span class="w"> </span><span class="m">32480</span>
</span><span id="__span-4-74"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-74" id="__codelineno-4-74" name="__codelineno-4-74"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span><span class="nb">command</span><span class="w"> </span>line:<span class="w"> </span>earlycon
</span><span id="__span-4-75"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-75" id="__codelineno-4-75" name="__codelineno-4-75"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Dentry<span class="w"> </span>cache<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">16384</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span><span class="m">65536</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-76"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-76" id="__codelineno-4-76" name="__codelineno-4-76"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Inode-cache<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">8192</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">3</span>,<span class="w"> </span><span class="m">32768</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-77"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-77" id="__codelineno-4-77" name="__codelineno-4-77"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>mem<span class="w"> </span>auto-init:<span class="w"> </span>stack:off,<span class="w"> </span>heap<span class="w"> </span>alloc:off,<span class="w"> </span>heap<span class="w"> </span>free:off
</span><span id="__span-4-78"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-78" id="__codelineno-4-78" name="__codelineno-4-78"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Memory:<span class="w"> </span>117732K/131072K<span class="w"> </span>available<span class="w"> </span><span class="o">(</span>4926K<span class="w"> </span>kernel<span class="w"> </span>code,<span class="w"> </span>1114K<span class="w"> </span>rwdata,<span class="w"> </span>944K<span class="w"> </span>rodata,<span class="w"> </span>2480K<span class="w"> </span>init,<span class="w"> </span>473K<span class="w"> </span>bss,<span class="w"> </span>13340K<span class="w"> </span>reserved,<span class="w"> </span>0K<span class="w"> </span>cma-reserved<span class="o">)</span>
</span><span id="__span-4-79"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-79" id="__codelineno-4-79" name="__codelineno-4-79"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>SLUB:<span class="w"> </span><span class="nv">HWalign</span><span class="o">=</span><span class="m">64</span>,<span class="w"> </span><span class="nv">Order</span><span class="o">=</span><span class="m">0</span>-3,<span class="w"> </span><span class="nv">MinObjects</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">CPUs</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">Nodes</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-4-80"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-80" id="__codelineno-4-80" name="__codelineno-4-80"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>rcu:<span class="w"> </span>Preemptible<span class="w"> </span>hierarchical<span class="w"> </span>RCU<span class="w"> </span>implementation.
</span><span id="__span-4-81"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-81" id="__codelineno-4-81" name="__codelineno-4-81"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>rcu:<span class="w">     </span>RCU<span class="w"> </span>event<span class="w"> </span>tracing<span class="w"> </span>is<span class="w"> </span>enabled.
</span><span id="__span-4-82"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-82" id="__codelineno-4-82" name="__codelineno-4-82"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">  </span>Trampoline<span class="w"> </span>variant<span class="w"> </span>of<span class="w"> </span>Tasks<span class="w"> </span>RCU<span class="w"> </span>enabled.
</span><span id="__span-4-83"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-83" id="__codelineno-4-83" name="__codelineno-4-83"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">  </span>Tracing<span class="w"> </span>variant<span class="w"> </span>of<span class="w"> </span>Tasks<span class="w"> </span>RCU<span class="w"> </span>enabled.
</span><span id="__span-4-84"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-84" id="__codelineno-4-84" name="__codelineno-4-84"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>rcu:<span class="w"> </span>RCU<span class="w"> </span>calculated<span class="w"> </span>value<span class="w"> </span>of<span class="w"> </span>scheduler-enlistment<span class="w"> </span>delay<span class="w"> </span>is<span class="w"> </span><span class="m">25</span><span class="w"> </span>jiffies.
</span><span id="__span-4-85"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-85" id="__codelineno-4-85" name="__codelineno-4-85"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NR_IRQS:<span class="w"> </span><span class="m">320</span>
</span><span id="__span-4-86"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-86" id="__codelineno-4-86" name="__codelineno-4-86"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>------------<span class="o">[</span><span class="w"> </span>cut<span class="w"> </span>here<span class="w"> </span><span class="o">]</span>------------
</span><span id="__span-4-87"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-87" id="__codelineno-4-87" name="__codelineno-4-87"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>WARNING:<span class="w"> </span>CPU:<span class="w"> </span><span class="m">0</span><span class="w"> </span>PID:<span class="w"> </span><span class="m">0</span><span class="w"> </span>at<span class="w"> </span>kernel/time/clockevents.c:38<span class="w"> </span>cev_delta2ns.isra.15+0x17c/0x1c8
</span><span id="__span-4-88"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-88" id="__codelineno-4-88" name="__codelineno-4-88"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>CPU:<span class="w"> </span><span class="m">0</span><span class="w"> </span>PID:<span class="w"> </span><span class="m">0</span><span class="w"> </span>Comm:<span class="w"> </span>swapper<span class="w"> </span>Not<span class="w"> </span>tainted<span class="w"> </span><span class="m">5</span>.14.0-rc2-g32a8c74db8fc-dirty<span class="w"> </span><span class="c1">#26</span>
</span><span id="__span-4-89"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-89" id="__codelineno-4-89" name="__codelineno-4-89"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Stack<span class="w"> </span>:
</span><span id="__span-4-90"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-90" id="__codelineno-4-90" name="__codelineno-4-90"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Call<span class="w"> </span>Trace:
</span><span id="__span-4-91"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-91" id="__codelineno-4-91" name="__codelineno-4-91"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span>
</span><span id="__span-4-92"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-92" id="__codelineno-4-92" name="__codelineno-4-92"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span>
</span><span id="__span-4-93"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-93" id="__codelineno-4-93" name="__codelineno-4-93"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>random:<span class="w"> </span>get_random_bytes<span class="w"> </span>called<span class="w"> </span>from<span class="w"> </span>print_oops_end_marker+0x30/0x68<span class="w"> </span>with<span class="w"> </span><span class="nv">crng_init</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-4-94"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-94" id="__codelineno-4-94" name="__codelineno-4-94"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>---<span class="o">[</span><span class="w"> </span>end<span class="w"> </span>trace<span class="w"> </span>a8581308883ff14d<span class="w"> </span><span class="o">]</span>---
</span><span id="__span-4-95"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-95" id="__codelineno-4-95" name="__codelineno-4-95"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Constant<span class="w"> </span>clock<span class="w"> </span>event<span class="w"> </span>device<span class="w"> </span>register
</span><span id="__span-4-96"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-96" id="__codelineno-4-96" name="__codelineno-4-96"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>clocksource:<span class="w"> </span>Constant:<span class="w"> </span>mask:<span class="w"> </span>0xffffffffffffffff<span class="w"> </span>max_cycles:<span class="w"> </span>0xffffffffffffffff,<span class="w"> </span>max_idle_ns:<span class="w"> </span><span class="m">9007199254740991</span><span class="w"> </span>ns
</span><span id="__span-4-97"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-97" id="__codelineno-4-97" name="__codelineno-4-97"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Constant<span class="w"> </span>clock<span class="w"> </span><span class="nb">source</span><span class="w"> </span>device<span class="w"> </span>register
</span><span id="__span-4-98"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-98" id="__codelineno-4-98" name="__codelineno-4-98"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.752000<span class="o">]</span><span class="w"> </span>Console:<span class="w"> </span>colour<span class="w"> </span>dummy<span class="w"> </span>device<span class="w"> </span>80x25
</span><span id="__span-4-99"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-99" id="__codelineno-4-99" name="__codelineno-4-99"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.816000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>console<span class="w"> </span><span class="o">[</span>tty0<span class="o">]</span><span class="w"> </span>enabled
</span><span id="__span-4-100"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-100" id="__codelineno-4-100" name="__codelineno-4-100"></a><span class="o">[</span><span class="w">    </span><span class="m">0</span>.856000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>bootconsole<span class="w"> </span><span class="o">[</span>early0<span class="o">]</span><span class="w"> </span>disabled
</span><span id="__span-4-101"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-101" id="__codelineno-4-101" name="__codelineno-4-101"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.024000<span class="o">]</span><span class="w"> </span>random:<span class="w"> </span>fast<span class="w"> </span>init<span class="w"> </span><span class="k">done</span>
</span><span id="__span-4-102"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-102" id="__codelineno-4-102" name="__codelineno-4-102"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.240000<span class="o">]</span><span class="w"> </span>Calibrating<span class="w"> </span>delay<span class="w"> </span>loop...<span class="w"> </span><span class="m">0</span>.65<span class="w"> </span>BogoMIPS<span class="w"> </span><span class="o">(</span><span class="nv">lpj</span><span class="o">=</span><span class="m">1312</span><span class="o">)</span>
</span><span id="__span-4-103"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-103" id="__codelineno-4-103" name="__codelineno-4-103"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.444000<span class="o">]</span><span class="w"> </span>pid_max:<span class="w"> </span>default:<span class="w"> </span><span class="m">32768</span><span class="w"> </span>minimum:<span class="w"> </span><span class="m">301</span>
</span><span id="__span-4-104"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-104" id="__codelineno-4-104" name="__codelineno-4-104"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.860000<span class="o">]</span><span class="w"> </span>Mount-cache<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-105"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-105" id="__codelineno-4-105" name="__codelineno-4-105"></a><span class="o">[</span><span class="w">    </span><span class="m">1</span>.868000<span class="o">]</span><span class="w"> </span>Mountpoint-cache<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-106"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-106" id="__codelineno-4-106" name="__codelineno-4-106"></a><span class="o">[</span><span class="w">   </span><span class="m">10</span>.740000<span class="o">]</span><span class="w"> </span>rcu:<span class="w"> </span>Hierarchical<span class="w"> </span>SRCU<span class="w"> </span>implementation.
</span><span id="__span-4-107"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-107" id="__codelineno-4-107" name="__codelineno-4-107"></a><span class="o">[</span><span class="w">   </span><span class="m">13</span>.408000<span class="o">]</span><span class="w"> </span>devtmpfs:<span class="w"> </span>initialized
</span><span id="__span-4-108"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-108" id="__codelineno-4-108" name="__codelineno-4-108"></a><span class="o">[</span><span class="w">   </span><span class="m">15</span>.948000<span class="o">]</span><span class="w"> </span>clocksource:<span class="w"> </span>jiffies:<span class="w"> </span>mask:<span class="w"> </span>0xffffffff<span class="w"> </span>max_cycles:<span class="w"> </span>0xffffffff,<span class="w"> </span>max_idle_ns:<span class="w"> </span><span class="m">7645041785100000</span><span class="w"> </span>ns
</span><span id="__span-4-109"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-109" id="__codelineno-4-109" name="__codelineno-4-109"></a><span class="o">[</span><span class="w">   </span><span class="m">15</span>.980000<span class="o">]</span><span class="w"> </span>futex<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span>-1,<span class="w"> </span><span class="m">3072</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-110"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-110" id="__codelineno-4-110" name="__codelineno-4-110"></a><span class="o">[</span><span class="w">   </span><span class="m">16</span>.948000<span class="o">]</span><span class="w"> </span>NET:<span class="w"> </span>Registered<span class="w"> </span>PF_NETLINK/PF_ROUTE<span class="w"> </span>protocol<span class="w"> </span>family
</span><span id="__span-4-111"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-111" id="__codelineno-4-111" name="__codelineno-4-111"></a><span class="o">[</span><span class="w">   </span><span class="m">28</span>.832000<span class="o">]</span><span class="w"> </span>pps_core:<span class="w"> </span>LinuxPPS<span class="w"> </span>API<span class="w"> </span>ver.<span class="w"> </span><span class="m">1</span><span class="w"> </span>registered
</span><span id="__span-4-112"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-112" id="__codelineno-4-112" name="__codelineno-4-112"></a><span class="o">[</span><span class="w">   </span><span class="m">28</span>.840000<span class="o">]</span><span class="w"> </span>pps_core:<span class="w"> </span>Software<span class="w"> </span>ver.<span class="w"> </span><span class="m">5</span>.3.6<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2005</span>-2007<span class="w"> </span>Rodolfo<span class="w"> </span>Giometti<span class="w"> </span>&lt;giometti@linux.it&gt;
</span><span id="__span-4-113"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-113" id="__codelineno-4-113" name="__codelineno-4-113"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>clocksource:<span class="w"> </span>Switched<span class="w"> </span>to<span class="w"> </span>clocksource<span class="w"> </span>Constant
</span><span id="__span-4-114"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-114" id="__codelineno-4-114" name="__codelineno-4-114"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>FS-Cache:<span class="w"> </span>Loaded
</span><span id="__span-4-115"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-115" id="__codelineno-4-115" name="__codelineno-4-115"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>NET:<span class="w"> </span>Registered<span class="w"> </span>PF_INET<span class="w"> </span>protocol<span class="w"> </span>family
</span><span id="__span-4-116"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-116" id="__codelineno-4-116" name="__codelineno-4-116"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>IP<span class="w"> </span>idents<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">2048</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">2</span>,<span class="w"> </span><span class="m">16384</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-117"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-117" id="__codelineno-4-117" name="__codelineno-4-117"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>tcp_listen_portaddr_hash<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">512</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-118"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-118" id="__codelineno-4-118" name="__codelineno-4-118"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>TCP<span class="w"> </span>established<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-119"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-119" id="__codelineno-4-119" name="__codelineno-4-119"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>TCP<span class="w"> </span><span class="nb">bind</span><span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-120"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-120" id="__codelineno-4-120" name="__codelineno-4-120"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>TCP:<span class="w"> </span>Hash<span class="w"> </span>tables<span class="w"> </span>configured<span class="w"> </span><span class="o">(</span>established<span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="nb">bind</span><span class="w"> </span><span class="m">1024</span><span class="o">)</span>
</span><span id="__span-4-121"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-121" id="__codelineno-4-121" name="__codelineno-4-121"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>UDP<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-122"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-122" id="__codelineno-4-122" name="__codelineno-4-122"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>UDP-Lite<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>table<span class="w"> </span>entries:<span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>order:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">4096</span><span class="w"> </span>bytes,<span class="w"> </span>linear<span class="o">)</span>
</span><span id="__span-4-123"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-123" id="__codelineno-4-123" name="__codelineno-4-123"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>NET:<span class="w"> </span>Registered<span class="w"> </span>PF_UNIX/PF_LOCAL<span class="w"> </span>protocol<span class="w"> </span>family
</span><span id="__span-4-124"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-124" id="__codelineno-4-124" name="__codelineno-4-124"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>workingset:<span class="w"> </span><span class="nv">timestamp_bits</span><span class="o">=</span><span class="m">14</span><span class="w"> </span><span class="nv">max_order</span><span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">bucket_order</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-4-125"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-125" id="__codelineno-4-125" name="__codelineno-4-125"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>IPMI<span class="w"> </span>message<span class="w"> </span>handler:<span class="w"> </span>version<span class="w"> </span><span class="m">39</span>.2
</span><span id="__span-4-126"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-126" id="__codelineno-4-126" name="__codelineno-4-126"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ipmi<span class="w"> </span>device<span class="w"> </span>interface
</span><span id="__span-4-127"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-127" id="__codelineno-4-127" name="__codelineno-4-127"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ipmi_si:<span class="w"> </span>IPMI<span class="w"> </span>System<span class="w"> </span>Interface<span class="w"> </span>driver
</span><span id="__span-4-128"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-128" id="__codelineno-4-128" name="__codelineno-4-128"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ipmi_si:<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span>find<span class="w"> </span>any<span class="w"> </span>System<span class="w"> </span>Interface<span class="o">(</span>s<span class="o">)</span>
</span><span id="__span-4-129"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-129" id="__codelineno-4-129" name="__codelineno-4-129"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>Serial:<span class="w"> </span><span class="m">8250</span>/16550<span class="w"> </span>driver,<span class="w"> </span><span class="m">16</span><span class="w"> </span>ports,<span class="w"> </span>IRQ<span class="w"> </span>sharing<span class="w"> </span>enabled
</span><span id="__span-4-130"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-130" id="__codelineno-4-130" name="__codelineno-4-130"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>1fe001e0.serial:<span class="w"> </span>ttyS0<span class="w"> </span>at<span class="w"> </span>MMIO<span class="w"> </span>0x1fe001e0<span class="w"> </span><span class="o">(</span><span class="nv">irq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span>,<span class="w"> </span><span class="nv">base_baud</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2062500</span><span class="o">)</span><span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>16550A
</span><span id="__span-4-131"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-131" id="__codelineno-4-131" name="__codelineno-4-131"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>console<span class="w"> </span><span class="o">[</span>ttyS0<span class="o">]</span><span class="w"> </span>enabled
</span><span id="__span-4-132"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-132" id="__codelineno-4-132" name="__codelineno-4-132"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ls1a-nand<span class="w"> </span>driver<span class="w"> </span>initializing
</span><span id="__span-4-133"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-133" id="__codelineno-4-133" name="__codelineno-4-133"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ls1a_nand<span class="w"> </span>:<span class="w"> </span>mtd<span class="w"> </span>struct<span class="w"> </span>base<span class="w"> </span>address<span class="w"> </span>is<span class="w"> </span>a102b800
</span><span id="__span-4-134"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-134" id="__codelineno-4-134" name="__codelineno-4-134"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>info-&gt;data_buff<span class="o">===================</span>0x81130000
</span><span id="__span-4-135"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-135" id="__codelineno-4-135" name="__codelineno-4-135"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>nand:<span class="w"> </span>No<span class="w"> </span>NAND<span class="w"> </span>device<span class="w"> </span>found
</span><span id="__span-4-136"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-136" id="__codelineno-4-136" name="__codelineno-4-136"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ls1a-nand<span class="w"> </span>1fe78000.nand:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>scan<span class="w"> </span>nand
</span><span id="__span-4-137"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-137" id="__codelineno-4-137" name="__codelineno-4-137"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>ITC<span class="w"> </span>MAC<span class="w"> </span><span class="m">10</span>/100M<span class="w"> </span>Fast<span class="w"> </span>Ethernet<span class="w"> </span>Adapter<span class="w"> </span>driver<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span>init
</span><span id="__span-4-138"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-138" id="__codelineno-4-138" name="__codelineno-4-138"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>libphy:<span class="w"> </span>Fixed<span class="w"> </span>MDIO<span class="w"> </span>Bus:<span class="w"> </span>probed
</span><span id="__span-4-139"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-139" id="__codelineno-4-139" name="__codelineno-4-139"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>mousedev:<span class="w"> </span>PS/2<span class="w"> </span>mouse<span class="w"> </span>device<span class="w"> </span>common<span class="w"> </span><span class="k">for</span><span class="w"> </span>all<span class="w"> </span>mice
</span><span id="__span-4-140"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-140" id="__codelineno-4-140" name="__codelineno-4-140"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>IR<span class="w"> </span>MCE<span class="w"> </span>Keyboard/mouse<span class="w"> </span>protocol<span class="w"> </span>handler<span class="w"> </span>initialized
</span><span id="__span-4-141"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-141" id="__codelineno-4-141" name="__codelineno-4-141"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>hid:<span class="w"> </span>raw<span class="w"> </span>HID<span class="w"> </span>events<span class="w"> </span>driver<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span>Jiri<span class="w"> </span>Kosina
</span><span id="__span-4-142"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-142" id="__codelineno-4-142" name="__codelineno-4-142"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>NET:<span class="w"> </span>Registered<span class="w"> </span>PF_INET6<span class="w"> </span>protocol<span class="w"> </span>family
</span><span id="__span-4-143"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-143" id="__codelineno-4-143" name="__codelineno-4-143"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>random:<span class="w"> </span>crng<span class="w"> </span>init<span class="w"> </span><span class="k">done</span>
</span><span id="__span-4-144"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-144" id="__codelineno-4-144" name="__codelineno-4-144"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>Segment<span class="w"> </span>Routing<span class="w"> </span>with<span class="w"> </span>IPv6
</span><span id="__span-4-145"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-145" id="__codelineno-4-145" name="__codelineno-4-145"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>sit:<span class="w"> </span>IPv6,<span class="w"> </span>IPv4<span class="w"> </span>and<span class="w"> </span>MPLS<span class="w"> </span>over<span class="w"> </span>IPv4<span class="w"> </span>tunneling<span class="w"> </span>driver
</span><span id="__span-4-146"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-146" id="__codelineno-4-146" name="__codelineno-4-146"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>Warning:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span>open<span class="w"> </span>an<span class="w"> </span>initial<span class="w"> </span>console.
</span><span id="__span-4-147"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-147" id="__codelineno-4-147" name="__codelineno-4-147"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>Freeing<span class="w"> </span>unused<span class="w"> </span>kernel<span class="w"> </span>image<span class="w"> </span><span class="o">(</span>initmem<span class="o">)</span><span class="w"> </span>memory:<span class="w"> </span>2480K
</span><span id="__span-4-148"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-148" id="__codelineno-4-148" name="__codelineno-4-148"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>This<span class="w"> </span>architecture<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>have<span class="w"> </span>kernel<span class="w"> </span>memory<span class="w"> </span>protection.
</span><span id="__span-4-149"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-149" id="__codelineno-4-149" name="__codelineno-4-149"></a><span class="o">[</span><span class="w">   </span><span class="m">32</span>.492000<span class="o">]</span><span class="w"> </span>Run<span class="w"> </span>/init<span class="w"> </span>as<span class="w"> </span>init<span class="w"> </span>process
</span><span id="__span-4-150"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-150" id="__codelineno-4-150" name="__codelineno-4-150"></a>
</span><span id="__span-4-151"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-151" id="__codelineno-4-151" name="__codelineno-4-151"></a>Processing<span class="w"> </span>/etc/profile...<span class="w"> </span>Done
</span><span id="__span-4-152"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-152" id="__codelineno-4-152" name="__codelineno-4-152"></a>
</span><span id="__span-4-153"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-4-153" id="__codelineno-4-153" name="__codelineno-4-153"></a>/<span class="w"> </span><span class="c1">#</span>
</span></code></pre></div>
<p>我在 la32r-QEMU 的基础上，把 LoongArch 32 Reduced 的支持部分移植到了 QEMU 8.0.0 上：<a href="https://github.com/jiegec/qemu/commits/la32r-8.0.0">https://github.com/jiegec/qemu/commits/la32r-8.0.0</a>。</p>
<h3 id="_2"><a class="toclink" href="hardware/2023/06/12/try-loongarch/#_2">虚实地址映射</a></h3>
<p>LoongArch 有两种虚实地址映射方法：</p>
<ol>
<li>直接地址翻译模式（CSR.CRMD.DA=1，CSR.CRMD.PG=0），此时物理地址等于虚拟地址，如果虚拟地址位数更多，则截断高位。</li>
<li>映射地址翻译模式（CSR.CRMD.DA=0，CSR.CRMD.PG=1），此时按照顺序进行下面的翻译：<ol>
<li>直接映射模式：CSR.DMW 定义了四个（LA32R 只有两个）窗口，这些窗口内的虚拟地址与物理地址是平移的关系。</li>
<li>页表映射模式：如果没有匹配上直接映射模式，则会查询 TLB。虽说是页表映射模式，但依然是 MIPS 传统的 TLB 做法。</li>
</ol>
</li>
</ol>
<p>相比 MIPS 来讲，LoongArch 的地址映射还是容易理解一些。</p>
<p>从复位中出来的时候，CSR.CRMD.DA=1，CSR.CRMD.PG=0，意味着是直接地址翻译模式。PC 是 0x1C000000，由于是直接地址翻译模式，所以物理地址也是 0x1C000000。</p>
<p>在遇到 TLB Refill 异常的时候，处理器会跳到 CSR.TLBRENTRY 的地址，同时进入直接地址翻译模式（CSR.CRMD.DA=1，CSR.CRMD.PG=0），意味着虚拟地址直接对应物理地址，所以此时需要做好相应的准备。LoongArch 提供了 lddir 和 ldpte 指令来加快页表到 TLB 项目的查询性能，例如下面是 <a href="https://github.com/tianocore/edk2-platforms/blob/4c3e742e931538a1ee6cb3b571b1281e7fba2564/Platform/Loongson/LoongArchQemuPkg/Library/MmuLib/Mmu.S#L37">EDK2 的 TLB Refill 异常处理函数</a>：</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-5-1"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nf">ASM_PFX</span><span class="p">(</span><span class="no">HandleTlbRefill</span><span class="p">):</span>
</span><span id="__span-5-2"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nf">csrwr</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">LOONGARCH_CSR_TLBRSAVE</span>
</span><span id="__span-5-3"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="nf">csrrd</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">LOONGARCH_CSR_PGD</span>
</span><span id="__span-5-4"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nf">lddir</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">   </span><span class="c1">#Put pud BaseAddress into T0</span>
</span><span id="__span-5-5"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nf">lddir</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="c1">#Put pmd BaseAddress into T0</span>
</span><span id="__span-5-6"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="nf">lddir</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="c1">#Put pte BaseAddress into T0</span>
</span><span id="__span-5-7"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="nf">ldpte</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-5-8"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="nf">ldpte</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-5-9"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">  </span><span class="nf">tlbfill</span>
</span><span id="__span-5-10"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="nf">csrrd</span><span class="w"> </span><span class="no">T0</span><span class="p">,</span><span class="w"> </span><span class="no">LOONGARCH_CSR_TLBRSAVE</span>
</span><span id="__span-5-11"><a href="hardware/2023/06/12/try-loongarch/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="nf">ertn</span>
</span></code></pre></div>
<p>比较有意思的是，csrwr 指令会把旧的 CSR 值写回到通用寄存器里，所以看起来名字是 write，其实是 swap。为了方便查表，还给用户态和内核态分别一个页表基地址：CSR.PGDL，CSR.PGDH，根据异常的高位判断要选择哪一个页表基地址。</p>
<nav class="md-post__action">
<a href="hardware/2023/06/12/try-loongarch/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-23 00:00:00">2023年5月23日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="tar"><a class="toclink" href="software/2023/05/23/tar-format/">Tar 文件格式</a></h2>
<p>本文的内容已经整合到<a href="/kb/software/tar.html">知识库</a>中。</p>
<h3 id="_1"><a class="toclink" href="software/2023/05/23/tar-format/#_1">背景</a></h3>
<p>最近在解压 tar.gz 文件的时候，发现如果用 unar 解压，就会出现文件名截断到 100 个字节的问题，而如果用 gnu tar 解压，文件名就是正常的，因此深入研究了一下 Tar 的文件格式。实际上，这是因为早期 tar 格式设计的时候，就设定了路径最长 100 字节的限制，后来的扩展解决了这个问题，但是 unar 没能正确地识别扩展，导致解压路径出错。</p>
<h3 id="tar_1"><a class="toclink" href="software/2023/05/23/tar-format/#tar_1">Tar 文件格式</a></h3>
<p>Tar 的文件格式比较简单，就是一系列的 File Entry，最后是两个 512 字节的全 0，表示结束。每个 File Entry 由头部和数据组成，头部的格式是：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a href="software/2023/05/23/tar-format/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cm">/* tar Header Block, from POSIX 1003.1-1990.  */</span>
</span><span id="__span-0-2"><a href="software/2023/05/23/tar-format/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="software/2023/05/23/tar-format/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="cm">/* POSIX header.  */</span>
</span><span id="__span-0-4"><a href="software/2023/05/23/tar-format/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a href="software/2023/05/23/tar-format/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">posix_header</span>
</span><span id="__span-0-6"><a href="software/2023/05/23/tar-format/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">{</span><span class="w">                              </span><span class="cm">/* byte offset */</span>
</span><span id="__span-0-7"><a href="software/2023/05/23/tar-format/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span><span class="w">               </span><span class="cm">/*   0 */</span>
</span><span id="__span-0-8"><a href="software/2023/05/23/tar-format/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">mode</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">                 </span><span class="cm">/* 100 */</span>
</span><span id="__span-0-9"><a href="software/2023/05/23/tar-format/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">uid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">                  </span><span class="cm">/* 108 */</span>
</span><span id="__span-0-10"><a href="software/2023/05/23/tar-format/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">gid</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">                  </span><span class="cm">/* 116 */</span>
</span><span id="__span-0-11"><a href="software/2023/05/23/tar-format/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">size</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span><span class="w">                </span><span class="cm">/* 124 */</span>
</span><span id="__span-0-12"><a href="software/2023/05/23/tar-format/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">mtime</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span><span class="w">               </span><span class="cm">/* 136 */</span>
</span><span id="__span-0-13"><a href="software/2023/05/23/tar-format/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">chksum</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">               </span><span class="cm">/* 148 */</span>
</span><span id="__span-0-14"><a href="software/2023/05/23/tar-format/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">typeflag</span><span class="p">;</span><span class="w">                </span><span class="cm">/* 156 */</span>
</span><span id="__span-0-15"><a href="software/2023/05/23/tar-format/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">linkname</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span><span class="w">           </span><span class="cm">/* 157 */</span>
</span><span id="__span-0-16"><a href="software/2023/05/23/tar-format/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">magic</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w">                </span><span class="cm">/* 257 */</span>
</span><span id="__span-0-17"><a href="software/2023/05/23/tar-format/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">              </span><span class="cm">/* 263 */</span>
</span><span id="__span-0-18"><a href="software/2023/05/23/tar-format/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">uname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">               </span><span class="cm">/* 265 */</span>
</span><span id="__span-0-19"><a href="software/2023/05/23/tar-format/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">gname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">               </span><span class="cm">/* 297 */</span>
</span><span id="__span-0-20"><a href="software/2023/05/23/tar-format/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">devmajor</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">             </span><span class="cm">/* 329 */</span>
</span><span id="__span-0-21"><a href="software/2023/05/23/tar-format/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">devminor</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="w">             </span><span class="cm">/* 337 */</span>
</span><span id="__span-0-22"><a href="software/2023/05/23/tar-format/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">prefix</span><span class="p">[</span><span class="mi">155</span><span class="p">];</span><span class="w">             </span><span class="cm">/* 345 */</span>
</span><span id="__span-0-23"><a href="software/2023/05/23/tar-format/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">                                </span><span class="cm">/* 500 */</span>
</span><span id="__span-0-24"><a href="software/2023/05/23/tar-format/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="p">};</span>
</span></code></pre></div>
<p>来源：<a href="https://www.gnu.org/software/tar/manual/html_node/Standard.html">Basic Tar Format</a></p>
<p>可以看到，就是一系列的 char 数组，里面的很多数字字段，例如 mode，uid 和 gid 等，都是用 ASCII 码写的。由于头部需要对齐到 512 字节，所以实际上后面还有 12 字节的 padding。</p>
<p>头部的 512 字节结束后，紧接着就是文件的内容，内容的大小在头部的 size 字段已经保存，把字符串当成 8 进制数转换，就可以得到文件长度。文件也要对齐到 512 字节，所以文件后面还有若干个 0 作为 padding。</p>
<p>总结一下，Tar 文件的格式就是：<code>(头部，数据)*结尾</code>。每一个部分都对齐到 512 字节。</p>
<h3 id="pax"><a class="toclink" href="software/2023/05/23/tar-format/#pax">PAX 扩展</a></h3>
<p>如果仔细观察，会发现上面的 <code>posix_header</code> 里面，<code>name</code> 字段只有 100 个字节，意味着如果文件路径特别长，那就放不下，只能截断了。为了解决这个问题，Tar 引入了 PAX 扩展。</p>
<p>具体来说，PAX 扩展以特殊的文件形式存在。例如要记录一个名字很长的文件 <code>'X'*101</code>，实际上 Tar 中记录了两个文件：</p>
<ol>
<li>PaxHeader：特殊的 PAX 文件，不对应实际的文件</li>
<li><code>'X'*100</code>：文件名被截断，其他不变</li>
</ol>
<p>这个 PaxHeader 在解压的时候，不会生成实际的文件。它的内容是一些键值对，例如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="software/2023/05/23/tar-format/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>123 path=XXXXXXXXXXXXXXXXX...
</span></code></pre></div>
<p>格式是：<code>length key=value\n</code>，然后可以有多个这样的键值对。这样就可以解决 <code>posix_header</code> 里名字长度限制的问题：只要在 PaxHeader 文件里，保存一个 key 为 path，value 为实际名字的信息。那么 tar 在看到 PaxHeader 的时候，记录下来，再遇到下一个文件的时候，就知道要用 PaxHeader 中的 path，而不是保存在 <code>posix_header</code> 中的 <code>name[100]</code>。</p>
<p>类似地，PaxHeader 还可以存很多其他 <code>posix_header</code> 中没有的信息，例如 <code>atime</code>、<code>ctime</code> 和 <code>uid</code> 等等。完整列表可以参考 <a href="https://www.ibm.com/docs/en/zos/2.4.0?topic=descriptions-pax-interchange-portable-archives#r4paxsh__pxchk">Extended header keywords</a>。</p>
<h3 id="bard"><a class="toclink" href="software/2023/05/23/tar-format/#bard">Bard</a></h3>
<p>Bard 讲解 Tar 格式：</p>
<p>A tar file is an archive file format that is used to store a collection of files in a single file. The tar format is a standard format on Unix-like operating systems and is also supported by many other operating systems.</p>
<p>A tar file consists of a series of blocks, each of which contains 512 bytes of data. Each block contains a header and a body. The header contains information about the file, such as the file name, the file size, and the file permissions. The body contains the actual contents of the file.</p>
<p>The tar format is a simple and efficient format for storing files. It is also a portable format, which means that tar files can be moved from one computer to another without any problems.</p>
<p>Here is a more detailed description of the tar file format:</p>
<ul>
<li>The header of a tar file is 512 bytes long. It contains the following information:<ul>
<li>The name of the file</li>
<li>The size of the file</li>
<li>The permissions of the file</li>
<li>The modification time of the file</li>
<li>The owner of the file</li>
<li>The group of the file</li>
</ul>
</li>
<li>The body of a tar file contains the actual contents of the file. The body is padded to a multiple of 512 bytes.</li>
<li>Tar files can be compressed using a variety of compression algorithms, such as gzip, bzip2, and xz.</li>
</ul>
<p>Tar files are a versatile format that can be used for a variety of purposes. They are commonly used for backing up files, distributing software, and archiving files.</p>
<p>Here are some of the benefits of using tar files:</p>
<ul>
<li>Tar files are a standard format that is supported by many operating systems.</li>
<li>Tar files are a portable format, which means that they can be moved from one computer to another without any problems.</li>
<li>Tar files can be compressed using a variety of compression algorithms, which can significantly reduce the size of the archive.</li>
<li>Tar files can be easily created and managed using the tar command-line tool.</li>
</ul>
<p>If you need to store a collection of files in a single file, then a tar file is a good option to consider.</p>
<p>Bard 讲解 PAX 扩展：</p>
<p>The POSIX 1003.1-2001 (pax) format for tar archives supports file names longer than 256 characters by using a different format for storing file names and metadata than the traditional ustar format. In the pax format, file names are stored as null-terminated strings, which means that they can be any length up to the maximum file size supported by the underlying file system. The metadata for each file is also stored in a separate record, which allows for more flexibility in the types of metadata that can be stored.</p>
<p>To create a tar archive in the pax format, you can use the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a href="software/2023/05/23/tar-format/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>tar cf - --format=pax /path/to/files
</span></code></pre></div>
<p>To extract a tar archive in the pax format, you can use the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a href="software/2023/05/23/tar-format/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>tar xvf - --format=pax archive.tar
</span></code></pre></div>
<p>The pax format is a more flexible and powerful format than the ustar format, and it is recommended for use when creating or extracting tar archives that may contain file names longer than 256 characters.</p>
<p>Here are some additional details about the pax format:</p>
<ul>
<li>File names are stored as null-terminated strings, which means that they can be any length up to the maximum file size supported by the underlying file system.</li>
<li>The metadata for each file is stored in a separate record, which allows for more flexibility in the types of metadata that can be stored.</li>
<li>The pax format is supported by most modern tar implementations.</li>
</ul>
<p>Here are some examples of file names that can be stored in the pax format:</p>
<ul>
<li>"This is a file name with more than 256 characters."</li>
<li>"/path/to/a/file/with/a/long/name."</li>
<li>"file.with.spaces.in.its.name"</li>
</ul>
<p>The pax format is a good choice for storing file names that may be long, contain special characters, or be stored in a directory hierarchy with a long path.</p>
<nav class="md-post__action">
<a href="software/2023/05/23/tar-format/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-13 00:00:00">2023年5月13日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 8 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="docker-openldap"><a class="toclink" href="software/2023/05/13/openldap-in-docker/">使用 Docker 部署 OpenLDAP</a></h2>
<h3 id="docker-compose"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#docker-compose">Docker-Compose</a></h3>
<p>OpenLDAP 可以用现成的 Docker 镜像：<a href="https://hub.docker.com/r/bitnami/openldap/">bitnami/openldap</a>，配合 Docker-Compose 进行部署：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>version: '2'
</span><span id="__span-0-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>services:
</span><span id="__span-0-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>  openldap:
</span><span id="__span-0-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>    image: bitnami/openldap:2.6
</span><span id="__span-0-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>    ports:
</span><span id="__span-0-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>      - '1389:1389' # LDAP
</span><span id="__span-0-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>    environment:
</span><span id="__span-0-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>      - LDAP_ROOT=dc=example,dc=com # example.com
</span><span id="__span-0-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>    env_file: .env # admin password
</span><span id="__span-0-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>    volumes:
</span><span id="__span-0-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>      - './data:/bitnami/openldap' # data storage
</span></code></pre></div>
<p>admin 密码建议单独保存，例如写在 <code>.env</code> 中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nv">LDAP_ADMIN_PASSWORD</span><span class="o">=</span>12345678REDACTED
</span></code></pre></div>
<p>启动服务：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">## prepare data folder</span>
</span><span id="__span-2-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>sudo<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>data
</span><span id="__span-2-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>sudo<span class="w"> </span>mkdir<span class="w"> </span>data
</span><span id="__span-2-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1001</span>:root<span class="w"> </span>data
</span><span id="__span-2-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">## launch docker compose</span>
</span><span id="__span-2-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>sudo<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
</span></code></pre></div>
<p>然后就可以通过 ldapsearch 列出所有对象，默认情况下不需要登录（Bind DN），可以只读访问：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">## search elements under dc=example,dc=com</span>
</span><span id="__span-3-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">## -x: Simple authentication without user and password</span>
</span><span id="__span-3-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c1">## -b dc=example,dc=com: base dn for search</span>
</span><span id="__span-3-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="c1">## -H: ldap server</span>
</span><span id="__span-3-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>$<span class="w"> </span>ldapsearch<span class="w"> </span>-x<span class="w"> </span>-b<span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/
</span><span id="__span-3-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="c1">## user01, users, example.com</span>
</span><span id="__span-3-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>dn:<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user01,ou<span class="o">=</span>users,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-3-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>cn:<span class="w"> </span>User1
</span><span id="__span-3-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>cn:<span class="w"> </span>user01
</span><span id="__span-3-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>sn:<span class="w"> </span>Bar1
</span><span id="__span-3-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>objectClass:<span class="w"> </span>inetOrgPerson
</span><span id="__span-3-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>objectClass:<span class="w"> </span>posixAccount
</span><span id="__span-3-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>objectClass:<span class="w"> </span>shadowAccount
</span><span id="__span-3-14"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>userPassword::<span class="w"> </span><span class="nv">Yml0bmFtaTE</span><span class="o">=</span>
</span><span id="__span-3-15"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>uid:<span class="w"> </span>user01
</span><span id="__span-3-16"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>uidNumber:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-3-17"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>gidNumber:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-3-18"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>homeDirectory:<span class="w"> </span>/home/user01
</span><span id="__span-3-19"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>
</span><span id="__span-3-20"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="c1">## user02, users, example.com</span>
</span><span id="__span-3-21"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>dn:<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user02,ou<span class="o">=</span>users,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-3-22"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>cn:<span class="w"> </span>User2
</span><span id="__span-3-23"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>cn:<span class="w"> </span>user02
</span><span id="__span-3-24"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>sn:<span class="w"> </span>Bar2
</span><span id="__span-3-25"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>objectClass:<span class="w"> </span>inetOrgPerson
</span><span id="__span-3-26"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>objectClass:<span class="w"> </span>posixAccount
</span><span id="__span-3-27"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>objectClass:<span class="w"> </span>shadowAccount
</span><span id="__span-3-28"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>userPassword::<span class="w"> </span><span class="nv">Yml0bmFtaTI</span><span class="o">=</span>
</span><span id="__span-3-29"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>uid:<span class="w"> </span>user02
</span><span id="__span-3-30"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>uidNumber:<span class="w"> </span><span class="m">1001</span>
</span><span id="__span-3-31"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>gidNumber:<span class="w"> </span><span class="m">1001</span>
</span><span id="__span-3-32"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>homeDirectory:<span class="w"> </span>/home/user02
</span></code></pre></div>
<p>可以看到 Docker 镜像初始化了两个用户，仅供测试用，它用的密码比较弱。</p>
<h3 id="tls"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#tls">TLS</a></h3>
<p>接着，给 OpenLDAP 配置 TLS。首先用 OpenSSL 生成 CA 和证书：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">## https://arminreiter.com/2022/01/create-your-own-certificate-authority-ca-using-openssl/</span>
</span><span id="__span-4-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">## setup CA</span>
</span><span id="__span-4-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>rm<span class="w"> </span>-rf<span class="w"> </span>certs
</span><span id="__span-4-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>certs
</span><span id="__span-4-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>
</span><span id="__span-4-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>certs/ldap_ca.key<span class="w"> </span><span class="m">4096</span>
</span><span id="__span-4-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-new<span class="w"> </span>-nodes<span class="w"> </span>-key<span class="w"> </span>certs/ldap_ca.key<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">1826</span><span class="w"> </span>-out<span class="w"> </span>certs/ldap_ca.crt<span class="w"> </span>-subj<span class="w"> </span><span class="s2">"/CN=Example Com CA/ST=Somewhere/L=Earth/O=ExampleOrg"</span>
</span><span id="__span-4-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>
</span><span id="__span-4-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">## setup cert</span>
</span><span id="__span-4-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="c1">## CN must match hostname</span>
</span><span id="__span-4-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-nodes<span class="w"> </span>-out<span class="w"> </span>certs/ldap_server.csr<span class="w"> </span>-newkey<span class="w"> </span>rsa:4096<span class="w"> </span>-keyout<span class="w"> </span>certs/ldap_server.key<span class="w"> </span>-subj<span class="w"> </span><span class="s2">"/CN=</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2">/ST=Somewhere/L=Earth/O=ExampleOrg"</span>
</span><span id="__span-4-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>certs/ldap_server.csr<span class="w"> </span>-CA<span class="w"> </span>certs/ldap_ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>certs/ldap_ca.key<span class="w"> </span>-CAcreateserial<span class="w"> </span>-out<span class="w"> </span>certs/ldap_server.crt<span class="w"> </span>-days<span class="w"> </span><span class="m">730</span><span class="w"> </span>-sha256
</span><span id="__span-4-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
</span><span id="__span-4-14"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">1001</span>:root<span class="w"> </span>certs
</span></code></pre></div>
<p>然后修改 docker-compose.yml：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>version: '2'
</span><span id="__span-5-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>services:
</span><span id="__span-5-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>  openldap:
</span><span id="__span-5-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>    image: bitnami/openldap:2.6
</span><span id="__span-5-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>    ports:
</span><span id="__span-5-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>      - '1389:1389' # LDAP
</span><span id="__span-5-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>      - '1636:1636' # LDAPS
</span><span id="__span-5-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>    environment:
</span><span id="__span-5-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>      - LDAP_ROOT=dc=example,dc=com # example.com
</span><span id="__span-5-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>      - LDAP_ENABLE_TLS=yes
</span><span id="__span-5-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>      - LDAP_TLS_CERT_FILE=/opt/bitnami/openldap/certs/ldap_server.crt
</span><span id="__span-5-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>      - LDAP_TLS_KEY_FILE=/opt/bitnami/openldap/certs/ldap_server.key
</span><span id="__span-5-14"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>      - LDAP_TLS_CA_FILE=/opt/bitnami/openldap/certs/ldap_ca.crt
</span><span id="__span-5-15"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>    env_file: .env # admin password
</span><span id="__span-5-16"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>    volumes:
</span><span id="__span-5-17"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>      - './data:/bitnami/openldap' # data storage
</span><span id="__span-5-18"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>      - './certs:/opt/bitnami/openldap/certs'
</span></code></pre></div>
<p>再重新启动，就可以用 LDAPS 来访问 LDAP Server：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">## LDAP</span>
</span><span id="__span-6-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>$<span class="w"> </span>ldapsearch<span class="w"> </span>-x<span class="w"> </span>-b<span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/
</span><span id="__span-6-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">## LDAPS</span>
</span><span id="__span-6-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>$<span class="w"> </span><span class="nv">LDAPTLS_CACERT</span><span class="o">=</span><span class="nv">$PWD</span>/certs/ldap_ca.crt<span class="w"> </span>ldapsearch<span class="w"> </span>-x<span class="w"> </span>-b<span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldaps://localhost:1636/
</span></code></pre></div>
<h3 id="_1"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#_1">修改密码</a></h3>
<p>管理员修改用户的密码，使用 ldappasswd 修改：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">## Generate a new password for cn=user01,ou=users,dc=example,dc=com</span>
</span><span id="__span-7-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="c1">## -W: prompt for bind(login) password</span>
</span><span id="__span-7-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="c1">## -D cn=admin,dc=example,dc=com: bind(login) to admin user</span>
</span><span id="__span-7-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>$<span class="w"> </span>ldappasswd<span class="w"> </span>-x<span class="w"> </span>-W<span class="w"> </span>-D<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>admin,dc<span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user01,ou<span class="o">=</span>users,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-7-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>Enter<span class="w"> </span>LDAP<span class="w"> </span>Password:
</span><span id="__span-7-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>New<span class="w"> </span>password:<span class="w"> </span>REDACTED
</span><span id="__span-7-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>
</span><span id="__span-7-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="c1">## Set password for for cn=user01,ou=users,dc=example,dc=com</span>
</span><span id="__span-7-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="c1">## -S: prompt for new password</span>
</span><span id="__span-7-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>$<span class="w"> </span>ldappasswd<span class="w"> </span>-x<span class="w"> </span>-W<span class="w"> </span>-S<span class="w"> </span>-D<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>admin,dc<span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user01,ou<span class="o">=</span>users,dc<span class="o">=</span>example,dc<span class="o">=</span>com
</span><span id="__span-7-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>New<span class="w"> </span>password:
</span><span id="__span-7-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>Re-enter<span class="w"> </span>new<span class="w"> </span>password:
</span><span id="__span-7-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>Enter<span class="w"> </span>LDAP<span class="w"> </span>Password:
</span></code></pre></div>
<p>默认情况下，用户没有权限修改自己的密码。可以进入 Docker 容器，修改数据库的权限：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>openldap<span class="w"> </span>bash
</span><span id="__span-8-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="c1">## Authenticate using local user</span>
</span><span id="__span-8-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>openldap$<span class="w"> </span>ldapmodify<span class="w"> </span>-Y<span class="w"> </span>EXTERNAL<span class="w"> </span>-H<span class="w"> </span><span class="s2">"ldapi:///"</span>
</span><span id="__span-8-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>SASL/EXTERNAL<span class="w"> </span>authentication<span class="w"> </span>started
</span><span id="__span-8-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>SASL<span class="w"> </span>username:<span class="w"> </span><span class="nv">gidNumber</span><span class="o">=</span><span class="m">0</span>+uidNumber<span class="o">=</span><span class="m">1001</span>,cn<span class="o">=</span>peercred,cn<span class="o">=</span>external,cn<span class="o">=</span>auth
</span><span id="__span-8-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>SASL<span class="w"> </span>SSF:<span class="w"> </span><span class="m">0</span>
</span><span id="__span-8-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="c1">## Paste the following lines</span>
</span><span id="__span-8-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="c1">## Allow user to change its own password</span>
</span><span id="__span-8-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>dn:<span class="w"> </span><span class="nv">olcDatabase</span><span class="o">={</span><span class="m">2</span><span class="o">}</span>mdb,cn<span class="o">=</span>config
</span><span id="__span-8-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>changetype:<span class="w"> </span>modify
</span><span id="__span-8-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>replace:<span class="w"> </span>olcAccess
</span><span id="__span-8-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>olcAccess:<span class="w"> </span><span class="o">{</span><span class="m">0</span><span class="o">}</span>to<span class="w"> </span><span class="nv">attrs</span><span class="o">=</span>userPassword
</span><span id="__span-8-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">  </span>by<span class="w"> </span>anonymous<span class="w"> </span>auth
</span><span id="__span-8-14"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">  </span>by<span class="w"> </span>self<span class="w"> </span>write
</span><span id="__span-8-15"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">  </span>by<span class="w"> </span>*<span class="w"> </span>none
</span><span id="__span-8-16"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>olcAccess:<span class="w"> </span><span class="o">{</span><span class="m">1</span><span class="o">}</span>to<span class="w"> </span>*
</span><span id="__span-8-17"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">  </span>by<span class="w"> </span>*<span class="w"> </span><span class="nb">read</span>
</span></code></pre></div>
<p>此时用户就可以自己修改密码了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>ldappasswd<span class="w"> </span>-x<span class="w"> </span>-W<span class="w"> </span>-S<span class="w"> </span>-D<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user01,ou<span class="o">=</span>users,dc<span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/
</span><span id="__span-9-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>New<span class="w"> </span>password:
</span><span id="__span-9-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>Re-enter<span class="w"> </span>new<span class="w"> </span>password:
</span><span id="__span-9-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>Enter<span class="w"> </span>LDAP<span class="w"> </span>Password:
</span></code></pre></div>
<p>并且 userPassword 也对非 admin 用户被隐藏了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>ldapsearch<span class="w"> </span>-x<span class="w"> </span>-b<span class="w"> </span><span class="nv">dc</span><span class="o">=</span>example,dc<span class="o">=</span>com<span class="w"> </span>-H<span class="w"> </span>ldap://localhost:1389/
</span><span id="__span-10-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="c1">## user01, users, craft.cn</span>
</span><span id="__span-10-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>dn:<span class="w"> </span><span class="nv">cn</span><span class="o">=</span>user01,ou<span class="o">=</span>users,dc<span class="o">=</span>craft,dc<span class="o">=</span>cn
</span><span id="__span-10-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>cn:<span class="w"> </span>User1
</span><span id="__span-10-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>cn:<span class="w"> </span>user01
</span><span id="__span-10-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>sn:<span class="w"> </span>Bar1
</span><span id="__span-10-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>objectClass:<span class="w"> </span>inetOrgPerson
</span><span id="__span-10-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>objectClass:<span class="w"> </span>posixAccount
</span><span id="__span-10-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>objectClass:<span class="w"> </span>shadowAccount
</span><span id="__span-10-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>uid:<span class="w"> </span>user01
</span><span id="__span-10-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>uidNumber:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-10-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>gidNumber:<span class="w"> </span><span class="m">1000</span>
</span><span id="__span-10-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>homeDirectory:<span class="w"> </span>/home/user01
</span></code></pre></div>
<h3 id="ldap-ui"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#ldap-ui">ldap-ui</a></h3>
<p>如果想要 Web 管理界面，可以用 ldap-ui，在 docker-compose 添加：</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-11-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="w">  </span><span class="nt">ldap-ui</span><span class="p">:</span>
</span><span id="__span-11-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnknth/ldap-ui</span>
</span><span id="__span-11-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-11-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'5000:5000'</span>
</span><span id="__span-11-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nt">links</span><span class="p">:</span>
</span><span id="__span-11-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openldap</span>
</span><span id="__span-11-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-11-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LDAP_URL=ldap://openldap:1389/</span>
</span><span id="__span-11-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BASE_DN=dc=example,dc=com</span>
</span><span id="__span-11-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BIND_PATTERN=cn=%s,dc=example,dc=com</span>
</span></code></pre></div>
<p>访问 localhost:5000，就可以用 admin 用户登录了。如果想用其他用户登录，由于 BIND 路径多了一级 ou=users，所以要么修改 BIND_PATTERN，要么用户名要写成 user01,ou=users</p>
<h3 id="_2"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#_2">权限管理</a></h3>
<p>前面修改了权限，从而允许用户修改自己的密码：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>$<span class="w"> </span>sudo<span class="w"> </span>docker-compose<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>openldap<span class="w"> </span>bash
</span><span id="__span-12-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="c1">## Authenticate using local user</span>
</span><span id="__span-12-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>openldap$<span class="w"> </span>ldapmodify<span class="w"> </span>-Y<span class="w"> </span>EXTERNAL<span class="w"> </span>-H<span class="w"> </span><span class="s2">"ldapi:///"</span>
</span><span id="__span-12-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>SASL/EXTERNAL<span class="w"> </span>authentication<span class="w"> </span>started
</span><span id="__span-12-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a>SASL<span class="w"> </span>username:<span class="w"> </span><span class="nv">gidNumber</span><span class="o">=</span><span class="m">0</span>+uidNumber<span class="o">=</span><span class="m">1001</span>,cn<span class="o">=</span>peercred,cn<span class="o">=</span>external,cn<span class="o">=</span>auth
</span><span id="__span-12-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>SASL<span class="w"> </span>SSF:<span class="w"> </span><span class="m">0</span>
</span><span id="__span-12-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="c1">## Paste the following lines</span>
</span><span id="__span-12-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="c1">## Allow user to change its own password</span>
</span><span id="__span-12-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>dn:<span class="w"> </span><span class="nv">olcDatabase</span><span class="o">={</span><span class="m">2</span><span class="o">}</span>mdb,cn<span class="o">=</span>config
</span><span id="__span-12-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>changetype:<span class="w"> </span>modify
</span><span id="__span-12-11"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a>replace:<span class="w"> </span>olcAccess
</span><span id="__span-12-12"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>olcAccess:<span class="w"> </span><span class="o">{</span><span class="m">0</span><span class="o">}</span>to<span class="w"> </span><span class="nv">attrs</span><span class="o">=</span>userPassword
</span><span id="__span-12-13"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">  </span>by<span class="w"> </span>anonymous<span class="w"> </span>auth
</span><span id="__span-12-14"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">  </span>by<span class="w"> </span>self<span class="w"> </span>write
</span><span id="__span-12-15"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">  </span>by<span class="w"> </span>*<span class="w"> </span>none
</span><span id="__span-12-16"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a>olcAccess:<span class="w"> </span><span class="o">{</span><span class="m">1</span><span class="o">}</span>to<span class="w"> </span>*
</span><span id="__span-12-17"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">  </span>by<span class="w"> </span>*<span class="w"> </span><span class="nb">read</span>
</span></code></pre></div>
<p>核心部分的含义如下：</p>
<ol>
<li>to attrs=userPassword：针对 userPassword 这个字段，任何人都可以认证，用户自己可以写，其他人没有权限</li>
<li>to *：任何人可以读</li>
</ol>
<p>如果想要进一步收缩权限，例如：</p>
<ol>
<li>不登录看不到任何信息</li>
<li>普通用户登录后，只能读取自己的信息</li>
</ol>
<p>那么，可以写出如下的配置：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>dn: olcDatabase={2}mdb,cn=config
</span><span id="__span-13-2"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>changetype: modify
</span><span id="__span-13-3"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>replace: olcAccess
</span><span id="__span-13-4"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>olcAccess: {0}to attrs=userPassword
</span><span id="__span-13-5"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a>  by anonymous auth
</span><span id="__span-13-6"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>  by self write
</span><span id="__span-13-7"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a>  by * none
</span><span id="__span-13-8"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a>olcAccess: {1}to *
</span><span id="__span-13-9"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a>  by self read
</span><span id="__span-13-10"><a href="software/2023/05/13/openldap-in-docker/#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>  by * none
</span></code></pre></div>
<p>由于从前往后匹配，找到第一个匹配就不看后面的规则的原因，更精确的过滤要放在前面。</p>
<h3 id="ldap"><a class="toclink" href="software/2023/05/13/openldap-in-docker/#ldap">LDAP 用于其他软件的认证</a></h3>
<p>LDAP 很重要的一个用途是用于其他软件的认证，一般来说有两种用法：</p>
<ol>
<li>LDAP 自身带了认证的功能（Simple Auth），那么就需要把用户名（user01）映射到 LDAP 的 Bind DN 上（cn=user01,ou=users,cn=example,cn=com），Bind DN 和密码会传输到 LDAP Server；在 LDAP Server 上密码会与用户的 userPassword 进行匹配，如果 Bind 成功，就认为用户登录成功</li>
<li>LDAP 附带了列用户的功能（Search），那么这个时候，一般是要创建一个用于搜索的 DN 来控制权限；然后其他软件 Bind 到用于搜索的 DN 上，搜索用户，把用户信息同步到本地</li>
</ol>
<p>第一种使用方法要求用户和 DN 有直接映射关系，例如上面的 <code>cn=%s,ou=users,cn=example=com</code>，好处是比较简单，缺点是要把所有用户放在同一个 DN 下面，不适合比较复杂的组织结构。</p>
<p>第二种使用方法，则是其他软件先进行搜索（搜索本身可能需要 Bind 到用于搜索的 DN 上），找到匹配用户名或者邮箱的用户，再进行 Simple Auth。这样的好处是灵活性更好，用户不需要放在同一个 DN 下面，可以有更多层级。</p>
<p>由于使用了 Simple Auth，密码会明文发送给 LDAP Server，因此为了安全性，建议配置 TLS。</p>
<nav class="md-post__action">
<a href="software/2023/05/13/openldap-in-docker/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-08 00:00:00">2023年5月8日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/hardware/">hardware</a></li>
<li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="jlink-spi-nor-flash"><a class="toclink" href="hardware/2023/05/08/jlink-spi-nor-flash/">使用 JLink 操作 SPI NOR Flash</a></h2>
<h3 id="_1"><a class="toclink" href="hardware/2023/05/08/jlink-spi-nor-flash/#_1">背景</a></h3>
<p>最近设计了一款 <a href="https://github.com/jiegec/PMOD-SPI-NOR-FLASH">PMOD SPI NOR Flash</a> 扩展板，搭载了 W25Q128 SPI NOR Flash 芯片。在 jlc 生产回来以后，通过 JLink 连接到电脑上进行测试。</p>
<h3 id="jlink"><a class="toclink" href="hardware/2023/05/08/jlink-spi-nor-flash/#jlink">连接到 JLink</a></h3>
<p>JLink 提供了 20 pin 的引脚，如果要连接 SPI，那么引脚定义如下：</p>
<p><img alt="" src="https://c.a.segger.com/fileadmin/images/products/J-Link/Software/pinout-spi-20-pin.gif.webp"/></p>
<p>图源 <a href="https://www.segger.com/products/debug-probes/j-link/tools/j-flash-spi/">JFlash SPI 文档</a>。</p>
<p>连接的时候，至少需要连接以下的引脚：</p>
<ol>
<li>JLink GND(pin 4/6/8/10) - SPI NOR Flash GND</li>
<li>JLink VTref(pin 1) - 3.3V - SPI NOR Flash VCC</li>
<li>JLink CLK(pin 9) - SPI NOR Flash CLK</li>
<li>JLink DI(pin 5) - SPI NOR Flash D0/DI/MOSI</li>
<li>JLink DO(pin 13) - SPI NOR Flash D1/DO/MISO</li>
<li>JLink nCS(pin 7) - SPI NOR Flash CS#</li>
</ol>
<p>由于 SPI NOR Flash 无法接受 5V 的电压，所以要用额外的 3.3V 作为电源，同时接到 JLink 的 VTref 引脚上。</p>
<p>JFlash SPI 还支持 Quad SPI 模式，可以在它的文档里找到连接方式。</p>
<h3 id="jflash-spi"><a class="toclink" href="hardware/2023/05/08/jlink-spi-nor-flash/#jflash-spi">JFlash SPI</a></h3>
<p>连接了以后，就可以在 JFlash SPI 软件中识别出 SPI Flash 了：Flash ID 0xEF 40 18。有意思的是，JFlash SPI 软件会认为这个芯片是 Infineon 的 S25FL128K，而不是 Winbond 的 W25Q128。发邮件问了一下 SEGGER，得到的回复是这两个芯片的 Flash ID 都是 0xEF4018，所以无法区分。</p>
<h3 id="flashrom"><a class="toclink" href="hardware/2023/05/08/jlink-spi-nor-flash/#flashrom">flashrom</a></h3>
<p>如果想用开源软件，可以用 flashrom，编译的时候打开 jlink 支持，就可以用 flashrom 来通过 JLink 读写 SPI NOR Flash。</p>
<p>但是 flashrom 的 cs 信号并不是上面的 nCS(pin 7)，而是 nRESET(pin 15，默认) 或者 nTRST(pin 3，可以添加参数 <code>cs=trst</code>)。这就导致如果想用 flashrom 的话，就要修改引脚连接方式，把 pin 15 连接到 SPI NOR Flash 的 CS# 上。修改连接以后，就可以检测到芯片了：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>$<span class="w"> </span>flashrom<span class="w"> </span>--programmer<span class="w"> </span>jlink_spi
</span><span id="__span-0-2"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>flashrom<span class="w"> </span>v1.3.0<span class="w"> </span>on<span class="w"> </span>Darwin<span class="w"> </span><span class="m">22</span>.4.0<span class="w"> </span><span class="o">(</span>arm64<span class="o">)</span>
</span><span id="__span-0-3"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>flashrom<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software,<span class="w"> </span>get<span class="w"> </span>the<span class="w"> </span><span class="nb">source</span><span class="w"> </span>code<span class="w"> </span>at<span class="w"> </span>https://flashrom.org
</span><span id="__span-0-4"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>Calibrating<span class="w"> </span>delay<span class="w"> </span>loop...<span class="w"> </span>OK.
</span><span id="__span-0-6"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>Found<span class="w"> </span>Winbond<span class="w"> </span>flash<span class="w"> </span>chip<span class="w"> </span><span class="s2">"W25Q128.V"</span><span class="w"> </span><span class="o">(</span><span class="m">16384</span><span class="w"> </span>kB,<span class="w"> </span>SPI<span class="o">)</span><span class="w"> </span>on<span class="w"> </span>jlink_spi.
</span><span id="__span-0-7"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="o">===</span>
</span><span id="__span-0-8"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>This<span class="w"> </span>flash<span class="w"> </span>part<span class="w"> </span>has<span class="w"> </span>status<span class="w"> </span>UNTESTED<span class="w"> </span><span class="k">for</span><span class="w"> </span>operations:<span class="w"> </span>WP
</span><span id="__span-0-9"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>The<span class="w"> </span><span class="nb">test</span><span class="w"> </span>status<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>chip<span class="w"> </span>may<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>updated<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>latest<span class="w"> </span>development
</span><span id="__span-0-10"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>version<span class="w"> </span>of<span class="w"> </span>flashrom.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>running<span class="w"> </span>the<span class="w"> </span>latest<span class="w"> </span>development<span class="w"> </span>version,
</span><span id="__span-0-11"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>please<span class="w"> </span>email<span class="w"> </span>a<span class="w"> </span>report<span class="w"> </span>to<span class="w"> </span>flashrom@flashrom.org<span class="w"> </span><span class="k">if</span><span class="w"> </span>any<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>above<span class="w"> </span>operations
</span><span id="__span-0-12"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>work<span class="w"> </span>correctly<span class="w"> </span><span class="k">for</span><span class="w"> </span>you<span class="w"> </span>with<span class="w"> </span>this<span class="w"> </span>flash<span class="w"> </span>chip.<span class="w"> </span>Please<span class="w"> </span>include<span class="w"> </span>the<span class="w"> </span>flashrom<span class="w"> </span>log
</span><span id="__span-0-13"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>file<span class="w"> </span><span class="k">for</span><span class="w"> </span>all<span class="w"> </span>operations<span class="w"> </span>you<span class="w"> </span>tested<span class="w"> </span><span class="o">(</span>see<span class="w"> </span>the<span class="w"> </span>man<span class="w"> </span>page<span class="w"> </span><span class="k">for</span><span class="w"> </span>details<span class="o">)</span>,<span class="w"> </span>and<span class="w"> </span>mention
</span><span id="__span-0-14"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>which<span class="w"> </span>mainboard<span class="w"> </span>or<span class="w"> </span>programmer<span class="w"> </span>you<span class="w"> </span>tested<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>subject<span class="w"> </span>line.
</span><span id="__span-0-15"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>Thanks<span class="w"> </span><span class="k">for</span><span class="w"> </span>your<span class="w"> </span>help!
</span><span id="__span-0-16"><a href="hardware/2023/05/08/jlink-spi-nor-flash/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>No<span class="w"> </span>operations<span class="w"> </span>were<span class="w"> </span>specified.
</span></code></pre></div>
<p>为了解决这个问题，我给 <a href="https://review.coreboot.org/c/flashrom/+/75011">flashrom</a> 提交了 patch，如果合并了，就可以支持 <code>--programmer jlink_spi:cs=tms</code> 选项，此时就不需要修改连接方式了。</p>
<nav class="md-post__action">
<a href="hardware/2023/05/08/jlink-spi-nor-flash/">
        继续阅读
      </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2023-05-06 00:00:00">2023年5月6日</time></li>
<li class="md-meta__item">
            分类于
            
              <a class="md-meta__link" href="category/software/">software</a></li>
<li class="md-meta__item">
            
              需要 28 分钟阅读时间
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="_1"><a class="toclink" href="software/2023/05/06/linker/">链接器的工作原理</a></h2>
<h3 id="_2"><a class="toclink" href="software/2023/05/06/linker/#_2">背景</a></h3>
<p>最近和同学讨论一些比较复杂的链接问题，遇到一些比较复杂的情况，因此复习一遍链接器的工作原理。</p>
<h3 id="_3"><a class="toclink" href="software/2023/05/06/linker/#_3">编译</a></h3>
<p>编译器会把源文件编译成 obj，obj 里面有符号表，定义了不同的符号类型。常见的代码与符号的对应关系：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a href="software/2023/05/06/linker/#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// global in .bss section if -fno-common</span>
</span><span id="__span-0-2"><a href="software/2023/05/06/linker/#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="c1">// common symbol if -fcommon</span>
</span><span id="__span-0-3"><a href="software/2023/05/06/linker/#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">uninitialized</span><span class="p">;</span>
</span><span id="__span-0-4"><a href="software/2023/05/06/linker/#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1">// global in .bss section</span>
</span><span id="__span-0-5"><a href="software/2023/05/06/linker/#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-6"><a href="software/2023/05/06/linker/#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="c1">// global in .data section</span>
</span><span id="__span-0-7"><a href="software/2023/05/06/linker/#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kt">int</span><span class="w"> </span><span class="n">initialized_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-8"><a href="software/2023/05/06/linker/#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1">// global in .rodata section</span>
</span><span id="__span-0-9"><a href="software/2023/05/06/linker/#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">const_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-10"><a href="software/2023/05/06/linker/#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="c1">// global in .rodata section</span>
</span><span id="__span-0-11"><a href="software/2023/05/06/linker/#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">const_initialized_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-12"><a href="software/2023/05/06/linker/#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c1">// global undefined symbol</span>
</span><span id="__span-0-13"><a href="software/2023/05/06/linker/#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">external</span><span class="p">;</span>
</span><span id="__span-0-14"><a href="software/2023/05/06/linker/#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="c1">// local in .bss section</span>
</span><span id="__span-0-15"><a href="software/2023/05/06/linker/#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_uninitialized</span><span class="p">;</span>
</span><span id="__span-0-16"><a href="software/2023/05/06/linker/#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="c1">// local in .bss section</span>
</span><span id="__span-0-17"><a href="software/2023/05/06/linker/#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-18"><a href="software/2023/05/06/linker/#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="c1">// local in .data section</span>
</span><span id="__span-0-19"><a href="software/2023/05/06/linker/#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_initialized_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-20"><a href="software/2023/05/06/linker/#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="c1">// local in .rodata section</span>
</span><span id="__span-0-21"><a href="software/2023/05/06/linker/#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">const_static_initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-22"><a href="software/2023/05/06/linker/#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="c1">// local in .rodata section</span>
</span><span id="__span-0-23"><a href="software/2023/05/06/linker/#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">const</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">const_static_initialized_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-0-24"><a href="software/2023/05/06/linker/#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="c1">// global in .text section</span>
</span><span id="__span-0-25"><a href="software/2023/05/06/linker/#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="kt">int</span><span class="w"> </span><span class="nf">simple_function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-26"><a href="software/2023/05/06/linker/#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">  </span><span class="c1">// local in .bss section</span>
</span><span id="__span-0-27"><a href="software/2023/05/06/linker/#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_in_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-28"><a href="software/2023/05/06/linker/#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">}</span>
</span><span id="__span-0-29"><a href="software/2023/05/06/linker/#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="c1">// global in .text section</span>
</span><span id="__span-0-30"><a href="software/2023/05/06/linker/#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="kt">void</span><span class="w"> </span><span class="nf">access_external</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-31"><a href="software/2023/05/06/linker/#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="c1">// global undefined symbol</span>
</span><span id="__span-0-32"><a href="software/2023/05/06/linker/#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="k">extern</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">external_function</span><span class="p">();</span>
</span><span id="__span-0-33"><a href="software/2023/05/06/linker/#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="c1">// global in .text section</span>
</span><span id="__span-0-34"><a href="software/2023/05/06/linker/#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="kt">long</span><span class="w"> </span><span class="nf">call_external</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">external_function</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-0-35"><a href="software/2023/05/06/linker/#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="c1">// local in .text section</span>
</span><span id="__span-0-36"><a href="software/2023/05/06/linker/#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">static_function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-0-37"><a href="software/2023/05/06/linker/#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="c1">// weak in .text section</span>
</span><span id="__span-0-38"><a href="software/2023/05/06/linker/#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">weak</span><span class="p">))</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">weak_function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-0-39"><a href="software/2023/05/06/linker/#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="c1">// global in .text section marked .hidden</span>
</span><span id="__span-0-40"><a href="software/2023/05/06/linker/#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">visibility</span><span class="w"> </span><span class="p">(</span><span class="s">"hidden"</span><span class="p">)))</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">hidden_function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</span></code></pre></div>
<p>使用 <code>readelf -s</code> 查看符号表：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a href="software/2023/05/06/linker/#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span><span id="__span-1-2"><a href="software/2023/05/06/linker/#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>     6: 0000000000000008     4 OBJECT  LOCAL  DEFAULT    4 static_uninitialized
</span><span id="__span-1-3"><a href="software/2023/05/06/linker/#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>     7: 000000000000000c     4 OBJECT  LOCAL  DEFAULT    4 static_initialized
</span><span id="__span-1-4"><a href="software/2023/05/06/linker/#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>     8: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    3 static_initializ[...]
</span><span id="__span-1-5"><a href="software/2023/05/06/linker/#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>     9: 0000000000000008     4 OBJECT  LOCAL  DEFAULT    5 const_static_ini[...]
</span><span id="__span-1-6"><a href="software/2023/05/06/linker/#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>    10: 000000000000000c     4 OBJECT  LOCAL  DEFAULT    5 const_static_ini[...]
</span><span id="__span-1-7"><a href="software/2023/05/06/linker/#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>    11: 0000000000000029     7 FUNC    LOCAL  DEFAULT    1 static_function
</span><span id="__span-1-8"><a href="software/2023/05/06/linker/#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>    12: 0000000000000010     4 OBJECT  LOCAL  DEFAULT    4 static_in_function.0
</span><span id="__span-1-9"><a href="software/2023/05/06/linker/#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>    16: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    4 uninitialized
</span><span id="__span-1-10"><a href="software/2023/05/06/linker/#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>    17: 0000000000000004     4 OBJECT  GLOBAL DEFAULT    4 initialized
</span><span id="__span-1-11"><a href="software/2023/05/06/linker/#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>    18: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    3 initialized_one
</span><span id="__span-1-12"><a href="software/2023/05/06/linker/#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>    19: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    5 const_initialized
</span><span id="__span-1-13"><a href="software/2023/05/06/linker/#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>    20: 0000000000000004     4 OBJECT  GLOBAL DEFAULT    5 const_initialized_one
</span><span id="__span-1-14"><a href="software/2023/05/06/linker/#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>    21: 0000000000000000     7 FUNC    GLOBAL DEFAULT    1 simple_function
</span><span id="__span-1-15"><a href="software/2023/05/06/linker/#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>    22: 0000000000000007    17 FUNC    GLOBAL DEFAULT    1 access_external
</span><span id="__span-1-16"><a href="software/2023/05/06/linker/#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>    23: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND external
</span><span id="__span-1-17"><a href="software/2023/05/06/linker/#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>    24: 0000000000000018    17 FUNC    GLOBAL DEFAULT    1 call_external
</span><span id="__span-1-18"><a href="software/2023/05/06/linker/#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>    25: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_
</span><span id="__span-1-19"><a href="software/2023/05/06/linker/#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>    26: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND external_function
</span><span id="__span-1-20"><a href="software/2023/05/06/linker/#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>    27: 0000000000000030    11 FUNC    WEAK   DEFAULT    1 weak_function
</span><span id="__span-1-21"><a href="software/2023/05/06/linker/#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>    28: 000000000000003b     7 FUNC    GLOBAL HIDDEN     1 hidden_function
</span></code></pre></div>
<p>总结一下，每个符号有如下属性：</p>
<ol>
<li>Bind：Local（static）、Global（extern 或者非 static）、Weak（标记 <code>__attribute__ ((weak))</code>）</li>
<li>Vis(Visibility): Default、Hidden（标记 <code>__attribute__ ((visibility ("hidden")))</code>）</li>
<li>Ndx：<ol>
<li>COMMON：如果打开了 -fcommon，那么没有初始化的全局变量（上面的 <code>uninitialized</code>）会生成 COMMON 符号；如果打开了 -fno-common，则不会有 COMMON 符号</li>
<li>UNDEFINED：extern 符号</li>
</ol>
</li>
<li>Section:<ol>
<li>const 变量放在 .rodata section</li>
<li>非 const 变量，如果没有初始化，如果开了 -fcommon，则生成 COMMON 符号；如果开了 -fno-common，则放在 .bss section</li>
<li>非 const 变量，如果初始化了，放在 .data section</li>
<li>函数放在 .text section</li>
</ol>
</li>
</ol>
<p>关于 COMMON 符号的详细内容，建议阅读 <a href="https://maskray.me/blog/2022-02-06-all-about-common-symbols">All about COMMON symbols - MaskRay</a> 和 <a href="/software/2022/07/11/archive-common-linking/">COMMON 符号</a>。</p>
<h3 id="_4"><a class="toclink" href="software/2023/05/06/linker/#_4">链接</a></h3>
<p>链接要做的是把多个 obj 合并成一个可执行文件或者动态库，主要目的是将一个 obj 中定义的符号与另一个 obj 中 undefined 的符号对应起来。</p>
<p>链接器运行时，传入若干个 obj 文件，然后按照下面的流程进行：</p>
<ol>
<li>维护一个全局的符号表</li>
<li>循环每个 obj 文件，循环其中的符号，找到其中的 GLOBAL/WEAK 符号</li>
<li>把 GLOBAL/WEAK 符号插入到符号表中，处理各种情况，例如：<ol>
<li>如果出现两个 defined 符号冲突，报告 multiple definition 错误</li>
<li>如果出现重名的 weak 符号和 strong 符号，选择保留 strong 的符号</li>
</ol>
</li>
<li>如果存在没有找到匹配的 defined 符号的 undefined 符号，报告 undefined reference 错误</li>
</ol>
<p>符号表是在解析 obj 文件的同时动态更新的，因此，如果 A 使用了 B 的符号，那么应该把 A 放在前面，这样链接器解析 A 的时候会在符号表中创建 undefined 符号，然后 B 在后面，当链接器解析 B 的时候，就可以把 B 的 defined 符号与 A 的 undefined 符号进行匹配。</p>
<h3 id="_5"><a class="toclink" href="software/2023/05/06/linker/#_5">静态库</a></h3>
<p>静态库将多个 .o 合并为一个 .a，并且创建了索引。具体来说，创建一个静态库的时候：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a href="software/2023/05/06/linker/#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>$<span class="w"> </span>ar<span class="w"> </span>rcs<span class="w"> </span>libxxx.a<span class="w"> </span>obj1.o<span class="w"> </span>obj2.o<span class="w"> </span>obj3.o<span class="w"> </span>...
</span></code></pre></div>
<p>生成的 .a 会包括所有的 .o，然后创建索引（<code>ar rcs</code> 中的 <code>s</code>，会运行 <code>ranlib</code> 命令），索引的内容是一个符号到 .o 文件的映射：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a href="software/2023/05/06/linker/#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>$<span class="w"> </span>nm<span class="w"> </span>-s<span class="w"> </span>/lib/x86_64-linux-gnu/libc.a
</span><span id="__span-3-2"><a href="software/2023/05/06/linker/#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>Archive<span class="w"> </span>index:
</span><span id="__span-3-3"><a href="software/2023/05/06/linker/#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>__printf<span class="w"> </span><span class="k">in</span><span class="w"> </span>printf.o
</span><span id="__span-3-4"><a href="software/2023/05/06/linker/#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>_IO_printf<span class="w"> </span><span class="k">in</span><span class="w"> </span>printf.o
</span><span id="__span-3-5"><a href="software/2023/05/06/linker/#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="nb">printf</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>printf.o
</span><span id="__span-3-6"><a href="software/2023/05/06/linker/#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>__scanf<span class="w"> </span><span class="k">in</span><span class="w"> </span>scanf.o
</span><span id="__span-3-7"><a href="software/2023/05/06/linker/#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>scanf<span class="w"> </span><span class="k">in</span><span class="w"> </span>scanf.o
</span></code></pre></div>
<p>因此，链接器在遇到参数是 .a 的静态库的时候，不会查看里面的每个 .o 文件，而是从 Archive index 入手，如果当前的符号表依赖了 Archive index 中的符号，那就加载相应的 .o 文件。</p>
<h3 id="_6"><a class="toclink" href="software/2023/05/06/linker/#_6">动态库</a></h3>
<p>生成动态库的方法是，编译的时候添加 <code>-fPIC</code> 选项，链接的时候添加 <code>-shared</code> 编译参数：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a href="software/2023/05/06/linker/#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-c<span class="w"> </span>source1.c<span class="w"> </span>-o<span class="w"> </span>source1.o
</span><span id="__span-4-2"><a href="software/2023/05/06/linker/#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>gcc<span class="w"> </span>-shared<span class="w"> </span>source1.o<span class="w"> </span>-o<span class="w"> </span>libtest.so.0.0.0
</span><span id="__span-4-3"><a href="software/2023/05/06/linker/#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">## oneliner:</span>
</span><span id="__span-4-4"><a href="software/2023/05/06/linker/#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>source1.c<span class="w"> </span>-o<span class="w"> </span>libtest.so.0.0.0
</span></code></pre></div>
<p>此时代码中定义的函数会出现在 Dynamic Symbol Table 中，可以用 <code>objdump -T</code> 命令查看：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a href="software/2023/05/06/linker/#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>$<span class="w"> </span>cat<span class="w"> </span>source1.c
</span><span id="__span-5-2"><a href="software/2023/05/06/linker/#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>int<span class="w"> </span>simple_function<span class="o">()</span><span class="w"> </span><span class="o">{}</span>
</span><span id="__span-5-3"><a href="software/2023/05/06/linker/#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>$<span class="w"> </span>objdump<span class="w"> </span>-T<span class="w"> </span>libtest.so.0.0.0
</span><span id="__span-5-4"><a href="software/2023/05/06/linker/#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>
</span><span id="__span-5-5"><a href="software/2023/05/06/linker/#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>libtest.so.0.0.0:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64
</span><span id="__span-5-6"><a href="software/2023/05/06/linker/#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a href="software/2023/05/06/linker/#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>DYNAMIC<span class="w"> </span>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-5-8"><a href="software/2023/05/06/linker/#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span>__cxa_finalize
</span><span id="__span-5-9"><a href="software/2023/05/06/linker/#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span>_ITM_registerTMCloneTable
</span><span id="__span-5-10"><a href="software/2023/05/06/linker/#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span>_ITM_deregisterTMCloneTable
</span><span id="__span-5-11"><a href="software/2023/05/06/linker/#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span>__gmon_start__
</span><span id="__span-5-12"><a href="software/2023/05/06/linker/#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>00000000000010f9<span class="w"> </span>g<span class="w">    </span>DF<span class="w"> </span>.text<span class="w">  </span><span class="m">0000000000000007</span><span class="w"> </span>simple_function
</span></code></pre></div>
<p>如果代码中用了 libc 的一些函数，那么这些函数则会以 undefined symbol 的形式出现在 Dynamic Symbol Table 中：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a href="software/2023/05/06/linker/#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>$<span class="w"> </span>cat<span class="w"> </span>source1.c
</span><span id="__span-6-2"><a href="software/2023/05/06/linker/#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="c1">##include &lt;stdio.h&gt;</span>
</span><span id="__span-6-3"><a href="software/2023/05/06/linker/#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>int<span class="w"> </span>simple_function<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-6-4"><a href="software/2023/05/06/linker/#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span>printf<span class="o">(</span><span class="s2">"Simple function"</span><span class="o">)</span><span class="p">;</span>
</span><span id="__span-6-5"><a href="software/2023/05/06/linker/#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
</span><span id="__span-6-6"><a href="software/2023/05/06/linker/#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="o">}</span>
</span><span id="__span-6-7"><a href="software/2023/05/06/linker/#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>$<span class="w"> </span>objdump<span class="w"> </span>-T<span class="w"> </span>libtest.so.0.0.0
</span><span id="__span-6-8"><a href="software/2023/05/06/linker/#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>
</span><span id="__span-6-9"><a href="software/2023/05/06/linker/#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>libtest.so.0.0.0:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64
</span><span id="__span-6-10"><a href="software/2023/05/06/linker/#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>
</span><span id="__span-6-11"><a href="software/2023/05/06/linker/#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>DYNAMIC<span class="w"> </span>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-6-12"><a href="software/2023/05/06/linker/#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>Base<span class="w">        </span>_ITM_deregisterTMCloneTable
</span><span id="__span-6-13"><a href="software/2023/05/06/linker/#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="m">0000000000000000</span><span class="w">      </span>DF<span class="w"> </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span><span class="o">(</span>GLIBC_2.2.5<span class="o">)</span><span class="w"> </span><span class="nb">printf</span>
</span><span id="__span-6-14"><a href="software/2023/05/06/linker/#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>Base<span class="w">        </span>__gmon_start__
</span><span id="__span-6-15"><a href="software/2023/05/06/linker/#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>D<span class="w">  </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>Base<span class="w">        </span>_ITM_registerTMCloneTable
</span><span id="__span-6-16"><a href="software/2023/05/06/linker/#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="m">0000000000000000</span><span class="w">  </span>w<span class="w">   </span>DF<span class="w"> </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w"> </span><span class="o">(</span>GLIBC_2.2.5<span class="o">)</span><span class="w"> </span>__cxa_finalize
</span><span id="__span-6-17"><a href="software/2023/05/06/linker/#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="m">0000000000001109</span><span class="w"> </span>g<span class="w">    </span>DF<span class="w"> </span>.text<span class="w">  </span>000000000000001b<span class="w">  </span>Base<span class="w">        </span>simple_function
</span></code></pre></div>
<h4 id="_7"><a class="toclink" href="software/2023/05/06/linker/#_7">符号版本</a></h4>
<p>中间出现的 Base 或者 GLIBC_2.2.5 是符号的版本号，这样做的目的是为了兼容性：假如某天 glibc 想要给一个函数添加一个新的参数，但是现有的程序编译的时候动态链接了旧版本的 glibc，新旧两个版本的函数名字一样，但是功能却不一样，如果直接让旧程序用新 glibc 的函数，就会出现问题。即使参数不变，如果函数的语义变了，也可能带来不兼容的问题。</p>
<p>解决办法是给符号添加版本号，这样旧版本的程序会继续找到旧版本的符号，解决了兼容性的问题。例如 memcpy 在 glibc 中就有两个版本：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a href="software/2023/05/06/linker/#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-T<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>memcpy
</span><span id="__span-7-2"><a href="software/2023/05/06/linker/#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>00000000000a2b70<span class="w"> </span>g<span class="w">    </span>DF<span class="w"> </span>.text<span class="w">  </span><span class="m">0000000000000028</span><span class="w"> </span><span class="o">(</span>GLIBC_2.2.5<span class="o">)</span><span class="w"> </span>memcpy
</span><span id="__span-7-3"><a href="software/2023/05/06/linker/#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>000000000009bc50<span class="w"> </span>g<span class="w">   </span>iD<span class="w">  </span>.text<span class="w">  </span><span class="m">0000000000000109</span><span class="w">  </span>GLIBC_2.14<span class="w">  </span>memcpy
</span></code></pre></div>
<p>在 <a href="https://github.com/bminor/glibc/blob/a363f7075125fa654342c69331e6c075518ec28c/sysdeps/x86_64/multiarch/memcpy.c#LL38C11-L38C11">glibc 代码</a>中，通过 <code>versioned_symbol</code> 宏来实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a href="software/2023/05/06/linker/#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">versioned_symbol</span><span class="w"> </span><span class="p">(</span><span class="n">libc</span><span class="p">,</span><span class="w"> </span><span class="n">__new_memcpy</span><span class="p">,</span><span class="w"> </span><span class="n">memcpy</span><span class="p">,</span><span class="w"> </span><span class="n">GLIBC_2_14</span><span class="p">);</span>
</span></code></pre></div>
<p>更多关于符号版本的内容，可以阅读 <a href="https://maskray.me/blog/2020-11-26-all-about-symbol-versioning">All about symbol versioning</a>。</p>
<h4 id="_8"><a class="toclink" href="software/2023/05/06/linker/#_8">动态链接</a></h4>
<p>编译好动态链接库以后，可以在链接的时候，作为参数引入：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a href="software/2023/05/06/linker/#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>$<span class="w"> </span>cat<span class="w"> </span>main.c
</span><span id="__span-9-2"><a href="software/2023/05/06/linker/#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>extern<span class="w"> </span>void<span class="w"> </span>simple_function<span class="o">()</span><span class="p">;</span>
</span><span id="__span-9-3"><a href="software/2023/05/06/linker/#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>int<span class="w"> </span>main<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>simple_function<span class="o">()</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
</span><span id="__span-9-4"><a href="software/2023/05/06/linker/#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-9-5"><a href="software/2023/05/06/linker/#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>$<span class="w"> </span><span class="nv">LD_LIRBARY_PATH</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>./main
</span><span id="__span-9-6"><a href="software/2023/05/06/linker/#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>Simple<span class="w"> </span><span class="k">function</span>
</span></code></pre></div>
<p>可以观察一下发生了什么事情：首先，链接的时候，会找到 <code>libtest.so.0.0.0</code> 导出的符号表，发现它定义了 <code>main.c</code> 缺少的 <code>simple_function</code> 函数，因此链接不会出错。但是，函数本身没有被链接到 <code>main</code> 里面，需要在运行时去加载动态库，这样 <code>main</code> 才可以调用函数：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a href="software/2023/05/06/linker/#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>main
</span><span id="__span-10-2"><a href="software/2023/05/06/linker/#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="m">0000000000000000</span><span class="w">       </span>F<span class="w"> </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w">              </span>simple_function
</span><span id="__span-10-3"><a href="software/2023/05/06/linker/#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>$<span class="w"> </span>objdump<span class="w"> </span>-T<span class="w"> </span>main
</span><span id="__span-10-4"><a href="software/2023/05/06/linker/#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="m">0000000000000000</span><span class="w">      </span>DF<span class="w"> </span>*UND*<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>Base<span class="w">        </span>simple_function
</span><span id="__span-10-5"><a href="software/2023/05/06/linker/#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>./main
</span><span id="__span-10-6"><a href="software/2023/05/06/linker/#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>Dynamic<span class="w"> </span>section<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span>0x2dd0<span class="w"> </span>contains<span class="w"> </span><span class="m">27</span><span class="w"> </span>entries:
</span><span id="__span-10-7"><a href="software/2023/05/06/linker/#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-10-8"><a href="software/2023/05/06/linker/#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libtest.so.0.0.0<span class="o">]</span>
</span><span id="__span-10-9"><a href="software/2023/05/06/linker/#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span id="__span-10-10"><a href="software/2023/05/06/linker/#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>$<span class="w"> </span>./main
</span><span id="__span-10-11"><a href="software/2023/05/06/linker/#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>./main:<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>loading<span class="w"> </span>shared<span class="w"> </span>libraries:<span class="w"> </span>libtest.so.0.0.0:<span class="w"> </span>cannot<span class="w"> </span>open<span class="w"> </span>shared<span class="w"> </span>object<span class="w"> </span>file:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</span><span id="__span-10-12"><a href="software/2023/05/06/linker/#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>$<span class="w"> </span>ldd<span class="w"> </span>./main
</span><span id="__span-10-13"><a href="software/2023/05/06/linker/#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">        </span>linux-vdso.so.1<span class="w"> </span><span class="o">(</span>0x00007ffe07dbc000<span class="o">)</span>
</span><span id="__span-10-14"><a href="software/2023/05/06/linker/#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">        </span>libtest.so.0.0.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>not<span class="w"> </span>found
</span><span id="__span-10-15"><a href="software/2023/05/06/linker/#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">        </span>libc.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="o">(</span>0x00007f83ee3fb000<span class="o">)</span>
</span><span id="__span-10-16"><a href="software/2023/05/06/linker/#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">        </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>0x00007f83ee602000<span class="o">)</span>
</span><span id="__span-10-17"><a href="software/2023/05/06/linker/#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>$<span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>ldd<span class="w"> </span>./main
</span><span id="__span-10-18"><a href="software/2023/05/06/linker/#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">        </span>linux-vdso.so.1<span class="w"> </span><span class="o">(</span>0x00007fffb0bd5000<span class="o">)</span>
</span><span id="__span-10-19"><a href="software/2023/05/06/linker/#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">        </span>libtest.so.0.0.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/tmp/libtest.so.0.0.0<span class="w"> </span><span class="o">(</span>0x00007f985b3db000<span class="o">)</span>
</span><span id="__span-10-20"><a href="software/2023/05/06/linker/#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">        </span>libc.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="o">(</span>0x00007f985b1db000<span class="o">)</span>
</span><span id="__span-10-21"><a href="software/2023/05/06/linker/#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">        </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>0x00007f985b3e7000<span class="o">)</span>
</span></code></pre></div>
<p>首先可以看到，二进制里面 <code>simple_function</code> 依然属于 undefined 状态。但 <code>main</code> 也指定了 NEEDED libtest.so.0.0.0，那么在运行的时候，ld.so 就会去寻找这个动态库。由于当前路径不在系统默认路径中，直接运行是找不到的（<code>not found</code>），这里的解决办法是添加动态库的路径到 <code>LD_LIBRARY_PATH</code> 中。</p>
<h4 id="soname"><a class="toclink" href="software/2023/05/06/linker/#soname">soname</a></h4>
<p>上述例子中，编译出来的动态库名称带有完整的版本号：<code>major.minor.patch=0.0.0</code>，但一般认为，如果 <code>major</code> 版本号没有变，可以认为是 ABI 兼容的，可以更新动态库的版本，而不用重新编译程序。但是，上面的例子里，<code>readelf -d main</code> 显示 NEEDED 的动态库名字里也包括了完整的版本号，那就没有办法寻找到同 major 的不同版本了。</p>
<p>解决办法是让同 major 的不同版本共享同一个 soname，常见的做法就是只保留 major 版本号：<code>libtest.so.0</code>，而不是 <code>libtest.so.0.0.0</code>。在编译动态库的时候，通过 <code>-Wl,-soname,libtest.so.0</code> 参数来指定 soname：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a href="software/2023/05/06/linker/#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>$<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>source1.c<span class="w"> </span>-Wl,-soname,libtest.so.0<span class="w"> </span>-o<span class="w"> </span>libtest.so.0.0.0
</span><span id="__span-11-2"><a href="software/2023/05/06/linker/#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-11-3"><a href="software/2023/05/06/linker/#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>main
</span><span id="__span-11-4"><a href="software/2023/05/06/linker/#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-11-5"><a href="software/2023/05/06/linker/#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libtest.so.0<span class="o">]</span>
</span><span id="__span-11-6"><a href="software/2023/05/06/linker/#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libc.so.6<span class="o">]</span>
</span></code></pre></div>
<p>此时可以看到 NEEDED 的动态库名字已经是预期的 <code>libtest.so.0</code>，这意味着 <code>main</code> 函数在动态加载的时候，不考虑小版本，只指定了 <code>major</code> 版本为 0 的 libtest 动态库。但单是这样还不能运行：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a href="software/2023/05/06/linker/#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>$<span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>./main
</span><span id="__span-12-2"><a href="software/2023/05/06/linker/#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>./main:<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>loading<span class="w"> </span>shared<span class="w"> </span>libraries:<span class="w"> </span>libtest.so.0:<span class="w"> </span>cannot<span class="w"> </span>open<span class="w"> </span>shared<span class="w"> </span>object<span class="w"> </span>file:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</span></code></pre></div>
<p>毕竟 ld.so 要找的是 <code>libtest.so.0</code>，但是文件系统里只有 <code>libtest.so.0.0.0</code>，最后的这一步用符号链接来实现：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a href="software/2023/05/06/linker/#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>$<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>libtest.so.0
</span><span id="__span-13-2"><a href="software/2023/05/06/linker/#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>$<span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>./main
</span><span id="__span-13-3"><a href="software/2023/05/06/linker/#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>Simple<span class="w"> </span><span class="k">function</span>
</span></code></pre></div>
<p>这样，如果哪天发布了 libtest.so 的 0.0.1 版本，只需要修改符号链接 <code>libtest.so.0 -&gt; libtest.so.0.0.1</code> 即可，不需要重新编译 <code>main</code> 程序。</p>
<p>想要查看动态库的 soname，可以用 <code>readelf -d</code> 查看：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a href="software/2023/05/06/linker/#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>libtest.so.0.0.0
</span><span id="__span-14-2"><a href="software/2023/05/06/linker/#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-14-3"><a href="software/2023/05/06/linker/#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span id="__span-14-4"><a href="software/2023/05/06/linker/#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w"> </span>0x000000000000000e<span class="w"> </span><span class="o">(</span>SONAME<span class="o">)</span><span class="w">             </span>Library<span class="w"> </span>soname:<span class="w"> </span><span class="o">[</span>libtest.so.0<span class="o">]</span>
</span></code></pre></div>
<h4 id="cuda"><a class="toclink" href="software/2023/05/06/linker/#cuda">cuda</a></h4>
<p>在 CUDA 中，如果程序需要访问 NVML 或者一些底层的 CUDA 函数，会链接到 libcuda（而不是 libcudart），但是如果在 CUDA 目录下寻找 libcuda，只会找到一个 <code>targets/x86_64-linux/lib/stubs/libcuda.so</code>，里面的函数都是空的，只有一个 <code>retq</code> 指令：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a href="software/2023/05/06/linker/#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-S<span class="w"> </span>./targets/x86_64-linux/lib/stubs/libcuda.so
</span><span id="__span-15-2"><a href="software/2023/05/06/linker/#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>./targets/x86_64-linux/lib/stubs/libcuda.so:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64
</span><span id="__span-15-3"><a href="software/2023/05/06/linker/#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>
</span><span id="__span-15-4"><a href="software/2023/05/06/linker/#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>
</span><span id="__span-15-5"><a href="software/2023/05/06/linker/#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>Disassembly<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>.text:
</span><span id="__span-15-6"><a href="software/2023/05/06/linker/#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>
</span><span id="__span-15-7"><a href="software/2023/05/06/linker/#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="m">0000000000007370</span><span class="w"> </span>&lt;cuGetErrorString&gt;:
</span><span id="__span-15-8"><a href="software/2023/05/06/linker/#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="m">7370</span>:<span class="w">       </span>b8<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x22,%eax
</span><span id="__span-15-9"><a href="software/2023/05/06/linker/#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="m">7375</span>:<span class="w">       </span>c3<span class="w">                      </span>retq
</span><span id="__span-15-10"><a href="software/2023/05/06/linker/#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="m">7376</span>:<span class="w">       </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>nopw<span class="w">   </span>%cs:0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span><span id="__span-15-11"><a href="software/2023/05/06/linker/#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span>737d:<span class="w">       </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span>
</span><span id="__span-15-12"><a href="software/2023/05/06/linker/#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a>
</span><span id="__span-15-13"><a href="software/2023/05/06/linker/#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="m">0000000000007380</span><span class="w"> </span>&lt;cuGetErrorName&gt;:
</span><span id="__span-15-14"><a href="software/2023/05/06/linker/#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="m">7380</span>:<span class="w">       </span>b8<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x22,%eax
</span><span id="__span-15-15"><a href="software/2023/05/06/linker/#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="m">7385</span>:<span class="w">       </span>c3<span class="w">                      </span>retq
</span><span id="__span-15-16"><a href="software/2023/05/06/linker/#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="m">7386</span>:<span class="w">       </span><span class="m">66</span><span class="w"> </span>2e<span class="w"> </span>0f<span class="w"> </span>1f<span class="w"> </span><span class="m">84</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">    </span>nopw<span class="w">   </span>%cs:0x0<span class="o">(</span>%rax,%rax,1<span class="o">)</span>
</span><span id="__span-15-17"><a href="software/2023/05/06/linker/#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span>738d:<span class="w">       </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span>
</span></code></pre></div>
<p>这个 <code>libcuda.so</code> 用途就是导出了所有可能会用到的符号，并且设置 <code>soname</code> 为 <code>libcuda.so.1</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a href="software/2023/05/06/linker/#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>./targets/x86_64-linux/lib/stubs/libcuda.so
</span><span id="__span-16-2"><a href="software/2023/05/06/linker/#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a href="software/2023/05/06/linker/#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>Dynamic<span class="w"> </span>section<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span>0xdf30<span class="w"> </span>contains<span class="w"> </span><span class="m">8</span><span class="w"> </span>entries:
</span><span id="__span-16-4"><a href="software/2023/05/06/linker/#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-16-5"><a href="software/2023/05/06/linker/#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w"> </span>0x000000000000000e<span class="w"> </span><span class="o">(</span>SONAME<span class="o">)</span><span class="w">             </span>Library<span class="w"> </span>soname:<span class="w"> </span><span class="o">[</span>libcuda.so.1<span class="o">]</span>
</span></code></pre></div>
<p>这就意味着，<code>ld.so</code> 会去寻找 <code>libcuda.so.1</code>，而不是 <code>libcuda</code>。前者才是真正实现了 CUDA Driver 的动态库：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a href="software/2023/05/06/linker/#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a>$<span class="w"> </span>dpkg<span class="w"> </span>-S<span class="w"> </span>libcuda.so.1
</span><span id="__span-17-2"><a href="software/2023/05/06/linker/#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>libnvidia-compute-470:amd64:<span class="w"> </span>/usr/lib/x86_64-linux-gnu/libcuda.so.1
</span><span id="__span-17-3"><a href="software/2023/05/06/linker/#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>$<span class="w"> </span>ls<span class="w"> </span>-alh<span class="w"> </span>/usr/lib/x86_64-linux-gnu/libcuda.so.1
</span><span id="__span-17-4"><a href="software/2023/05/06/linker/#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">21</span><span class="w"> </span>May<span class="w"> </span><span class="m">13</span><span class="w">  </span><span class="m">2022</span><span class="w"> </span>/usr/lib/x86_64-linux-gnu/libcuda.so.1<span class="w"> </span>-&gt;<span class="w"> </span>libcuda.so.470.129.06
</span></code></pre></div>
<p>而 CUDA Driver 的实现和 NVIDIA Driver 的版本是绑定的，因此 <code>libcuda.so.1</code> 是软链接，软链接到对应驱动版本的 <code>libcuda.so</code>。这样做的好处就是，编译 CUDA 的机器，不需要安装 NVIDIA Driver，CUDA 也不需要自己带一份 CUDA Driver 进来，节省了空间。</p>
<p>像 pytorch 这种支持 CUDA 的程序，不会在链接的时候链接到 <code>libcuda</code> 上，而是在用户需要的时候，去 <code>dlopen</code>。这样即使用户的电脑上没有装 NVIDIA Driver，也可以运行支持 CUDA 的 pytorch。</p>
<h4 id="dynamic-linkerloader"><a class="toclink" href="software/2023/05/06/linker/#dynamic-linkerloader">dynamic linker/loader</a></h4>
<p>前文讲到，动态链接库参与链接的时候，实际上函数本身没有链接进可执行程序，最后的加载是由 dynamic linker/loader 完成的，在 linux 上是 ld.so，在 macOS 上是 dyld。它在程序启动的时候，负责根据 NEEDED 信息，知道程序要加载哪些动态库，然后去文件系统里找，如果找到了，就把相应的动态库加载到内存中，然后把可执行程序中对动态链接库的函数调用，变成真实的地址。相当于把原来静态链接的时候，链接器做的事情，挪到了程序运行开始时，即 linking at run time。</p>
<p>那么这里就涉及到一个问题了：NEEDED 只记录了文件名，但是却没有路径。这意味着动态库也需要用类似 PATH 的机制，在一些路径里去寻找一个想要的动态库。例如前文修改 <code>LD_LIBRARY_PATH</code>，实际上就是告诉 ld.so，可以在这个环境变量指向的路径中寻找动态库的文件。</p>
<p>而用系统包管理器安装的动态库，一般不需要修改 <code>LD_LIBRARY_PATH</code> 也可以用。这是靠 <code>/etc/ld.so.cache</code> 文件实现的。在动态库相关的问题里，经常会看到运行 <code>ldconfig</code> 命令。这个命令的用途是，收集系统目录里的动态库，建立一个索引，保存在 <code>/etc/ld.so.cache</code> 文件中。然后 ld.so 直接去 <code>/etc/ld.so.cache</code> 中寻找 NEEDED 的动态库对应的文件系统中的路径，不需要再重新扫描一遍目录了。所以 <code>/etc/ld.so.cache</code> 就是一个文件系统中动态库的缓存，这也就是为啥叫做 <code>ld.so.cache</code>。</p>
<p>既然是缓存，就要考虑缓存和实际对不上的情况，这就是为啥要运行 <code>ldconfig</code> 命令更新缓存。当然了，包管理器会自动运行 <code>ldconfig</code>，只有自己 <code>make install</code> 一些库的时候，才需要手动进行 <code>ldconfig</code>。</p>
<p><code>ldconfig</code> 会从 <code>/etc/ld.so.conf</code> 中配置的路径中扫描动态链接库，常见的路径包括：</p>
<ul>
<li>/lib/x86_64-linux-gnu</li>
<li>/usr/lib/x86_64-linux-gnu</li>
<li>/usr/local/lib</li>
<li>/usr/local/lib/x86_64-linux-gnu</li>
</ul>
<p>包管理器安装的动态库基本都在这些目录中。可以用 <code>ldconfig -p</code> 来查看缓存 <code>ld.so.cache</code> 的内容：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-18-1"><a href="software/2023/05/06/linker/#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>$<span class="w"> </span>/sbin/ldconfig<span class="w"> </span>-p
</span><span id="__span-18-2"><a href="software/2023/05/06/linker/#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="m">1967</span><span class="w"> </span>libs<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span>cache<span class="w"> </span><span class="sb">`</span>/etc/ld.so.cache<span class="err">'</span>
</span><span id="__span-18-3"><a href="software/2023/05/06/linker/#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">        </span>libz3.so.4<span class="w"> </span><span class="o">(</span>libc6,x86-64<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libz3.so.4
</span><span id="__span-18-4"><a href="software/2023/05/06/linker/#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">        </span>libz3.so<span class="w"> </span><span class="o">(</span>libc6,x86-64<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libz3.so
</span><span id="__span-18-5"><a href="software/2023/05/06/linker/#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">        </span>ld-linux.so.2<span class="w"> </span><span class="o">(</span>ELF<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/i386-linux-gnu/ld-linux.so.2
</span><span id="__span-18-6"><a href="software/2023/05/06/linker/#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">        </span>ld-linux.so.2<span class="w"> </span><span class="o">(</span>ELF<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib32/ld-linux.so.2
</span><span id="__span-18-7"><a href="software/2023/05/06/linker/#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">        </span>ld-linux.so.2<span class="w"> </span><span class="o">(</span>ELF<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/ld-linux.so.2
</span><span id="__span-18-8"><a href="software/2023/05/06/linker/#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">        </span>ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>libc6,x86-64<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
</span><span id="__span-18-9"><a href="software/2023/05/06/linker/#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">        </span>ld-linux-x32.so.2<span class="w"> </span><span class="o">(</span>libc6,x32<span class="o">)</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/libx32/ld-linux-x32.so.2
</span></code></pre></div>
<p>维护了 soname 到文件系统中动态库文件的映射。并且添加了一些属性来帮助 ld.so 进行过滤和选择。</p>
<h4 id="rpath"><a class="toclink" href="software/2023/05/06/linker/#rpath">rpath</a></h4>
<p>除了 LD_LIBRARY_PATH 和 <code>/etc/ld.so.cache</code>，ld.so 还可以通过 rpath 来寻找动态库。设想要打包一个 Qt 程序，希望在别人的机器上可以直接跑，但是别人的机器上不一定有 Qt，因此需要把程序和 Qt 的各种动态库打包在一起。但是，这时候 Qt 的动态库不会在系统路径中，不会被 <code>ldconfig</code> 索引。一种办法就是写一个脚本，设置一下 <code>LD_LIBRARY_PATH</code>，再启动 Qt 程序。另一种办法，就是利用 rpath：在程序中就告诉 ld.so 去哪里找它依赖（NEEDED）的动态库。这个路径可以是相对于可执行文件的路径。</p>
<p>设置 <code>rpath</code> 的方法是，编译的时候添加 <code>-Wl,-rpath,RPATH</code> 选项，例如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-19-1"><a href="software/2023/05/06/linker/#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-19-2"><a href="software/2023/05/06/linker/#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>$<span class="w"> </span>./main
</span><span id="__span-19-3"><a href="software/2023/05/06/linker/#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>./main:<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>loading<span class="w"> </span>shared<span class="w"> </span>libraries:<span class="w"> </span>libtest.so.0:<span class="w"> </span>cannot<span class="w"> </span>open<span class="w"> </span>shared<span class="w"> </span>object<span class="w"> </span>file:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</span><span id="__span-19-4"><a href="software/2023/05/06/linker/#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>-Wl,-rpath,<span class="nv">$PWD</span><span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-19-5"><a href="software/2023/05/06/linker/#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a>$<span class="w"> </span>./main
</span><span id="__span-19-6"><a href="software/2023/05/06/linker/#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a>Simple<span class="w"> </span><span class="k">function</span>
</span><span id="__span-19-7"><a href="software/2023/05/06/linker/#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>main
</span><span id="__span-19-8"><a href="software/2023/05/06/linker/#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-19-9"><a href="software/2023/05/06/linker/#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libtest.so.0<span class="o">]</span>
</span><span id="__span-19-10"><a href="software/2023/05/06/linker/#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span id="__span-19-11"><a href="software/2023/05/06/linker/#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w"> </span>0x000000000000001d<span class="w"> </span><span class="o">(</span>RUNPATH<span class="o">)</span><span class="w">            </span>Library<span class="w"> </span>runpath:<span class="w"> </span><span class="o">[</span>/tmp<span class="o">]</span>
</span><span id="__span-19-12"><a href="software/2023/05/06/linker/#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.so.0.0.0<span class="w"> </span>-Wl,-rpath,<span class="s1">'$ORIGIN'</span><span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-19-13"><a href="software/2023/05/06/linker/#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>$<span class="w"> </span>./main
</span><span id="__span-19-14"><a href="software/2023/05/06/linker/#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>Simple<span class="w"> </span><span class="k">function</span>
</span><span id="__span-19-15"><a href="software/2023/05/06/linker/#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span>main
</span><span id="__span-19-16"><a href="software/2023/05/06/linker/#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">  </span>Tag<span class="w">        </span>Type<span class="w">                         </span>Name/Value
</span><span id="__span-19-17"><a href="software/2023/05/06/linker/#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libtest.so.0<span class="o">]</span>
</span><span id="__span-19-18"><a href="software/2023/05/06/linker/#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w"> </span>0x0000000000000001<span class="w"> </span><span class="o">(</span>NEEDED<span class="o">)</span><span class="w">             </span>Shared<span class="w"> </span>library:<span class="w"> </span><span class="o">[</span>libc.so.6<span class="o">]</span>
</span><span id="__span-19-19"><a href="software/2023/05/06/linker/#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w"> </span>0x000000000000001d<span class="w"> </span><span class="o">(</span>RUNPATH<span class="o">)</span><span class="w">            </span>Library<span class="w"> </span>runpath:<span class="w"> </span><span class="o">[</span><span class="nv">$ORIGIN</span><span class="o">]</span>
</span></code></pre></div>
<p>第一个编译命令不带 <code>rpath</code>，因此 ld.so 会找不到动态库，可以添加 LD_LIBRARY_PATH 的办法来解决。第二个和第三个编译命令带 <code>rpath</code>，其中第二个使用了绝对路径，第三个使用了相对路径（<code>$ORIGIN</code> 表示可执行文件所在的目录）。那么，ld.so 在寻找 libtest.so.0 的时候，会在 RUNPATH 中进行寻找。</p>
<h4 id="_9"><a class="toclink" href="software/2023/05/06/linker/#_9">调试</a></h4>
<p>动态链接经常会遇到各种找不到动态库的问题，需要使用一些工具来帮助找到问题。最常用的就是 <code>ldd</code> 命令，显示一个程序依赖的动态库以及路径：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a href="software/2023/05/06/linker/#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>$<span class="w"> </span>ldd<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>vim<span class="k">)</span>
</span><span id="__span-20-2"><a href="software/2023/05/06/linker/#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">        </span>linux-vdso.so.1<span class="w"> </span><span class="o">(</span>0x00007fff599a4000<span class="o">)</span>
</span><span id="__span-20-3"><a href="software/2023/05/06/linker/#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">        </span>libm.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libm.so.6<span class="w"> </span><span class="o">(</span>0x00007f0504dfc000<span class="o">)</span>
</span><span id="__span-20-4"><a href="software/2023/05/06/linker/#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">        </span>libtinfo.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libtinfo.so.6<span class="w"> </span><span class="o">(</span>0x00007f0504dc9000<span class="o">)</span>
</span><span id="__span-20-5"><a href="software/2023/05/06/linker/#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">        </span>libselinux.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libselinux.so.1<span class="w"> </span><span class="o">(</span>0x00007f0504d9b000<span class="o">)</span>
</span><span id="__span-20-6"><a href="software/2023/05/06/linker/#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">        </span>libsodium.so.23<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libsodium.so.23<span class="w"> </span><span class="o">(</span>0x00007f05049a6000<span class="o">)</span>
</span><span id="__span-20-7"><a href="software/2023/05/06/linker/#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">        </span>libacl.so.1<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libacl.so.1<span class="w"> </span><span class="o">(</span>0x00007f0504d90000<span class="o">)</span>
</span><span id="__span-20-8"><a href="software/2023/05/06/linker/#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">        </span>libgpm.so.2<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libgpm.so.2<span class="w"> </span><span class="o">(</span>0x00007f050499e000<span class="o">)</span>
</span><span id="__span-20-9"><a href="software/2023/05/06/linker/#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">        </span>libc.so.6<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6<span class="w"> </span><span class="o">(</span>0x00007f05047bd000<span class="o">)</span>
</span><span id="__span-20-10"><a href="software/2023/05/06/linker/#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">        </span>/lib64/ld-linux-x86-64.so.2<span class="w"> </span><span class="o">(</span>0x00007f0504f07000<span class="o">)</span>
</span><span id="__span-20-11"><a href="software/2023/05/06/linker/#__codelineno-20-11" id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">        </span>libpcre2-8.so.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libpcre2-8.so.0<span class="w"> </span><span class="o">(</span>0x00007f0504723000<span class="o">)</span>
</span><span id="__span-20-12"><a href="software/2023/05/06/linker/#__codelineno-20-12" id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">        </span>libpthread.so.0<span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span>/lib/x86_64-linux-gnu/libpthread.so.0<span class="w"> </span><span class="o">(</span>0x00007f0504d89000<span class="o">)</span>
</span></code></pre></div>
<p>当然了，<code>ldd</code> 有一定的风险，不建议在不信任的程序上运行 <code>ldd</code>，详情见 <a href="https://man7.org/linux/man-pages/man1/ldd.1.html">ldd.1</a>。更稳妥的方法是用 <code>objdump -p</code> 或者 <code>readelf -d</code>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a href="software/2023/05/06/linker/#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-p<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>vim<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>NEEDED
</span><span id="__span-21-2"><a href="software/2023/05/06/linker/#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>$<span class="w"> </span>readelf<span class="w"> </span>-d<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>vim<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>NEEDED
</span></code></pre></div>
<p>但是 ldd 可以打印出动态库依赖的动态库，而 objdump 和 readelf 只会打印直接依赖。也可以设置环境变量，让 ld.so 打印出加载的动态库：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a href="software/2023/05/06/linker/#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">LD_DEBUG</span><span class="o">=</span>files
</span><span id="__span-22-2"><a href="software/2023/05/06/linker/#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>$<span class="w"> </span>./main
</span><span id="__span-22-3"><a href="software/2023/05/06/linker/#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span><span class="nv">file</span><span class="o">=</span>libtest.so.0<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">;</span><span class="w">  </span>needed<span class="w"> </span>by<span class="w"> </span>./main<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-22-4"><a href="software/2023/05/06/linker/#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span><span class="nv">file</span><span class="o">=</span>libtest.so.0<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">;</span><span class="w">  </span>generating<span class="w"> </span>link<span class="w"> </span>map
</span><span id="__span-22-5"><a href="software/2023/05/06/linker/#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">       </span>dynamic:<span class="w"> </span>0x00007fcd57c23df8<span class="w">  </span>base:<span class="w"> </span>0x00007fcd57c20000<span class="w">   </span>size:<span class="w"> </span>0x0000000000004018
</span><span id="__span-22-6"><a href="software/2023/05/06/linker/#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">         </span>entry:<span class="w"> </span>0x00007fcd57c20000<span class="w">  </span>phdr:<span class="w"> </span>0x00007fcd57c20040<span class="w">  </span>phnum:<span class="w">                  </span><span class="m">9</span>
</span><span id="__span-22-7"><a href="software/2023/05/06/linker/#__codelineno-22-7" id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">   </span><span class="m">2243766</span>:
</span><span id="__span-22-8"><a href="software/2023/05/06/linker/#__codelineno-22-8" id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span><span class="nv">file</span><span class="o">=</span>libc.so.6<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">;</span><span class="w">  </span>needed<span class="w"> </span>by<span class="w"> </span>./main<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-22-9"><a href="software/2023/05/06/linker/#__codelineno-22-9" id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span><span class="nv">file</span><span class="o">=</span>libc.so.6<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="p">;</span><span class="w">  </span>generating<span class="w"> </span>link<span class="w"> </span>map
</span><span id="__span-22-10"><a href="software/2023/05/06/linker/#__codelineno-22-10" id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">       </span>dynamic:<span class="w"> </span>0x00007fcd57bf1b60<span class="w">  </span>base:<span class="w"> </span>0x00007fcd57a20000<span class="w">   </span>size:<span class="w"> </span>0x00000000001e0f50
</span><span id="__span-22-11"><a href="software/2023/05/06/linker/#__codelineno-22-11" id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">         </span>entry:<span class="w"> </span>0x00007fcd57a47350<span class="w">  </span>phdr:<span class="w"> </span>0x00007fcd57a20040<span class="w">  </span>phnum:<span class="w">                 </span><span class="m">14</span>
</span><span id="__span-22-12"><a href="software/2023/05/06/linker/#__codelineno-22-12" id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">   </span><span class="m">2243766</span>:
</span><span id="__span-22-13"><a href="software/2023/05/06/linker/#__codelineno-22-13" id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>calling<span class="w"> </span>init:<span class="w"> </span>/lib64/ld-linux-x86-64.so.2
</span><span id="__span-22-14"><a href="software/2023/05/06/linker/#__codelineno-22-14" id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>calling<span class="w"> </span>init:<span class="w"> </span>/lib/x86_64-linux-gnu/libc.so.6
</span><span id="__span-22-15"><a href="software/2023/05/06/linker/#__codelineno-22-15" id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>calling<span class="w"> </span>init:<span class="w"> </span>/tmp/libtest.so.0
</span><span id="__span-22-16"><a href="software/2023/05/06/linker/#__codelineno-22-16" id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>initialize<span class="w"> </span>program:<span class="w"> </span>./main
</span><span id="__span-22-17"><a href="software/2023/05/06/linker/#__codelineno-22-17" id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>transferring<span class="w"> </span>control:<span class="w"> </span>./main
</span><span id="__span-22-18"><a href="software/2023/05/06/linker/#__codelineno-22-18" id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>calling<span class="w"> </span>fini:<span class="w"> </span>./main<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-22-19"><a href="software/2023/05/06/linker/#__codelineno-22-19" id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">   </span><span class="m">2243766</span>:<span class="w">     </span>calling<span class="w"> </span>fini:<span class="w"> </span>/tmp/libtest.so.0<span class="w"> </span><span class="o">[</span><span class="m">0</span><span class="o">]</span>
</span><span id="__span-22-20"><a href="software/2023/05/06/linker/#__codelineno-22-20" id="__codelineno-22-20" name="__codelineno-22-20"></a>Simple<span class="w"> </span><span class="k">function</span>
</span></code></pre></div>
<h4 id="macos"><a class="toclink" href="software/2023/05/06/linker/#macos">macOS</a></h4>
<p>macOS 与 Linux 下动态库的使用方法基本类似，但有一些细微的差别。首先是 macOS 上的动态库的后缀用的是 dylib 而不是 so：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a href="software/2023/05/06/linker/#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>$<span class="w"> </span>gcc<span class="w"> </span>-fPIC<span class="w"> </span>-shared<span class="w"> </span>source1.c<span class="w"> </span>-o<span class="w"> </span>libtest.dylib
</span><span id="__span-23-2"><a href="software/2023/05/06/linker/#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a>$<span class="w"> </span>gcc<span class="w"> </span>main.c<span class="w"> </span>libtest.dylib<span class="w"> </span>-o<span class="w"> </span>main
</span><span id="__span-23-3"><a href="software/2023/05/06/linker/#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>libtest.dylib
</span><span id="__span-23-4"><a href="software/2023/05/06/linker/#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a>libtest.dylib:<span class="w">  </span>file<span class="w"> </span>format<span class="w"> </span>mach-o<span class="w"> </span>arm64
</span><span id="__span-23-5"><a href="software/2023/05/06/linker/#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a>
</span><span id="__span-23-6"><a href="software/2023/05/06/linker/#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-23-7"><a href="software/2023/05/06/linker/#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a>0000000000003f7c<span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_simple_function
</span><span id="__span-23-8"><a href="software/2023/05/06/linker/#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_printf
</span><span id="__span-23-9"><a href="software/2023/05/06/linker/#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a>$<span class="w"> </span>objdump<span class="w"> </span>-t<span class="w"> </span>main
</span><span id="__span-23-10"><a href="software/2023/05/06/linker/#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a>main:<span class="w">   </span>file<span class="w"> </span>format<span class="w"> </span>mach-o<span class="w"> </span>arm64
</span><span id="__span-23-11"><a href="software/2023/05/06/linker/#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a>
</span><span id="__span-23-12"><a href="software/2023/05/06/linker/#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a>SYMBOL<span class="w"> </span>TABLE:
</span><span id="__span-23-13"><a href="software/2023/05/06/linker/#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="m">0000000100000000</span><span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>__mh_execute_header
</span><span id="__span-23-14"><a href="software/2023/05/06/linker/#__codelineno-23-14" id="__codelineno-23-14" name="__codelineno-23-14"></a>0000000100003f94<span class="w"> </span>g<span class="w">     </span>F<span class="w"> </span>__TEXT,__text<span class="w"> </span>_main
</span><span id="__span-23-15"><a href="software/2023/05/06/linker/#__codelineno-23-15" id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="m">0000000000000000</span><span class="w">         </span>*UND*<span class="w"> </span>_simple_function
</span></code></pre></div>
<p>虽然这里用的是 gcc 命令，但实际上 macOS 上的 gcc 命令是 clang。这里直接用 clang 命令也是一样的。可以看到，这里的可执行文件中 <code>simple_function</code> 函数也是处于 undefined 状态，需要在运行时由 <code>libtest.dylib</code> 提供。</p>
<p>macOS 下的动态链接器是 dyld，它会解析 MachO 的 Load command 去加载动态库：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a href="software/2023/05/06/linker/#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-p<span class="w"> </span>main
</span><span id="__span-24-2"><a href="software/2023/05/06/linker/#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>Load<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="m">13</span>
</span><span id="__span-24-3"><a href="software/2023/05/06/linker/#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">          </span>cmd<span class="w"> </span>LC_LOAD_DYLIB
</span><span id="__span-24-4"><a href="software/2023/05/06/linker/#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">      </span>cmdsize<span class="w"> </span><span class="m">40</span>
</span><span id="__span-24-5"><a href="software/2023/05/06/linker/#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">         </span>name<span class="w"> </span>libtest.dylib<span class="w"> </span><span class="o">(</span>offset<span class="w"> </span><span class="m">24</span><span class="o">)</span>
</span><span id="__span-24-6"><a href="software/2023/05/06/linker/#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">   </span><span class="nb">time</span><span class="w"> </span>stamp<span class="w"> </span><span class="m">2</span><span class="w"> </span>Thu<span class="w"> </span>Jan<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">08</span>:00:02<span class="w"> </span><span class="m">1970</span>
</span><span id="__span-24-7"><a href="software/2023/05/06/linker/#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">      </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0
</span><span id="__span-24-8"><a href="software/2023/05/06/linker/#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0
</span><span id="__span-24-9"><a href="software/2023/05/06/linker/#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a>Load<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="m">14</span>
</span><span id="__span-24-10"><a href="software/2023/05/06/linker/#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">          </span>cmd<span class="w"> </span>LC_LOAD_DYLIB
</span><span id="__span-24-11"><a href="software/2023/05/06/linker/#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">      </span>cmdsize<span class="w"> </span><span class="m">56</span>
</span><span id="__span-24-12"><a href="software/2023/05/06/linker/#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">         </span>name<span class="w"> </span>/usr/lib/libSystem.B.dylib<span class="w"> </span><span class="o">(</span>offset<span class="w"> </span><span class="m">24</span><span class="o">)</span>
</span><span id="__span-24-13"><a href="software/2023/05/06/linker/#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">   </span><span class="nb">time</span><span class="w"> </span>stamp<span class="w"> </span><span class="m">2</span><span class="w"> </span>Thu<span class="w"> </span>Jan<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">08</span>:00:02<span class="w"> </span><span class="m">1970</span>
</span><span id="__span-24-14"><a href="software/2023/05/06/linker/#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">      </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">1319</span>.100.3
</span><span id="__span-24-15"><a href="software/2023/05/06/linker/#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">1</span>.0.0
</span></code></pre></div>
<p>这就相当于 Linux 中的 NEEDED，告诉动态链接器要加载哪些动态库。可以用 <code>otool -L</code> 或者 <code>dyld_info</code> 命令列出可执行文件所有依赖的动态库：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a href="software/2023/05/06/linker/#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>$<span class="w"> </span>otool<span class="w"> </span>-L<span class="w"> </span>main
</span><span id="__span-25-2"><a href="software/2023/05/06/linker/#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>main:
</span><span id="__span-25-3"><a href="software/2023/05/06/linker/#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">        </span>libtest.dylib<span class="w"> </span><span class="o">(</span>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0,<span class="w"> </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0<span class="o">)</span>
</span><span id="__span-25-4"><a href="software/2023/05/06/linker/#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">        </span>/usr/lib/libSystem.B.dylib<span class="w"> </span><span class="o">(</span>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">1</span>.0.0,<span class="w"> </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">1319</span>.100.3<span class="o">)</span>
</span><span id="__span-25-5"><a href="software/2023/05/06/linker/#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a>$<span class="w"> </span>dyld_info<span class="w"> </span>-dependents<span class="w"> </span>main
</span><span id="__span-25-6"><a href="software/2023/05/06/linker/#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a>main<span class="w"> </span><span class="o">[</span>arm64<span class="o">]</span>:
</span><span id="__span-25-7"><a href="software/2023/05/06/linker/#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">    </span>-dependents:
</span><span id="__span-25-8"><a href="software/2023/05/06/linker/#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">        </span>attributes<span class="w">     </span>load<span class="w"> </span>path
</span><span id="__span-25-9"><a href="software/2023/05/06/linker/#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">                       </span>libtest.dylib
</span><span id="__span-25-10"><a href="software/2023/05/06/linker/#__codelineno-25-10" id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">                       </span>/usr/lib/libSystem.B.dylib
</span></code></pre></div>
<p>macOS 也提供了 rpath 的机制，在 <code>LC_LOAD_DYLIB</code> 中指定 <code>@rpath</code>，然后通过 <code>LC_RPATH</code> 指定有哪些 rpath，那么动态链接器就可以根据可执行文件的相对路径去寻找动态库：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a href="software/2023/05/06/linker/#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>$<span class="w"> </span>objdump<span class="w"> </span>-p<span class="w"> </span>/Applications/Visual<span class="se">\ </span>Studio<span class="se">\ </span>Code.app/Contents/MacOS/Electron
</span><span id="__span-26-2"><a href="software/2023/05/06/linker/#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>Load<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="m">8</span>
</span><span id="__span-26-3"><a href="software/2023/05/06/linker/#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">          </span>cmd<span class="w"> </span>LC_RPATH
</span><span id="__span-26-4"><a href="software/2023/05/06/linker/#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">      </span>cmdsize<span class="w"> </span><span class="m">48</span>
</span><span id="__span-26-5"><a href="software/2023/05/06/linker/#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">         </span>path<span class="w"> </span>@executable_path/../Frameworks<span class="w"> </span><span class="o">(</span>offset<span class="w"> </span><span class="m">12</span><span class="o">)</span>
</span><span id="__span-26-6"><a href="software/2023/05/06/linker/#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a>Load<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="m">13</span>
</span><span id="__span-26-7"><a href="software/2023/05/06/linker/#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">          </span>cmd<span class="w"> </span>LC_LOAD_DYLIB
</span><span id="__span-26-8"><a href="software/2023/05/06/linker/#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">      </span>cmdsize<span class="w"> </span><span class="m">80</span>
</span><span id="__span-26-9"><a href="software/2023/05/06/linker/#__codelineno-26-9" id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">         </span>name<span class="w"> </span>@rpath/Electron<span class="w"> </span>Framework.framework/Electron<span class="w"> </span>Framework<span class="w"> </span><span class="o">(</span>offset<span class="w"> </span><span class="m">24</span><span class="o">)</span>
</span><span id="__span-26-10"><a href="software/2023/05/06/linker/#__codelineno-26-10" id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">   </span><span class="nb">time</span><span class="w"> </span>stamp<span class="w"> </span><span class="m">0</span><span class="w"> </span>Thu<span class="w"> </span>Jan<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">08</span>:00:00<span class="w"> </span><span class="m">1970</span>
</span><span id="__span-26-11"><a href="software/2023/05/06/linker/#__codelineno-26-11" id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">      </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">22</span>.5.2
</span><span id="__span-26-12"><a href="software/2023/05/06/linker/#__codelineno-26-12" id="__codelineno-26-12" name="__codelineno-26-12"></a>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0
</span><span id="__span-26-13"><a href="software/2023/05/06/linker/#__codelineno-26-13" id="__codelineno-26-13" name="__codelineno-26-13"></a>Load<span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="m">14</span>
</span><span id="__span-26-14"><a href="software/2023/05/06/linker/#__codelineno-26-14" id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">          </span>cmd<span class="w"> </span>LC_LOAD_DYLIB
</span><span id="__span-26-15"><a href="software/2023/05/06/linker/#__codelineno-26-15" id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">      </span>cmdsize<span class="w"> </span><span class="m">56</span>
</span><span id="__span-26-16"><a href="software/2023/05/06/linker/#__codelineno-26-16" id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">         </span>name<span class="w"> </span>/usr/lib/libSystem.B.dylib<span class="w"> </span><span class="o">(</span>offset<span class="w"> </span><span class="m">24</span><span class="o">)</span>
</span><span id="__span-26-17"><a href="software/2023/05/06/linker/#__codelineno-26-17" id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">   </span><span class="nb">time</span><span class="w"> </span>stamp<span class="w"> </span><span class="m">0</span><span class="w"> </span>Thu<span class="w"> </span>Jan<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">08</span>:00:00<span class="w"> </span><span class="m">1970</span>
</span><span id="__span-26-18"><a href="software/2023/05/06/linker/#__codelineno-26-18" id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">      </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">1311</span>.100.3
</span><span id="__span-26-19"><a href="software/2023/05/06/linker/#__codelineno-26-19" id="__codelineno-26-19" name="__codelineno-26-19"></a>$<span class="w"> </span>otool<span class="w"> </span>-L<span class="w"> </span>/Applications/Visual<span class="se">\ </span>Studio<span class="se">\ </span>Code.app/Contents/MacOS/Electron
</span><span id="__span-26-20"><a href="software/2023/05/06/linker/#__codelineno-26-20" id="__codelineno-26-20" name="__codelineno-26-20"></a>/Applications/Visual<span class="w"> </span>Studio<span class="w"> </span>Code.app/Contents/MacOS/Electron:
</span><span id="__span-26-21"><a href="software/2023/05/06/linker/#__codelineno-26-21" id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">        </span>@rpath/Electron<span class="w"> </span>Framework.framework/Electron<span class="w"> </span>Framework<span class="w"> </span><span class="o">(</span>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.0.0,<span class="w"> </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">22</span>.5.2<span class="o">)</span>
</span><span id="__span-26-22"><a href="software/2023/05/06/linker/#__codelineno-26-22" id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">        </span>/usr/lib/libSystem.B.dylib<span class="w"> </span><span class="o">(</span>compatibility<span class="w"> </span>version<span class="w"> </span><span class="m">1</span>.0.0,<span class="w"> </span>current<span class="w"> </span>version<span class="w"> </span><span class="m">1311</span>.100.3<span class="o">)</span>
</span></code></pre></div>
<p>也可以让 dyld 动态打印日志：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-27-1"><a href="software/2023/05/06/linker/#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">DYLD_PRINT_LIBRARIES</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-27-2"><a href="software/2023/05/06/linker/#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a>$<span class="w"> </span>./main
</span><span id="__span-27-3"><a href="software/2023/05/06/linker/#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;F4E9A9E0-E958-3D0C-8D5A-7DC3ABA8E8C4&gt;<span class="w"> </span>/Volumes/Data/temp/main
</span><span id="__span-27-4"><a href="software/2023/05/06/linker/#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;DD5E30FB-753D-3746-8034-50C56971C47B&gt;<span class="w"> </span>/Volumes/Data/temp/libtest.dylib
</span><span id="__span-27-5"><a href="software/2023/05/06/linker/#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;4BEBCD61-9E62-39BE-BFD2-C7D0689A826D&gt;<span class="w"> </span>/usr/lib/libSystem.B.dylib
</span><span id="__span-27-6"><a href="software/2023/05/06/linker/#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;FEA038BA-CC59-3085-93B0-AB8437AA6CE2&gt;<span class="w"> </span>/usr/lib/system/libcache.dylib
</span><span id="__span-27-7"><a href="software/2023/05/06/linker/#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;34AC4B05-E145-3C58-8C24-1190770EAB31&gt;<span class="w"> </span>/usr/lib/system/libcommonCrypto.dylib
</span><span id="__span-27-8"><a href="software/2023/05/06/linker/#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;1D6552C4-49C4-374F-8371-198BCFC4174D&gt;<span class="w"> </span>/usr/lib/system/libcompiler_rt.dylib
</span><span id="__span-27-9"><a href="software/2023/05/06/linker/#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;E61C2838-9EA2-33CE-B96B-85FF38DB7744&gt;<span class="w"> </span>/usr/lib/system/libcopyfile.dylib
</span><span id="__span-27-10"><a href="software/2023/05/06/linker/#__codelineno-27-10" id="__codelineno-27-10" name="__codelineno-27-10"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;4A9F9101-A1B1-3FB7-89EA-746CFCE95099&gt;<span class="w"> </span>/usr/lib/system/libcorecrypto.dylib
</span><span id="__span-27-11"><a href="software/2023/05/06/linker/#__codelineno-27-11" id="__codelineno-27-11" name="__codelineno-27-11"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;C2FD3094-B465-39A4-B774-16583FF53C4B&gt;<span class="w"> </span>/usr/lib/system/libdispatch.dylib
</span><span id="__span-27-12"><a href="software/2023/05/06/linker/#__codelineno-27-12" id="__codelineno-27-12" name="__codelineno-27-12"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;A2947B47-B494-36D4-96C6-95977FFB51FB&gt;<span class="w"> </span>/usr/lib/system/libdyld.dylib
</span><span id="__span-27-13"><a href="software/2023/05/06/linker/#__codelineno-27-13" id="__codelineno-27-13" name="__codelineno-27-13"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;C4512BA5-7CA3-30AE-9793-5CC5417F0FC3&gt;<span class="w"> </span>/usr/lib/system/libkeymgr.dylib
</span><span id="__span-27-14"><a href="software/2023/05/06/linker/#__codelineno-27-14" id="__codelineno-27-14" name="__codelineno-27-14"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;91A88FDF-FD27-32AF-A2CE-70F7E4065C3B&gt;<span class="w"> </span>/usr/lib/system/libmacho.dylib
</span><span id="__span-27-15"><a href="software/2023/05/06/linker/#__codelineno-27-15" id="__codelineno-27-15" name="__codelineno-27-15"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;A2D17FF6-CBC6-3D19-89E1-F5E57191E8A3&gt;<span class="w"> </span>/usr/lib/system/libquarantine.dylib
</span><span id="__span-27-16"><a href="software/2023/05/06/linker/#__codelineno-27-16" id="__codelineno-27-16" name="__codelineno-27-16"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;2213EE66-253B-3234-AA4D-B46F07C3540E&gt;<span class="w"> </span>/usr/lib/system/libremovefile.dylib
</span><span id="__span-27-17"><a href="software/2023/05/06/linker/#__codelineno-27-17" id="__codelineno-27-17" name="__codelineno-27-17"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;68D76774-F8B4-36EA-AA35-0AB4044D56C7&gt;<span class="w"> </span>/usr/lib/system/libsystem_asl.dylib
</span><span id="__span-27-18"><a href="software/2023/05/06/linker/#__codelineno-27-18" id="__codelineno-27-18" name="__codelineno-27-18"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;5541DF62-A795-3F57-A54C-1AEC4DD3E44C&gt;<span class="w"> </span>/usr/lib/system/libsystem_blocks.dylib
</span><span id="__span-27-19"><a href="software/2023/05/06/linker/#__codelineno-27-19" id="__codelineno-27-19" name="__codelineno-27-19"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;95A70E20-1DF3-3DDF-900C-315ED0B2C067&gt;<span class="w"> </span>/usr/lib/system/libsystem_c.dylib
</span><span id="__span-27-20"><a href="software/2023/05/06/linker/#__codelineno-27-20" id="__codelineno-27-20" name="__codelineno-27-20"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;BEB9DE52-6F49-370A-B45B-CBE6780E7083&gt;<span class="w"> </span>/usr/lib/system/libsystem_collections.dylib
</span><span id="__span-27-21"><a href="software/2023/05/06/linker/#__codelineno-27-21" id="__codelineno-27-21" name="__codelineno-27-21"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;121F8B4D-3939-300D-BE22-979D6B476361&gt;<span class="w"> </span>/usr/lib/system/libsystem_configuration.dylib
</span><span id="__span-27-22"><a href="software/2023/05/06/linker/#__codelineno-27-22" id="__codelineno-27-22" name="__codelineno-27-22"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;7CE9526A-B673-363A-8905-71D080974C0E&gt;<span class="w"> </span>/usr/lib/system/libsystem_containermanager.dylib
</span><span id="__span-27-23"><a href="software/2023/05/06/linker/#__codelineno-27-23" id="__codelineno-27-23" name="__codelineno-27-23"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;54BF691A-0908-3548-95F2-34CFD58E5617&gt;<span class="w"> </span>/usr/lib/system/libsystem_coreservices.dylib
</span><span id="__span-27-24"><a href="software/2023/05/06/linker/#__codelineno-27-24" id="__codelineno-27-24" name="__codelineno-27-24"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;579733C7-851D-3B3E-83B5-FD203BA50D02&gt;<span class="w"> </span>/usr/lib/system/libsystem_darwin.dylib
</span><span id="__span-27-25"><a href="software/2023/05/06/linker/#__codelineno-27-25" id="__codelineno-27-25" name="__codelineno-27-25"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;4EFF0147-928F-3321-8268-655FE71DC209&gt;<span class="w"> </span>/usr/lib/system/libsystem_dnssd.dylib
</span><span id="__span-27-26"><a href="software/2023/05/06/linker/#__codelineno-27-26" id="__codelineno-27-26" name="__codelineno-27-26"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;5068382F-DC0F-3824-8ED5-18A24B35FEF9&gt;<span class="w"> </span>/usr/lib/system/libsystem_featureflags.dylib
</span><span id="__span-27-27"><a href="software/2023/05/06/linker/#__codelineno-27-27" id="__codelineno-27-27" name="__codelineno-27-27"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;4448FB99-7B1D-3E15-B7EE-3340FF0DA88D&gt;<span class="w"> </span>/usr/lib/system/libsystem_info.dylib
</span><span id="__span-27-28"><a href="software/2023/05/06/linker/#__codelineno-27-28" id="__codelineno-27-28" name="__codelineno-27-28"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;82E529F5-C4DF-3D42-9113-3A4F87FEF1A0&gt;<span class="w"> </span>/usr/lib/system/libsystem_m.dylib
</span><span id="__span-27-29"><a href="software/2023/05/06/linker/#__codelineno-27-29" id="__codelineno-27-29" name="__codelineno-27-29"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;0AC99C6E-CB01-30E5-AB10-65AB990652A5&gt;<span class="w"> </span>/usr/lib/system/libsystem_malloc.dylib
</span><span id="__span-27-30"><a href="software/2023/05/06/linker/#__codelineno-27-30" id="__codelineno-27-30" name="__codelineno-27-30"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;3B2CC4A9-A5EE-3627-8293-4AF4D891074E&gt;<span class="w"> </span>/usr/lib/system/libsystem_networkextension.dylib
</span><span id="__span-27-31"><a href="software/2023/05/06/linker/#__codelineno-27-31" id="__codelineno-27-31" name="__codelineno-27-31"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;E4AA6E5F-2501-3382-BFB3-64464E6D8254&gt;<span class="w"> </span>/usr/lib/system/libsystem_notify.dylib
</span><span id="__span-27-32"><a href="software/2023/05/06/linker/#__codelineno-27-32" id="__codelineno-27-32" name="__codelineno-27-32"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;99FDEFF2-36F1-3436-B8B2-DE0003B5A4BF&gt;<span class="w"> </span>/usr/lib/system/libsystem_sandbox.dylib
</span><span id="__span-27-33"><a href="software/2023/05/06/linker/#__codelineno-27-33" id="__codelineno-27-33" name="__codelineno-27-33"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;E529D1AC-D20A-3308-9033-E1712A9C655E&gt;<span class="w"> </span>/usr/lib/system/libsystem_secinit.dylib
</span><span id="__span-27-34"><a href="software/2023/05/06/linker/#__codelineno-27-34" id="__codelineno-27-34" name="__codelineno-27-34"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;42F503E2-9273-360A-A086-C1B19BBD3962&gt;<span class="w"> </span>/usr/lib/system/libsystem_kernel.dylib
</span><span id="__span-27-35"><a href="software/2023/05/06/linker/#__codelineno-27-35" id="__codelineno-27-35" name="__codelineno-27-35"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;F80C6971-C080-31F5-AB6E-BE01311154AF&gt;<span class="w"> </span>/usr/lib/system/libsystem_platform.dylib
</span><span id="__span-27-36"><a href="software/2023/05/06/linker/#__codelineno-27-36" id="__codelineno-27-36" name="__codelineno-27-36"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;46D35233-A051-3F4F-BBA4-BA56DDDC4D1A&gt;<span class="w"> </span>/usr/lib/system/libsystem_pthread.dylib
</span><span id="__span-27-37"><a href="software/2023/05/06/linker/#__codelineno-27-37" id="__codelineno-27-37" name="__codelineno-27-37"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;F9F1F4BE-D97F-37A7-8382-552C22DF1BB4&gt;<span class="w"> </span>/usr/lib/system/libsystem_symptoms.dylib
</span><span id="__span-27-38"><a href="software/2023/05/06/linker/#__codelineno-27-38" id="__codelineno-27-38" name="__codelineno-27-38"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;3F3E75B7-F0A7-30BB-9FD7-FD1307FE6055&gt;<span class="w"> </span>/usr/lib/system/libsystem_trace.dylib
</span><span id="__span-27-39"><a href="software/2023/05/06/linker/#__codelineno-27-39" id="__codelineno-27-39" name="__codelineno-27-39"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;E3BF7A76-2CBE-3DB9-8496-8BB6DBBE0CFC&gt;<span class="w"> </span>/usr/lib/system/libunwind.dylib
</span><span id="__span-27-40"><a href="software/2023/05/06/linker/#__codelineno-27-40" id="__codelineno-27-40" name="__codelineno-27-40"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;F3F19227-FF8F-389C-A094-6F4C16E458AF&gt;<span class="w"> </span>/usr/lib/system/libxpc.dylib
</span><span id="__span-27-41"><a href="software/2023/05/06/linker/#__codelineno-27-41" id="__codelineno-27-41" name="__codelineno-27-41"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;52AA13E2-567C-36C2-9494-7B892FDBF245&gt;<span class="w"> </span>/usr/lib/libc++abi.dylib
</span><span id="__span-27-42"><a href="software/2023/05/06/linker/#__codelineno-27-42" id="__codelineno-27-42" name="__codelineno-27-42"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;5BEAFA2B-3AF4-3ED2-B054-1F58A7C851EF&gt;<span class="w"> </span>/usr/lib/libobjc.A.dylib
</span><span id="__span-27-43"><a href="software/2023/05/06/linker/#__codelineno-27-43" id="__codelineno-27-43" name="__codelineno-27-43"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;FB664621-26AE-3F46-8F5A-DD5D890A5CE7&gt;<span class="w"> </span>/usr/lib/liboah.dylib
</span><span id="__span-27-44"><a href="software/2023/05/06/linker/#__codelineno-27-44" id="__codelineno-27-44" name="__codelineno-27-44"></a>dyld<span class="o">[</span><span class="m">17486</span><span class="o">]</span>:<span class="w"> </span>&lt;54E8FBE1-DF0D-33A2-B8FA-356565C12929&gt;<span class="w"> </span>/usr/lib/libc++.1.dylib
</span><span id="__span-27-45"><a href="software/2023/05/06/linker/#__codelineno-27-45" id="__codelineno-27-45" name="__codelineno-27-45"></a>Simple<span class="w"> </span><span class="k">function</span>
</span></code></pre></div>
<p>与 Linux 上的 <code>/etc/ld.so.cache</code> 类似，macOS 也针对动态库的加载做了优化，但是 macOS 做的更彻底：由于 macOS 的系统库是只读的，于是直接把所有系统库打包成一个文件，这个文件就是 dyld shared cache。可以用 <a href="https://github.com/keith/dyld-shared-cache-extractor">keith/dyld-shared-cache-extractor</a> 来还原出内部的 dylib。在 macOS Ventura 13.4 中，可以解出 2499 个动态库。</p>
<h3 id="relocation"><a class="toclink" href="software/2023/05/06/linker/#relocation">relocation</a></h3>
<p>链接器找到符号以后，就需要进行 relocation。在编译的时候，为了准备未来链接时的需要，提前做了一些准备：因为符号的地址还不知道，所以生成一条指令，指令的立即数内包括了符号的地址的信息，但此时还不知道立即数应该是多少，所以编译器把指令的立即数填充为 0，同时生成一个 relocation。当链接器看到 relocation 的时候，在已经排好所有符号的地址的时候，就可以按照 relocation 更新代码。</p>
<p>由于动态链接库可能会被加载到不同的基地址上，所以为了解决动态链接库内部的符号链接问题，采用 PIC 的方法，即通过指令本身的地址进行相对运算，计算出另一个符号的地址。这样动态链接库加载到不同地址的时候，内部的符号之间都可以正常引用，不需要修改指令，使得动态库可以在不同的进程间共享。</p>
<p>但是还需要考虑动态链接库使用了其他动态链接库的符号（全局变量）。这个时候，PIC 的方法失效了，因为无法确定其他动态链接库会加载到什么地址。此时的解决办法是用 GOT，程序在引用符号的时候，去 GOT 里查找实际的地址。动态链接器负责填 GOT 表的内容，这样动态库本身还是不会修改，只会修改 GOT。</p>
<p>如果动态链接库调用了其他动态链接库的函数，也可以用类似的方法，但是实践起来稍有不同。函数也在 GOT 表的 PLT 表里有实际的地址，但动态链接库不会自动替换，而是让编译器生成一个 PLT stub。PLT stub 做的事情是：</p>
<ol>
<li>如果初始化过，那么直接跳转到实际的函数</li>
<li>如果没有初始化过，调用 ld.so 提供的函数，函数会找到实际的函数，并且对 PLT 进行初始化</li>
</ol>
<p>这一系列的做法都是为了让动态库的大部分内容保持不变，只修改少部分数据使得 relocation 可以工作。完整的内容建议阅读<a href="https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html">PLT and GOT - the key to code sharing and dynamic libraries</a>。</p>
<h4 id="relocation-truncated-to-fit"><a class="toclink" href="software/2023/05/06/linker/#relocation-truncated-to-fit">relocation truncated to fit</a></h4>
<p>常见的 <code>relocation truncated to fit</code> 错误的意思是，链接器在进行 relocation 的时候，无法把想要的值填入到编译器预留的立即数里面。这是因为，编译器在编译的时候，其实不知道偏移具体是多少，那么这时候就可以选择用不同的指令序列，有的指令序列比较短，但是立即数位数也比较少；有的指令序列比较长，但是可以访问更大范围的偏移。如果编译器选择了比较小的范围，但是链接器链接的时候，发现放不下，就会出现 <code>relocation truncated to fit</code> 的错误。</p>
<p>解决方法，一是查看是否真的有那么大的偏移，例如是否不小心分配了一个超级大的全局数组，是的话是否砍掉一些大小；二是修改 Code Model，也就是让编译器选择更大的 Code Model，以更长的指令的代价，支持更大范围的 relocation。完整内容推荐阅读 <a href="https://maskray.me/blog/2023-05-14-relocation-overflow-and-code-models">Relocation overflow and code models by MaskRay</a>。</p>
<nav class="md-post__action">
<a href="software/2023/05/06/linker/">
        继续阅读
      </a>
</nav>
</div>
</article>
<nav class="md-pagination">
<span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a> <a class="md-pagination__link" href="page/3/">3</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="page/36/">36</a>
</nav>
</div>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="下一页: 关于" class="md-footer__link md-footer__link--next" href="about/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                关于
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/jiegec" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": ".", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "assets/javascripts/workers/search.780af0f4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="assets/javascripts/bundle.f11ae8b1.min.js"></script>
<script src="javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
</body>
</html>