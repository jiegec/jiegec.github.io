<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>杰哥的{运维,编程}小笔记</title>
    <description>This is the personal blog of Jiajie Chen, a NANO(uNix hAcker aNd lOver).
</description>
    <link>https://jiegec.me/</link>
    <atom:link href="https://jiegec.me/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Wed, 26 Sep 2018 21:26:50 +0800</pubDate>
    <lastBuildDate>Wed, 26 Sep 2018 21:26:50 +0800</lastBuildDate>
    <generator>Jekyll v3.6.2</generator>
    
      <item>
        <title>在 macOS 的 VirtualBox 上从 USB 启动</title>
        <description>&lt;p&gt;做了一个 Windows 10 安装 U 盘，想测试一下能不能启动，于是想用 VirtualBox 起一个虚拟机。但是发现，一般情况下要从 ISO 或者把 U 盘克隆成一个 vdi/vmdk etc 再启动。不过找到了 Cem Arslan 的 &lt;a href=&quot;https://www.linkedin.com/pulse/virtualbox-booting-from-usb-mac-cem-arslan&quot;&gt;VirtualBox - Booting From USB (MAC)&lt;/a&gt; 实验了一下，确实可以用，以 &lt;code class=&quot;highlighter-rouge&quot;&gt;/dev/disk2&lt;/code&gt; 为例方法如下：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;diskutil unmountDisk /dev/disk2
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;chown &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;whoami&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt; /dev/disk2
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;VBoxManage internalcommands createrawvmdk &lt;span class=&quot;nt&quot;&gt;-filename&lt;/span&gt; PATH_TO_VMDK &lt;span class=&quot;nt&quot;&gt;-rawdisk&lt;/span&gt; /dev/disk2
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Now boot from VirtualBox&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;对于其它平台，可以参考 Tu Nguyen 的 &lt;a href=&quot;https://www.aioboot.com/en/boot-from-usb-in-virtualbox/&quot;&gt;How to boot from USB in VirtualBox&lt;/a&gt; 。&lt;/p&gt;

&lt;p&gt;研究了一下生成的 vmdk 文件，大概是这样的：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Disk DescriptorFile
version=1
CID=12345678
parentCID=ffffffff
createType=&quot;fullDevice&quot;

# Extent description
RW 12345678 FLAT &quot;/dev/disk2&quot; 0

# The disk Data Base 
#DDB

ddb.virtualHWVersion = &quot;4&quot;
ddb.adapterType=&quot;ide&quot;
ddb.geometry.cylinders=&quot;1234&quot;
ddb.geometry.heads=&quot;1234&quot;
ddb.geometry.sectors=&quot;1234&quot;
ddb.uuid.image=&quot;12341234-1234-1234-1234-123412341234&quot;
ddb.uuid.parent=&quot;00000000-0000-0000-0000-000000000000&quot;
ddb.uuid.modification=&quot;00000000-0000-0000-0000-000000000000&quot;
ddb.uuid.parentmodification=&quot;00000000-0000-0000-0000-000000000000&quot;
ddb.geometry.biosCylinders=&quot;1234&quot;
ddb.geometry.biosHeads=&quot;1234&quot;
ddb.geometry.biosSectors=&quot;1234&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

</description>
        <pubDate>Fri, 14 Sep 2018 23:57:00 +0800</pubDate>
        <link>https://jiegec.me/os/2018/09/14/virtualbox-booting-from-usb-on-mac/</link>
        <guid isPermaLink="true">https://jiegec.me/os/2018/09/14/virtualbox-booting-from-usb-on-mac/</guid>
        
        <category>virtualbox</category>
        
        <category>macos</category>
        
        
        <category>os</category>
        
      </item>
    
      <item>
        <title>在 Ubuntu 上跨版本迁移 MongoDB</title>
        <description>&lt;p&gt;由于 MongoDB 只支持当前版本和上一个版本的数据库格式，然后刚刚滚系统升级的时候升级到了 3.6.x ，而数据库格式仍然是 3.2.x 的，于是需要先安装回 3.4.x 版本的 MongoDB，输入命令把数据库升级到 3.4.x 版本后，再用 3.6.x 的数据库进行升级。&lt;/p&gt;

&lt;p&gt;以 从 Ubuntu 14.04 LTS 升级到 Ubuntu 18.04.1 LTS 为例，方法如下：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-3.4.17.tgz
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;xvf mongodb-linux-x86_64-ubuntu1604-3.4.17.tgz
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;mongodb-linux-x86_64-ubuntu1604-3.4.17/bin/
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; ./mongod &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; /etc/mongodb.conf &amp;amp;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mongo
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; db.adminCommand&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; setFeatureCompatibilityVersion: &lt;span class=&quot;s1&quot;&gt;'3.4'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ok&quot;&lt;/span&gt; : 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;fg&lt;/span&gt;
^C
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;chown &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mongodb:mongodb /var/lib/mongodb
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start mongodb
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mongo
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; db.adminCommand&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; getParameter: 1, featureCompatibilityVersion: 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;featureCompatibilityVersion&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;version&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;3.4&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;ok&quot;&lt;/span&gt; : 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; db.adminCommand&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; setFeatureCompatibilityVersion: &lt;span class=&quot;s1&quot;&gt;'3.6'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ok&quot;&lt;/span&gt; : 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; db.adminCommand&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; getParameter: 1, featureCompatibilityVersion: 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;featureCompatibilityVersion&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;version&quot;&lt;/span&gt; : &lt;span class=&quot;s2&quot;&gt;&quot;3.6&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;ok&quot;&lt;/span&gt; : 1 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Okay now&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
</description>
        <pubDate>Thu, 13 Sep 2018 14:27:00 +0800</pubDate>
        <link>https://jiegec.me/software/2018/09/13/migrate-mongodb-on-ubuntu/</link>
        <guid isPermaLink="true">https://jiegec.me/software/2018/09/13/migrate-mongodb-on-ubuntu/</guid>
        
        <category>mongodb</category>
        
        <category>ubuntu</category>
        
        
        <category>software</category>
        
      </item>
    
      <item>
        <title>通过 SSH 隧道连接 ADB 和 Android 设备</title>
        <description>&lt;p&gt;由于本机算力不足，想要在远程&lt;a href=&quot;/programming/2018/06/18/building-lineageos-in-archlinux/&quot;&gt;编译 LineageOS&lt;/a&gt; ，其中有一步需要连接到已有的设备，于是突发奇想：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;adb 可以通过 网络连接&lt;/li&gt;
  &lt;li&gt;ssh 可以进行端口转发，这里是把 remote 的端口转发到 Android 设备上的端口。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;方法如下：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb shell ip &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; inet addr show wlan0
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# remember the ip address here&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb tcpip PORT1
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; PORT2:ANDROID_IP:PORT1 REMOTE
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;remote&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb connect localhost:PORT2 &lt;span class=&quot;c&quot;&gt;# trust this device on Android&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;参考文档：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/a/3623727&quot;&gt;How can I connect to Android with ADB over TCP?&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.ssh.com/ssh/tunneling/example&quot;&gt;SSH PORT FORWARDING EXAMPLE&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
        <pubDate>Thu, 13 Sep 2018 13:20:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/09/13/adb-over-ssh-tunnel/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/09/13/adb-over-ssh-tunnel/</guid>
        
        <category>ssh</category>
        
        <category>adb</category>
        
        <category>forwarding</category>
        
        
        <category>networking</category>
        
      </item>
    
      <item>
        <title>在 LEDE （OpenWrt） 上启用 wpad</title>
        <description>&lt;p&gt;WPAD（Web Proxy Auto-Discovery Protocol）是一个可以利用 dhcp 分发 pac 配置的协议。方法如下：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# ssh to router first&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;vim /etc/dnsmasq.conf
dhcp-option&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;252,&lt;span class=&quot;s2&quot;&gt;&quot;http://router_ip/wpad.dat&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;vim /www/wpad.dat &lt;span class=&quot;c&quot;&gt;# put pac here&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;service dnsmasq restart
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# ensure proxy is available to lan&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# enable wpad on devices&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;参考文档：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Web_Proxy_Auto-Discovery_Protocol&quot;&gt;Web Proxy Auto-Discovery Protocol&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.davidpashley.com/articles/automatic-proxy-configuration-with-wpad/&quot;&gt;Automatic Proxy Configuration with WPAD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://findproxyforurl.com/deploying-wpad/&quot;&gt;Deploying WPAD&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://findproxyforurl.com/example-pac-file/&quot;&gt;Example PAC File&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
        <pubDate>Tue, 11 Sep 2018 23:23:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/09/11/enable-wpad-on-lede/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/09/11/enable-wpad-on-lede/</guid>
        
        <category>lede</category>
        
        <category>openwrt</category>
        
        <category>wpad</category>
        
        <category>pac</category>
        
        
        <category>networking</category>
        
      </item>
    
      <item>
        <title>在 Xcode 9 上启用 Vim 模拟（XVim 2）</title>
        <description>&lt;p&gt;作为一个不用 vim 编辑会死星人，用 Xcode 总是止不住自己想 Escape 的心。于是找到了 &lt;a href=&quot;https://github.com/XVimProject/XVim&quot;&gt;XVimProject/XVim2&lt;/a&gt; 进行配置。&lt;/p&gt;

&lt;p&gt;大致方法如下：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;按照 &lt;a href=&quot;https://github.com/XVimProject/XVim2/blob/master/SIGNING_Xcode.md&quot;&gt;Signing Xcode&lt;/a&gt; 对 Xcode 进行重签名。套路和对 GDB 进行签名一样。不过这次，签名完成的时间可长多了，毕竟 Xcode 这么大。&lt;/li&gt;
  &lt;li&gt;接着按照项目的 README ，首先 &lt;code class=&quot;highlighter-rouge&quot;&gt;git clone&lt;/code&gt; 然后 &lt;code class=&quot;highlighter-rouge&quot;&gt;make&lt;/code&gt; ，第一次打开 Xcode 的时候选择 &lt;code class=&quot;highlighter-rouge&quot;&gt;Load Bundle&lt;/code&gt; 即可。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;终于可以满足我 Escape Xcode 的欲望了。&lt;/p&gt;
</description>
        <pubDate>Sat, 08 Sep 2018 02:01:00 +0800</pubDate>
        <link>https://jiegec.me/software/2018/09/08/enable-vim-mode-in-xcode-9/</link>
        <guid isPermaLink="true">https://jiegec.me/software/2018/09/08/enable-vim-mode-in-xcode-9/</guid>
        
        <category>xcode</category>
        
        <category>vim</category>
        
        <category>xvim</category>
        
        
        <category>software</category>
        
      </item>
    
      <item>
        <title>在 macOS 上读取移动硬盘的 S.M.A.R.T. 信息</title>
        <description>&lt;p&gt;之前想看看自己各个盘的情况，但是发现只能看电脑内置的 SSD 的 S.M.A.R.T 信息，而移动硬盘的都显示：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ smartctl -a /dev/disk2
smartctl 6.6 2017-11-05 r4594 [Darwin 17.7.0 x86_64] (local build)
Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org

/dev/disk2: Unable to detect device type
Please specify device type with the -d option.

Use smartctl -h to get a usage summary
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;一开始我怀疑是个别盘不支持，但换了几个盘都不能工作，问题应该出现在了 USB 上。查了下资料，果然如此。根据 &lt;a href=&quot;https://www.smartmontools.org/wiki/USB&quot;&gt;USB devices and smartmontools&lt;/a&gt; ，获取 S.M.A.R.T 信息需要直接发送 ATA 命令，但是由于经过了 USB ，于是需要进行一个转换，导致无法直接发送 ATA 命令。这个问题自然是有解决方案，大概就是直接把 ATA 命令发送过去（pass-through）。上面这个地址里写到，如果需要在 macOS 上使用，需要安装一个内核驱动。可以找到，源码在 &lt;a href=&quot;https://github.com/kasbert/OS-X-SAT-SMART-Driver&quot;&gt;kasbert/OS-X-SAT-SMART-Driver&lt;/a&gt; 并且有一个带签名的安装包在 &lt;a href=&quot;https://binaryfruit.com/drivedx/usb-drive-support&quot;&gt;External USB / FireWire drive diagnostics support&lt;/a&gt; 中可以下载。丢到 VirusTotal 上没查出问题，用 v0.8 版本安装好后就成功地读取到了移动硬盘的 S.M.A.R.T 信息了。&lt;/p&gt;

&lt;p&gt;然后我又简单研究了一下各个 S.M.A.R.T 各个值的含义是什么。 &lt;code class=&quot;highlighter-rouge&quot;&gt;VALUE&lt;/code&gt; 代表当前的值， &lt;code class=&quot;highlighter-rouge&quot;&gt;WORST&lt;/code&gt; 代表目前检测到的最差的值， &lt;code class=&quot;highlighter-rouge&quot;&gt;THRESH&lt;/code&gt; 代表损坏阈值。这些值都是从 &lt;code class=&quot;highlighter-rouge&quot;&gt;RAW_VALUE&lt;/code&gt; 进行计算后归一化而来。然后 &lt;code class=&quot;highlighter-rouge&quot;&gt;TYPE&lt;/code&gt; 分为两种，一是 &lt;code class=&quot;highlighter-rouge&quot;&gt;Pre-fail&lt;/code&gt; ，代表如果这一项的值小于阈值，代表这个机器很危险了，赶紧拷数据丢掉吧。二是 &lt;code class=&quot;highlighter-rouge&quot;&gt;Old_age&lt;/code&gt; ，代表如果这一项小于阈值，代表这个机器比较老了，但还没坏。真正要看是否坏了，可以看 &lt;code class=&quot;highlighter-rouge&quot;&gt;When_Failed&lt;/code&gt; 一栏。&lt;/p&gt;
</description>
        <pubDate>Fri, 07 Sep 2018 10:20:00 +0800</pubDate>
        <link>https://jiegec.me/hardware/2018/09/07/reading-smart-info-of-external-drives-under-macOS/</link>
        <guid isPermaLink="true">https://jiegec.me/hardware/2018/09/07/reading-smart-info-of-external-drives-under-macOS/</guid>
        
        <category>smart</category>
        
        <category>macos</category>
        
        <category>smartmontools</category>
        
        <category>kext</category>
        
        
        <category>hardware</category>
        
      </item>
    
      <item>
        <title>通过 Ipfilter Extension 实现 RFC8367</title>
        <description>&lt;p&gt;前几天无聊闲逛看到了一个很有趣的 &lt;a href=&quot;https://tools.ietf.org/html/rfc8367&quot;&gt;RFC8367 - Wrongful Termination of Internet Protocol (IP) Packets&lt;/a&gt; ，看到日期大家应该都懂了，这是个粥客，不过里面还是反映了一些事情，咳。&lt;/p&gt;

&lt;p&gt;之前看到闪客实现了 &lt;a href=&quot;https://github.com/shankerwangmiao/xt_PROTO&quot;&gt;shankerwangmiao/xt_PROTO&lt;/a&gt; ，想到自己也可以做一个 iptables 扩展，于是就写了 &lt;a href=&quot;https://github.com/jiegec/xt_EQUALIZE&quot;&gt;jiegec/xt_EQUALIZE&lt;/a&gt; 。它是这样使用的：&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git clone git@github.com:jiegec/xt_EQUALIZE.git
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;make install
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; filter &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; INPUT &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; EQUALIZE
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;dmesg &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; &amp;amp;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Make some random network requests to see the effect!&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ping 1.1.1.1
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ping 8.8.8.8
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ping ::1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;目前还没有把参数都变成可以配置的。如果真的有人需要这个模块的话，我再改吧（逃&lt;/p&gt;
</description>
        <pubDate>Fri, 31 Aug 2018 15:47:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/08/31/implementing-rfc8367-as-iptables-extension/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/08/31/implementing-rfc8367-as-iptables-extension/</guid>
        
        <category>rfc</category>
        
        <category>rfc8367</category>
        
        <category>aprilfool</category>
        
        <category>iptables</category>
        
        <category>kernel</category>
        
        <category>mod</category>
        
        <category>xtables</category>
        
        
        <category>networking</category>
        
      </item>
    
      <item>
        <title>在 macOS 上 TAP Interface 上启用 IPv6 自动配置</title>
        <description>&lt;p&gt;由于 macOS 对 TAP Interface 不会自动出现一个设置中对应的服务，所以需要手动进行配置。一番测试后，发现可以通过：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo ipconfig set [tap_if] automatic-v6
$ sudo ipconfig set [tap_if] dhcp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;启用系统自带的 dhcp 和 ra 功能。也许有方法可以把这些 tap 搬到系统的设置中去。&lt;/p&gt;

&lt;p&gt;UPDATE:&lt;/p&gt;

&lt;p&gt;可以把 TAP Interface 加到系统的设置中去。方法参考&lt;a href=&quot;https://stackoverflow.com/a/6375307&quot;&gt;Virtual network interface in Mac OS X&lt;/a&gt;。完成以后可以直接通过系统设置界面进行配置。&lt;/p&gt;
</description>
        <pubDate>Sat, 25 Aug 2018 19:07:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/08/25/enable-ipv6-autoconfiguration-on-tap-interfaces-in-macos/</guid>
        
        <category>slacc</category>
        
        <category>ipv6</category>
        
        <category>tuntaposx</category>
        
        <category>tap</category>
        
        
        <category>networking</category>
        
      </item>
    
      <item>
        <title>在 macOS 下实现 GRETAP</title>
        <description>&lt;p&gt;由于没有找到 macOS 下现成的 GRETAP 实现，我就想到自己实现一个。由于&lt;a href=&quot;http://tuntaposx.sourceforge.net/&quot;&gt;tuntaposx&lt;/a&gt;提供了一个和 Linux 下基本一样的 TAP Interface，于是自己利用 raw socket 和 TAP Interface 实现了一下，主要方法：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;打开 raw socket ，读取收到的 proto 47 的包，判断是否为 GRETAP 包，是，则写入内层包到打开的 TAP Interface 中。&lt;/li&gt;
  &lt;li&gt;从 TAP Interface 中读入包，自己加上 GRE 头和 IP 头，然后发送。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;主要的难度是在 raw socket 部分，macOS 继承了 BSD ，与 Linux 不大一样。于是参考了&lt;a href=&quot;https://sock-raw.org/papers/sock_raw&quot;&gt;SOCK_RAW Demystified&lt;/a&gt;，成功地实现了这个功能。&lt;/p&gt;

&lt;p&gt;代码放在&lt;a href=&quot;https://github.com/jiegec/gretapmac&quot;&gt;jiegec/gretapmac&lt;/a&gt;。写得并不高效，仅仅可用，用了一百多行。&lt;/p&gt;

&lt;p&gt;UPDATE: 之后又随手实现了一个类似的协议，L2TPv3 over UDP。代码在&lt;a href=&quot;https://github.com/jiegec/l2tpv3udptap&quot;&gt;jiegc/l2tpv3udptap&lt;/a&gt;。&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Aug 2018 09:42:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/08/21/implementing-gretap-in-macos/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/08/21/implementing-gretap-in-macos/</guid>
        
        <category>tuntaposx</category>
        
        <category>tap</category>
        
        <category>gre</category>
        
        <category>gretap</category>
        
        
        <category>networking</category>
        
      </item>
    
      <item>
        <title>在 WireGuard 构建的 Overlay Network 上跑 babel 路由协议</title>
        <description>&lt;p&gt;受 &lt;a href=&quot;https://fugoes.github.io/computer/network/2018/02/03/Run-Babeld-over-Wireguard.html&quot;&gt;Run Babeld over Wireguard - Fugoes’s Blog&lt;/a&gt; 和 &lt;a href=&quot;https://vincent.bernat.im/en/blog/2018-route-based-vpn-wireguard&quot;&gt;Route-based VPN on Linux with WireGuard&lt;/a&gt; 启发，自己也想尝试一下，在一个有多个结点的网络中，如何通过 WireGuard 构建一个 overlay network，并通过 babel 自动进行结点发现和路径选择。&lt;/p&gt;

&lt;p&gt;首先建立点对点的 WireGuard Tunnel 。由于我们用 babel 进行路由，所以我们不能采用 Wiregurad 本身基于目的地址的端口复用，所以每一个 WireGuard interface 都只有一个 Peer 。&lt;/p&gt;

&lt;p&gt;配置一个点对点的 WireGuard Tunnel：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ # for wg-quick
$ cat wg0.conf
[Interface]
Address = IPV4/32, fe80::ID/64
PrivateKey = REDACTED
ListenPort = PORT1
Table = off # ask wg-quick not to insert peer address into routing table

[Peer]
PublicKey = REDACTED
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = REDACTED:PORT2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里的 IPV4 和 ID 在同一设备上的不同 WireGuard Tunnel 上相同。只是通过 wg interface 编号来区分。&lt;/p&gt;

&lt;p&gt;接着配置 babeld ：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ cat babeld.conf

router-id ID
local-port 33123 # for babelweb2

# one line for each wg interface
interface wg0 type tunnel rtt-max 512

redistribute ip PREFIX/LEN ge LEN le 32 local allow # tunnel neighbors
redistribute proto 42 # routes installed by babeld
redistribute local deny
# consult babeld man page for more
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后通过 BabelWeb2 （很难用）进行可视化，然后通过手动触发一些网络波动即可达到效果。&lt;/p&gt;
</description>
        <pubDate>Fri, 10 Aug 2018 09:17:00 +0800</pubDate>
        <link>https://jiegec.me/networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/</link>
        <guid isPermaLink="true">https://jiegec.me/networking/2018/08/10/use-babel-in-overlay-network-with-wireguard/</guid>
        
        <category>wireguard</category>
        
        <category>babel</category>
        
        <category>routing</category>
        
        <category>go</category>
        
        
        <category>networking</category>
        
      </item>
    
  </channel>
</rss>
