<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>infiniband on 杰哥的{运维,编程,调板子}小笔记</title>
    <link>https://jia.je/tags/infiniband/</link>
    <description>Recent content in infiniband on 杰哥的{运维,编程,调板子}小笔记</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 06 Dec 2022 18:47:00 +0800</lastBuildDate><atom:link href="https://jia.je/tags/infiniband/feed.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>InfiniBand 学习笔记</title>
      <link>https://jia.je/hardware/2022/12/06/infiniband-notes/</link>
      <pubDate>Tue, 06 Dec 2022 18:47:00 +0800</pubDate>
      
      <guid>https://jia.je/hardware/2022/12/06/infiniband-notes/</guid>
      <description>本文的内容已经整合到知识库中。
参考文献 Infiniband Architecture Overview InfiniBand Architecture Specification Volume 1 Release 1.2.1 InfiniBand Architecture Specification Volume 2 Release 1.4 An Introduction to the InfiniBand Architecture InfiniBand Network Architecture - MindShare ArchWiki - InfiniBand 概览 InfiniBand 的网络分为两层，第一层是由 End Node 和 Switch 组成的 Subnet，第二层是由 Router 连接起来的若干个 Subnet。有点类似以太网以及 IP 的关系，同一个二层内通过 MAC 地址转发，三层间通过 IP 地址转发。
在 IB 网络中，End Node 一般是插在结点上的 IB 卡（Host Channel Adapter，HCA）或者是存储结点上的 Target Channel Adapter。End Node 之间通过 Switch 连接成一个 Subnet，由 Subnet Manager 给每个 Node 和 Switch 分配 Local ID，同一个 Subnet 中通过 LID（Local ID）来路由。但是 LID 位数有限，为了进一步扩展，可以用 Router 连接多个 Subnet，此时要通过 GID（Global ID）来路由。</description>
    </item>
    
    <item>
      <title>升级 Mellanox 网卡固件</title>
      <link>https://jia.je/hardware/2022/11/23/upgrade-mlnx-firmware/</link>
      <pubDate>Wed, 23 Nov 2022 19:24:00 +0800</pubDate>
      
      <guid>https://jia.je/hardware/2022/11/23/upgrade-mlnx-firmware/</guid>
      <description>背景 最近发现有一台机器，插上 ConnectX-4 IB 网卡后，内核模块可以识别到设备，但是无法使用，现象是 ibstat 等命令都看不到设备。降级 OFED 从 5.8 到 5.4 以后问题消失，所以认为可能是新的 OFED 与比较旧的固件版本有兼容性问题，所以尝试升级网卡固件。升级以后，问题就消失了。
安装 MFT 首先，在 https://network.nvidia.com/products/adapter-software/firmware-tools/ 下载 MFT，按照指示解压，安装后，启动 mst 服务，就可以使用 mlxfwmanager 得到网卡的型号以及固件版本：
Device Type: ConnectX4 Description: Mellanox ConnectX-4 Single Port EDR PCIE Adapter LP PSID: DEL2180110032 Versions: Current FW 12.20.1820 升级固件 从 PSID 可以看到，这是 DELL OEM 版本的网卡，可以在 https://network.nvidia.com/support/firmware/dell/ 处寻找最新固件，注意需要保证 PSID 一致，可以找到这个 PSID 的 DELL 固件地址：https://www.mellanox.com/downloads/firmware/fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin.zip。
下载以后，解压，然后就可以升级固件：
mlxfwmanager -u -i fw-ConnectX4-rel-12_28_4512-06W1HY_0JJN39_Ax-FlexBoot-3.6.203.bin 升级以后重启就工作了。
考虑到类似的情况之后还可能发生，顺便还升级了其他几台机器的网卡，下面是一个例子：
Device Type: ConnectX4 Description: ConnectX-4 VPI adapter card; FDR IB (56Gb/s) and 40GbE; dual-port QSFP28; PCIe3.</description>
    </item>
    
    <item>
      <title>切换 ConnectX-4 为以太网模式</title>
      <link>https://jia.je/software/2022/07/02/connectx-4-switch-to-ethernet/</link>
      <pubDate>Sat, 02 Jul 2022 20:26:00 +0800</pubDate>
      
      <guid>https://jia.je/software/2022/07/02/connectx-4-switch-to-ethernet/</guid>
      <description>背景 最近在给机房配置网络，遇到一个需求，就是想要把 ConnectX-4 当成以太网卡用，它既支持 Infiniband，又支持 Ethernet，只不过默认是 Infiniband 模式，所以需要用 mlxconfig 工具来做这个切换。
切换方法 在 Using mlxconfig 文档中，写了如何切换网卡为 Infiniband 模式：
$ mlxconfig -d /dev/mst/mt4103_pci_cr0 set LINK_TYPE_P1=1 LINK_TYPE_P2=1 Device #1: ---------- Device type: ConnectX3Pro PCI device: /dev/mst/mt4103_pci_cr0 Configurations: Next Boot New LINK_TYPE_P1 ETH(2) IB(1) LINK_TYPE_P2 ETH(2) IB(1) Apply new Configuration? ? (y/n) [n] : y Applying... Done! -I- Please reboot machine to load new configurations. 那么，我们只需要反其道而行之，设置模式为 ETH(2) 即可。
MST 安装 要使用 mlxconfig，就需要安装 MFT(Mellanox Firmware Tools)。我们用的是 Debian bookworm，于是要下载 DEB：</description>
    </item>
    
  </channel>
</rss>
