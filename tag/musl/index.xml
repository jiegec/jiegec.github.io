<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 <title>Tag - musl</title>
 <link href="https://jiege.ch/tag/musl/index.xml" rel="self"/>
 <link href="https://jiege.ch/tag/musl.html"/>
 <updated>2019-04-20T22:45:42+08:00</updated>
 <id>https://jiege.ch/tag/musl.html</id>
 <author>
   <name>Jiege Chen</name>
 </author>
 
 <entry>
   <title>静态编译 sqlite3</title>
   <link href="https://jiege.ch/software/2019/03/24/static-building-sqlite/"/>
   <updated>2019-03-24T19:13:00+08:00</updated>
   <id>https://jiege.ch/software/2019/03/24/static-building-sqlite</id>
   <content type="html">&lt;p&gt;最近 rCore 支持了动态链接库，于是想着在测试 sqlite 的时候直接用动态的，不过出现了玄学的问题，它会访问一个不存在的地址，看代码也没看出个所以然来。所以研究了一下 sqlite 的静态编译。首先在 &lt;code class=&quot;highlighter-rouge&quot;&gt;configure&lt;/code&gt; 的时候尝试了一下：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./configure &lt;span class=&quot;nv&quot;&gt;CC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;x86_64-linux-musl-gcc &lt;span class=&quot;nt&quot;&gt;--disable-shared&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--enabled-static&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;发现 &lt;code class=&quot;highlighter-rouge&quot;&gt;libsqlite&lt;/code&gt; 确实是静态了，但是 &lt;code class=&quot;highlighter-rouge&quot;&gt;sqlite3&lt;/code&gt; 并不是。一番研究以后，发现是 &lt;code class=&quot;highlighter-rouge&quot;&gt;libtool&lt;/code&gt; 的原因，只要这样编译：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make &lt;span class=&quot;nv&quot;&gt;LTLINK_EXTRAS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-all-static&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;就可以编译出静态的 &lt;code class=&quot;highlighter-rouge&quot;&gt;sqlite3&lt;/code&gt; ：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sqlite3: ELF 64-bit LSB executable, x86-64, version 1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, statically linked, with debug_info, not stripped
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

</content>
 </entry>
 
 <entry>
   <title>交叉编译 Nginx 1.14.2 到 RISC-V</title>
   <link href="https://jiege.ch/software/2019/03/22/cross-compiling-nginx-to-riscv/"/>
   <updated>2019-03-22T23:18:00+08:00</updated>
   <id>https://jiege.ch/software/2019/03/22/cross-compiling-nginx-to-riscv</id>
   <content type="html">&lt;p&gt;最近又把一定的精力放到了 RISC-V 64 上的 rCore 用户态程序的支持上，同时也借到了 HiFive Unleashed 板子，所以有真实硬件可以拿来跑了。在这之前先在 QEMU 上把能跑的都跑起来。&lt;/p&gt;

&lt;p&gt;由于 rCore 对 glibc 的支持一直有问题，RISC-V 也不例外，所以还是选择用 musl 来做这件事情。一般搜索，终于找到了 Linux 下能用的 &lt;a href=&quot;https://github.com/rv8-io/musl-riscv-toolchain&quot;&gt;musl-riscv-toolchain&lt;/a&gt; 。编译好工具链以后，很多需要 libc 的用户态都能跑了，于是想着试一下 nginx 的编译。试着编译了一下，遇到了各种问题，最后搜到了&lt;a href=&quot;https://www.jianshu.com/p/5d9b60f7b262&quot;&gt;交叉编译Hi3536上面使用的nginx&lt;/a&gt;，里面的方法解决了这个问题。最后总结出了这样的 patch :&lt;/p&gt;

&lt;div class=&quot;language-diff highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff --git a/nginx-1.14.2/auto/cc/name b/nginx-1.14.2/auto/cc/name
index ded93f5..d6ab27a 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/nginx-1.14.2/auto/cc/name
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/nginx-1.14.2/auto/cc/name
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -7,7 +7,7 @@ if [ &quot;$NGX_PLATFORM&quot; != win32 ]; then
&lt;/span&gt; 
     ngx_feature=&quot;C compiler&quot;
     ngx_feature_name=
&lt;span class=&quot;gd&quot;&gt;-    ngx_feature_run=yes
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+    ngx_feature_run=no
&lt;/span&gt;     ngx_feature_incs=
     ngx_feature_path=
     ngx_feature_libs=
&lt;span class=&quot;gh&quot;&gt;diff --git a/nginx-1.14.2/auto/lib/openssl/make b/nginx-1.14.2/auto/lib/openssl/make
index 126a238..7a0e768 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/nginx-1.14.2/auto/lib/openssl/make
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/nginx-1.14.2/auto/lib/openssl/make
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -51,7 +51,7 @@ END
&lt;/span&gt; $OPENSSL/.openssl/include/openssl/ssl.h:	$NGX_MAKEFILE
 	cd $OPENSSL \\
 	&amp;amp;&amp;amp; if [ -f Makefile ]; then \$(MAKE) clean; fi \\
&lt;span class=&quot;gd&quot;&gt;-	&amp;amp;&amp;amp; ./config --prefix=$ngx_prefix no-shared no-threads $OPENSSL_OPT \\
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+	&amp;amp;&amp;amp; ./config --prefix=$ngx_prefix no-shared no-threads --cross-compile-prefix=riscv64-linux-musl- $OPENSSL_OPT \\
&lt;/span&gt; 	&amp;amp;&amp;amp; \$(MAKE) \\
 	&amp;amp;&amp;amp; \$(MAKE) install_sw LIBDIR=lib
 
&lt;span class=&quot;gh&quot;&gt;diff --git a/nginx-1.14.2/auto/types/sizeof b/nginx-1.14.2/auto/types/sizeof
index 480d8cf..52c7287 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/nginx-1.14.2/auto/types/sizeof
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/nginx-1.14.2/auto/types/sizeof
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -33,7 +33,7 @@ int main(void) {
&lt;/span&gt; END
 
 
&lt;span class=&quot;gd&quot;&gt;-ngx_test=&quot;$CC $CC_TEST_FLAGS $CC_AUX_FLAGS \
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+ngx_test=&quot;gcc $CC_TEST_FLAGS $CC_AUX_FLAGS \
&lt;/span&gt;           -o $NGX_AUTOTEST $NGX_AUTOTEST.c $NGX_LD_OPT $ngx_feature_libs&quot;
 
 eval &quot;$ngx_test &amp;gt;&amp;gt; $NGX_AUTOCONF_ERR 2&amp;gt;&amp;amp;1&quot;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;接着，在 &lt;code class=&quot;highlighter-rouge&quot;&gt;./configure --with-cc=riscv64-linux-musl-gcc --with-cc-opt=-static --with-ld-opt=-static --without-pcre --without-http_rewrite_module --without-http_gzip_module --with-poll_module --without-http_upstream_zone_module&lt;/code&gt; 之后，修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;objs/ngx_auto_config.h&lt;/code&gt;，加入：&lt;/p&gt;

&lt;div class=&quot;language-c highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#ifndef NGX_SYS_NERR
#define NGX_SYS_NERR  132
#endif
&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#ifndef NGX_HAVE_SYSVSHM
#define NGX_HAVE_SYSVSHM 1
#endif
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;接着就可以正常编译了：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;file objs/nginx
objs/nginx: ELF 64-bit LSB executable, UCB RISC-V, version 1 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SYSV&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, statically linked, with debug_info, not stripped
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

</content>
 </entry>
 
</feed>
