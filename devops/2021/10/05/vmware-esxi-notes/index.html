<!DOCTYPE html>
<html>
<head>
    <title>ESXi 常用信息 // 杰哥的{运维,编程,调板子}小笔记</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="ESXi 常用信息" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en" />
    <meta property="og:url" content="https://jia.je/devops/2021/10/05/vmware-esxi-notes/" />
    

    <link rel="shortcut icon" href="/favicon.ico">

    <link href="https://jia.je/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://jia.je/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://jia.je/css/style.css">
    

    <meta name="generator" content="Hugo 0.94.2" />
</head>


<body>
<div id="container">
    <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://jia.je/">杰哥的{运维,编程,调板子}小笔记</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="/about/">关于</a>
                
                <a class="main-nav-link" href="/category/">分类</a>
                
                <a class="main-nav-link" href="/tools/">工具</a>
                
                <a class="main-nav-link" href="/open-source-contributions/">开源</a>
                
                <a class="main-nav-link" href="/tags/">标签</a>
                
                <a class="main-nav-link" href="/feed.xml">订阅</a>
                
                <a class="main-nav-link" href="/projects/readme/">项目</a>
                
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>
</header>

    <section id="main" class="outer">
        <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">ESXi 常用信息</h1>
        </header>
        
        <div class="article-meta">
            <a href="/devops/2021/10/05/vmware-esxi-notes/" class="article-date">
                <time datetime='2021-10-05T21:19:00.000&#43;08:00' itemprop="datePublished">2021-10-05</time>
            </a>
            
            
            
            <div class="article-comment-link-wrap">
                <a href="/devops/2021/10/05/vmware-esxi-notes/#disqus_thread" class="article-comment-link">Comments</a>
            </div>
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <h2 id="常用链接">常用链接</h2>
<ul>
<li><a href="http://blog.erben.sk/2020/02/04/how-to-check-cpu-microcode-revision-in-esxi/">检查 CPU microcode 版本</a>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vsish -e cat /hardware/cpu/cpuList/0 | grep -i -E <span style="color:#e6db74">&#39;family|model|stepping|microcode|revision&#39;</span>
</span></span></code></pre></div><ul>
<li><a href="https://kb.vmware.com/s/article/56145">ESXi 从 6.7 到 6.7U1 升级时出现版本问题</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/6_7#custom_iso">ESXi 6.7 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/downloads/info/slug/datacenter_cloud_infrastructure/vmware_vsphere/7_0#custom_iso">ESXi 7.0 OEM 版本下载</a></li>
<li><a href="https://customerconnect.vmware.com/en/web/vmware/evalcenter?p=free-esxi7">ESXi 7.0 标准版下载</a></li>
<li><a href="https://flings.vmware.com/community-networking-driver-for-esxi/comments">NUC 11 ESXi 7.0 网卡支持</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ esxcli software vib install -d $PWD/Net-Community-Driver_1.2.0.0-1vmw.700.1.0.15843807_18028830.zip
</span></span></code></pre></div><h2 id="离线升级方法">离线升级方法</h2>
<ol>
<li>下载 Offline Bundle 文件</li>
<li>上传到 ESXi datastore 中</li>
<li>在 <code>/vmfs/volumes/</code> 里找到更新文件</li>
<li>查询 profile 列表 <code>esxcli software sources profile list -d &lt;zip&gt;</code></li>
<li>更新到 profile <code>esxcli software profile update -p &lt;profile&gt; -d &lt;zip&gt;</code></li>
</ol>
<p>ref: <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-E51C5DB6-F28E-42E8-ACA4-0EBDD11DF55D.html">Upgrade or Update a Host with Image Profiles</a></p>
<p>如果 CPU 比较旧，可能会有警告：<a href="https://kb.vmware.com/s/article/82794">Updated Plan for CPU Support Discontinuation In Future Major vSphere Releases</a>，按照信息添加参数忽略即可，ESXi 7.0 系列都是支持的，如果之后出了新的版本可能不支持。</p>
<h2 id="在线升级方法">在线升级方法</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ esxcli network firewall ruleset set -e true -r httpClient
</span></span><span style="display:flex;"><span><span style="color:#75715e"># find profile name</span>
</span></span><span style="display:flex;"><span>$ esxcli software sources profile list -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># upgrade to 7.0u3 for example</span>
</span></span><span style="display:flex;"><span>$ esxcli software profile update -p ESXi-7.0U3-18644231-standard -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml
</span></span></code></pre></div><p>ref: <a href="https://docs.macstadium.com/docs/update-standalone-esxi-host-via-online-bundle">Update Standalone ESXi Host</a></p>
<h2 id="防火墙">防火墙</h2>
<p>列出所有防火墙规则：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ esxcli network firewall ruleset list
</span></span></code></pre></div><p>允许出站 SSH：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ esxcli network firewall ruleset set --enabled<span style="color:#f92672">=</span>true --ruleset-id<span style="color:#f92672">=</span>sshClient
</span></span></code></pre></div><p>关闭出站 SSH：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ esxcli network firewall ruleset set --enabled<span style="color:#f92672">=</span>false --ruleset-id<span style="color:#f92672">=</span>sshClient
</span></span></code></pre></div><h2 id="nuc11i5-esxi-70-安装过程">NUC11i5 ESXi 7.0 安装过程</h2>
<ol>
<li>下载 ESXi ISO 文件，用 UNetbootin 制作安装盘</li>
<li>插入 U 盘，在 NUC 上安装 ESXi，在 81% 的时候卡住了，不管直接重启</li>
<li>用 root 无密码登录进去，然后重置网络设置</li>
<li>配置 usb 网卡，然后通过网页访问 ESXi，打开 SSH</li>
<li>下载 Fling 上面的社区网卡支持，用 esxcli 安装</li>
<li>重启以后，就可以看到 vmnic0 网卡了</li>
</ol>
<p>参考：<a href="https://www.virten.net/2020/07/solution-esxi-installation-with-usb-nic-only-fails-at-81/">Solution: ESXi Installation with USB NIC only fails at 81%</a></p>
<h2 id="推荐博客">推荐博客</h2>
<p>发现以下博客有很多关于 ESXi 的内容：</p>
<ul>
<li><a href="https://williamlam.com/">https://williamlam.com/</a></li>
<li><a href="https://www.virten.net/">https://www.virten.net/</a></li>
</ul>
<h2 id="重要版本更新">重要版本更新</h2>
<p>参考 ESXi/vCSA Release Notes：</p>
<ul>
<li>Performance improvements for AMD Zen CPUs: With ESXi 7.0 Update 2, out-of-the-box optimizations can increase AMD Zen CPU performance by up to 30% in various benchmarks. The updated ESXi scheduler takes full advantage of the AMD NUMA architecture to make the most appropriate placement decisions for virtual machines and containers. AMD Zen CPU optimizations allow a higher number of VMs or container deployments with better performance.</li>
<li>Reduced compute and I/O latency, and jitter for latency sensitive workloads: Latency sensitive workloads, such as in financial and telecom applications, can see significant performance benefit from I/O latency and jitter optimizations in ESXi 7.0 Update 2. The optimizations reduce interference and jitter sources to provide a consistent runtime environment. With ESXi 7.0 Update 2, you can also see higher speed in interrupt delivery for passthrough devices.</li>
<li>vSphere Lifecycle Manager fast upgrades: Starting with vSphere 7.0 Update 2, you can configure vSphere Lifecycle Manager to suspend virtual machines to memory instead of migrating them, powering them off, or suspending them to disk. For more information, see Configuring vSphere Lifecycle Manager for Fast Upgrades.</li>
<li>Zero downtime, zero data loss for mission critical VMs in case of Machine Check Exception (MCE) hardware failure: With vSphere 7.0 Update 3, mission critical VMs protected by VMware vSphere Fault Tolerance can achieve zero downtime, zero data loss in case of Machine Check Exception (MCE) hardware failure, because VMs fallback to the secondary VM, instead of failing. For more information, see How Fault Tolerance Works.</li>
</ul>
<h2 id="vcsa-相关常见错误">vCSA 相关常见错误</h2>
<ul>
<li><a href="https://kb.vmware.com/s/article/85468">https://kb.vmware.com/s/article/85468</a> vCSA 日志分区 <code>/storage/log</code> 满，原因是访问 vmware 网站失败打印的日志太大：<code>/storage/log/vmware/analytics/analytics-runtime.log*</code>；解决方法：<code>vmon-cli -r analytics</code> 重启服务，然后删掉旧的日志。</li>
<li><a href="https://kb.vmware.com/s/article/83070">https://kb.vmware.com/s/article/83070</a> vCSA 日志分区 <code>/storage/log</code> 满，原因是 tomcat 日志太大。</li>
<li><code>XXX Service Health Alarm</code>：尝试重启对应服务，比如 <code>vmon-cli -r perfcharts</code> 对应 <code>Performance Charts</code>，<code>vmon-cli -r vapi-endpoint</code> 对应 <code>VMWare vAPI Endpoint</code></li>
</ul>
<p>查看更新状态：<code>cat /storage/core/software-update/stage_operation</code>；更新文件下载路径：<code>/storage/updatemgr/software-update*/stage</code>。有一个包特别大：<code>wcpovf</code> 需要两个多 G。</p>
<p>CLI 更新方法： <a href="https://earlruby.org/2021/01/upgrading-vcenter-7-via-the-command-line/">https://earlruby.org/2021/01/upgrading-vcenter-7-via-the-command-line/</a></p>

        </div>

        
        
        <div class="article-toc" style="display:none;">
            <h3>Contents</h3>
            <nav id="TableOfContents">
  <ul>
    <li><a href="#常用链接">常用链接</a></li>
    <li><a href="#离线升级方法">离线升级方法</a></li>
    <li><a href="#在线升级方法">在线升级方法</a></li>
    <li><a href="#防火墙">防火墙</a></li>
    <li><a href="#nuc11i5-esxi-70-安装过程">NUC11i5 ESXi 7.0 安装过程</a></li>
    <li><a href="#推荐博客">推荐博客</a></li>
    <li><a href="#重要版本更新">重要版本更新</a></li>
    <li><a href="#vcsa-相关常见错误">vCSA 相关常见错误</a></li>
  </ul>
</nav>
        </div>
        
        

        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
        <script>
            (function() {
                var $toc = $('#TableOfContents');
                if ($toc.length > 0) {
                    var $window = $(window);

                    function onScroll(){
                        var currentScroll = $window.scrollTop();
                        var h = $('.article-entry h1, .article-entry h2, .article-entry h3, .article-entry h4, .article-entry h5, .article-entry h6');
                        var id = "";
                        h.each(function (i, e) {
                            e = $(e);
                            if (e.offset().top - 10 <= currentScroll) {
                                id = e.attr('id');
                            }
                        });
                        var active = $toc.find('a.active');
                        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

                        active.each(function (i, e) {
                            $(e).removeClass('active').siblings('ul').hide();
                        });
                        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                            $(e).children('a').addClass('active').siblings('ul').show();
                        });
                    }

                    $window.on('scroll', onScroll);
                    $(document).ready(function() {
                        $toc.find('a').parent('li').find('ul').hide();
                        onScroll();
                        document.getElementsByClassName('article-toc')[0].style.display = '';
                    });
                }
            })();
        </script>
        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://jia.je/tags/esxi">esxi
                    </a>
                </li>
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://jia.je/tags/vmware">vmware
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="/hardware/2021/10/18/port-system-to-rocket-chip-on-vcu128/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            移植系统到 Rocket Chip on VCU128
        </div>
    </a>
    
    
    <a href="/hardware/2021/09/27/xilinx-axi-quad-spi-timing/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">AXI Quad SPI 时序理解&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>

        
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jiegec" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
    </section>
    <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2022 杰哥的{运维,编程,调板子}小笔记
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-185962713-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css" integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha256-ExtbCSBuYA7kq1Pz362ibde9nnsHYPt6JxuxYeZbU+c=" crossorigin="anonymous"></script>
        <script>renderMathInElement(document.body);</script>
    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
</footer>

</div>
</body>
</html>
